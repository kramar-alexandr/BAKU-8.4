external function longint DateDiff(date,date);
remote function boolean CompanyIsJWLikeCompany(Integer);
external procedure YcToStr(Integer,var string);
external updating function LongInt TRVcRecordRemove(var record TRVc,record TRVc,LongInt,LongInt);
external function val AbsoluteVal(val);
external procedure RetPUSumUp(var record RetPUVc);
remote procedure ORSumup(var record ORVc);
remote procedure ORVc_PastePrice(var record ORVc,Integer,var Boolean);
remote procedure ORDchsum(var record ORVc,Integer);
external procedure PUVc_PasteCostPrice(var record PUVc,Integer);
remote procedure TRVc_PasteCurCredVal(var record TRVc,Integer);
remote procedure TRVc_PasteCurDebVal(var record TRVc,Integer);
remote procedure TRVc_PasteDebVal(var record TRVc,Integer);
remote procedure TRVc_PasteCredVal(var record TRVc,Integer);
external function Integer MakeTransFromPU(record TRVc,record PUVc,record LocationVc,Boolean);
external updating procedure SaveTrans(record TRVc);
external updating procedure AddTTrans_PUVc(record TRVc,record PUVc);
external updating procedure DeleteTransaction(LongInt,Integer);
external updating procedure AddTTrans_IVVc(record TRVc,record IVVc);
external function Integer MakeTransFromIV(var record TRVc,var record SMVc,record IVVc,Boolean,Boolean,record IVVc);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
remote function Boolean ORVc_PasteArtCode(var record ORVc,Integer,var string,var string,Boolean);
external procedure GetAccStartBalance(string,string,Date,record ObjBalVc,Integer,Integer,string,Integer,var val);
external procedure GetAccBalance(string,string,Date,record ObjBalVc,Integer,Integer,Integer,string,Integer,var val);
external procedure FindNLAccBal(string,string,string,Integer,Date,Date,Integer,Integer,Boolean,string,Integer,string,string,var val);
external procedure ExtractObjectsByType(string, string, var array string, var integer);
external procedure IPVc_PasteCustCode(var record IPVc,Integer,var LongInt);
external procedure IPVc_PasteRecVal(var record IPVc,Integer);
external procedure RecordAction_raExpandPay(var record IPVc,Integer);
external function Boolean TRVc_PasteAccNumber(var record TRVc,Integer,Integer,Boolean);
external procedure TRVc_PasteDebVal(var record TRVc,Integer);
external procedure TRVc_PasteCredVal(var record TRVc,Integer);
external procedure IPPastePayMode2(var record IPVc,string);
external procedure NormalizeObjstr(var string);
external function Boolean PasteInvIn2OPr(var record OPVc,Integer,Date,Integer,val,var string,Boolean,var Boolean);
external procedure OPVc_PasteRecCurncy(var record OPVc,Integer);
external procedure OPVc_PasteRecVal(var record OPVc,Integer);
external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);
external procedure OPSumup(var record OPVc,Boolean);
external procedure OPVc_PasteVECode(var record OPVc,Integer);
external procedure OPPastePayMode2(var record OPVc,string);
external procedure IPSumup(var record IPVc);
external procedure TRSumup(var record TRVc,var val);

SetLangMode(LangRussian,"RUS",0);


global webpublic updating procedure WebFindAndFixItems()
begin
	record RHistVc RHr;
	boolean TrHs,testf;
	vector integer vrstr;
  array string 20 keys;
  integer i,j,counter,lastj;
  string 10 c;
  string 50 recname,compnr,mainkey;
  integer cter,pref,check;
  longint kkk;
  area workarea;
  record INVc INr,OrigINr;
  vector string 100 brandbnames;
  record BPIBrandVc BPIBrandr;
  
  setcompany(1,false);
  
  while(loopmain(BPIBrandr,1,true))begin
  	brandbnames[BPIBrandr.Code] = BPIBrandr.Name;
  end;
  
  kkk = 1;
	RHr.TransDate = stringtodate("12/02/2020");
	RHr.User = "IRKAKH";
	
	TrHs = true;
	while(loopkey("UserDateTime",RHr,2,TrHs))begin
		testf = true;
		if(RHr.TransDate!=stringtodate("12/02/2020"))then begin TrHs = false; end;
		if(RHr.User!="IRKAKH")then begin TrHs = false; end;
		
		
		
		if(testf)then begin
			testf = TrHs;
		end;
		
		if(testf)then begin
			setareazerosize(workarea);
			addtexttoarea(RHr.RecidStr,workarea);
			c = getstringfromarea(workarea,0,1);//left(RHr.RecidStr,1);
			pref = asc(c) + 1;
			compnr = getstringfromarea(workarea,1,asc(c));//mid(RHr.RecidStr,1,asc(c));
			recname = "";
			mainkey = "";
			cter = 0;
			lastj = 0;
			if(pref<getarealength(workarea))then begin
				for(j=pref;j<getarealength(workarea);j=j+1)begin
					c = getstringfromarea(workarea,j,1);//mid(RHr.RecidStr,j,1);
					if(asc(c)<48)then begin
						j = getarealength(workarea);
					end else begin
						recname = recname & c;
						lastj = j;
					end;
				end;
				
				for(j=lastj;j<getarealength(workarea);j=j+1)begin
					c = getstringfromarea(workarea,j,1);//mid(RHr.RecidStr,j,1);
					if(asc(c)<48)then begin
						if((j+1)<getarealength(workarea))then begin
							mainkey = getstringfromarea(workarea,j+1,getarealength(workarea)-(j+1));
							if(asc(left(mainkey,1))<48)then begin
								mainkey = right(mainkey,len(mainkey)-1);
							end;
						end;
						j = getarealength(workarea);
					end else begin
					end;
				end;
			end else begin
			end;
			
		end;
		
		if(testf)then begin
			if(recname=="INVc")then begin
				//weboutstring(kkk & " compnr " & compnr & "_____record " & recname & " mainkey " & mainkey);
				weboutstring("<BR>");
				kkk = kkk + 1;
				setcompany(stringtoint(compnr),false);
					INr.Code = mainkey;
					if(readfirstmain(INr,1,true))then begin
						ReadOriginalRecord(RHr,OrigINr);	
						if(blank(INr.BPIBrand) and nonblank(OrigINr.BPIBrand))then begin
							weboutstring(compnr & " Restore brand " & brandbnames[OrigINr.BPIBrand] & " for item " & INr.Code);
							INr.BPIBrand = OrigINr.BPIBrand;
							INr.BPICollection = OrigINr.BPICollection;
							INr.BPIGroup = OrigINr.BPIGroup;
							INr.BPISubGroup = OrigINr.BPISubGroup;
							INr.BPICategory = OrigINr.BPICategory;
							INr.BPIMaterial = OrigINr.BPIMaterial;
							INr.BPIColor = OrigINr.BPIColor;
							INr.BPIShape = OrigINr.BPIShape;
							INr.BPISize = OrigINr.BPISize;
							INr.BPIUse = OrigINr.BPIUse;
							INr.BPISex = OrigINr.BPISex;
							INr.BPIPlating = OrigINr.BPIPlating;
							INr.BPIClarity = OrigINr.BPIClarity;
							INr.BPIWeight = OrigINr.BPIWeight;
							INr.BPICut = OrigINr.BPICut;
							INr.BPIStone = OrigINr.BPIStone;
							INr.BPIStrap = OrigINr.BPIStrap;
							INr.BPIOdour = OrigINr.BPIOdour;
							recordstore(INr,true);
						end;
					end;
				resetcompany(1);
			end;
			//logtext(0,"compnr " & compnr & "_____record " & recname & " mainkey " & mainkey);
		end;
		
	end;
	
return;
end;


global procedure FillClassInM4Text(var record GlobalItemVc GIr, string ClassMachName ,string ClassNameENG, string ClassNameRUS, string ClassNameAZE, 
																																			string ValENG, string ValRUS, string ValAZE, area ImportedFile)
begin
	longint tlcnt,i,newtlcnt, l, currentLineInArea, t, ststr, lnstr;
	string 255 linestr, chunkValENG, chunkValRUS, chunkValAZE, tstr;
	array string 255 TextLinesArray, oldTextLinesArray, Class;
	val strCoef;
	Integer strNatCoef, clarea;
	string 255 tabInLine;
	
	newtlcnt = 0;
	tlcnt = LineTextCnt(GIr);
	if (tlcnt > 1) then begin
		for (i=0;i<tlcnt;i=i+1) begin
			linestr = LineTextGet	(GIr,i);
			if (linestr == chr(09) & "\"" & ClassMachName & "\":{") then begin
				TextLinesArray[newtlcnt - 1] = chr(09) & "}";
				while (linestr!=chr(09) & "}" and linestr!=chr(09) & "}," and i<tlcnt) begin
					i = i + 1;
					linestr = LineTextGet	(GIr,i);
				end;
			end else begin
				TextLinesArray[newtlcnt] = linestr;
				newtlcnt = newtlcnt + 1;
			end;
		end;
	end;
	
	if (newtlcnt<tlcnt) then begin
		for (i=0;i<tlcnt;i=i+1) begin
			if (nonblank(TextLinesArray[i])) then begin
				LineTextPut	(GIr,i,TextLinesArray[i]);
			end else begin
				LineTextPut	(GIr,i,"");
			end;
		end;
	end;
	
	
	tlcnt = LineTextCnt(GIr);
	if (tlcnt > 1) then begin
		for (i=tlcnt-1;i>=0;i=i-1) begin
			linestr = LineTextGet	(GIr,i);
			if (linestr == "}") then begin
				tlcnt = i - 1;
				if (LineTextGet	(GIr,i-1)==chr(09) & "}") then begin
					LineTextPut	(GIr,i-1,chr(09) & "},");
				end;
				i=0;
			end;
			if (linestr == chr(09) & "}") then begin
				tlcnt = i;
				LineTextPut	(GIr,tlcnt,chr(09) & "},");
				i=0;
			end;
		end;
	end;
	if (tlcnt==0 or LineTextGet(GIr,0)!="{") then begin
		LineTextPut	(GIr,tlcnt,"{");
		tlcnt = 1;
	end else begin
		tlcnt = tlcnt + 1;
	end;
	if (LineTextGet(GIr,1)=="") then begin
		tlcnt = 1;
	end;
	LineTextPut	(GIr,tlcnt,chr(09) & "\"" & ClassMachName & "\":{");
	tlcnt = tlcnt + 1;
	LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & "\"Name\":{");
	tlcnt = tlcnt + 1;
	LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"ENG\":\"" & ClassNameENG & "\"\,");
	tlcnt = tlcnt + 1;
	// if (nonblank(ClassNameRUS)) then begin
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"RUS\":\"" & ClassNameRUS & "\"\,");
		tlcnt = tlcnt + 1;
	// end;
	// if (nonblank(ClassNameAZE)) then begin
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"AZE\":\"" & ClassNameAZE & "\"");
		tlcnt = tlcnt + 1;
	// end;
	LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & "},");
	tlcnt = tlcnt + 1;
	LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & "\"Value\":{");
	tlcnt = tlcnt + 1;
	if (len(ValENG)<100) then begin
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"ENG\":\"" & ValENG & "\"\,");
		tlcnt = tlcnt + 1;
	end else begin
		clarea = countlinesinarea(ImportedFile);
		for (l=0;l<clarea;l=l+1) begin
			tstr = GetTabTextFromArea (l,0,ImportedFile);
			if (left(tstr,len(GIr.Code))==GIr.Code) then begin
				currentLineInArea = l;
			end;
		end;
		
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"ENG\":\[");
		tlcnt = tlcnt + 1;
		t = 0;
		while (left(chunkValENG,len(ValENG)-1)!=left(ValENG,len(ValENG)-1)) begin
			chunkValENG = GetTabTextFromArea (currentLineInArea,t,ImportedFile);
			t = t + 1;
		end;
		strCoef = len(chunkValENG)/100;
		ststr = 0;
		for (i=0;i<strCoef;i=i+1) begin
			if (i+1>=strCoef) then begin
				LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & chr(09) & "\"" & mid(chunkValENG,ststr,100) & "\"");
			end else begin
				LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & chr(09) & "\"" & mid(chunkValENG,ststr,100) & "\"\,");
			end;
			tlcnt = tlcnt + 1;
			ststr = ststr + 100;
		end;
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\]\,");
		tlcnt = tlcnt + 1;
	end;
	if (len(ValRUS)<100) then begin
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"RUS\":\"" & ValRUS & "\"\,");
		tlcnt = tlcnt + 1;
	end else begin
		clarea = countlinesinarea(ImportedFile);
		for (l=0;l<clarea;l=l+1) begin
			tstr = GetTabTextFromArea (l,0,ImportedFile);
			if (left(tstr,len(GIr.Code))==GIr.Code) then begin
				currentLineInArea = l;
			end;
		end;
		
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"RUS\":\[");
		tlcnt = tlcnt + 1;
		t = 0;
		while (left(chunkValRUS,len(ValRUS)-1)!=left(ValRUS,len(ValRUS)-1)) begin
			chunkValRUS = GetTabTextFromArea (currentLineInArea,t,ImportedFile);
			t = t + 1;
		end;
		strCoef = len(chunkValRUS)/100;
		ststr = 0;
		for (i=0;i<strCoef;i=i+1) begin
			if (i+1>=strCoef) then begin
				LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & chr(09) & "\"" & mid(chunkValRUS,ststr,100) & "\"");
			end else begin
				LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & chr(09) & "\"" & mid(chunkValRUS,ststr,100) & "\"\,");
			end;
			tlcnt = tlcnt + 1;
			ststr = ststr + 100;
		end;
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\]\,");
		tlcnt = tlcnt + 1;
	end;
	if (len(ValAZE)<100) then begin
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"AZE\":\"" & ValAZE & "\"");
		tlcnt = tlcnt + 1;
	end else begin
		clarea = countlinesinarea(ImportedFile);
		for (l=0;l<clarea;l=l+1) begin
			tstr = GetTabTextFromArea (l,0,ImportedFile);
			if (left(tstr,len(GIr.Code))==GIr.Code) then begin
				currentLineInArea = l;
			end;
		end;
		
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\"AZE\":\[");
		tlcnt = tlcnt + 1;
		t = 0;
		while (left(chunkValAZE,len(ValAZE)-1)!=left(ValAZE,len(ValAZE)-1)) begin
			chunkValAZE = GetTabTextFromArea (currentLineInArea,t,ImportedFile);
			t = t + 1;
		end;
		strCoef = len(chunkValAZE)/100;
		ststr = 0;
		for (i=0;i<strCoef;i=i+1) begin
			if (i+1>=strCoef) then begin
				LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & chr(09) & "\"" & mid(chunkValAZE,ststr,100) & "\"");
			end else begin
				LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & chr(09) & "\"" & mid(chunkValAZE,ststr,100) & "\"\,");
			end;
			tlcnt = tlcnt + 1;
			ststr = ststr + 100;
		end;
		LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & chr(09) & "\]");
		tlcnt = tlcnt + 1;
	end;
	LineTextPut	(GIr,tlcnt,chr(09) & chr(09) & "}");
	tlcnt = tlcnt + 1;
	LineTextPut	(GIr,tlcnt,chr(09) & "}");
	tlcnt = tlcnt + 1;
	LineTextPut	(GIr,tlcnt,"}");
	tlcnt = tlcnt + 1;
return;
end;


global updating procedure SaveGI (record GlobalItemVc GIr)
begin
	record GlobalItemVc OldGIr;
	RecordStore(GIr,true);
	RecordCopy(OldGIr,GIr);
	RecordUpdate(GIr,GIr,true);
	logtext(0,GIr.Code);
return;
end;



global webpublic procedure WebReRUSXMLItems()
begin
	record GlobalItemVc GIr;
	boolean TrHs, TESTf;
	
	TrHs = true;
	while (loopMain(GIr,1,TrHs)) begin
		if (left(GIr.Code,4)=="ECMX") then begin
			GIr.Code = "ECMXA" & right(GIr.Code,11);
			GIr.HansaCode = "ECMXA" & right(GIr.Code,11);
			queued.SaveGI (GIr);
			MilliSleep(50);
		end;
	end;
return;
end;


global webpublic procedure WebClearClassInJSON()
begin
	record GlobalItemVc GIr, blankGIr;
	boolean TrHs;
	longint tlcnt,i, j;
	
	SetCompany(1,false);
	GIr.Code = "";
	TrHs = true;
	j = 0;
	while (LoopMain(GIr,1,TrHs)) begin
		if(fileexists("stop"))then begin TrHs = false; end;
		if (LineTextCnt(GIr)>0 and left(GIr.Code,4)=="BRND") then begin
			tlcnt = LineTextCnt(GIr);
			for (i=0;i<=tlcnt;i=i+1) begin
				if (i==1) then begin 
					LineTextPut	(GIr,i,"\}");
				end else begin
					LineTextPut	(GIr,i,"");
				end;
			end;
			queued.SaveGI(GIr);
			MilliSleep(50);
		end;
	end;
	return;
end;




global webpublic procedure WebFillHNForMAXI()
begin
	record GlobalItemVc GIr;
	boolean TrHs, testf;
	
	SetCompany(1,false);
	logtext(0,"WebReFillClassInJSON START");
	GIr.Code = "";
	TrHs = true;
	while (LoopMain(GIr,1,TrHs)) begin
		testf = true;
		logtext(0,GIr.Code);
		// if(fileexists("stop"))then begin TrHs = false; end;
		if(blank(GIr.HansaName))then begin 
			logtext(0,GIr.Code);
			GIr.HansaName = GIr.Name;
			queued.SaveGI(GIr);
			MilliSleep(40);
		end;
	end;
	logtext(0,"WebReFillClassInJSON FINISH");
return;
end;


global webpublic procedure WebReFillClassInJSON()
begin
	record GlobalItemVc GIr;
	record JSONClassNamesVc JCNr;
	string 255 line;
	longint tlcnt;
	array string 255 TextLinesArray, oldTextLinesArray, Class;
	record BtrxAllMaterialsVc BAMr;
	record BtrxComplicationsVc BCr;
	record BtrxStoveCompatVc SCr;
	record BtrxMicrowaveProtectVc BMPr;
	record BtrxPlatingVc BPr;
	record BtrxPowerReserveVc BPRr;
	record BtrxWaterResistantVc BWRr;
	record BtrxMaterialVc BMr;
	record BtrxColourVc BClr;
	boolean TrHs;
	longint i;
	area ImportedFile;

	
	SetCompany(1,false);
	GIr.Code = "";
	TrHs = true;
	while (LoopMain(GIr,1,TrHs)) begin
		if(fileexists("stop"))then begin TrHs = false; end;
		tlcnt = LineTextCnt(GIr);
		for (i=0;i<tlcnt;i=i+1) begin
			LineTextPut	(GIr,i,"");
		end;
		if (nonblank(GIr.BtrxAllMaterials)) then begin
			JCNr.Code = "ALL_MATERIALS";
			if (ReadFirstMain(JCNr,1,true)) then begin
				BAMr.Code = GIr.BtrxAllMaterials;
				if (ReadFirstMain(BAMr,1,true)) then begin
					FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,BAMr.Name,BAMr.NameRUS,BAMr.NameAZ,ImportedFile);
				end;
			end;
		end;
		if (nonblank(GIr.BtrxComplications)) then begin
			JCNr.Code = "COMPLICATIONS";
			if (ReadFirstMain(JCNr,1,true)) then begin
				BCr.Code = GIr.BtrxComplications;
				if (ReadFirstMain(BCr,1,true)) then begin
					FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,BCr.Name,BCr.NameRUS,BCr.NameAZ,ImportedFile);
				end;
			end;
		end;
		if (nonblank(GIr.StrBTRxSetQty)) then begin
			JCNr.Code = "QUANTITY_IN_SET";
			if (ReadFirstMain(JCNr,1,true)) then begin
				FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,GIr.StrBTRxSetQty,GIr.StrBTRxSetQty,GIr.StrBTRxSetQty,ImportedFile);
			end;
		end;
		// if (nonblank(GIr.BtrxStoveCompat)) then begin
			// JCNr.Code = "MATCHES_THIS_KITCHEN_STOVE";
			// if (ReadFirstMain(JCNr,1,true)) then begin
				// SCr.Code = GIr.BtrxStoveCompat;
				// if (ReadFirstMain(SCr,1,true)) then begin
					// FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,SCr.Name,SCr.NameRUS,SCr.NameAZ,ImportedFile);
				// end;
			// end;
		// end;
		if (nonblank(GIr.BtrxMicrowaveProtect)) then begin
			JCNr.Code = "MICROWAVE_SAFE";
			if (ReadFirstMain(JCNr,1,true)) then begin
				BMPr.Code = GIr.BtrxMicrowaveProtect;
				if (ReadFirstMain(BMPr,1,true)) then begin
					FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,BMPr.Name,BMPr.NameRUS,BMPr.NameAZ,ImportedFile);
				end;
			end;
		end;
		if (nonblank(GIr.BPIPlating)) then begin
			JCNr.Code = "PLATING";
			if (ReadFirstMain(JCNr,1,true)) then begin
				BPr.Code = GIr.BPIPlating;
				if (ReadFirstMain(BPr,1,true)) then begin
					FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,BPr.Name,BPr.NameRUS,BPr.NameAZ,ImportedFile);
				end;
			end;
		end;
		if (nonblank(GIr.BTRxPowerReserve)) then begin
			JCNr.Code = "POWER_RESERVE";
			if (ReadFirstMain(JCNr,1,true)) then begin
				BPRr.Code = GIr.BTRxPowerReserve;
				if (ReadFirstMain(BPRr,1,true)) then begin
					FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,BPRr.Name,BPRr.NameRUS,BPRr.NameAZ,ImportedFile);
				end;
			end;
		end;
		if (nonblank(GIr.BtrxScratchRes)) then begin
			JCNr.Code = "SCTRATCH_RESISTANT";
			if (ReadFirstMain(JCNr,1,true)) then begin
				FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,GIr.BtrxScratchRes,GIr.BtrxScratchRes,GIr.BtrxScratchRes,ImportedFile);
			end;
		end;
		if (nonblank(GIr.BtrxWarranty)) then begin
			JCNr.Code = "WARANTY_INFORMATION";
			if (ReadFirstMain(JCNr,1,true)) then begin
				FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,GIr.BtrxWarranty,GIr.BtrxWarranty,GIr.BtrxWarranty,ImportedFile);
			end;
		end;
		if (nonblank(GIr.BTRxWatterRes)) then begin
			JCNr.Code = "WATER_RESISTANT";
			if (ReadFirstMain(JCNr,1,true)) then begin
				BWRr.Code = GIr.BTRxWatterRes;
				if (ReadFirstMain(BWRr,1,true)) then begin
					FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,BWRr.Name,BWRr.NameRUS,BWRr.NameAZ,ImportedFile);
				end;
			end;
		end;
		if (nonblank(GIr.StrWeight)) then begin
			JCNr.Code = "WEIGHT";
			if (ReadFirstMain(JCNr,1,true)) then begin
				FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,GIr.StrWeight,GIr.StrWeight,GIr.StrWeight,ImportedFile);
			end;
		end;
		if (nonblank(GIr.BtrxClockFaceMaterial)) then begin
			JCNr.Code = "DIAL_MATERIAL";
			if (ReadFirstMain(JCNr,1,true)) then begin
				BMr.Code = GIr.BtrxClockFaceMaterial;
				if (ReadFirstMain(BMr,1,true)) then begin
					FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,BMr.Name,BMr.NameRUS,BMr.NameAZ,ImportedFile);
				end;
			end;
		end;
		if (nonblank(GIr.BtrxClockFaceColour)) then begin
			JCNr.Code = "DIAL_COLOR";
			if (ReadFirstMain(JCNr,1,true)) then begin
				BClr.Code = GIr.BtrxClockFaceColour;
				if (ReadFirstMain(BClr,1,true)) then begin
					FillClassInM4Text(GIr,JCNr.Code,JCNr.Name,JCNr.NameRUS,JCNr.NameAZ,BClr.Name,BClr.NameRUS,BClr.NameAZ,ImportedFile);
				end;
			end;
		end;
		if (LineTextCnt(GIr)>0) then begin
			queued.SaveGI(GIr);
		end;
		MilliSleep(50);
	end;
return;
end;



global webpublic updating procedure WebRestoreCustomNames()
begin
	record RHistVc RHr;
	boolean TrHs,testf;
	vector integer vrstr;
  array string 20 keys;
  integer i,j,counter,lastj;
  string 10 c;
  string 50 recname,compnr,mainkey;
  integer cter,pref,check;
  longint kkk;
  area workarea;
  record INVc INr,OrigINr;
  record CUVc CUr,OrigCUr;
  vector string 100 brandbnames;
  
	setcompany(1,false);
  
  
  kkk = 1;
	//RHr.TransDate = stringtodate("04/03/2020");
	//RHr.User = "CRMSYST";
	
	RHr.SerNr = 9999999999;
	
	TrHs = true;
	while(loopbackkey("MainKey",RHr,1,TrHs))begin
		testf = true;
		if(RHr.TransDate<stringtodate("04/03/2020"))then begin TrHs = false; end;
		//if(RHr.User!="CRMSYST")then begin TrHs = false; end;
		
		logtext(0,RHr.SerNr & " " & RHr.TransDate);
		
		if(testf)then begin
			testf = TrHs;
		end;
		
		if(fileexists("stop"))then begin
			TrHs = false;
		end;
		
		if(testf)then begin
			setareazerosize(workarea);
			addtexttoarea(RHr.RecidStr,workarea);
			c = getstringfromarea(workarea,0,1);//left(RHr.RecidStr,1);
			pref = asc(c) + 1;
			compnr = getstringfromarea(workarea,1,asc(c));//mid(RHr.RecidStr,1,asc(c));
			recname = "";
			mainkey = "";
			cter = 0;
			lastj = 0;
			if(pref<getarealength(workarea))then begin
				for(j=pref;j<getarealength(workarea);j=j+1)begin
					c = getstringfromarea(workarea,j,1);//mid(RHr.RecidStr,j,1);
					if(asc(c)<48)then begin
						j = getarealength(workarea);
					end else begin
						recname = recname & c;
						lastj = j;
					end;
				end;
				
				for(j=lastj;j<getarealength(workarea);j=j+1)begin
					c = getstringfromarea(workarea,j,1);//mid(RHr.RecidStr,j,1);
					if(asc(c)<48)then begin
						if((j+1)<getarealength(workarea))then begin
							mainkey = getstringfromarea(workarea,j+1,getarealength(workarea)-(j+1));
							if(asc(left(mainkey,1))<48)then begin
								mainkey = right(mainkey,len(mainkey)-1);
							end;
						end;
						j = getarealength(workarea);
					end else begin
					end;
				end;
			end else begin
			end;
			
		end;
		
		if(testf)then begin
			if(recname=="CUVc")then begin
				logtext(0,mainkey);
				//weboutstring(kkk & " compnr " & compnr & "_____record " & recname & " mainkey " & mainkey);
				//weboutstring("<BR>");
				kkk = kkk + 1;
					CUr.Code = mainkey;
					if(readfirstmain(CUr,1,true))then begin
						if(blank(CUr.Name))then begin
							ReadOriginalRecord(RHr,OrigCUr);	
							if(CUr.Name!=OrigCUr.Name and nonblank(OrigCUr.Name))then begin
								weboutstring(compnr & " Restore name " & CUr.Code & " for customer " & OrigCUr.Name);
								weboutstring("<BR>");
								CUr.Name = OrigCUr.Name;
								recordstore(CUr,true);
							end;
						end;
					end;
			end;
			//logtext(0,"compnr " & compnr & "_____record " & recname & " mainkey " & mainkey);
		end;
		
	end;
	
return;
end;



global webpublic updating procedure WebRestoreCustomNamesCUr()
begin
	record RHistVc RHr;
	boolean TrHs,testf;
	vector integer vrstr;
  array string 20 keys;
  integer i,j,counter,lastj;
  string 10 c;
  string 50 recname,compnr,mainkey;
  integer cter,pref,check;
  longint kkk;
  area workarea;
  record INVc INr,OrigINr;
  record CUVc CUr,OrigCUr;
  vector string 100 brandbnames;
  string 255 tstr;
  
	setcompany(1,false);
  
  
  kkk = 1;
	//RHr.TransDate = stringtodate("04/03/2020");
	//RHr.User = "CRMSYST";
	
	RHr.SerNr = 9999999999;
	
	TrHs = true;
	CUr.Name = "";
	while(loopkey("Name",CUr,1,TrHs))begin
		if(nonblank(CUr.Name))then begin TrHs = false; end;
		
		if(TrHs)then begin
			tstr = BuildRecordIdStr(CUr,1);
			
			RHr.RecidStr = tstr;
			if(readlastkey("RecidStr",RHr,1,true))then begin
				ReadOriginalRecord(RHr,OrigCUr);	
				if(CUr.Name!=OrigCUr.Name and nonblank(OrigCUr.Name))then begin
					weboutstring(compnr & " Restore name " & CUr.Code & " for customer " & OrigCUr.Name);
					weboutstring("<BR>");
					CUr.Name = OrigCUr.Name;
					recordstore(CUr,true);
				end;
			
			end;						
			
		end;
		
	end;
	
	/*
	TrHs = true;
	while(loopbackkey("MainKey",RHr,1,TrHs))begin
		testf = true;
		if(RHr.TransDate<stringtodate("04/03/2020"))then begin TrHs = false; end;
		//if(RHr.User!="CRMSYST")then begin TrHs = false; end;
		
		logtext(0,RHr.SerNr & " " & RHr.TransDate);
		
		if(testf)then begin
			testf = TrHs;
		end;
		
		if(fileexists("stop"))then begin
			TrHs = false;
		end;
		
		if(testf)then begin
			setareazerosize(workarea);
			addtexttoarea(RHr.RecidStr,workarea);
			c = getstringfromarea(workarea,0,1);//left(RHr.RecidStr,1);
			pref = asc(c) + 1;
			compnr = getstringfromarea(workarea,1,asc(c));//mid(RHr.RecidStr,1,asc(c));
			recname = "";
			mainkey = "";
			cter = 0;
			lastj = 0;
			if(pref<getarealength(workarea))then begin
				for(j=pref;j<getarealength(workarea);j=j+1)begin
					c = getstringfromarea(workarea,j,1);//mid(RHr.RecidStr,j,1);
					if(asc(c)<48)then begin
						j = getarealength(workarea);
					end else begin
						recname = recname & c;
						lastj = j;
					end;
				end;
				
				for(j=lastj;j<getarealength(workarea);j=j+1)begin
					c = getstringfromarea(workarea,j,1);//mid(RHr.RecidStr,j,1);
					if(asc(c)<48)then begin
						if((j+1)<getarealength(workarea))then begin
							mainkey = getstringfromarea(workarea,j+1,getarealength(workarea)-(j+1));
							if(asc(left(mainkey,1))<48)then begin
								mainkey = right(mainkey,len(mainkey)-1);
							end;
						end;
						j = getarealength(workarea);
					end else begin
					end;
				end;
			end else begin
			end;
			
		end;
		
		if(testf)then begin
			if(recname=="CUVc")then begin
				logtext(0,mainkey);
				//weboutstring(kkk & " compnr " & compnr & "_____record " & recname & " mainkey " & mainkey);
				//weboutstring("<BR>");
				kkk = kkk + 1;
					CUr.Code = mainkey;
					if(readfirstmain(CUr,1,true))then begin
						if(blank(CUr.Name))then begin
							ReadOriginalRecord(RHr,OrigCUr);	
							if(CUr.Name!=OrigCUr.Name and nonblank(OrigCUr.Name))then begin
								weboutstring(compnr & " Restore name " & CUr.Code & " for customer " & OrigCUr.Name);
								weboutstring("<BR>");
								CUr.Name = OrigCUr.Name;
								recordstore(CUr,true);
							end;
						end;
					end;
			end;
			//logtext(0,"compnr " & compnr & "_____record " & recname & " mainkey " & mainkey);
		end;
		
	end;*/
	
return;
end;



global webpublic procedure WebCheckListToClose()
begin
	area ainput,aoutput;
	longint lines,i,j;
	string 255 linestr;
	array string 50 contacts;
	vector boolean isVendor,isEmpl,hasLC,hasActiv,isClosed,isIDEA;
	record CUVc CUr;
	record LoyaltyCardVc LCr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer CompQty,comp;
	record ORVc ORr;
	record IVVc IVr;
	record CSVc CSr;
	vector val LCbal;
	vector date cucrdate,lccrdate;
	vector integer contage;
	
	setcompany(1,true);
	
	blockload(Compb);
	CompQty = matrowcnt(Compb);
	logtext(0,"WebCheckListToClose start");
	
	addfiletoarea("ListToCkeckDublicates.txt",ainput,false);
	lines = countlinesinarea(ainput);
	
	addtexttoarea("Code" & chr(9),aoutput);
	addtexttoarea("is Vendor" & chr(9),aoutput);
	addtexttoarea("is Employe" & chr(9),aoutput);
	addtexttoarea("has Activity" & chr(9),aoutput);
	addtexttoarea("has LC" & chr(9),aoutput);
	addtexttoarea("LC points" & chr(9),aoutput);
	addtexttoarea("Contact Date" & chr(9),aoutput);
	addtexttoarea("LC Date" & chr(9),aoutput);
	addtexttoarea("ContactDaysAge" & chr(9),aoutput);
	addtexttoarea("IDEA Contact" & chr(9),aoutput);
	addtexttoarea("Closed in Hansa" & chr(9),aoutput);
	addtexttoarea(chr(13) & chr(10),aoutput);
	
	for(i=0;i<lines;i=i+1)begin
		linestr = getlinefromarea(ainput,i);
		
		if(nonblank(linestr))then begin
			CUr.Code = linestr;
			
			if(readfirstmain(CUr,1,true))then begin
				if(CUr.CustCat=="IDEA")then begin
					isIDEA[CUr.Code] = true;
				end;
				if(CUr.blockedFlag>0)then begin
					isClosed[CUr.Code] = true;
				end;
				cucrdate[CUr.Code] = CUr.DateCreated;
				if(CUr.VEType>0)then begin
					isVendor[CUr.Code] = true;
				end;
				if(CUr.EmployeeType>0)then begin
					isEmpl[CUr.Code] = true;
				end;
				LCr.CustCode = CUr.Code;
				if(ReadFirstKey("ActCustCode",LCr,1,true)) then begin 
					hasLC[CUr.Code] = true; 
					LCbal[CUr.Code] = LCr.PointsBalance + LCr.StartBalance + LCr.PointsBalanceTotal;
					lccrdate[CUr.Code] = LCr.StartDate;
				end;
				
				if(nonblankdate(cucrdate[CUr.Code]) or nonblankdate(lccrdate[CUr.Code]))then begin
					
					contage[CUr.Code] = datediff(currentdate,cucrdate[CUr.Code]);
					if(contage[CUr.Code]<datediff(currentdate,lccrdate[CUr.Code]))then begin
						contage[CUr.Code] = datediff(currentdate,lccrdate[CUr.Code]);
					end;
					
				end else begin
					contage[CUr.Code] = 11111;
				end;
				
				for(comp=0;comp<CompQty;comp=comp+1) begin
					matrowget(Compb,comp,Comprw);
					if(Comprw.ActiveStatus==0) then begin
						SetCompany(comp+1,false);
						ORr.CustCode = CUr.Code;
						if(ReadFirstKey("CustCode",ORr,1,true)) then begin hasActiv[CUr.Code] = true; comp = CompQty; end;
						CSr.CustCode = CUr.Code;
						if(ReadFirstMain(CSr,1,true))then begin hasActiv[CUr.Code] = true; comp = CompQty; end;
					end;
				end;
				
			end else begin
				contage[linestr] = 11111;
				isClosed[linestr] = true;
			end;
			contacts[contacts.length] = linestr;
		end else begin
			//check compained contacts
			for(j=0;j<contacts.length;j=j+1)begin
				addtexttoarea(contacts[j] & chr(9),aoutput);
				addtexttoarea(isVendor[contacts[j]] & chr(9),aoutput);
				addtexttoarea(isEmpl[contacts[j]] & chr(9),aoutput);
				addtexttoarea(hasActiv[contacts[j]] & chr(9),aoutput);
				addtexttoarea(hasLC[contacts[j]] & chr(9),aoutput);
				addtexttoarea(LCbal[contacts[j]] & chr(9),aoutput);
				addtexttoarea(cucrdate[contacts[j]] & chr(9),aoutput);
				addtexttoarea(lccrdate[contacts[j]] & chr(9),aoutput);
				addtexttoarea(contage[contacts[j]] & chr(9),aoutput);				
				addtexttoarea(isIDEA[contacts[j]] & chr(9),aoutput);
				addtexttoarea(isClosed[contacts[j]] & chr(9),aoutput);
				addtexttoarea(chr(13) & chr(10),aoutput);
			end;
			addtexttoarea(chr(13) & chr(10),aoutput);
			ClearArray(contacts);
			ClearVector(isVendor);
			ClearVector(isEmpl);
			ClearVector(hasLC);
			ClearVector(LCbal);
			ClearVector(lccrdate);
			ClearVector(cucrdate);
			ClearVector(contage);
			ClearVector(isIDEA);
			ClearVector(isClosed);
		end;
		
		
		
		
	
	end;
	
	writeareatofile(aoutput,"O_ListToCkeckDublicates.txt",0);
	
	logtext(0,"WebCheckListToClose end");
	
return;
end;

global webpublic updating procedure WebDeleteGlobalItemNotForBtrx()
begin
	record BrandsECommerceBlock BECB;
	row BrandsECommerceBlock BECBrw;
	integer i;
	vector boolean vcheck;
	record GlobalItemVc GIr,mainGIr, GI2r;
	
	
	setcompany(29,false);
	
	blockload(BECB);
	
	for (i=0;i<matrowcnt(BECB);i=i+1) begin
		matrowget(BECB,i,BECBrw);
		vcheck[BECBrw.Brand] = true;
		logtext(0,BECBrw.Brand);
	end;
	
	while(loopmain(GIr,1,true))begin
		if(vcheck[left(GIr.Code,8)])then begin
			logtext(0,"delete GIR " & GIr.Code & " " & GIr.Name);
			recorddelete(GIr);
			stepback(GIr);
		end;
	end;

return;
end;




global webpublic updating procedure WebZeroSWInstockIfOneDuplicates()
begin
	record ItemDuplicatesVc IDr;
	record GlobalItemVc GIr, OldGIr;
	row GlobalItemVc GIrw;
	LongInt i,j;
	boolean testf, TrHs;
	
	TrHs = true;
	GIr.Code = "BRND0171";
	while (loopMain(GIr,1,TrHs)) begin
		if (left(GIr.Code,8)!="BRND0171") then begin TrHs = false; end;
		if (TrHs) then begin
			RecordCopy(OldGIr,GIr);
			testf = false;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget(GIr,i,GIrw);
				if (left(GIrw.Location,2)=="SW" and GIrw.Instock==1) then begin
					GIrw.Instock = 0;
					matrowput(GIr,i,GIrw);
					testf = true;
				end;
			end;
			if (testf) then begin
				RecordUpdate(OldGIr,GIr,true);
				logtext(0,GIr.Code);
			end;
		end;
	end;




return;
end;





global webpublic updating procedure WebClearKeyFieldsInGlobalItemDuplicates()
begin
	record ItemDuplicatesVc IDr;
	record GlobalItemVc DupGIr, OldGIr, OrigGIr, OldOrigGIr;
	row GlobalItemVc DupGIrw, OrigGIrw;
	boolean TrHs, testf, LocAddDupInstf;
	longint i, j, mtrw;
	
	SetCompany(1,false); 
	
	IDr.OrigCode = "";
	while (loopMain(IDr,1,true)) begin
		DupGIr.Code = IDr.DupBrandCode & "_" & IDr.DupCode;
		if (ReadFirstMain(DupGIr,1,true)) then begin
			OrigGIr.Code = IDr.OrigBrandCode & "_" & IDr.OrigCode;
			if (ReadFirstMain(OrigGIr,1,true)) then begin
				for (i=0;i<matrowcnt(DupGIr);i=i+1) begin
					matrowget(DupGIr,i,DupGIrw);
					if (DupGIrw.Instock>0) then begin
						LocAddDupInstf = false;
						for (j=0;j<matrowcnt(OrigGIr);j=j+1) begin
							matrowget(OrigGIr,j,OrigGIrw);
							if (OrigGIrw.Location==DupGIrw.Location) then begin
								OrigGIrw.Instock = OrigGIrw.Instock + DupGIrw.Instock;
								logtext(0,OrigGIr.Code & " " & OrigGIrw.Location &  " updated Instock");
								matrowput (OrigGIr,j,OrigGIrw);
								recordStore(OrigGIr,true);
								LocAddDupInstf = true;
							end;
							if (!LocAddDupInstf) then begin
								OrigGIrw.Location = DupGIrw.Location;
								OrigGIrw.Instock = DupGIrw.Instock;
								logtext(0,OrigGIr.Code & " " & OrigGIrw.Location &  " created");
								matrowput (OrigGIr,matrowcnt(OrigGIr),OrigGIrw);
								recordStore(OrigGIr,true);
							end;
						end;
					end;
				end;
			end;
			RecordCopy(OldGIr,DupGIr);
			DupGIr.HansaName = "";
			RecordUpdate(OldGIr,DupGIr,true);
			logtext(0,DupGIr.Code & " Key fields cleared");
			RecordCopy(OldOrigGIr,OrigGIr);
			RecordUpdate(OldOrigGIr,OrigGIr,true);
		end;
	end;

return;
end;


global webpublic updating procedure WebRestoreCostAndCurncyForIN()
begin
	record INVc INr,origINr,oldINr;
	record RHistVc RHr;
	string 100 tstr;
	boolean TrHs;
	integer i;
	record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
	
	blockload(Compb);
	
	for(i=1;i<26;i=i+1)begin
		setcompany(i,false);
		matrowget(Compb,i-1,Comprw);
		if(CompanyIsJWLikeCompany(i)==false and Comprw.ActiveStatus==0)then begin
			resetloop(INr);
			INr.Code = "";
			while(loopmain(INr,1,true))begin
				if(INr.InPrice>0 and 	(INr.LastPurchPrice2==blankval or INr.LastPurchPrice2==0))then begin
					if(blank(INr.LastPurchCurncyCode))then begin
				
						tstr = BuildRecordIdStr(INr,i);
			
						RHr.RecidStr = tstr;
						RHr.SerNr = 999999999;
						TrHs = true;
						while(loopbackkey("RecidStr",RHr,2,TrHs))begin
							if(RHr.RecidStr!=tstr)then begin TrHs = false; end;
					
							if(TrHs)then begin
								ReadOriginalRecord(RHr,origINr);	
								if(origINr.Code==INr.Code and nonblank(origINr.LastPurchCurncyCode) and origINr.LastPurchPrice2>0)then begin
									weboutstring(Comprw.CompCode & "  " & INr.Code & " Restore CURNCY " & origINr.LastPurchCurncyCode & " price " & origINr.LastPurchPrice2);
									weboutstring("<BR>");
									TrHs = false;
									/*recordcopy(oldINr,INr);
										INr.LastPurchCurncyCode = origINr.LastPurchCurncyCode;
										INr.LastPurchPrice2 = origINr.LastPurchPrice2;
									recordupdate(oldINr,INr,true);*/
								end;
							end;
			
						end;
						resetloop(RHr);
						
					end;
				end;
			end;
		end;
	
	end;
	
	
return;
end;



global webpublic updating procedure WebMoveTransFromIDtoFound()
begin
	Record TRVc TRr,copyTRr,olTRr;
	row TRVc TRrw;
	boolean TrHs,testf,foundf,copyflag,deleteflag;
	integer i,rwcnt,j;
	array string 20 typrtomove;
	string 100 temstr;
	record CLInVc CLInr,oldCLInr;
	record CLOutVc CLOutr,oldCLOutr;
	
	copyflag = false;//!!!!!!!!!!!!!!!!!!!!!!!!! change to true if transfer to 33!!!
	deleteflag = false;// set tru if delete all in 18!!!
	
	if(fileexists("demoserver"))then begin
		//copyflag = true;
		//deleteflag = true;
	end;
	//copyflag = true;
	//deleteflag = true;
	
	setcompany(18,false);
	
	typrtomove[0] = "HOLDING";
	typrtomove[1] = "OBJECT_2";
	typrtomove[2] = "OBJECT_3";
	typrtomove[3] = "OBJECT_4";
	typrtomove[4] = "OBJECT_5";
	typrtomove[5] = "OBJECT_6";
	typrtomove[6] = "AMAF";
	typrtomove[7] = "AGROPARK";
	typrtomove[8] = "AZAD";
	
	weboutstring("<html>");
	weboutstring("<head>");
		weboutstring("<script src=\"https://code.jquery.com/jquery-3.4.1.js\"></script>");
		weboutstring("<script>");
			weboutstring("$(document).ready(function() {");
				weboutstring("$('tr:not(.header)').hide();");

				weboutstring("$('tr.header').click(function() {");
					weboutstring("$(this).find('span').text(function(_, value) {");
						weboutstring("return value == '-' ? '+' : '-'");
					weboutstring("});");
		
					weboutstring("$(this).nextUntil('tr.header').slideToggle(100, function() {});");
				weboutstring("});");
			weboutstring("});");
		weboutstring("</script>");
	
		weboutstring("<style>");
			weboutstring("table,");
			weboutstring("tr,");
			weboutstring("td,");
			weboutstring("th {");
				weboutstring("border: 1px solid black;");
				weboutstring("border-collapse: collapse;");
			weboutstring("}");

			weboutstring("tr.header {");
				weboutstring("cursor: pointer;");
			weboutstring("}");

		weboutstring("</style>");
		
	weboutstring("</head>");
	
	weboutstring("<table>");
	

	TRr.TransDate = stringtodate("01/01/2020");
	TrHs = true;
	while(loopkey("TransDate",TRr,1,TrHs))begin
		testf = true;
		if(TRr.TransDate<stringtodate("01/01/2020"))then begin TrHs = false; testf = false; end;
		if(TRr.IntYc>=300)then begin testf = false; end;
		if(TRr.IntYc==203)then begin testf = false; end;
		if(TRr.IntYc==204)then begin testf = false; end;
		if(TRr.IntYc==205)then begin testf = false; end;
		
		if(testf)then begin
			foundf = false;
			rwcnt = matrowcnt(TRr);
			for(i=0;i<rwcnt;i=i+1)begin
				matrowget(TRr,i,TRrw);
				if(TRrw.stp==1 and TRrw.ovst==0)then begin
					for(j=0;j<typrtomove.length;j=j+1)begin
						if(setinset(typrtomove[j],TRrw.Objects))then begin
							if(typrtomove[j]=="HOLDING" and TRrw.AccNumber=="50")then begin
								foundf = true;
							end;
							if(typrtomove[j]!="HOLDING")then begin
								foundf = true;
							end;
						end;
					end;
				end;
			end;
			
			if(foundf)then begin
				
				if(deleteflag)then begin
					if(TRr.IntYc==212)then begin
						CLOutr.SerNr = TRr.Number;
						if(readfirstmain(CLOutr,1,true))then begin
							//recorddelete(CLOutr);
							//recordcopy(oldCLOutr,CLOutr);
								CLOutr.OKFlag = 0;
								recordstore(CLOutr,true);
								//recordupdate(oldCLOutr,CLOutr,true);
							logtext(0,"CLOutr recorddelete in 18 " & CLOutr.SerNr);
						end;
					end;
					if(TRr.IntYc==211)then begin
						CLInr.SerNr = TRr.Number;
						if(readfirstmain(CLInr,1,true))then begin
								//recordcopy(oldCLInr,CLInr);
								CLInr.OKFlag = 0;
								recordstore(CLInr,true);
								//recordupdate(oldCLInr,CLInr,true);
								//recorddelete(CLInr);
								logtext(0,"CLInr recorddelete in 18 " & CLInr.SerNr);
						end;
					end;
					if (TRVcRecordRemove(TRr,TRr,0,0)<=0) then begin
          end;
					recorddelete(TRr);
					stepback(TRr);
				end;
				
				
				if(copyflag)then begin
					if(TRr.IntYc==212)then begin
						CLOutr.SerNr = TRr.Number;
						if(readfirstmain(CLOutr,1,true))then begin
							setcompany(33,false);
								//recordstore(CLOutr,false);
								logtext(0,3);
								logtext(0,"CLOutr saved in 33 " & CLOutr.SerNr);
							setcompany(18,false);
							logtext(0,2);
						end;
					end;
					logtext(0,1);
					if(TRr.IntYc==211)then begin
						CLInr.SerNr = TRr.Number;
						if(readfirstmain(CLInr,1,true))then begin
							setcompany(33,false);
								//recordstore(CLInr,false);
								logtext(0,"CLInr saved in 33 " & CLInr.SerNr);
							setcompany(18,false);
						end;
					end;
					logtext(0,"CopyTR");
					recordcopy(copyTRr,TRr);
					if(copyTRr.IntYc<200)then begin
						copyTRr.IntYc = 55;
					end;		
					logtext(0,"CopyTR1");
					setcompany(33,false);	
					logtext(0,"CopyTR2");		
					logtext(0,"TRVc saved in 33 " & copyTRr.Number & " " & copyTRr.IntYc);
					//recordstore(copyTRr,false);
					logtext(0,"CopyTR3");
					setcompany(18,false);
					logtext(0,"CopyTR4");
				end;

				
				weboutstring("<tr class=\"header\">");
				
				weboutstring("<td>" & TRr.TransDate & "</td>");
				temstr = "";
				YcToStr(TRr.IntYc,temstr);
				weboutstring("<td>" & TRr.IntYc & "</td>");
				weboutstring("<td>" & temstr & "</td>");
				weboutstring("<td>" & TRr.Comment & "</td>");
				
				weboutstring("</tr>");
				
				for(i=0;i<rwcnt;i=i+1)begin
					matrowget(TRr,i,TRrw);
					if(TRrw.stp==1 and TRrw.ovst==0)then begin
						weboutstring("<tr bgcolor=\"#ffcc00\">");
							weboutstring("<td>" & TRrw.AccNumber & "</td>");
							weboutstring("<td>" & TRrw.Objects & "</td>");
							weboutstring("<td>" & TRrw.Comment & "</td>");
							weboutstring("<td>" & TRrw.DebVal & "</td>");
							weboutstring("<td>" & TRrw.CredVal & "</td>");
							weboutstring("<td>" & TRrw.Curncy & "</td>");
							weboutstring("<td>" & TRrw.CurDebVal & "</td>");
							weboutstring("<td>" & TRrw.CurCredVal & "</td>");
						weboutstring("</tr>");
					end;
				end;
				
				
				
				
			end;
			
		end;
		
	end;
	
	weboutstring("</table>");
	weboutstring("</html>");
return;
end;







global webpublic updating procedure WebFindDifferencesInDocsAndIHFromSHInIDGroupComp()
begin
	record SHVc SHr;
	row SHVc SHrw;
	record POVc POr;
	record PUVc PUr;
	row PUVc PUrw;
	boolean TrHs, testf, remf;
	integer MainCompany, i, LCNt, j;
	record ECVendFobSetBlaock CObjr;
	row ECVendFobSetBlaock CObjrw;
	vector integer vObjComp;
	vector val vItemFRV;
	record RLinkVc RLr;
	LongInt PUrSerNr, cnt1, cnt2, shcnt;
	record ItemHistVc IHr;
	vector string 255 vPosItems;
	record ConsItemVc CIr;
	
	MainCompany = 18;
	
	SetCompany(MainCompany,false);
	BlockLoad(CObjr);
	for (i=0;i<matrowcnt(CObjr);i=i+1) begin
		matrowget(CObjr,i,CObjrw);
		vObjComp[CObjrw.VendName] = CObjrw.CompanyNr;
	end;
	
	SHr.OKFlag = 1;
	TrHs = true;
	
	cnt1 = 0;
	cnt2 = 0;
	shcnt = 0;
	while (loopkey("OKFlag",SHr,1,TrHs)) begin
		if (SHr.OKFlag != 1) then begin TrHs = false; end;
		if (TrHs) then begin
			j = 0;
			for (i=0;i<matrowcnt(SHr);i=i+1)begin
				matrowget(SHr,i,SHrw);
				if (SHrw.Ship>0) then begin
					vItemFRV[SHr.SerNr & "_" & i - j] = SHrw.FIFORowVal;
					CIr.Code = SHrw.ArtCode;
					if (ReadFirstMain(CIr,1,true)) then begin
						vPosItems[SHr.SerNr & "_" & i - j] = CIr.LocCode;
					end;
				end else begin
					j = j + 1;
				end;
			end;
			LCNt = 1;
			while (ReadRecordLink(SHr,LCNt,PUr,RLr)) begin
				PUrSerNr = PUr.SerNr;
				logtext(0,PUrSerNr);
				if(setcompany(vObjComp[SHr.CustCode],false))then begin
					PUr.SerNr = PUrSerNr;
					if (ReadFirstMain(PUr,1,true)) then begin
						if (PUr.OKFlag==1) then begin
							for (i=0;i<matrowcnt(PUr);i=i+1) begin
								matrowget(PUr,i,PUrw);
								if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and vItemFRV[SHr.SerNr & "_" & i]-AbsoluteVal(PUrw.Sum) > 1.01 and AbsoluteVal(PUrw.Sum)<1 and vPosItems[SHr.SerNr & "_" & i]==PUrw.ArtCode) then begin
									IHr.FileName = "PUVc";
									IHr.TransNr = PUr.SerNr;
									IHr.Row = i;
									remf = false;
									if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
										if (IHr.Qty != IHr.RemQty) then begin
											remf = true;
											shcnt = shcnt + 1;
										end;
									end;
									weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum & " Remf: " & remf);
									weboutstring("<BR>");
									cnt1 = cnt1 + 1;
								end;
								if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and AbsoluteVal(PUrw.Sum)-vItemFRV[SHr.SerNr & "_" & i] > 1.01 and AbsoluteVal(PUrw.Sum)<1 and vPosItems[SHr.SerNr & "_" & i]==PUrw.ArtCode) then begin 
									IHr.FileName = "PUVc";
									IHr.TransNr = PUr.SerNr;
									IHr.Row = i;
									remf = false;
									if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
										if (IHr.Qty != IHr.RemQty) then begin
											remf = true;
											shcnt = shcnt + 1;
										end;
									end;
									weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum & " Remf: " & remf);
									weboutstring("<BR>");
									cnt1 = cnt1 + 1;
								end;
								// if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum < 1) then begin 
									// weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum);
									// weboutstring("<BR>");
									// cnt2 = cnt2 + 1;
								// end;
							end;
						end;
					end;
				end;
				resetcompany(MainCompany);
				LCNt = LCNt + 1;
			end;
		end;
	end;
	weboutstring("Items > 1 diff " & cnt1);
	weboutstring("<BR>");
	weboutstring("Shipped items " & shcnt);
	weboutstring("<BR>");
return;
end;



global webpublic updating procedure WebFindBlankPathToCompPOInIDGroupComp()
begin
	record ORVc ORr, OrigORr;
	record RHistVc RHr;
	string 255 tstr;
	
	SetCompany(18,false);
	ORr.SerNr = -1;
	while (loopmain(ORr,1,true)) begin
		if (ORr.OrderClass=="CLIEN" and blank(ORr.OfficialSerNr)) then begin
			tstr = BuildRecordIdStr(ORr,18);
			
			RHr.RecidStr = tstr;
			if(readfirstkey("RecidStr",RHr,1,true))then begin
				ReadOriginalRecord(RHr,OrigORr);	
				if(ORr.OfficialSerNr!=OrigORr.OfficialSerNr and nonblank(OrigORr.OfficialSerNr))then begin
					weboutstring(" Restore OR " & ORr.SerNr & " for OfficialSerNr " & OrigORr.OfficialSerNr);
					weboutstring("<BR>");
					// ORr.Name = OrigORr.Name;
					// recordstore(ORr,true);
				end;
			end;		
			
		
		
			weboutstring("OR SerNr: " & ORr.SerNr );
			weboutstring("<BR>");
		end;
	end;

return;
end;



global webpublic updating procedure WebClearORIDGroupComp()
begin
	record ORVc ORr, OrigORr;
	record RHistVc RHr;
	string 255 tstr,inwarning,warning;
	record POVc POr;
	integer OrigComp;
	string 255 Companystr, POSerNrstr;
	row ORVc ORrw, OrigORrw;
	row POVc POrw;
	array string 255 artCodes;
	array integer aQuant;
	integer i, pos;
	record ConsItemVc CIr;
	boolean SHf, updf, IHSavef;
	longint ORSer;
	
	SetCompany(18,false);
	
	ORr.SerNr = 193;
	if (ReadFirstMain(ORr,1,true)) then begin
		for (i=0;i<matrowcnt(ORr);i=i+1) begin
			matrowget(ORr,i,ORrw);
			weboutstring("PO SerNr: " & ORrw.ECReceived & " PO Comp: " & ORrw.ECReservComp & " PO Row " & ORrw.LCPOrow & " do not match in company " & CurrentCompany );
			weboutstring("<BR>");
			pos = 0;
			ExtractObjWithSeparator(":",ORr.OfficialSerNr,true,pos,POSerNrstr);
			ExtractObjWithSeparator(":",ORr.OfficialSerNr,true,pos,Companystr);
			ORrw.ECReceived = StringToInt(POSerNrstr);
			ORrw.ECReservComp = StringToInt(Companystr);
			ORrw.LCPOrow = i+1;
			matrowput(ORr,i,ORrw);
		end;
		recordstore(ORr,true);
		// tstr = BuildRecordIdStr(ORr,18);
		// RHr.RecidStr = tstr;
		// if(readfirstkey("RecidStr",RHr,1,true))then begin
			// ReadOriginalRecord(RHr,OrigORr);	
			// for (i=0;i<matrowcnt(OrigORr);i=i+1) begin
				// matrowget(OrigORr,i,OrigORrw);
				// ORrw.stp = 1;
				// ORrw.ArtCode = OrigORrw.ArtCode;
				// matrowput(ORr,i,ORrw);
				// ORVc_PasteArtCode(ORr,i,inwarning,warning,false);
				// matrowget(ORr,i,ORrw);
				// ORrw.ECReceived = OrigORrw.ECReceived;
				// ORrw.ECReservComp = OrigORrw.ECReservComp;
				// ORrw.Quant = OrigORrw.Quant;	
				// ORrw.Price = OrigORrw.Price;
				// ORrw.GlobalItemArtCode = OrigORrw.GlobalItemArtCode;
				// ORrw.IDAltCode = OrigORrw.IDAltCode;
				// ORrw.BasePrice = OrigORrw.BasePrice ;
				// ORrw.LCPOrow = OrigORrw.LCPOrow;
				// matrowput(ORr,i,ORrw);
			// end;
			// recordstore(ORr,true);
		// end;		
	end;
return;
end;

global webpublic updating procedure WebFindIncorrectPOInCompFromIDGroupComp()
begin
	record ORVc ORr, OrigORr;
	record RHistVc RHr;
	string 255 tstr;
	record POVc POr;
	integer OrigComp;
	string 255 Companystr, POSerNrstr;
	row ORVc ORrw;
	row POVc POrw;
	array string 255 artCodes;
	array integer aQuant;
	integer i, pos;
	record ConsItemVc CIr;
	boolean SHf, updf, IHSavef;
	longint ORSer;
	
	
	SetCompany(18,false);
	OrigComp = CurrentCompany;
	
	ORr.SerNr = -1;
	while (loopmain(ORr,1,true)) begin
		if (ORr.OrderClass=="CLIEN" and nonblank(ORr.OfficialSerNr)) then begin
			Companystr = "";
			POSerNrstr = "";
			ORSer = ORr.SerNr;
			SHf = false;
			for (i=0;i<matrowcnt(ORr);i=i+1) begin
				matrowget(ORr,i,ORrw);
				//if (ORrw.Shipd2>0) then begin SHf = true;  end;
				CIr.Code = ORrw.ArtCode;
				if (ReadFirstMain(Cir,1,true)) then begin
					artCodes[i] = Cir.LocCode;
					aQuant[i] = ORrw.Quant;
				end;
			end;
			updf = false;
			IHSavef = false;
			if (!SHf) then begin
				pos = 0;
				ExtractObjWithSeparator(":",ORr.OfficialSerNr,true,pos,POSerNrstr);
				ExtractObjWithSeparator(":",ORr.OfficialSerNr,true,pos,Companystr);

				logtext(0,Companystr);
				
				SetCompany(StringToInt(Companystr),false);
				
				POr.SerNr = StringToInt(POSerNrstr);
				if (ReadFirstMain(POr,1,true)) then begin
					for (i=0;i<matrowcnt(POr);i=i+1) begin
						matrowget(POr,i,POrw);
						if (POrw.ArtCode!=artCodes[i]) then begin
							weboutstring("OR SerNr: " & ORr.SerNr & " PO SerNr: " & POr.SerNr & " ArtCodes in row " & i + 1 & " do not match in company " & CurrentCompany );
							weboutstring("<BR>");
							IHSavef = true;
						end else begin
							if (POrw.Quant!=aQuant[i]) then begin
								weboutstring("OR SerNr: " & ORr.SerNr & " PO SerNr: " & POr.SerNr & " Different quantities in row " & i + 1 & "in company " & CurrentCompany );
								weboutstring("<BR>");
								aQuant[i] = POrw.Quant;
							end;
						end;
						
					end;
				end;
			end;
			
			resetcompany(OrigComp);
			// ORr.SerNr = ORSer;
			// if (ReadFirstMain(ORr,1,true)) then begin 
				// if (IHSavef) then begin
					// tstr = BuildRecordIdStr(ORr,18);
					// RHr.RecidStr = tstr;
					// if(readfirstkey("RecidStr",RHr,1,true))then begin
						// ReadOriginalRecord(RHr,OrigORr);	
						// for (i=0;i<matrowcnt(OrigORr);i=i+1) begin
							// matrowget(OrigORr,i,ORrw);
							// matrowput(ORr,i,ORrw);
						// end;
						// recordstore(ORr,true);
					// end;		
				// end else begin
					// for (i=0;i<matrowcnt(ORr);i=i+1) begin
						// matrowget(ORr,i,ORrw);
						// if (aQuant[i]!=ORrw.Quant) then begin
							// ORrw.Quant = aQuant[i];
							// matrowput(ORr,i,ORrw);
							// updf = true;
						// end;
					// end;
					// if (updf) then begin
						// RecordStore(ORr,true);
					// end;
				// end;
			// end;
			ClearArray(artCodes);
			ClearArray(aQuant);
		end;
	end;

return;
end;








global webpublic updating procedure WebFixBlankPathToCompPOInIDGroupComp()
begin
	record ORVc ORr, OrigORr;
	record RHistVc RHr;
	string 255 tstr;
	
	SetCompany(18,false);
	ORr.SerNr = -1;
	while (loopmain(ORr,1,true)) begin
		if (ORr.OrderClass=="CLIEN" and blank(ORr.OfficialSerNr)) then begin
			tstr = BuildRecordIdStr(ORr,18);
			
			RHr.RecidStr = tstr;
			if(readfirstkey("RecidStr",RHr,1,true))then begin
				ReadOriginalRecord(RHr,OrigORr);	
				if(ORr.OfficialSerNr!=OrigORr.OfficialSerNr and nonblank(OrigORr.OfficialSerNr))then begin
					ORr.OfficialSerNr = OrigORr.OfficialSerNr;
					recordstore(ORr,true);
				end;
			end;		
		end;
	end;

return;
end;









global webpublic updating procedure WebFixBlankPathToCompPOInIDGroupComp2()
begin
	record PUVc PUr;
	row PUVc PUrw;
	record ItemHistVc IHr;
	string 255 tstr;
	integer i;
	
	SetCompany(25,false);
	PUr.SerNr = 2312;
	if (ReadFirstMain(PUr,1,true)) then begin
		for (i=0;i<matrowcnt(PUr);i=i+1) begin
			matrowget (PUr,i,PUrw);
			if (nonblank(PUrw.ArtCode)) then begin
				IHr.FileName = "PUVc";
				IHr.TransNr = PUr.SerNr;
				IHr.Row = i;
				if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
					IHr.TransDate = stringtodate("10/01/2020");
					IHr.FIFODate = stringtodate("10/01/2020");
					recordStore(IHr,true);
				end;
			end;
		end;
		PUr.TransDate = stringtodate("10/01/2020");
		recordstore(PUr,true);
	end;
return;
end;












global webpublic updating procedure WebFindErrorSHFromIDGroupComp()
begin
	record SHVc SHr;
	row SHVc SHrw;
	record POVc POr;
	record PUVc PUr;
	row PUVc PUrw;
	boolean TrHs, testf, remf;
	integer MainCompany, i, LCNt, j;
	record ECVendFobSetBlaock CObjr;
	row ECVendFobSetBlaock CObjrw;
	vector integer vObjComp;
	vector val vItemFRV;
	record RLinkVc RLr;
	LongInt PUrSerNr, cnt1, cnt2, shcnt;
	record ItemHistVc IHr;
	vector string 255 vPosItems;
	record ConsItemVc CIr;
	
	MainCompany = 18;
	
	SetCompany(MainCompany,false);
	BlockLoad(CObjr);
	for (i=0;i<matrowcnt(CObjr);i=i+1) begin
		matrowget(CObjr,i,CObjrw);
		vObjComp[CObjrw.VendName] = CObjrw.CompanyNr;
	end;
	
	SHr.OKFlag = 1;
	TrHs = true;
	
	cnt1 = 0;
	cnt2 = 0;
	shcnt = 0;
	while (loopkey("OKFlag",SHr,1,TrHs)) begin
		if (SHr.OKFlag != 1) then begin TrHs = false; end;
		if (TrHs) then begin
			j = 0;
			for (i=0;i<matrowcnt(SHr);i=i+1)begin
				matrowget(SHr,i,SHrw);
				if (SHrw.Ship>0) then begin
					vItemFRV[SHr.SerNr & "_" & i - j] = SHrw.FIFORowVal;
					CIr.Code = SHrw.ArtCode;
					if (ReadFirstMain(CIr,1,true)) then begin
						vPosItems[SHr.SerNr & "_" & i - j] = CIr.LocCode;
					end;
				end else begin
					j = j + 1;
				end;
			end;
			LCNt = 1;
			while (ReadRecordLink(SHr,LCNt,PUr,RLr)) begin
				PUrSerNr = PUr.SerNr;
				logtext(0,PUrSerNr);
				if(setcompany(vObjComp[SHr.CustCode],false))then begin
					PUr.SerNr = PUrSerNr;
					if (ReadFirstMain(PUr,1,true)) then begin
						if (PUr.OKFlag==1) then begin
							for (i=0;i<matrowcnt(PUr);i=i+1) begin
								matrowget(PUr,i,PUrw);
								if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and vItemFRV[SHr.SerNr & "_" & i]-AbsoluteVal(PUrw.Sum) > 1.01 and vPosItems[SHr.SerNr & "_" & i]==PUrw.ArtCode) then begin
									IHr.FileName = "PUVc";
									IHr.TransNr = PUr.SerNr;
									IHr.Row = i;
									remf = false;
									if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
										if (IHr.Qty != IHr.RemQty) then begin
											remf = true;
											shcnt = shcnt + 1;
										end;
									end;
									weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum & " Remf: " & remf);
									weboutstring("<BR>");
									cnt1 = cnt1 + 1;
								end;
								if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and AbsoluteVal(PUrw.Sum)-vItemFRV[SHr.SerNr & "_" & i] > 1.01 and vPosItems[SHr.SerNr & "_" & i]==PUrw.ArtCode) then begin 
									IHr.FileName = "PUVc";
									IHr.TransNr = PUr.SerNr;
									IHr.Row = i;
									remf = false;
									if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
										if (IHr.Qty != IHr.RemQty) then begin
											remf = true;
											shcnt = shcnt + 1;
										end;
									end;
									weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum & " Remf: " & remf);
									weboutstring("<BR>");
									cnt1 = cnt1 + 1;
								end;
								// if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum < 1) then begin 
									// weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum);
									// weboutstring("<BR>");
									// cnt2 = cnt2 + 1;
								// end;
							end;
						end;
					end;
				end;
				resetcompany(MainCompany);
				LCNt = LCNt + 1;
			end;
		end;
	end;
	weboutstring("Items > 1 diff " & cnt1);
	weboutstring("<BR>");
	weboutstring("Shipped items " & shcnt);
	weboutstring("<BR>");
return;
end;



global updating procedure ClearAltcode(record INVc INr)
begin

	record INVc AltINr;
	
	AltINr.Code = INr.AlternativeCode;
	if (ReadFirstMain(AltINr,1,true)) then begin
		INr.AlternativeCode = "";
		if (recordStore (INr,true)) then begin
			logtext (0,"Alt code " & INr.AlternativeCode & " in Item with code " & INr.Code & "is cleared in company No " & CurrentCompany);
		end;
	end;
	
return;
end;




global webpublic procedure WebFindAndClearAltCodesInCodes()
begin
	record INVc INr;
	record CompaniesBlock CBb;
	row CompaniesBlock Comprw;
	integer i, slipcont, cnt, allINs;
	array string 255 INrs;
	boolean TrHs;
	
	BlockLoad(CBb);
	for (i=9;i<matrowcnt(CBb);i=i+1) begin
		matrowget(CBb,i,Comprw);
		allINs = 0;
		if(Comprw.ActiveStatus==0 and i+1!=18 and i+1!=29 and i+1!=31 and i+1!=32 and i+1!=33) then begin
			SetCompany(i+1,false);
			slipcont = 0;
			INr.Code = "";
			cnt = 0;
			TrHs = true;
			while (loopmain(INr,1,TrHs)) begin
				if (nonblank(INr.AlternativeCode)) then begin
					INrs[cnt] = INr.Code;
					cnt = cnt + 1;
				end;
				if(fileexists("stop"))then begin TrHs = false; cnt = 0; i = matrowcnt(CBb); end;
			end;
			resetloop(INr);
			allINs = cnt;
			for (cnt=0;cnt<allINs;cnt=cnt+1)begin
				INr.Code = INrs[cnt];
				if (ReadFirstMain(INr,1,true)) then begin
					queued.ClearAltcode(INr);
					// slipcont = slipcont + 1;					
					// if(slipcont>3)then begin
						// millisleep(350);
						// slipcont = 0;
					// end;
				end;
				if(fileexists("stop"))then begin cnt = allINs; i = matrowcnt(CBb); end;
			end;
			ClearArray(INrs);
		end;
	end;
	logtext (0,"WebFindAndClearAltCodesInCodes finished");		
return;
end;


global updating procedure CalcPUTotalsQD(record PUVc PUr)
begin

	row PUVc PUrw;
	integer i;
	val correctTotal;
	
	if (ReadFirstMain(PUr,1,true)) then begin
		correctTotal = 0;
		for (i=0;i<matrowcnt(PUr);i=i+1) begin
			matrowget(PUr,i,PUrw);
			correctTotal = correctTotal + PUrw.Sum;
		end;
		if (correctTotal!=PUr.PayVal) then begin
			PUr.PayVal = correctTotal;
			PUr.SumCostPrice = correctTotal;
			if (recordStore (PUr,true)) then begin
				logtext (0,"PU No" & PUr.SerNr & " updated in company " & CurrentCompany);
			end;
		end else begin
			logtext (0,"PU No" & PUr.SerNr & " is normal in company " & CurrentCompany);
		end;
	end;
	
return;
end;





global webpublic procedure WebFindAndEditIncorrectTotals()
begin
	record INVc INr;
	record CompaniesBlock CBb;
	row CompaniesBlock Comprw;
	integer i, slipcont, cnt, allINs;
	array string 255 INrs;
	boolean TrHs;
	record PUVc PUr;
	row PUVc PUrw;
	
	logtext (0,"WebFindAndEditIncorrectTotals started");		
	BlockLoad(CBb);
	for (i=0;i<matrowcnt(CBb);i=i+1) begin
		matrowget(CBb,i,Comprw);
		if(Comprw.ActiveStatus==0 and i+1!=18 and i+1!=29 and i+1!=31 and i+1!=32 and i+1!=33) then begin
			SetCompany(i+1,false);
			slipcont = 0;
			TrHs = true;
			PUr.VECode = "FOB_SKLAD";
			while (loopkey("VECode",PUr,1,TrHs)) begin
				if (PUr.VECode!="FOB_SKLAD") then begin TrHs = false; end;
				if (TrHs) then begin
					queued.CalcPUTotalsQD(PUr);
					slipcont = slipcont + 1;					
					if(slipcont>3)then begin
						millisleep(350);
						slipcont = 0;
					end;
				end;
			end;
			Resetloop(PUr);
		end;
	end;
	logtext (0,"WebFindAndEditIncorrectTotals finished");		
return;
end;






global webpublic updating procedure WebFillExtprItemsCodeForms()  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:50 23.06.2020
begin
	record INVc INr;
	boolean TrHs, testf;
	record GlobalItemVc GIr;
	
	logtext(0,"WebFillExtprItemsCodeForms");
	
	SetCompany(29,false);
	TrHs = true;
	INr.Code = "SB00001";
	while (loopmain(INr,1,TrHs)) begin
		testf = true;
		if (left(INr.Code,2)!="SB") then begin TrHs = false; testf = false; end;
		if (testf) then begin
			GIr.Code = INr.GlobalArtCode;
			if (ReadFirstMain(Gir,1,true)) then begin
				GIr.ExtProwItRegulations = 1;
				recordstore(GIr,true);
			end;
			logtext (0,INr.Code);
		end;
	end;
	resetloop(INr);
return;
end;






global webpublic updating procedure WebReplaceClassFrom29to1Comp()  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:50 23.06.2020
begin

	record BtrxComplicationsVc Comr;
	record BtrxMicrowaveProtectVc MPr;
	record BtrxStoveCompatVc SCr;
	record BtrxAllMaterialsVc AMr;
	record BtrxPrecMetalContVc PMCr;
	record BtrxCaseDiamVc CDr;
	vector string 255 vClassCodeNames;
	array string 255 AClassCodes;
	longint i, classcnt;
	
	setcompany(29,false);
	Comr.Code = "";
	i = 0;
	while (loopmain(Comr,1,true)) begin
		AClassCodes[i] = Comr.Code;
		vClassCodeNames[AClassCodes[i] & "Eng"] = Comr.Name;
		vClassCodeNames[AClassCodes[i] & "Rus"] = Comr.NameRUS;
		vClassCodeNames[AClassCodes[i] & "Az"] = Comr.NameAZ;
		i=i+1;
	end;
	Resetloop(Comr);
	classcnt = i;
	setcompany(4,false);
	Comr.Code = "CMP99999";
	while (loopbackkey("Code",Comr,1,true)) begin
		if (blank(vClassCodeNames[Comr.Code & "Rus"])) then begin
			vClassCodeNames[Comr.Code & "Rus"] = Comr.NameRUS;
		end;
		if (blank(vClassCodeNames[Comr.Code & "Az"])) then begin
			vClassCodeNames[Comr.Code & "Az"] = Comr.NameAZ;
		end;
		recorddelete(Comr);
	end;
	Resetloop(Comr);
	setcompany(1,false);
	Comr.Code = "CMP99999";
	while (loopbackkey("Code",Comr,1,true)) begin
		recorddelete(Comr);
	end;
	Resetloop(Comr);
	
	for (i=0;i<classcnt;i=i+1) begin
		recordNew(Comr);
		Comr.Code = AClassCodes[i];
		Comr.Name = vClassCodeNames[AClassCodes[i] & "Eng"];
		Comr.NameRUS = vClassCodeNames[AClassCodes[i] & "Rus"];
		Comr.NameAZ = vClassCodeNames[AClassCodes[i] & "Az"];
		RecordStore(Comr,true);
	end;
	clearArray(AClassCodes);
	clearVector(vClassCodeNames);

	setcompany(29,false);
	MPr.Code = "";
	i = 0;
	while (loopmain(MPr,1,true)) begin
		AClassCodes[i] = MPr.Code;
		vClassCodeNames[AClassCodes[i] & "Eng"] = MPr.Name;
		vClassCodeNames[AClassCodes[i] & "Rus"] = MPr.NameRUS;
		vClassCodeNames[AClassCodes[i] & "Az"] = MPr.NameAZ;
		i=i+1;
	end;
	Resetloop(MPr);
	classcnt = i;
	setcompany(4,false);
	MPr.Code = "MPR99999";
	while (loopbackkey("Code",MPr,1,true)) begin
		if (blank(vClassCodeNames[MPr.Code & "Rus"])) then begin
			vClassCodeNames[MPr.Code & "Rus"] = MPr.NameRUS;
		end;
		if (blank(vClassCodeNames[MPr.Code & "Az"])) then begin
			vClassCodeNames[MPr.Code & "Az"] = MPr.NameAZ;
		end;
		recorddelete(MPr);
	end;
	Resetloop(MPr);
	setcompany(1,false);
	MPr.Code = "MPR99999";
	while (loopbackkey("Code",MPr,1,true)) begin
		recorddelete(MPr);
	end;
	Resetloop(MPr);
	
	for (i=0;i<classcnt;i=i+1) begin
		recordNew(MPr);
		MPr.Code = AClassCodes[i];
		MPr.Name = vClassCodeNames[AClassCodes[i] & "Eng"];
		MPr.NameRUS = vClassCodeNames[AClassCodes[i] & "Rus"];
		MPr.NameAZ = vClassCodeNames[AClassCodes[i] & "Az"];
		RecordStore(MPr,true);
	end;
	clearArray(AClassCodes);
	clearVector(vClassCodeNames);

	setcompany(29,false);
	SCr.Code = "";
	i = 0;
	while (loopmain(SCr,1,true)) begin
		AClassCodes[i] = SCr.Code;
		vClassCodeNames[AClassCodes[i] & "Eng"] = SCr.Name;
		vClassCodeNames[AClassCodes[i] & "Rus"] = SCr.NameRUS;
		vClassCodeNames[AClassCodes[i] & "Az"] = SCr.NameAZ;
		i=i+1;
	end;
	Resetloop(SCr);
	classcnt = i;
	setcompany(4,false);
	SCr.Code = "STC99999";
	while (loopbackkey("Code",SCr,1,true)) begin
		if (blank(vClassCodeNames[SCr.Code & "Rus"])) then begin
			vClassCodeNames[SCr.Code & "Rus"] = SCr.NameRUS;
		end;
		if (blank(vClassCodeNames[SCr.Code & "Az"])) then begin
			vClassCodeNames[SCr.Code & "Az"] = SCr.NameAZ;
		end;
		recorddelete(SCr);
	end;
	Resetloop(SCr);
	setcompany(1,false);
	SCr.Code = "STC99999";
	while (loopbackkey("Code",SCr,1,true)) begin
		recorddelete(SCr);
	end;
	Resetloop(SCr);
	
	for (i=0;i<classcnt;i=i+1) begin
		recordNew(SCr);
		SCr.Code = AClassCodes[i];
		SCr.Name = vClassCodeNames[AClassCodes[i] & "Eng"];
		SCr.NameRUS = vClassCodeNames[AClassCodes[i] & "Rus"];
		SCr.NameAZ = vClassCodeNames[AClassCodes[i] & "Az"];
		RecordStore(SCr,true);
	end;
	clearArray(AClassCodes);
	clearVector(vClassCodeNames);
	
	setcompany(29,false);
	AMr.Code = "";
	i = 0;
	while (loopmain(AMr,1,true)) begin
		AClassCodes[i] = AMr.Code;
		vClassCodeNames[AClassCodes[i] & "Eng"] = AMr.Name;
		vClassCodeNames[AClassCodes[i] & "Rus"] = AMr.NameRUS;
		vClassCodeNames[AClassCodes[i] & "Az"] = AMr.NameAZ;
		i=i+1;
	end;
	Resetloop(AMr);
	classcnt = i;
	setcompany(4,false);
	AMr.Code = "AM999999";
	while (loopbackkey("Code",AMr,1,true)) begin
		if (blank(vClassCodeNames[AMr.Code & "Rus"])) then begin
			vClassCodeNames[AMr.Code & "Rus"] = AMr.NameRUS;
		end;
		if (blank(vClassCodeNames[AMr.Code & "Az"])) then begin
			vClassCodeNames[AMr.Code & "Az"] = AMr.NameAZ;
		end;
		recorddelete(AMr);
	end;
	Resetloop(AMr);
	setcompany(1,false);
	AMr.Code = "AM999999";
	while (loopbackkey("Code",AMr,1,true)) begin
		recorddelete(AMr);
	end;
	Resetloop(AMr);
	
	for (i=0;i<classcnt;i=i+1) begin
		recordNew(AMr);
		AMr.Code = AClassCodes[i];
		AMr.Name = vClassCodeNames[AClassCodes[i] & "Eng"];
		AMr.NameRUS = vClassCodeNames[AClassCodes[i] & "Rus"];
		AMr.NameAZ = vClassCodeNames[AClassCodes[i] & "Az"];
		RecordStore(AMr,true);
	end;
	clearArray(AClassCodes);
	clearVector(vClassCodeNames);
	
	setcompany(29,false);
	PMCr.Code = "";
	i = 0;
	while (loopmain(PMCr,1,true)) begin
		AClassCodes[i] = PMCr.Code;
		vClassCodeNames[AClassCodes[i] & "Eng"] = PMCr.Name;
		vClassCodeNames[AClassCodes[i] & "Rus"] = PMCr.NameRUS;
		vClassCodeNames[AClassCodes[i] & "Az"] = PMCr.NameAZ;
		i=i+1;
	end;
	Resetloop(PMCr);
	classcnt = i;
	setcompany(4,false);
	PMCr.Code = "PMC99999";
	while (loopbackkey("Code",PMCr,1,true)) begin
		if (blank(vClassCodeNames[PMCr.Code & "Rus"])) then begin
			vClassCodeNames[PMCr.Code & "Rus"] = PMCr.NameRUS;
		end;
		if (blank(vClassCodeNames[PMCr.Code & "Az"])) then begin
			vClassCodeNames[PMCr.Code & "Az"] = PMCr.NameAZ;
		end;
		recorddelete(PMCr);
	end;
	Resetloop(PMCr);
	setcompany(1,false);
	PMCr.Code = "PMC99999";
	while (loopbackkey("Code",PMCr,1,true)) begin
		recorddelete(PMCr);
	end;
	Resetloop(PMCr);
	
	for (i=0;i<classcnt;i=i+1) begin
		recordNew(PMCr);
		PMCr.Code = AClassCodes[i];
		PMCr.Name = vClassCodeNames[AClassCodes[i] & "Eng"];
		PMCr.NameRUS = vClassCodeNames[AClassCodes[i] & "Rus"];
		PMCr.NameAZ = vClassCodeNames[AClassCodes[i] & "Az"];
		RecordStore(PMCr,true);
	end;
	clearArray(AClassCodes);
	clearVector(vClassCodeNames);
	
	setcompany(29,false);
	CDr.Code = "";
	i = 0;
	while (loopmain(CDr,1,true)) begin
		AClassCodes[i] = CDr.Code;
		vClassCodeNames[AClassCodes[i] & "Eng"] = CDr.Name;
		vClassCodeNames[AClassCodes[i] & "Rus"] = CDr.NameRUS;
		vClassCodeNames[AClassCodes[i] & "Az"] = CDr.NameAZ;
		i=i+1;
	end;
	Resetloop(CDr);
	classcnt = i;
	setcompany(4,false);
	CDr.Code = "CD999999";
	while (loopbackkey("Code",CDr,1,true)) begin
		if (blank(vClassCodeNames[CDr.Code & "Rus"])) then begin
			vClassCodeNames[CDr.Code & "Rus"] = CDr.NameRUS;
		end;
		if (blank(vClassCodeNames[CDr.Code & "Az"])) then begin
			vClassCodeNames[CDr.Code & "Az"] = CDr.NameAZ;
		end;
		recorddelete(CDr);
	end;
	Resetloop(CDr);
	setcompany(1,false);
	CDr.Code = "CD999999";
	while (loopbackkey("Code",CDr,1,true)) begin
		recorddelete(CDr);
	end;
	Resetloop(CDr);
	
	for (i=0;i<classcnt;i=i+1) begin
		recordNew(CDr);
		CDr.Code = AClassCodes[i];
		CDr.Name = vClassCodeNames[AClassCodes[i] & "Eng"];
		CDr.NameRUS = vClassCodeNames[AClassCodes[i] & "Rus"];
		CDr.NameAZ = vClassCodeNames[AClassCodes[i] & "Az"];
		RecordStore(CDr,true);
	end;
	clearArray(AClassCodes);
	clearVector(vClassCodeNames);

return;
end;



global webpublic updating procedure WebDeleteClassInOtherComps()  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:50 23.06.2020
begin

	record BtrxComplicationsVc Comr;
	record BtrxMicrowaveProtectVc MPr;
	record BtrxStoveCompatVc SCr;
	record BtrxAllMaterialsVc AMr;
	record BtrxPrecMetalContVc PMCr;
	record BtrxCaseDiamVc CDr;
	vector string 255 vClassCodeNames;
	array string 255 AClassCodes;
	longint i, classcnt;
	
	for (i=2;i<34;i=i+1) begin
		SetCompany (i,false);
		Comr.Code = "CMP99999";
		while (loopbackkey("Code",Comr,1,true)) begin
			recorddelete(Comr);
		end;
		Resetloop(Comr);
		MPr.Code = "MPR99999";
		while (loopbackkey("Code",MPr,1,true)) begin
			recorddelete(MPr);
		end;
		Resetloop(MPr);
		SCr.Code = "STC99999";
		while (loopbackkey("Code",SCr,1,true)) begin
			recorddelete(SCr);
		end;
		Resetloop(SCr);
		AMr.Code = "AM999999";
		while (loopbackkey("Code",AMr,1,true)) begin
			recorddelete(AMr);
		end;
		Resetloop(AMr);
		PMCr.Code = "PMC99999";
		while (loopbackkey("Code",PMCr,1,true)) begin
			recorddelete(PMCr);
		end;
		Resetloop(PMCr);
		CDr.Code = "CD999999";
		while (loopbackkey("Code",CDr,1,true)) begin
			recorddelete(CDr);
		end;
		Resetloop(CDr);
	end;
	
return;
end;




global webpublic updating procedure WebFindErrorsCostPrFromIDGroup2()  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:50 23.06.2020
begin
	record NewINVc NINr;
	row NewINVc NINrw;
	longint NewINSerNr, i, mainComp, j, y;
	record CompaniesBlock CBb;	
	row CompaniesBlock CBrw;	
	array integer aCompNo;
	record ConsItemVc CIr;
	record PUVc PUr;
	record ItemHistVc IHr;
	val CostInCurrency, POCompCost, POIDCost;
	string 255 correncyCode;
	date PUTransDate, blankTD, POIDDate;
	record INVc INr;
	record POVc POr;
	row POVc POrw;
	boolean POFlag, NINSErNrf;
	
	blockload(CBb);
	mainComp = 18;
	SetCompany(mainComp,false);

	NewINSerNr = StringToLongInt(WebGetArg("newinno"));
	if (NewINSerNr>-1) then begin
		NINr.SerNr = NewINSerNr;
		if (readfirstmain(NINr,1,true)) then begin
			for (i=0;i<matrowcnt(NINr);i=i+1) begin
				matrowget(NINr,i,NINrw);
				CIr.Code = NINrw.Code;
				PUTransDate = blankTD;
				CostInCurrency = blankval;
				correncyCode = "";
				if (ReadFirstMain(CIr,1,true)) then begin
					IHr.ArtCode = NINrw.Code;
					IHr.FileName = "PUVc";
					if (ReadLastKey("FNArtCode",IHr,2,true)) then begin
						PUTransDate = IHr.TransDate;
						CostInCurrency = IHr.TotCostPriceCurncy/IHr.Qty;
						correncyCode = IHr.RemCostPriceCurncy;
						POr.TransDate = PUTransDate;
						POIDCost = blankval;
						POIDDate = blankTD;
						// while (loopkey("TransDate",POr,1,true)) begin
							// if (POr.OKFlag==1) then begin
								// for (y=0;y<matrowcnt(POr);y=y+1) begin
									// matrowget(POr,y,POrw);
									// if (POrw.ArtCode == CIr.Code) then begin
										// POIDCost = POrw.Sum/POrw.Quant;
										// POIDDate = POr.TransDate;
									// end;
								// end;
							// end;
						// end;
						resetloop(POr);
						
						for (j=0;j<matrowcnt(CBb);j=j+1) begin
							matrowget(CBb,j,CBrw);
							if(CBrw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(j+1) or j+1==3) and j+1!=18 and j+1!=33 and j+1!=32)then begin
								SetCompany(j+1,false);
								INr.Code = CIr.LocCode;
								if (readfirstMain(INr,1,true)) then begin
									if (INr.BPIBrand==CIr.BrandCode) then begin
										IHr.ArtCode = CIr.LocCode;
										IHr.FileName = "PUVc";
										if (ReadLastKey("FNArtCode",IHr,2,true)) then begin
											PUr.SerNr = IHr.TransNr;
											if (ReadFirstMain(PUr,1,true)) then begin end;
											if (PUr.TransDate>PUTransDate) then begin
												POr.TransDate = PUr.TransDate;
											end else begin
												POr.TransDate = PUTransDate;
											end;
											// if (POIDDate>POr.TransDate) then begin
												// POr.TransDate = POIDDate;
											// end;
											POCompCost = blankval;
											while (loopkey("TransDate",POr,1,true)) begin
												if (POr.OKFlag==1) then begin
													for (y=0;y<matrowcnt(POr);y=y+1) begin
														matrowget(POr,y,POrw);
														if (POrw.ArtCode == CIr.LocCode) then begin
															POCompCost = POrw.Sum/POrw.Quant;
														end;
													end;
												end;
											end;
											resetloop(POr);
											if (POCompCost!=blankval and POCompCost != INr.LastPurchPrice2) then begin
												weboutstring("Company: " & CBrw.ShortName & " IDG ItemCode: " & CIr.Code & " Company ItemCode: " & CIr.LocCode & " In INVc LPP: " & INr.LastPurchPrice2 & " In PUVc Price: " & POCompCost & " From PO in current company");
												weboutstring("<BR>");
											end;
											if (POCompCost==blankval and POIDCost!=blankval and POIDCost!=INr.LastPurchPrice2 and POIDDate>PUTransDate and POIDDate>IHr.TransDate) then begin
												weboutstring("Company: " & CBrw.ShortName & " IDG ItemCode: " & CIr.Code & " Company ItemCode: " & CIr.LocCode & " In INVc LPP: " & INr.LastPurchPrice2 & " In PUVc Price: " & POIDCost & " From PO in IDG company");
												weboutstring("<BR>");
											end;
											resetloop(POr);
											if (POCompCost==blankval and POIDCost==blankval) then begin
												if (PUTransDate < IHr.TransDate and left(PUr.VECode,3)!="FOB") then begin
													if (IHr.TotCostPriceCurncy/IHr.Qty!=INr.LastPurchPrice2) then begin
														weboutstring("Company: " & CBrw.ShortName & " IDG ItemCode: " & CIr.Code & " Company ItemCode: " & CIr.LocCode & " In INVc LPP: " & INr.LastPurchPrice2 & " In PUVc Price: " & IHr.TotCostPriceCurncy/IHr.Qty & " From PU in current company");
														weboutstring("<BR>");
													end;
												end else begin
													if (CostInCurrency!=INr.LastPurchPrice2) then begin
														weboutstring("Company: " & CBrw.ShortName & " IDG ItemCode: " & CIr.Code & " Company ItemCode: " & CIr.LocCode & " In INVc LPP: " & INr.LastPurchPrice2 & " In PUVc Price: " & CostInCurrency & " From PU in IDG company");
														weboutstring("<BR>");
													end;
												end;
											end;
										end;
									end;
								end;
							end;
						end;
						resetcompany(mainComp);
					end;
				end;
			end;
		end;
	end else begin
		NINr.SerNr = 0;
		while (loopmain(NINr,1,true)) begin
			NINSErNrf = false;
			for (i=0;i<matrowcnt(NINr);i=i+1) begin
				matrowget(NINr,i,NINrw);
				CIr.Code = NINrw.Code;
				PUTransDate = blankTD;
				CostInCurrency = blankval;
				correncyCode = "";
				if (ReadFirstMain(CIr,1,true)) then begin
					IHr.ArtCode = NINrw.Code;
					IHr.FileName = "PUVc";
					if (ReadLastKey("FNArtCode",IHr,2,true)) then begin
						PUTransDate = IHr.TransDate;
						CostInCurrency = IHr.TotCostPriceCurncy/IHr.Qty;
						correncyCode = IHr.RemCostPriceCurncy;
						POr.TransDate = PUTransDate;
						POIDCost = blankval;
						POIDDate = blankTD;
						// while (loopkey("TransDate",POr,1,true)) begin
							// if (POr.OKFlag==1) then begin
								// for (y=0;y<matrowcnt(POr);y=y+1) begin
									// matrowget(POr,y,POrw);
									// if (POrw.ArtCode == CIr.Code) then begin
										// POIDCost = POrw.Sum/POrw.Quant;
										// POIDDate = POr.TransDate;
									// end;
								// end;
							// end;
						// end;
						resetloop(POr);
						
						for (j=0;j<matrowcnt(CBb);j=j+1) begin
							matrowget(CBb,j,CBrw);
							if(CBrw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(j+1) or j+1==3) and j+1!=18 and j+1!=33 and j+1!=32)then begin
								SetCompany(j+1,false);
								INr.Code = CIr.LocCode;
								if (readfirstMain(INr,1,true)) then begin
									if (INr.BPIBrand==CIr.BrandCode) then begin
										IHr.ArtCode = CIr.LocCode;
										IHr.FileName = "PUVc";
										if (ReadLastKey("FNArtCode",IHr,2,true)) then begin
											PUr.SerNr = IHr.TransNr;
											if (ReadFirstMain(PUr,1,true)) then begin end;
											if (PUr.TransDate>PUTransDate) then begin
												POr.TransDate = PUr.TransDate;
											end else begin
												POr.TransDate = PUTransDate;
											end;
											// if (POIDDate>POr.TransDate) then begin
												// POr.TransDate = POIDDate;
											// end;
											POCompCost = blankval;
											while (loopkey("TransDate",POr,1,true)) begin
												if (POr.OKFlag==1) then begin
													for (y=0;y<matrowcnt(POr);y=y+1) begin
														matrowget(POr,y,POrw);
														if (POrw.ArtCode == CIr.LocCode) then begin
															POCompCost = POrw.Sum/POrw.Quant;
														end;
													end;
												end;
											end;
											resetloop(POr);
											if (POCompCost!=blankval and POCompCost != INr.LastPurchPrice2) then begin
												if (!NINSErNrf) then begin
													NINSErNrf = true;
													weboutstring("************************************************* SerNr: " & NINr.SerNr & " ********************************************************");
													weboutstring("<BR>");
												end;
												weboutstring("Company: " & CBrw.ShortName & " IDG ItemCode: " & CIr.Code & " Company ItemCode: " & CIr.LocCode & " In INVc LPP: " & INr.LastPurchPrice2 & " In PUVc Price: " & POCompCost & " From PO in current company");
												weboutstring("<BR>");
											end;
											if (POCompCost==blankval and POIDCost!=blankval and POIDCost!=INr.LastPurchPrice2 and POIDDate>PUTransDate and POIDDate>IHr.TransDate) then begin
												if (!NINSErNrf) then begin
													NINSErNrf = true;
													weboutstring("************************************************* SerNr: " & NINr.SerNr & " ********************************************************");
													weboutstring("<BR>");
												end;
												weboutstring("Company: " & CBrw.ShortName & " IDG ItemCode: " & CIr.Code & " Company ItemCode: " & CIr.LocCode & " In INVc LPP: " & INr.LastPurchPrice2 & " In PUVc Price: " & POIDCost & " From PO in IDG company");
												weboutstring("<BR>");
											end;
											resetloop(POr);
											if (POCompCost==blankval and POIDCost==blankval) then begin
												if (PUTransDate < IHr.TransDate and left(PUr.VECode,3)!="FOB") then begin
													if (IHr.TotCostPriceCurncy/IHr.Qty!=INr.LastPurchPrice2) then begin
														if (!NINSErNrf) then begin
															NINSErNrf = true;
															weboutstring("************************************************* SerNr: " & NINr.SerNr & " ********************************************************");
															weboutstring("<BR>");
														end;
														weboutstring("Company: " & CBrw.ShortName & " IDG ItemCode: " & CIr.Code & " Company ItemCode: " & CIr.LocCode & " In INVc LPP: " & INr.LastPurchPrice2 & " In PUVc Price: " & IHr.TotCostPriceCurncy/IHr.Qty & " From PU in current company");
														weboutstring("<BR>");
													end;
												end else begin
													if (CostInCurrency!=INr.LastPurchPrice2) then begin
														if (!NINSErNrf) then begin
															NINSErNrf = true;
															weboutstring("************************************************* SerNr: " & NINr.SerNr & " ********************************************************");
															weboutstring("<BR>");
														end;
														weboutstring("Company: " & CBrw.ShortName & " IDG ItemCode: " & CIr.Code & " Company ItemCode: " & CIr.LocCode & " In INVc LPP: " & INr.LastPurchPrice2 & " In PUVc Price: " & CostInCurrency & " From PU in IDG company");
														weboutstring("<BR>");
													end;
												end;
											end;
										end;
									end;
								end;
							end;
						end;
						resetcompany(mainComp);
					end;
				end;
			end;
		end;
	end;
	
return;
end;



global updating procedure UpdIN(var record INVc OldINr,var record INVc INr)
begin
	if (RecordUpdate(OldINr,INr,true)==0) then begin
		logtext (0,"Updated INVc: " & INr.Code & " In company: " & CurrentCompany);
	end;
return;
end;





global webpublic procedure WebQueuedUpdCostPrFromIDGroup2()  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:50 23.06.2020
begin
	record NewINVc NINr;
	row NewINVc NINrw;
	longint NewINSerNr, i, mainComp, j, y, slipcont;
	record CompaniesBlock CBb;	
	row CompaniesBlock CBrw;	
	array integer aCompNo;
	record ConsItemVc CIr;
	record PUVc PUr;
	record ItemHistVc IHr;
	val CostInCurrency, POCompCost, POIDCost;
	string 255 correncyCode;
	date PUTransDate, blankTD, POIDDate;
	record INVc INr, OldINr;
	record POVc POr;
	row POVc POrw;
	boolean POFlag, NINSErNrf, TrHs;
	
	blockload(CBb);
	mainComp = 18;
	SetCompany(mainComp,false);
	logtext(0,"WebQueuedUpdCostPrFromIDGroup2 START");
	NewINSerNr = StringToLongInt(WebGetArg("newinno"));
	if (NewINSerNr>-1) then begin
		NINr.SerNr = NewINSerNr;
		if (readfirstmain(NINr,1,true)) then begin
			for (i=0;i<matrowcnt(NINr);i=i+1) begin
				matrowget(NINr,i,NINrw);
				CIr.Code = NINrw.Code;
				PUTransDate = blankTD;
				CostInCurrency = blankval;
				correncyCode = "";
				if (ReadFirstMain(CIr,1,true)) then begin
					IHr.ArtCode = NINrw.Code;
					IHr.FileName = "PUVc";
					if (ReadLastKey("FNArtCode",IHr,2,true)) then begin
						PUTransDate = IHr.TransDate;
						CostInCurrency = IHr.TotCostPriceCurncy/IHr.Qty;
						correncyCode = IHr.RemCostPriceCurncy;
						POr.TransDate = PUTransDate;
						POIDCost = blankval;
						POIDDate = blankTD;
						// while (loopkey("TransDate",POr,1,true)) begin
							// if (POr.OKFlag==1) then begin
								// for (y=0;y<matrowcnt(POr);y=y+1) begin
									// matrowget(POr,y,POrw);
									// if (POrw.ArtCode == CIr.Code) then begin
										// POIDCost = POrw.Sum/POrw.Quant;
										// POIDDate = POr.TransDate;
									// end;
								// end;
							// end;
						// end;
						resetloop(POr);
						
						for (j=0;j<matrowcnt(CBb);j=j+1) begin
							matrowget(CBb,j,CBrw);
							if(CBrw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(j+1) or j+1==3) and j+1!=18 and j+1!=33 and j+1!=32)then begin
								SetCompany(j+1,false);
								INr.Code = CIr.LocCode;
								if (readfirstMain(INr,1,true)) then begin
									if (INr.BPIBrand==CIr.BrandCode) then begin
										IHr.ArtCode = CIr.LocCode;
										IHr.FileName = "PUVc";
										if (ReadLastKey("FNArtCode",IHr,2,true)) then begin
											PUr.SerNr = IHr.TransNr;
											if (ReadFirstMain(PUr,1,true)) then begin end;
											if (PUr.TransDate>PUTransDate) then begin
												POr.TransDate = PUr.TransDate;
											end else begin
												POr.TransDate = PUTransDate;
											end;
											// if (POIDDate>POr.TransDate) then begin
												// POr.TransDate = POIDDate;
											// end;
											POCompCost = blankval;
											while (loopkey("TransDate",POr,1,true)) begin
												if (POr.OKFlag==1) then begin
													for (y=0;y<matrowcnt(POr);y=y+1) begin
														matrowget(POr,y,POrw);
														if (POrw.ArtCode == CIr.LocCode) then begin
															POCompCost = POrw.Sum/POrw.Quant;
														end;
													end;
												end;
											end;
											resetloop(POr);
											if (POCompCost!=blankval and POCompCost != INr.LastPurchPrice2) then begin
												RecordCopy(OldINr,INr);
												INr.LastPurchPrice2 = POCompCost;
												queued.UpdIN(OldINr,INr);
												if(slipcont>2)then begin
													millisleep(100);
													slipcont = 0;
												end;
											end;
											if (POCompCost==blankval and POIDCost!=blankval and POIDCost!=INr.LastPurchPrice2 and POIDDate>PUTransDate and POIDDate>IHr.TransDate) then begin
												RecordCopy(OldINr,INr);
												INr.LastPurchPrice2 = POIDCost;
												queued.UpdIN(OldINr,INr);
												slipcont = slipcont + 1;
												if(slipcont>2)then begin
													millisleep(100);
													slipcont = 0;
												end;
											end;
											resetloop(POr);
											if (POCompCost==blankval and POIDCost==blankval) then begin
												if (PUTransDate < IHr.TransDate and left(PUr.VECode,3)!="FOB") then begin
													if (IHr.TotCostPriceCurncy/IHr.Qty!=INr.LastPurchPrice2) then begin
														RecordCopy(OldINr,INr);
														INr.LastPurchPrice2 = IHr.TotCostPriceCurncy/IHr.Qty;
														queued.UpdIN(OldINr,INr);
														slipcont = slipcont + 1;
														if(slipcont>2)then begin
															millisleep(100);
															slipcont = 0;
														end;
													end;
												end else begin
													if (CostInCurrency!=INr.LastPurchPrice2) then begin
														RecordCopy(OldINr,INr);
														INr.LastPurchPrice2 = CostInCurrency;
														queued.UpdIN(OldINr,INr);
														slipcont = slipcont + 1;
														if(slipcont>2)then begin
															millisleep(100);
															slipcont = 0;
														end;
													end;
												end;
											end;
										end;
									end;
								end;
							end;
						end;
						resetcompany(mainComp);
					end;
				end;
			end;
		end;
	end else begin
		NINr.SerNr = 0;
		TrHs = true;
		while (loopmain(NINr,1,TrHs)) begin
			if(fileexists("stop"))then begin TrHs = false; end;
			NINSErNrf = false;
			for (i=0;i<matrowcnt(NINr);i=i+1) begin
				if(fileexists("stop"))then begin i=matrowcnt(NINr); end;
				matrowget(NINr,i,NINrw);
				CIr.Code = NINrw.Code;
				PUTransDate = blankTD;
				CostInCurrency = blankval;
				correncyCode = "";
				if (ReadFirstMain(CIr,1,true)) then begin
					IHr.ArtCode = NINrw.Code;
					IHr.FileName = "PUVc";
					if (ReadLastKey("FNArtCode",IHr,2,true)) then begin
						PUTransDate = IHr.TransDate;
						CostInCurrency = IHr.TotCostPriceCurncy/IHr.Qty;
						correncyCode = IHr.RemCostPriceCurncy;
						POr.TransDate = PUTransDate;
						POIDCost = blankval;
						POIDDate = blankTD;
						// while (loopkey("TransDate",POr,1,true)) begin
							// if (POr.OKFlag==1) then begin
								// for (y=0;y<matrowcnt(POr);y=y+1) begin
									// matrowget(POr,y,POrw);
									// if (POrw.ArtCode == CIr.Code) then begin
										// POIDCost = POrw.Sum/POrw.Quant;
										// POIDDate = POr.TransDate;
									// end;
								// end;
							// end;
						// end;
						resetloop(POr);
						
						for (j=0;j<matrowcnt(CBb);j=j+1) begin
							matrowget(CBb,j,CBrw);
							if(CBrw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(j+1) or j+1==3) and j+1!=18 and j+1!=33 and j+1!=32)then begin
								SetCompany(j+1,false);
								INr.Code = CIr.LocCode;
								if (readfirstMain(INr,1,true)) then begin
									if (INr.BPIBrand==CIr.BrandCode) then begin
										IHr.ArtCode = CIr.LocCode;
										IHr.FileName = "PUVc";
										if (ReadLastKey("FNArtCode",IHr,2,true)) then begin
											PUr.SerNr = IHr.TransNr;
											if (ReadFirstMain(PUr,1,true)) then begin end;
											if (PUr.TransDate>PUTransDate) then begin
												POr.TransDate = PUr.TransDate;
											end else begin
												POr.TransDate = PUTransDate;
											end;
											// if (POIDDate>POr.TransDate) then begin
												// POr.TransDate = POIDDate;
											// end;
											POCompCost = blankval;
											while (loopkey("TransDate",POr,1,true)) begin
												if (POr.OKFlag==1) then begin
													for (y=0;y<matrowcnt(POr);y=y+1) begin
														matrowget(POr,y,POrw);
														if (POrw.ArtCode == CIr.LocCode) then begin
															POCompCost = POrw.Sum/POrw.Quant;
														end;
													end;
												end;
											end;
											resetloop(POr);
											if (POCompCost!=blankval and POCompCost != INr.LastPurchPrice2) then begin
												RecordCopy(OldINr,INr);
												INr.LastPurchPrice2 = POCompCost;
												queued.UpdIN(OldINr,INr);
												slipcont = slipcont + 1;
												if(slipcont>1)then begin
													millisleep(100);
													slipcont = 0;
												end;
											end;
											if (POCompCost==blankval and POIDCost!=blankval and POIDCost!=INr.LastPurchPrice2 and POIDDate>PUTransDate and POIDDate>IHr.TransDate) then begin
												RecordCopy(OldINr,INr);
												INr.LastPurchPrice2 = POIDCost;
												queued.UpdIN(OldINr,INr);
												slipcont = slipcont + 1;
												if(slipcont>1)then begin
													millisleep(100);
													slipcont = 0;
												end;
											end;
											resetloop(POr);
											if (POCompCost==blankval and POIDCost==blankval) then begin
												if (PUTransDate < IHr.TransDate and left(PUr.VECode,3)!="FOB") then begin
													if (IHr.TotCostPriceCurncy/IHr.Qty!=INr.LastPurchPrice2) then begin
														RecordCopy(OldINr,INr);
														INr.LastPurchPrice2 = IHr.TotCostPriceCurncy/IHr.Qty;
														queued.UpdIN(OldINr,INr);
														slipcont = slipcont + 1;
														if(slipcont>1)then begin
															millisleep(100);
															slipcont = 0;
														end;
													end;
												end else begin
													if (CostInCurrency!=INr.LastPurchPrice2) then begin
														RecordCopy(OldINr,INr);
														INr.LastPurchPrice2 = CostInCurrency;
														queued.UpdIN(OldINr,INr);
														slipcont = slipcont + 1;
														if(slipcont>1)then begin
															millisleep(100);
															slipcont = 0;
														end;
													end;
												end;
											end;
										end;
									end;
								end;
							end;
						end;
						resetcompany(mainComp);
					end;
				end;
			end;
		end;
	end;
	logtext(0,"WebQueuedUpdCostPrFromIDGroup2 FINISH");
return;
end;










global webpublic updating procedure WebFindErrorCostPrFromIDGroup()  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:50 23.06.2020
begin
	integer MainCompany, i, lNr;
	string 255 CCitemcode, Origitemcode, upd, noUpdIHf;
	val cpriceazn, cpricecb, IHcostpricecur, IHtotcostprice, cpriceaznSumQty;
	record ConsItemVc CIr;
	record ItemHistVc IHr;
	boolean TrHs,testf,updf,updTRf,updDocf,transSearchf;
	record CompaniesBlock CBb;
	row CompaniesBlock Comprw;
	record INVc INr;
	record PUVc PUr;
	row PUVc PUrw;
	record IVVc IVr, fifocurIVr;
	row IVVc IVrw;
	record StockMovVc SMr;
	row StockMovVc SMrw;
	record SHVc SHr;
	row SHVc SHrw;
	record SDVc SDr;
	row SDVc SDrw;
	record RetVc Retr;
	row RetVc Retrw;
	record RetPUVc RetPUr;
	row RetPUVc RetPUrw;
	record TRVc TRr, OldTRr;
	row TRVc TRrw;
	record RLinkVc RLr;
	record ORVc ORr;
	row ORvc ORrw;
	record LocationVc Lcr;
  record SMVc gSMr;
	
	BlockLoad(CBb);
	MainCompany = 18;
	setcompany(MainCompany,false);
	
	CCitemcode = UpperCase(WebGetArg("itemcode"));
  cpriceazn = StringToVal(WebGetArg("cpriceazn"),M4Val);
  cpricecb = StringToVal(WebGetArg("cpricecb"),M4Val);
	noUpdIHf = WebGetArg("noupdf");
	upd = WebGetArg("updf");
	if (upd=="true") then begin
		updf = true;
	end else begin
		updf = false;
	end;

	if (nonblank(CCitemcode) and nonblank(cpriceazn) and nonblank(cpricecb)) then begin
		CIr.Code = CCitemcode;
		if (ReadFirstMain(CIr,1,true)) then begin
			Origitemcode = CIr.LocCode;
			IHr.ArtCode = CCitemcode;
			IHr.TransDate = StringToDate("01/01/2020");
			TrHs = true;
			weboutstring("________________________ID Group Company________________________");
			weboutstring("<BR>");
			while (LoopKey("ArtCode",IHr,2,TrHs)) begin
				testf = true;
				IHcostpricecur = blankval;
				cpriceaznSumQty = blankval;
				IHtotcostprice = blankval;
				IHcostpricecur = IHr.TotCostPriceCurncy / AbsoluteVal(IHr.Qty);
				IHtotcostprice = IHr.TotCostPrice / AbsoluteVal(IHr.Qty);
				if (IHr.ArtCode!=CCitemcode) then begin TrHs = false; testf = false; end;
				if (IHr.TransDate<StringToDate("01/01/2020")) then begin TrHs = false; testf = false; end;
				if (cpricecb > IHcostpricecur and 0.05 < cpricecb - IHcostpricecur) then begin testf = false; end;
				if (cpricecb < IHcostpricecur and 0.05 < IHcostpricecur - cpricecb) then begin testf = false; end;
				if (IHtotcostprice>0 and cpriceazn >= IHtotcostprice and cpriceazn / IHtotcostprice < 1.01) then begin testf = false; end;
				if (IHtotcostprice>0 and cpriceazn <= IHtotcostprice and IHtotcostprice / cpriceazn < 1.01) then begin testf = false; end;
				if (IHtotcostprice<0 and cpriceazn >= IHtotcostprice and -cpriceazn / IHtotcostprice < 1.01) then begin testf = false; end;
				if (IHtotcostprice<0 and cpriceazn <= IHtotcostprice and IHtotcostprice / -cpriceazn < 1.01) then begin testf = false; end;
				if (SetInSet(IHr.SerNr,noUpdIHf)) then begin testf = false; end;
				if (testf) then begin
					if (!updf) then begin
						weboutstring("Item hist. No.: " & IHr.SerNr & " Document: " & IHr.FileName & " Doc. SerNr: " & IHr.TransNr & " CostPrice: " & IHtotcostprice);
						weboutstring("<BR>");
					end else begin
						updDocf = false;
						updTRf = false;
						transSearchf = false;
						cpriceaznSumQty = cpriceazn * AbsoluteVal(IHr.Qty);
						switch(IHr.FileName)begin
							case "PUVc":
								PUr.SerNr = IHr.TransNr;
								if (readfirstmain(PUr,1,true)) then begin
									matrowget(PUr,IHr.Row,PUrw);
									PUrw.CostPrice = cpriceazn;
									PUrw.Sum = cpriceaznSumQty;
									matrowput(PUr,IHr.Row,PUrw);
									PUVc_PasteCostPrice(PUr,IHr.Row);
									matrowget(PUr,IHr.Row,PUrw);
									matrowput(PUr,IHr.Row,PUrw);
									OldTRr.Number = PUr.SerNr;
									OldTRr.IntYc = PUYc;
									if (ReadFirstMain(OldTRr,2,true)) then begin 
										DeleteTransaction(OldTRr.Number,OldTRr.IntYc);
										recordstore(PUr,true);
										if (nonblank(PUrw.Location)) then begin
											Lcr.Code = PUrw.Location;
										end else begin
											Lcr.Code = PUr.Location;
										end;
										if (ReadFirstMain(Lcr,1,true)) then begin
											if(MakeTransFromPU(TRr,PUr,Lcr,true)==0)then begin
												SaveTrans(TRr);
												AddTTrans_PUVc(TRr,PUr);
												updDocf = true;
											end else begin
												weboutstring("MakeTransFromPU ERROR " & MakeTransFromPU(TRr,PUr,Lcr,true));
												weboutstring("<BR>");
											end;
										end;
									end else begin
										recordstore(PUr,true);
										if (nonblank(PUrw.Location)) then begin
											Lcr.Code = PUrw.Location;
										end else begin
											Lcr.Code = PUr.Location;
										end;
										if (ReadFirstMain(Lcr,1,true)) then begin
											if(MakeTransFromPU(TRr,PUr,Lcr,true)==0)then begin
												SaveTrans(TRr);
												AddTTrans_PUVc(TRr,PUr);
												updDocf = true;
											end else begin
												weboutstring("MakeTransFromPU ERROR " & MakeTransFromPU(TRr,PUr,Lcr,true));
												weboutstring("<BR>");
											end;
										end;
									end;
								end;
							case "RetPUVc":
								RetPUr.SerNr = IHr.TransNr;
								if (readfirstmain(RetPUr,1,true)) then begin
									matrowget(RetPUr,IHr.Row,RetPUrw);
									RetPUrw.PUCostPrice = cpriceazn;
									RetPUrw.FIFO = cpriceazn;
									RetPUrw.FIFORowVal = cpriceaznSumQty;
									matrowput(RetPUr,IHr.Row,RetPUrw);
									RetPUSumUp(RetPUr);
									TRr.Number = RetPUr.SerNr;
									TRr.IntYc = RetPUYc;
									if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
								end;
							case "SHVc":
								SHr.SerNr = IHr.TransNr;
								if(readfirstmain(SHr,1,true))then begin
									matrowget(SHr,IHr.Row,SHrw);
									SHrw.BBCostPrice = cpriceazn;
									SHrw.FIFO = cpriceazn;
									SHrw.FIFORowVal = cpriceaznSumQty;
									matrowput(SHr,IHr.Row,SHrw);
									lNr = 1;
									if (ReadRecordLink(SHr,lNr,ORr,RLr)) then begin
										for (i=0;i<matrowcnt(ORr);i=i+1) begin
											matrowget (ORr,i,ORrw);
											if (ORrw.ArtCode==CCitemcode and ORrw.Quant==AbsoluteVal(IHr.Qty)) then begin
												ORrw.Price = cpriceazn;
												ORrw.Sum = cpriceaznSumQty;
												matrowput(ORr,i,ORrw);
												ORDchsum(ORr,i);
												matrowget(ORr,i,ORrw); 
												ORSumup(ORr);
												matrowput(ORr,i,ORrw); 
											end;
										end;	
										recordstore(ORr,true);
									end;
									TRr.Number = SHr.SerNr;
									TRr.IntYc = SHYc;
									if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
								end;
							case "SDVc":
								SDr.SerNr = IHr.TransNr;
								if(readfirstmain(SDr,1,true))then begin
									matrowget(SDr,IHr.Row,SDrw);
									SDrw.FIFO = cpriceazn;
									SDrw.FIFORowVal = cpriceaznSumQty;
									matrowput(SDr,IHr.Row,SDrw);
									TRr.Number = SDr.SerNr;
									TRr.IntYc = SDYc;
									if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
								end;
							case "RetVc":
								Retr.SerNr = IHr.TransNr;
								if(readfirstmain(Retr,1,true))then begin
									matrowget(Retr,IHr.Row,Retrw);
									Retrw.UPrice = cpriceazn;
									Retrw.CostPrice = cpriceazn;
									Retrw.BBCostPrice = cpriceazn;
									matrowput(Retr,IHr.Row,Retrw);
									TRr.Number = Retr.SerNr;
									TRr.IntYc = RetYc;
									if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
								end;
							case "IVVc":
								IVr.SerNr = IHr.TransNr;
								if(readfirstmain(IVr,1,true))then begin
									matrowget(IVr,IHr.Row,IVrw);
									IVrw.BasePrice = cpriceazn;
									IVrw.FIFO = cpriceazn;
									IVrw.FIFORowVal = cpriceaznSumQty;
									matrowput(IVr,IHr.Row,IVrw);
									TRr.Number = IVr.SerNr;
									TRr.IntYc = IVYc;
									if (ReadFirstMain(TRr,2,true)) then begin 
										RecordCopy(OldTRr,TRr);
										for (i=0;i<matrowcnt(TRr);i=i+1) begin
											matrowget(TRr,i,TRrw);
											if (TRrw.DebVal!=blankval and ((TRrw.DebVal-IHr.TotCostPrice<0.05 and TRrw.DebVal>=IHr.TotCostPrice) or 
																										(IHr.TotCostPrice-TRrw.DebVal<0.05 and TRrw.DebVal<=IHr.TotCostPrice))) then begin
												matrowget(TRr,i,TRrw);
												TRrw.DebVal = cpriceaznSumQty;
												matrowput(TRr,i,TRrw);
												// TRVc_PasteDebVal(TRr,i);
												matrowget(TRr,i,TRrw);
												matrowput(TRr,i,TRrw);
											end;
											matrowget(TRr,i,TRrw);
											if (TRrw.CredVal!=blankval and ((TRrw.CredVal-IHr.TotCostPrice<0.05 and TRrw.CredVal>=IHr.TotCostPrice) or 
																										(IHr.TotCostPrice-TRrw.CredVal<0.05 and TRrw.CredVal<=IHr.TotCostPrice))) then begin
												matrowget(TRr,i,TRrw);
												TRrw.CredVal = cpriceaznSumQty;
												matrowput(TRr,i,TRrw);
												// TRVc_PasteCredVal(TRr,i);
												matrowget(TRr,i,TRrw);
												matrowput(TRr,i,TRrw);
											end;
											matrowget(TRr,i,TRrw);
											if (TRrw.Curncy=="AZN" and TRrw.CurDebVal!=blankval and ((TRrw.CurDebVal-IHr.TotCostPrice<0.05 and TRrw.CurDebVal>=IHr.TotCostPrice) or 
																																								(IHr.TotCostPrice-TRrw.CurDebVal<0.05 and TRrw.CurDebVal<=IHr.TotCostPrice))) then begin
												matrowget(TRr,i,TRrw);
												TRrw.CurDebVal = cpriceaznSumQty;
												matrowput(TRr,i,TRrw);
												// TRVc_PasteCurDebVal(TRr,i);
												matrowget(TRr,i,TRrw);
												matrowput(TRr,i,TRrw);
											end;
											matrowget(TRr,i,TRrw);
											if (TRrw.Curncy=="AZN" and TRrw.CurCredVal!=blankval and ((TRrw.CurCredVal-IHr.TotCostPrice<0.05 and TRrw.CurCredVal>=IHr.TotCostPrice) or 
																																									(IHr.TotCostPrice-TRrw.CurCredVal<0.05 and TRrw.CurCredVal<=IHr.TotCostPrice))) then begin
												matrowget(TRr,i,TRrw);
												TRrw.CurCredVal = cpriceaznSumQty;
												matrowput(TRr,i,TRrw);
												// TRVc_PasteCurCredVal(TRr,i);
												matrowget(TRr,i,TRrw);
												matrowput(TRr,i,TRrw);
											end;
											matrowput(TRr,i,TRrw);
										end;
										if (RecordUpdate(OldTRr,TRr,true)==0) then begin
											updTRf = true;
										end;
									end;
									// OldTRr.Number = IVr.SerNr;
									// OldTRr.IntYc = IVYc;
									// if (ReadFirstMain(OldTRr,2,true)) then begin 
										// DeleteTransaction(OldTRr.Number,OldTRr.IntYc);
										// recordstore(IVr,true);
										// if(MakeTransFromIV(TRr,gSMr,IVr,true,false,fifocurIVr)==0)then begin
											// SaveTrans(TRr);
											// AddTTrans_IVVc(TRr,IVr);
											// updDocf = true;
										// end else begin
											// weboutstring("MakeTransFromIV ERROR " & MakeTransFromIV(TRr,gSMr,IVr,true,false,fifocurIVr));
											// weboutstring("<BR>");
										// end;
									// end else begin
										// recordstore(IVr,true);
										// if(MakeTransFromIV(TRr,gSMr,IVr,true,false,fifocurIVr)==0)then begin
											// SaveTrans(TRr);
											// AddTTrans_IVVc(TRr,IVr);
											// updDocf = true;
										// end else begin
											// weboutstring("MakeTransFromIV ERROR " & MakeTransFromIV(TRr,gSMr,IVr,true,false,fifocurIVr));
											// weboutstring("<BR>");
										// end;
									// end;
								end;
							case "StockMovVc":
								SMr.SerNr = IHr.TransNr;
								if(readfirstmain(SMr,1,true))then begin
									matrowget(SMr,IHr.Row,SMrw);
									SMrw.OldPrice = cpriceazn;
									SMrw.NewPrice = cpriceazn;
									SMrw.FIFORowVal = cpriceaznSumQty;
									matrowput(SMr,IHr.Row,SMrw);
									if (IHr.Qty<0) then begin
										TRr.Number = SMr.SerNr;
										TRr.IntYc = SentSTMovYc;
										if (ReadFirstMain(TRr,2,true)) then begin 
											transSearchf = true; 
										end else begin
											updTRf = true;
										end;
									end else begin
										TRr.Number = SMr.SerNr;
										TRr.IntYc = STMovYc;
										if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
									end;
								end;
							otherwise
								weboutstring("Other filename. FileName is " & IHr.FileName);
								weboutstring("<BR>");
						end;
						
						if (transSearchf) then begin
							RecordCopy(OldTRr,TRr);
							matrowget(TRr,IHr.Row * 2,TRrw);
								if (TRrw.DebVal!=blankval and TRrw.DebVal==IHr.TotCostPrice) then begin
									TRrw.DebVal = cpriceaznSumQty;
									matrowput(TRr,IHr.Row * 2,TRrw);
									TRVc_PasteDebVal(TRr,IHr.Row * 2);
									matrowget(TRr,IHr.Row * 2,TRrw);
								end;
								if (TRrw.CredVal!=blankval and TRrw.CredVal==IHr.TotCostPrice) then begin
									TRrw.CredVal = cpriceaznSumQty;
									matrowput(TRr,IHr.Row * 2,TRrw);
									TRVc_PasteCredVal(TRr,IHr.Row * 2);
									matrowget(TRr,IHr.Row * 2,TRrw);
								end;
								if (TRrw.Curncy=="AZN" and TRrw.CurDebVal!=blankval and TRrw.CurDebVal==IHr.TotCostPrice) then begin
									TRrw.CurDebVal = cpriceaznSumQty;
									matrowput(TRr,IHr.Row * 2,TRrw);
									TRVc_PasteCurDebVal(TRr,IHr.Row * 2);
									matrowget(TRr,IHr.Row * 2,TRrw);
								end;
								if (TRrw.Curncy=="AZN" and TRrw.CurCredVal!=blankval and TRrw.CurCredVal==IHr.TotCostPrice) then begin
									TRrw.CurCredVal = cpriceaznSumQty;
									matrowput(TRr,IHr.Row * 2,TRrw);
									TRVc_PasteCurCredVal(TRr,IHr.Row * 2);
									matrowget(TRr,IHr.Row * 2,TRrw);
								end;
							matrowput(TRr,IHr.Row * 2,TRrw);
							
							matrowget(TRr,IHr.Row * 2 + 1,TRrw);
								if (TRrw.DebVal!=blankval and TRrw.DebVal==IHr.TotCostPrice) then begin
									TRrw.DebVal = cpriceaznSumQty;
									matrowput(TRr,IHr.Row * 2 + 1,TRrw);
									TRVc_PasteDebVal(TRr,IHr.Row * 2 + 1);
									matrowget(TRr,IHr.Row * 2 + 1,TRrw);
								end;
								if (TRrw.CredVal!=blankval and TRrw.CredVal==IHr.TotCostPrice) then begin
									TRrw.CredVal = cpriceaznSumQty;
									matrowput(TRr,IHr.Row * 2 + 1,TRrw);
									TRVc_PasteCredVal(TRr,IHr.Row * 2 + 1);
									matrowget(TRr,IHr.Row * 2 + 1,TRrw);
								end;
								if (TRrw.Curncy=="AZN" and TRrw.CurDebVal!=blankval and TRrw.CurDebVal==IHr.TotCostPrice) then begin
									TRrw.CurDebVal = cpriceaznSumQty;
									matrowput(TRr,IHr.Row * 2 + 1,TRrw);
									TRVc_PasteCurDebVal(TRr,IHr.Row * 2 + 1);
									matrowget(TRr,IHr.Row * 2 + 1,TRrw);
								end;
								if (TRrw.Curncy=="AZN" and TRrw.CurCredVal!=blankval and TRrw.CurCredVal==IHr.TotCostPrice) then begin
									TRrw.CurCredVal = cpriceaznSumQty;
									matrowput(TRr,IHr.Row * 2 + 1,TRrw);
									TRVc_PasteCurCredVal(TRr,IHr.Row * 2 + 1);
									matrowget(TRr,IHr.Row * 2 + 1,TRrw);
								end;
							matrowput(TRr,IHr.Row * 2 + 1,TRrw);
							if (RecordUpdate(OldTRr,TRr,true)==0) then begin
								updTRf = true;
							end;
						end;
						
						
						if (updTRf) then begin
							switch(IHr.FileName)begin
								case "PUVc":
										recordstore(PUr,true);
										updDocf = true;
								case "SHVc":
										recordstore(SHr,true);
										updDocf = true;
								case "SDVc":
										recordstore(SDr,true);
										updDocf = true;
								case "RetVc":
										recordstore(Retr,true);
										updDocf = true;
								case "IVVc":
										recordstore(IVr,true);
										updDocf = true;
								case "StockMovVc":
										recordstore(SMr,true);
										updDocf = true;
								case "RetPUVc":
										recordstore(RetPUr,true);
										updDocf = true;
								otherwise
									weboutstring("Other filename. FileName is " & IHr.FileName);
									weboutstring("<BR>");
							end;
						end;
						
						if (updDocf) then begin
							IHr.TotCostPrice = cpriceaznSumQty;
							IHr.WATotCostPerLoc = cpriceaznSumQty;
							IHr.WATotCost = cpriceaznSumQty;
							IHr.CPTotCost = cpriceaznSumQty;
							IHr.RemCostPrice = AbsoluteVal(IHr.RemQty) * cpriceazn;
							recordstore(IHr,true);
						end;
					end;
				end;
			end;
			Resetloop(IHr);
			
			for (i=0;i<matrowcnt(CBb);i=i+1) begin
				matrowget(CBb,i,Comprw);
				if(Comprw.ActiveStatus==0 and i+1!=18 and i+1!=29 and i+1!=31 and i+1!=32 and i+1!=33) then begin
					SetCompany(i+1,false);
					INr.Code = Origitemcode;
					if (ReadFirstMain(INr,1,true)) then begin
						if (INr.BPIBrand==CIr.BrandCode) then begin
							IHr.ArtCode = Origitemcode;
							IHr.TransDate = StringToDate("01/01/2020");
							TrHs = true;
							weboutstring("________________________" & Comprw.CompName & " Company________________________");
							weboutstring("<BR>");
							while (LoopKey("ArtCode",IHr,2,TrHs)) begin
								testf = true;
								IHcostpricecur = blankval;
								IHtotcostprice = blankval;
								IHcostpricecur = IHr.TotCostPriceCurncy / AbsoluteVal(IHr.Qty);
								IHtotcostprice = IHr.TotCostPrice / AbsoluteVal(IHr.Qty);
								if (IHr.ArtCode!=Origitemcode) then begin TrHs = false; testf = false; end;
								if (IHr.TransDate<StringToDate("01/01/2020")) then begin TrHs = false; testf = false; end;
								if (cpricecb > IHcostpricecur and 0.05 < cpricecb - IHcostpricecur) then begin testf = false; end;
								if (cpricecb < IHcostpricecur and 0.05 < IHcostpricecur - cpricecb) then begin testf = false; end;
								if (IHtotcostprice>0 and cpriceazn >= IHtotcostprice and cpriceazn / IHtotcostprice < 1.01) then begin testf = false; end;
								if (IHtotcostprice>0 and cpriceazn <= IHtotcostprice and IHtotcostprice / cpriceazn < 1.01) then begin testf = false; end;
								if (IHtotcostprice<0 and cpriceazn >= IHtotcostprice and -cpriceazn / IHtotcostprice < 1.01) then begin testf = false; end;
								if (IHtotcostprice<0 and cpriceazn <= IHtotcostprice and IHtotcostprice / -cpriceazn < 1.01) then begin testf = false; end;
								if (SetInSet(IHr.SerNr,noUpdIHf)) then begin testf = false; end;
								if (testf) then begin
									if (!updf) then begin
										weboutstring("Item hist. No.: " & IHr.SerNr & " Document: " & IHr.FileName & " Doc. SerNr: " & IHr.TransNr & " CostPrice: " & IHtotcostprice);
										weboutstring("<BR>");
									end else begin
										updDocf = false;
										updTRf = false;
										transSearchf = false;
										cpriceaznSumQty = cpriceazn * AbsoluteVal(IHr.Qty);
										switch(IHr.FileName)begin
											case "PUVc":
												PUr.SerNr = IHr.TransNr;
												if (readfirstmain(PUr,1,true)) then begin
													matrowget(PUr,IHr.Row,PUrw);
													PUrw.CostPrice = cpriceazn;
													PUrw.Sum = cpriceaznSumQty;
													matrowput(PUr,IHr.Row,PUrw);
													PUVc_PasteCostPrice(PUr,IHr.Row);
													matrowget(PUr,IHr.Row,PUrw);
													matrowput(PUr,IHr.Row,PUrw);
													OldTRr.Number = PUr.SerNr;
													OldTRr.IntYc = PUYc;
													if (ReadFirstMain(OldTRr,2,true)) then begin 
														DeleteTransaction(OldTRr.Number,OldTRr.IntYc);
														recordstore(PUr,true);
														if (nonblank(PUrw.Location)) then begin
															Lcr.Code = PUrw.Location;
														end else begin
															Lcr.Code = PUr.Location;
														end;
														if (ReadFirstMain(Lcr,1,true)) then begin
															if(MakeTransFromPU(TRr,PUr,Lcr,true)==0)then begin
																SaveTrans(TRr);
																AddTTrans_PUVc(TRr,PUr);
																updDocf = true;
															end else begin
																weboutstring("MakeTransFromPU ERROR " & MakeTransFromPU(TRr,PUr,Lcr,true));
																weboutstring("<BR>");
															end;
														end;
													end else begin
														recordstore(PUr,true);
														if (nonblank(PUrw.Location)) then begin
															Lcr.Code = PUrw.Location;
														end else begin
															Lcr.Code = PUr.Location;
														end;
														if (ReadFirstMain(Lcr,1,true)) then begin
															if(MakeTransFromPU(TRr,PUr,Lcr,true)==0)then begin
																SaveTrans(TRr);
																AddTTrans_PUVc(TRr,PUr);
																updDocf = true;
															end else begin
																weboutstring("MakeTransFromPU ERROR " & MakeTransFromPU(TRr,PUr,Lcr,true));
																weboutstring("<BR>");
															end;
														end;
													end;
												end;
											case "RetPUVc":
												RetPUr.SerNr = IHr.TransNr;
												if (readfirstmain(RetPUr,1,true)) then begin
													matrowget(RetPUr,IHr.Row,RetPUrw);
													RetPUrw.PUCostPrice = cpriceazn;
													RetPUrw.FIFO = cpriceazn;
													RetPUrw.FIFORowVal = cpriceaznSumQty;
													matrowput(RetPUr,IHr.Row,RetPUrw);
													RetPUSumUp(RetPUr);
													TRr.Number = RetPUr.SerNr;
													TRr.IntYc = RetPUYc;
													if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
												end;
											case "SHVc":
												SHr.SerNr = IHr.TransNr;
												if(readfirstmain(SHr,1,true))then begin
													matrowget(SHr,IHr.Row,SHrw);
													SHrw.BBCostPrice = cpriceazn;
													SHrw.FIFO = cpriceazn;
													SHrw.FIFORowVal = cpriceaznSumQty;
													matrowput(SHr,IHr.Row,SHrw);
													TRr.Number = SHr.SerNr;
													TRr.IntYc = SHYc;
													if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
												end;
											case "SDVc":
												SDr.SerNr = IHr.TransNr;
												if(readfirstmain(SDr,1,true))then begin
													matrowget(SDr,IHr.Row,SDrw);
													SDrw.FIFO = cpriceazn;
													SDrw.FIFORowVal = cpriceaznSumQty;
													matrowput(SDr,IHr.Row,SDrw);
													TRr.Number = SDr.SerNr;
													TRr.IntYc = SDYc;
													if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
												end;
											case "RetVc":
												Retr.SerNr = IHr.TransNr;
												if(readfirstmain(Retr,1,true))then begin
													matrowget(Retr,IHr.Row,Retrw);
													Retrw.UPrice = cpriceazn;
													Retrw.CostPrice = cpriceazn;
													Retrw.BBCostPrice = cpriceazn;
													matrowput(Retr,IHr.Row,Retrw);
													TRr.Number = Retr.SerNr;
													TRr.IntYc = RetYc;
													if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
												end;
											case "IVVc":
												IVr.SerNr = IHr.TransNr;
												if(readfirstmain(IVr,1,true))then begin
													matrowget(IVr,IHr.Row,IVrw);
													IVrw.BasePrice = cpriceazn;
													IVrw.FIFO = cpriceazn;
													IVrw.FIFORowVal = cpriceaznSumQty;
													matrowput(IVr,IHr.Row,IVrw);
													TRr.Number = IVr.SerNr;
													TRr.IntYc = IVYc;
													if (ReadFirstMain(TRr,2,true)) then begin 
														RecordCopy(OldTRr,TRr);
														for (i=0;i<matrowcnt(TRr);i=i+1) begin
															matrowget(TRr,i,TRrw);
															if (TRrw.DebVal!=blankval and ((TRrw.DebVal-IHr.TotCostPrice<0.05 and TRrw.DebVal>=IHr.TotCostPrice) or 
																														(IHr.TotCostPrice-TRrw.DebVal<0.05 and TRrw.DebVal<=IHr.TotCostPrice))) then begin
																matrowget(TRr,i,TRrw);
																TRrw.DebVal = cpriceaznSumQty;
																matrowput(TRr,i,TRrw);
																// TRVc_PasteDebVal(TRr,i);
																matrowget(TRr,i,TRrw);
																matrowput(TRr,i,TRrw);
															end;
															matrowget(TRr,i,TRrw);
															if (TRrw.CredVal!=blankval and ((TRrw.CredVal-IHr.TotCostPrice<0.05 and TRrw.CredVal>=IHr.TotCostPrice) or 
																														(IHr.TotCostPrice-TRrw.CredVal<0.05 and TRrw.CredVal<=IHr.TotCostPrice))) then begin
																matrowget(TRr,i,TRrw);
																TRrw.CredVal = cpriceaznSumQty;
																matrowput(TRr,i,TRrw);
																// TRVc_PasteCredVal(TRr,i);
																matrowget(TRr,i,TRrw);
																matrowput(TRr,i,TRrw);
															end;
															matrowget(TRr,i,TRrw);
															if (TRrw.Curncy=="AZN" and TRrw.CurDebVal!=blankval and ((TRrw.CurDebVal-IHr.TotCostPrice<0.05 and TRrw.CurDebVal>=IHr.TotCostPrice) or 
																																												(IHr.TotCostPrice-TRrw.CurDebVal<0.05 and TRrw.CurDebVal<=IHr.TotCostPrice))) then begin
																matrowget(TRr,i,TRrw);
																TRrw.CurDebVal = cpriceaznSumQty;
																matrowput(TRr,i,TRrw);
																// TRVc_PasteCurDebVal(TRr,i);
																matrowget(TRr,i,TRrw);
																matrowput(TRr,i,TRrw);
															end;
															matrowget(TRr,i,TRrw);
															if (TRrw.Curncy=="AZN" and TRrw.CurCredVal!=blankval and ((TRrw.CurCredVal-IHr.TotCostPrice<0.05 and TRrw.CurCredVal>=IHr.TotCostPrice) or 
																																													(IHr.TotCostPrice-TRrw.CurCredVal<0.05 and TRrw.CurCredVal<=IHr.TotCostPrice))) then begin
																matrowget(TRr,i,TRrw);
																TRrw.CurCredVal = cpriceaznSumQty;
																matrowput(TRr,i,TRrw);
																// TRVc_PasteCurCredVal(TRr,i);
																matrowget(TRr,i,TRrw);
																matrowput(TRr,i,TRrw);
															end;
															matrowput(TRr,i,TRrw);
														end;
														if (RecordUpdate(OldTRr,TRr,true)==0) then begin
															updTRf = true;
														end;
													end;
													// OldTRr.Number = IVr.SerNr;
													// OldTRr.IntYc = IVYc;
													// if (ReadFirstMain(OldTRr,2,true)) then begin 
														// DeleteTransaction(OldTRr.Number,OldTRr.IntYc);
														// recordstore(IVr,true);
														// if(MakeTransFromIV(TRr,gSMr,IVr,true,false,fifocurIVr)==0)then begin
															// SaveTrans(TRr);
															// AddTTrans_IVVc(TRr,IVr);
															// updDocf = true;
														// end else begin
															// weboutstring("MakeTransFromIV ERROR " & MakeTransFromIV(TRr,gSMr,IVr,true,false,fifocurIVr));
															// weboutstring("<BR>");
														// end;
													// end else begin
														// recordstore(IVr,true);
														// if(MakeTransFromIV(TRr,gSMr,IVr,true,false,fifocurIVr)==0)then begin
															// SaveTrans(TRr);
															// AddTTrans_IVVc(TRr,IVr);
															// updDocf = true;
														// end else begin
															// weboutstring("MakeTransFromIV ERROR " & MakeTransFromIV(TRr,gSMr,IVr,true,false,fifocurIVr));
															// weboutstring("<BR>");
														// end;
													// end;
												end;
											case "StockMovVc":
												SMr.SerNr = IHr.TransNr;
												if(readfirstmain(SMr,1,true))then begin
													matrowget(SMr,IHr.Row,SMrw);
													SMrw.OldPrice = cpriceazn;
													SMrw.NewPrice = cpriceazn;
													SMrw.FIFORowVal = cpriceaznSumQty;
													matrowput(SMr,IHr.Row,SMrw);
													if (IHr.Qty<0) then begin
														TRr.Number = SMr.SerNr;
														TRr.IntYc = SentSTMovYc;
														if (ReadFirstMain(TRr,2,true)) then begin 
															transSearchf = true; 
														end else begin
															updTRf = true;
														end;
													end else begin
														TRr.Number = SMr.SerNr;
														TRr.IntYc = STMovYc;
														if (ReadFirstMain(TRr,2,true)) then begin transSearchf = true; end;
													end;
												end;
											otherwise
												weboutstring("Other filename. FileName is " & IHr.FileName);
												weboutstring("<BR>");
										end;
										
										if (transSearchf) then begin
											RecordCopy(OldTRr,TRr);
											matrowget(TRr,IHr.Row * 2,TRrw);
												if (TRrw.DebVal!=blankval and TRrw.DebVal==IHr.TotCostPrice) then begin
													TRrw.DebVal = cpriceaznSumQty;
													matrowput(TRr,IHr.Row * 2,TRrw);
													TRVc_PasteDebVal(TRr,IHr.Row * 2);
													matrowget(TRr,IHr.Row * 2,TRrw);
												end;
												if (TRrw.CredVal!=blankval and TRrw.CredVal==IHr.TotCostPrice) then begin
													TRrw.CredVal = cpriceaznSumQty;
													matrowput(TRr,IHr.Row * 2,TRrw);
													TRVc_PasteCredVal(TRr,IHr.Row * 2);
													matrowget(TRr,IHr.Row * 2,TRrw);
												end;
												if (TRrw.Curncy=="AZN" and TRrw.CurDebVal!=blankval and TRrw.CurDebVal==IHr.TotCostPrice) then begin
													TRrw.CurDebVal = cpriceaznSumQty;
													matrowput(TRr,IHr.Row * 2,TRrw);
													TRVc_PasteCurDebVal(TRr,IHr.Row * 2);
													matrowget(TRr,IHr.Row * 2,TRrw);
												end;
												if (TRrw.Curncy=="AZN" and TRrw.CurCredVal!=blankval and TRrw.CurCredVal==IHr.TotCostPrice) then begin
													TRrw.CurCredVal = cpriceaznSumQty;
													matrowput(TRr,IHr.Row * 2,TRrw);
													TRVc_PasteCurCredVal(TRr,IHr.Row * 2);
													matrowget(TRr,IHr.Row * 2,TRrw);
												end;
											matrowput(TRr,IHr.Row * 2,TRrw);
											
											matrowget(TRr,IHr.Row * 2 + 1,TRrw);
												if (TRrw.DebVal!=blankval and TRrw.DebVal==IHr.TotCostPrice) then begin
													TRrw.DebVal = cpriceaznSumQty;
													matrowput(TRr,IHr.Row * 2 + 1,TRrw);
													TRVc_PasteDebVal(TRr,IHr.Row * 2 + 1);
													matrowget(TRr,IHr.Row * 2 + 1,TRrw);
												end;
												if (TRrw.CredVal!=blankval and TRrw.CredVal==IHr.TotCostPrice) then begin
													TRrw.CredVal = cpriceaznSumQty;
													matrowput(TRr,IHr.Row * 2 + 1,TRrw);
													TRVc_PasteCredVal(TRr,IHr.Row * 2 + 1);
													matrowget(TRr,IHr.Row * 2 + 1,TRrw);
												end;
												if (TRrw.Curncy=="AZN" and TRrw.CurDebVal!=blankval and TRrw.CurDebVal==IHr.TotCostPrice) then begin
													TRrw.CurDebVal = cpriceaznSumQty;
													matrowput(TRr,IHr.Row * 2 + 1,TRrw);
													TRVc_PasteCurDebVal(TRr,IHr.Row * 2 + 1);
													matrowget(TRr,IHr.Row * 2 + 1,TRrw);
												end;
												if (TRrw.Curncy=="AZN" and TRrw.CurCredVal!=blankval and TRrw.CurCredVal==IHr.TotCostPrice) then begin
													TRrw.CurCredVal = cpriceaznSumQty;
													matrowput(TRr,IHr.Row * 2 + 1,TRrw);
													TRVc_PasteCurCredVal(TRr,IHr.Row * 2 + 1);
													matrowget(TRr,IHr.Row * 2 + 1,TRrw);
												end;
											matrowput(TRr,IHr.Row * 2 + 1,TRrw);
											if (RecordUpdate(OldTRr,TRr,true)==0) then begin
												updTRf = true;
											end;
										end;
										
										if (updTRf) then begin
											switch(IHr.FileName)begin
												case "PUVc":
														recordstore(PUr,true);
														updDocf = true;
												case "SHVc":
														recordstore(SHr,true);
														updDocf = true;
												case "SDVc":
														recordstore(SDr,true);
														updDocf = true;
												case "RetVc":
														recordstore(Retr,true);
														updDocf = true;
												case "IVVc":
														recordstore(IVr,true);
														updDocf = true;
												case "StockMovVc":
														recordstore(SMr,true);
														updDocf = true;
												case "RetPUVc":
														recordstore(RetPUr,true);
														updDocf = true;
												otherwise
													weboutstring("Other filename. FileName is " & IHr.FileName);
													weboutstring("<BR>");
											end;
										end;
										
										if (updDocf) then begin
											IHr.TotCostPrice = cpriceaznSumQty;
											IHr.WATotCostPerLoc = cpriceaznSumQty;
											IHr.WATotCost = cpriceaznSumQty;
											IHr.CPTotCost = cpriceaznSumQty;
											IHr.RemCostPrice = AbsoluteVal(IHr.RemQty) * cpriceazn;
											recordstore(IHr,true);
										end;
									end;
								end;
							end;
							Resetloop(IHr);		
						end;
					end;
				end;
			end;
			
			
		end else begin
			weboutstring("Incorrect itemcode ``" & CCitemcode & "``");
			weboutstring("<BR>");
		end;
	end else begin
		if (blank(CCitemcode)) then begin
			weboutstring("Blank parameter `` itemcode ``");
			weboutstring("<BR>");
		end;
		if (blank(cpriceazn)) then begin
			weboutstring("Blank parameter `` cpriceazn ``");
			weboutstring("<BR>");
		end;
		if (blank(cpricecb)) then begin
			weboutstring("Blank parameter `` cpricecb ``");
			weboutstring("<BR>");
		end;
	end;
	
	
	
	
return;
end;
 // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:50 23.06.2020













global updating procedure CorrectErrorsSHFromIDGroupComp()
begin
	record SHVc SHr;
	row SHVc SHrw;
	record POVc POr;
	record PUVc PUr;
	row PUVc PUrw;
	boolean TrHs, testf, remf, updf;
	integer MainCompany, i, j, LCNt, trdouble;
	record ECVendFobSetBlaock CObjr;
	row ECVendFobSetBlaock CObjrw;
	vector integer vObjComp;
	vector val vItemFRV;
	record RLinkVc RLr;
	LongInt PUrSerNr, cnt1, cnt2, shcnt, trmtrw;
	record ItemHistVc IHr, oldIHr;
	record TRVc TRr, oldTRr;
	row TRVc TRrw;
	vector string 255 vPosItems;
	record ConsItemVc CIr;
	record LocationVc LCr;
	
	MainCompany = 18;
	
	SetCompany(MainCompany,false);
	BlockLoad(CObjr);
	for (i=0;i<matrowcnt(CObjr);i=i+1) begin
		matrowget(CObjr,i,CObjrw);
		vObjComp[CObjrw.VendName] = CObjrw.CompanyNr;
	end;
	
	SHr.OKFlag = 1;
	TrHs = true;
	
	cnt1 = 0;
	cnt2 = 0;
	shcnt = 0;
	while (loopkey("OKFlag",SHr,1,TrHs)) begin
		updf = false;
		if (SHr.OKFlag != 1) then begin TrHs = false; end;
		if (TrHs) then begin
			j = 0;
			for (i=0;i<matrowcnt(SHr);i=i+1)begin
				matrowget(SHr,i,SHrw);
				if (SHrw.Ship>0) then begin
					vItemFRV[SHr.SerNr & "_" & i - j] = SHrw.FIFORowVal;
					CIr.Code = SHrw.ArtCode;
					if (ReadFirstMain(CIr,1,true)) then begin
						vPosItems[SHr.SerNr & "_" & i - j] = CIr.LocCode;
					end;
				end else begin
					j = j + 1;
				end;
			end;
			LCNt = 1;
			while (ReadRecordLink(SHr,LCNt,PUr,RLr)) begin
				PUrSerNr = PUr.SerNr;
				if(setcompany(vObjComp[SHr.CustCode],false))then begin
					PUr.SerNr = PUrSerNr;
					if (ReadFirstMain(PUr,1,true)) then begin
						if (PUr.OKFlag==1) then begin
							for (i=0;i<matrowcnt(PUr);i=i+1) begin
								matrowget(PUr,i,PUrw);
								if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and vItemFRV[SHr.SerNr & "_" & i]-AbsoluteVal(PUrw.Sum) > 1.01 and vPosItems[SHr.SerNr & "_" & i]==PUrw.ArtCode) then begin
									
									IHr.FileName = "PUVc";
									IHr.TransNr = PUr.SerNr;
									IHr.Row = i;
									remf = false;
									if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
										if (IHr.Qty == IHr.RemQty and vPosItems[SHr.SerNr & "_" & i]==PUrw.ArtCode) then begin
											weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum & " Remf: " & remf);
											weboutstring("<BR>");
											logtext (0,"SH SerNr: " & SHr.SerNr);
											RecordCopy(oldIHr,IHr);
											IHr.TotCostPrice = vItemFRV[SHr.SerNr & "_" & i];
											IHr.RemCostPrice = vItemFRV[SHr.SerNr & "_" & i];
											if (RecordUpdate(oldIHr,IHr,true)==0) then begin
												weboutstring("IH Updated");
												weboutstring("<BR>");
												logtext (0,"IH Updated");
												trdouble = 0;
												trmtrw = 0;
												// TRr.Number = PUr.SerNr;
												// TRr.IntYc = PUYc;
												// if (ReadFirstMain(TRr,2,true)) then begin
													// RecordCopy(oldTRr,TRr);
													// for (j=0;j<matrowcnt(TRr);j=j+1) begin
														// if (trmtrw == i)then begin
															// matrowget(TRr,j,TRrw);
															// if (TRrw.DebVal!=blankval) then begin
																// TRrw.DebVal = vItemFRV[SHr.SerNr & "_" & i];
															// end;
															// if (TRrw.CredVal!=blankval) then begin
																// TRrw.CredVal = vItemFRV[SHr.SerNr & "_" & i];
															// end;
															// matrowput(TRr,j,TRrw);
														// end;
														// if (trdouble==1)then begin
															// trdouble = 0;
															// trmtrw = trmtrw + 1;
														// end else begin
															// trdouble = 1;
														// end;
													// end;
													// logtext(0,TRr.Number);
													// if (RecordUpdate(oldTRr,TRr,true)==0) then begin
														// weboutstring("TR Updated");
														// weboutstring("<BR>");
														// logtext (0,"TR Updated");
														// PUrw.Sum = vItemFRV[SHr.SerNr & "_" & i];
														// PUrw.CostPrice = PUrw.Sum / PUrw.Quant;
														// matrowput(PUr,i,PUrw);
														// updf = true;
													// end;
												// end;
												
												
												OldTRr.Number = PUr.SerNr;
												OldTRr.IntYc = PUYc;
												if (ReadFirstMain(OldTRr,2,true)) then begin 
													DeleteTransaction(OldTRr.Number,OldTRr.IntYc);
													PUrw.Sum = vItemFRV[SHr.SerNr & "_" & i];
													PUrw.CostPrice = PUrw.Sum / PUrw.Quant;
													matrowput(PUr,i,PUrw);
													recordstore(PUr,true);
													if (nonblank(PUrw.Location)) then begin
														Lcr.Code = PUrw.Location;
													end else begin
														Lcr.Code = PUr.Location;
													end;
													if (ReadFirstMain(Lcr,1,true)) then begin
														if(MakeTransFromPU(TRr,PUr,Lcr,true)==0)then begin
															SaveTrans(TRr);
															AddTTrans_PUVc(TRr,PUr);
														end else begin
															weboutstring("MakeTransFromPU ERROR " & MakeTransFromPU(TRr,PUr,Lcr,true));
															weboutstring("<BR>");
														end;
													end;
												end else begin
													PUrw.Sum = vItemFRV[SHr.SerNr & "_" & i];
													PUrw.CostPrice = PUrw.Sum / PUrw.Quant;
													recordstore(PUr,true);
													if (nonblank(PUrw.Location)) then begin
														Lcr.Code = PUrw.Location;
													end else begin
														Lcr.Code = PUr.Location;
													end;
													if (ReadFirstMain(Lcr,1,true)) then begin
														if(MakeTransFromPU(TRr,PUr,Lcr,true)==0)then begin
															SaveTrans(TRr);
															AddTTrans_PUVc(TRr,PUr);
														end else begin
															weboutstring("MakeTransFromPU ERROR " & MakeTransFromPU(TRr,PUr,Lcr,true));
															weboutstring("<BR>");
														end;
													end;
												end;
											end;
										end;
									end;
									cnt1 = cnt1 + 1;
								end;
								if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and AbsoluteVal(PUrw.Sum)-vItemFRV[SHr.SerNr & "_" & i] > 1.01 and vPosItems[SHr.SerNr & "_" & i]==PUrw.ArtCode) then begin 
									
									IHr.FileName = "PUVc";
									IHr.TransNr = PUr.SerNr;
									IHr.Row = i;
									remf = false;
									if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
										if (IHr.Qty == IHr.RemQty and vPosItems[SHr.SerNr & "_" & i]==PUrw.ArtCode) then begin
											weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum & " Remf: " & remf);
											weboutstring("<BR>");

											RecordCopy(oldIHr,IHr);
											IHr.TotCostPrice = vItemFRV[SHr.SerNr & "_" & i];
											IHr.RemCostPrice = vItemFRV[SHr.SerNr & "_" & i];
											if (RecordUpdate(oldIHr,IHr,true)==0) then begin
												weboutstring("IH Updated");
												weboutstring("<BR>");
												logtext (0,"IH Updated");
												trdouble = 0;
												trmtrw = 0;
												// TRr.Number = PUr.SerNr;
												// TRr.IntYc = PUYc;
												// if (ReadFirstMain(TRr,2,true)) then begin
													// RecordCopy(oldTRr,TRr);
													// for (j=0;j<matrowcnt(TRr);j=j+1) begin
														// if (trmtrw == i)then begin
															// matrowget(TRr,j,TRrw);
															// if (TRrw.DebVal!=blankval) then begin
																// TRrw.DebVal = vItemFRV[SHr.SerNr & "_" & i];
															// end;
															// if (TRrw.CredVal!=blankval) then begin
																// TRrw.CredVal = vItemFRV[SHr.SerNr & "_" & i];
															// end;
															// matrowput(TRr,j,TRrw);
														// end;
														// if (trdouble==1)then begin
															// trdouble = 0;
															// trmtrw = trmtrw + 1;
														// end else begin
															// trdouble = 1;
														// end;
													// end;
													// if (RecordUpdate(oldTRr,TRr,true)==0) then begin
														// weboutstring("TR Updated");
														// weboutstring("<BR>");
														// logtext (0,"TR Updated");
														// PUrw.Sum = vItemFRV[SHr.SerNr & "_" & i];
														// PUrw.CostPrice = PUrw.Sum / PUrw.Quant;
														// matrowput(PUr,i,PUrw);
														// updf = true;
													// end;
												// end;
												
												OldTRr.Number = PUr.SerNr;
												OldTRr.IntYc = PUYc;
												if (ReadFirstMain(OldTRr,2,true)) then begin 
													DeleteTransaction(OldTRr.Number,OldTRr.IntYc);
													PUrw.Sum = vItemFRV[SHr.SerNr & "_" & i];
													PUrw.CostPrice = PUrw.Sum / PUrw.Quant;
													matrowput(PUr,i,PUrw);
													recordstore(PUr,true);
													if (nonblank(PUrw.Location)) then begin
														Lcr.Code = PUrw.Location;
													end else begin
														Lcr.Code = PUr.Location;
													end;
													if (ReadFirstMain(Lcr,1,true)) then begin
														if(MakeTransFromPU(TRr,PUr,Lcr,true)==0)then begin
															SaveTrans(TRr);
															AddTTrans_PUVc(TRr,PUr);
														end else begin
															weboutstring("MakeTransFromPU ERROR " & MakeTransFromPU(TRr,PUr,Lcr,true));
															weboutstring("<BR>");
														end;
													end;
												end else begin
													PUrw.Sum = vItemFRV[SHr.SerNr & "_" & i];
													PUrw.CostPrice = PUrw.Sum / PUrw.Quant;
													recordstore(PUr,true);
													if (nonblank(PUrw.Location)) then begin
														Lcr.Code = PUrw.Location;
													end else begin
														Lcr.Code = PUr.Location;
													end;
													if (ReadFirstMain(Lcr,1,true)) then begin
														if(MakeTransFromPU(TRr,PUr,Lcr,true)==0)then begin
															SaveTrans(TRr);
															AddTTrans_PUVc(TRr,PUr);
														end else begin
															weboutstring("MakeTransFromPU ERROR " & MakeTransFromPU(TRr,PUr,Lcr,true));
															weboutstring("<BR>");
														end;
													end;
												end;
											end;
										end;
									end;
									cnt1 = cnt1 + 1;
								end;
								// if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum < 1) then begin 
									// weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum);
									// weboutstring("<BR>");
									// cnt2 = cnt2 + 1;
								// end;
							end;
						end;
						if (updf) then begin
							RecordStore (PUr,true);
							logtext (0,"PU Updated");
						end;
					end;
				end;
				resetcompany(MainCompany);
				LCNt = LCNt + 1;
			end;
		end;
	end;
return;
end;



global webpublic updating procedure WebRestoreVendorCodeForIN()
begin
record ConsItemVc CIr;
record INVc INr,tmpINr;
LongInt rwcnt,oldcomp,i;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
boolean TrHs;
blockload(Compb);
setcompany(18,false);
oldcomp = 18;
CIr.Code = "";
while(LoopMain(CIr,1,true)) begin
	if(left(CIr.LocCode,3)=="IN_") then begin
		rwcnt = MatRowCnt(Compb);
		for (i = 0; i<rwcnt; i = i + 1) begin
			MatRowGet(Compb,i+1,Comprw);
			if(Comprw.ActiveStatus==0 and  i+1!=29 and i+1!=18  and i+1!=32 and i+1!=33)then begin
				setcompany(i+1,false);
				tmpINr.Code = CIr.Code;
				if(ReadFirstMain(tmpINr,1,true)) then begin
					Weboutstring(i+1 & " " & CIr.Code & " " & tmpINr.BPIBrand & " " & CIr.BrandCode & " " & tmpINr.AlternativeCode);
					Weboutstring("<BR>---------------------");
					if(tmpINr.BPIBrand==CIr.BrandCode and nonblank(tmpINr.AlternativeCode)) then begin
						logtext(0,tmpINr.AlternativeCode);
						logtext(0,i+1);
						Weboutstring(tmpINr.AlternativeCode & " " & tmpINr.Code & " " & i+1);
						Weboutstring("<BR>");
						setcompany(oldcomp,false);
						CIr.LocCode = tmpINr.AlternativeCode;
						RecordStore(CIr,true);
					end;
				end;
			end;
		end;
	end;
	ResetCompany(oldcomp);
end;
return;
end;







global webpublic updating procedure WebUnDontAllowOverreserving()
begin
	record ConsItemVc CIr;
	record INVc INr,tmpINr;
	LongInt rwcnt,oldcomp,i;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	boolean TrHs;
	record OrdSettBlock OSb;
	
	blockload(Compb);
	rwcnt = MatRowCnt(Compb);
	for (i = 0; i<rwcnt; i = i + 1) begin
		MatRowGet(Compb,i+1,Comprw);
		if(i+1!=29 and i+1!=18  and i+1!=32 and i+1!=33)then begin
			setcompany(i+1,false);
			blockload(OSb);
			OSb.dontAllowOverreserving = 0;
			BlockStore(OSb);
			blockload(OSb);
			logtext(0,OSb.dontAllowOverreserving & " dontAllowOverreserving");
		end;
	end;
return;
end;






global webpublic updating procedure WebGrtLocationsInAllComp()
begin
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	boolean TrHs, Orf;
	integer i, rwcnt, lcnt;
	record LocationVc Lcr, OrigLcr, OldLcr;
	record ECVendFobSetBlaock ECVFSb;
	row ECVendFobSetBlaock ECVFSrw;
	array string 255 aLoc;
	array integer aCompNr;
	
	
	SetCompany(1,false);
	blockload(ECVFSb);
	
	blockload(Compb);
	rwcnt = MatRowCnt(Compb);
	for (i = 0; i<rwcnt; i = i + 1) begin
		MatRowGet(Compb,i+1,Comprw);
		// if(Comprw.ActiveStatus==0) then begin
			setcompany(i+1,false);
			Lcr.Code = "";
			while (loopMain(Lcr,1,true)) begin
				Weboutstring(i+1 & "__" & Lcr.Code & "__" & Lcr.Name);
				Weboutstring("<BR>");
			end;
			Resetloop(Lcr);
		// end;
	end;
	

	return;
end;





global webpublic updating procedure WebCreateConsLocationsInAllComp()
begin
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	boolean TrHs, Orf;
	integer i, rwcnt, lcnt;
	record LocationVc Lcr, OrigLcr, OldLcr;
	record ECVendFobSetBlaock ECVFSb;
	row ECVendFobSetBlaock ECVFSrw;
	array string 255 aLoc;
	array integer aCompNr;
	
	
	SetCompany(29,false);
	blockload(ECVFSb);
	
	for (i=0;i<matrowcnt(ECVFSb);i=i+1) begin
		matrowget(ECVFSb,i,ECVFSrw);
		aCompNr[i] = ECVFSrw.CompanyNr;
		aLoc[i] = ECVFSrw.LocCode;
	end;
	lcnt = i;
	
	
	
	for (i=0;i<lcnt;i=i+1) begin
		if (SetCompany(aCompNr[i],false)) then begin
			OrigLcr.Code = aLoc[i];
			if (ReadFirstMain(OrigLcr,1,true)) then begin
				if (nonblank(OrigLcr.ConsigStockCode)) then begin
					if (right(OrigLcr.ConsigStockCode,7)=="_CONSIG") then begin
						RecordNew(Lcr);
						Lcr.Code = left(OrigLcr.ConsigStockCode,len(OrigLcr.ConsigStockCode)-7) & "_BR";
						recordStore(Lcr,true);
						recordCopy(OldLcr,Lcr);
						Lcr.Name = "  " & aLoc[i];
						Lcr.StockAcc = OrigLcr.StockAcc;
						Lcr.Objects = OrigLcr.Objects;
						Lcr.FOBSuplier = OrigLcr.FOBSuplier;
						RecordUpdate (OldLcr,Lcr,true);
						OrigLcr.DefectStockCode = Lcr.Code;
						RecordStore(OrigLcr,true);
					end else begin
						if (right(OrigLcr.ConsigStockCode,4)=="_CSG") then begin
							RecordNew(Lcr);
							Lcr.Code = left(OrigLcr.ConsigStockCode,len(OrigLcr.ConsigStockCode)-4) & "_BR";
							recordStore(Lcr,true);
							recordCopy(OldLcr,Lcr);
							Lcr.Name = "  " & aLoc[i];
							Lcr.StockAcc = OrigLcr.StockAcc;
							Lcr.Objects = OrigLcr.Objects;
							Lcr.FOBSuplier = OrigLcr.FOBSuplier;
							RecordUpdate (OldLcr,Lcr,true);
							OrigLcr.DefectStockCode = Lcr.Code;
							RecordStore(OrigLcr,true);
						end;
					end;
				end;
			end;
		end;
	end;
	

	return;
end;









// global updating procedure CorrectErrorsSHFromIDGroupComp()
// begin
	// record SHVc SHr;
	// row SHVc SHrw;
	// record POVc POr;
	// record PUVc PUr;
	// row PUVc PUrw;
	// boolean TrHs, testf, remf, updf;
	// integer MainCompany, i, j, LCNt, trdouble;
	// record ECVendFobSetBlaock CObjr;
	// row ECVendFobSetBlaock CObjrw;
	// vector integer vObjComp;
	// vector val vItemFRV;
	// record RLinkVc RLr;
	// LongInt PUrSerNr, cnt1, cnt2, shcnt, trmtrw;
	// record ItemHistVc IHr, oldIHr;
	// record TRVc TRr, oldTRr;
	// row TRVc TRrw;
	
	
	// MainCompany = 18;
	
	// SetCompany(MainCompany,false);
	// BlockLoad(CObjr);
	// for (i=0;i<matrowcnt(CObjr);i=i+1) begin
		// matrowget(CObjr,i,CObjrw);
		// vObjComp[CObjrw.VendName] = CObjrw.CompanyNr;
	// end;
	
	// SHr.OKFlag = 1;
	// TrHs = true;
	
	// cnt1 = 0;
	// cnt2 = 0;
	// shcnt = 0;
	// while (loopkey("OKFlag",SHr,1,TrHs)) begin
		// updf = false;
		// if (SHr.OKFlag != 1) then begin TrHs = false; end;
		// if (TrHs) then begin
			// for (i=0;i<matrowcnt(SHr);i=i+1)begin
				// matrowget(SHr,i,SHrw);
				// if (SHrw.Ship>0) then begin
					// vItemFRV[SHr.SerNr & "_" & i - j] = SHrw.FIFORowVal;
				// end else begin
					// j = j + 1;
				// end;
			// end;
			// LCNt = 1;
			// while (ReadRecordLink(SHr,LCNt,PUr,RLr)) begin
				// PUrSerNr = PUr.SerNr;
				// if(setcompany(vObjComp[SHr.CustCode],false))then begin
					// PUr.SerNr = PUrSerNr;
					// if (ReadFirstMain(PUr,1,true)) then begin
						// if (PUr.OKFlag==1) then begin
							// for (i=0;i<matrowcnt(PUr);i=i+1) begin
								// matrowget(PUr,i,PUrw);
								// if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and vItemFRV[SHr.SerNr & "_" & i]/PUrw.Sum > 1.5) then begin
									
									// IHr.FileName = "PUVc";
									// IHr.TransNr = PUr.SerNr;
									// IHr.Row = i;
									// remf = false;
									// if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
										// if (IHr.Qty == IHr.RemQty) then begin
											// weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum & " Remf: " & remf);
											// weboutstring("<BR>");
											// logtext (0,"SH SerNr: " & SHr.SerNr);
											// RecordCopy(oldIHr,IHr);
											// IHr.TotCostPrice = vItemFRV[SHr.SerNr & "_" & i];
											// IHr.RemCostPrice = vItemFRV[SHr.SerNr & "_" & i];
											// if (RecordUpdate(oldIHr,IHr,true)==0) then begin
												// weboutstring("IH Updated");
												// weboutstring("<BR>");
												// logtext (0,"IH Updated");
												// trdouble = 0;
												// trmtrw = 0;
												// TRr.Number = PUr.SerNr;
												// TRr.IntYc = PUYc;
												// if (ReadFirstMain(TRr,2,true)) then begin
													// RecordCopy(oldTRr,TRr);
													// for (j=0;j<matrowcnt(TRr);j=j+1) begin
														// if (trmtrw == i)then begin
															// matrowget(TRr,j,TRrw);
															// if (TRrw.DebVal!=blankval) then begin
																// TRrw.DebVal = vItemFRV[SHr.SerNr & "_" & i];
															// end;
															// if (TRrw.CredVal!=blankval) then begin
																// TRrw.CredVal = vItemFRV[SHr.SerNr & "_" & i];
															// end;
															// matrowput(TRr,j,TRrw);
														// end;
														// if (trdouble==1)then begin
															// trdouble = 0;
															// trmtrw = trmtrw + 1;
														// end else begin
															// trdouble = 1;
														// end;
													// end;
													// logtext(0,TRr.Number);
													// if (RecordUpdate(oldTRr,TRr,true)==0) then begin
														// weboutstring("TR Updated");
														// weboutstring("<BR>");
														// logtext (0,"TR Updated");
														// PUrw.Sum = vItemFRV[SHr.SerNr & "_" & i];
														// PUrw.CostPrice = PUrw.Sum / PUrw.Quant;
														// matrowput(PUr,i,PUrw);
														// updf = true;
													// end;
												// end;
											// end;
										// end;
									// end;
									// cnt1 = cnt1 + 1;
								// end;
								// if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and PUrw.Sum/vItemFRV[SHr.SerNr & "_" & i] > 1.5) then begin 
									
									// IHr.FileName = "PUVc";
									// IHr.TransNr = PUr.SerNr;
									// IHr.Row = i;
									// remf = false;
									// if(ReadFirstKey("FNTransNr",IHr,3,true)) then begin
										// if (IHr.Qty == IHr.RemQty) then begin
											// weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum & " Remf: " & remf);
											// weboutstring("<BR>");

											// RecordCopy(oldIHr,IHr);
											// IHr.TotCostPrice = vItemFRV[SHr.SerNr & "_" & i];
											// IHr.RemCostPrice = vItemFRV[SHr.SerNr & "_" & i];
											// if (RecordUpdate(oldIHr,IHr,true)==0) then begin
												// weboutstring("IH Updated");
												// weboutstring("<BR>");
												// logtext (0,"IH Updated");
												// trdouble = 0;
												// trmtrw = 0;
												// TRr.Number = PUr.SerNr;
												// TRr.IntYc = PUYc;
												// if (ReadFirstMain(TRr,2,true)) then begin
													// RecordCopy(oldTRr,TRr);
													// for (j=0;j<matrowcnt(TRr);j=j+1) begin
														// if (trmtrw == i)then begin
															// matrowget(TRr,j,TRrw);
															// if (TRrw.DebVal!=blankval) then begin
																// TRrw.DebVal = vItemFRV[SHr.SerNr & "_" & i];
															// end;
															// if (TRrw.CredVal!=blankval) then begin
																// TRrw.CredVal = vItemFRV[SHr.SerNr & "_" & i];
															// end;
															// matrowput(TRr,j,TRrw);
														// end;
														// if (trdouble==1)then begin
															// trdouble = 0;
															// trmtrw = trmtrw + 1;
														// end else begin
															// trdouble = 1;
														// end;
													// end;
													// if (RecordUpdate(oldTRr,TRr,true)==0) then begin
														// weboutstring("TR Updated");
														// weboutstring("<BR>");
														// logtext (0,"TR Updated");
														// PUrw.Sum = vItemFRV[SHr.SerNr & "_" & i];
														// PUrw.CostPrice = PUrw.Sum / PUrw.Quant;
														// matrowput(PUr,i,PUrw);
														// updf = true;
													// end;
												// end;
											// end;
										// end;
									// end;
									// cnt1 = cnt1 + 1;
								// end;
								// // if (vItemFRV[SHr.SerNr & "_" & i] != PUrw.Sum and vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum < 1) then begin 
									// // weboutstring("SH SerNr: " & SHr.SerNr & " Company: " & vObjComp[SHr.CustCode] & " PU SerNr: " & PUr.SerNr & " row: " & i+1 & " Diff: " & vItemFRV[SHr.SerNr & "_" & i] - PUrw.Sum);
									// // weboutstring("<BR>");
									// // cnt2 = cnt2 + 1;
								// // end;
							// end;
						// end;
						// if (updf) then begin
							// RecordStore (PUr,true);
							// logtext (0,"PU Updated");
						// end;
					// end;
				// end;
				// resetcompany(MainCompany);
				// LCNt = LCNt + 1;
			// end;
		// end;
	// end;
// return;
// end;





global updating procedure QueuedBenchmarkTest(var record GlobalItemVc GIr)
begin
	
	logtext(0,"QueuedBenchmarkTest " & GIr.Code);
	GIr.TPCPCode = 1;
	recordstore(GIr,true);
	
return;
end;


// global webpublic procedure WebGetGlobTypeNamest()
// begin
	// record GlobalItemVc GIr;
	// record BtrxTypeVc Typer;

	// GIr.Code = "";
	// while (loopmain(GIr,1,true)) begin
		// if (nonblank(GIr.BTRxType)) then begin
			// Typer.Code = GIr.BTRxType;
			// if (ReadFirstMain(Typer,1,true)) then begin
				// weboutstring(GIr.Code & "____________" & Typer.Name & "____________" & GIr.Name);
				// weboutstring("<BR>");
			// end;
		// end else begin
			// weboutstring(GIr.Code & "____________" & "N/A" & "____________" & GIr.Name);
			// weboutstring("<BR>");
		// end;
	// end;
	// resetloop(GIr);

// return;
// end;



global webpublic procedure WebGetGlobTypeNamest()
begin
	record GlobalItemVc GIr;
	record BtrxTypeVc Typer;

	GIr.Code = "";
	while (loopmain(GIr,1,true)) begin
		weboutstring(GIr.Code & "____________" & GIr.HansaCode & "____________" & GIr.BPIBrand & "____________" & GIr.Name & "____________" & GIr.NameRUS & "____________" & GIr.NameAZ);
		weboutstring("<BR>");
	end;
	resetloop(GIr);

return;
end;




global webpublic updating procedure WebDeleteAllBTRxTypes()
begin
	record GlobalItemVc GIr;
	record BtrxTypeVc Typer;

	SetCompany(1,false);

	Typer.Code = "BTYPE9999";
	while (loopBackKey("Code",Typer,1,true)) begin
		recordDelete(Typer);
	end;
	resetloop(Typer);

return;
end;






global webpublic procedure WebBenchmarkTest()
begin
	record GlobalItemVc GIr;
	longint stick,etick,recordcounter,updrecordcounter,slipcont;
	val alltime;
	boolean TrHs;
	
	setcompany(1,false);
	stick = GetCurTick;
	recordcounter = 0;
	TrHs = true;
	while(loopmain(GIr,1,TrHs))begin
		if(fileexists("stop"))then begin
			TrHs = false;
		end;
		if(recordcounter>10)then begin
			//TrHs = false;
		end;
		recordcounter = recordcounter + 1;
		queued.QueuedBenchmarkTest(GIr);
		if(slipcont>10)then begin
			millisleep(20);
			slipcont = 0;
		end;
		slipcont = slipcont + 1;
		//recordstore(GIr,true);
	end;
	etick = GetCurTick;
	
	alltime = (etick-stick)/100/60/10;
	
	weboutstring("Time: " & alltime & " minutes " & etick-stick & " ticks");
	weboutstring("<BR>");
	weboutstring("RecordCount: " & recordcounter & " ");
	weboutstring("Updated RecordCount: " & updrecordcounter & " ");
return;
end;

global webpublic procedure WebBenchmarkTestCheck()
begin
	record GlobalItemVc GIr;
	longint stick,etick,recordcounter,updrecordcounter;
	val alltime;
	boolean TrHs;
	
	setcompany(1,false);
	stick = GetCurTick;
	recordcounter = 0;
	TrHs = true;
	while(loopmain(GIr,1,TrHs))begin
		if(GIr.TPCPCode=="1")then begin
			updrecordcounter = updrecordcounter + 1;
		end;
		recordcounter = recordcounter + 1;
	end;
	etick = GetCurTick;
	
	alltime = (etick-stick)/100/60/10;
	
	weboutstring("Time: " & alltime & " minutes " & etick-stick & " ticks");
	weboutstring("<BR>");
	weboutstring("RecordCount: " & recordcounter & " ");
	weboutstring("Updated RecordCount: " & updrecordcounter & " ");
return;
end;

global webpublic updating procedure WebFixItensBarcode()
begin
	record INVc INr, fINr;
	boolean TrHs;
	
	setcompany(18,false);
	
	while(loopmain(INr,1,true))begin
		if(nonblank(INr.BarCode))then begin
			fINr.AlternativeCode = INr.BarCode;
			TrHs = true;
			while(loopkey("AlternativeCode",fINr,1,TrHs))begin
				if(fINr.AlternativeCode!=INr.BarCode)then begin TrHs = false; end;
				
				if(TrHs)then begin
					if(fINr.Code!=INr.Code and INr.BPIBrand==fINr.BPIBrand)then begin
						weboutstring("<BR>");
						weboutstring(fINr.Code & " " & fINr.BPIBrand & " " & fINr.AlternativeCode & " => " & INr.Code & " " & INr.BPIBrand & " " & INr.AlternativeCode);
						INr.BarCode = "";
						//recordstore(INr,true);
						//stepback(INr);
					end;
				end;
			end;
			resetloop(fINr);
		end;
	end;
	
return;
end;


global webpublic updating procedure WebFindWrongFIFOIDGroup()
begin
	record INVc INr;
	record ItemHistVc IHr;
	
	setcompany(18,false);
	weboutstring("<table>");
	
	while(loopmain(IHr,1,true))begin
		if(IHr.TotCostPrice>IHr.TotCostPriceCurncy*3)then begin
			weboutstring("<tr>");
				weboutstring("<td>" & IHr.ArtCode & "</td>");
				weboutstring("<td>" & IHr.TotCostPrice & "</td>");
				weboutstring("<td>" & IHr.TotCostPriceCurncy & "</td>");
				weboutstring("<td>" & IHr.TotCostPrice/IHr.TotCostPriceCurncy & "</td>");
			weboutstring("</tr>");
		end;
	end;
	
	/*while(loopmain(INr,1,true))begin
		if(INr.LastPurchPrice*2<INr.InPrice and INr.LastPurchPrice>=INr.LastPurchPrice2 and INr.LastPurchPrice2>0) then begin
			IHr.ArtCode = INr.Code;
			if(readfirstkey("ArtCode",IHr,1,true))then begin
				weboutstring("<tr>");
				weboutstring("<td>" & INr.Code & "</td>");
				weboutstring("<td>" & INr.AlternativeCode & "</td>");
				weboutstring("<td>" & INr.InPrice & "</td>");
				weboutstring("<td>" & INr.LastPurchPrice & "</td>");
				weboutstring("<td>" & INr.InPrice/INr.LastPurchPrice & "</td>");
				weboutstring("<td>" & INr.LastPurchCurncyCode & "</td>");
				weboutstring("</tr>");
			end;
		end;
		
		
		if(INr.InPrice>INr.LastPurchPrice2*3)then begin
			IHr.ArtCode = INr.Code;
			if(readfirstkey("ArtCode",IHr,1,true))then begin
				weboutstring("<tr>");
				weboutstring("<td>" & INr.Code & "</td>");
				weboutstring("<td>" & INr.AlternativeCode & "</td>");
				weboutstring("<td>" & INr.InPrice & "</td>");
				weboutstring("<td>" & INr.LastPurchPrice2 & "</td>");
				weboutstring("<td>" & INr.InPrice/INr.LastPurchPrice2 & "</td>");
				weboutstring("<td>" & INr.LastPurchCurncyCode & "</td>");
				weboutstring("</tr>");
			end;
		end;
	end;*/
	weboutstring("</table>");

return;
end;

global webpublic updating procedure WebDeleteBarCodes()
begin
	record INVc INr,oldINr;
	string 40 prevbarcode,prevcode;
	
	setcompany(5,false);
	
	logtext(0,"WebDeleteBarCodes");
	
	INr.BarCode = "";
	while(loopkey("BarCode",INr,1,true))begin
		if(nonblank(INr.BarCode))then begin
			if(INr.BarCode==prevbarcode)then begin
				logtext(0,"WebDeleteBarCodes " & INr.Code & "==" & prevcode & "  barcode" & INr.BarCode);
				oldINr.Code = prevcode;
				readfirstmain(oldINr,1,true);
				if(oldINr.BarCode==INr.BarCode and oldINr.Code!=INr.Code)then begin
					if(blank(INr.BPIBrand) or blank(oldINr.BPIBrand) or oldINr.OutOfOrder==1 or INr.OutOfOrder==1)then begin
						logtext(0,"canbecleared");
						if(blank(oldINr.BPIBrand) or oldINr.OutOfOrder==1)then begin
							oldINr.BarCode = "";
							recordstore(oldINr,true);
							logtext(0,"cleared " & oldINr.Code);
							//stepback(INr);
						end;
						if(blank(INr.BPIBrand) or INr.OutOfOrder==1)then begin
							INr.BarCode = "";
							recordstore(INr,true);
							logtext(0,"cleared " & INr.Code);
							//stepback(INr);
						end;
					end;
				end;	
			end;
			prevbarcode = INr.BarCode;
			prevcode = INr.Code;
		end;
	
	end;
	
	
	
return;
end;

global webpublic updating procedure WebGetPing()
begin
	record CUVc CUr;
	record INVc INr;
	record IVVc IVr;
	
	
	setcompany(1,false);
	CUr.Code = random(1000,9999);
	readfirstmain(CUr,1,false);
	INr.Code = random(1000,9999);
	readfirstmain(INr,1,false);
	INr.Code = random(10000,99999);
	readfirstmain(INr,1,false);
	
	weboutstring(random(0,5));

return;
end;

global webpublic updating procedure WebIpdatejsongiSync()
begin
	record GlobalItemVc GIr,oldGIr;
	string 255 tstr;
	Integer pos,textsize;
	
	while(loopmain(GIr,1,true))begin
		textsize = SizeTextCnt(GIr);
		if(textsize>0)then begin
			logtext(0,"WebIpdatejsongiSync " & GIr.Code);
			//recordcopy(oldGIr,GIr);
			//recordupdate(oldGIr,GIr,true);
		end;
	end;

return;
end;


global webpublic updating procedure WebUpdateINItemsForCoin()
begin
	record INVc INr;
	record ConsItemVc CIr;
	boolean TrHs;
	
	setcompany(25,false);
	
	INr.Code = "IN_";
	TrHs = true;
	while(loopmain(INr,1,TrHs))begin
		if(left(INr.Code,3)!="IN_")then begin TrHs = false; end;
		
		if(TrHs)Then begin
			logtext(0,"WebUpdateINItemsForCoin " & INr.Code);
			setcompany(18,false);
				CIr.Code = INr.Code;
				if(readfirstmain(CIr,1,true))then begin
					if(CIr.Code==CIr.LocCode)then begin
						if(nonblank(INr.AlternativeCode))then begin
							CIr.LocCode = INr.AlternativeCode;
							recordstore(CIr,true);
						end;
					end;
				end;
			setcompany(25,false);
		end;
		
	end;

return;
end;

procedure OpenInvoiceNumber(string custcode, var LongInt lastpos,var record APVc resAPr)
begin
  record APVc APr;
  Boolean found;
  string 255 ckey;

  RecordNew(resAPr);  
  APr.VECode = custcode;
  found = true;
  SetLoopPosition(APr,lastpos);

  
  ckey = "VECode";
  while (LoopKey(ckey,APr,1,found)) begin
    if (APr.VECode!=custcode) then begin found = false; end;
    if (found) then begin
      lastpos = GetLoopPosition(APr);
      RecordCopy(resAPr,APr);     
      goto LOpenInvoiceNumber;
    end;    
  end;

LOpenInvoiceNumber:;
  return;
end;

procedure ChangeOPRows(record OPVc OPp,LongInt VISerNr,string reccurncy,Integer currow,var val curv,Boolean installmentf)
begin
  row OPVc OPrw;
  row OPVc newOPrw;
  Integer i,rwcnt;
  val v;
         
  v = curv;
  curv = blankval;
  rwcnt = MatRowCnt(OPp);
  for (i=currow+1;i<rwcnt;i=i+1) begin
    MatRowGet(OPp,i,OPrw);
    if (OPrw.VISerNr==VISerNr) then begin
	    switch (OPrw.stp) begin
	      case 1:
	        if (installmentf) then begin
	        end;
	      case 5: 
	        CopyRow(OPp,OPrw,newOPrw);
			newOPrw.RecCurncy = reccurncy;
			MatRowPut(OPp,i,newOPrw);
			OPVc_PasteRecCurncy(OPp,i);				  
			MatRowGet(OPp,i,newOPrw);
	        v = v - newOPrw.RecVal;
	        curv = curv + newOPrw.RecVal;
	    end;
	  end;
  end;

  MatRowGet(OPp,currow,newOPrw);    
  newOPrw.RecCurncy = RecCurncy;
  MatRowPut(OPp,currow,newOPrw);
  OPVc_PasteRecCurncy(OPp,currow);
    MatRowGet(OPp,currow,newOPrw);
	curv = curv + newOPrw.RecVal;
  
	if (installmentf==false) then begin
    MatRowGet(OPp,currow,newOPrw);
    newOPrw.RecVal = v;
    MatRowPut(OPp,currow,newOPrw);
    OPVc_PasteRecVal(OPp,currow);
    MatRowGet(OPp,currow,newOPrw);
  end;
  RETURN;
END;

global
procedure RecordAction_raExpandOPPay(var record OPVc OPp,Integer rownr,string fobobj)
begin
  row OPVc OP0rw;
  row OPVc newOPrw;
  Integer i,rwcnt,currow;
  record APVc APr;
  record VIVc VIr;
  Boolean loopf,testf,installmentf;
  LongInt lastpos;
  record BaseCurBlock BCb;
  val v,remv,chk;  
  string 255 warning;
  
  BlockLoad(BCb);

  rwcnt = MatRowCnt(OPp);
  currow = rwcnt;
  MatRowGet(OPp,rownr,OP0rw);
  remv = OP0rw.RecVal;
  if (OP0rw.VISerNr<0) and (OP0rw.RecVal>0) then begin
    loopf = true;
  end;
  while (loopf) begin
    OpenInvoiceNumber(OP0rw.VECode,lastpos,APr);    
    if (APr.SerNr<=0) then begin
      loopf = false;
    end;
    if (remv<=0) then begin
      loopf = false;
    end;
    if (loopf) then begin
      testf = true;
      VIr.SerNr = APr.SerNr;
      if (ReadFirstMain(VIr,1,true)) then begin
        testf = true;
        if (VIr.Invalid!=0) then begin
          testf = false;
        end;
      end;
      if(!setinset(fobobj,VIr.Objects))then begin
      	 testf = false;
      end;
      if(VIr.InvDate>OPp.TransDate)then begin
      	testf = false;
      end;
      
      if (testf) then begin
        if (VIr.CurncyCode!=OP0rw.RecCurncy) then begin
          CurValToOtherCur(OPp.TransDate,VIr.CurncyCode,APr.RVal,OP0rw.RecCurncy,v,DefaultCurRoundOff);
        end else begin
          v = APr.RVal;
        end;
        if (remv<v) then begin
          v = remv;
        end;

        ClearRow(OPp,newOPrw,1)
        newOPrw.VISerNr = APr.SerNr;
        MatRowPut(OPp,currow,newOPrw);
        PasteInvIn2OPr(OPp,currow,OPp.TransDate,1,chk,warning,false,installmentf)
        ChangeOPRows(OPp,newOPrw.VISerNr,OP0rw.RecCurncy,currow,v,installmentf);
                
//        currow = currow + 1;
        currow = MatRowCnt(OPp);
        remv = remv - v;        
      end;
    end;    
  end;  
  
  MatRowDelete(OPp,rownr);
  if (remv>0) then begin
    currow = MatRowCnt(OPp);
    CopyRow(OPp,OP0rw,newOPrw);
    MatRowPut(OPp,currow,newOPrw);
    MatRowGet(OPp,currow,newOPrw);
    newOPrw.RecVal = remv;
    MatRowPut(OPp,currow,newOPrw);
    OPVc_PasteRecVal(OPp,currow);
  end;
  OPSumup(OPp,true);
  return;
end;

updating procedure ChangeOPTR(var record TRVc TRr, record IPVc IPr,string vfob,string objcode,integer comtoop)
begin
	record TRVc oldTRr;
	row TRVc TRrw;
	integer rownr,rwcnt,i,oscnt;
	string 50 subdi,expen;
	array string 20 tstr;
	record OPVc OPr,oldOPr;
	row OPVc OPrw;
	val tmpval;
				
		rwcnt = matrowcnt(TRr);
		for(i=0;i<rwcnt;i=i+1)begin
			matrowget(TRr,i,TRrw);
			ExtractObjectsByType(TRrw.Objects,"SUBDI",tstr,oscnt);
			if(oscnt>0)then begin
				if(nonblank(tstr[0]))then begin
					subdi = tstr[0];
				end;
			end;
			ExtractObjectsByType(TRrw.Objects,"EXPEN",tstr,oscnt);
			if(oscnt>0)then begin
				if(nonblank(tstr[0]))then begin
					expen = tstr[0];
				end;
			end;
		end;
		
		recordcopy(oldTRr,TRr);
		clearrow(oldTRr,TRrw,1);
		rownr = matrowcnt(TRr);
		TRrw.AccNumber = "06";
		MatRowPut(TRr,rownr,TRrw);
		TRVc_PasteAccNumber(TRr,1,rownr,true);
		MatRowGet(TRr,rownr,TRrw);
		TRrw.DebVal = IPr.CurPayVal;
		TRrw.CurDebVal = IPr.CurPayVal;
		MatRowPut(TRr,rownr,TRrw);
		TRVc_PasteDebVal(TRr,rownr);
		MatRowGet(TRr,rownr,TRrw);
		TRrw.Objects = "FOB_CC," & vfob;
		if(nonblank(subdi))then begin
			TRrw.Objects = TRrw.Objects & "," & subdi;
		end;
		if(nonblank(expen))then begin
			TRrw.Objects = TRrw.Objects & "," & expen;
		end;
		NormalizeObjstr(TRrw.Objects);
		MatRowPut(TRr,rownr,TRrw);
		
		clearrow(TRr,TRrw,1);
		rownr = matrowcnt(TRr);
		TRrw.AccNumber = "76/01";
		MatRowPut(TRr,rownr,TRrw);
		TRVc_PasteAccNumber(TRr,1,rownr,true);
		MatRowGet(TRr,rownr,TRrw);
		TRrw.CredVal = IPr.CurPayVal;
		TRrw.CurCredVal = IPr.CurPayVal;
		MatRowPut(TRr,rownr,TRrw);
		TRVc_PasteCredVal(TRr,rownr);
		MatRowGet(TRr,rownr,TRrw);
		TRrw.Objects = "FOB_CC," & vfob;
		if(nonblank(subdi))then begin
			TRrw.Objects = TRrw.Objects & "," & subdi;
		end;
		if(nonblank(expen))then begin
			TRrw.Objects = TRrw.Objects & "," & expen;
		end;
		NormalizeObjstr(TRrw.Objects);
		MatRowPut(TRr,rownr,TRrw);
		TRSumup(TRr,tmpval);
		if(recordupdate(oldTRr,TRr,true)==0)then begin
			setcompany(comtoop,false);
				recordnew(OPr);
					OPr.TransDate = IPr.TransDate;
					OPr.PayDate = OPr.TransDate;
					OPr.PayMode = "VZ";
					OPPastePayMode2(OPr,"");
					OPr.SerNr = NextSerNr("OPVc",OPr.TransDate,-1,false,"");
					clearrow(OPr,OPrw,1);
					OPrw.VECode = "FOB_SKLAD";
					matrowput(OPr,0,OPrw);
					OPVc_PasteVECode(OPr,0);
					MatRowGet(OPr,0,OPrw);
					OPrw.RecVal = IPr.CurPayVal;
					MatRowPut(OPr,0,OPrw);
					OPVc_PasteRecVal(OPr,0);
					RecordAction_raExpandOPPay(OPr,0,vfob);
					if(matrowcnt(OPr)>0)then begin
						MatRowget(OPr,matrowcnt(OPr)-1,OPrw);
						if(OPrw.VISerNr<0)then begin
							matrowdelete(OPr,matrowcnt(OPr)-1);
							OPSumup(OPr,true);
						end;
					end;
				if(matrowcnt(OPr)>0)then begin
					recordstore(OPr,true);
					recordcopy(oldOPr,OPr);
					OPr.OrderedFlag = 1;
					OPr.DoneFlag = 1;
					recordupdate(oldOPr,OPr,true);
					createrecordlink(IPr,18,OPr,currentcompany);
					createrecordlink(OPr,currentcompany,IPr,18);
				end;
			setcompany(18,false);
		end;

return
end;


global updating procedure ColelctPaymentsCCAndOthersMn(record RcVc RepSpec)
begin
	record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  integer i,rwcnt,oscnt,rownr;
  record LocationVc Locr;
  record ObjVc Objr, Obj2r;
  boolean TrHs,testf;
  record ObjBalVc ObjBalr;
  val res1,res2;
  record CUVc CUr;
  vector string 200 vCuObj,vFOBObjStore;
  array string 200 stores;
  record IPVc IPr,oldIPr;
  row IPVc IPrw;
  longint lg;
  record TRVc TRr,oldTRr;
  row TRVc TRrw;
  vector integer vFomCompNr;
    
  
  if(blank(RepSpec.d1))then begin
  	RepSpec.d1 = addday(currentdate,-1);
  end;  
  
  blockload(Compb);
  rwcnt = matrowcnt(Compb);
  for(i=0;i<rwcnt;i=i+1)begin
  	matrowget(Compb,i,Comprw);
  	if(Comprw.ActiveStatus==0)then begin
  		setcompany(i+1,false);
  		resetloop(Locr);
  		Locr.Code = "";
  		while(loopmain(Locr,1,true))begin
  			if(nonblank(Locr.FOBSuplier))then begin
  				vFOBObjStore[Locr.FOBSuplier] = Locr.Objects;
  				vFomCompNr[Locr.FOBSuplier] = i+1;
  			end;
  		end;
  	end;
  end;
  
  
  setcompany(18,false);
  
  CUr.CustCat = "STORE";
  TrHs = true;
  while(loopkey("Group",CUr,1,TrHs))begin
  	if(CUr.CustCat!="STORE")then begin TrHs = false;  end;

  	if(TrHs)then begin
  		if(nonblank(CUr.Objects))then begin
  			ClearArray(stores);
  			ExtractObjectsByType(CUr.Objects,"FOB",stores,oscnt);
  			vCuObj[stores[0]] = CUr.Code;
				//weboutstring(stores[0]);
  		end;
  	end;
  end;
  
  resetloop(Objr);
  Objr.OTCode = "FOB";
  TrHs = true;
  while(loopkey("OTCode",Objr,1,TrHs))begin
  	testf = true;
  	if(Objr.OTCode!="FOB")then begin TrHs = false; testf = false; end;
  	if(Objr.Code=="FOB_CC")then begin testf = false; end;
  	
  	logtext(0,"ColelctPaymentsCCAndOthersMn objloop " & Objr.Code);
  	
  	if(testf)then begin
  		//weboutstring("CC," & Objr.Code);
  		ObjBalr.AccNumber = "76/01";
			ObjBalr.Object = Objr.Code;
			ReadFirstMain(ObjBalr,2,true); 
			res1 = blankval;
			res2 = blankval;
			FindNLAccBal("76/01","CC," & Objr.Code,"",0,"",RepSpec.d1,0,0,false,"",0,"","",res1);
  		logtext(0,"ColelctPaymentsCCAndOthersMn 76/01 " & RepSpec.d1 & " " & res1);
  		
  		if(res1<0)then begin
  			recordnew(IPr);
  			clearrow(IPr,IPrw,1);
  			IPr.TransDate = addday(RepSpec.d1,-1);
				IPr.SerNr = NextSerNr("IPVc",IPr.TransDate,-1,false,"");
				IPr.PayMode = "VZ";
				IPPastePayMode2(IPr,"");
				IPr.Comment = IPr.Comment & " " & vFOBObjStore[Objr.Code];
  			IPrw.CustCode = vCuObj[Objr.Code];
  			matrowput(IPr,0,IPrw);
  			IPVc_PasteCustCode(IPr,0,lg);
  			matrowget(IPr,0,IPrw);
  			IPrw.RecVal = -res1;
  			matrowput(IPr,0,IPrw);
  			IPVc_PasteRecVal(IPr,0);
  			matrowget(IPr,0,IPrw);
  			RecordAction_raExpandPay(IPr,0);
  			if(matrowcnt(IPr)>0)then begin
					matrowget(IPr,matrowcnt(IPr)-1,IPrw);
					if(IPrw.InvoiceNr<=0)then begin
						matrowdelete(IPr,matrowcnt(IPr)-1);
						IPSumup(IPr);
					end;
  			end;
  			
  			if(matrowcnt(IPr)>0)then begin
  				recordstore(IPr,true);
					recordcopy(oldIPr,IPr);
					IPr.OKFlag = 1;
					if(recordupdate(oldIPr,IPr,true)==0)then begin
						if(IPr.SerNr>0)then begin
							TRr.Number = IPr.SerNr;
							TRr.IntYc = IPYc;
							if(readfirstmain(TRr,2,true))then begin
								ChangeOPTR(TRr,IPr,vFOBObjStore[Objr.Code],Objr.Code,vFomCompNr[Objr.Code]);
							end;
						end;
					end;
  			end;
  		end;
  		
  	end;
  end;

return;
end;