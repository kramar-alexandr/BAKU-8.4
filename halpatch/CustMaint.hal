//server-only
external function string 60 AddObjectToObjectList(string,string);
external procedure NextM4SerialNumber(string,var string);
external procedure ExtractObj(string,var Integer,var string);
external procedure NormalizeObjstr(var string);
external function boolean CompanyIsJWLikeCompany(Integer);
external function string 255 StrReplace(string,string,string);
remote updating procedure CreatePOfromCCSH(record SHVc);
external function Boolean VIVc_PasteVECode(var record VIVc,Integer,Boolean,Boolean,var string);
external function Boolean GetAccName(string,var string,Integer);
external procedure ExtractObj(string,var Integer,var string);
external procedure ExtractObjectsByType(string, string, var array string, var integer);
remote procedure VICalcVals(var record VIVc);
external procedure VISumup(record VIVc,var val);
external procedure VIVc_PastePayVal(var record VIVc);
//external procedure MyExtractObj(string,var Integer,var string);
 external function val AbsoluteVal(val);
remote updating procedure CreateNewGlobalItem(var record INVc);
external function roundmode SetRoundModeD(Integer);
external updating procedure DeleteTransaction(LongInt,Integer);
external procedure TRSumup(var record TRVc,var val);
external function string 60 RemoveObjectFromObjectList(string,string);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
external updating procedure SendUpdateContactToCRM(var record CUVc);
remote updating procedure CreateECPOfromLocalORForCOVID19Period(record SHVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 15:58 24.03.2020
remote updating procedure ORLClassYellowColour(longint); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 15:29 14.04.2020
external procedure CheckFlush(var Integer,Integer);
external procedure NextCode(string,var string);
external function LongInt INVcRecordRemoveTest(var record INVc,record INVc,LongInt,LongInt);
remote updating procedure RecalcORMn(record RcVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 16:02 15.03.2021


SetLangMode(LangRussian,"RUS",0);






updating function boolean TPSetItemBitrixClass(var record GlobalItemVc GIr,array string headers,array string params, var array string ErrAr, var integer ErrCnt,var array string ErrAr2,var vector string classCode)
begin
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr, BSLLastCoder;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	record BtrxStrapMatVc BtrxStrapMatr;
	record BtrxBracelMatVc BtrxBracelMatr;
	record BtrxCollectionVc BtrxCollectionr;
	record BtrxComplicationsVc BtrxComplicationsr;
	record BtrxMicrowaveProtectVc BtrxMicrowaveProtectr;
	record BtrxStoveCompatVc BtrxStoveCompatr;
	record BtrxAllMaterialsVc BtrxAllMaterialsr;
	record BtrxPrecMetalContVc BtrxPrecMetalContr;
	record BtrxCaseDiamVc BtrxCaseDiamr;
	
	integer i, pos;
	string 100 param, OldCode, newCode;
	boolean res, TrHs, testf, THRDf, catrtreef, createdf;
	string 255 catName, catNameRUS, catNameAZ, parametr, paramsStr, Name3catrus, Name3cataz, tree3Code;
	
	SetCompany(1,false);
	// logtext(0,"SetItemBitrixClass");
	newCode = "";
	GIr.BTRxGiftClass = "";
	res = true;
	logtext(0,GIr.Code);
	for(i=0;i<headers.length;i=i+1)begin
		param = headers[i];
		// logtext(0,param);
		params[i] = trim(params[i]);
		// logtext(0,params[i]);
		switch(param)begin
			case"Brand": 			if(blank(params[i]))then begin
													GIr.BPIBrand = "";
												end else begin
													BTRxBrandr.Name = params[i];
													if(readfirstkey("Name",BTRxBrandr,1,true))then begin
														GIr.BPIBrand = BTRxBrandr.Code;
													end else begin
														BTRxBrandr.Code = params[i];
														if(readfirstmain(BTRxBrandr,1,true))then begin
															GIr.BPIBrand = BTRxBrandr.Code;
														end else begin
															GIr.BPIBrand = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrCnt = ErrCnt + 1;
															 // BTRxBrandr.Code = "BRND9999";
															 // TrHs = true;
															 // while (LoopBackKey("Code",BTRxBrandr,1,TrHs)) begin
																 // OldCode = BTRxBrandr.Code;
																 // TrHs = false;
															 // end;
															 // ResetLoop(BTRxBrandr);
															 // recordnew(BTRxBrandr);
															 // if(blank(OldCode))then begin OldCode = "BRND0000"; end;
															 // NextCode(OldCode,BTRxBrandr.Code);
															 // BTRxBrandr.Name = params[i];
															 // recordinsert(BTRxBrandr,true);
															 // recordupdate(BTRxBrandr,BTRxBrandr,true);
															 // GIr.BPIBrand = BTRxBrandr.Code;
															 // res = true;
															 // OldCode = "";
														end;
													end;
												end;
			case"IntCat": 		if(blank(params[i]))then begin
													GIr.BTRxInterCatClass = "";
												end else begin
													BtrxInternalCatr.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxInternalCatr,1,true))then begin
														GIr.BTRxInterCatClass = BtrxInternalCatr.Code;
													end else begin
														BtrxInternalCatr.Code = params[i];
														if(readfirstmain(BtrxInternalCatr,1,true))then begin
															GIr.BTRxInterCatClass = BtrxInternalCatr.Code;
														end else begin
															// GIr.BTRxInterCatClass = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxInternalCatr.Code = "INCAT9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxInternalCatr,1,TrHs)) begin
																// OldCode = BtrxInternalCatr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxInternalCatr);
															// recordnew(BtrxInternalCatr);
															// if(blank(OldCode))then begin OldCode = "INCAT0000"; end;
															// NextCode(OldCode,BtrxInternalCatr.Code);
															// BtrxInternalCatr.Name = params[i];
															// recordinsert(BtrxInternalCatr,true);
															// recordupdate(BtrxInternalCatr,BtrxInternalCatr,true);
															// GIr.BTRxInterCatClass = BtrxInternalCatr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Type": 			if(blank(params[i]))then begin
													GIr.BTRxType = "";
												end else begin
													BtrxTyper.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxTyper,1,true))then begin
														GIr.BTRxType = BtrxTyper.Code;
													end else begin
														BtrxTyper.Code = params[i];
														if(readfirstmain(BtrxTyper,1,true))then begin
															GIr.BTRxType = BtrxTyper.Code;
														end else begin
															// GIr.BTRxType = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxTyper.Code = "BTYPE9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxTyper,1,TrHs)) begin
																// OldCode = BtrxTyper.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxTyper);
															// recordnew(BtrxTyper);
															// if(blank(OldCode))then begin OldCode = "BTYPE0000"; end;
															// NextCode(OldCode,BtrxTyper.Code);
															// BtrxTyper.Name = params[i];
															// recordinsert(BtrxTyper,true);
															// recordupdate(BtrxTyper,BtrxTyper,true);
															// GIr.BTRxType = BtrxTyper.Code;
															// res = true;
															// OldCode = "";
														end;
													end;					
												end;
			// case"Cat1":				if(blank(params[i]))then begin
													// GIr.BTRxFirstLevCat = "";
												// end else begin
													// pos = 0;
													// BtrxFirstLevelCatr.Name = "";
													// paramsStr = "";
													// parametr = trim(params[i]);
													// // ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													// // while (nonblank(paramsStr)) begin
														// // if(nonblank(BtrxFirstLevelCatr.Name))then begin
															// // BtrxFirstLevelCatr.Name = BtrxFirstLevelCatr.Name & " ";
														// // end;
														// // BtrxFirstLevelCatr.Name = BtrxFirstLevelCatr.Name & paramsStr;
														// // ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													// // end;
													// BtrxFirstLevelCatr.Name = parametr;
													// if(readfirstkey("Name",BtrxFirstLevelCatr,1,true))then begin
														// GIr.BTRxFirstLevCat = BtrxFirstLevelCatr.Code;
													// end else begin
														// BtrxFirstLevelCatr.Code = params[i];
														// if(readfirstmain(BtrxFirstLevelCatr,1,true))then begin
															// GIr.BTRxFirstLevCat = BtrxFirstLevelCatr.Code;
														// end else begin
															// // GIr.BTRxFirstLevCat = "";
															// // ErrAr[ErrCnt] = param & ": " & params[i];
															// // ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// // ErrCnt = ErrCnt + 1;
															// logtext(0,"yes");
															// BtrxFirstLevelCatr.Code = "FILVL9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxFirstLevelCatr,1,TrHs)) begin
																// OldCode = BtrxFirstLevelCatr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxFirstLevelCatr);
															// recordnew(BtrxFirstLevelCatr);
															// if(blank(OldCode))then begin OldCode = "FILVL0000"; end;
															// NextCode(OldCode,BtrxFirstLevelCatr.Code);
															// BtrxFirstLevelCatr.Name = params[i];
															// recordinsert(BtrxFirstLevelCatr,true);
															// recordupdate(BtrxFirstLevelCatr,BtrxFirstLevelCatr,true);
															// GIr.BTRxFirstLevCat = BtrxFirstLevelCatr.Code;
															// res = true;
															// OldCode = "";
														// end;
													// end;
												// end;
			// case"Cat2":				if(blank(params[i]))then begin
													// GIr.BTRxSecondLevCat = "";
												// end else begin
													// pos = 0;
													// BtrxSecondLevelCatr.Name = "";
													// paramsStr = "";
													// parametr = trim(params[i]);
													// // ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													// // while (nonblank(paramsStr)) begin
														// // if(nonblank(BtrxSecondLevelCatr.Name))then begin
															// // BtrxSecondLevelCatr.Name = BtrxSecondLevelCatr.Name & " ";
														// // end;
														// // BtrxSecondLevelCatr.Name = BtrxSecondLevelCatr.Name & paramsStr;
														// // ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													// // end;
													// BtrxSecondLevelCatr.Name = parametr;
													// if(readfirstkey("Name",BtrxSecondLevelCatr,1,true))then begin
														// GIr.BTRxSecondLevCat = BtrxSecondLevelCatr.Code;
													// end else begin
														// BtrxSecondLevelCatr.Code = params[i];
														// if(readfirstmain(BtrxSecondLevelCatr,1,true))then begin
															// GIr.BTRxSecondLevCat = BtrxSecondLevelCatr.Code;
														// end else begin
															// GIr.BTRxSecondLevCat = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
														// end;
													// end;
												// end;
			// case"Cat3":				if(blank(params[i]))then begin
													// GIr.BTRxThirdLevCat = GIr.BTRxGiftClass;
												// end else begin
													// TrHs = true;
													// resetloop(BtrxThirdLevelCatr);
													// BtrxThirdLevelCatr.Name = trim(params[i]);
													// while(loopkey("Name",BtrxThirdLevelCatr,1,TrHs))begin
														// if(BtrxThirdLevelCatr.Name!=params[i])then begin TrHs = false; end;
														
														// if(TrHs)then begin
															// if(BtrxThirdLevelCatr.PathScndCode==GIr.BTRxSecondLevCat)then begin
																// if(nonblank(GIr.BTRxGiftClass))then begin
																	// GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code & "," & GIr.BTRxGiftClass;
																// end else begin
																	// GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
																// end;
															// end;
														// end;
													// end;
													
												// end;
												// /*if(blank(params[i]))then begin
													// GIr.BTRxThirdLevCat = "";
												// end else begin
													// pos = 0;
													// BtrxThirdLevelCatr.Name = "";
													// paramsStr = "";
													// parametr = params[i];
													// ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													// while (nonblank(paramsStr)) begin
														// if(nonblank(BtrxThirdLevelCatr.Name))then begin
															// BtrxThirdLevelCatr.Name = BtrxThirdLevelCatr.Name & " ";
														// end;
														// BtrxThirdLevelCatr.Name = BtrxThirdLevelCatr.Name & paramsStr;
														// ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													// end;
													// if(readfirstkey("Name",BtrxThirdLevelCatr,1,true))then begin
														// Name3catrus = BtrxThirdLevelCatr.NameRUS;
														// Name3cataz = BtrxThirdLevelCatr.NameAZ;
														// if(BtrxThirdLevelCatr.RelatedTo==GIr.BTRxSecondLevCat)then begin
															// if(nonblank(GIr.BTRxThirdLevCat))then begin
																// GIr.BTRxThirdLevCat = "," & GIr.BTRxThirdLevCat;
															// end;
															// GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code & GIr.BTRxThirdLevCat;
															// pos = 0;
															// BtrxThirdLevelCatr.Name = "";
															// paramsStr = "";
															// parametr = GIr.BTRxThirdLevCat;
															// GIr.BTRxThirdLevCat = "";
															// ExtractObjWithSeparator(",",parametr,true,pos,paramsStr);
															// THRDf = false;
															// while (nonblank(paramsStr)) begin
																// BtrxThirdLevelCatr.Name = paramsStr;
																// if(ReadFirstMain(BtrxThirdLevelCatr,1,true) and !THRDf)then begin
																	// THRDf = true;
																	// if(nonblank(GIr.BTRxThirdLevCat))then begin GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ","; end;
																	// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & paramsStr;
																// end else begin
																	// BtrxThirdLevelCatr.Name = paramsStr;
																	// if(!ReadFirstMain(BtrxThirdLevelCatr,1,true)) then begin
																		// if(nonblank(GIr.BTRxThirdLevCat))then begin GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ","; end;
																		// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & paramsStr;
																	// end;
																// end;
																// ExtractObjWithSeparator(",",parametr,true,pos,paramsStr);
															// end;
														// end else begin

														// end;
													// end else begin
														// BtrxThirdLevelCatr.Code = params[i];
														// if(readfirstmain(BtrxThirdLevelCatr,1,true))then begin
															// GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
														// end else begin
															// GIr.BTRxThirdLevCat = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
														// end;
													// end;
												// end;*/
			case"Name":				if(nonblank(params[i]))then begin GIr.Name = params[i]; end;
			case"NameRUS":		if(nonblank(params[i]))then begin GIr.NameRUS = params[i]; end;
			case"NameAZ":			if(nonblank(params[i]))then begin GIr.NameAZ = params[i]; end;
			case"ReffCode":		if(nonblank(params[i]))then begin GIr.ReffCode = params[i]; end;
			case"Material":		if(blank(params[i]))then begin
													GIr.BPIMaterial = "";
												end else begin
													BTRxMaterialr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
														GIr.BPIMaterial = BTRxMaterialr.Code;
													end else begin
														BTRxMaterialr.Code = params[i];
														if(readfirstmain(BTRxMaterialr,1,true))then begin
															GIr.BPIMaterial = BTRxMaterialr.Code;
														end else begin
															// GIr.BPIMaterial = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxMaterialr.Code = "MATR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxMaterialr,1,TrHs)) begin
																// OldCode = BTRxMaterialr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxMaterialr);
															// recordnew(BTRxMaterialr);
															// if(blank(OldCode))then begin OldCode = "MATR00000"; end;
															// NextCode(OldCode,BTRxMaterialr.Code);
															// BTRxMaterialr.Name = params[i];
															// recordinsert(BTRxMaterialr,true);
															// recordupdate(BTRxMaterialr,BTRxMaterialr,true);
															// GIr.BPIMaterial = BTRxMaterialr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Plating":		if(blank(params[i]))then begin
													GIr.BPIPlating = "";
												end else begin
													BTRxPlatingr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxPlatingr,1,true))then begin
														GIr.BPIPlating = BTRxPlatingr.Code;
													end else begin
														BTRxPlatingr.Code = params[i];
														if(readfirstmain(BTRxPlatingr,1,true))then begin
															GIr.BPIPlating = BTRxPlatingr.Code;
														end else begin
															// GIr.BPIPlating = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxPlatingr.Code = "PLAT99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxPlatingr,1,TrHs)) begin
																// OldCode = BTRxPlatingr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxPlatingr);
															// recordnew(BTRxPlatingr);
															// if(blank(OldCode))then begin OldCode = "PLAT00000"; end;
															// NextCode(OldCode,BTRxPlatingr.Code);
															// BTRxPlatingr.Name = params[i];
															// recordinsert(BTRxPlatingr,true);
															// recordupdate(BTRxPlatingr,BTRxPlatingr,true);
															// GIr.BPIPlating = BTRxPlatingr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Gender":			if(blank(params[i]))then begin
													GIr.BPISex = "";
												end else begin
													BTRxSexr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxSexr,1,true))then begin
														GIr.BPISex = BTRxSexr.Code;
													end else begin
														BTRxSexr.Code = params[i];
														if(readfirstmain(BTRxSexr,1,true))then begin
															GIr.BPISex = BTRxSexr.Code;
														end else begin
															// GIr.BPISex = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxSexr.Code = "SEX99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxSexr,1,TrHs)) begin
																// OldCode = BTRxSexr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxSexr);
															// recordnew(BTRxSexr);
															// if(blank(OldCode))then begin OldCode = "SEX00000"; end;
															// NextCode(OldCode,BTRxSexr.Code);
															// BTRxSexr.Name = params[i];
															// recordinsert(BTRxSexr,true);
															// recordupdate(BTRxSexr,BTRxSexr,true);
															// GIr.BPISex = BTRxSexr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Size":				if(blank(params[i]))then begin
													GIr.BPISize = "";
												end else begin
													if (GIr.HansaCode == "R17080OX52") then begin logtext(0,params[i]); end;
													BTRxSizer.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxSizer,1,true))then begin
														GIr.BPISize = BTRxSizer.Code;
													end else begin
														BTRxSizer.Code = params[i];
														if(readfirstmain(BTRxSizer,1,true))then begin
															GIr.BPISize = BTRxSizer.Code;
														end else begin
															// GIr.BPISize = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxSizer.Code = "SZ99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxSizer,1,TrHs)) begin
																// OldCode = BTRxSizer.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxSizer);
															// recordnew(BTRxSizer);
															// if(blank(OldCode))then begin OldCode = "SZ00000"; end;
															// NextCode(OldCode,BTRxSizer.Code);
															// BTRxSizer.Name = params[i];
															// recordinsert(BTRxSizer,true);
															// recordupdate(BTRxSizer,BTRxSizer,true);
															// GIr.BPISize = BTRxSizer.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Weight":			GIr.StrWeight = params[i];
			case"Volume":			GIr.StrVolume = params[i];
			case"Diameter":		GIr.StrBTRxDiam = params[i];
			case"Width":			GIr.StrWidth = params[i];
			case"Length":			GIr.StrDepth = params[i];
			case"Height":			GIr.StrHeight = params[i];
			case"SetQty":			GIr.StrBTRxSetQty = params[i];
			case"FinGirth":		GIr.BTRxFingerGirth = params[i];
			case"ProdColor":	if(blank(params[i]))then begin
													GIr.BTRxProdColour = "";
												end else begin
													BTRxColorr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxColorr,1,true))then begin
														GIr.BTRxProdColour = BTRxColorr.Code;
													end else begin
														BTRxColorr.Code = params[i];
														if(readfirstmain(BTRxColorr,1,true))then begin
															GIr.BTRxProdColour = BTRxColorr.Code;
														end else begin
															// GIr.BTRxProdColour = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxColorr.Code = "CL99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxColorr,1,TrHs)) begin
																// OldCode = BTRxColorr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxColorr);
															// recordnew(BTRxColorr);
															// if(blank(OldCode))then begin OldCode = "CL00000"; end;
															// NextCode(OldCode,BTRxColorr.Code);
															// BTRxColorr.Name = params[i];
															// recordinsert(BTRxColorr,true);
															// recordupdate(BTRxColorr,BTRxColorr,true);
															// GIr.BTRxProdColour = BTRxColorr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Cert":				GIr.Cert = params[i];
			case"Warranty":		GIr.BtrxWarranty = params[i];
			case"ScratchRes":	GIr.BtrxScratchRes = params[i];
			case"isLimit":		if(params[i]=="1")then begin GIr.BTRxLimitedGood = 1; end;
			case"Mech":				if(blank(params[i]))then begin
													GIr.BTRxWatchMechanism = "";
												end else begin
													BtrxWatchMechanr.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxWatchMechanr,1,true))then begin
														GIr.BTRxWatchMechanism = BtrxWatchMechanr.Code;
													end else begin
														BtrxWatchMechanr.Code = params[i];
														if(readfirstmain(BtrxWatchMechanr,1,true))then begin
															GIr.BTRxWatchMechanism = BtrxWatchMechanr.Code;
														end else begin
															// GIr.BTRxWatchMechanism = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxWatchMechanr.Code = "WTMEC9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatchMechanr,1,TrHs)) begin
																// OldCode = BtrxWatchMechanr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatchMechanr);
															// recordnew(BtrxWatchMechanr);
															// if(blank(OldCode))then begin OldCode = "WTMEC0000"; end;
															// NextCode(OldCode,BtrxWatchMechanr.Code);
															// BtrxWatchMechanr.Name = params[i];
															// recordinsert(BtrxWatchMechanr,true);
															// recordupdate(BtrxWatchMechanr,BtrxWatchMechanr,true);
															// GIr.BTRxWatchMechanism = BtrxWatchMechanr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"LifeTime":		if(blank(params[i]))then begin
													GIr.BTRxPowerReserve = "";
												end else begin
													BtrxPowerReserver.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxPowerReserver,1,true))then begin
														GIr.BTRxPowerReserve = BtrxPowerReserver.Code;
													end else begin
														BtrxPowerReserver.Code = params[i];
														if(readfirstmain(BtrxPowerReserver,1,true))then begin
															GIr.BTRxPowerReserve = BtrxPowerReserver.Code;
														end else begin
															// GIr.BTRxPowerReserve = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxPowerReserver.Code = "PWRES9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxPowerReserver,1,TrHs)) begin
																// OldCode = BtrxPowerReserver.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxPowerReserver);
															// recordnew(BtrxPowerReserver);
															// if(blank(OldCode))then begin OldCode = "PWRES0000"; end;
															// NextCode(OldCode,BtrxPowerReserver.Code);
															// BtrxPowerReserver.Name = params[i];
															// recordinsert(BtrxPowerReserver,true);
															// recordupdate(BtrxPowerReserver,BtrxPowerReserver,true);
															// GIr.BTRxPowerReserve = BtrxPowerReserver.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Strap":			if(blank(params[i]))then begin
													GIr.BPIStrap = "";
												end else begin
													BTRxStrapr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxStrapr,1,true))then begin
														GIr.BPIStrap = BTRxStrapr.Code;
													end else begin
														BTRxStrapr.Code = params[i];
														if(readfirstmain(BTRxStrapr,1,true))then begin
															GIr.BPIStrap = BTRxStrapr.Code;
														end else begin
															// GIr.BPIStrap = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxStrapr.Code = "STRP99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxStrapr,1,TrHs)) begin
																// OldCode = BTRxStrapr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxStrapr);
															// recordnew(BTRxStrapr);
															// if(blank(OldCode))then begin OldCode = "STRP00000"; end;
															// NextCode(OldCode,BTRxStrapr.Code);
															// BTRxStrapr.Name = params[i];
															// recordinsert(BTRxStrapr,true);
															// recordupdate(BTRxStrapr,BTRxStrapr,true);
															// GIr.BPIStrap = BTRxStrapr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"StClolor":		if(blank(params[i]))then begin
													GIr.BTRxStrapColour = "";
												end else begin
													BTRxColorr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxColorr,1,true))then begin
														GIr.BTRxStrapColour = BTRxColorr.Code;
													end else begin
														BTRxColorr.Code = params[i];
														if(readfirstmain(BTRxColorr,1,true))then begin
															GIr.BTRxStrapColour = BTRxColorr.Code;
														end else begin
															// GIr.BTRxStrapColour = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxColorr.Code = "CL99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxColorr,1,TrHs)) begin
																// OldCode = BTRxColorr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxColorr);
															// recordnew(BTRxColorr);
															// if(blank(OldCode))then begin OldCode = "CL00000"; end;
															// NextCode(OldCode,BTRxColorr.Code);
															// BTRxColorr.Name = params[i];
															// recordinsert(BTRxColorr,true);
															// recordupdate(BTRxColorr,BTRxColorr,true);
															// GIr.BTRxStrapColour = BTRxColorr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Com1":				if(blank(params[i]))then begin
													GIr.BTRxWatchGradeA = "";
												end else begin
													BtrxWatchGrader.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxWatchGrader,1,true))then begin
														GIr.BTRxWatchGradeA = BtrxWatchGrader.Code;
													end else begin
														BtrxWatchGrader.Code = params[i];
														if(readfirstmain(BtrxWatchGrader,1,true))then begin
															GIr.BTRxWatchGradeA = BtrxWatchGrader.Code;
														end else begin
															// GIr.BTRxWatchGradeA = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxWatchGrader.Code = "WTGRD9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatchGrader,1,TrHs)) begin
																// OldCode = BtrxWatchGrader.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatchGrader);
															// recordnew(BtrxWatchGrader);
															// if(blank(OldCode))then begin OldCode = "WTGRD0000"; end;
															// NextCode(OldCode,BtrxWatchGrader.Code);
															// BtrxWatchGrader.Name = params[i];
															// recordinsert(BtrxWatchGrader,true);
															// recordupdate(BtrxWatchGrader,BtrxWatchGrader,true);
															// GIr.BTRxWatchGradeA = BtrxWatchGrader.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Com2":				if(blank(params[i]))then begin
													GIr.BTRxWatchGradeB = "";
												end else begin
													BtrxWatchGrader.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxWatchGrader,1,true))then begin
														GIr.BTRxWatchGradeB = BtrxWatchGrader.Code;
													end else begin
														BtrxWatchGrader.Code = params[i];
														if(readfirstmain(BtrxWatchGrader,1,true))then begin
															GIr.BTRxWatchGradeB = BtrxWatchGrader.Code;
														end else begin
															// GIr.BTRxWatchGradeB = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxWatchGrader.Code = "WTGRD9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatchGrader,1,TrHs)) begin
																// OldCode = BtrxWatchGrader.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatchGrader);
															// recordnew(BtrxWatchGrader);
															// if(blank(OldCode))then begin OldCode = "WTGRD0000"; end;
															// NextCode(OldCode,BtrxWatchGrader.Code);
															// BtrxWatchGrader.Name = params[i];
															// recordinsert(BtrxWatchGrader,true);
															// recordupdate(BtrxWatchGrader,BtrxWatchGrader,true);
															// GIr.BTRxWatchGradeB = BtrxWatchGrader.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Com3":				if(blank(params[i]))then begin
													GIr.BTRxWatchGradeC = "";
												end else begin
													BtrxWatchGrader.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxWatchGrader,1,true))then begin
														GIr.BTRxWatchGradeC = BtrxWatchGrader.Code;
													end else begin
														BtrxWatchGrader.Code = params[i];
														if(readfirstmain(BtrxWatchGrader,1,true))then begin
															GIr.BTRxWatchGradeC = BtrxWatchGrader.Code;
														end else begin
															// GIr.BTRxWatchGradeC = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxWatchGrader.Code = "WTGRD9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatchGrader,1,TrHs)) begin
																// OldCode = BtrxWatchGrader.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatchGrader);
															// recordnew(BtrxWatchGrader);
															// if(blank(OldCode))then begin OldCode = "WTGRD0000"; end;
															// NextCode(OldCode,BtrxWatchGrader.Code);
															// BtrxWatchGrader.Name = params[i];
															// recordinsert(BtrxWatchGrader,true);
															// recordupdate(BtrxWatchGrader,BtrxWatchGrader,true);
															// GIr.BTRxWatchGradeC = BtrxWatchGrader.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Stone1":			if(blank(params[i]))then begin
													GIr.BTRxStoneA = "";
												end else begin
													BTRxStoner.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxStoner,1,true))then begin
														GIr.BTRxStoneA = BTRxStoner.Code;
													end else begin
														BTRxStoner.Code = params[i];
														if(readfirstmain(BTRxStoner,1,true))then begin
															GIr.BTRxStoneA = BTRxStoner.Code;
														end else begin
															// GIr.BTRxStoneA = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxStoner.Code = "STN99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxStoner,1,TrHs)) begin
																// OldCode = BTRxStoner.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxStoner);
															// recordnew(BTRxStoner);
															// if(blank(OldCode))then begin OldCode = "STN00000"; end;
															// NextCode(OldCode,BTRxStoner.Code);
															// BTRxStoner.Name = params[i];
															// recordinsert(BTRxStoner,true);
															// recordupdate(BTRxStoner,BTRxStoner,true);
															// GIr.BTRxStoneA = BTRxStoner.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Carat1":			GIr.BTRxStoneScattA = stringtoval(params[i],m4val);
			case"Stone2":			if(blank(params[i]))then begin
													GIr.BTRxStoneB = "";
												end else begin
													BTRxStoner.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxStoner,1,true))then begin
														GIr.BTRxStoneB = BTRxStoner.Code;
													end else begin
														BTRxStoner.Code = params[i];
														if(readfirstmain(BTRxStoner,1,true))then begin
															GIr.BTRxStoneB = BTRxStoner.Code;
														end else begin
															// GIr.BTRxStoneB = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxStoner.Code = "STN99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxStoner,1,TrHs)) begin
																// OldCode = BTRxStoner.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxStoner);
															// recordnew(BTRxStoner);
															// if(blank(OldCode))then begin OldCode = "STN00000"; end;
															// NextCode(OldCode,BTRxStoner.Code);
															// BTRxStoner.Name = params[i];
															// recordinsert(BTRxStoner,true);
															// recordupdate(BTRxStoner,BTRxStoner,true);
															// GIr.BTRxStoneB = BTRxStoner.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Carat2":			GIr.BTRxStoneScattB = stringtoval(params[i],m4val);
			case"Stone3":			if(blank(params[i]))then begin
													GIr.BTRxStoneC = "";
												end else begin
													BTRxStoner.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxStoner,1,true))then begin
														GIr.BTRxStoneC = BTRxStoner.Code;
													end else begin
														BTRxStoner.Code = params[i];
														if(readfirstmain(BTRxStoner,1,true))then begin
															GIr.BTRxStoneC = BTRxStoner.Code;
														end else begin
															// GIr.BTRxStoneC = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxStoner.Code = "STN99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxStoner,1,TrHs)) begin
																// OldCode = BTRxStoner.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxStoner);
															// recordnew(BTRxStoner);
															// if(blank(OldCode))then begin OldCode = "STN00000"; end;
															// NextCode(OldCode,BTRxStoner.Code);
															// BTRxStoner.Name = params[i];
															// recordinsert(BTRxStoner,true);
															// recordupdate(BTRxStoner,BTRxStoner,true);
															// GIr.BTRxStoneC = BTRxStoner.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Carat3":			GIr.BTRxStoneScattC = stringtoval(params[i],m4val);
			case"AllCarat":		GIr.BTRxPlacerScatt = stringtoval(params[i],m4val);
											
			case"Color":			if(blank(params[i]))then begin
													GIr.BPIColor = "";
												end else begin
													BTRxColorr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxColorr,1,true))then begin
														GIr.BPIColor = BTRxColorr.Code;
													end else begin
														BTRxColorr.Code = params[i];
														if(readfirstmain(BTRxColorr,1,true))then begin
															GIr.BPIColor = BTRxColorr.Code;
														end else begin
															// GIr.BPIColor = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxColorr.Code = "CL99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxColorr,1,TrHs)) begin
																// OldCode = BTRxColorr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxColorr);
															// recordnew(BTRxColorr);
															// if(blank(OldCode))then begin OldCode = "CL00000"; end;
															// NextCode(OldCode,BTRxColorr.Code);
															// BTRxColorr.Name = params[i];
															// recordinsert(BTRxColorr,true);
															// recordupdate(BTRxColorr,BTRxColorr,true);
															// GIr.BPIColor = BTRxColorr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Odour":			if(blank(params[i]))then begin
													GIr.BPIOdour = "";
												end else begin
													BTRxOdourr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxOdourr,1,true))then begin
														GIr.BPIOdour = BTRxOdourr.Code;
													end else begin
														BTRxOdourr.Code = params[i];
														if(readfirstmain(BTRxOdourr,1,true))then begin
															GIr.BPIOdour = BTRxOdourr.Code;
														end else begin
															// GIr.BPIOdour = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxOdourr.Code = "ODR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxOdourr,1,TrHs)) begin
																// OldCode = BTRxOdourr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxOdourr);
															// recordnew(BTRxOdourr);
															// if(blank(OldCode))then begin OldCode = "ODR00000"; end;
															// NextCode(OldCode,BTRxOdourr.Code);
															// BTRxOdourr.Name = params[i];
															// recordinsert(BTRxOdourr,true);
															// recordupdate(BTRxOdourr,BTRxOdourr,true);
															// GIr.BPIOdour = BTRxOdourr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Phone":			if(blank(params[i]))then begin
													GIr.BTRxPhoneModel = "";
												end else begin
													BtrxPhoneModelr.Name = params[i];
													if(readfirstkey("Name",BtrxPhoneModelr,1,true))then begin
														GIr.BTRxPhoneModel = BtrxPhoneModelr.Code;
													end else begin
														BtrxPhoneModelr.Code = trim(params[i]);
														if(readfirstmain(BtrxPhoneModelr,1,true))then begin
															GIr.BTRxPhoneModel = BtrxPhoneModelr.Code;
														end else begin
															// GIr.BTRxPhoneModel = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxPhoneModelr.Code = "PHMOD9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxPhoneModelr,1,TrHs)) begin
																// OldCode = BtrxPhoneModelr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxPhoneModelr);
															// recordnew(BtrxPhoneModelr);
															// if(blank(OldCode))then begin OldCode = "PHMOD0000"; end;
															// NextCode(OldCode,BtrxPhoneModelr.Code);
															// BtrxPhoneModelr.Name = params[i];
															// recordinsert(BtrxPhoneModelr,true);
															// recordupdate(BtrxPhoneModelr,BtrxPhoneModelr,true);
															// GIr.BTRxPhoneModel = BtrxPhoneModelr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"ChaninMat":	if(blank(params[i]))then begin
													GIr.BTRxChainMaterial = "";
												end else begin
													BTRxMaterialr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
														GIr.BTRxChainMaterial = BTRxMaterialr.Code;
													end else begin
														BTRxMaterialr.Code = params[i];
														if(readfirstmain(BTRxMaterialr,1,true))then begin
															GIr.BTRxChainMaterial = BTRxMaterialr.Code;
														end else begin
															// GIr.BTRxChainMaterial = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxMaterialr.Code = "MATR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxMaterialr,1,TrHs)) begin
																// OldCode = BTRxMaterialr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxMaterialr);
															// recordnew(BTRxMaterialr);
															// if(blank(OldCode))then begin OldCode = "MATR00000"; end;
															// NextCode(OldCode,BTRxMaterialr.Code);
															// BTRxMaterialr.Name = params[i];
															// recordinsert(BTRxMaterialr,true);
															// recordupdate(BTRxMaterialr,BTRxMaterialr,true);
															// GIr.BTRxChainMaterial = BTRxMaterialr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Fill":				if(blank(params[i]))then begin
													GIr.BTRxFilling = "";
												end else begin
													BtrxFillingr.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxFillingr,1,true))then begin
														GIr.BTRxFilling = BtrxFillingr.Code;
													end else begin
														BtrxFillingr.Code = params[i];
														if(readfirstmain(BtrxFillingr,1,true))then begin
															GIr.BTRxFilling = BtrxFillingr.Code;
														end else begin
															// GIr.BTRxFilling = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxFillingr.Code = "FILLN9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxFillingr,1,TrHs)) begin
																// OldCode = BtrxFillingr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxFillingr);
															// recordnew(BtrxFillingr);
															// if(blank(OldCode))then begin OldCode = "FILLN0000"; end;
															// NextCode(OldCode,BtrxFillingr.Code);
															// BtrxFillingr.Name = params[i];
															// recordinsert(BtrxFillingr,true);
															// recordupdate(BtrxFillingr,BtrxFillingr,true);
															// GIr.BTRxFilling = BtrxFillingr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"WaterRes":		if(blank(params[i]))then begin
													GIr.BTRxWatterRes = "";
												end else begin
													BtrxWatResr.Name = trim(params[i]);
													if(readfirstkey("Name",BtrxWatResr,1,true))then begin
														GIr.BTRxWatterRes = BtrxWatResr.Code;
													end else begin
														BtrxWatResr.Code = params[i];
														if(readfirstmain(BtrxWatResr,1,true))then begin
															GIr.BTRxWatterRes = BtrxWatResr.Code;
														end else begin
															// GIr.BTRxWatterRes = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BtrxWatResr.Code = "WTRS9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatResr,1,TrHs)) begin
																// OldCode = BtrxWatResr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatResr);
															// recordnew(BtrxWatResr);
															// if(blank(OldCode))then begin OldCode = "WTRS0000"; end;
															// NextCode(OldCode,BtrxWatResr.Code);
															// BtrxWatResr.Name = params[i];
															// recordinsert(BtrxWatResr,true);
															// recordupdate(BtrxWatResr,BtrxWatResr,true);
															// GIr.BTRxWatterRes = BtrxWatResr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"StrapMat":		if(blank(params[i]))then begin
													GIr.BTRxStrapMat = "";
												end else begin
													BTRxMaterialr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
														GIr.BTRxStrapMat = BTRxMaterialr.Code;
													end else begin
														BTRxMaterialr.Code = params[i];
														if(readfirstmain(BTRxMaterialr,1,true))then begin
															GIr.BTRxStrapMat = BTRxMaterialr.Code;
														end else begin
															// GIr.BTRxStrapMat = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxMaterialr.Code = "MATR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxMaterialr,1,TrHs)) begin
																// OldCode = BTRxMaterialr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxMaterialr);
															// recordnew(BTRxMaterialr);
															// if(blank(OldCode))then begin OldCode = "MATR00000"; end;
															// NextCode(OldCode,BTRxMaterialr.Code);
															// BTRxMaterialr.Name = params[i];
															// recordinsert(BTRxMaterialr,true);
															// recordupdate(BTRxMaterialr,BTRxMaterialr,true);
															// GIr.BTRxStrapMat = BTRxMaterialr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"BracelMat":		if(blank(params[i]))then begin
													GIr.BTRxBracelMat = "";
												end else begin
													BTRxMaterialr.Name = trim(params[i]);
													if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
														GIr.BTRxBracelMat = BTRxMaterialr.Code;
													end else begin
														BTRxMaterialr.Code = params[i];
														if(readfirstmain(BTRxMaterialr,1,true))then begin
															GIr.BTRxBracelMat = BTRxMaterialr.Code;
														end else begin
															// GIr.BTRxBracelMat = "";
															// ErrAr[ErrCnt] = param & ": " & params[i];
															// ErrAr2[ErrCnt] = param & chr(09) & params[i];
															// ErrCnt = ErrCnt + 1;
															// BTRxMaterialr.Code = "MATR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxMaterialr,1,TrHs)) begin
																// OldCode = BTRxMaterialr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxMaterialr);
															// recordnew(BTRxMaterialr);
															// if(blank(OldCode))then begin OldCode = "MATR00000"; end;
															// NextCode(OldCode,BTRxMaterialr.Code);
															// BTRxMaterialr.Name = params[i];
															// recordinsert(BTRxMaterialr,true);
															// recordupdate(BTRxMaterialr,BTRxMaterialr,true);
															// GIr.BTRxBracelMat = BTRxMaterialr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
				case"Collection":		if(blank(params[i]))then begin
															GIr.BtrxCollection = "";
														end else begin
															BtrxCollectionr.Name = trim(params[i]);
															if(readfirstkey("Name",BtrxCollectionr,1,true))then begin
																GIr.BtrxCollection = BtrxCollectionr.Code;
															end else begin
																BtrxCollectionr.Code = params[i];
																if(readfirstmain(BtrxCollectionr,1,true))then begin
																	GIr.BtrxCollection = BtrxCollectionr.Code;
																end else begin
																	// GIr.BTRxBracelMat = "";
																	// ErrAr[ErrCnt] = param & ": " & params[i];
																	// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																	// ErrCnt = ErrCnt + 1;
																	// BtrxCollectionr.Code = "COLL9999";
																	// TrHs = true;
																	// while (LoopBackKey("Code",BtrxCollectionr,1,TrHs)) begin
																		// OldCode = BtrxCollectionr.Code;
																		// TrHs = false;
																	// end;
																	// ResetLoop(BtrxCollectionr);
																	// recordnew(BtrxCollectionr);
																	// if(blank(OldCode))then begin OldCode = "COLL0000"; end;
																	// NextCode(OldCode,BtrxCollectionr.Code);
																	// BtrxCollectionr.Name = params[i];
																	// recordinsert(BtrxCollectionr,true);
																	// recordupdate(BtrxCollectionr,BtrxCollectionr,true);
																	// GIr.BtrxCollection = BtrxCollectionr.Code;
																	// res = true;
																	// OldCode = "";
																end;
															end;
														end;
				case"ClockFaceColour":	if(blank(params[i]))then begin
																	GIr.BtrxClockFaceColour = "";
																end else begin
																	BTRxColorr.Name = trim(params[i]);
																	if(readfirstkey("Name",BTRxColorr,1,true))then begin
																		GIr.BtrxClockFaceColour = BTRxColorr.Code;
																	end else begin
																		BTRxColorr.Code = params[i];
																		if(readfirstmain(BTRxColorr,1,true))then begin
																			GIr.BtrxClockFaceColour = BTRxColorr.Code;
																		end else begin
																			// GIr.BTRxBracelMat = "";
																			// ErrAr[ErrCnt] = param & ": " & params[i];
																			// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																			// ErrCnt = ErrCnt + 1;
																			// BTRxColorr.Code = "CL99999";
																			// TrHs = true;
																			// while (LoopBackKey("Code",BTRxColorr,1,TrHs)) begin
																				// OldCode = BTRxColorr.Code;
																				// TrHs = false;
																			// end;
																			// ResetLoop(BTRxColorr);
																			// recordnew(BTRxColorr);
																			// if(blank(OldCode))then begin OldCode = "CL00000"; end;
																			// NextCode(OldCode,BTRxColorr.Code);
																			// BTRxColorr.Name = params[i];
																			// recordinsert(BTRxColorr,true);
																			// recordupdate(BTRxColorr,BTRxColorr,true);
																			// GIr.BtrxClockFaceColour = BTRxColorr.Code;
																			// res = true;
																			// OldCode = "";
																		end;
																	end;
																end;
																
				case"Complications":	if(blank(params[i]))then begin
																	GIr.BtrxComplications = "";
																end else begin
																	BtrxComplicationsr.Name = trim(params[i]);
																	if(readfirstkey("Name",BtrxComplicationsr,1,true))then begin
																		GIr.BtrxComplications = BtrxComplicationsr.Code;
																	end else begin
																		BtrxComplicationsr.Code = params[i];
																		if(readfirstmain(BtrxComplicationsr,1,true))then begin
																			GIr.BtrxComplications = BtrxComplicationsr.Code;
																		end else begin
																			// GIr.BTRxBracelMat = "";
																			// ErrAr[ErrCnt] = param & ": " & params[i];
																			// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																			// ErrCnt = ErrCnt + 1;
																			// BtrxComplicationsr.Code = "CMP99999";
																			// TrHs = true;
																			// while (LoopBackKey("Code",BtrxComplicationsr,1,TrHs)) begin
																				// OldCode = BtrxComplicationsr.Code;
																				// TrHs = false;
																			// end;
																			// ResetLoop(BtrxComplicationsr);
																			// recordnew(BtrxComplicationsr);
																			// if(blank(OldCode))then begin OldCode = "CMP00000"; end;
																			// NextCode(OldCode,newCode);
																			// BtrxComplicationsr.Name = params[i];
																			// BtrxComplicationsr.Code = newCode;
																			// recordinsert(BtrxComplicationsr,true);
																			// recordupdate(BtrxComplicationsr,BtrxComplicationsr,true);
																			// GIr.BtrxComplications = BtrxComplicationsr.Code;
																			// res = true;
																			// OldCode = "";
																		end;
																	end;
																end;
				case"ClockFaceMaterial":	if(blank(params[i]))then begin
																	GIr.BtrxClockFaceMaterial = "";
																end else begin
																	BTRxMaterialr.Name = trim(params[i]);
																	if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
																		GIr.BtrxClockFaceMaterial = BTRxMaterialr.Code;
																	end else begin
																		BTRxMaterialr.Code = params[i];
																		if(readfirstmain(BTRxMaterialr,1,true))then begin
																			GIr.BtrxClockFaceMaterial = BTRxMaterialr.Code;
																		end else begin
																			// GIr.BTRxBracelMat = "";
																			// ErrAr[ErrCnt] = param & ": " & params[i];
																			// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																			// ErrCnt = ErrCnt + 1;
																			// BTRxMaterialr.Code = "MATR99999";
																			// TrHs = true;
																			// while (LoopBackKey("Code",BTRxMaterialr,1,TrHs)) begin
																				// OldCode = BTRxMaterialr.Code;
																				// TrHs = false;
																			// end;
																			// ResetLoop(BTRxMaterialr);
																			// recordnew(BTRxMaterialr);
																			// if(blank(OldCode))then begin OldCode = "MATR00000"; end;
																			// NextCode(OldCode,BTRxMaterialr.Code);
																			// BTRxMaterialr.Name = params[i];
																			// recordinsert(BTRxMaterialr,true);
																			// recordupdate(BTRxMaterialr,BTRxMaterialr,true);
																			// GIr.BtrxClockFaceMaterial = BTRxMaterialr.Code;
																			// res = true;
																			// OldCode = "";
																		end;
																	end;
																end;
				case"MicrowaveProtect":	if(blank(params[i]))then begin
																	GIr.BtrxMicrowaveProtect = "";
																end else begin
																	BtrxMicrowaveProtectr.Name = trim(params[i]);
																	if(readfirstkey("Name",BtrxMicrowaveProtectr,1,true))then begin
																		GIr.BtrxMicrowaveProtect = BtrxMicrowaveProtectr.Code;
																	end else begin
																		BtrxMicrowaveProtectr.Code = params[i];
																		if(readfirstmain(BtrxMicrowaveProtectr,1,true))then begin
																			GIr.BtrxMicrowaveProtect = BtrxMicrowaveProtectr.Code;
																		end else begin
																			// GIr.BTRxBracelMat = "";
																			// ErrAr[ErrCnt] = param & ": " & params[i];
																			// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																			// ErrCnt = ErrCnt + 1;
																			// BtrxMicrowaveProtectr.Code = "MPR99999";
																			// TrHs = true;
																			// while (LoopBackKey("Code",BtrxMicrowaveProtectr,1,TrHs)) begin
																				// OldCode = BtrxMicrowaveProtectr.Code;
																				// TrHs = false;
																			// end;
																			// ResetLoop(BtrxMicrowaveProtectr);
																			// recordnew(BtrxMicrowaveProtectr);
																			// if(blank(OldCode))then begin OldCode = "MPR00000"; end;
																			// NextCode(OldCode,BtrxMicrowaveProtectr.Code);
																			// BtrxMicrowaveProtectr.Name = params[i];
																			// recordinsert(BtrxMicrowaveProtectr,true);
																			// recordupdate(BtrxMicrowaveProtectr,BtrxMicrowaveProtectr,true);
																			// GIr.BtrxMicrowaveProtect = BtrxMicrowaveProtectr.Code;
																			// res = true;
																			// OldCode = "";
																		end;
																	end;
																end;
				case"StoveCompat":			if(blank(params[i]))then begin
																	GIr.BtrxStoveCompat = "";
																end else begin
																	BtrxStoveCompatr.Name = trim(params[i]);
																	if(readfirstkey("Name",BtrxStoveCompatr,1,true))then begin
																		GIr.BtrxStoveCompat = BtrxStoveCompatr.Code;
																	end else begin
																		BtrxStoveCompatr.Code = params[i];
																		if(readfirstmain(BtrxStoveCompatr,1,true))then begin
																			GIr.BtrxStoveCompat = BtrxStoveCompatr.Code;
																		end else begin
																			// GIr.BTRxBracelMat = "";
																			// ErrAr[ErrCnt] = param & ": " & params[i];
																			// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																			// ErrCnt = ErrCnt + 1;
																			// BtrxStoveCompatr.Code = "STC99999";
																			// TrHs = true;
																			// while (LoopBackKey("Code",BtrxStoveCompatr,1,TrHs)) begin
																				// OldCode = BtrxStoveCompatr.Code;
																				// TrHs = false;
																			// end;
																			// ResetLoop(BtrxStoveCompatr);
																			// recordnew(BtrxStoveCompatr);
																			// if(blank(OldCode))then begin OldCode = "STC00000"; end;
																			// NextCode(OldCode,BtrxStoveCompatr.Code);
																			// BtrxStoveCompatr.Name = params[i];
																			// recordinsert(BtrxStoveCompatr,true);
																			// recordupdate(BtrxStoveCompatr,BtrxStoveCompatr,true);
																			// GIr.BtrxStoveCompat = BtrxStoveCompatr.Code;
																			// res = true;
																			// OldCode = "";
																		end;
																	end;
																end;
				case"AllMaterials":			if(blank(params[i]))then begin
																	GIr.BtrxAllMaterials = "";
																end else begin
																	BtrxAllMaterialsr.Name = trim(params[i]);
																	if(readfirstkey("Name",BtrxAllMaterialsr,1,true))then begin
																		GIr.BtrxAllMaterials = BtrxAllMaterialsr.Code;
																	end else begin
																		BtrxAllMaterialsr.Code = params[i];
																		if(readfirstmain(BtrxAllMaterialsr,1,true))then begin
																			GIr.BtrxAllMaterials = BtrxAllMaterialsr.Code;
																		end else begin
																			// GIr.BTRxBracelMat = "";
																			// ErrAr[ErrCnt] = param & ": " & params[i];
																			// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																			// ErrCnt = ErrCnt + 1;
																			// BtrxAllMaterialsr.Code = "AM999999";
																			// TrHs = true;
																			// while (LoopBackKey("Code",BtrxAllMaterialsr,1,TrHs)) begin
																				// OldCode = BtrxAllMaterialsr.Code;
																				// TrHs = false;
																			// end;
																			// ResetLoop(BtrxAllMaterialsr);
																			// recordnew(BtrxAllMaterialsr);
																			// if(blank(OldCode))then begin OldCode = "AM000000"; end;
																			// NextCode(OldCode,BtrxAllMaterialsr.Code);
																			// BtrxAllMaterialsr.Name = params[i];
																			// recordinsert(BtrxAllMaterialsr,true);
																			// recordupdate(BtrxAllMaterialsr,BtrxAllMaterialsr,true);
																			// GIr.BtrxAllMaterials = BtrxAllMaterialsr.Code;
																			// res = true;
																			// OldCode = "";
																		end;
																	end;
																end;
				case"MetalCont":			if(blank(params[i]))then begin
																	GIr.BtrxPrecMetalCont = "";
																end else begin
																	BtrxPrecMetalContr.Name = trim(params[i]);
																	if(readfirstkey("Name",BtrxPrecMetalContr,1,true))then begin
																		GIr.BtrxPrecMetalCont = BtrxPrecMetalContr.Code;
																	end else begin
																		BtrxPrecMetalContr.Code = params[i];
																		if(readfirstmain(BtrxPrecMetalContr,1,true))then begin
																			GIr.BtrxPrecMetalCont = BtrxPrecMetalContr.Code;
																		end else begin
																			// GIr.BTRxBracelMat = "";
																			// ErrAr[ErrCnt] = param & ": " & params[i];
																			// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																			// ErrCnt = ErrCnt + 1;
																			// BtrxPrecMetalContr.Code = "PMC99999";
																			// TrHs = true;
																			// while (LoopBackKey("Code",BtrxPrecMetalContr,1,TrHs)) begin
																				// OldCode = BtrxPrecMetalContr.Code;
																				// TrHs = false;
																			// end;
																			// ResetLoop(BtrxPrecMetalContr);
																			// recordnew(BtrxPrecMetalContr);
																			// if(blank(OldCode))then begin OldCode = "PMC00000"; end;
																			// NextCode(OldCode,BtrxPrecMetalContr.Code);
																			// BtrxPrecMetalContr.Name = params[i];
																			// recordinsert(BtrxPrecMetalContr,true);
																			// recordupdate(BtrxPrecMetalContr,BtrxPrecMetalContr,true);
																			// GIr.BtrxPrecMetalCont = BtrxPrecMetalContr.Code;
																			// res = true;
																			// OldCode = "";
																		end;
																	end;
																end;
				case"CaseDiam":			if(blank(params[i]))then begin
																	GIr.BtrxCaseDiam = "";
																end else begin
																	BtrxCaseDiamr.Name = trim(params[i]);
																	if(readfirstkey("Name",BtrxCaseDiamr,1,true))then begin
																		GIr.BtrxCaseDiam = BtrxCaseDiamr.Code;
																	end else begin
																		BtrxCaseDiamr.Code = params[i];
																		if(readfirstmain(BtrxCaseDiamr,1,true))then begin
																			GIr.BtrxCaseDiam = BtrxCaseDiamr.Code;
																		end else begin
																			// GIr.BTRxBracelMat = "";
																			// ErrAr[ErrCnt] = param & ": " & params[i];
																			// ErrAr2[ErrCnt] = param & chr(09) & params[i];
																			// ErrCnt = ErrCnt + 1;
																			// BtrxCaseDiamr.Code = "CD999999";
																			// TrHs = true;
																			// while (LoopBackKey("Code",BtrxCaseDiamr,1,TrHs)) begin
																				// OldCode = BtrxCaseDiamr.Code;
																				// TrHs = false;
																			// end;
																			// ResetLoop(BtrxCaseDiamr);
																			// recordnew(BtrxCaseDiamr);
																			// if(blank(OldCode))then begin OldCode = "CD000000"; end;
																			// NextCode(OldCode,BtrxCaseDiamr.Code);
																			// BtrxCaseDiamr.Name = params[i];
																			// recordinsert(BtrxCaseDiamr,true);
																			// recordupdate(BtrxCaseDiamr,BtrxCaseDiamr,true);
																			// GIr.BtrxCaseDiam = BtrxCaseDiamr.Code;
																			// res = true;
																			// OldCode = "";
																		end;
																	end;
																end;
				// case"PF1":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF10":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF11":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF2":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF3":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF4":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF5":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF6":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF7":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF8":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PF9":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PG1":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PG2":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PG3":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO1":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO10":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO11":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO12":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO2":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO3":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO4":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO5":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO6":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO7":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO8":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				// case"PO9":		if(nonblank(params[i]))then begin
												// if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													// if(nonblank(GIr.BTRxThirdLevCat))then begin
														// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													// end;
													// GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												// end;
												// if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													// if(nonblank(GIr.BTRxGiftClass))then begin
														// GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													// end;
													// GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												// end;
											// end;
				
				otherwise 
											ErrAr[ErrCnt] = USetStr(36352) & " \"" & param & "\" " & ": " & params[i];
											ErrAr2[ErrCnt] = param & chr(09) & params[i];
											ErrCnt = ErrCnt + 1;
end;
	end;
	TPSetItemBitrixClass = res;
return;
end;










global updating function LongInt CheckClassifGlblImprt(array string headers,array string params,var record INVc INr)
begin

	LongInt res;
  row NewINVc newINrw;
	record INVc OldINr,tmpINr,OldConsINr;
	record NewINVc OthCompnewINr;
  record INVc IN2r,INConsr,IN3r;
	record NewINVc newINr2;
  record ITVc ITr;
  integer mtrw,i,insertmode,updatemode,j; //Edit***************************Sasha2,17:50 07.12.2015
  string 20 codestring;
	string 100 lastSerNr,newSerNr;
  LongInt stat1,long41;
  string 200 rawclass,uloc,group;
  integer pos,rwcnt, t,tcnt,oldComp,CompQty,k;
  record DIVc DIr;
  boolean upd,insertDispNameNotCode,TrHs,TrHs1,testf;
  record DiCheckBlock DiCb; //Edit***************************Sasha2,16:52 07.12.2015
  row DiCheckBlock DiCbw; //Edit***************************Sasha2,16:52 07.12.2015
  vector string 255 diCheckTypes; //Edit***************************Sasha2,17:22 07.12.2015
  string 255 newdispstr,foundtypes,outdisps,mes; //Edit***************************Sasha2,17:37 07.12.2015
  string 20 type; //Edit***************************Sasha2,10:34 08.12.2015
  boolean NewValidClassif;
	record NewClassSetVc NCSr;
	row NewClassSetVc NCSrw;
	record BPIBrandVc Brandr;
	record BPICollectionVc Collectr;
	record BPIGroupVc Groupr;
	record BPISubGroupVc SGroupr;
	vector string 255 vclassification, vclassificationfield;
	vector boolean vclasstipecode, AllSetTypes;
	record NewClassifChBlock NCCHb;	
	array string 100 aTipeClass;
	record BPICategoryVc BPICategoryr;
	record BPIMaterialVc BPIMaterialr;
	record BPIColorVc BPIColorr;
	record BPIShapeVc BPIShaper;
	record BPISizeVc BPISizer;
	record BPIUseVc BPIUser;
	record BPISexVc BPISexr;
	record BPIPlatingVc BPIPlatingr;
	record BPIClarityVc BPIClarityr;
	record BPIWeightVc BPIWeightr;
	record BPICutVc BPICutr;
	record BPIStoneVc BPIStoner;
	record BPIStrapVc BPIStrapr;
	record BPIOdourVc BPIOdourr;
	record ConsCompBlock CCB;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	Array string 255 astr;
  Integer acnt,strlen,y;
	record IdINSNOneBlock IINSNOb;
	row IdINSNOneBlock IINSNOrw;
	string 255 SNOneNumber, param;
	val SNMiddleval;
	boolean Catef,TrHs2;
	array string 100 asnt;
	integer check,curcomp;
	record ConsItemVc CI2r,CIr;



	
	for (i=0;i<headers.length;i=i+1) begin
		param = headers[i];
		params[i] = trim(params[i]);
		if(nonblank(params[i]))then begin
			switch(param)begin
				case"Collection": 	
													Collectr.Name = params[i];
													if(ReadFirstKey("Name",Collectr,1,true))then begin
														INr.BPICollection = Collectr.Code;
													end else begin
														res = 1;
													end;
				case"Group":
													Groupr.Name = params[i];
													if(ReadFirstKey("Name",Groupr,1,true))then begin
														INr.BPIGroup = Groupr.Code;
													end else begin
														res = 2;
													end;
				case"Sub-Group":
													SGroupr.Name = params[i];
													if(ReadFirstKey("Name",SGroupr,1,true))then begin
														INr.BPISubGroup = SGroupr.Code;
													end else begin
														res = 3;
													end;
				case"Category":
													BPICategoryr.Name = params[i];
													if(ReadFirstKey("Name",BPICategoryr,1,true))then begin
														INr.BPICategory = BPICategoryr.Code;
													end else begin
														res = 4;
													end;
				case"Material":
													BPIMaterialr.Name = params[i];
													if(ReadFirstKey("Name",BPIMaterialr,1,true))then begin
														INr.BPIMaterial = BPIMaterialr.Code;
													end else begin
														res = 5;
													end;
				case"Color":
													BPIColorr.Name = params[i];
													if(ReadFirstKey("Name",BPIColorr,1,true))then begin
														INr.BPIColor = BPIColorr.Code;
													end else begin
														res = 1;
													end;
				case"Shape":
													BPIShaper.Name = params[i];
													if(ReadFirstKey("Name",BPIShaper,1,true))then begin
														INr.BPIShape = BPIShaper.Code;
													end else begin
														res = 6;
													end;
				case"Size":
													BPISizer.Name = params[i];
													if(ReadFirstKey("Name",BPISizer,1,true))then begin
														INr.BPISize = BPISizer.Code;
													end else begin
														res = 1;
													end;
				case"Use":
													BPIUser.Name = params[i];
													if(ReadFirstKey("Name",BPIUser,1,true))then begin
														INr.BPIUse = BPIUser.Code;
													end else begin
														res = 7;
													end;
				case"Gender":
													BPISexr.Name = params[i];
													if(ReadFirstKey("Name",BPISexr,1,true))then begin
														INr.BPISex = BPISexr.Code;
													end else begin
														res = 8;
													end;
				case"Plating":
													BPIPlatingr.Name = params[i];
													if(ReadFirstKey("Name",BPIPlatingr,1,true))then begin
														INr.BPIPlating = BPIPlatingr.Code;
													end else begin
														
													end;
				case"Weight":
													BPIWeightr.Name = params[i];
													if(ReadFirstKey("Name",BPIWeightr,1,true))then begin
														INr.BPIWeight = BPIWeightr.Code;
													end else begin
														res = 9;
													end;
				case"Cut1":
													BPICutr.Name = params[i];
													if(ReadFirstKey("Name",BPICutr,1,true))then begin
														INr.BPICut = BPICutr.Code;
													end else begin
														res = 10;
													end;
				case"Stone1":
													BPIStoner.Name = params[i];
													if(ReadFirstKey("Name",BPIStoner,1,true))then begin
														INr.BPIStone = BPIStoner.Code;
													end else begin
														res = 11;
													end;
				case"Strap Material":
													BPIStrapr.Name = params[i];
													if(ReadFirstKey("Name",BPIStrapr,1,true))then begin
														INr.BPIStrap = BPIStrapr.Code;
													end else begin
														res = 12;
													end;
				case"Odour":
													BPIOdourr.Name = params[i];
													if(ReadFirstKey("Name",BPIOdourr,1,true))then begin
														INr.BPIOdour = BPIOdourr.Code;
													end else begin
														res = 13;
													end;
				case"Clarity1":
													BPIClarityr.Name = params[i];
													if(ReadFirstKey("Name",BPIClarityr,1,true))then begin
														INr.BPIClarity = BPIClarityr.Code;
													end else begin
														res = 14;
													end;
			end;
		end;
	end;
	
	
	
	t = 0;
	vclassification["BRAND"] = INr.BPIBrand;
	Brandr.Code = INr.BPIBrand;
	if(nonblank(Brandr.Code) and !readfirstmain(Brandr,1,true))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : BRAND",i,"BrandSC");
		// goto LNewINVcRecordCheck;
	end;
	if(nonblank(Brandr.Code) and Brandr.Closed!=0)then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification["BRAND"] & " : BRAND",i,"BrandSC");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t] = "CATEGORY";
	vclassificationfield[aTipeClass[t]] = "Category";
	vclassification["CATEGORY"] = INr.BPICategory;
	BPICategoryr.Code = INr.BPICategory;
	if(nonblank(BPICategoryr.Code) and !readfirstmain(BPICategoryr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : CATEGORY",i,"classif31");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "CLARITY";
	vclassificationfield[aTipeClass[t]] = "Clarity1";
	vclassification["CLARITY"] = INr.BPIClarity;
	BPIClarityr.Code = INr.BPIClarity;
	if(nonblank(BPIClarityr.Code) and !readfirstmain(BPIClarityr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : CLARITY",i,"ClaritySC");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "COLLECT";
	vclassification["COLLECT"] = INr.BPICollection;
	Collectr.Code = INr.BPICollection;
	if(nonblank(Collectr.Code) and !readfirstmain(Collectr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : COLLECT",i,"Collection");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "COLOR";
	vclassificationfield[aTipeClass[t]] = "Color";
	vclassification["COLOR"] = INr.BPIColor;
	BPIColorr.Code = INr.BPIColor;
	if(nonblank(BPIColorr.Code) and !readfirstmain(BPIColorr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : COLOR",i,"Color");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "CUT";
	vclassificationfield[aTipeClass[t]] = "Cut1";
	vclassification["CUT"] = INr.BPICut;
	BPICutr.Code = INr.BPICut;
	if(nonblank(BPICutr.Code) and !readfirstmain(BPICutr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : CUT",i,"CutCl");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "GROUP";
	vclassification["GROUP"] = INr.BPIGroup;
	Groupr.Code = INr.BPIGroup;
	if(nonblank(Groupr.Code) and !readfirstmain(Groupr,1,true))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : GROUP",i,"GroupCl");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "MATERIAL";
	vclassificationfield[aTipeClass[t]] = "Material";
	vclassification["MATERIAL"] = INr.BPIMaterial;
	BPIMaterialr.Code = INr.BPIMaterial;
	if(nonblank(BPIMaterialr.Code) and !readfirstmain(BPIMaterialr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : MATERIAL",i,"Material");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "ODOUR";
	vclassificationfield[aTipeClass[t]] = "Odour";
	vclassification["ODOUR"] = INr.BPIOdour;
	BPIOdourr.Code = INr.BPIOdour;
	if(nonblank(BPIOdourr.Code) and !readfirstmain(BPIOdourr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : ODOUR",i,"OdourCl");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "PLATING";
	vclassificationfield[aTipeClass[t]] = "Plating";
	vclassification["PLATING"] = INr.BPIPlating;
	BPIPlatingr.Code = INr.BPIPlating;
	if(nonblank(BPIPlatingr.Code) and !readfirstmain(BPIPlatingr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : PLATING",i,"PlatingCl");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "SEX";
	vclassificationfield[aTipeClass[t]] = "Gender";
	vclassification["SEX"] = INr.BPISex;
	BPISexr.Code = INr.BPISex;
	if(nonblank(BPISexr.Code) and !readfirstmain(BPISexr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : SEX",i,"SexCl");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "SHAPE";
	vclassificationfield[aTipeClass[t]] = "Shape";
	vclassification["SHAPE"] = INr.BPIShape;
	BPIShaper.Code = INr.BPIShape;
	if(nonblank(BPIShaper.Code) and !readfirstmain(BPIShaper,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : SHAPE",i,"ShapeCut");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "SIZE";
	vclassificationfield[aTipeClass[t]] = "Size";
	vclassification["SIZE"] = INr.BPISize;
	BPISizer.Code = INr.BPISize;
	if(nonblank(BPISizer.Code) and !readfirstmain(BPISizer,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : SIZE",i,"SizeCl");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "STRAP";
	vclassificationfield[aTipeClass[t]] = "Strap Material";
	vclassification["STRAP"] = INr.BPIStrap;
	BPIStrapr.Code = INr.BPIStrap;
	if(nonblank(BPIStrapr.Code) and !readfirstmain(BPIStrapr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : STRAP",i,"Strap");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "STONE";
	vclassificationfield[aTipeClass[t]] = "Stone1";
	vclassification["STONE"] = INr.BPIStone;
	BPIStoner.Code = INr.BPIStone;
	if(nonblank(BPIStoner.Code) and !readfirstmain(BPIStoner,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : STONE",i,"StoneCl");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "WEIGHT";
	vclassificationfield[aTipeClass[t]] = "Weight";
	vclassification["WEIGHT"] = INr.BPIWeight;
	BPIWeightr.Code = INr.BPIWeight;
	if(nonblank(BPIWeightr.Code) and !readfirstmain(BPIWeightr,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : WEIGHT",i,"WeightCl");
		// goto LNewINVcRecordCheck;
	end;
	//aTipeClass[t+=1] = "SUBGROUP";
	vclassificationfield[aTipeClass[t]] = "Sub-Group";
	vclassification["SUBGROUP"] = INr.BPISubGroup;
	SGroupr.Code = INr.BPISubGroup;
	if(nonblank(SGroupr.Code) and !readfirstmain(SGroupr,1,true))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : SUBGROUP",i,"SubGroupCl");
		// goto LNewINVcRecordCheck;
	end;
	aTipeClass[t+=1] = "USE";
	vclassificationfield[aTipeClass[t]] = "Use";
	vclassification["USE"] = INr.BPIUse;
	BPIUser.Code = INr.BPIUse;
	if(nonblank(BPIUser.Code) and !readfirstmain(BPIUser,1,true) and (INr.ConsgType!=3 and INr.ConsgType!=4))then begin
		// res = -1;
		// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "      : USE",i,"UseCl");
		// goto LNewINVcRecordCheck;
	end;
	tcnt = t + 1;
	
	TrHs = true;
	NCSr.Group = "";
	while (loopmain(NCSr,1,TrHs)) begin
		if(NCSr.Type==vclassification["SUBGROUP"])then begin
			rwcnt = matrowcnt(NCSr);
			for (j=0;j<rwcnt;j=j+1)begin
				matrowget(NCSr,j,NCSrw);
				AllSetTypes[NCSrw.CType] = true;
				if(blank(vclassification[NCSrw.CType]))then begin
					// res = -1;
					// RecordCheckError(31228,"  : " & NCSrw.CType & "   !",i,vclassificationfield[NCSrw.CType]);
					// goto LNewINVcRecordCheck;
				end else begin
					vclasstipecode[NCSrw.CType & NCSrw.CCode] = true;
				end;
			end;
			for (j=0;j<rwcnt;j=j+1)begin
				matrowget(NCSr,j,NCSrw);
				if(!vclasstipecode[NCSrw.CType & vclassification[NCSrw.CType]])then begin
					// res = -1;
					// RecordCheckError(31228," " & vclassification[NCSrw.CType] & "     : " & NCSrw.CType,i,vclassificationfield[NCSrw.CType]);
					// goto LNewINVcRecordCheck;
				end;
			end;
			for (j=0;j<rwcnt;j=j+1)begin
				matrowget(NCSr,j,NCSrw);
				vclasstipecode[NCSrw.CType & NCSrw.CCode] = false;
			end;
			TrHs = false;
		end;
	end;
	ResetLoop(NCSr);

	for (t=0;t<tcnt;t=t+1) begin
		if(nonblank(vclassification[aTipeClass[t]]) and AllSetTypes[aTipeClass[t]]==false)then begin
			// res = -1;
			// RecordCheckError(31228," " & vclassification[aTipeClass[t]] & "     : " & aTipeClass[t],i,vclassificationfield[aTipeClass[t]]);
			// goto LNewINVcRecordCheck;
		end;
	end;
	
	CheckClassifGlblImprt = res;
	return;
end;



global updating function string 255 CheckNewRowInCompanies(row newINVc newINrw)
begin
record INVc testINr;
integer wn,CompQty,i,j,oldCompany,qty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
string 255 Company;
BlockLoad(Compb);

oldCompany = currentCompany;
Company = "";
CompQty = matrowcnt(Compb);
for (j=0;j<CompQty;j=j+1)begin
	matrowget(Compb,j,Comprw);
	if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(j+1) or j+1==3) and j+1!=18 and j+1!=33)then begin
		SetCompany(j+1,false);
		testINr.Code = newINrw.VendorCode;
		if(ReadFirstMain(testINr,1,true))then begin
			if(nonblank(Company)) then begin Company= Company & "," & Comprw.ShortName; 
			end else begin Company = Comprw.ShortName; end;
		end;
	end;
end;
SetCompany(oldCompany,false);
CheckNewRowInCompanies = Company;
return;
end;

global updating procedure RepastItemsCodeMn(record RcVc RepSpec)
begin
record PUVc PUr;
row PUVc PUrw;
boolean TrHs;
integer i;
record INVc INr;

TrHs = true;
PUr.TransDate = StringToDate("01/01/10");
while(LoopKey("TransDate",PUr,1,TrHs)) begin
	if(PUr.TransDate > StringToDate("28/01/20")) then begin TrHs = false; end;
	if(TrHs) then begin
		for(i=0;i<matrowcnt(PUr);i=i+1) begin
			matrowget(PUr,i,PUrw);
			INr.Code = PUrw.ArtCode;
			if(ReadFirstMain(INr,1,true)) then begin
				PUrw.VIReconComment = INr.AlternativeCode;
			end;
			matrowput(PUr,i,PUrw);
		end;
		RecordStore(PUr,true);
	end;
end;
end;


global webpublic updating procedure WebChangeDownpaymentAcc()
begin
	record IVVc IVr,oldIVr;
	row IVVc IVrw;
	record TRVc  TRr,oldTRr;
	row TRVc TRrw;
	integer i,rwcnt,trrwcnt,j,dcnt;
	boolean storef,trsoref,TrHs;
	
	setcompany(28,false);
	
	//IVr.SerNr = 2100559;
	TrHs = true;
	while(loopmain(IVr,1,TrHs))begin
		if(IVr.SerNr!=2100559)then begin
			//TrHs = false;
		end;
		if(TrHs	)then begin
			recordcopy(oldIVr,IVr);
			storef = false;
			dcnt = 0;
		
			rwcnt = matrowcnt(IVr);
			for(i=0;i<rwcnt;i=i+1)begin
				matrowget(IVr,i,IVrw);
				if(IVrw.SalesAcc=="46")then begin
					dcnt = dcnt + 1;
				end;
				if(IVrw.stp==kInvoiceRowTypeDownpayment)then begin
					if(IVrw.SalesAcc=="46")then begin
						storef = true;
						IVrw.SalesAcc = "981";
						matrowput(IVr,i,IVrw);
					end;
				end;
			end;
			
			logtext(0,"WebChangeDownpaymentAcc storef " & storef);
			logtext(0,"WebChangeDownpaymentAcc dcnt " & dcnt);
		
			if(storef and dcnt>1)then begin
				
				TRr.Number = IVr.SerNr;
				TRr.IntYc = IVYc;
				if(readfirstmain(TRr,2,true))then begin
					trsoref = false;
					recordcopy(oldTRr,TRr);
					trrwcnt = matrowcnt(TRr);
					//storef = false;
				
					for(i=0;i<rwcnt;i=i+1)begin
						matrowget(oldIVr,i,IVrw);
						if(IVrw.stp==kInvoiceRowTypeDownpayment)then begin
							if(IVrw.SalesAcc=="46")then begin
								logtext(0,"IVrw.Sum " & IVrw.Sum);
								if(IVrw.Sum<0)then begin
									for(j=0;j<trrwcnt;j=j+1)begin
										matrowget(TRr,j,TRrw);
										if(TRrw.AccNumber=="46" and TRrw.CurDebVal==-IVrw.Sum)then begin
											TRrw.AccNumber = "981";
											TRrw.Comment = TRrw.Comment & "(46)";
											trsoref = true;
											matrowput(TRr,j,TRrw);
										end;
									end;
								end;
							end;
						end;
					end;

					if(trsoref)then begin
						if(recordupdate(oldTRr,TRr,true)==0)then begin
							storef = true;
						end;
					end;
				end;
			end;
		
			if(storef and dcnt==1)then begin
				TRr.Number = IVr.SerNr;
				TRr.IntYc = IVYc;
				if(readfirstmain(TRr,2,true))then begin
					//storef = false;
					trsoref = false;
					recordcopy(oldTRr,TRr);
					trrwcnt = matrowcnt(TRr);
					for(j=0;j<trrwcnt;j=j+1)begin
						matrowget(TRr,j,TRrw);
						if(TRrw.AccNumber=="46")then begin
							TRrw.AccNumber = "981";
							TRrw.Comment = TRrw.Comment & "(46)";
							trsoref = true;
							matrowput(TRr,j,TRrw);
						end;
					end;
					if(trsoref)then begin
						if(recordupdate(oldTRr,TRr,true)==0)then begin
							storef = true;
						end;
					end;
				end;
			end;
		
			if(storef and dcnt==1)then begin
				TRr.Number = IVr.SerNr;
				TRr.IntYc = IVYc;
				if(readfirstmain(TRr,2,true))then begin
					//storef = false;
					trsoref = false;
					recordcopy(oldTRr,TRr);
					trrwcnt = matrowcnt(TRr);
					for(j=0;j<trrwcnt;j=j+1)begin
						matrowget(TRr,j,TRrw);
						if(TRrw.AccNumber=="46")then begin
							TRrw.AccNumber = "981";
							trsoref = true;
							matrowput(TRr,j,TRrw);
						end;
					end;
					if(trsoref)then begin
						if(recordupdate(oldTRr,TRr,true)==0)then begin
							storef = true;
						end;
					end;
				end;
			end;
		
			if(storef)then begin
				recordstore(IVr,true);
			end;
		end;
	end;

return;
end;

global webpublic updating procedure WebFixIdeaObjects()
begin
	record IVVc IVr,oldIVr;
	row IVVc IVrw;
	record ORVc ORr;
	row ORVc ORrw;
	record SHVc SHr;
	row SHVc SHrw;
	record INVc INr;
	record ITVc ITr;
	string 255 obj;
	
	record TRVc  TRr,oldTRr;
	row TRVc TRrw;
	integer i,rwcnt,trrwcnt,j,dcnt;
	boolean storef,trsoref,TrHs;
	
	setcompany(28,false);
	
	IVr.SerNr = -1;
	TrHs = true;
	while(loopmain(IVr,1,TrHs))begin
		storef = false;
		rwcnt = matrowcnt(IVr);
		for(i=0;i<rwcnt;i=i+1)begin
			matrowget(IVr,i,IVrw);
			if(IVrw.stp==1)then begin
				if(blank(IVrw.Objects))then begin
					obj = "";
					INr.Code = IVrw.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						obj = INr.Objects;
						ITr.Code = INr.Group;
						if(readfirstmain(ITr,1,true))then begin
							if(nonblank(ITr.Objects))then begin
								obj = AddObjectToObjectList(obj,ITr.Objects);
							end;
						end;
					end;
					if(nonblank(obj))then begin
						IVrw.Objects = obj;
						matrowput(IVr,i,IVrw);
						storef = true;
						obj = "";
					end;
				end;
			end;
		end;
		if(storef)then begin
			recordstore(IVr,true);
		end;
	end;
	
	ORr.SerNr = -1;
	TrHs = true;
	while(loopmain(ORr,1,TrHs))begin
		storef = false;
		rwcnt = matrowcnt(ORr);
		for(i=0;i<rwcnt;i=i+1)begin
			matrowget(ORr,i,ORrw);
			if(ORrw.stp==1)then begin
				if(blank(ORrw.Objects))then begin
					obj = "";
					INr.Code = ORrw.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						obj = INr.Objects;
						ITr.Code = INr.Group;
						if(readfirstmain(ITr,1,true))then begin
							if(nonblank(ITr.Objects))then begin
								obj = AddObjectToObjectList(obj,ITr.Objects);
							end;
						end;
					end;
					if(nonblank(obj))then begin
						ORrw.Objects = obj;
						matrowput(ORr,i,ORrw);
						storef = true;
						obj = "";
					end;
				end;
			end;
		end;
		if(storef)then begin
			recordstore(ORr,true);
		end;
	end;
	
	SHr.SerNr = -1;
	TrHs = true;
	while(loopmain(SHr,1,TrHs))begin
		storef = false;
		rwcnt = matrowcnt(SHr);
		for(i=0;i<rwcnt;i=i+1)begin
			matrowget(SHr,i,SHrw);
			if(SHrw.stp==1)then begin
				if(blank(SHrw.Objects))then begin
					obj = "";
					INr.Code = SHrw.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						obj = INr.Objects;
						ITr.Code = INr.Group;
						if(readfirstmain(ITr,1,true))then begin
							if(nonblank(ITr.Objects))then begin
								obj = AddObjectToObjectList(obj,ITr.Objects);
							end;
						end;
					end;
					if(nonblank(obj))then begin
						SHrw.Objects = obj;
						matrowput(SHr,i,SHrw);
						storef = true;
						obj = "";
					end;
				end;
			end;
		end;
		if(storef)then begin
			recordstore(SHr,true);
		end;
	end;

return;
end;



global webpublic updating procedure WebFixIdeaObjectsAccc()
begin
	record IVVc IVr,oldIVr;
	row IVVc IVrw;
	record ORVc ORr;
	row ORVc ORrw;
	record SHVc SHr;
	row SHVc SHrw;
	record INVc INr;
	record ITVc ITr;
	string 255 obj;
	record MainVc Mainr;
	record TRVc TRr,oldTRr;
	row TRVc TRrw;
	integer i,rwcnt,trrwcnt,j,dcnt;
	boolean storef,trsoref,TrHs;
	
	setcompany(28,false);
	
	Mainr.AccNumber = "45";
	Mainr.IntYc = SHYc;
	TrHs = true;
	while(loopkey("IntYc",Mainr,2,TrHs))begin
		if(Mainr.AccNumber!="45")then begin TrHs = false; end;
		if(Mainr.IntYc!=SHYc)then begin TrHs = false; end;
		
		if(TrHs)then begin
			
			TRr.Number = Mainr.TransNr;
			TRr.IntYc = Mainr.IntYc;
			if(readfirstmain(TRr,2,true))then begin
				storef = false;
				recordcopy(oldTRr,TRr);
				rwcnt = matrowcnt(TRr);
				for(i=0;i<rwcnt;i=i+1)begin
					matrowget(TRr,i,TRrw);
					if(TRrw.AccNumber=="45")then begin
						if(blank(TRrw.Objects))then begin
							logtext(0,"TransNr " & Mainr.TransNr);
							SHr.SerNr = TRr.Number;
							if(readfirstmain(SHr,1,true))then begin
								if(matrowcnt(SHr)>=(i+2)/2)then begin
									matrowget(SHr,((i+2)/2)-1,SHrw);
									if(nonblank(SHrw.Objects))then begin
										logtext(0,TRrw.AccNumber & " NewObkects " & SHrw.Objects);
										TRrw.Objects = SHrw.Objects;
										matrowput(TRr,i,TRrw);
										storef = true;
									end;
								end;
							end;
						end;
					end;
				end;
				
				if(storef)then begin
					recordupdate(oldTRr,TRr,true);
				end;
			end;
		end;
	
	end;
	

return;
end;


global webpublic updating procedure WebFixIdeaObjectsAccc46()
begin
	record IVVc IVr,oldIVr;
	row IVVc IVrw;
	record ORVc ORr;
	row ORVc ORrw;
	record SHVc SHr;
	row SHVc SHrw;
	record INVc INr;
	record ITVc ITr;
	string 255 obj;
	record MainVc Mainr;
	record TRVc TRr,oldTRr;
	row TRVc TRrw;
	integer i,rwcnt,trrwcnt,j,dcnt;
	boolean storef,trsoref,TrHs;
	
	setcompany(28,false);
	
	Mainr.AccNumber = "46";
	Mainr.IntYc = IVYc;
	TrHs = true;
	while(loopkey("IntYc",Mainr,2,TrHs))begin
		if(Mainr.AccNumber!="46")then begin TrHs = false; end;
		if(Mainr.IntYc!=IVYc)then begin TrHs = false; end;
		
		if(TrHs)then begin
			
			TRr.Number = Mainr.TransNr;
			TRr.IntYc = Mainr.IntYc;
			if(readfirstmain(TRr,2,true))then begin
				storef = false;
				recordcopy(oldTRr,TRr);
				rwcnt = matrowcnt(TRr);
				for(i=0;i<rwcnt;i=i+1)begin
					matrowget(TRr,i,TRrw);
					if(TRrw.AccNumber=="46")then begin
						if(blank(TRrw.Objects))then begin
							logtext(0,"TransNr " & Mainr.TransNr);
							IVr.SerNr = TRr.Number;
							if(readfirstmain(IVr,1,true))then begin
								recordcopy(oldIVr,IVr);
									IVr.OKFlag = 0;
								if(recordupdate(oldIVr,IVr,true)==0)then begin
									recordcopy(oldIVr,IVr)
									IVr.OKFlag = 1;
									recordupdate(oldIVr,IVr,true);
								end;
							end;							
						end;
					end;
				end;
			end;
		end;
	
	end;
	

return;
end;

global webpublic updating procedure WebFix3Level()
begin
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	
	while(loopmain(BtrxThirdLevelCatr,1,true))begin
	
		if(blank(BtrxThirdLevelCatr.PathScndCode))then begin
			recorddelete(BtrxThirdLevelCatr);
			stepback(BtrxThirdLevelCatr);
		end;
	end;


return;
end;

global 
webpublic updating procedure WebFillTreePathMn()
begin
	record GlobalItemVc GIr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr, BSLLastCoder;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder,old3cetr;
	boolean testf, TrHs;
	string 255 catName, catNameRUS, catNameAZ, OldCode, sCatName, tCatName,tstr,new3cat;
	vector string 200 tlvelto2;
	integer pos;
	
	BtrxThirdLevelCatr.Name = "";
	while (loopkey("Name",BtrxThirdLevelCatr,1,testf)) begin
		tlvelto2[BtrxThirdLevelCatr.Name & ";;;" & BtrxThirdLevelCatr.PathScndCode] = BtrxThirdLevelCatr.Code;
	end;
	
	
	GIr.Code = "";
	while (LoopMain(GIr,1,true)) begin
		if(nonblank(GIr.BTRxFirstLevCat) and nonblank(GIr.BTRxSecondLevCat) and nonblank(GIr.BTRxThirdLevCat))then begin
			logtext(0,GIr.Code);
			
			pos = 0;
			new3cat = "";
			ExtractObj(GIr.BTRxThirdLevCat,pos,tstr);
			while(nonblank(tstr))begin
				if(nonblank(tstr) and left(tstr,5)=="THLVL")then begin
					BtrxThirdLevelCatr.Code = tstr;
					if(ReadFirstMain(BtrxThirdLevelCatr,1,true))then begin 
						if(BtrxThirdLevelCatr.PathScndCode!=GIr.BTRxSecondLevCat and left(BtrxThirdLevelCatr.Code,5)=="THLVL")then begin
							if(nonblank(tlvelto2[BtrxThirdLevelCatr.Name & ";;;" & GIr.BTRxSecondLevCat]))then begin
								tstr = tlvelto2[BtrxThirdLevelCatr.Name & ";;;" & GIr.BTRxSecondLevCat];
							end else begin
								BTLLastCoder.Code = "THLVL9999";
								if (readlastkey("Code",BTLLastCoder,1,false)) begin
									OldCode = BTLLastCoder.Code;
									recordcopy(BTLLastCoder,BtrxThirdLevelCatr);
									NextM4SerialNumber(OldCode,BTLLastCoder.Code);
									old3cetr.Code = BTLLastCoder.Code;
									if(readfirstmain(old3cetr,1,true)==false)then begin
										BTLLastCoder.PathScndCode = GIr.BTRxSecondLevCat;
										BtrxSecondLevelCatr.Code = GIr.BTRxSecondLevCat;
										if(readfirstmain(BtrxSecondLevelCatr,1,true))then begin
											BTLLastCoder.CatSecLvlName = BtrxSecondLevelCatr.Name;
										end;
										tlvelto2[BTLLastCoder.Name & ";;;" & BTLLastCoder.PathScndCode] = BTLLastCoder.Code;
										tstr = BTLLastCoder.Code;
										recordstore(BTLLastCoder,true);
									end;
								end;
							end;
						end;
					end;
				end;
				if(nonblank(new3cat))then begin
					new3cat = new3cat & "," & tstr;
				end else begin
					new3cat = tstr;
				end;
				ExtractObj(GIr.BTRxThirdLevCat,pos,tstr);
			end;
			if(nonblank(new3cat))then begin
				if(GIr.BTRxThirdLevCat!=new3cat)then begin
					GIr.BTRxThirdLevCat = new3cat;
					recordstore(GIr,true);
					new3cat = "";
				end;
			end;
			
		end;
	end;
return;
end;

procedure MyExtractObj(string ostr,var Integer pos,var string rstr)
BEGIN
  string 1 c1;
	integer i;
	
	rstr = "";
	if(pos<len(ostr))then begin
		for(i=pos;i<len(ostr);i=i+1)begin
			c1 = mid(ostr,i,1);
			if ((c1==",") or (c1==".") or (c1==";")) then begin
				pos = i+1;
				i = len(ostr);
			end else begin
				rstr = rstr & c1;
				pos = i+1;
			end;
		end;
	end;
	
  RETURN;
END;


global 
webpublic updating procedure WebFixGlobalWatchesMn()
begin
	record GlobalItemVc GIr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr, BSLLastCoder;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder,old3cetr;
	boolean testf, TrHs;
	string 255 catName, catNameRUS, catNameAZ, OldCode, sCatName, tCatName,tstr,new3cat;
	string 1 c;
	vector string 200 tlvelto2,brand,lv1name,lv2name,lv3name;
	integer pos,i;
	boolean ch;
	record BPIBrandVc BPIBrandr;
	
	setcompany(1,false);
	
	
	while(loopmain(BtrxThirdLevelCatr,1,true))begin
		tlvelto2[BtrxThirdLevelCatr.Code] = BtrxThirdLevelCatr.PathScndCode;
		lv3name[BtrxThirdLevelCatr.Code] = BtrxThirdLevelCatr.Name;
	end;
	
	while(loopmain(BtrxSecondLevelCatr,1,true))begin
		lv2name[BtrxSecondLevelCatr.Code] = BtrxSecondLevelCatr.Name;
	end;
	
	while(loopmain(BtrxFirstLevelCatr,1,true))begin
		lv1name[BtrxFirstLevelCatr.Code] = BtrxFirstLevelCatr.Name;
	end;
	
	while(loopmain(BPIBrandr,1,true))begin
		brand[BPIBrandr.Code] = BPIBrandr.Name;
	end;
	
	while(loopmain(GIr,1,true))begin
		ch = false;
		
		/*if(nonblank(GIr.BTRxThirdLevCat))then begin
			tstr = "";
			for(i=0;i<len(GIr.BTRxThirdLevCat);i=i+1)begin
				c = mid(GIr.BTRxThirdLevCat,i,1);
				if(c=="_")then begin
					tstr = tstr & ",";
				end else begin
					tstr = tstr & c;
				end;
			end;
			
			if(tstr!=GIr.BTRxThirdLevCat)then begin
				logtext(0,GIr.Code & " " & GIr.BTRxThirdLevCat & " -> " & tstr);
			end;
		end;*/
		
		
		/*
		ch = false;
		tstr = "";
		pos = 0;
		new3cat = "";
		MyExtractObj(GIr.BTRxThirdLevCat,pos,tstr);
		while(nonblank(tstr))begin
			if(nonblank(tstr) and left(tstr,5)=="THLVL")then begin
				if(nonblank(tlvelto2[tstr]))then begin
					if(tlvelto2[tstr]!=GIr.BTRxSecondLevCat)then begin
						//logtext(0,"Error in 3 level wronglink" & GIr.Code);
						
						logtext(0,GIr.HansaCode & ";;;" & brand[GIr.BPIBrand] & ";;;" & GIr.Name & ";;;" & lv1name[GIr.BTRxFirstLevCat] & ";;;" & lv2name[GIr.BTRxSecondLevCat] & ";;;" & lv3name[GIr.BTRxThirdLevCat]);
					end;
				end else begin
					//logtext(0,"Error in 3 level levelnotexist" & GIr.Code);
					logtext(0,GIr.HansaCode & ";;;" & brand[GIr.BPIBrand] & ";;;" & GIr.Name & ";;;" & lv1name[GIr.BTRxFirstLevCat] & ";;;" & lv2name[GIr.BTRxSecondLevCat] & ";;;" & lv3name[GIr.BTRxThirdLevCat]);
				end;
			end;
			MyExtractObj(GIr.BTRxThirdLevCat,pos,tstr);
		end;
		*/
		
		/*if(GIr.BTRxFirstLevCat=="THLVL0109")then begin
			GIr.BTRxFirstLevCat = "THLVL0090";
			ch = true;
		end;
		if(GIr.BTRxFirstLevCat=="THLVL0083")then begin
			GIr.BTRxFirstLevCat = "THLVL0023";
			ch = true;
		end;
		if(GIr.BTRxSecondLevCat=="SCLVL0010")then begin
			GIr.BTRxSecondLevCat = "SCLVL0017";
			ch = true;
		end;*/
		/*if(GIr.BTRxFirstLevCat=="THLVL0031")then begin
			GIr.BTRxFirstLevCat = "THLVL0062";
			ch = true;
		end;*/
		
		/*if(GIr.BTRxFirstLevCat=="THLVL0096")then begin
			GIr.BTRxFirstLevCat = "THLVL0036";
			ch = true;
		end;
		
		if(ch)then begin
			logtext(0,GIr.Code);
			recordstore(GIr,true);
		end;*/
		if(GIr.BTRxFirstLevCat=="THLVL0095")then begin
			GIr.BTRxFirstLevCat = "THLVL0037";
			ch = true;
		end;
		
		if(ch)then begin
			logtext(0,GIr.Code);
			recordstore(GIr,true);
		end;
	end;
	
	
	/*while(loopmain(BtrxThirdLevelCatr,1,true))begin
		if(BtrxThirdLevelCatr.PathScndCode=="SCLVL0010")then begin
			BtrxThirdLevelCatr.PathScndCode = "SCLVL0017";
			logtext(0,"BtrxThirdLevelCatr " & BtrxThirdLevelCatr.Code);
			recordstore(BtrxThirdLevelCatr,true);
		end;
	end;*/
	
	return;
end;


global 
webpublic updating procedure WebDrawCategoryTree()
begin
	record GlobalItemVc GIr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr, BSLLastCoder;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder,old3cetr;
	boolean testf, TrHs;
	string 255 catName, catNameRUS, catNameAZ, OldCode, sCatName, tCatName,tstr,new3cat;
	string 1 c;
	vector string 200 tlvelto2,brand,lv1name,lv2name,lv3name;
	integer pos,i;
	boolean ch;
	record BPIBrandVc BPIBrandr;
	
	setcompany(1,false);
	
	while(loopmain(BtrxFirstLevelCatr,1,true))begin
		lv1name[BtrxFirstLevelCatr.Code] = BtrxFirstLevelCatr.Name;
	end;
	resetloop(BtrxFirstLevelCatr);
	
	while(loopmain(BtrxSecondLevelCatr,1,true))begin
		lv2name[BtrxSecondLevelCatr.Code] = BtrxSecondLevelCatr.Name;
	end;
	resetloop(BtrxSecondLevelCatr);
	
	while(loopmain(BtrxThirdLevelCatr,1,true))begin
		lv3name[BtrxThirdLevelCatr.Code] = BtrxThirdLevelCatr.Name;
	end;
	resetloop(BtrxThirdLevelCatr);
	WebOutString("<BR>");
	BtrxFirstLevelCatr.Code = "";
	while(loopmain(BtrxFirstLevelCatr,1,true))begin
		WebOutString(BtrxFirstLevelCatr.Name & "(" & BtrxFirstLevelCatr.Code & ")" & BtrxFirstLevelCatr.NameRUS);
		weboutstring("<BR>");
		resetloop(BtrxSecondLevelCatr);
		BtrxSecondLevelCatr.Code = "";
		while(loopmain(BtrxSecondLevelCatr,1,true))begin
			if(BtrxSecondLevelCatr.PathFrstCode==BtrxFirstLevelCatr.Code)then begin
				lv2name[BtrxSecondLevelCatr.Code] = "";
				WebOutString("---------------------------" & BtrxSecondLevelCatr.Name & "(" & BtrxSecondLevelCatr.Code & ")" & BtrxSecondLevelCatr.NameRUS);
				weboutstring("<BR>");
				resetloop(BtrxThirdLevelCatr);
				BtrxThirdLevelCatr.Code = "";
				while(loopmain(BtrxThirdLevelCatr,1,true))begin
					if(BtrxThirdLevelCatr.PathScndCode==BtrxSecondLevelCatr.Code)then begin
						lv3name[BtrxThirdLevelCatr.Code] = "";
						WebOutString("------------------------------------------------------" & BtrxThirdLevelCatr.Name & "(" & BtrxThirdLevelCatr.Code & ")" & BtrxThirdLevelCatr.NameRUS);
						weboutstring("<BR>");
					end;
				end;
			end;
		end;
	end;
	
	weboutstring("<BR>");
	weboutstring("<BR>");
	weboutstring("Problems...");
	weboutstring("<BR>");
	weboutstring("<BR>");
	
	resetloop(BtrxSecondLevelCatr);
	BtrxSecondLevelCatr.Code = "";
	while(loopmain(BtrxSecondLevelCatr,1,true))begin
		if(nonblank(lv2name[BtrxSecondLevelCatr.Code]))then begin
			weboutstring(BtrxSecondLevelCatr.Code & "_____" & BtrxSecondLevelCatr.Name);
			weboutstring("<BR>");
		end;
	end;
	
	resetloop(BtrxThirdLevelCatr);
	BtrxThirdLevelCatr.Code = "";
	while(loopmain(BtrxThirdLevelCatr,1,true))begin
		if(nonblank(lv3name[BtrxThirdLevelCatr.Code]))then begin
			weboutstring(BtrxThirdLevelCatr.Code & "_____" & BtrxThirdLevelCatr.Name);
			weboutstring("<BR>");
		end;
	end;
	
	
	return;
end;





global 
webpublic updating procedure WebNegCostPriceRn()
begin
	record ItemHistVc IHr;
	boolean TrHs;
	longint i;
	for (i=1;i<34;i=i+1)begin
		if (SetCompany(i,false)) then begin
			IHr.FileName = "RetVc";
			TrHs = true;
			while (loopkey("FNTransNr",IHr,1,TrHs)) begin
				if (IHr.FileName != "RetVc") then begin TrHs = false; end;
				if (TrHs)then begin
					if (IHr.TotCostPriceCurncy<0) then begin
						weboutstring("Company:___" & i & "___ItemCode:___" & IHr.ArtCode & "___ItemHistNr:___" & IHr.TransNr & "___TotCostPriceCurncy:___" & IHr.TotCostPriceCurncy);
						weboutstring("<BR>");
					end;
				end;
			end;
			resetloop(IHr);
		end;
	end;
	return;
end;






global 
webpublic updating procedure WebIncorrectPhones()
begin
	record CUVc CUr;
	boolean TrHs,testf;	
		
		CUr.Code = "";
  CUr.CUType = 1;
  CUr.blockedFlag = 0;
	TrHs = true;
	While(LoopKey("ActCode",CUr,3,TrHs)) begin
	  testf = false;
		if(CUr.blockedFlag>0) then begin TrHs = false; end;
		if (nonblank(CUr.Phone)) then begin
			if (left(CUr.Phone,6)!="+99412" or len(CUr.Phone)!=13) then begin
				testf = true;
			end;
		end;
		if (nonblank(CUr.Mobile)) then begin
			if ((left(CUr.Mobile,6)!="+99450" and left(CUr.Mobile,6)!="+99451" and left(CUr.Mobile,6)!="+99455" and left(CUr.Mobile,6)!="+99470" and left(CUr.Mobile,6)!="+99477") or len(CUr.Mobile)!=13) then begin
				testf = true;
			end;
		end;
		if (nonblank(CUr.AltPhone)) then begin
			if ((left(CUr.AltPhone,6)!="+99450" and left(CUr.AltPhone,6)!="+99451" and left(CUr.AltPhone,6)!="+99455" and left(CUr.AltPhone,6)!="+99470" and left(CUr.AltPhone,6)!="+99477") or len(CUr.AltPhone)!=13) then begin
				testf = true;
			end;
		end;
		if(blank(CUr.CRMid)) then begin testf = false; end;
		if(testf) then begin
			weboutstring(CUr.Code & "  " & CUr.Phone & "   " & CUr.Mobile & "    " & CUr.AltPhone);
			weboutstring("<BR>");
		end;
	end;
	
	
	
	return;
end;


global procedure LogProcTime(string procname, longint timems)
begin
	area logfile;
	
	addtexttoarea(currentdate & chr(9) & currenttime & chr(9) & procname & chr(9) & currentcompany & chr(9) & timems & chr(13) & chr(10),logfile);
	
	writeareatofile(logfile,"ProcTimes.txt",1);
	

return;
end;


webpublic global
procedure WebCalcRHist()
begin
	record RHistVc RHr;
	vector longint cnter;
	string 1 c,nul;
	integer cter,i,pref,check;
	boolean TrHs;
	string 50 recname,compnr;
	array string 50 vtags;
	
	
	setcompany(1,false);
  RHr.SerNr = -1;
  TrHs = true;
  while(loopmain(RHr,1,TrHs))begin
  
  	if(check>1000)then begin
  		//TrHs = false;
  	end;
  	
  	if(fileexists("stop"))then begin
  		TrHs = false;
  	end;
  	
  	//check = check + 1;
  	
  	c = left(RHr.RecidStr,1);
  	recname = "";
  	cter = 0;
  	if(blank(RHr.RecidStr))then begin
  		cnter["BLANK"] = cnter["BLANK"] + 1;
  	end else begin
  		pref = asc(c) + 1;
  		compnr = mid(RHr.RecidStr,1,asc(c));
  		if(pref<len(RHr.RecidStr))then begin
				for(i=pref;i<len(RHr.RecidStr);i=i+1)begin
						c = mid(RHr.RecidStr,i,1);
					if(asc(c)==0)then begin
						i = len(RHr.RecidStr);
					end else begin
						recname = recname & c;
					end;
				end;
  		end else begin
  			cnter["BLANK"] = cnter["BLANK"] + 1;
  		end;
  	end;
  	if(nonblank(recname))then begin
  		cnter[compnr & "_" & recname] = cnter[compnr & "_" & recname] + 1;
  	end else begin
  		cnter["BLANK"] = cnter["BLANK"] + 1;
  	end;
  end;
  
  getvectortags(cnter,vtags);
  for(i=0;i<vtags.length;i=i+1)begin
  	weboutstring(vtags[i] & " ----- " & cnter[vtags[i]]);
  	weboutstring("<BR>");
  end;
  
return;
end;




// webpublic global
// updating procedure WebFillglobalClassFromIN()
// begin
	// record INVc INr;
	// record GlobalItemVc GIr;
	// boolean TrHs;
	// integer i,rwcnt,j,rwcnt2,curcomp,compNo;
  // string 50 store;
  // record CompaniesBlock CBb;
	// array string 255 noBrIt;

	// blockload(CBb);
	
	// j = 0;
	// GIr.Code = "";
	// while (loopMain(GIr,1,true)) begin
		// if(blank(GIr.BPIBrand))then begin
			// noBrIt[j] = GIr.HansaCode;
			// j = j + 1;
		// end;
	// end;
	// resetloop(GIr);
	// rwcnt = j;
	
	
	

	// for (i=0;i<matrowcnt(CBb);i=i+1) begin
		// compNo = i + 1;
		// if(compNo!=9 and compNo!=18 and compNo!=28 and compNo!=29 and compNo!=32 and compNo!=33 and !(CompanyIsJWLikeCompany(compNo) and compNo!=3))then begin
			// SetCompany(compNo,false);
			// logtext(0,"Company - " & compNo);
			// for (j=0;j<rwcnt;j=j+1) begin
				// INr.Code = noBrIt[j];
				// if (ReadFirstMain(INr,1,true)) begin
					// if(nonblank(INr.BPIBrand))then begin
						// GIr.Code = INr.BPIBrand & "_" & INr.Code;
						// if(ReadFirstMain(GIr,1,true))then begin
							// GIr.BPIBrand = INr.BPIBrand;
							// if(nonblank(INr.BPICollection))then begin
								// GIr.BPICollection = INr.BPICollection;
							// end;
							// if(nonblank(INr.BPICollection))then begin
								// GIr.BPIGroup = INr.BPICollection;
							// end;
							// if(nonblank(INr.BPISubGroup))then begin
								// GIr.BPISubGroup = INr.BPISubGroup;
							// end;
							// if(nonblank(INr.BPICategory))then begin
								// GIr.BPICategory = INr.BPICategory;
							// end;
							// if(nonblank(INr.BPIMaterial))then begin
								// GIr.BPIMaterial = INr.BPIMaterial;
							// end;
							// if(nonblank(INr.BPIColor))then begin
								// GIr.BPIColor = INr.BPIColor;
							// end;
							// if(nonblank(INr.BPIShape))then begin
								// GIr.BPIShape = INr.BPIShape;
							// end;
							// if(nonblank(INr.BPISize))then begin
								// GIr.BPISize = INr.BPISize;
							// end;
							// if(nonblank(INr.BPIUse))then begin
								// GIr.BPIUse = INr.BPIUse;
							// end;
							// if(nonblank(INr.BPISex))then begin
								// GIr.BPISex = INr.BPISex;
							// end;
							// if(nonblank(INr.BPIPlating))then begin
								// GIr.BPIPlating = INr.BPIPlating;
							// end;
							// if(nonblank(INr.BPIClarity))then begin
								// GIr.BPIClarity = INr.BPIClarity;
							// end;
							// if(nonblank(INr.BPIWeight))then begin
								// GIr.BPIWeight = INr.BPIWeight;
							// end;
							// if(nonblank(INr.BPICut))then begin
								// GIr.BPICut = INr.BPICut;
							// end;
							// if(nonblank(INr.BPIStone))then begin
								// GIr.BPIStone = INr.BPIStone;
							// end;
							// if(nonblank(INr.BPIStrap))then begin
								// GIr.BPIStrap = INr.BPIStrap;
							// end;
							// if(nonblank(INr.BPIOdour))then begin
								// GIr.BPIOdour = INr.BPIOdour;
							// end;
							// if(nonblank(INr.BTRxGiftClass))then begin
								// GIr.BTRxGiftClass = INr.BTRxGiftClass;
							// end;
							// if(nonblank(INr.BTRxInterCatClass))then begin
								// GIr.BTRxInterCatClass = INr.BTRxInterCatClass;
							// end;
							// if(nonblank(INr.BTRxFirstLevCat))then begin
								// GIr.BTRxFirstLevCat = INr.BTRxFirstLevCat;
							// end;
							// if(nonblank(INr.BTRxSecondLevCat))then begin
								// GIr.BTRxSecondLevCat = INr.BTRxSecondLevCat;
							// end;
							// if(nonblank(INr.BTRxThirdLevCat))then begin
								// GIr.BTRxThirdLevCat = INr.BTRxThirdLevCat;
							// end;
							// if(nonblank(INr.AlternativeCode))then begin
								// GIr.AlternativeCode = INr.AlternativeCode;
							// end;
							// if(nonblank(INr.Cert))then begin
								// GIr.Cert = INr.Cert;
							// end;
							// if(nonblank(INr.BTRxWatchMechanism))then begin
								// GIr.BTRxWatchMechanism = INr.BTRxWatchMechanism;
							// end;
							// if(nonblank(INr.BTRxPowerReserve))then begin
								// GIr.BTRxPowerReserve = INr.BTRxPowerReserve;
							// end;
							// if(nonblank(INr.BPIStrap))then begin
								// GIr.BPIStrap = INr.BPIStrap;
							// end;
							// if(nonblank(INr.BTRxStrapColour))then begin
								// GIr.BTRxStrapColour = INr.BTRxStrapColour;
							// end;
							// if(nonblank(INr.BTRxPlacerScatt))then begin
								// GIr.BTRxPlacerScatt = INr.BTRxPlacerScatt;
							// end;
							// if(nonblank(INr.BTRxPhoneModel))then begin
								// GIr.BTRxPhoneModel = INr.BTRxPhoneModel;
							// end;
							// if(nonblank(INr.BTRxFilling))then begin
								// GIr.BTRxFilling = INr.BTRxFilling;
							// end;
							// if(nonblank(INr.Depth))then begin
								// GIr.Depth = INr.Depth;
							// end;
							// if(nonblank(INr.Width))then begin
								// GIr.Width = INr.Width;
							// end;
							// if(nonblank(INr.Height))then begin
								// GIr.Height = INr.Height;
							// end;
							// if(nonblank(INr.BTRxDiam))then begin
								// GIr.BTRxDiam = INr.BTRxDiam;
							// end;
							// if(nonblank(INr.Volume))then begin
								// GIr.Volume = INr.Volume;
							// end;
							// if(nonblank(INr.Weight))then begin
								// GIr.Weight = INr.Weight;
							// end;
							// if(nonblank(INr.BTRxProdColour))then begin
								// GIr.BTRxProdColour = INr.BTRxProdColour;
							// end;
							// if(nonblank(INr.BTRxChainMaterial))then begin
								// GIr.BTRxChainMaterial = INr.BTRxChainMaterial;
							// end;
							// if(nonblank(INr.BTRxWatchGradeA))then begin
								// GIr.BTRxWatchGradeA = INr.BTRxWatchGradeA;
							// end;
							// if(nonblank(INr.BTRxWatchGradeB))then begin
								// GIr.BTRxWatchGradeB = INr.BTRxWatchGradeB;
							// end;
							// if(nonblank(INr.BTRxWatchGradeC))then begin
								// GIr.BTRxWatchGradeC = INr.BTRxWatchGradeC;
							// end;
							// if(nonblank(INr.BTRxStoneA))then begin
								// GIr.BTRxStoneA = INr.BTRxStoneA;
							// end;
							// if(nonblank(INr.BTRxStoneScattA))then begin
								// GIr.BTRxStoneScattA = INr.BTRxStoneScattA;
							// end;
							// if(nonblank(INr.BTRxStoneB))then begin
								// GIr.BTRxStoneB = INr.BTRxStoneB;
							// end;
							// if(nonblank(INr.BTRxStoneScattB))then begin
								// GIr.BTRxStoneScattB = INr.BTRxStoneScattB;
							// end;
							// if(nonblank(INr.BTRxStoneC))then begin
								// GIr.BTRxStoneC = INr.BTRxStoneC;
							// end;
							// if(nonblank(INr.BTRxStoneScattC))then begin
								// GIr.BTRxStoneScattC = INr.BTRxStoneScattC;
							// end;
							// if(nonblank(INr.BTRxLimitedGood))then begin
								// GIr.BTRxLimitedGood = INr.BTRxLimitedGood;
							// end;
							// if(RecordStore(GIr,true))then begin 
								// logtext(0,GIr.Code & "_" & compNo);
							// end;
						// end else begin
							// CreateNewGlobalItem(INr);
						// end;
					// end;
				// end;
			// end;
		// end;
	// end;
	
	



// end;




// webpublic global
// updating procedure WebFillglobalClassFromIN()
// begin
	// record INVc INr;
	// record GlobalItemVc GIr;
	// boolean TrHs;
	// integer i,rwcnt,j,rwcnt2,curcomp,compNo;
  // string 50 store;
  // record CompaniesBlock CBb;
	// array string 255 noBrIt;

	// blockload(CBb);
	
	// GIr.Code = "ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ";
	// while (loopBackKey("Code",GIr,1,true)) begin
		// if(blank(GIr.BPIBrand))then begin
			// recorddelete(GIr);
			// logtext(0,GIr.Code);
		// end;
	// end;
	// resetloop(GIr);
	
// end;








webpublic global
updating procedure WebCalcRHistWithDeleting()
begin
	record RHistVc RHr;
	vector longint cnter;
	string 1 c,nul;
	integer cter,i,pref,check;
	boolean TrHs;
	string 50 recname,compnr;
	array string 50 vtags;
	date fd;
	
	fd.year = 2018;
	fd.month = 6;
	fd.day = 31;
	
	Logtext(0,"WebCalcRHistWithDeleting start");
	setcompany(1,false);
  RHr.SerNr = -1;
  TrHs = true;
  while(loopmain(RHr,1,TrHs))begin
  
  	if(check>1000)then begin
  		//TrHs = false;
  	end;
  	
  	if(fileexists("stop"))then begin
  		TrHs = false;
  	end;
  	
  	//check = check + 1;
  	
  	c = left(RHr.RecidStr,1);
  	recname = "";
  	cter = 0;
  	if(blank(RHr.RecidStr))then begin
  		cnter["BLANK"] = cnter["BLANK"] + 1;
  	end else begin
  		pref = asc(c) + 1;
  		compnr = mid(RHr.RecidStr,1,asc(c));
  		if(pref<len(RHr.RecidStr))then begin
				for(i=pref;i<len(RHr.RecidStr);i=i+1)begin
						c = mid(RHr.RecidStr,i,1);
					if(asc(c)==0)then begin
						i = len(RHr.RecidStr);
					end else begin
						recname = recname & c;
					end;
				end;
  		end else begin
  		end;
  	end;
  	if(blank(recname))then begin
  		recname = "BLANK";
  	end;
  	
  	switch(recname)begin
  		case"ACCESSVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"ACTVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"CLCORSPVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"DIVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"IVVC":
  						if(RHr.TransDate<=fd)then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;
  		/*case"INVC":
  						if(RHr.TransDate<=fd)then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;*/
  		/*case"PLVC":
  						if(RHr.TransDate<=fd)then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;*/
  		case"CLINVC":
  						if(RHr.TransDate<=fd)then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;
  		case"CLOUTVC":
  						if(RHr.TransDate<=fd)then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;
  		case"ERVC":
  						if(RHr.TransDate<=fd)then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;
  		/*case"LOYALTYCARDVC":
  						if(RHr.TransDate<=fd)then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;*/
  		case"OBJVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"PFORMVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"PLDEFVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"REBVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"RETPUVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"RETVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"SDVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"SHVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"STOCKMOVVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"STOCKTAKEVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"TRVC":
  						if(RHr.TransDate<=fd)then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;
  		case"USERVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		case"VIVC":cnter[recname] = cnter[recname] + 1;
  						recorddelete(RHr);
  						stepback(RHr);
  		otherwise
  						if(compnr=="10" or compnr=="14")then begin
								cnter[recname] = cnter[recname] + 1;
								recorddelete(RHr);
								stepback(RHr);
  						end;
  	end;
  end;
  
  Logtext(0,"WebCalcRHistWithDeleting end");
  
  getvectortags(cnter,vtags);
  for(i=0;i<vtags.length;i=i+1)begin
  	weboutstring(vtags[i] & " ----- " & cnter[vtags[i]]);
  	weboutstring("<BR>");
  end;
  
  Logtext(0,"WebCalcRHistWithDeleting end");
  
return;
end;

function string 100 fixPhone(string inpphone)
begin
	string 100 res;
	integer i;
	string 1 c;
	
	for(i=0;i<len(inpphone);i=i+1)begin
		c = mid(inpphone,i,1);
		if(asc(c)>47 and asc(c)<58)then begin	
			res = res & c;
		end;
	end;
	
	if(len(res)==10)then begin
		res = right(res,9);
	end;
	if(len(res)==20)then begin
		res = mid(res,1,9) & "," & mid(res,11,9);
	end;
	
	fixPhone = res;
return;
end;

function string 255 CheckCustomersWithSamePhnes(record CUVc origCUr,string phone)
begin
	boolean TrHs,testf;
	string 255 res;
	record CUVc CUr;
	
	if(nonblank(phone))then begin
		CUr.Phone = phone;
		TrHs = true;
		while(loopkey("Phone",CUr,1,TrHs))begin
			if(CUr.Phone!=phone)then begin TrHs = false; end;
			
			if(CUr.blockedFlag==0 and CUr.Code!=origCUr.Code and TrHs)then begin
				res = res & CUr.Code & ",";
			end;
		end;
		resetloop(CUr);
		
		CUr.Mobile = phone;
		TrHs = true;
		while(loopkey("Mobile",CUr,1,TrHs))begin
			if(CUr.Mobile!=phone)then begin TrHs = false; end;
			
			if(CUr.blockedFlag==0 and CUr.Code!=origCUr.Code and TrHs)then begin
				res = res & CUr.Code & ",";
			end;
		end;
		resetloop(CUr);
		
		CUr.AltPhone = phone;
		TrHs = true;
		while(loopkey("AltPhone",CUr,1,TrHs))begin
			if(CUr.AltPhone!=phone)then begin TrHs = false; end;
			
			if(CUr.blockedFlag==0 and CUr.Code!=origCUr.Code and TrHs)then begin
				res = res & CUr.Code & ",";
			end;
		end;
		resetloop(CUr);
	end;
	
	CheckCustomersWithSamePhnes = res;
return;
end;

global webpublic procedure WebGetDuplClient()
begin
	record CUVc CUr,oldCUr;
	boolean TrHs,testf;
	integer i,pos;
	string 100 tstr,normphone,dupcust;
	
	setcompany(28,false);
	
	CUr.CustCat = "IDEA";
	TrHs = true;
	while(loopkey("Group",CUr,1,TrHs))begin
		testf = true;
		if(CUr.CustCat!="IDEA")then begin TrHs = false; testf = false; end;
		if(CUr.blockedFlag==1)then begin testf = false; end;
		if(CUr.CUType==0)then begin testf = false; end;
		
		
		if(testf)then begin
			normphone = fixPhone(CUr.Phone);
			tstr = "";
			pos = 0;
			dupcust = "";
			if(nonblank(normphone))then begin
				ExtractObj(normphone,pos,tstr);
				while(nonblank(tstr))begin
					dupcust = dupcust & CheckCustomersWithSamePhnes(CUr,normphone);
					ExtractObj(normphone,pos,tstr);
				end;
			end;
			NormalizeObjstr(dupcust);
			if(nonblank(dupcust))then begin
				weboutstring("Custcomer code:" & CUr.Code & "&nbsp| name &nbsp" & CUr.Name & "&nbsp| Phone &nbsp" & fixPhone(CUr.Phone) & "&nbsp|&nbspDuplicates: " & dupcust);
				weboutstring("<BR>");
			end;
		end;
	end;
	
return;
end;





global webpublic procedure WebGetBlankThrdCat()
begin
	record GlobalItemVc GIr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BTRxBrandVc BTRxBrandr;

	boolean TrHs,testf;
	integer i,pos;
	string 100 tstr,normphone,dupcust;
	
	SetCompany(18,false);
	
	GIr.Code = "";
	while (LoopMain(GIr,1,true)) begin
		// if(nonblank(GIr.BTRxFirstLevCat) and nonblank(GIr.BTRxSecondLevCat) and blank(GIr.BTRxThirdLevCat))then begin
			BTRxBrandr.Code = GIr.BPIBrand;
			if(ReadFirstMain(BTRxBrandr,1,true))then begin end;
			BtrxFirstLevelCatr.Code = GIr.BTRxFirstLevCat;
			if(ReadFirstMain(BtrxFirstLevelCatr,1,true))then begin end;
			BtrxSecondLevelCatr.Code = GIr.BTRxSecondLevCat;
			if(ReadFirstMain(BtrxSecondLevelCatr,1,true))then begin end;
			
			weboutstring("Global code: " & GIr.Code & " --------- Brand: " & BTRxBrandr.Name & " --------- BTRxFirstLevCat: " & BtrxFirstLevelCatr.Name & " --------- BTRxSecondLevCat: " & BtrxSecondLevelCatr.Name);
			weboutstring("<BR>");
		// end;
	end;
	
	
return;
end;











global updating procedure ChangeAllBrandBPIBrandMn(record RcVc RepSpec)
begin
record INVc INr,oldINr;
integer i,curcomp,cnt,j,k;
record GlobalItemVc GIr,oldGIr;
string 100 item,oldBrand,newBrand,code,glCode;
record BPIBrandVc BPIBrandr;
record BPIBrandVc BPIBrand1r;
array string 100 abrand,anewbrand;
boolean tochan;


	curcomp = currentcompany;
	logtext(0,"start");

		cnt = cnt + 1;
		oldBrand = RepSpec.f1;
		newBrand = RepSpec.f2;
		BPIBrandr.Code = oldBrand;
		logtext(0,"oldBrand " & oldBrand);
		logtext(0,"newBrand " & newBrand);
		if(nonblank(RepSpec.f1))then begin
			if(true)then begin		
				BPIBrand1r.Code = newBrand;
				if(readfirstkey("Code",BPIBrand1r,1,true))then begin						
					for(i=1;i<34; i=i+1) begin
						if((!CompanyIsJWLikeCompany(i) or i==3) and i!=10) then begin
							SetCompany(i,false);
							resetloop(INr);
							INr.Code = "";
							while(LoopMain(INr,1,true))begin
								if(nonblank(INr.BPIBrand))then begin
									if(INr.BPIBrand==RepSpec.f1)then begin;
										tochan = true;
										logtext(0,INr.Code & " " & INr.BPIBrand & " " & INr.GlobalArtCode);
										if(setinset(INr.BPIBrand,INr.DispGroups))then begin										
											INr.DispGroups = StrReplace(INr.DispGroups,INr.BPIBrand,BPIBrand1r.Code);
										end;
										glCode = INr.GlobalArtCode;
										INr.GlobalArtCode = "";
										INr.BPIBrand = BPIBrand1r.Code;
										GIr.Code = glCode;										
										if(ReadFirstMain(GIr,1,true)) then begin
											logtext(0,"del" & GIr.Code);
											oldGIr.Code = INr.Code & "_" & INr.BPIBrand;
											if(readfirstmain(oldGIr,1,true))then begin
												tochan = false;
												logtext(0,"Failed to change brand for " & INr.Code & " in company " & currentcompany);
											end else begin
												recordcopy(oldGIr,GIr);
											 GIr.Code = INr.BPIBrand & "_" & INr.Code;
											 INr.GlobalArtCode = GIr.Code;
											 GIr.Brand = BPIBrand1r.Name;
											 GIr.BPIBrand = BPIBrand1r.Code;
											 if(nonblank(GIr.MainCode))then begin
											 	if(left(GIr.MainCode,8)!=left(GIr.Code,8))then begin
											 		GIr.MainCode = GIr.BPIBrand & right(GIr.MainCode,len(GIr.MainCode)-8);
											 	end;
											 end;
											 GIr.Classification = INr.DispGroups;
											 recordupdate(oldGIr,GIr,false);
											end;
										end;
										if(tochan)then begin
											logtext(0,"Brand Changed for item " & INr.Code & " in company " & currentcompany);
											if(recordStore(INr,true)) then begin  end;
										end;
									end; 
								end;
							end;
						end;
					end;
				end;
			end;
		end;
	SetCompany(curcomp,false);
	
logtext(0,"end");
return;
end;

updating procedure LoopItemsInOtherCom(record INVc INr,integer orgcomp)
begin
	record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  integer i,rwcnt;
  record INVc IN2r;
  boolean diff;
  
  BlockLoad(Compb);
  rwcnt = MatRowCnt(Compb);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Compb,i,Comprw);
  	if((i+1)!=orgcomp)then begin
  		setcompany(i+1,false);
  		IN2r.Code = INr.Code;
  		if(readfirstmain(IN2r,1,true))then begin
  			
  			diff = false;
  			if(IN2r.BPIBrand==INr.BPIBrand)then begin
					if(IN2r.BPICollection!=INr.BPICollection)then begin diff = true; logtext(0,"BPICollection"); end;
					if(IN2r.BPIGroup!=INr.BPIGroup)then begin diff = true; logtext(0,"BPIGroup"); end;
					if(IN2r.BPISubGroup!=INr.BPISubGroup)then begin diff = true; logtext(0,"BPISubGroup"); end;
					if(IN2r.BPICategory!=INr.BPICategory)then begin diff = true; logtext(0,"BPICategory"); end;
					if(IN2r.BPIMaterial!=INr.BPIMaterial)then begin diff = true; logtext(0,"BPIMaterial"); end;
					if(IN2r.BPIColor!=INr.BPIColor)then begin diff = true; logtext(0,"BPIColor"); end;
					if(IN2r.BPIShape!=INr.BPIShape)then begin diff = true; logtext(0,"BPIShape"); end;
					if(IN2r.BPISize!=INr.BPISize)then begin diff = true; logtext(0,"BPISize"); end;
					if(IN2r.BPIUse!=INr.BPIUse)then begin diff = true; logtext(0,"BPIUse"); end;
					if(IN2r.BPISex!=INr.BPISex)then begin diff = true; logtext(0,"BPISex"); end;
					if(IN2r.BPIPlating!=INr.BPIPlating)then begin diff = true; logtext(0,"BPIPlating"); end;
					if(IN2r.BPIClarity!=INr.BPIClarity)then begin diff = true; logtext(0,"BPIClarity"); end;
					if(IN2r.BPIWeight!=INr.BPIWeight)then begin diff = true; logtext(0,"BPIWeight"); end;
					if(IN2r.BPICut!=INr.BPICut)then begin diff = true; logtext(0,"BPICut"); end;
					if(IN2r.BPIStone!=INr.BPIStone)then begin diff = true; logtext(0,"BPIStone"); end;
					if(IN2r.BPIStrap!=INr.BPIStrap)then begin diff = true; logtext(0,"BPIStrap"); end;
					if(IN2r.BPIOdour!=INr.BPIOdour)then begin diff = true; logtext(0,"BPIOdour"); end;
  				
  				if(diff)then begin
						logtext(0,"LoopItemsInOtherCom " & currentcompany & "  " & IN2r.Code);
						IN2r.BPICollection = INr.BPICollection;
						IN2r.BPIGroup = INr.BPIGroup;
						IN2r.BPISubGroup = INr.BPISubGroup;
						IN2r.BPICategory = INr.BPICategory;
						IN2r.BPIMaterial = INr.BPIMaterial;
						IN2r.BPIColor = INr.BPIColor;
						IN2r.BPIShape = INr.BPIShape;
						IN2r.BPISize = INr.BPISize;
						IN2r.BPIUse = INr.BPIUse;
						IN2r.BPISex = INr.BPISex;
						IN2r.BPIPlating = INr.BPIPlating;
						IN2r.BPIClarity = INr.BPIClarity;
						IN2r.BPIWeight = INr.BPIWeight;
						IN2r.BPICut = INr.BPICut;
						IN2r.BPIStone = INr.BPIStone;
						IN2r.BPIStrap = INr.BPIStrap;
						IN2r.BPIOdour = INr.BPIOdour;
						IN2r.Name = INr.Name;
						recordstore(IN2r,true);
  				end;
  				
  			end;
  		end;
  	end;
  end;
  
  resetcompany(orgcomp);

return;
end;

global webpublic updating  procedure offUpdateAllBenchmarkingInItemMn()
begin
	record IVVc IVr,IVr1;
	row IVVc IVrw;
	integer i,mtrw,curcomp;
	record INVc INr;
	
	curcomp = 6;
	
	setcompany(curcomp,false);
	IVr.SerNr = 4826;
	IVr1.SerNr = 4827;
	
	readfirstmain(IVr,1,true);
	readfirstmain(IVr1,1,true);
	
	mtrw = matrowcnt(IVr);
	for(i=0;i<mtrw;i=i+1)begin
		matrowget(IVr,i,IVrw);
		INr.Code = IVrw.ArtCode;
		if(readfirstmain(INr,1,true))then begin
			LoopItemsInOtherCom(INr,curcomp);
		end;
	end;
	
	mtrw = matrowcnt(IVr1);
	for(i=0;i<mtrw;i=i+1)begin
		matrowget(IVr1,i,IVrw);
		INr.Code = IVrw.ArtCode;
		if(readfirstmain(INr,1,true))then begin
			LoopItemsInOtherCom(INr,curcomp);
		end;
	end;
	
	IVr.SerNr = 4828;
	IVr1.SerNr = 4829;
	
	readfirstmain(IVr,1,true);
	readfirstmain(IVr1,1,true);
	
	mtrw = matrowcnt(IVr);
	for(i=0;i<mtrw;i=i+1)begin
		matrowget(IVr,i,IVrw);
		INr.Code = IVrw.ArtCode;
		if(readfirstmain(INr,1,true))then begin
			LoopItemsInOtherCom(INr,curcomp);
		end;
	end;
	
	mtrw = matrowcnt(IVr1);
	for(i=0;i<mtrw;i=i+1)begin
		matrowget(IVr1,i,IVrw);
		INr.Code = IVrw.ArtCode;
		if(readfirstmain(INr,1,true))then begin
			LoopItemsInOtherCom(INr,curcomp);
		end;
	end;
	
	IVr.SerNr = 4830;
	IVr1.SerNr = 4831;
	
	readfirstmain(IVr,1,true);
	readfirstmain(IVr1,1,true);
	
	mtrw = matrowcnt(IVr);
	for(i=0;i<mtrw;i=i+1)begin
		matrowget(IVr,i,IVrw);
		INr.Code = IVrw.ArtCode;
		if(readfirstmain(INr,1,true))then begin
			LoopItemsInOtherCom(INr,curcomp);
		end;
	end;
	
	mtrw = matrowcnt(IVr1);
	for(i=0;i<mtrw;i=i+1)begin
		matrowget(IVr1,i,IVrw);
		INr.Code = IVrw.ArtCode;
		if(readfirstmain(INr,1,true))then begin
			LoopItemsInOtherCom(INr,curcomp);
		end;
	end;
	
return;
end;

global webpublic procedure WebCompileAllParams()
begin
	record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  integer i,rwcnt;
  record INVc INr;
  boolean diff;
  boolean incomp;
  area aINParams,aGIParams;
  record BPIBrandVc BPIBrandr;
record BPICollectionVc BPICollectionr;
record BPIGroupVc BPIGroupr;
record BPISubGroupVc BPISubGroupr;
record BPICategoryVc BPICategoryr;
record BPIMaterialVc BPIMaterialr;
record BPIColorVc BPIColorr;
record BPIShapeVc BPIShaper;
record BPISizeVc BPISizer;
record BPIUseVc BPIUser;
record BPISexVc BPISexr;
record BPIPlatingVc BPIPlatingr;
record BPIClarityVc BPIClarityr;
record BPIWeightVc BPIWeightr;
record BPICutVc BPICutr;
record BPIStoneVc BPIStoner;
record BPIStrapVc BPIStrapr;
record BPIOdourVc BPIOdourr;
vector string 255 vClass;
longint curtick;
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	record BtrxStrapMatVc BtrxStrapMatr;
	record BtrxBracelMatVc BtrxBracelMatr;
	record BtrxCollectionVc BtrxCollectionr;
	record BtrxCollectionGroupVc BtrxCollectionGroupr;
	record GlobalItemVc GIr;
		
	setcompany(1,false); 
	// Collect Bitrix Name start
	BTRxBrandr.Code = "";
	while (loopMain(BTRxBrandr,1,true)) begin 
		vClass [BTRxBrandr.Code] = BTRxBrandr.Name;
	end;
	
	BTRxMaterialr.Code = "";
	while (loopMain(BTRxMaterialr,1,true)) begin 
		vClass [BTRxMaterialr.Code] = BTRxMaterialr.Name;
	end;
	BTRxColorr.Code = "";
	while (loopMain(BTRxColorr,1,true)) begin 
		vClass [BTRxColorr.Code] = BTRxColorr.Name;
	end;
	BTRxSizer.Code = "";
	while (loopMain(BTRxSizer,1,true)) begin 
		vClass [BTRxSizer.Code] = BTRxSizer.Name;
	end;	
	BTRxSexr.Code = "";
	while (loopMain(BTRxSexr,1,true)) begin 
		vClass [BTRxSexr.Code] = BTRxSexr.Name;
	end;	
	BTRxPlatingr.Code = "";
	while (loopMain(BTRxPlatingr,1,true)) begin 
		vClass [BTRxPlatingr.Code] = BTRxPlatingr.Name;
	end;	
	BTRxStoner.Code = "";
	while (loopMain(BTRxStoner,1,true)) begin 
		vClass [BTRxStoner.Code] = BTRxStoner.Name;
	end;	
	BTRxStrapr.Code = "";
	while (loopMain(BTRxStrapr,1,true)) begin 
		vClass [BTRxStrapr.Code] = BTRxStrapr.Name;
	end;	
	BTRxOdourr.Code = "";
	while (loopMain(BTRxOdourr,1,true)) begin 
		vClass [BTRxOdourr.Code] = BTRxOdourr.Name;
	end;	
	BtrxInternalCatr.Code = "";
	while (loopMain(BtrxInternalCatr,1,true)) begin 
		vClass [BtrxInternalCatr.Code] = BtrxInternalCatr.Name;
	end;	
	BtrxFirstLevelCatr.Code = "";
	while (loopMain(BtrxFirstLevelCatr,1,true)) begin 
		vClass [BtrxFirstLevelCatr.Code] = BtrxFirstLevelCatr.Name;
	end;	
	BtrxSecondLevelCatr.Code = "";
	while (loopMain(BtrxSecondLevelCatr,1,true)) begin 
		vClass [BtrxSecondLevelCatr.Code] = BtrxSecondLevelCatr.Name;
	end;	
	BtrxThirdLevelCatr.Code = "";
	while (loopMain(BtrxThirdLevelCatr,1,true)) begin 
		vClass [BtrxThirdLevelCatr.Code] = BtrxThirdLevelCatr.Name;
	end;	
	BtrxCertificater.Code = "";
	while (loopMain(BtrxCertificater,1,true)) begin 
		vClass [BtrxCertificater.Code] = BtrxCertificater.Name;
	end;	
	BtrxWatchMechanr.Code = "";
	while (loopMain(BtrxWatchMechanr,1,true)) begin 
		vClass [BtrxWatchMechanr.Code] = BtrxWatchMechanr.Name;
	end;	
	BtrxPowerReserver.Code = "";
	while (loopMain(BtrxPowerReserver,1,true)) begin 
		vClass [BtrxPowerReserver.Code] = BtrxPowerReserver.Name;
	end;	
	BtrxWatchGrader.Code = "";
	while (loopMain(BtrxWatchGrader,1,true)) begin 
		vClass [BtrxWatchGrader.Code] = BtrxWatchGrader.Name;
	end;	
	BtrxPhoneModelr.Code = "";
	while (loopMain(BtrxPhoneModelr,1,true)) begin 
		vClass [BtrxPhoneModelr.Code] = BtrxPhoneModelr.Name;
	end;	
	BtrxFillingr.Code = "";
	while (loopMain(BtrxFillingr,1,true)) begin 
		vClass [BtrxFillingr.Code] = BtrxFillingr.Name;
	end;	
	BtrxTyper.Code = "";
	while (loopMain(BtrxTyper,1,true)) begin 
		vClass [BtrxTyper.Code] = BtrxTyper.Name;
	end;	
	BtrxWatResr.Code = "";
	while (loopMain(BtrxWatResr,1,true)) begin 
		vClass [BtrxWatResr.Code] = BtrxWatResr.Name;
	end;	
	BtrxStrapMatr.Code = "";
	while (loopMain(BtrxStrapMatr,1,true)) begin 
		vClass [BtrxStrapMatr.Code] = BtrxStrapMatr.Name;
	end;	
	BtrxBracelMatr.Code = "";
	while (loopMain(BtrxBracelMatr,1,true)) begin 
		vClass [BtrxBracelMatr.Code] = BtrxBracelMatr.Name;
	end;	
	BtrxCollectionr.Code = "";
	while (loopMain(BtrxCollectionr,1,true)) begin 
		vClass [BtrxCollectionr.Code] = BtrxCollectionr.Name;
	end;	
	BtrxCollectionGroupr.Code = "";
	while (loopMain(BtrxCollectionGroupr,1,true)) begin 
		vClass [BtrxCollectionGroupr.Code] = BtrxCollectionGroupr.Name;
	end;	
	// end
	// Collect BPIclassification Name start
	vClass [""] = "";
	BPIBrandr.Code = "";
	while (loopMain(BPIBrandr,1,true)) begin 
		vClass [BPIBrandr.Code] = BPIBrandr.Name;
	end;
	
	BPICollectionr.Code = "";
	while (loopMain(BPICollectionr,1,true)) begin 
		vClass [BPICollectionr.Code] = BPICollectionr.Name;
	end;
	BPIGroupr.Code = "";
	while (loopMain(BPIGroupr,1,true)) begin 
		vClass [BPIGroupr.Code] = BPIGroupr.Name;
	end;
	BPISubGroupr.Code = "";
	while (loopMain(BPISubGroupr,1,true)) begin 
		vClass [BPISubGroupr.Code] = BPISubGroupr.Name;
	end;	
	BPICategoryr.Code = "";
	while (loopMain(BPICategoryr,1,true)) begin 
		vClass [BPICategoryr.Code] = BPICategoryr.Name;
	end;	
	BPIMaterialr.Code = "";
	while (loopMain(BPIMaterialr,1,true)) begin 
		vClass [BPIMaterialr.Code] = BPIMaterialr.Name;
	end;	
	BPIColorr.Code = "";
	while (loopMain(BPIColorr,1,true)) begin 
		vClass [BPIColorr.Code] = BPIColorr.Name;
	end;	
	BPIShaper.Code = "";
	while (loopMain(BPIShaper,1,true)) begin 
		vClass [BPIShaper.Code] = BPIShaper.Name;
	end;	
	BPISizer.Code = "";
	while (loopMain(BPISizer,1,true)) begin 
		vClass [BPISizer.Code] = BPISizer.Name;
	end;	
	BPIUser.Code = "";
	while (loopMain(BPIUser,1,true)) begin 
		vClass [BPIUser.Code] = BPIUser.Name;
	end;	
	BPISexr.Code = "";
	while (loopMain(BPISexr,1,true)) begin 
		vClass [BPISexr.Code] = BPISexr.Name;
	end;	
	BPIPlatingr.Code = "";
	while (loopMain(BPIPlatingr,1,true)) begin 
		vClass [BPIPlatingr.Code] = BPIPlatingr.Name;
	end;	
	BPIClarityr.Code = "";
	while (loopMain(BPIClarityr,1,true)) begin 
		vClass [BPIClarityr.Code] = BPIClarityr.Name;
	end;	
	BPICutr.Code = "";
	while (loopMain(BPICutr,1,true)) begin 
		vClass [BPICutr.Code] = BPICutr.Name;
	end;	
	BPIStoner.Code = "";
	while (loopMain(BPIStoner,1,true)) begin 
		vClass [BPIStoner.Code] = BPIStoner.Name;
	end;	
	BPIStrapr.Code = "";
	while (loopMain(BPIStrapr,1,true)) begin 
		vClass [BPIStrapr.Code] = BPIStrapr.Name;
	end;	
	BPIOdourr.Code = "";
	while (loopMain(BPIOdourr,1,true)) begin 
		vClass [BPIOdourr.Code] = BPIOdourr.Name;
	end;	
	vClass [""] = "";
  // end 
	
  addtexttoarea("GROUP<;>SUBGROUP<;>COLLECTION<;>CATEGORY<;>MATERIAL<;>COLOR<;>SHAPE<;>SIZE<;>USE<;>SEX<;>PLATING<;>CLARITY<;>WEIGHT<;>CUT<;>STONE<;>STRAP<;>ODOUR",aINParams);
	addtexttoarea("<;>FIRST_LEVEL_CATEGORY<;>SECOND_LEVEL_CATEGORY<;>THIRD_LEVEL_CATEGORY<;>BTRX_MATERIAL<;>INTER_CATEGORY<;>BTRX_PLATING<;>WATCH_MEHANISM<;>POWER_RESERVE<;>BTRX_STRAP<;>STRAP_COLUR<;>PLACER_SCATT",aINParams);
	addtexttoarea("<;>BTRX_COLOR<;>BTRX_ODOUR<;>PHONE_MODEL<;>BTRX_TYPE<;>STRAP_MATERIAL<;>COLLECTION<;>FILLING<;>BTRX_SEX<;>BTRX_SIZE<;>DEPTH<;>WIDTH<;>HEIGHT<;>DIAMETR<;>VOLUME<;>BTRX_WEIGHT",aINParams);
	addtexttoarea("<;>PROD_COLOR<;>CHAIN_MATERIAL<;>WATCH_GRADE_A<;>WATCH_GRADE_B<;>WATCH_GRADE_C<;>STONE_A<;>STONE_SCATT_A<;>STONE_B<;>SCATT_B<;>STONE_C<;>STONE_SCATT_C",aINParams);
	addtexttoarea("<;>BRACEL_MATERIAL<;>WATER_RESIST<;>SET_QUANT<;>FINGER_GIRTH<;>LIMITE_DGOOD" & chr(13) & chr(10),aINParams);

  blockload(Compb);
  rwcnt = matrowcnt(Compb);
  for(i=1;i<=rwcnt;i=i+1)begin	
  	setcompany(i,false);
  	matrowget(Compb,i-1,Comprw);
  	incomp = true;
  	if((CompanyIsJWLikeCompany(i) and i!=3))then begin
  		incomp = false;
  	end;
  	if(i==10)then begin
  		incomp = false;
  	end;
  	if(Comprw.ActiveStatus!=0)then begin
  		incomp = false;
  	end;
  	
  	logtext(0,Currentcompany);
  	if(incomp)then begin
  		resetloop(INr);
  		while(loopmain(INr,1,true))begin
  			if(nonblank(INr.BPIBrand) and nonblank(INr.BPICategory))then begin
					addtexttoarea(vClass[INr.BPIGroup] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPISubGroup] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPICollection] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPICategory] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIMaterial] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIColor] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIShape] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPISize] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIUse] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPISex] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIPlating] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIClarity] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIWeight] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPICut] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIStone] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIStrap] & "<;>",aINParams);
					addtexttoarea(vClass[INr.BPIOdour] & "<;>",aINParams);
					GIr.Code = INr.BPIBrand & "_" & INr.Code;
					if(ReadFirstMain(GIr,1,true) and nonblank(GIr.BTRxFirstLevCat)) then begin	
						addtexttoarea(vClass[GIr.BTRxFirstLevCat] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxSecondLevCat] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxThirdLevCat] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BPIMaterial] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxInterCatClass] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BPIPlating] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxWatchMechanism] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxPowerReserve] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BPIStrap] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxStrapColour] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxPlacerScatt] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BPIColor] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BPIOdour] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxPhoneModel] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxType] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxStrapMat] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BtrxCollection] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxFilling] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BPISex] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BPISize] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.StrDepth] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.StrWidth] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.StrHeight] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.StrBTRxDiam] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.StrVolume] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.StrWeight] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxProdColour] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxChainMaterial] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxWatchGradeA] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxWatchGradeB] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxWatchGradeC] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxStoneA] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxStoneScattA] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxStoneB] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxStoneScattB] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxStoneC] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxStoneScattC] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxBracelMat] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxWatterRes] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.StrBTRxSetQty] & "<;>",aINParams);
						addtexttoarea(vClass[GIr.BTRxFingerGirth] & "<;>",aINParams);
						addtexttoarea(vClass[INr.BTRxLimitedGood] & "<;>",aINParams);
					end;
					addtexttoarea(chr(13) & chr(10),aINParams);
				end;	
  		end;
  	end;
  end;
	
	writeareatofile(aINParams,"AllBenchMark.txt",0);
	
	weboutstring("Done");
return;
end;

global 
webpublic updating procedure WebDelAllBPU()
begin
record BigPUVc BPUr;

weboutstring("Begin");
SetCompany(18,false);
BPUr.SerNr = -1;
while(LoopMain(BPUr,1,true)) begin
	RecordDelete(BPUr);
	StepBack(BPUr);
end;	
weboutstring("Done");
return;
end;

global 
updating procedure FillAltCodeItemMn()
begin
record INVc INr;
record ConsItemVc CI2r;

INr.Code = "";
while(LoopMain(INr,1,true)) begin
	//if(Blank(INr.AlternativeCode)) then begin
		CI2r.Code = INr.Code;
		if(readfirstMain(CI2r,1,true))then begin
			if(blank(INr.BarCode)) then begin
				INr.BarCode = INr.AlternativeCode;
			end;
			INr.AlternativeCode = CI2r.LocCode;
			RecordStore(INr,true);
		end;
	//end;	
end;	
return;
end;
/*global 
webpublic updating procedure WebUpdAllINVc()
begin
record INVc INr;
boolean incomp;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
integer i,rwcnt;
weboutstring("Begin");
	blockload(Compb);
  rwcnt = matrowcnt(Compb);
for(i=1;i<=rwcnt;i=i+1)begin	
  	setcompany(i,false);
  	matrowget(Compb,i-1,Comprw);
  	incomp = true;
  	if((CompanyIsJWLikeCompany(i) and i!=3))then begin
  		incomp = false;
  	end;
  	if(i==10)then begin
  		incomp = false;
  	end;
  	if(Comprw.ActiveStatus!=0)then begin
  		incomp = false;
  	end;
  	
  	logtext(0,Currentcompany);
  	if(incomp)then begin
			INr.Code = "";
			while(LoopMain(INr,1,true)) begin
				if(INr.UpdateCost==0 or INr.SRUpdateCost==0) then begin
					INr.UpdateCost = 1;
					INr.SRUpdateCost = 1;
					RecordStore(INr,true);
				end;
			end;
			ResetLoop(INr);
		end;
end;		
weboutstring("Done");

return;
end;*/

procedure addheadertoexport(integer i)
begin
	
	exportstring("compnr");
	ExportPadString(i & chr(13) & chr(10),len(i & chr(13) & chr(9)),"",false);
	ExportPadString(chr(13) & chr(10),2,"",false);
	ExportPadString("format" & chr(13) & chr(10),len("format")+2,"",false);
	ExportPadString("1	46	1	1	0	0	0	/	" & chr(13) & chr(10),len("1	46	1	1	0	0	0	/	")+2,"",false);
	ExportPadString(chr(13) & chr(10),2,"",false);
	ExportPadString("codepage	UTF-8	" & chr(13) & chr(10),len("codepage	UTF-8	")+2,"",false);
	ExportPadString(chr(13) & chr(10),2,"",false);

return;
end;

global webpublic procedure WebExportAnyReg()
begin
	string 100 regname,blockname,dirrname;
	integer i,CompQty;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	
	BlockLoad(Compb);	
	
	regname = WebGetArg("regname");
	blockname = WebGetArg("blockname");
	
	
	if(blank(regname) and blank(blockname))then begin
		WebOutString("regname or blockname");
	end else begin	
		if(nonblank(regname))then begin
			CompQty = matrowcnt(Compb);
			dirrname = "ExportData";
			if (!DirExists(dirrname)) then begin
				CreateFolder(dirrname);
			end;
			for (i=0;i<CompQty;i=i+1) begin
				matrowget(Compb,i,Comprw);
				if(Comprw.ActiveStatus==0) then begin
					SetCompany(i+1,false);
					createfile(dirrname & "\\" & regname & i+1 & ".txt");
					logtext(0,dirrname & "\\" & regname & i+1 & ".txt");
					CloseFile;
					openexportfile(dirrname & "\\" & regname & i+1 & ".txt",true);
					addheadertoexport(i+1);
					RegisterExport(regname);
					CloseFile;
				end;
			end;
		end;
		if(nonblank(blockname))then begin
			CompQty = matrowcnt(Compb);
			dirrname = "ExportData";
			if (!DirExists(dirrname)) then begin
				CreateFolder(dirrname);
			end;
			for (i=0;i<CompQty;i=i+1) begin
				matrowget(Compb,i,Comprw);
				if(Comprw.ActiveStatus==0) then begin
					SetCompany(i+1,false);
					createfile(dirrname & "\\" & blockname & i+1 & ".txt");
					CloseFile;
					openexportfile(dirrname & "\\" & blockname & i+1 & ".txt",true);
					addheadertoexport(i+1);
					BlockExport(blockname);
					CloseFile;
				end;
			end;
		end;
	end;
	runprogram("chmod","-R a+rw ExportData");
return;
end;


global webpublic procedure WebWriteRegistersFiles()
begin
integer i,curcomp,CompQty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
area PayMode,PayDeal,Buttons,Controll;
string 255 filename;
record PDVc PayDealr; // 
record PMBlock PMRec;
record POSButtonsVc POSr;
record OTCheckBlock OTCr;
record AccBlock Accb;
	
	BlockLoad(Accb);
	BlockLoad(PMRec);
	BlockLoad(Compb);	
	BlockLoad(OTCr);	
	CompQty = matrowcnt(Compb);
	curcomp = currentcompany;
	
	filename = "NewFileData\\";
		for (i=0;i<CompQty;i=i+1) begin
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0) then begin
				SetCompany(i+1,false);
					/*PayDealr.Code = "";
					While(LoopMain(PayDealr,1,true)) begin 
						AddRecordToArea(PayDealr,"PDVc",PayDeal);
					end;
					if(CountRecords("PDVc")>0) then begin
						writeareatofile(PayDeal,filename & i+1 & "PayDeal.txt",0);
					end;	
					setareazerosize(PayDeal);
					ResetLoop(PayDealr);

					POSr.Page = -1;
					While(LoopKey("Page",POSr,1,true)) begin 
						AddRecordToArea(POSr,"POSButtonsVc",Buttons);
					end;
					ResetLoop(POSr);
					if(CountRecords("POSButtonsVc")>0) then begin
						writeareatofile(Buttons,filename & i+1 & "POSButton.txt",0);
					end;	
					setareazerosize(Buttons);
					*/
					
					/*createfile(filename & i+1 & "OTCheckBlock.txt");
					CloseFile;
					openexportfile(filename & i+1 & "OTCheckBlock.txt",true);
					addheadertoexport(i+1);
					BlockExport("OTCheckBlock");
					closefile*/
					
					createfile(filename & i+1 & "PDVc.txt");
					CloseFile;
					openexportfile(filename & i+1 & "PDVc.txt",true);
					addheadertoexport(i+1);
					RegisterExport("PDVc");
					CloseFile;
					
					/*createfile(filename & i+1 & "POSButtonsVc.txt");
					CloseFile;
					openexportfile(filename & i+1 & "POSButtonsVc.txt",true);
					addheadertoexport(i+1);
					RegisterExport("POSButtonsVc");
					CloseFile;*/
					
					createfile(filename & i+1 & "PMBlock.txt");
					CloseFile;
					openexportfile(filename & i+1 & "PMBlock.txt",true);
					addheadertoexport(i+1);
					BlockExport("PMBlock");
					closefile;
					
					createfile(filename & i+1 & "VATCodeBlock.txt");
					CloseFile;
					openexportfile(filename & i+1 & "VATCodeBlock.txt",true);
					addheadertoexport(i+1);
					BlockExport("VATCodeBlock");
					closefile;
										
					/*createfile(filename & i+1 & "AccBlock.txt");
					CloseFile;
					openexportfile(filename & i+1 & "AccBlock.txt",true);
					addheadertoexport(i+1);
					BlockExport("AccBlock");
					closefile;*/
					
					
			end;
		end;	
return;
end;


global webpublic procedure WebWriteRegistersTRVcFiles()
begin
integer i,curcomp,CompQty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
area PayMode,PayDeal,Buttons,Controll;
string 255 filename;
record PDVc PayDealr; // 
record PMBlock PMRec;
record POSButtonsVc POSr;
record OTCheckBlock OTCr;
BlockLoad(PMRec);
	BlockLoad(Compb);	
	BlockLoad(OTCr);	
	CompQty = matrowcnt(Compb);
	curcomp = currentcompany;
	
	filename = "NewFileDataTRVc\\";
		for (i=0;i<CompQty;i=i+1) begin
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0) then begin
				SetCompany(i+1,false);
					
					createfile(filename & i+1 & "TRVc.txt");
					CloseFile;
					openexportfile(filename & i+1 & "TRVc.txt",true);
					addheadertoexport(i+1);
					RegisterExport("TRVc");
					CloseFile;
					
			end;
		end;	
return;
end;





global webpublic procedure WebWriteRegistersPeriodFiles()
begin
integer i,curcomp,CompQty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
area PayMode,PayDeal,Buttons,Controll;
string 255 filename;
record PDVc PayDealr; // 
record PMBlock PMRec;
record POSButtonsVc POSr;
record PeriodBlock OTCr;

	BlockLoad(PMRec);
	BlockLoad(Compb);	
	
	CompQty = matrowcnt(Compb);
	curcomp = currentcompany;
	
	filename = "NewFileDataPeriod\\";
		for (i=0;i<CompQty;i=i+1) begin
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0) then begin
				SetCompany(i+1,false);
					BlockLoad(OTCr);	
					
					createfile(filename & i+1 & "PeriodBlock.txt");
					CloseFile;
					openexportfile(filename & i+1 & "PeriodBlock.txt",true);
					addheadertoexport(i+1);
					BlockExport("PeriodBlock");
					CloseFile;
					
			end;
		end;	
return;
end;

global 
webpublic procedure WebFindINV()
begin
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
integer i,rwcnt;
record IPVc IVr;

blockload(Compb);
  rwcnt = matrowcnt(Compb);
	
	for(i=1;i<=rwcnt;i=i+1)begin	
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0)then begin
			SetCompany(i+1,false);
			resetloop(IVr);
			IVr.TransDate = currentdate;
			while(loopkey("TransDate",IVr,1,true))begin
				if(IVr.OKFlag==1)then begin
					weboutstring("Company " & Comprw.CompName & " invoice " & IVr.SerNr & " time " & "<BR>");
				end;
			end;
		end;
	end;
	
return;
end;

global 
webpublic procedure WebCreateFolders()
begin
record BPIBrandVc BPBr;
string 255 name;
integer i;

weboutstring("begin");
BPBr.Code = "";
while(LoopMain(BPBr,1,true)) begin
name = "";
	for(i=0;i<len(BPBr.Name);i=i+1) begin
		if((ASC(mid(BPBr.Name,i,1)) >= 65 and ASC(mid(BPBr.Name,i,1)) <= 90  ) or ( ASC(mid(BPBr.Name,i,1)) >= 97 and  ASC(mid(BPBr.Name,i,1)) <= 122 ) or (ASC(mid(BPBr.Name,i,1))==95)) then begin
			name = name & mid(BPBr.Name,i,1);
		end else begin
			name = name & "_";
		end;
	end;
	CreateFolder("webcust\\BRND_" & name);
end;
weboutstring("end");
return;
end;



// global webpublic updating procedure WebRestoreItemNames()
// begin
// integer i,curcomp,CompQty;
// record CompaniesBlock Compb;
// row CompaniesBlock Comprw;
// area PayMode,PayDeal,Buttons,Controll;
// record INVc INr,oldINr;
// record RhistVc RHr,lastRHr;
// string 255 tstr;
// boolean TrHs,testf,isupd;


	// BlockLoad(Compb);	
	
	// //i = -1;
	// i = stringtoint(webgetarg("compnr"));
	// isupd = webgetarg("isupd")=="update";
	
	// CompQty = matrowcnt(Compb);
	// curcomp = currentcompany;
		// if(i>0)then begin
			// //i = 7;
			// matrowget(Compb,i,Comprw);
			// if(Comprw.ActiveStatus==0) then begin
				// if(!CompanyIsJWLikeCompany(i+1) or i==2)then begin
					// SetCompany(i+1,false);
					// resetloop(INr);
					// INr.Code = "";
					// while(loopmain(INr,1,true))begin
						// tstr = BuildRecordIdStr(INr,currentcompany);
						// resetloop(RHr);
						// RHr.RecidStr = tstr;
						// TrHs = true;
						
						// while(loopbackkey("RecidStr",RHr,1,TrHs))begin
							// testf = true;
							// if(RHr.RecidStr!=tstr)then begin TrHs = false; testf = false; end;
							// if(RHr.accode==7)then begin testf = false; end;
							
							// if(testf)then begin
								// if(RHr.TransDate<stringtodate("25/04/2019"))then begin
									// TrHs = false;
								// end;
								// if(TrHs)then begin
								 // recordcopy(lastRHr,RHr);
								// end;
							// end;
						// end;
						// if(lastRHr.RecidStr==tstr)then begin
							// ReadOriginalRecord(lastRHr,oldINr);
							// if(oldINr.Code==INr.Code and oldINr.Name!=INr.Name and lastRHr.TransDate<=stringtodate("5/5/2019"))then begin
								// if(asc(left(INr.Name,1))>128)then begin
									// weboutstring(Comprw.CompName & "---" & INr.Code & "---" & INr.Name & "---" & lastRHr.TransDate & " oldname========== " & oldINr.Name);
									// weboutstring("<BR>");
									// if(isupd)then begin
										// INr.Name = oldINr.Name;
										// recordstore(INr,true);
									// end;
								// end;
							// end;
						// end;
					// end;
				// end;
			// end;
		// end;	
// return;
// end;






global 
webpublic updating procedure WebRestoreCCItemNames()
begin
integer i,curcomp,CompQty,consComp;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
area PayMode,PayDeal,Buttons,Controll;
record INVc INr,CINr;
record RhistVc RHr,lastRHr;
string 255 tstr;
boolean TrHs,testf,isupd;
record ConsItemVc CIr;

	

	BlockLoad(Compb);	
	
	i = -1;
	i = stringtoint(webgetarg("compnr"));
	isupd = webgetarg("isupd")=="update";
	
	CompQty = matrowcnt(Compb);
	curcomp = i;
	consComp = 18;
		if(i>0)then begin
			//i = 7;
			logtext(0,"Start");
			matrowget(Compb,i-1,Comprw);
			if(Comprw.ActiveStatus==0) then begin
				if(!CompanyIsJWLikeCompany(i) or i==3)then begin
					SetCompany(i,false);
					resetloop(INr);
					INr.Code = "";
					while(loopmain(INr,1,true))begin
						resetloop(RHr);
						SetCompany(consComp,false);
						CIr.LocCode = INr.Code;
						CIr.BrandCode = INr.BPIBrand;
						if(ReadFirstKey("LocCodeBrand",CIr,2,true))then begin
							CINr.Code = CIr.Code;
							if(ReadFirstMain(CINr,1,true))then begin
								if(CINr.Name!=INr.Name)then begin
									logtext(0, "OldName ----> " & CINr.Name & "  NewName ----->" & INr.Name);
									weboutstring( "OldName ----> " & CINr.Name & "  ("  & CIr.LocCode & "  " & CIr.BrandCode & ")  NewName -----> " & INr.Name & "  ("  & INr.Code &"  " & INr.BPIBrand & ")  CompName ----> " & Comprw.CompName);
									weboutstring("<BR>");
									CINr.Name = INr.Name;
									if(isupd)then begin
										RecordStore(CINr,true);
									end;
								end;
							end;
						end;
						ResetCompany(curcomp);
					end;
				end;
			end;
			logtext(0,"Stop");
		end;	

return;
end;


global webpublic updating procedure WebRestoreItemNames()
begin
integer i,curcomp,CompQty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
area PayMode,PayDeal,Buttons,Controll;
record INVc INr,oldINr;
record RhistVc RHr,lastRHr;
string 255 tstr;
boolean TrHs,testf,isupd;


	BlockLoad(Compb);	
	
	i = -1;
	i = stringtoint(webgetarg("compnr"));
	isupd = webgetarg("isupd")=="update";
	
	CompQty = matrowcnt(Compb);
	curcomp = currentcompany;
		if(i>0)then begin
			//i = 7;
			logtext(0,"Start");
			matrowget(Compb,i-1,Comprw);
			if(Comprw.ActiveStatus==0) then begin
				if(!CompanyIsJWLikeCompany(i) or i==3)then begin
					SetCompany(i,false);
					resetloop(INr);
					INr.Code = "";
					while(loopmain(INr,1,true))begin
						tstr = BuildRecordIdStr(INr,currentcompany);
						resetloop(RHr);
						RHr.RecidStr = tstr;
						TrHs = true;
						
						while(loopbackkey("RecidStr",RHr,1,TrHs))begin
							testf = true;
							if(RHr.RecidStr!=tstr)then begin TrHs = false; testf = false; end;
							if(RHr.accode==7)then begin testf = false; end;
							
							if(testf)then begin
								if(RHr.TransDate<stringtodate("25/04/2019"))then begin
									TrHs = false;
								end;
								if(TrHs)then begin
								 recordcopy(lastRHr,RHr);
								end;
							end;
						end;
						if(lastRHr.RecidStr==tstr)then begin
							ReadOriginalRecord(lastRHr,oldINr);
							if(oldINr.Code==INr.Code and oldINr.Name!=INr.Name and lastRHr.TransDate<=stringtodate("5/5/2019") and left(lastRHr.User,2)=="SA")then begin
								weboutstring(Comprw.CompName & "---" & INr.Code & "---" & INr.Name & "---" & lastRHr.TransDate & " oldname ========== " & oldINr.Name);
								logtext(0,Comprw.CompName & "---" & INr.Code & "---" & INr.Name & "---" & lastRHr.TransDate & " oldname ========== " & oldINr.Name);
								weboutstring("<BR>");
								if(isupd)then begin
									INr.Name = oldINr.Name;
									recordstore(INr,true);
								end;
							end;
						end;
					end;
				end;
			end;
			logtext(0,"Stop");
		end;	
return;
end;








global webpublic updating procedure WebReportItemNames()
begin
integer i,curcomp,CompQty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
area PayMode,PayDeal,Buttons,Controll;
record INVc INr,oldINr;
record RhistVc RHr,lastRHr;
string 255 tstr;
boolean TrHs,testf,isupd;

	logtext(0,"Start");

	BlockLoad(Compb);	
	
	//i = -1;
	i = stringtoint(webgetarg("compnr"));
	isupd = webgetarg("isupd")=="update";
	
	CompQty = matrowcnt(Compb);
	curcomp = currentcompany;
		// if(i>0)then begin
		// i = 7;
		for (i=0;i<CompQty;i=i+1) begin
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0) then begin
				if(!CompanyIsJWLikeCompany(i+1) or i==2)then begin
					SetCompany(i+1,false);
					resetloop(INr);
					INr.Code = "";
					while(loopmain(INr,1,true))begin
						tstr = BuildRecordIdStr(INr,currentcompany);
						resetloop(RHr);
						RHr.RecidStr = tstr;
						TrHs = true;
						
						while(loopbackkey("RecidStr",RHr,1,TrHs))begin
							testf = true;
							if(RHr.RecidStr!=tstr)then begin TrHs = false; testf = false; end;
							if(RHr.accode==7)then begin testf = false; end;
							
							if(testf)then begin
								if(RHr.TransDate>stringtodate("5/05/2019"))then begin
									testf = false;
								end;
								if(RHr.TransDate<stringtodate("1/03/2019"))then begin
									TrHs = false;
									testf = false;
								end;
								if(TrHs and testf)then begin
									recordcopy(lastRHr,RHr);
								end;
							end;
						end;
						ResetLoop(INr);
						if(lastRHr.RecidStr==tstr)then begin
							ReadOriginalRecord(lastRHr,oldINr);
							if(oldINr.Code==INr.Code and oldINr.Name!=INr.Name and left(lastRHr.User,2)=="SA")then begin
								weboutstring(Comprw.CompName & "---" & INr.Code & "---" & INr.Name & "---" & lastRHr.TransDate & " oldname========== " & oldINr.Name);
								logtext(0,Comprw.CompName & "---" & INr.Code & "---" & INr.Name & "---" & lastRHr.TransDate & " oldname========== " & oldINr.Name);
								weboutstring("<BR>");
								/*if(isupd)then begin
									INr.Name = oldINr.Name;
									recordstore(INr,true);
								end;*/
							end;
						end;
					end;
				end;
			end;
		end;	
	logtext(0,"End");
return;
end;



global webpublic updating procedure WebConcPlacesInCWH7()
begin
	record BPIBrandVc BPIBrandr;
	boolean TrHs;

	SetCompany(18,false);
	
	BPIBrandr.Code = "";
	TrHs = true;
	while (LoopMain(BPIBrandr,1,TrHs)) begin
		if(BPIBrandr.CWHCode == "CWH9" or BPIBrandr.CWHCode == "CWH10" or BPIBrandr.CWHCode == "CWH11") then begin
			logtext(0,BPIBrandr.Code & "  <>  " & BPIBrandr.CWHCode);
			BPIBrandr.CWHCode = "CWH7";
			recordStore(BPIBrandr,true);
		end;
	end;
	resetloop(BPIBrandr);
	return;
end;

global updating 
procedure CollectVIDaySaleMn(record RcVc RepSpec)
begin
record TRVc TRr,AccTRr,AccTRrCC;
row TRVc TRrw,AccTRrw;
record VIVc VIr,oldVIr;
row VIVc VIrw;
boolean TrHs,testf,TrHs2,testBrand;
integer cntrw,i,j,oscnt,rowCnt,oldCompany,comp,CompQty;
vector val saleSum,sumVi,saleSumRow;
val ct,allSum;
string 255 vewarn,tstr,obj,objects;
array string 255 tags,tags1;
array string 20 stores,brand;
record SHVc SHr;
record RetVc Retr;
record IVVc IVr;
vector string 255 upd,brandObj,objTVI,updCreadAcc;
vector boolean brands,create;
record BrandsBanDateBlock BBBr;
row BrandsBanDateBlock BBBrw;
record CompaniesBlock Compb;
record OTypeAddControlBlock OType;
row OTypeAddControlBlock OTypew;
row CompaniesBlock Comprw;
date loopDate;
integer rownr,curAccDiffIntYc;
val tmpval;
boolean createTr;
longint corrTRrNum;
val Acc60,Acc61;
record SDVc SDr;
record LocationVc Locr;
string 255 fobCust, objT;
vector integer companies;
integer pos;

testf = true;
oldCompany = currentCompany;
setCompany(18,false);
blockload(BBBr);
BlockLoad(Compb);
BlockLoad(OType);
ResetCompany(oldCompany);
CompQty = matrowcnt(Compb);
//-------------------------------Brands allowed-------------------------------------
//----------------------------------------------------------------------------------
logtext(0,"Start ");
curAccDiffIntYc = 301;
loopDate = RepSpec.sStartDate;
for(comp=0;comp<CompQty;comp=comp+1) begin
	matrowget(Compb,comp,Comprw);
	if(Comprw.ActiveStatus==0  and comp+1!=33 and comp+1!=29) then begin 
		SetCompany(comp+1,false);
		RecordClear(AccTRr);
		AccTRr.IntYc = curAccDiffIntYc;
		resetloop(AccTRr);
		TrHs = true;
		while(loopkey("IntYc",AccTRr,1,TrHs)) begin
			if (AccTRr.IntYc!=curAccDiffIntYc) then begin TrHs = false; end;
			if (TrHs) and (AccTRr.TransDate>=RepSpec.sStartDate) and (AccTRr.TransDate<=RepSpec.sEndDate) then begin
				DeleteTransaction(AccTRr.Number,AccTRr.IntYc);
				stepback(AccTRr);
			end;
		end;
	end;	
end;	

while(loopDate<=RepSpec.sEndDate) begin
	for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0 and comp+1!=18 and comp+1!=33 and comp+1!=29) then begin 
			SetCompany(comp+1,false);
			logtext(0,comp+1);
			createTr = false;
			RecordClear(AccTRrCC);
			RecordClear(AccTRr);
			RecordNew(AccTRr);
			RecordNew(AccTRrCC);
			AccTRr.TransDate = loopDate;
			AccTRr.IntYc = curAccDiffIntYc;
			TRr.Number = 9999999;
			TRr.IntYc = curAccDiffIntYc;
			TrHs = true;
			corrTRrNum = -1;
			while(LoopBackKey("Number",TRr,2,TrHs)) begin
				if(TRr.IntYc==curAccDiffIntYc) then begin
					TrHs = false;
					corrTRrNum = TRr.Number;
				end else begin 
					TrHs = false;
				end;
			end;
			ResetLoop(TRr);
			if (corrTRrNum<0) then begin
				corrTRrNum = 1;
			end else begin
				corrTRrNum = corrTRrNum + 1;
			end;
			AccTRr.Number = corrTRrNum;
			AccTRr.Comment = " (   )";
			AccTRr.RegDate = loopDate;
			AccTRr.RegTime = CurrentTime;
			rownr = 0;
			VIr.VECode = "FOB_SKLAD";
			VIr.TransDate = loopDate;
			TrHs2 = true;
			while(loopkey("VECodeTransDate",VIr,2,TrHs2)) begin
				testf = true;
				if(VIr.TransDate>loopDate) then begin testf = false; TrHs2 = false; end;
				if(VIr.VECode!="FOB_SKLAD" or VIr.OKPersons != "AUTO") then begin testf = false; end;
				if(testf) then begin
					if(VIr.PayVal==blankval or VIr.PayVal==0) then begin
						RecordDelete(VIr);
						StepBack(VIr);
					end else begin 	
						obj = "";
						ExtractObjectsByType(VIr.Objects,"STORE",stores,oscnt);
						obj = stores[0];
						if(blank(obj)) then begin obj = "blank"; end;
						sumVi[obj] = sumVi[obj] + VIr.PayVal;
						upd[obj] = VIr.SerNr;
					end;	
				end;
			end;
			ResetLoop(VIr);
			ResetLoop(TRr);
			TrHs = true;
			TRr.TransDate = loopDate;
			while(loopkey("TransDate",TRr,1,TrHs)) begin
				fobCust = "";
				testf = true;
				if(TRr.TransDate>loopDate) then begin testf = false; TrHs = false; end;
				if(TRr.IntYc!=SHYc and TRr.IntYc!=RetYc and TRr.IntYc!=IVYc and TRr.IntYc!=SDYc) then begin testf=false; end;
				if(testf) then begin 
					switch(TRr.IntYc) begin
						case SHYc: SHr.SerNr = TRr.Number;
								if(ReadFirstMain(SHr,1,true)) then begin
										if(SHr.ECOMMERCEOrdf==1 and SHr.ShipDate < StringToDate("01/03/2020")) then begin testf=false; end;
									Locr.Code = SHr.Location;
									ExtractObjectsByType(SHr.Objects,"STORE",stores,oscnt);
									objT = "";
									for(i=0;i<matrowcnt(OType);i=i+1) begin
										matRowget(OType,i,OTypew);
										if(OTypew.STORE == stores[0]) then begin
											pos = 0;
											tstr = "";
											ExtractObjWithSeparator(",",OTypew.SUBDI,true,pos,tstr);
											objT = tstr;
										end;
									end;
									if(blank(objT)) then begin
										switch(Comprw.CompName) begin
											case "Lladro": objT = "LL1";
											case "Rosental": objT = "RS1";
											case "Baccarat": objT = "BACCARAT";
											case "CreativeSystem": objT = "CREATIVE";
											case "Idea": objT = "IDEA";
											case "E-Commerce": objT = "ECOMMERCE";
										end;	
									end;
									if(ReadFirstMain(Locr,1,true)) then begin
										fobCust = Locr.FOBSuplier;
									end;
								end;
						case 	RetYc	: Retr.SerNr = TRr.Number;
								if(ReadFirstMain(Retr,1,true)) then begin
										if(Retr.ECOMMERCEOrdf==1 and Retr.TransDate < StringToDate("01/03/2020")) then begin testf=false; end;
									Locr.Code = Retr.Location;
									ExtractObjectsByType(Retr.Objects,"STORE",stores,oscnt);
									objT = "";
									for(i=0;i<matrowcnt(OType);i=i+1) begin
										matRowget(OType,i,OTypew);
										if(OTypew.STORE == stores[0]) then begin
											pos = 0;
											tstr = "";
											ExtractObjWithSeparator(",",OTypew.SUBDI,true,pos,tstr);
											objT = tstr;
										end;
									end;
									if(blank(objT)) then begin
										switch(Comprw.CompName) begin
											case "Lladro": objT = "LL1";
											case "Rosental": objT = "RS1";
											case "Baccarat": objT = "BACCARAT";
											case "CreativeSystem": objT = "CREATIVE";
											case "Idea": objT = "IDEA";
											case "E-Commerce": objT = "ECOMMERCE";
										end;	
									end;
									if(ReadFirstMain(Locr,1,true)) then begin
										fobCust = Locr.FOBSuplier;
									end;
								end;
						case 	IVYc	: IVr.SerNr = TRr.Number;
								if(ReadFirstMain(IVr,1,true)) then begin
									if(IVr.ECOMMERCEOrdf==1 and IVr.TransDate < StringToDate("01/03/2020")) then begin testf=false; end;
									Locr.Code = IVr.Location;
									ExtractObjectsByType(IVr.Objects,"STORE",stores,oscnt);
									objT = "";
									for(i=0;i<matrowcnt(OType);i=i+1) begin
										matRowget(OType,i,OTypew);
										if(OTypew.STORE == stores[0]) then begin
											pos = 0;
											tstr = "";
											ExtractObjWithSeparator(",",OTypew.SUBDI,true,pos,tstr);
											objT = tstr;
										end;
									end;
									if(blank(objT)) then begin
										switch(Comprw.CompName) begin
											case "Lladro": objT = "LL1";
											case "Rosental": objT = "RS1";
											case "Baccarat": objT = "BACCARAT";
											case "CreativeSystem": objT = "CREATIVE";
											case "Idea": objT = "IDEA";
											case "E-Commerce": objT = "ECOMMERCE";
										end;	
									end;
									if(ReadFirstMain(Locr,1,true)) then begin
										fobCust = Locr.FOBSuplier;
									end;
								end;
						case 	SDYc	: SDr.SerNr = TRr.Number;
								if(ReadFirstMain(SDr,1,true)) then begin
									if(SetInSet("CENTRAL_RETURN",SDr.Objects)) then begin testf=false; end;
									ExtractObjectsByType(SDr.Objects,"STORE",stores,oscnt);
									objT = "";
									for(i=0;i<matrowcnt(OType);i=i+1) begin
										matRowget(OType,i,OTypew);
										if(OTypew.STORE == stores[0]) then begin
											pos = 0;
											tstr = "";
											ExtractObjWithSeparator(",",OTypew.SUBDI,true,pos,tstr);
											objT = tstr;
										end;
									end;
									if(blank(objT)) then begin
										switch(Comprw.CompName) begin
											case "Lladro": objT = "LL1";
											case "Rosental": objT = "RS1";
											case "Baccarat": objT = "BACCARAT";
											case "CreativeSystem": objT = "CREATIVE";
											case "Idea": objT = "IDEA";
											case "E-Commerce": objT = "ECOMMERCE";
										end;	
									end;
									Locr.Code = SDr.Location;
									if(ReadFirstMain(Locr,1,true)) then begin
										fobCust = Locr.FOBSuplier;
									end;
								end;
								
					end;			
				end;
				if(testf) then begin
					cntrw = matrowcnt(TRr);
					Acc60 = 0;
					Acc61 = 0;
					for(i=0;i<cntrw;i=i+1) begin
						obj = "";
						matrowget(TRr,i,TRrw);
						if((TRrw.AccNumber=="45" or TRrw.AccNumber=="60" or TRrw.AccNumber=="61")and TRrw.ovst <> 1 and TRrw.stp==1) then begin
							ExtractObjectsByType(TRrw.Objects,"STORE",stores,oscnt);
							obj = stores[0];
							ClearArray(brand);
							ExtractObjectsByType(TRrw.Objects,"BRAND",brand,oscnt);
							if(blank(obj)) then begin 
								//  obj = "blank";  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 19:08 27.05.2020
								switch(Comprw.CompName) begin
									case "Lladro": obj = "LL1";
									case "Rosental": obj = "RS1";
									case "Baccarat": obj = "BACCARAT";
									case "CreativeSystem": obj = "CREATIVE";
									case "Idea": obj = "IDEA";
									case "E-Commerce": obj = "ECOMMERCE";
								end;	
							end;
							testBrand = false;
							rowCnt = matrowcnt(BBBr);
							for(j=0;j<rowCnt;j=j+1) begin
								matrowget(BBBr,j,BBBrw);
								if((SetInSet(brand[0],BBBrw.Object) or BBBrw.Object==brand[0]) and BBBrw.StartBanDate<=TRr.TransDate and nonblank(brand[0])) then begin testBrand = true; end;
							end;
							if(testBrand) then begin
								if(TRrw.AccNumber=="45") then begin
									if(TRr.IntYc!=SDYc) then begin
										companies[obj] = comp+1;
										saleSum[obj] = saleSum[obj] + TRrw.DebVal;
										saleSum[obj] = saleSum[obj] - TRrw.CredVal;
										brandObj[obj & brand[0]] = brand[0];
										saleSumRow[obj & brand[0]] = saleSumRow[obj & brand[0]] + TRrw.DebVal;
										saleSumRow[obj & brand[0]] = saleSumRow[obj & brand[0]] - TRrw.CredVal;
										create[obj] = true;
										brands[brand[0]] = true;
									end;	
								end else begin
									if(TRrw.AccNumber=="60") then begin
										Acc60 = TRrw.DebVal - TRrw.CredVal;
										matrowput(TRr,i,TRrw);
										matrowget(TRr,i+1,TRrw);
										if(TRrw.AccNumber=="61") then begin								
											Acc61 = TRrw.DebVal - TRrw.CredVal;
											if(Acc61+Acc60 == 0) then begin
												matrowput(TRr,i+1,TRrw);
												matrowget(TRr,i,TRrw);
												if(TRrw.DebVal!=0) then begin
													TRrw.DebVal = TRrw.DebVal*(-1);
												end;	
												if(TRrw.CredVal!=0) then begin
													TRrw.CredVal = TRrw.CredVal*(-1);
												end;	
												if(TRrw.CurDebVal!=0) then begin
													TRrw.CurDebVal = TRrw.CurDebVal*(-1);
												end;	
												if(TRrw.CurCredVal!=0) then begin
													TRrw.CurCredVal = TRrw.CurCredVal*(-1);
												end;	
												MatrowPut(AccTRr,rownr,TRrw);
												Matrowget(AccTRr,rownr,TRrw);
												ExtractObjectsByType(TRrw.Objects,"STORE",stores,oscnt);
												obj = stores[0];
												TRrw.Objects = RemoveObjectFromObjectList(TRrw.Objects,obj);
												TRrw.Objects = AddObjectToObjectList(TRrw.Objects,fobCust);
												TRrw.Objects = AddObjectToObjectList(TRrw.Objects,"CC");
												TRrw.Objects = AddObjectToObjectList(TRrw.Objects,objT);
												MatRowInsert(AccTRrCC,rownr,TRrw);
												MatrowPut(AccTRrCC,rownr,TRrw);
												rownr = rownr + 1;
												matrowget(TRr,i+1,TRrw);
												if(TRrw.DebVal!=0) then begin
													TRrw.DebVal = TRrw.DebVal*(-1);
												end;	
												if(TRrw.CredVal!=0) then begin
													TRrw.CredVal = TRrw.CredVal*(-1);
												end;	
												if(TRrw.CurDebVal!=0) then begin
													TRrw.CurDebVal = TRrw.CurDebVal*(-1);
												end;	
												if(TRrw.CurCredVal!=0) then begin
													TRrw.CurCredVal = TRrw.CurCredVal*(-1);
												end;	
												MatrowPut(AccTRr,rownr,TRrw);
												Matrowget(AccTRr,rownr,TRrw);
												ExtractObjectsByType(TRrw.Objects,"STORE",stores,oscnt);
												obj = stores[0];
												TRrw.Objects = RemoveObjectFromObjectList(TRrw.Objects,obj);
												TRrw.Objects = AddObjectToObjectList(TRrw.Objects,fobCust);
												TRrw.Objects = AddObjectToObjectList(TRrw.Objects,"CC");
												TRrw.Objects = AddObjectToObjectList(TRrw.Objects,objT);
												MatRowInsert(AccTRrCC,rownr,TRrw);
												MatrowPut(AccTRrCC,rownr,TRrw);
												rownr = rownr + 1;
												createTr = true;
											end;	
										end;
									end;	
								end;
							end;
						end;
					end;
				end;
			end;	

			if(createTr) then begin
				TRSumup(AccTRr,tmpval);
				RecordInsert(AccTRr,true);
				SetCompany(18,false);
				ResetLoop(TRr);
				TRr.Number = 9999999;
				TRr.IntYc = curAccDiffIntYc;
				TrHs = true;
				corrTRrNum = -1;
				while(LoopBackKey("Number",TRr,2,TrHs)) begin
					if(TRr.IntYc==curAccDiffIntYc) then begin
						TrHs = false;
						corrTRrNum = TRr.Number;
					end else begin 
						TrHs = false;
					end;
				end;
				if (corrTRrNum<0) then begin
					corrTRrNum = 1;
				end else begin
					corrTRrNum = corrTRrNum + 1;
				end;
				AccTRr.Number = corrTRrNum;
				for(i=0;i<matrowcnt(AccTRrCC);i=i+1) begin
					matrowget(AccTRrCC,i,TRrw);
					if(TRrw.DebVal!=0) then begin
						TRrw.DebVal = TRrw.DebVal*(-1);
					end;	
					if(TRrw.CredVal!=0) then begin
						TRrw.CredVal = TRrw.CredVal*(-1);
					end;	
					if(TRrw.CurDebVal!=0) then begin
						TRrw.CurDebVal = TRrw.CurDebVal*(-1);
					end;	
					if(TRrw.CurCredVal!=0) then begin
						TRrw.CurCredVal = TRrw.CurCredVal*(-1);
					end;	
					matrowput(AccTRr,i,TRrw);
				end;
				TRSumup(AccTRr,tmpval);
				RecordInsert(AccTRr,true);
				SetCompany(comp+1,false);
			END;
			ResetLoop(TRr);
			tstr = "";
			getvectortags(brands,tags1);
			getvectortags(saleSum,tags);
			if(tags.length>0) then begin 
				for(i=0;i<tags.length;i=i+1) begin
					if(create[tags[i]] and (companies[tags[i]]==(comp+1))) then begin
						allSum = 0;
						if(nonblank(upd[tags[i]])) then begin
							if(sumVi[tags[i]]!=Round(saleSum[tags[i]] + saleSum[tags[i]]*18/100 , SetRoundModeD(2))) then begin
								VIr.SerNr = upd[tags[i]];
								if(ReadFirstMain(VIr,1,true)) then begin
									RecordCopy(oldVIr,VIr);
									VIr.Objects = "";
									VIr.OKFlag = 0;
									if(RecordUpdate(oldVIr,VIr,true)==0) then begin end;
									RecordCopy(oldVIr,VIr);
									rowCnt = 0;
									VIVc_PasteVECode(VIr,0,false,true,vewarn);
									if(tags[i]!="blank") then begin VIr.Objects = VIr.Objects & "," & tags[i]; end;;
									VIr.APAcc = 60;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 20 05 2020 y. at 10:38:39 PM
									for(j=0;j<tags1.length;j=j+1) begin
										if(nonblank(brandObj[tags[i] & tags1[j]])) then begin
											matRowget(VIr,rowCnt,VIrw);
											VIrw.stp = 1;
											VIrw.Objects = tags[i] & "," & brandObj[tags[i] & tags1[j]];
											VIrw.AccNumber = "41/06";
											if (GetAccName(VIrw.AccNumber,tstr,60)) then begin end;
											VIrw.Comment = tstr; 
											VIrw.Sum = saleSumRow[tags[i] & tags1[j]];
											allSum = allSum + saleSumRow[tags[i] & tags1[j]];
											matrowput(VIr,rowCnt,VIrw);  
											rowCnt = rowCnt + 1;
										end;	
									end;	
									matRowget(VIr,rowCnt,VIrw);
									VIrw.stp = 1;
									VIrw.Objects = tags[i] & "," & brandObj[tags[i] & tags1[j]];
									VIrw.AccNumber = "19/03";
									if (GetAccName(VIrw.AccNumber,tstr,60)) then begin end;
									VIrw.Comment = tstr; 
									VIrw.Sum = Round(allSum * 18 / 100,SetRoundModeD(2));
									matrowput(VIr,rowCnt,VIrw);  
									VICalcVals(VIr);
									VISumup(VIr,ct); 
									VIr.PayVal = VIr.PayVal - ct;
									VIVc_PastePayVal(VIr);
									if(RecordUpdate(oldVIr,VIr,true)==0) then begin end;
									if(saleSum[tags[i]]!=0) then begin
										RecordCopy(oldVIr,VIr);
										VIr.OKFlag = 1;
										if(RecordUpdate(oldVIr,VIr,true)==0) then begin end;
									end;	
								end;	
							end;
						end else begin	
							if(saleSum[tags[i]]!=0) then begin
								RecordNew(VIr);
								VIr.VECode = "FOB_SKLAD";
								VIVc_PasteVECode(VIr,0,false,true,vewarn);
								VIr.SerNr = NextSerNr("VIVc",currentdate,-1,false,""); 
								VIr.TransDate = loopDate;
								if(blank(VIr.Objects) and tags[i]!="blank") then begin VIr.Objects = tags[i]; end;
								if(!SetInSet(tags[i],VIr.Objects) and tags[i]!="blank") then begin VIr.Objects = VIr.Objects & "," & tags[i]; end;
								rowCnt = 0;
								for(j=0;j<tags1.length;j=j+1) begin
									if(nonblank(brandObj[tags[i] & tags1[j]])) then begin
										matrowget(VIr,rowCnt,VIrw);
										VIrw.stp = 1;	
										VIrw.Objects = tags[i] & "," & brandObj[tags[i] & tags1[j]];
										VIrw.AccNumber = "41/06";
										if (GetAccName(VIrw.AccNumber,tstr,60)) then begin end;
										VIrw.Comment = tstr; 
										allSum = allSum + saleSumRow[tags[i] & tags1[j]];
										VIrw.Sum = saleSumRow[tags[i] & tags1[j]];
										matrowput(VIr,rowCnt,VIrw);
										rowCnt = rowCnt + 1;
									end;	
								end;	
								matRowget(VIr,rowCnt,VIrw);
								VIrw.stp = 1;
								VIrw.Objects = tags[i] & "," & brandObj[tags[i] & tags1[j]];
								VIrw.AccNumber = "19/03";
								if (GetAccName(VIrw.AccNumber,tstr,60)) then begin end;
								VIrw.Comment = tstr; 
								VIrw.Sum = Round(allSum * 18 / 100,SetRoundModeD(2));
								matrowput(VIr,rowCnt,VIrw);  
								VICalcVals(VIr);
								VISumup(VIr,ct); 
								VIr.PayVal = -ct;
								VIVc_PastePayVal(VIr);
								VIr.OKPersons = "AUTO";
								VIr.InvDate = loopDate;
								VIr.DueDate = loopDate;
								if (RecordInsert(VIr,true)) then begin end;
								RecordCopy(oldVIr,VIr);
								VIr.OKFlag = 1;
								if(RecordUpdate(oldVIr,VIr,true)==0) then begin  logtext(0,"VIr created " & VIr.SerNr & " company " & currentcompany); end;
							end;	
						end;
					end;	
				end;	
			end;
			ClearVector(saleSum);
			ClearVector(sumVi);
			ClearVector(create);
			ClearVector(saleSumRow);
			ClearVector(brandObj);
			ClearVector(upd);
			ClearVector(updCreadAcc);
			ClearArray(stores);
			ClearArray(brand);
			ClearArray(tags);
			ClearArray(tags1);
			obj = "";
		end;	
	end;	
	loopDate = AddDay(loopDate,1);
end;	
ResetCompany(oldCompany);
logtext(0,"fin ");
return;
end;

global updating 
procedure DeleteVIDaySaleMn(record RcVc RepSpec)
begin
record TRVc TRr,AccTRr,AccTRrCC;
row TRVc TRrw,AccTRrw;
record VIVc VIr,oldVIr;
row VIVc VIrw;
boolean TrHs,testf,TrHs2,testBrand;
integer cntrw,i,j,oscnt,rowCnt,oldCompany,comp,CompQty;
vector val saleSum,sumVi,saleSumRow;
val ct,allSum;
string 255 vewarn,tstr,obj,objects;
array string 255 tags,tags1;
array string 20 stores,brand;
record SHVc SHr;
record RetVc Retr;
record IVVc IVr;
vector string 255 upd,brandObj,objTVI,updCreadAcc;
vector boolean brands,create;
record BrandsBanDateBlock BBBr;
row BrandsBanDateBlock BBBrw;
record CompaniesBlock Compb;
record OTypeAddControlBlock OType;
row OTypeAddControlBlock OTypew;
row CompaniesBlock Comprw;
date loopDate;
integer rownr,curAccDiffIntYc;
val tmpval;
boolean createTr;
longint corrTRrNum;
val Acc60,Acc61;
record SDVc SDr;
record LocationVc Locr;
string 255 fobCust, objT;

testf = true;
oldCompany = currentCompany;
BlockLoad(Compb);
CompQty = matrowcnt(Compb);
//-------------------------------Brands allowed-------------------------------------
//----------------------------------------------------------------------------------
logtext(0,"Start ");

for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0 and comp+1!=18 and comp+1!=33 and comp+1!=29) then begin 
			SetCompany(comp+1,false);
			logtext(0,comp+1);
			VIr.VECode = "FOB_SKLAD";
			VIr.InvDate = RepSpec.sStartDate;
			TrHs2 = true;
			while(loopkey("VEDate",VIr,2,TrHs2)) begin
				testf = true;
				if(VIr.InvDate>RepSpec.sEndDate) then begin testf = false; TrHs2 = false; end;
				if(VIr.VECode!="FOB_SKLAD" or VIr.OKPersons != "AUTO") then begin testf = false; end;
				if(testf) then begin
					RecordCopy(oldVIr,VIr);
					VIr.OKFlag = 0;
					create[VIr.SerNr & ":" &  comp+1] = true;
					if(RecordUpdate(oldVIr,VIr,true)==0) then begin  end;
					RecordDelete(VIr);
					StepBack(VIr);
				end;	
			end;
			ResetLoop(VIr);
		end;
end;	
getvectortags(create,tags);
SetCompany(18,false);
for(i=0;i<tags.length;i=i+1) begin
	IVr.OfficialSerNr = tags[i];
	if(ReadFirstKey("OfficialSerNrDate",IVr,1,true)) then begin
		RecordDelete(IVr);
	end;
end;
ResetCompany(oldCompany);

logtext(0,"fin ");
return;
end;

global updating 
procedure ReCollectObjSHECommerceMn(record RcVc RepSpec)
begin
record TRVc TRr,AccTRr,AccTRrCC;
row TRVc TRrw,AccTRrw;
record VIVc VIr,oldVIr;
row VIVc VIrw;
boolean TrHs,testf,TrHs2,testBrand;
integer cntrw,i,j,oscnt,rowCnt,oldCompany,comp,CompQty;
vector val saleSum,sumVi,saleSumRow;
val ct,allSum;
string 255 vewarn,tstr,obj,objects;
array string 255 tags,tags1;
array string 20 stores,brand;
record SHVc SHr;
row SHVc SHrw;
record RetVc Retr;
row RetVc Retrw;
record IVVc IVr;
vector string 255 upd,brandObj,objTVI,updCreadAcc;
vector boolean brands,create;
record BrandsBanDateBlock BBBr;
row BrandsBanDateBlock BBBrw;
record CompaniesBlock Compb;
record OTypeAddControlBlock OType;
row OTypeAddControlBlock OTypew;
row CompaniesBlock Comprw;
date loopDate;
integer rownr,curAccDiffIntYc;
val tmpval;
boolean createTr;
longint corrTRrNum;
val Acc60,Acc61;
record SDVc SDr;
record LocationVc Locr;
string 255 fobCust, objT;
record BPIBrandVc BPIBr;
record INVc INr;
record CUVc CUr;

testf = true;
oldCompany = currentCompany;
BlockLoad(Compb);
CompQty = matrowcnt(Compb);
//-------------------------------Brands allowed-------------------------------------
//----------------------------------------------------------------------------------
logtext(0,"Start ");

for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0 and comp+1!=18 and comp+1!=33 and comp+1!=29) then begin 
			SetCompany(comp+1,false);
			logtext(0,comp+1);
			SHr.ShipDate = RepSpec.sStartDate;
			TrHs2 = true;
			while(loopkey("ShipDate",SHr,1,TrHs2)) begin
				testf = true;
				if(SHr.ShipDate>RepSpec.sEndDate) then begin testf = false; TrHs2 = false; end;
				if(SHr.CustCode!="FOBE_COMMERCE" and SHr.CustCode!="NOFULLNAME") then begin testf = false; end;
				if(testf) then begin
					TRr.IntYc = SHYc;
					TRr.Number = SHr.SerNr;
					if(ReadFirstMain(TRr,2,true)) then begin
						j = 0;
						for(i=0;i<matrowcnt(SHr);i=i+1) begin
							matRowget(SHr,i,SHrw);
							INr.Code = SHrw.ArtCode;
							if(ReadFirstMain(INr,1,true)) then begin
								BPIBr.Code = INr.BPIBrand;
								if(ReadFirstMain(BPIBr,1,true)) then begin
									oscnt = 0;
									ExtractObj(BPIBr.Vendor,oscnt,tstr);
									CUr.Code = tstr;
									if(ReadFirstMain(CUr,1,true)) then begin
										matrowget(TRr,i+j,TRrw);
										if(!SetInSet(CUr.VEObjects,TRrw.Objects)) then begin
											if(blank(TRrw.Objects)) then begin TRrw.Objects = CUr.VEObjects; 
											end else begin TRrw.Objects = TRrw.Objects & "," & CUr.VEObjects; end;
										end;
										matrowput(TRr,i+j,TRrw);
										matrowget(TRr,i+j+1,TRrw);
										if(TRrw.stp==1 and TRrw.ovst==0) then begin
											if(!SetInSet(CUr.VEObjects,TRrw.Objects)) then begin
												if(blank(TRrw.Objects)) then begin TRrw.Objects = CUr.VEObjects; 
												end else begin TRrw.Objects = TRrw.Objects & "," & CUr.VEObjects; end;
											end;
											matrowput(TRr,i+j+1,TRrw);
											if(!SetInSet(CUr.VEObjects,SHrw.Objects)) then begin
												if(blank(SHrw.Objects)) then begin SHrw.Objects = CUr.VEObjects; 
												end else begin SHrw.Objects = SHrw.Objects & "," & CUr.VEObjects; end;
											end;
											j = j + 1;
										end else begin 
											matrowput(TRr,i+j+1,TRrw);
											matrowget(TRr,i+j+2,TRrw);
											if(TRrw.stp==1 and TRrw.ovst==0) then begin
												if(!SetInSet(CUr.VEObjects,TRrw.Objects)) then begin
													if(blank(TRrw.Objects)) then begin TRrw.Objects = CUr.VEObjects; 
													end else begin TRrw.Objects = TRrw.Objects & "," & CUr.VEObjects; end;
												end;
												matrowput(TRr,i+j+2,TRrw);
												if(!SetInSet(CUr.VEObjects,SHrw.Objects)) then begin
													if(blank(SHrw.Objects)) then begin SHrw.Objects = CUr.VEObjects; 
													end else begin SHrw.Objects = SHrw.Objects & "," & CUr.VEObjects; end;
												end;
												j = j + 2;
											end else begin
												matrowput(TRr,i+j+2,TRrw);
												matrowget(TRr,i+j+3,TRrw);
												if(TRrw.stp==1 and TRrw.ovst==0) then begin
													if(!SetInSet(CUr.VEObjects,TRrw.Objects)) then begin
														if(blank(TRrw.Objects)) then begin TRrw.Objects = CUr.VEObjects; 
														end else begin TRrw.Objects = TRrw.Objects & "," & CUr.VEObjects; end;
													end;
													matrowput(TRr,i+j+3,TRrw);
													if(!SetInSet(CUr.VEObjects,SHrw.Objects)) then begin
														if(blank(SHrw.Objects)) then begin SHrw.Objects = CUr.VEObjects; 
														end else begin SHrw.Objects = SHrw.Objects & "," & CUr.VEObjects; end;
													end;
													j = j + 3;
												end;
											end;
										end;
									end;
								end;
							end;
							matRowput(SHr,i,SHrw);
						end;
						if(RecordStore(TRr,true)) then begin
						end;
						if(RecordStore(SHr,true)) then begin
						end;
					end;
				end;	
			end;
			ResetLoop(SHr);
			Retr.TransDate = RepSpec.sStartDate;
			TrHs2 = true;
			while(loopkey("TransDate",Retr,1,TrHs2)) begin
				testf = true;
				if(Retr.TransDate>RepSpec.sEndDate) then begin testf = false; TrHs2 = false; end;
				if(Retr.CustCode!="FOBE_COMMERCE" and Retr.CustCode!="NOFULLNAME") then begin testf = false; end;
				if(testf) then begin
					TRr.IntYc = RetYc;
					TRr.Number = Retr.SerNr;
					if(ReadFirstMain(TRr,2,true)) then begin
						j = 0;
						for(i=0;i<matrowcnt(Retr);i=i+1) begin
							matRowget(Retr,i,Retrw);
							INr.Code = Retrw.ArtCode;
							if(ReadFirstMain(INr,1,true)) then begin
								BPIBr.Code = INr.BPIBrand;
								if(ReadFirstMain(BPIBr,1,true)) then begin
									oscnt = 0;
									ExtractObj(BPIBr.Vendor,oscnt,tstr);
									CUr.Code = tstr;
									if(ReadFirstMain(CUr,1,true)) then begin
										matrowget(TRr,i+j,TRrw);
										if(!SetInSet(CUr.VEObjects,TRrw.Objects)) then begin
											if(blank(TRrw.Objects)) then begin TRrw.Objects = CUr.VEObjects; 
											end else begin TRrw.Objects = TRrw.Objects & "," & CUr.VEObjects; end;
										end;
										matrowput(TRr,i+j,TRrw);
										matrowget(TRr,i+j+1,TRrw);
										if(TRrw.stp==1 and TRrw.ovst==0) then begin
											if(!SetInSet(CUr.VEObjects,TRrw.Objects)) then begin
												if(blank(TRrw.Objects)) then begin TRrw.Objects = CUr.VEObjects; 
												end else begin TRrw.Objects = TRrw.Objects & "," & CUr.VEObjects; end;
											end;
											matrowput(TRr,i+j+1,TRrw);
											if(!SetInSet(CUr.VEObjects,Retrw.Objects)) then begin
												if(blank(Retrw.Objects)) then begin Retrw.Objects = CUr.VEObjects; 
												end else begin Retrw.Objects = Retrw.Objects & "," & CUr.VEObjects; end;
											end;
											j = j + 1;
										end else begin 
											matrowput(TRr,i+j+1,TRrw);
											matrowget(TRr,i+j+2,TRrw);
											if(TRrw.stp==1 and TRrw.ovst==0) then begin
												if(!SetInSet(CUr.VEObjects,TRrw.Objects)) then begin
													if(blank(TRrw.Objects)) then begin TRrw.Objects = CUr.VEObjects; 
													end else begin TRrw.Objects = TRrw.Objects & "," & CUr.VEObjects; end;
												end;
												matrowput(TRr,i+j+2,TRrw);
												if(!SetInSet(CUr.VEObjects,Retrw.Objects)) then begin
													if(blank(Retrw.Objects)) then begin Retrw.Objects = CUr.VEObjects; 
													end else begin Retrw.Objects = Retrw.Objects & "," & CUr.VEObjects; end;
												end;
												j = j + 2;
											end else begin
												matrowput(TRr,i+j+2,TRrw);
												matrowget(TRr,i+j+3,TRrw);
												if(TRrw.stp==1 and TRrw.ovst==0) then begin
													if(!SetInSet(CUr.VEObjects,TRrw.Objects)) then begin
														if(blank(TRrw.Objects)) then begin TRrw.Objects = CUr.VEObjects; 
														end else begin TRrw.Objects = TRrw.Objects & "," & CUr.VEObjects; end;
													end;
													matrowput(TRr,i+j+3,TRrw);
													if(!SetInSet(CUr.VEObjects,Retrw.Objects)) then begin
														if(blank(Retrw.Objects)) then begin Retrw.Objects = CUr.VEObjects; 
														end else begin Retrw.Objects = Retrw.Objects & "," & CUr.VEObjects; end;
													end;
													j = j + 3;
												end;
											end;
										end;
									end;
								end;
							end;
							matRowput(Retr,i,Retrw);
						end;
						if(RecordStore(TRr,true)) then begin
						end;
						if(RecordStore(Retr,true)) then begin
						end;
					end;
				end;	
			end;
			ResetLoop(Retr);
		end;
end;	
ResetCompany(oldCompany);
logtext(0,"fin ");
return;
end;
/*global updating
procedure CollectVIDaySaleRecalkMn(record RcVc RepSpec)
begin
record TRVc TRr;
row TRVc TRrw;
record VIVc VIr,oldVIr;
row VIVc VIrw;
boolean TrHs,testf,TrHs2,testBrand;
integer cntrw,i,j,oscnt,rowCnt,comp,oldComp,CompQty;
vector val saleSum,sumVi,saleSumRow;
val ct;
string 255 vewarn,tstr,obj,objects;
array string 255 tags,tags1;
array string 20 stores,brand;
record SHVc SHr;
record RetVc Retr;
record IVVc IVr;
vector string 255 upd,brandObj;
vector boolean brands,create;
date loopDate;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
record BrandsBanDateBlock BBBr;
row BrandsBanDateBlock BBBrw;
testf = true;
//-------------------------------Brands allowed-------------------------------------
//----------------------------------------------------------------------------------
BlockLoad(Compb);

oldComp = currentcompany;
SetCompany(18,false);
blockload(BBBr);
ResetCompany(oldComp);
CompQty = matrowcnt(Compb);

loopDate = RepSpec.sStartDate;
while(loopDate<=RepSpec.sEndDate) begin
	for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0 and comp+1!=18 and comp+1!=33 and comp+1!=29) then begin 
			SetCompany(comp+1,false);
			logtext(0,comp+1);
			TRr.TransDate = loopDate;
			TrHs = true;
			VIr.VECode = "FOB_SKLAD";
			VIr.TransDate = loopDate;
			TrHs2 = true;
			while(loopkey("VECodeTransDate",VIr,2,TrHs2)) begin
				testf = true;
				if(VIr.TransDate>loopDate) then begin testf = false; TrHs2 = false; end;
				if(VIr.VECode!="FOB_SKLAD" or VIr.OKPersons != "AUTO") then begin testf = false; end;
				if(testf) then begin
					obj = "";
					ExtractObjectsByType(VIr.Objects,"STORE",stores,oscnt);
					obj = stores[0];
					if(blank(obj)) then begin obj = "blank"; end;
					upd[obj] = VIr.SerNr;
				end;
			end;
			ResetLoop(VIr);
			while(loopkey("TransDate",TRr,1,TrHs)) begin
				testf = true;
				if(TRr.TransDate>loopDate) then begin testf = false; TrHs = false; end;
				if(TRr.IntYc!=SHYc and TRr.IntYc!=RetYc and TRr.IntYc!=IVYc) then begin testf=false; end;
				if(testf) then begin 
					switch(TRr.IntYc) begin
						case SHYc: SHr.SerNr = TRr.Number;
								if(ReadFirstMain(SHr,1,true)) then begin
									if(SHr.ECOMMERCEOrdf==1) then begin testf=false; end;
								end;
						case 	RetYc	: Retr.SerNr = TRr.Number;
								if(ReadFirstMain(Retr,1,true)) then begin
									if(Retr.ECOMMERCEOrdf==1) then begin testf=false; end;
								end;
						case 	IVYc	: IVr.SerNr = TRr.Number;
								if(ReadFirstMain(IVr,1,true)) then begin
									if(IVr.ECOMMERCEOrdf==1) then begin testf=false; end;
								end;
					end;			
				end;
				if(testf) then begin
					cntrw = matrowcnt(TRr);
					for(i=0;i<cntrw;i=i+1) begin
						matrowget(TRr,i,TRrw);
						if(TRrw.AccNumber=="45" and TRrw.ovst <> 1 and TRrw.stp==1) then begin
							obj = "";
							testBrand = false;
							ExtractObjectsByType(TRrw.Objects,"STORE",stores,oscnt);
							obj = stores[0];
							ClearArray(brand);
							ExtractObjectsByType(TRrw.Objects,"BRAND",brand,oscnt);
							if(blank(obj)) then begin obj = "blank"; end;
							rowCnt = matrowcnt(BBBr);
							for(j=0;j<rowCnt;j=j+1) begin
								matrowget(BBBr,j,BBBrw);
								if((SetInSet(brand[0],BBBrw.Object) or BBBrw.Object==brand[0]) and BBBrw.StartBanDate<=TRr.TransDate and nonblank(brand[0])) then begin testBrand = true; end;
							end;
							if(testBrand) then begin
								saleSum[obj] = saleSum[obj] + TRrw.DebVal;
								saleSum[obj] = saleSum[obj] - TRrw.CredVal;
								brandObj[obj & brand[0]] = brand[0];
								saleSumRow[obj & brand[0]] = saleSumRow[obj & brand[0]] + TRrw.DebVal;
								saleSumRow[obj & brand[0]] = saleSumRow[obj & brand[0]] - TRrw.CredVal;
								create[obj] = true;
								brands[brand[0]] = true;
							end;
						end;
					end;
				end;
			end;	
			ResetLoop(TRr);
			getvectortags(brands,tags1);
			getvectortags(saleSum,tags);
			if(tags.length>0) then begin 
				for(i=0;i<tags.length;i=i+1) begin
					if(create[tags[i]) then begin
						VIr.SerNr = upd[tags[i]];
						if(ReadFirstMain(VIr,1,true)) then begin
							RecordCopy(oldVIr,VIr);
							VIr.OKFlag = 0;
							if(RecordUpdate(oldVIr,VIr,true)==0) then begin end;
							RecordCopy(oldVIr,VIr);
							rowCnt = 0;
							for(j=matrowcnt(VIr);j>=0;j=j-1) begin
								MatRowDelete(VIr,j);
							end;
							for(j=0;j<tags1.length;j=j+1) begin
								if(nonblank(brandObj[tags[i] & tags1[j]])) then begin
									VIrw.Objects = tags[i] & "," & brandObj[tags[i] & tags1[j]];
									VIrw.AccNumber = "41/06";
									if (GetAccName(VIrw.AccNumber,tstr,60)) then begin end;
									VIrw.Comment = tstr; 
									VIrw.Sum = saleSumRow[tags[i] & tags1[j]];
									logtext(0,VIrw.Sum );
									matrowput(VIr,rowCnt,VIrw);  
									rowCnt = rowCnt + 1;
								end;	
							end;	
							VICalcVals(VIr);
							VISumup(VIr,ct); 
							VIr.PayVal = VIr.PayVal - ct;
							VIVc_PastePayVal(VIr);
							if(RecordUpdate(oldVIr,VIr,true)==0) then begin end;
							if(saleSum[tags[i]]!=0) then begin
								RecordCopy(oldVIr,VIr);
								VIr.OKFlag = 1;
								if(RecordUpdate(oldVIr,VIr,true)==0) then begin end;
							end;	
						end;	
					end;	
				end;	
			end;	
			ClearVector(saleSum);
			ClearVector(sumVi);
			ClearVector(create);
			ClearVector(saleSumRow);
			ClearVector(brandObj);
			ClearVector(upd);
			ClearArray(tags);
			ClearArray(tags1);
		end;
	end;
	loopDate = AddDay(loopDate,1);
end;	
ResetCompany(oldComp);	
return;
end;*/


global
updating procedure CreateINConsItem(string code, string brand, integer company)
begin
record INVc ConsINr,UINr,OldConsINr,INr;
record ConsItemVc CIr;
boolean TrHs2;
string 255 OldCode;
integer c;
c = CurrentCompany;

CIr.LocCode = code;
CIr.BrandCode = brand;
if(ReadFirstKey("LocCodeBrand",CIr,2,true)==false) then begin 
	SetCompany(company,false);
	INr.Code = code;
	ReadFirstmain(INr,1,true);
	SetCompany(18,false);
	recordNew(UINr);
	recordNew(ConsINr);
	RecordCopy(ConsINr,INr);
	if(blank(ConsINr.BarCode)) then begin
		ConsINr.BarCode = INr.AlternativeCode;
	end;
	ConsINr.AlternativeCode = INr.Code;
	OldConsINr.Code = "IN_9999999";
	TrHs2 = true;
	while (LoopBackKey("Code",OldConsINr,1,TrHs2)) begin
		OldCode = OldConsINr.Code;
		TrHs2 = false;
	end;
	ResetLoop(OldConsINr);
	if(blank(OldCode)) then begin oldCode = "IN_0000000"; end;
	NextM4SerialNumber(OldCode,ConsINr.Code);
	ConsINr.UUID = UINr.UUID;
	CIr.LocCode = INr.Code;
	CIr.BrandCode = ConsINr.BPIBrand;
	if(!ReadFirstKey("LocCodeBrand",CIr,2,true))then begin	
		if(RecordStore(ConsINr,true))then begin
			logtext(0,ConsINr.Code & " Code");
			recordNew(CIr);
			CIr.Code = ConsINr.Code;
			CIr.LocCode = INr.Code;
			CIr.BrandCode = ConsINr.BPIBrand;
			if(RecordStore (CIr,true)) then begin end;	
		end;
	end;
end;
ResetCompany(c);
return;
end;	

global
updating procedure CreateINConsItemMn(record RcVc RepSpec)
begin
	CreateINConsItem(RepSpec.f1,RepSpec.f2,RepSpec.flags[0]);
return;
end;

global webpublic procedure WebCollectSDIn()
begin
	record SDVc SDr;
	boolean TrHs,testf;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer comp,oldComp,CompQty;
	logtext(0,"Start");
	blockload(Compb);
	oldComp = currentCompany;
	CompQty = matrowcnt(Compb);
	for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0 and comp+1!=18 and comp+1!=33) then begin 
			SetCompany(comp+1,false);
			weboutstring("<BR>");
			weboutstring("<BR>");
			weboutstring(Comprw.CompName);
			TrHs = true;
			SDr.TransDate = currentdate;
			while(LoopBackKey("TransDate",SDr,1,true)) begin
				testf = true;
				if(SDr.TransDate<addDay(currentdate,-3)) then begin testf = false; TrHs = false; end;
				if(SDr.OKFlag==0 or SDr.CostAcc!="41/06" or !SetInSet("CENTRAL_RETURN",SDr.Objects)) then begin testf = false; end;
				if(testf) then begin
					weboutstring("<BR>");
					weboutstring(SDr.SerNr);
				end;
			end;
			ResetLoop(SDr);
		end;
	end;	
	ResetCompany(oldComp);
	logtext(0,"End");
	return;
end;

global webpublic procedure WebCheckItem()
begin
	record INVc INr,IN1r;
	boolean TrHs,testf;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer comp,oldComp,CompQty;
	logtext(0,"Start");
	blockload(Compb);
	oldComp = currentCompany;
	CompQty = matrowcnt(Compb);
	for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0 and comp+1!=18 and comp+1!=33 and (!CompanyIsJWLikeCompany(comp) or comp+1 == 3)) then begin 
			SetCompany(comp+1,false);
			INr.Code = "";
			while(LoopMain(INr,1,true)) begin
				testf = true;
				if(Mid(INr.Code,0,3)!= "IN_") then begin testf = false; end;
				if(testf) then begin
					IN1r.Code = INr.AlternativeCode;
					if(ReadFirstMain(IN1r,1,true)) then begin
						weboutstring("<BR>");
						weboutstring(Comprw.CompName & " " & INr.Code & " " & INr.AlternativeCode & " " & INr.BPIBrand);
					end;	
				end;
			end;
			ResetLoop(INr);
		end;
	end;	
	ResetCompany(oldComp);
	logtext(0,"End");
	return;
end;

global webpublic updating procedure WebCheckItemBrendCC()
begin
	record INVc INr,IN2r;
	boolean TrHs,testf;
	vector string 255 brand;
	integer oldComp;
	record ItemHistVc IHr;
	logtext(0,"Start");;
	oldComp = currentCompany;
	SetCompany(18,false);
	INr.Code = "";
	while(LoopMain(INr,1,true)) begin
		testf = false;
		if(nonblank(brand[INr.AlternativeCode & "_" & INr.BPIBrand])) then begin testf = true; end;
		if(testf) then begin
			if(nonblank(INr.AlternativeCode) and nonblank(INr.BPIBrand)) then begin
				IN2r.Code = brand[INr.AlternativeCode & "_" & INr.BPIBrand];
				ReadFirstMain(IN2r,1,true);
				IHr.ArtCode = IN2r.Code;
				if(ReadFirstKey("ArtCode",IHr,1,true)) then begin 
					IHr.ArtCode = INr.Code;
					if(ReadFirstKey("ArtCode",IHr,1,true)) then begin 
						weboutstring("<BR>");
						weboutstring( "IS in " & " " & IN2r.Code & " " & IN2r.AlternativeCode & " " & IN2r.BPIBrand);
					end else begin 
						if(!INVcRecordRemoveTest(INr,INr,0,0)) then begin
							weboutstring("<BR>");
							weboutstring( INr.Code & " " & INr.AlternativeCode & " " & INr.BPIBrand);
						end else begin
							RecordDelete(INr);
						end;
					end;
				end else begin
					if(!INVcRecordRemoveTest(IN2r,IN2r,0,0)) then begin
						weboutstring("<BR>");
						weboutstring( IN2r.Code & " " & IN2r.AlternativeCode & " " & IN2r.BPIBrand);
					end else begin
						RecordDelete(IN2r);
					end;
				end;
			end;
		end else begin
			brand[INr.AlternativeCode & "_" & INr.BPIBrand] = INr.Code;
		end;
	end;
	ResetLoop(INr);
	ResetCompany(oldComp);
	logtext(0,"End");
	return;
end;

global webpublic procedure WebcheckAlternativeIn()
begin
	record INVc INr;
	boolean TrHs,testf;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer comp,oldComp,CompQty;
	vector boolean AltCode;
	logtext(0,"Start");
	oldComp = currentCompany;
	SetCompany(18,false);
		INr.Code = "";
		TrHs = true;
		while(LoopMain(INr,1,TrHs)) begin
			if(AltCode[INr.AlternativeCode]==true) then begin
				weboutstring("<BR>");
				weboutstring("<BR>");
				weboutstring(INr.AlternativeCode);
			end else begin
				AltCode[INr.AlternativeCode] = true;
			end;
		end;
	ResetCompany(oldComp);
	logtext(0,"End");
	return;
end;




// global webpublic updating procedure WebPriceChanges()
// begin
  // record PUVc PUr;
	// row PUVc PUrw;
	// vector val vPUPrice, vCurItemPrice;
	// vector string 255 vPUCur, vCurItemCurrency;
	// integer i,j,cicnt;
	// record ConsItemVc CIr;
	// record CompaniesBlock Compb;
	// row CompaniesBlock Comprw; 
	// integer Compcnt, compNo;
	// vector boolean ItemToCorrf;
	// record ItemHistVc IHr, oldIHr;
	// record INVc INr;
	// boolean TrHs, testf;
	// array string 255 aCorrArtCodes, aCorrItBrnds;
	// BlockLoad(Compb);
	
	// SetCompany(18,false);
	// PUr.SerNr = "";
	// weboutstring("   ________________________________________________________________________________________");
	// weboutstring("<BR>");
	// logtext(0,"1________________________________________________________________________________________");
	// j = 0;
	// while (loopmain(PUr,1,true)) begin
		// if(left(PUr.VECode,3)=="FOB" and PUr.OKFlag == 1 and PUr.CurncyCode!="AZN")then begin
			// for (i=0;i<matrowcnt(PUr);i=i+1) begin
				// matrowget (PUr,i,PUrw);
				// CIr.Code = PUrw.ArtCode;
				// if(ReadFirstMain(CIr,1,true))then begin
					// if(vPUPrice [CIr.LocCode & "_" & CIr.BrandCode]==blankval)then begin
						// vPUPrice [CIr.LocCode & "_" & CIr.BrandCode] = PUrw.UPrice;
						// vPUCur [CIr.LocCode & "_" & CIr.BrandCode]  = PUr.CurncyCode;
						// aCorrArtCodes[j] = CIr.LocCode;
						// aCorrItBrnds[j] = CIr.BrandCode;
						// j = j + 1;
						// weboutstring(PUrw.ArtCode & " --- " & vPUPrice [CIr.LocCode & "_" & CIr.BrandCode] & " --- " & PUrw.UPrice);
						// weboutstring("<BR>");
					// end;
				// end;
			// end;
		// end;
	// end;
	// cicnt = j;
	// ResetLoop (PUr);
	// weboutstring("      __________________________________________________");
	// weboutstring("<BR>");
	// logtext(0,"2________________________________________________________________________________________");
	// Compcnt = matrowcnt(Compb);
	// for (i=0;i<Compcnt;i=i+1) begin
		// compNo = i + 1;
		// if(compNo!=18 and compNo!=28 and compNo!=29 and compNo!=32 and compNo!=33)then begin
			// SetCompany(compNo,false);
			
			
			// weboutstring(" - " & compNo);
			// weboutstring("<BR>");
			
			
			// for (j=0;j<cicnt;j=j+1) begin
				// INr.Code = aCorrArtCodes[j];
				// if(ReadFirstMain(INr,1,true))then begin
					// if(INr.BPIBrand==aCorrItBrnds[j])then begin
						// ItemToCorrf[INr.Code & "_" & compNo] = true; 
						// vCurItemPrice[INr.Code & "_" & compNo] = vPUPrice [INr.Code & "_" & INr.BPIBrand]; 
						// vCurItemCurrency[INr.Code & "_" & compNo] = vPUCur [INr.Code & "_" & INr.BPIBrand]; 
					// end;
				// end;
			// end;
			
			
			// IHr.TransDate = CurrentDate;
			// TrHs = true;
			// while (LoopBackKey("TransDate",IHr,1,TrHs)) begin
				// testf = true;
				// if(IHr.TransDate<stringtodate("1/12/2019"))then begin TrHs = false; end;
				// if(!ItemToCorrf[IHr.ArtCode & "_" & compNo])then begin testf = false; end;
				// if(IHr.CurncyCode!="AZN")then begin testf = false; end;
				// if(TrHs and testf)then begin
					// RecordCopy(oldIHr,IHr);
					// IHr.TotCostPriceCurncy = vCurItemPrice[IHr.ArtCode & "_" & compNo] * AbsoluteVal(IHr.Qty);
					// if(IHr.RemQty>0)then begin
						// IHr.RemCostPriceCurncy = vCurItemPrice[IHr.ArtCode & "_" & compNo] * AbsoluteVal(IHr.RemQty);
					// end;
					// IHr.CurncyCode = vCurItemCurrency[IHr.ArtCode & "_" & compNo];
					// if(recordupdate(oldIHr,IHr,true)==0)then begin
						// weboutstring(" ItemHist in company " & IHr.TransDate & " --- " & IHr.ArtCode & " --- " & compNo & " --- " & IHr.FileName);
						// weboutstring("<BR>");
						// if(IHr.FileName=="PUVc")then begin
							// PUr.SerNr = IHr.TransNr;
							// if(ReadFirstMain(PUr,1,true))then begin
								// matrowget (PUr,IHr.Row,PUrw);
								// PUrw.UPrice = vCurItemPrice[IHr.ArtCode & "_" & compNo];
								// matrowput (PUr,IHr.Row,PUrw);
								// PUr.CurncyCode = vCurItemCurrency[IHr.ArtCode & "_" & compNo];
								// if(RecordStore(PUr,true))then begin
									// weboutstring(" PU in company " & PUr.SerNr & " --- " & PUrw.ArtCode & " --- " & compNo);
									// weboutstring("<BR>");
								// end;
							// end;
						// end;
					// end;
				// end;
			// end;
			// ResetLoop (IHr);
		// end;
	// end;
	
	// ResetCompany(18);
	// weboutstring("      FOB  CC__________________________________________________");
	// weboutstring("<BR>");
	// logtext(0,"3________________________________________________________________________________________");
	// PUr.SerNr = "";
	// while (loopmain(PUr,1,true)) begin
		// if(left(PUr.VECode,3)=="FOB" and PUr.CurncyCode=="AZN")then begin
			// for (i=0;i<matrowcnt(PUr);i=i+1) begin
				// matrowget (PUr,i,PUrw);
				// CIr.Code = PUrw.ArtCode;
				// if(ReadFirstMain(CIr,1,true))then begin
					// if(vPUPrice [CIr.LocCode & "_" & CIr.BrandCode]==blankval)then begin
						// PUrw.UPrice = vPUPrice [CIr.LocCode & "_" & CIr.BrandCode];
						// matrowput (PUr,i,PUrw);
						// if(RecordStore(PUr,true))then begin
							// weboutstring(" PU in CCpompany " & PUr.SerNr & " --- " & PUrw.ArtCode & " --- ");
							// weboutstring("<BR>");
							// IHr.FileName = "PUVc";
							// IHr.TransNr = PUr.SerNr;
							// IHr.Row = i;
							// TrHs = true;
							// while (LoopBackKey("FNTransNr",IHr,3,TrHs)) begin
								// if(IHr.FileName!="PUVc")then begin TrHs = false; end;
								// if(IHr.TransNr!=PUr.SerNr)then begin TrHs = false; end;
								// if(IHr.Row!=i)then begin TrHs = false; end;
								// if(IHr.ArtCode==PUrw.ArtCode and TrHs)then begin
									// RecordCopy(oldIHr,IHr);
									// IHr.TotCostPriceCurncy = PUrw.UPrice * AbsoluteVal(IHr.Qty);
									// if(IHr.RemQty>0)then begin
										// IHr.RemCostPriceCurncy = PUrw.UPrice * AbsoluteVal(IHr.RemQty);
									// end;
									// IHr.CurncyCode = vPUCur [CIr.LocCode & "_" & CIr.BrandCode];
									// if(recordupdate(oldIHr,IHr,true)==0)then begin
										// weboutstring(" ItemHist in CCompany " & IHr.TransDate & " --- " & IHr.ArtCode & " --- ");
										// weboutstring("<BR>");
									// end;
								// end;
							// end;
							// ResetLoop (IHr);
						// end;
					// end;
				// end;
			// end;
		// end;
	// end;
	// ResetLoop (PUr);
	
	
	// IHr.TransDate = CurrentDate;
	// TrHs = true;
	// while (LoopBackKey("TransDate",IHr,1,TrHs)) begin
		// testf = true;
		// if(IHr.TransDate<stringtodate("1/12/2019"))then begin TrHs = false; end;
		// CIr.Code = IHr.ArtCode;
		// if(ReadFirstMain(CIr,1,true))then begin end;
		// if(blank(vPUCur [CIr.LocCode & "_" & CIr.BrandCode]))then begin testf = false; end;
		// if(IHr.CurncyCode!="AZN")then begin testf = false; end;
		// if(TrHs and testf)then begin
			// RecordCopy(oldIHr,IHr);
			// IHr.TotCostPriceCurncy = vPUPrice[CIr.LocCode & "_" & CIr.BrandCode] * AbsoluteVal(IHr.Qty);
			// if(IHr.RemQty>0)then begin
				// IHr.RemCostPriceCurncy = vPUPrice[CIr.LocCode & "_" & CIr.BrandCode] * AbsoluteVal(IHr.RemQty);
			// end;
			// IHr.CurncyCode = vPUCur[CIr.LocCode & "_" & CIr.BrandCode];
			// if(recordupdate(oldIHr,IHr,true)==0)then begin
				// weboutstring(" ItemHist in CCompany " & IHr.TransDate & " --- " & IHr.ArtCode & " --- " & IHr.FileName);
				// weboutstring("<BR>");
			// end;
		// end;
	// end;
	// ResetLoop (IHr);
	
	// return;
// end;







global updating procedure ExchCurrInTr41AccRow(string FileName, longint DocNr)
begin
	record TRVc TRr, OldTRr;
	row TRVc TRrw, TR61rw;
	integer i,j,rwcnt, mtrw, i4120;
	array string 255 aArtCodes, aRowCrncy, a60and61Curr;
	array val aRowCostPrice, aChckFIFORV, a60and61Val, Chck60and61Val;
	array integer aItRows;
	boolean trf, TrHs, chckFIFORowf, f4102;
	record ItemHistVc IHr;
	record SDVc SDr;
	row SDVc SDrw;
	record SHVc SHr;
	row SHVc SHrw;
	record RetVc Retr;
	row RetVc Retrw;
	record RetPUVc RetPUr;
	row RetPUVc RetPUrw;
	record StockMovVc SMr;
	row StockMovVc SMrw;
	
	if(nonblank(FileName) and DocNr!=-1)then begin
		switch (FileName) begin
			case "SDVc":
									SDr.SerNr = DocNr;
									if(ReadFirstMain(SDr,1,true))then begin
										j = 0;
										for (i=0;i<matrowcnt(SDr);i=i+1) begin
											matrowget(SDr,i,SDrw);
											if(nonblank(SDrw.ArtCode))then begin
												aArtCodes[j] = SDrw.ArtCode;
												aItRows[j] = i;
												aChckFIFORV[j] = SDrw.FIFORowVal;
												chckFIFORowf = true;
												j=j+1;
											end;
										end;
										rwcnt = j;
									end;
									TRr.Number = DocNr;
									TRr.IntYc = SDYc;
									if (ReadFirstMain(TRr,2,true)) then begin
										RecordCopy(OldTRr,TRr);
										trf = true;
									end;
			case "SHVc":
									SHr.SerNr = DocNr;
									if(ReadFirstMain(SHr,1,true))then begin
										j = 0;
										for (i=0;i<matrowcnt(SHr);i=i+1) begin
											matrowget(SHr,i,SHrw);
											if(nonblank(SHrw.ArtCode) and SHrw.Ship>0)then begin
												aArtCodes[j] = SHrw.ArtCode;
												aItRows[j] = i;
												aChckFIFORV[j] = SHrw.FIFORowVal;
												chckFIFORowf = true;
												j=j+1;
											end;
										end;
										rwcnt = j;
									end;
									TRr.Number = DocNr;
									TRr.IntYc = SHYc;
									if (ReadFirstMain(TRr,2,true)) then begin
										RecordCopy(OldTRr,TRr);
										trf = true;
									end;
			case "RetVc":
									Retr.SerNr = DocNr;
									if(ReadFirstMain(Retr,1,true))then begin
										j = 0;
										for (i=0;i<matrowcnt(Retr);i=i+1) begin
											matrowget(Retr,i,Retrw);
											if(nonblank(Retrw.ArtCode))then begin
												aArtCodes[j] = Retrw.ArtCode;
												aItRows[j] = i;
												aChckFIFORV[j] = Retrw.Quant * Retrw.CostPrice;
												chckFIFORowf = true;
												j=j+1;
											end;
										end;
										rwcnt = j;
									end;
									TRr.Number = DocNr;
									TRr.IntYc = RetYc;
									if (ReadFirstMain(TRr,2,true)) then begin
										RecordCopy(OldTRr,TRr);
										trf = true;
									end;
			case "RetPUVc":
									RetPUr.SerNr = DocNr;
									if(ReadFirstMain(RetPUr,1,true))then begin
										j = 0;
										for (i=0;i<matrowcnt(RetPUr);i=i+1) begin
											matrowget(RetPUr,i,RetPUrw);
											if(nonblank(RetPUrw.ArtCode))then begin
												aArtCodes[j] = RetPUrw.ArtCode;
												aItRows[j] = i;
												aChckFIFORV[j] = RetPUrw.FIFORowVal;
												chckFIFORowf = true;
												j=j+1;
											end;
										end;
										rwcnt = j;
									end;
									TRr.Number = DocNr;
									TRr.IntYc = RetPUYc;
									if (ReadFirstMain(TRr,2,true)) then begin
										RecordCopy(OldTRr,TRr);
										trf = true;
									end;
		end;
		
		if(trf)then begin
			for (j=0;j<rwcnt;j=j+1) begin
				aRowCostPrice[j] = 0;
				aRowCrncy[j] = "";
				IHr.FileName = FileName;
				IHr.TransNr = DocNr;
				IHr.Row = aItRows[j];
				TrHs = true;
				while (LoopKey("FNTransNr",IHr,3,TrHs)) begin
					if(IHr.FileName!=FileName)then begin TrHs = false; end;
					if(IHr.TransNr!=DocNr)then begin TrHs = false; end;
					if(IHr.Row!=aItRows[j])then begin TrHs = false; end;
					if(TrHs)then begin
						aRowCostPrice[j] = aRowCostPrice[j] + IHr.TotCostPriceCurncy;
						aRowCrncy[j] = IHr.CurncyCode;
					end;
				end;
				ResetLoop(IHr);
			end;
			j = 0;
			i4120 = 0;
			mtrw = matrowcnt(TRr);
			for (i=0;i<mtrw;i=i+1) begin
				matrowget(TRr,i,TRrw);
				if(TRrw.AccNumber=="41/01" or TRrw.AccNumber=="41/02")then begin
					if (TRrw.AccNumber=="41/02") then begin  
						f4102 = true; 
						a60and61Curr[i4120] = aRowCrncy[j];
						a60and61Val[i4120] = aRowCostPrice[j];
						if(TRrw.DebVal!=blankval)then begin
							Chck60and61Val[i4120] = TRrw.DebVal;
						end else begin
							Chck60and61Val[i4120] = TRrw.CredVal;
						end;
						i4120 = i4120 + 1; 
					end;
					if (chckFIFORowf and (Round(aChckFIFORV[j],SetRoundModeD(2))==TRrw.DebVal or Round(aChckFIFORV[j],SetRoundModeD(2))==TRrw.CredVal)) then begin
						if (TRrw.DebVal!=blankval) then begin
							TRrw.CurDebVal = aRowCostPrice[j];
							TRrw.Curncy = aRowCrncy[j];
							matrowput (TRr,i,TRrw);
						end;
						if (TRrw.CredVal!=blankval) then begin
							TRrw.CurCredVal = aRowCostPrice[j];
							TRrw.Curncy = aRowCrncy[j];
							matrowput (TRr,i,TRrw);
						end;
						j = j + 1;
						if(rwcnt==j)then begin i = mtrw + 1; end;
					end;
					if(!chckFIFORowf)then begin
						if (TRrw.DebVal!=blankval) then begin
							TRrw.CurDebVal = aRowCostPrice[j];
							TRrw.Curncy = aRowCrncy[j];
							matrowput (TRr,i,TRrw);
						end;
						if (TRrw.CredVal!=blankval) then begin
							TRrw.CurCredVal = aRowCostPrice[j];
							TRrw.Curncy = aRowCrncy[j];
							matrowput (TRr,i,TRrw);
						end;
						j = j + 1;
						if(rwcnt==j)then begin i = mtrw + 1; end;
					end;
				end;
			end;
			
			j = 0;
			mtrw = matrowcnt(TRr);
			for (i=0;i<mtrw;i=i+1) begin
				matrowget(TRr,i,TRrw);
				matrowget(TRr,i+1,TR61rw);
				if(TRrw.AccNumber=="60" and TR61rw.AccNumber=="61" and (Chck60and61Val[j]==AbsoluteVal(TRrw.DebVal) or Chck60and61Val[j]==AbsoluteVal(TRrw.CredVal)))then begin
					if (TRrw.DebVal!=blankval) then begin
						TRrw.CurDebVal = a60and61Val[j] * (TRrw.DebVal / AbsoluteVal(TRrw.DebVal));
						TRrw.Curncy = a60and61Curr[j];
						matrowput (TRr,i,TRrw);
					end;
					if (TRrw.CredVal!=blankval) then begin
						TRrw.CurCredVal = a60and61Val[j] * (TRrw.CredVal / AbsoluteVal(TRrw.CredVal));
						TRrw.Curncy = a60and61Curr[j];
						matrowput (TRr,i,TRrw);
					end;
					i=i+1;
					matrowget(TRr,i,TRrw);
					if (TRrw.DebVal!=blankval) then begin
						TRrw.CurDebVal = a60and61Val[j] * (TRrw.DebVal / AbsoluteVal(TRrw.DebVal));
						TRrw.Curncy = a60and61Curr[j];
						matrowput (TRr,i,TRrw);
					end;
					if (TRrw.CredVal!=blankval) then begin
						TRrw.CurCredVal = a60and61Val[j] * (TRrw.CredVal / AbsoluteVal(TRrw.CredVal));
						TRrw.Curncy = a60and61Curr[j];
						matrowput (TRr,i,TRrw);
					end;
					j = j + 1;
					if(i4120==j)then begin i = mtrw + 1; end;
				end;
			end;
			
			
			if(recordupdate(oldTRr,TRr,true)==0) then begin
				logtext(0,"TRr Updated");
			end;
		end;
	end;
return;
end;

global updating procedure MyAddBalaceCUMn(record RcVc RepSpec)
begin
	record CSVc CSr;
	
	CSr.CustCode = RepSpec.f1;
  //CSr.BranchID = "";
  //CSr.Class = "";
  CSr.CurncyCode = RepSpec.f2; 
	readfirstmain(CSr,1,true);
  AddBalance(CSr,RepSpec.d1,"",0,"",0,"",0,"",0,"balance",RepSpec.vals0,"",0);
  AddBalance(CSr,RepSpec.d1,"",0,"",0,"",0,"",0,"paidvalue",RepSpec.vals0,"",0);
  
return;
end;

global updating procedure MyAddBalaceVEMn(record RcVc RepSpec)
begin
	record VSVc CSr;
	
	CSr.VECode = RepSpec.f1;
  //CSr.BranchID = "";
  //CSr.Class = "";
  CSr.CurncyCode = RepSpec.f2; 
	readfirstmain(CSr,1,true);
  AddBalance(CSr,RepSpec.d1,"",0,"",0,"",0,"",0,"vebalance",RepSpec.vals0,"",0);
  AddBalance(CSr,RepSpec.d1,"",0,"",0,"",0,"",0,"vepaidvalue",RepSpec.vals0,"",0);
  
return;
end;





global webpublic updating procedure WebSetStat()
begin
	record PUVc PUr;
	row PUVc PUrw;
	record POVc POr;
	row POVc POrw;
	boolean testf,TrHs,shipdf,shipd0f;
	integer pos,i,cntr;
	string 100 fname,lname,mname,tstr;
	val bc1v, PartTotal;
	vector val PPUItemQty;
	setCompany(28,false);
	TrHs = true;
	POr.SerNr = -1;
	while (loopMain(POr,1,true)) begin
		if (POr.IDStatus == "PO Confirmed") then begin
			shipdf = true;
			shipd0f = true;
			for (i=0;i<matrowcnt(POr);i=i+1) begin
				matrowget(POr,i,POrw);
				if(POrw.Shipd2 < POrw.Quant) then begin shipdf = false; end;
				if(POrw.Shipd2 > 0) then begin shipd0f = false; end; 
			end;		
			if (shipdf and !shipd0f) then begin
				POr.IDStatus = "PO Completed";
				logtext (0,POr.SerNr & "___" & "PO Completed");
				RecordStore (POr,true);
			end;
			if (!shipdf and !shipd0f) then begin
				POr.IDStatus = "PO Goods Delivered Partial";
				logtext (0,POr.SerNr & "___" & "PO Goods Delivered Partial");
				PUr.PONr = POr.SerNr;
				if (ReadFirstKey("PONr",PUr,1,true)) then begin 
					for (i=0;i<matrowcnt(PUr);i=i+1) begin
						matrowget(PUr,i,PUrw);
						PPUItemQty[PUrw.ArtCode] = PUrw.Quant;
					end;
					logtext (0,PUr.SerNr & "___" & "PU");
					for (i=0;i<matrowcnt(POr);i=i+1) begin
						matrowget(POr,i,POrw);
						if(PPUItemQty[POrw.ArtCode]>0) then begin
							PartTotal = PartTotal + (POrw.Sum / POrw.Quant * PPUItemQty[POrw.ArtCode]);
						end;
					end;		
					
					POr.PartDelSum4 = POr.PartDelSum4 + PartTotal;
				end;
				
				RecordStore (POr,true);
			end;
		end;
	end;
	


return;
end;



global webpublic updating procedure WebFillCustomerNames()
begin
	record CUvc CUr;
	boolean testf,TrHs;
	integer pos,i,cntr;
	string 100 fname,lname,mname,tstr;
	
	TrHs = true;
	
	
	while(loopmain(CUr,1,TrHs))begin
		testf = true;
		if(blank(CUr.Name))then begin testf = false; end;
		if(CUr.CUType==0)then begin testf = false; end;
		if(CUr.VEType==1)then begin testf = false; end;
		if(CUr.EmployeeType==0)then begin testf = false; end;//!!!!!!!!!!!!!
		if(CUr.blockedFlag==1)then begin testf = false; end;
		if(nonblank(CUr.CRMLName))then begin testf = false; end;
		if(nonblank(CUr.CRMName))then begin testf = false; end;
		if(nonblank(CUr.CRMPatr))then begin testf = false; end;
		
		if(fileexists("stop"))then begin
			TrHs = false;
		end;
		
		if(testf)then begin
			//logtext(0,cntr);
			cntr = cntr + 1;
			fname = "";
			lname = "";
			mname = "";
			
			pos = 0;
			tstr = "";
			i = 0;
			ExtractObjWithSeparator(" ",CUr.Name,true,pos,tstr);
			while(nonblank(tstr))begin
				if(nonblank(tstr))then begin					
					if(i>1)then begin
						if(len(tstr)<3 or tstr==uchr(120) & uchr(97) & uchr(110) & uchr(305) & uchr(109) or tstr=="xanum")then begin
							fname = fname & " " & tstr; 
						end else begin
							if(nonblank(mname))then begin
								mname = mname & " " & tstr;
							end else begin
								mname = tstr;
							end;
							i=i+1;
						end;
					end;
					if(i==1)then begin
						if(len(tstr)<3 or tstr==uchr(120) & uchr(97) & uchr(110) & uchr(305) & uchr(109) or tstr=="xanum")then begin
							lname = lname & " " & tstr; 
						end else begin
							fname = tstr;
							i=i+1;
						end;
					end;
					if(i==0)then begin
						lname = tstr;
						i=i+1;
					end;
				end;
				ExtractObjWithSeparator(" ",CUr.Name,true,pos,tstr);
			end;
			
			if(nonblank(lname) and blank(fname))then begin
				fname = lname;
				lname = "";
			end;
			CUr.CRMLName = lname;
			CUr.CRMName = fname;
			CUr.CRMPatr = mname;
			logtext(0,CUr.Code);
			//SendUpdateContactToCRM(CUr);
			recordstore(CUr,true);
			
			/*weboutstring(CUr.Code);
			weboutstring("===");
			weboutstring(CUr.Name);
			weboutstring("===");
			weboutstring(lname);
			weboutstring("===");
			weboutstring(fname);
			weboutstring("===");
			weboutstring(mname);
			weboutstring("<br>");*/
		end;
		
	end;

return;
end;

global updating procedure SortAccessMn(record RcVc RepSpec)
begin
record AccessVc Acsr, Acs2r;
row AccessVc Acsrw,Acs2rw;
boolean TrHs;
integer i,cnt,k,j,rows,accType;
vector string 255 type,name;
array string 255 tags,names;
Acsr.Code = "";
TrHs = true;
while(LoopMain(Acsr,1,TrHs)) begin
	cnt = matrowcnt(Acsr);
	for(j=0;j<cnt;j=j+1) begin
		matrowget(Acsr,0,Acsrw);
		if(Acsrw.AccType==0) then begin
			MatrowDelete(Acsr,0);
		end;
		for(i=cnt;i>0;i=i-1) begin
			matrowget(Acsr,i,Acsrw);
			matrowget(Acsr,i-1,Acs2rw);
			if(Acsrw.AccType<Acs2rw.AccType) then begin
				matrowget(Acsr,i,Acsrw);
				if(Acsrw.AccType==0) then begin
					MatrowDelete(Acsr,i);
				end else begin
					MatrowPut(Acsr,i-1,Acsrw);
					MatrowPut(Acsr,i,Acs2rw);
				end;	
			end;
		end;
	end;
	RecordStore(Acsr,true);
end;	
return;
end;

global 
updating procedure DellGlobalMn()
begin
	record GlobalItemVc GIr;
	record INVc INr;
	boolean TrHs, testf;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer comp,oldComp,CompQty;
	
	logtext(0,"start"); 
	oldComp = CurrentCompany;
	TrHs = true;
	blockload(Compb);
	oldComp = currentCompany;
	CompQty = matrowcnt(Compb);
	for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(comp+1) or comp+1==3))then begin
			SetCompany(comp+1,false);
			INr.Code = "";
			TrHs = true;
			while (LoopMain(INr,1,TrHs)) begin
				testf = false;
				if(INr.ConsgType!=0 and INr.ConsgType!=1) then begin testf = true; end;
				if(testf) then begin
					if(nonblank(INr.GlobalArtCode)) then begin
						GIr.HansaCode = INr.GlobalArtCode;
						if(ReadFirstKey("HansaCode",GIr,1,true)) then begin
							logtext(0,"Delete item- " & GIr.Code); 
							RecordDelete(GIr);
						end else begin
							INr.GlobalArtCode = "";
							RecordStore(INr,true);
						end;
					end;	
				end;
			end;
			ResetLoop(INr);
		end;	
	end;	
	ResetCompany(oldComp);
	logtext(0,"end"); 
return;
end;

global 
updating procedure AddObjMn()
begin
	record TRVc TRr,oldTRr;
	row TRVc TRrw;
	boolean TrHs, testf, update;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer comp,oldComp,CompQty;
	array string 20 stores;
	integer oscnt,cnt,i;
	logtext(0,"start"); 
	blockload(Compb);
	oldComp = currentCompany;
	CompQty = matrowcnt(Compb);
	for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0)then begin
			SetCompany(comp+1,false);
			TrHs = true;
			TRr.TransDate = CurrentDate;
			while(LoopBackKey("TransDate",TRr,1,TrHs)) begin
				if(TRr.TransDate<StringToDate("18/02/2020")) then begin TrHs = false; end;
				if(TrHs) then begin
					update = false;
					cnt = matrowcnt(TRr);
					for(i=0;i<cnt;i=i+1) begin
						matrowget(TRr,i,TRrw);
						ExtractObjectsByType(TRrw.Objects,"STORE",stores,oscnt);
						if(nonblank(stores[0])) then begin i = cnt; end;
					end;		
					RecordCopy(oldTRr,TRr)
					for(i=0;i<cnt;i=i+1) begin
						matrowget(TRr,i,TRrw);
						if(TRrw.Objects == "E801" or TRrw.Objects == "E8" or TRrw.Objects == "E800") then begin
							TRrw.Objects = AddObjectToObjectList(TRrw.Objects,stores[0]);
							update = true;						
						end;
						matrowput(TRr,i,TRrw);
					end;
					if(update) then begin 
						logtext(0," update TRr INTYc -" & TRr.IntYc & " number- " & TRr.Number & " in company- " & Comprw.ShortName);
						if (RecordUpdate(oldTRr,TRr,true)==0) then begin end;
					end;
					ClearArray(stores);
				end;
			end;
			ResetLoop(TRr);
		end;
	end;	
	SetCompany(oldComp,false);
	
	
return;
end;


global 
updating procedure AddObjKomisMn()
begin
	record TRVc TRr,oldTRr;
	row TRVc TRrw;
	boolean TrHs, testf, update;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer comp,oldComp,CompQty;
	array string 20 stores;
	integer oscnt,cnt,i;
	record NewComissPrc2Block CP2b;// Edit ************************** ABR 18.02.20
	
	
	logtext(0,"start"); 
	
	
	blockload(Compb);

	
	
	oldComp = currentCompany;
	CompQty = matrowcnt(Compb);
	for(comp=0;comp<CompQty;comp=comp+1) begin
		matrowget(Compb,comp,Comprw);
		if(Comprw.ActiveStatus==0)then begin
			SetCompany(comp+1,false);
			blockload(CP2b);
			TrHs = true;
			TRr.TransDate = CurrentDate;
			while(LoopBackKey("TransDate",TRr,1,TrHs)) begin
				if(TRr.TransDate<StringToDate("18/02/2020")) then begin TrHs = false; end;
				if(TrHs) then begin
					update = false;
					cnt = matrowcnt(TRr);

					RecordCopy(oldTRr,TRr)
					for(i=0;i<cnt;i=i+1) begin
						matrowget(TRr,i,TRrw);
						if(TRrw.AccNumber==CP2b.CorrAcc)then begin
							if(!setinset(CP2b.Objects,TRrw.Objects))then begin
								logtext(0,TRrw.AccNumber & " -> " & TRrw.Objects);
								TRrw.Objects = AddObjectToObjectList(TRrw.Objects,CP2b.Objects);
								logtext(0,TRrw.AccNumber & " -> " & TRrw.Objects);
								update = true;
							end;
						end;
						matrowput(TRr,i,TRrw);
					end;
					if(update) then begin 
						logtext(0," update TRr INTYc -" & TRr.IntYc & " number- " & TRr.Number & " in company- " & Comprw.ShortName & " for date "  & TRr.TransDate);
						if (RecordUpdate(oldTRr,TRr,true)==0) then begin end;
					end;
					ClearArray(stores);
				end;
			end;
			ResetLoop(TRr);
		end;
	end;	
	SetCompany(oldComp,false);
	
	
return;
end;


global webpublic updating procedure WebCreateCopyTPGlobalItem()
begin
	record GlobalItemVc  GIr, CopyGIr, TESTGIr;
	boolean testf, TrHs;
	array string 255 aTPCodes;
	LongInt i, TPcnt;

	GIr.Code = "";
	TrHs = true;
	i = 0;
	while (loopMain(GIr,1,TrHs)) begin
		if (GIr.IsVariant > 0) then  begin
			aTPCodes[i] = GIr.Code;
			i = i + 1;
		end;
	end;
	resetloop(GIr);
	TPcnt = i;
	for (i=0;i<TPcnt;i=i+1) begin
		GIr.Code = aTPCodes[i];
		if (ReadFirstMain(GIr,1,true)) then begin
			TESTGIr.Code = "CP_" & GIr.Code;
			if (!ReadFirstMain(TESTGIr,1,true)) then begin
				RecordCopy (CopyGIr,GIr);
				CopyGIr.Code = "CP_" & GIr.Code;
				CopyGIr.HansaCode = "CP_" & GIr.HansaCode;
				CopyGIr.IsVariant = 0;
				CopyGIr.MainItemFlag = 0;
				CopyGIr.MainCode = "";
				CopyGIr.TPCode = GIr.Code;
				if(RecordStore(CopyGIr,true)) then begin
					logtext(0,CopyGIr.Code);
					GIr.TPCPCode = CopyGIr.Code;
					RecordStore(GIr,true);
				end;
			end;
		end;
	end;
	
	
return;
end;


global webpublic updating procedure WebClearTPGlobalItem()
begin
	record GlobalItemVc  GIr, CopyGIr, TESTGIr;
	boolean testf, TrHs;
	array string 255 aTPCodes;
	LongInt i, TPcnt;

	GIr.Code = "";
	TrHs = true;
	while (loopMain(GIr,1,TrHs)) begin
		if (GIr.IsVariant>0 or nonblank(GIr.MainCode) or GIr.MainItemFlag>0) then  begin
			recordcopy(CopyGIr,GIr);
			GIr.IsVariant = 0;
			GIr.MainItemFlag = 0;
			GIr.MainCode = "";
			recordupdate(CopyGIr,GIr,true);
		end;
	end;
	
	
	
return;
end;






global webpublic updating procedure WebDeleteTPGlobalItem()
begin
	record GlobalItemVc  GIr, CopyGIr, TESTGIr;
	boolean testf, TrHs;
	array string 255 aTPCodes;
	LongInt i, TPcnt;

	GIr.Code = "";
	TrHs = true;
	i = 0;
	while (loopMain(GIr,1,TrHs)) begin
		if (left(GIr.Code,4) == "ZMAZ") then  begin
			aTPCodes[i] = GIr.Code;
			i = i + 1;
		end;
	end;
	resetloop(GIr);
	TPcnt = i;
	for (i=0;i<TPcnt;i=i+1) begin
		GIr.Code = aTPCodes[i];
		if (ReadFirstMain(GIr,1,true)) then begin
			recorddelete(GIr);
			logtext(0,"Deleted copy of IP  " & GIr.Code);
		end;
	end;
	
	
return;
end;





global webpublic updating procedure WebAddCPtoHansaCodeTPGlobalItem()
begin
	record GlobalItemVc  GIr, CopyGIr, TESTGIr;
	boolean testf, TrHs;
	array string 255 aTPCodes;
	LongInt i, TPcnt;

	GIr.Code = "";
	TrHs = true;
	i = 0;
	while (loopMain(GIr,1,TrHs)) begin
		if (left(GIr.Code,3) == "CP_" and left(GIr.HansaCode,3) != "CP") then  begin
			GIr.HansaCode = "CP_" & GIr.HansaCode;
			if(RecordStore(GIr,true)) then begin
				logtext(0,GIr.Code);
			end;
		end;
	end;
	resetloop(GIr);
	
return;
end;


global webpublic updating procedure WebClearCtsGlobalItem()
begin
	record GlobalItemVc  GIr, CopyGIr, TESTGIr;
	boolean testf, TrHs;
	array string 255 aTPCodes;
	LongInt i, TPcnt;

	GIr.Code = "";
	TrHs = true;
	i = 0;
	while (loopMain(GIr,1,TrHs)) begin
		GIr.BTRxFirstLevCat = "";
		GIr.BTRxSecondLevCat = "";
		GIr.BTRxThirdLevCat = "";
		if(RecordStore(GIr,true)) then begin
			logtext(0,GIr.Code);
		end;
	end;
	resetloop(GIr);
	
return;
end;


global webpublic updating procedure WebClearTypesOGlobalItem()
begin
	record GlobalItemVc  GIr, CopyGIr, TESTGIr;
	boolean testf, TrHs;
	array string 255 aTPCodes;
	LongInt i, TPcnt;
	//BTYPE0033
	GIr.Code = "";
	TrHs = true;
	i = 0;
	while (loopMain(GIr,1,TrHs)) begin
		if (GIr.BTRxType == "BTYPE0033") then begin
			GIr.BTRxType = "";
			if(RecordStore(GIr,true)) then begin
				logtext(0,GIr.Code);
			end;
		end;
	end;
	resetloop(GIr);
	
return;
end;



global webpublic updating procedure WebFillStandardBrabdCodesForGlobalItems()
begin
	record GlobalItemVc  GIr, CopyGIr, TESTGIr;
	boolean testf, TrHs;
	array string 255 aTPCodes;
	LongInt i, TPcnt;
	integer flushcnt;
	//BTYPE0033
	GIr.Code = "";
	TrHs = true;
	i = 0;
	while (loopMain(GIr,1,TrHs)) begin
		RecordCopy (CopyGIr,GIr);
		Gir.BPIBrand = left(GIr.Code,8);
		if (recordupdate(CopyGIr,GIr,true)==0) then begin
			logtext(0,GIr.Code);
		end;
		CheckFlush(flushcnt,1000);
	end;
	resetloop(GIr);
	
return;
end;




global webpublic updating procedure WebClearBtrxBrands()
begin
	record GlobalItemVc  GIr, CopyGIr, TESTGIr;
	record BtrxBrandVc Brandr;
	boolean testf, TrHs;
	array string 255 aTPCodes;
	LongInt i, TPcnt;
	Brandr.Code = "BRND9999";
	TrHs = true;
	while (loopBackKey("Code",Brandr,1,TrHs)) begin
		logtext(0,Brandr.Name);
		RecordDelete (Brandr);
	end;
	resetloop(Brandr);
	
return;
end;



global webpublic updating procedure WebExchCustFOBECOMtoECOMf()
begin
	record ORVc ORr;
	record IVVc IVr;
	record SHVc SHr;
	record RetVc Retr;
	integer compcnt, i;
	boolean TrHs;
	
	compcnt = 27;
	for (i=1;i<=compcnt;i=i+1) begin
		if(SetCompany(i,false)) then begin
			TrHs = true;
			ORr.CustCode = "FOBE_COMMERCE";
			while (loopkey("CustCode",ORr,1,TrHs)) begin
				if (ORr.CustCode != "FOBE_COMMERCE") begin TrHs = false; end;
				if (TrHs) then begin
					ORr.ECOMMERCEOrdf = 1;
					logtext (0,"Comp " & i & " ORr " & ORr.SerNr);
					recordStore(ORr,true);
				end;
			end;
			resetloop(ORr);
			
			TrHs = true;
			IVr.CustCode = "FOBE_COMMERCE";
			while (loopkey("CustCode",IVr,1,TrHs)) begin
				if (IVr.CustCode != "FOBE_COMMERCE") begin TrHs = false; end;
				if (TrHs) then begin
					IVr.ECOMMERCEOrdf = 1;
					logtext (0,"Comp " & i & " IVr " & IVr.SerNr);
					recordStore(IVr,true);
				end;
			end;
			resetloop(IVr);
			
			TrHs = true;
			SHr.CustCode = "FOBE_COMMERCE";
			while (loopkey("CustCode",SHr,1,TrHs)) begin
				if (SHr.CustCode != "FOBE_COMMERCE") begin TrHs = false; end;
				if (TrHs) then begin
					SHr.ECOMMERCEOrdf = 1;
					logtext (0,"Comp " & i & " SHr " & SHr.SerNr);
					recordStore(SHr,true);
				end;
			end;
			resetloop(SHr);
			
			TrHs = true;
			Retr.CustCode = "FOBE_COMMERCE";
			while (loopkey("CustCode",Retr,1,TrHs)) begin
				if (Retr.CustCode != "FOBE_COMMERCE") begin TrHs = false; end;
				if (TrHs) then begin
					Retr.ECOMMERCEOrdf = 1;
					logtext (0,"Comp " & i & " Retr " & Retr.SerNr);
					recordStore(Retr,true);
				end;
			end;
			resetloop(Retr);
		end;
	end;
	
	
return;
end;

global webpublic updating procedure WebCreateECDocsFromSH()
begin
	record ORVc ORr;
	record IVVc IVr;
	record SHVc SHr;
	record RetVc Retr;
	record PUVc PUr;
	integer compcnt, i;
	boolean TrHs, testf;
	vector boolean PUf;
	record RLinkVc RLr;
	
	
	compcnt = 27;
	for (i=1;i<=compcnt;i=i+1) begin
		if(SetCompany(i,false)) then begin	
			TrHs = true;
			SHr.CustCode = "FOBE_COMMERCE";
			while (loopbackkey("CustCode",SHr,1,TrHs)) begin
				testf = true;
				if (SHr.CustCode != "FOBE_COMMERCE") begin TrHs = false; testf = false; end;
				if (SHr.ShipDate < addDay(CurrentDate,-7)) then begin testf = false; end;
				if (testf) then begin
					if (SHr.OKFlag==1) then begin
						logtext (0,"Comp " & i & " SHr " & SHr.SerNr);
						ORLClassYellowColour(SHr.PRNr);
					end;
				end;
			end;
			resetloop(SHr);
		end;
	end;
	
	
return;
end;




global updating procedure UpdateStockInSetGlobalItem(string GIrCode)
begin
	record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	record GlobalItemSetVc ItemGISr, SetGISr;
	boolean TrHs, testf, TrHs2, testf2;
	vector val SetQty, SetPrice;
	vector boolean SetQtyf, SetNotExItf;
	longint i;
	val Qty, Price;
	roundmode rnd;
	array string 255 tags;


	rnd = DefaultValRoundoff;
	rnd.decimals = 0; 
	rnd.mode = kRoundingModeTruncate;
	
	
	TrHs = true;
	ItemGISr.SetUnitGlCode = GIrCode;
	while (loopkey("SetUnitGlCode",ItemGISr,1,TrHs)) begin
		if (ItemGISr.SetUnitGlCode!=GIrCode) then begin TrHs = false; end;
		if (TrHs) then begin
			SetGISr.SetGlCode = ItemGISr.SetGlCode;
			TrHs2 = true;
			while (loopmain(SetGISr,1,TrHs2)) begin
				if (SetGISr.SetGlCode!=ItemGISr.SetGlCode) then begin TrHs2 = false; end;
				if (TrHs2) then begin
					GIr.Code = SetGISr.SetUnitGlCode;
					if (ReadFirstMain(GIr,1,true)) then begin
						Qty = 0;
						Price = 0;
						for (i=0;i<matrowcnt(GIr);i=i+1) begin
							matrowget(GIr,i,GIrw);
							Qty = Qty + GIrw.Instock;
						end;
						Qty = round((Qty / SetGISr.SUQuant),rnd);
						Price = GIr.Price - GIr.Price / 100 * GIr.Rebate;
						Price = Price * SetGISr.SUQuant;
						logtext(0,Qty & "  " & SetGISr.SetGlCode);
						SetPrice[SetGISr.SetGlCode] = SetPrice[SetGISr.SetGlCode] + Price;
						if (!SetQtyf[SetGISr.SetGlCode]) then begin 
							SetQty[SetGISr.SetGlCode] = Qty;
							SetQtyf[SetGISr.SetGlCode] = true;
						end else begin
							if (Qty<SetQty[SetGISr.SetGlCode]) then begin
								SetQty[SetGISr.SetGlCode] = Qty;
							end;
						end;
					end else begin
						SetNotExItf[SetGISr.SetGlCode] = true;
					end;
				end;
			end;
			resetloop(SetGISr);
			if (!SetNotExItf[ItemGISr.SetGlCode] and SetQtyf[ItemGISr.SetGlCode]) then begin
				GIr.Code = ItemGISr.SetGlCode;
				if (ReadFirstMain(GIr,1,true)) then begin
					GIrw.Location = "MAIN";
					GIrw.Instock = SetQty[GIr.Code];
					GIr.Price = SetPrice[SetGISr.SetGlCode];
					matrowput(GIr,0,GIrw);
					RecordStore(GIr,true);
				end;
			end;
		end;
	end;
	resetloop(ItemGISr);
	
return;
end;



global updating procedure UpdateStockInOrigGlobalItem(string GIrCode, val DiffValue, string location, var boolean ItemDuplicatesf)
begin
	record GlobalItemVc OrigGIr, DupGir, OldOrigGir;
	row GlobalItemVc OrigGIrw, DupGirw;
	record ItemDuplicatesVc IDr;
	boolean TrHs, testf, origf, locf;
	string 255 OrigCode, OrigBrand;
	LongInt i, j;
	
	ItemDuplicatesf = false;
	
	logtext(0,GIrCode);
	logtext(0,DiffValue);
	logtext(0,location);

	
	DupGir.Code = GIrCode;
	if (ReadFirstMain(DupGir,1,true)) then begin
		IDr.DupCode = right(DupGir.Code,len(DupGir.Code)-9);
		TrHs = true;
		origf = false;
		while (loopkey("DupCode",IDr,1,TrHs)) begin
			testf = true;
			if (IDr.DupCode!=right(DupGir.Code,len(DupGir.Code)-9)) then begin TrHs = false; testf = false; end;
			if (IDr.DupBrandCode!=left(DupGir.Code,8)) then begin testf = false; end;
			if (testf) then begin
				ItemDuplicatesf = true;
				OrigCode = IDr.OrigCode;
				OrigBrand = IDr.OrigBrandCode;
				origf = true;
			end;
		end;
		resetloop(IDr);
		if (origf) then begin
			OrigGIr.Code = OrigBrand & "_" & OrigCode;
			if (ReadFirstMain(OrigGIr,1,true)) then begin
				locf = false;
				RecordCopy(OldOrigGir,OrigGIr);
				for (i=0;i<matrowcnt(OrigGIr);i=i+1) begin
					matrowget(OrigGIr,i,OrigGIrw);
					if (OrigGIrw.Location==location) then begin
						OrigGIrw.Instock = OrigGIrw.Instock + DiffValue;
						matrowput(OrigGIr,i,OrigGIrw);
						recordUpdate(OldOrigGir,OrigGIr,true);
						locf = true;
					end;
				end;
				if (!locf) then begin
					OrigGIrw.Instock = DiffValue;
					OrigGIrw.Location = location;
					matrowput(OrigGIr,matrowcnt(OrigGIr),OrigGIrw);
					recordUpdate(OldOrigGir,OrigGIr,true);
				end;
			end;
		end;
	end;
	OrigGIr.Code = GIrCode;
	if (ReadFirstMain(OrigGIr,1,true)) then begin
		IDr.OrigCode = right(OrigGIr.Code,len(OrigGIr.Code)-9);
		RecordCopy(OldOrigGir,OrigGIr);
		TrHs = true;
		origf = false;
		while (loopmain(IDr,1,TrHs)) begin
			testf = true;
			if (IDr.OrigCode!=right(OrigGIr.Code,len(OrigGIr.Code)-9)) then begin TrHs = false; testf = false; end;
			if (IDr.OrigBrandCode!=left(OrigGIr.Code,8)) then begin testf = false; end;
			if (testf) then begin
				ItemDuplicatesf = true;
				DupGir.Code = IDr.DupBrandCode & "_" & IDr.DupCode;
				if (ReadFirstMain(DupGir,1,true)) then begin
					for (i=0;i<matrowcnt(DupGir);i=i+1) begin
						matrowget(DupGir,i,DupGirw);
						if (DupGirw.Location==location) then begin
							for (j=0;j<matrowcnt(OrigGIr);j=j+1) begin
								matrowget(OrigGIr,j,OrigGIrw);
								if (OrigGIrw.Location==location) then begin
									logtext(0,OrigGIrw.Instock);
									logtext(0,DupGIrw.Instock);
									OrigGIrw.Instock = OrigGIrw.Instock + DupGIrw.Instock;
									matrowput(OrigGIr,j,OrigGIrw);
									recordUpdate(OldOrigGir,OrigGIr,true);
								end;
							end;
						end;
					end;
				end;
			end;
		end;
		ResetLoop(IDr);
	end;
return;
end;









global updating procedure CreateGlobalItem(string code, string  brand, string price, string name)
begin
	record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	record BTRxBrandVc BtrxBrndr, oldBrandr;
	boolean ExtPrBrandf, TrHs;
	string 255 OldCode, ExistBRNdCode;
	longint i;
	ExistBRNdCode = "";
	logtext(0,"CreateGlobalItem MAXI")
	GIr.Code = "ECMXA" & code;
	if(ReadFirstMain(GIr,1,true)) then begin
		Logtext(0,GIr.Code & " found");
		if(GIr.Price != StringToVal(price,M4Val)) then begin
			GIr.Price = StringToVal(price,M4Val);
			RecordStore(GIr,true);
		end;
		// if(gethour(currenttime)>=7 and getminute(currenttime)<=8/* and fileexists("demoserver")*/)then begin
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = 2;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = 2;
				matrowput (GIr,i,GIrw);
			end;
			RecordStore(GIr,true);
		// end;
		if (blank(GIr.BPIBrand) and nonblank(brand)) then begin
			ExtPrBrandf = false;
			BtrxBrndr.Name = brand;
			TrHs = true;
			while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
				if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
				if (TrHs) then begin
					if (left(BtrxBrndr.Code,4)=="MXBR") then begin
						ExtPrBrandf = true;
						ExistBRNdCode = BtrxBrndr.Code;
					end;
				end;
			end;
			if (!ExtPrBrandf) then begin
				oldBrandr.Code = "MXBR9999";
				TrHs = true;
				while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
					if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
					if (TrHs) then begin
						OldCode = oldBrandr.Code;
						TrHs = false;
					end;
				end;
				ResetLoop(oldBrandr);
				if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
				recordnew(BtrxBrndr);
				NextCode(OldCode,BtrxBrndr.Code);
				BtrxBrndr.Name = brand;
				RecordStore (BtrxBrndr,true);
				ExistBRNdCode = BtrxBrndr.Code;
			end;
			GIr.BPIBrand = ExistBRNdCode;
			GIr.HansaName = name;

			if (RecordStore(GIr,true)) then begin
				logtext(0,"MAXI Global Item updated: " & GIr.Code);
			end;
		end;
	end else begin
		if (nonblank(brand)) then begin
			ExtPrBrandf = false;
			BtrxBrndr.Name = brand;
			TrHs = true;
			while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
				if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
				if (TrHs) then begin
					if (left(BtrxBrndr.Code,4)=="MXBR") then begin
						ExtPrBrandf = true;
						ExistBRNdCode = BtrxBrndr.Code;
					end;
				end;
			end;
			if (!ExtPrBrandf) then begin
				oldBrandr.Code = "MXBR9999";
				TrHs = true;
				while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
					if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
					if (TrHs) then begin
						OldCode = oldBrandr.Code;
						TrHs = false;
					end;
				end;
				ResetLoop(oldBrandr);
				if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
				recordnew(BtrxBrndr);
				NextCode(OldCode,BtrxBrndr.Code);
				BtrxBrndr.Name = brand;
				RecordStore (BtrxBrndr,true);
				ExistBRNdCode = BtrxBrndr.Code;
			end;
		end;
		recordNew(GIr);
		GIr.Code = "ECMXA" & code;
		Logtext(0,GIr.Code & " not found");
		GIr.HansaCode = "ECMXA" & code;
		GIr.ExtProwItRegulations = 2;
		GIr.Brand = brand;
		GIr.BPIBrand = ExistBRNdCode;
		GIr.Price =  StringToVal(price,M4Val);
		GIr.Name = name;
		GIr.HansaName = name;
		if (matrowcnt(GIr)<1) then begin
			GIrw.Location = "MAIN";
			GIrw.Instock = 2;
			matrowput (GIr,0,GIrw);
		end;
		for (i=0;i<matrowcnt(GIr);i=i+1) begin
			matrowget (GIr,i,GIrw);
			GIrw.Instock = 2;
			matrowput (GIr,i,GIrw);
		end;
		if (RecordStore(GIr,true)) then begin
			logtext(0,"MAXI Global Item created: " & GIr.Code);
		end else begin
			logtext(0,"MAXI Global Item not created: " & GIr.Code);
		end;
	end;
return;
end;




global updating procedure CreateZOOMagGlobalItem(string code, string  brand, string price, string name, val qty)
begin
	record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	record BTRxBrandVc BtrxBrndr, oldBrandr;
	boolean ExtPrBrandf, TrHs;
	string 255 OldCode, ExistBRNdCode;
	longint i;
	ExistBRNdCode = "";
	logtext(0,"CreateGlobalItem ZOO")
	GIr.Code = "ZMAZ" & code;
	if(ReadFirstMain(GIr,1,true)) then begin
		Logtext(0,GIr.Code & " found");
		if(GIr.Price != StringToVal(price,M4Val)) then begin
			GIr.Price = StringToVal(price,M4Val);
			RecordStore(GIr,true);
		end;
		// if(gethour(currenttime)>=7 and getminute(currenttime)<=8/* and fileexists("demoserver")*/)then begin
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = qty;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = qty;
				matrowput (GIr,i,GIrw);
			end;
			GIr.ExtProwItRegulations = 4;
			RecordStore(GIr,true);
		// end;
		if (blank(GIr.BPIBrand) and nonblank(brand)) then begin
			ExtPrBrandf = false;
			BtrxBrndr.Name = brand;
			TrHs = true;
			while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
				if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
				if (TrHs) then begin
					if (left(BtrxBrndr.Code,4)=="ZOBR") then begin
						ExtPrBrandf = true;
						ExistBRNdCode = BtrxBrndr.Code;
					end;
				end;
			end;
			if (!ExtPrBrandf) then begin
				oldBrandr.Code = "ZOBR9999";
				TrHs = true;
				while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
					if (left(oldBrandr.Code,4)!="ZOBR") then begin TrHs = false; end;
					if (TrHs) then begin
						OldCode = oldBrandr.Code;
						TrHs = false;
					end;
				end;
				ResetLoop(oldBrandr);
				if(blank(OldCode))then begin OldCode = "ZOBR0000"; end;
				recordnew(BtrxBrndr);
				NextCode(OldCode,BtrxBrndr.Code);
				BtrxBrndr.Name = brand;
				RecordStore (BtrxBrndr,true);
				ExistBRNdCode = BtrxBrndr.Code;
			end;
			GIr.BPIBrand = ExistBRNdCode;
			GIr.HansaName = name;

			if (RecordStore(GIr,true)) then begin
				logtext(0,"ZOO Global Item updated: " & GIr.Code);
			end;
		end;
	end else begin
		if (nonblank(brand)) then begin
			ExtPrBrandf = false;
			BtrxBrndr.Name = brand;
			TrHs = true;
			while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
				if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
				if (TrHs) then begin
					if (left(BtrxBrndr.Code,4)=="ZOBR") then begin
						ExtPrBrandf = true;
						ExistBRNdCode = BtrxBrndr.Code;
					end;
				end;
			end;
			if (!ExtPrBrandf) then begin
				oldBrandr.Code = "ZOBR9999";
				TrHs = true;
				while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
					if (left(oldBrandr.Code,4)!="ZOBR") then begin TrHs = false; end;
					if (TrHs) then begin
						OldCode = oldBrandr.Code;
						TrHs = false;
					end;
				end;
				ResetLoop(oldBrandr);
				if(blank(OldCode))then begin OldCode = "ZOBR0000"; end;
				recordnew(BtrxBrndr);
				NextCode(OldCode,BtrxBrndr.Code);
				BtrxBrndr.Name = brand;
				RecordStore (BtrxBrndr,true);
				ExistBRNdCode = BtrxBrndr.Code;
			end;
		end;
		recordNew(GIr);
		GIr.Code = "ZMAZ" & code;
		Logtext(0,GIr.Code & " not found");
		GIr.HansaCode = "ZMAZ" & code;
		GIr.ExtProwItRegulations = 4;
		GIr.Brand = brand;
		GIr.BPIBrand = ExistBRNdCode;
		GIr.Price =  StringToVal(price,M4Val);
		GIr.Name = name;
		GIr.HansaName = name;
		if (matrowcnt(GIr)<1) then begin
			GIrw.Location = "MAIN";
			GIrw.Instock = qty;
			matrowput (GIr,0,GIrw);
		end;
		for (i=0;i<matrowcnt(GIr);i=i+1) begin
			matrowget (GIr,i,GIrw);
			GIrw.Instock = qty;
			matrowput (GIr,i,GIrw);
		end;
		if (RecordStore(GIr,true)) then begin
			logtext(0,"ZOO Global Item created: " & GIr.Code);
		end else begin
			logtext(0,"ZOO Global Item not created: " & GIr.Code);
		end;
	end;
return;
end;





global updating procedure CreateChiccoGlobalItem(string code, string  brand, string price, string name, boolean namef)
begin
	record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	record BTRxBrandVc BtrxBrndr, oldBrandr;
	boolean ExtPrBrandf, TrHs;
	string 255 OldCode, ExistBRNdCode;
	longint i;
	ExistBRNdCode = "";
	logtext(0,"CreateGlobalItem Chicco")
	GIr.Code = "CHIC" & code;
	if(ReadFirstMain(GIr,1,true)) then begin
		Logtext(0,GIr.Code & " found");
		if(GIr.Price != StringToVal(price,M4Val)) then begin
			GIr.Price = StringToVal(price,M4Val);
			RecordStore(GIr,true);
		end;
		// if(gethour(currenttime)>=7 and getminute(currenttime)<=8/* and fileexists("demoserver")*/)then begin
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = 2;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = 2;
				matrowput (GIr,i,GIrw);
			end;
			RecordStore(GIr,true);
		// end;
		if (blank(GIr.BPIBrand) and nonblank(brand)) then begin
			ExtPrBrandf = false;
			BtrxBrndr.Name = brand;
			TrHs = true;
			while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
				if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
				if (TrHs) then begin
					if (left(BtrxBrndr.Code,4)=="MXBR") then begin
						ExtPrBrandf = true;
						ExistBRNdCode = BtrxBrndr.Code;
					end;
				end;
			end;
			if (!ExtPrBrandf) then begin
				oldBrandr.Code = "MXBR9999";
				TrHs = true;
				while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
					if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
					if (TrHs) then begin
						OldCode = oldBrandr.Code;
						TrHs = false;
					end;
				end;
				ResetLoop(oldBrandr);
				if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
				recordnew(BtrxBrndr);
				NextCode(OldCode,BtrxBrndr.Code);
				BtrxBrndr.Name = brand;
				RecordStore (BtrxBrndr,true);
				ExistBRNdCode = BtrxBrndr.Code;
			end;
			GIr.BPIBrand = ExistBRNdCode;
			if (namef) then begin
				GIr.HansaName = name;
			end;

			if (RecordStore(GIr,true)) then begin
				logtext(0,"Chicco Global Item updated: " & GIr.Code);
			end;
		end;
	end else begin
		if (namef) then begin
			if (nonblank(brand)) then begin
				ExtPrBrandf = false;
				BtrxBrndr.Name = brand;
				TrHs = true;
				while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
					if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
					if (TrHs) then begin
						if (left(BtrxBrndr.Code,4)=="MXBR") then begin
							ExtPrBrandf = true;
							ExistBRNdCode = BtrxBrndr.Code;
						end;
					end;
				end;
				if (!ExtPrBrandf) then begin
					oldBrandr.Code = "MXBR9999";
					TrHs = true;
					while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
						if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
						if (TrHs) then begin
							OldCode = oldBrandr.Code;
							TrHs = false;
						end;
					end;
					ResetLoop(oldBrandr);
					if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
					recordnew(BtrxBrndr);
					NextCode(OldCode,BtrxBrndr.Code);
					BtrxBrndr.Name = brand;
					RecordStore (BtrxBrndr,true);
					ExistBRNdCode = BtrxBrndr.Code;
				end;
			end;
			recordNew(GIr);
			GIr.Code = "CHIC" & code;
			Logtext(0,GIr.Code & " not found");
			GIr.HansaCode = "CHIC" & code;
			GIr.ExtProwItRegulations = 3;
			GIr.Brand = brand;
			GIr.BPIBrand = ExistBRNdCode;
			GIr.Price =  StringToVal(price,M4Val);
			GIr.Name = name;
			GIr.HansaName = name;
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = 2;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = 2;
				matrowput (GIr,i,GIrw);
			end;
			if (RecordStore(GIr,true)) then begin
				logtext(0,"Chicco Global Item created: " & GIr.Code);
			end else begin
				logtext(0,"Chicco Global Item not created: " & GIr.Code);
			end;
		end;
	end;
return;
end;








global updating procedure CreateExtProvGlobalItem(string code, string  brand, string price, string name, boolean namef, string dealer_pr, boolean dealpf, string rebate, boolean rebf, longint ExtProvRegCode)
begin
	record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	record BTRxBrandVc BtrxBrndr, oldBrandr;
	boolean ExtPrBrandf, TrHs;
	string 255 OldCode, ExistBRNdCode;
	longint i;
	ExistBRNdCode = "";
	logtext(0,"CreateGlobalItem Ext. Pr")
	GIr.Code =  code;
	if(ReadFirstMain(GIr,1,true)) then begin
		Logtext(0,GIr.Code & " found");
		if(GIr.Price != StringToVal(price,M4Val)) then begin
			GIr.Price = StringToVal(price,M4Val);
			RecordStore(GIr,true);
		end;
		if(GIr.DealPrice != StringToVal(dealer_pr,M4Val) and dealpf) then begin
			GIr.DealPrice = StringToVal(dealer_pr,M4Val);
			RecordStore(GIr,true);
		end;
		if(GIr.Rebate != StringToVal(rebate,M4Val) and rebf) then begin
			GIr.Rebate = StringToVal(rebate,M4Val);
			RecordStore(GIr,true);
		end;
		ExtPrBrandf = false;
		BtrxBrndr.Name = brand;
		TrHs = true;
		while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
			if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
			if (TrHs) then begin
				if (left(BtrxBrndr.Code,4)=="MXBR") then begin
					ExtPrBrandf = true;
					ExistBRNdCode = BtrxBrndr.Code;
				end;
			end;
		end;
		if (!ExtPrBrandf) then begin
			oldBrandr.Code = "MXBR9999";
			TrHs = true;
			while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
				if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
				if (TrHs) then begin
					OldCode = oldBrandr.Code;
					TrHs = false;
				end;
			end;
			ResetLoop(oldBrandr);
			if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
			recordnew(BtrxBrndr);
			NextCode(OldCode,BtrxBrndr.Code);
			BtrxBrndr.Name = brand;
			RecordStore (BtrxBrndr,true);
			ExistBRNdCode = BtrxBrndr.Code;
		end;
		if(GIr.BPIBrand!=ExistBRNdCode) then begin
			GIr.BPIBrand = ExistBRNdCode;
			RecordStore(GIr,true);
		end;
		// if(gethour(currenttime)>=7 and getminute(currenttime)<=8/* and fileexists("demoserver")*/)then begin
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = 2;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = 2;
				matrowput (GIr,i,GIrw);
			end;
			GIr.ExtProwItRegulations = ExtProvRegCode;
			RecordStore(GIr,true);
		// end;
		if (blank(GIr.BPIBrand) and nonblank(brand)) then begin
			ExtPrBrandf = false;
			BtrxBrndr.Name = brand;
			TrHs = true;
			while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
				if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
				if (TrHs) then begin
					if (left(BtrxBrndr.Code,4)=="MXBR") then begin
						ExtPrBrandf = true;
						ExistBRNdCode = BtrxBrndr.Code;
					end;
				end;
			end;
			if (!ExtPrBrandf) then begin
				oldBrandr.Code = "MXBR9999";
				TrHs = true;
				while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
					if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
					if (TrHs) then begin
						OldCode = oldBrandr.Code;
						TrHs = false;
					end;
				end;
				ResetLoop(oldBrandr);
				if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
				recordnew(BtrxBrndr);
				NextCode(OldCode,BtrxBrndr.Code);
				BtrxBrndr.Name = brand;
				RecordStore (BtrxBrndr,true);
				ExistBRNdCode = BtrxBrndr.Code;
			end;
			GIr.BPIBrand = ExistBRNdCode;
			if (namef) then begin
				GIr.HansaName = name;
			end;

			if (RecordStore(GIr,true)) then begin
				logtext(0,"Chicco Global Item updated: " & GIr.Code);
			end;
		end;
	end else begin
		if (namef) then begin
			if (nonblank(brand)) then begin
				ExtPrBrandf = false;
				BtrxBrndr.Name = brand;
				TrHs = true;
				while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
					if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
					if (TrHs) then begin
						if (left(BtrxBrndr.Code,4)=="MXBR") then begin
							ExtPrBrandf = true;
							ExistBRNdCode = BtrxBrndr.Code;
						end;
					end;
				end;
				if (!ExtPrBrandf) then begin
					oldBrandr.Code = "MXBR9999";
					TrHs = true;
					while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
						if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
						if (TrHs) then begin
							OldCode = oldBrandr.Code;
							TrHs = false;
						end;
					end;
					ResetLoop(oldBrandr);
					if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
					recordnew(BtrxBrndr);
					NextCode(OldCode,BtrxBrndr.Code);
					BtrxBrndr.Name = brand;
					RecordStore (BtrxBrndr,true);
					ExistBRNdCode = BtrxBrndr.Code;
				end;
			end;
			recordNew(GIr);
			GIr.Code = code;
			Logtext(0,GIr.Code & " not found");
			GIr.HansaCode = code;
			GIr.ExtProwItRegulations = ExtProvRegCode;
			GIr.Brand = brand;
			GIr.BPIBrand = ExistBRNdCode;
			GIr.Price =  StringToVal(price,M4Val);
			if(dealpf) then begin
				GIr.DealPrice = StringToVal(dealer_pr,M4Val);
				RecordStore(GIr,true);
			end;
			if(rebf) then begin
				GIr.Rebate = StringToVal(rebate,M4Val);
				RecordStore(GIr,true);
			end;
			GIr.Name = name;
			GIr.HansaName = name;
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = 2;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = 2;
				matrowput (GIr,i,GIrw);
			end;
			if (RecordStore(GIr,true)) then begin
				logtext(0,"Ext. Pr Global Item created: " & GIr.Code);
			end else begin
				logtext(0,"Ext. Pr Global Item not created: " & GIr.Code);
			end;
		end;
	end;
return;
end;






global updating procedure CreateECAZGlobalItem(string code, string  brand, string price, string name, val qty, boolean namef, string dealer_pr, boolean dealpf, string rebate, boolean rebf, longint ExtProvRegCode)
begin
	record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	record BTRxBrandVc BtrxBrndr, oldBrandr;
	boolean ExtPrBrandf, TrHs;
	string 255 OldCode, ExistBRNdCode;
	longint i;
	ExistBRNdCode = "";
	logtext(0,"CreateGlobalItem Ext. Pr")
	GIr.Code =  code;
	if(ReadFirstMain(GIr,1,true)) then begin
		Logtext(0,GIr.Code & " found");
		if(GIr.Price != StringToVal(price,M4Val)) then begin
			GIr.Price = StringToVal(price,M4Val);
			RecordStore(GIr,true);
		end;
		if(GIr.DealPrice != StringToVal(dealer_pr,M4Val) and dealpf) then begin
			GIr.DealPrice = StringToVal(dealer_pr,M4Val);
			RecordStore(GIr,true);
		end;
		if(GIr.Rebate != StringToVal(rebate,M4Val) and rebf) then begin
			GIr.Rebate = StringToVal(rebate,M4Val);
			RecordStore(GIr,true);
		end;
		ExtPrBrandf = false;
		BtrxBrndr.Name = brand;
		TrHs = true;
		while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
			if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
			if (TrHs) then begin
				if (left(BtrxBrndr.Code,4)=="MXBR") then begin
					ExtPrBrandf = true;
					ExistBRNdCode = BtrxBrndr.Code;
				end;
			end;
		end;
		if (!ExtPrBrandf) then begin
			oldBrandr.Code = "MXBR9999";
			TrHs = true;
			while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
				if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
				if (TrHs) then begin
					OldCode = oldBrandr.Code;
					TrHs = false;
				end;
			end;
			ResetLoop(oldBrandr);
			if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
			recordnew(BtrxBrndr);
			NextCode(OldCode,BtrxBrndr.Code);
			BtrxBrndr.Name = brand;
			RecordStore (BtrxBrndr,true);
			ExistBRNdCode = BtrxBrndr.Code;
		end;
		if(GIr.BPIBrand!=ExistBRNdCode) then begin
			GIr.BPIBrand = ExistBRNdCode;
			RecordStore(GIr,true);
		end;
		// if(gethour(currenttime)>=7 and getminute(currenttime)<=8/* and fileexists("demoserver")*/)then begin
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = qty;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = qty;
				matrowput (GIr,i,GIrw);
			end;
			GIr.ExtProwItRegulations = ExtProvRegCode;
			RecordStore(GIr,true);
		// end;
		if (blank(GIr.BPIBrand) and nonblank(brand)) then begin
			ExtPrBrandf = false;
			BtrxBrndr.Name = brand;
			TrHs = true;
			while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
				if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
				if (TrHs) then begin
					if (left(BtrxBrndr.Code,4)=="MXBR") then begin
						ExtPrBrandf = true;
						ExistBRNdCode = BtrxBrndr.Code;
					end;
				end;
			end;
			if (!ExtPrBrandf) then begin
				oldBrandr.Code = "MXBR9999";
				TrHs = true;
				while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
					if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
					if (TrHs) then begin
						OldCode = oldBrandr.Code;
						TrHs = false;
					end;
				end;
				ResetLoop(oldBrandr);
				if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
				recordnew(BtrxBrndr);
				NextCode(OldCode,BtrxBrndr.Code);
				BtrxBrndr.Name = brand;
				RecordStore (BtrxBrndr,true);
				ExistBRNdCode = BtrxBrndr.Code;
			end;
			GIr.BPIBrand = ExistBRNdCode;
			if (namef) then begin
				GIr.HansaName = name;
			end;

			if (RecordStore(GIr,true)) then begin
				logtext(0,"Chicco Global Item updated: " & GIr.Code);
			end;
		end;
	end else begin
		if (namef) then begin
			if (nonblank(brand)) then begin
				ExtPrBrandf = false;
				BtrxBrndr.Name = brand;
				TrHs = true;
				while (loopkey("Name",BtrxBrndr,1,TrHs)) begin
					if (BtrxBrndr.Name != brand) then begin TrHs = false; end;
					if (TrHs) then begin
						if (left(BtrxBrndr.Code,4)=="MXBR") then begin
							ExtPrBrandf = true;
							ExistBRNdCode = BtrxBrndr.Code;
						end;
					end;
				end;
				if (!ExtPrBrandf) then begin
					oldBrandr.Code = "MXBR9999";
					TrHs = true;
					while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
						if (left(oldBrandr.Code,4)!="MXBR") then begin TrHs = false; end;
						if (TrHs) then begin
							OldCode = oldBrandr.Code;
							TrHs = false;
						end;
					end;
					ResetLoop(oldBrandr);
					if(blank(OldCode))then begin OldCode = "MXBR0000"; end;
					recordnew(BtrxBrndr);
					NextCode(OldCode,BtrxBrndr.Code);
					BtrxBrndr.Name = brand;
					RecordStore (BtrxBrndr,true);
					ExistBRNdCode = BtrxBrndr.Code;
				end;
			end;
			recordNew(GIr);
			GIr.Code = code;
			Logtext(0,GIr.Code & " not found");
			GIr.HansaCode = code;
			GIr.ExtProwItRegulations = ExtProvRegCode;
			GIr.Brand = brand;
			GIr.BPIBrand = ExistBRNdCode;
			GIr.Price =  StringToVal(price,M4Val);
			if(dealpf) then begin
				GIr.DealPrice = StringToVal(dealer_pr,M4Val);
				RecordStore(GIr,true);
			end;
			if(rebf) then begin
				GIr.Rebate = StringToVal(rebate,M4Val);
				RecordStore(GIr,true);
			end;
			GIr.Name = name;
			GIr.HansaName = name;
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = qty;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = qty;
				matrowput (GIr,i,GIrw);
			end;
			if (RecordStore(GIr,true)) then begin
				logtext(0,"Ext. Pr Global Item created: " & GIr.Code);
			end else begin
				logtext(0,"Ext. Pr Global Item not created: " & GIr.Code);
			end;
		end;
	end;
return;
end;


global updating procedure SetReffItem(string code, string  RefCode)
begin
	record GlobalItemVc GIr;
	
	GIr.Code = code;
	if (ReadFirstMain(GIr,1,true)) then begin
		GIr.ReffCode = RefCode;
		RecordStore(GIr,true);
	end;
	
return;
end;



global updating procedure CreateGlobalSet(string SetCode, string ItemCode, val SetItemQty, string SetName)
begin
	record GlobalItemSetVc GISr;
	record GlobalItemVc GIr, UnitGIr; 
	boolean testf, SetGirCreatedf;

	
	GISr.SetGlCode = SetCode;
	GISr.SetUnitGlCode = ItemCode;
	if (!ReadFirstMain(GISr,2,true)) then begin
		testf = true;
		GIr.Code = SetCode;
		if (ReadFirstMain(GIr,1,true)) then begin SetGirCreatedf = true; end;
		if (blank(SetName) and !SetGirCreatedf) then begin testf = false; end;
		if (testf) then begin
			RecordNew(GISr);
			GISr.SetGlCode = SetCode;
			GISr.SetUnitGlCode = ItemCode;
			GISr.SUQuant = SetItemQty;
			if(RecordInsert(GISr,true)) then begin
				logtext(0,"Global Set Created " & GISr.SetGlCode & " " & GISr.SetUnitGlCode);
				if (!SetGirCreatedf) then begin
					RecordNew(GIr);
					GIr.Code = GISr.SetGlCode;
					GIr.HansaName = SetName;
					UnitGIr.Code = ItemCode;
					if (ReadFirstMain(UnitGIr,1,true)) then begin
						if (blank(GIr.BPIBrand)) then begin GIr.BPIBrand = UnitGIr.BPIBrand; end;
					end;
					RecordStore(GIr,true);
				end;
				UpdateStockInSetGlobalItem(ItemCode);
			end else begin
				logtext(0,"Global set NOT Created, Blank name " & GISr.SetGlCode & " " & GISr.SetUnitGlCode);
			end;
		end;
	end else begin
		GISr.SUQuant = SetItemQty;
		if (RecordStore(GISr,true)) then begin
			logtext(0,"Global Set Updated " & GISr.SetGlCode & " " & GISr.SetUnitGlCode);
			GIr.Code = GISr.SetGlCode;
			if (!ReadFirstMain(GIr,1,true) and nonblank(SetName)) then begin
				RecordNew(GIr);
				GIr.Code = GISr.SetGlCode;
				GIr.HansaName = SetName;
				UnitGIr.Code = ItemCode;
				if (ReadFirstMain(UnitGIr,1,true)) then begin
					if (blank(GIr.BPIBrand)) then begin GIr.BPIBrand = UnitGIr.BPIBrand; end;
				end;
				RecordStore(GIr,true);
			end else begin
				UpdateStockInSetGlobalItem(UnitGIr.Code);
				if (blank(GIr.Code) and blank(SetName)) then begin 
					logtext(0,"Global set NOT Created, Blank name " & GISr.SetGlCode & " " & GISr.SetUnitGlCode);
				end;
			end;
		end;
	end;
	
	
	
return;
end;



global updating procedure CreateTPGlobalItem(string code, string  TPCode, string  MainName, array string aHeaders, vector string vParams)
begin
	record GlobalItemVc GIr, TPGir;
	row GlobalItemVc GIrw;
	record BTRxBrandVc BtrxBrndr, oldBrandr;
	boolean ExtPrBrandf, TrHs;
	string 255 OldCode, ExistBRNdCode,normalprice,price;
	longint i, j;
	integer blnk;
	array string 255 aParams, blankArr;
	vector string 255 blankVctr;
	ExistBRNdCode = "";
	logtext(0,"CreateGlobalItem TP")
	GIr.Code = code & "_" & TPCode;
	if(ReadFirstMain(GIr,1,true)) then begin
		Logtext(0,GIr.Code & " found");
		for(i=0;i<aHeaders.length;i=i+1)begin	
			if (aHeaders[i]=="Price") then begin
				price = vParams[TPCode & "_" & aHeaders[i]];
				for (j=0;j<len(price);j=j+1) begin
					if(Mid(price,j,1)==",") then begin
						normalprice = normalprice & ".";
					end else begin
						normalprice = normalprice & Mid(price,j,1);
					end;
				end;
				price = normalprice;
			end;
			aParams[i] = vParams[TPCode & "_" & aHeaders[i]];
		end;
		GIr.Price = StringToVal(price,M4Val);
		TPSetItemBitrixClass(GIr,aHeaders,aParams,blankArr,blnk,blankArr,blankVctr);
		RecordStore(GIr,true);
	end else begin
		GIr.Code = code;
		TPGir.Code = TPCode;
		if(ReadFirstMain(GIr,1,true) and !ReadFirstMain(TPGir,1,true)) then begin
			RecordNew(TPGir);
			RecordCopy(TPGir,GIr);
			TPGir.Code =  code & "_" & TPCode;
			TPGir.HansaCode = TPCode;
			TPGir.MainCode = code;
			RecordStore(TPGir,true);
			TPGir.Code = code & "_" & TPCode;
			if(ReadFirstMain(TPGir,1,true)) then begin
				Logtext(0,TPGir.Code & " Created");
				for(i=0;i<aHeaders.length;i=i+1)begin	
					if (aHeaders[i]=="Price") then begin
						price = vParams[TPCode & "_" & aHeaders[i]];
						for (j=0;j<len(price);j=j+1) begin
							if(Mid(price,j,1)==",") then begin
								normalprice = normalprice & ".";
							end else begin
								normalprice = normalprice & Mid(price,j,1);
							end;
						end;
						price = normalprice;
					end;
					aParams[i] = vParams[TPCode & "_" & aHeaders[i]];
				end;
				TPSetItemBitrixClass(TPGir,aHeaders,aParams,blankArr,blnk,blankArr,blankVctr);
				if(RecordStore(TPGir,true)) then begin
					GIr.Price = StringToVal(price,M4Val);
					GIr.MainCode = "MP";
					matrowget(GIr,0,GIrw);
					GIrw.Location = "MAIN";
					GIrw.Instock = 1;
					matrowput(GIr,0,GIrw);
					if (RecordStore(GIr,true)) then begin
						logtext(0,"Main Global Item created: " & GIr.Code);
					end;
				end;
			end;
		end else begin
			TPGir.Code = TPCode;
			if(ReadFirstMain(TPGir,1,true)) then begin
				for(i=0;i<aHeaders.length;i=i+1)begin	
					if (aHeaders[i]=="Price") then begin
						price = vParams[TPGir.Code & "_" & aHeaders[i]];
						for (j=0;j<len(price);j=j+1) begin
							if(Mid(price,j,1)==",") then begin
								normalprice = normalprice & ".";
							end else begin
								normalprice = normalprice & Mid(price,j,1);
							end;
						end;
						price = normalprice;
						logtext(0,TPGir.Code & " _ " & price);
					end;
					aParams[i] = vParams[TPGir.Code & "_" & aHeaders[i]];
				end;
				logtext(0,TPGir.Code & " _ " & price);
				GIr.Code = code;
				if (ReadFirstMain(GIr,1,true)) then begin
					TPGir.MainCode = code;
					TPSetItemBitrixClass(TPGir,aHeaders,aParams,blankArr,blnk,blankArr,blankVctr);
					if(RecordStore(TPGir,true)) then begin
						if (GIr.MainCode!="MP" or GIr.Price!=StringToVal(price,M4Val)) then begin
							GIr.MainCode = "MP";
							GIr.Price = StringToVal(price,M4Val);
							matrowget(GIr,0,GIrw);
							GIrw.Location = "MAIN";
							GIrw.Instock = 1;
							matrowput(GIr,0,GIrw);
							if (RecordStore(GIr,true)) then begin
								logtext(0,"Main Global Item created: " & GIr.Code);
							end;
						end;
					end;
				end else begin
					logtext (0," <> " & MainName);
					if (nonblank(MainName)) then begin
						recordNew(GIr);
						GIr.Code = code;
						GIr.HansaCode = code;
						GIr.Brand = TPGir.Brand;
						GIr.BPIBrand = TPGir.BPIBrand;
						GIr.Name = MainName;
						GIr.HansaName = MainName;
						GIr.MainCode = "MP";
						GIr.Price = StringToVal(price,M4Val);
						matrowget(GIr,0,GIrw);
						GIrw.Location = "MAIN";
						GIrw.Instock = 1;
						matrowput(GIr,0,GIrw);
						if (RecordStore(GIr,true)) then begin
							logtext(0,"Main Global Item created: " & GIr.Code);
							TPGir.MainCode = code;
							TPSetItemBitrixClass(TPGir,aHeaders,aParams,blankArr,blnk,blankArr,blankVctr);
							RecordStore(TPGir,true);
						end else begin
							logtext(0,"Main Global Item not created: " & GIr.Code);
						end;
					end;
				end;
			end;
		end;
	end;
return;
end;








global updating procedure Instock0(string code)
begin
	record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	record BTRxBrandVc BtrxBrndr, oldBrandr;
	boolean ExtPrBrandf, TrHs;
	string 255 OldCode, ExistBRNdCode;
	longint i;
	ExistBRNdCode = "";
	GIr.Code = code;
	if(ReadFirstMain(GIr,1,true)) then begin
		// if(gethour(currenttime)>=7 and getminute(currenttime)<=8/* and fileexists("demoserver")*/)then begin
			if (matrowcnt(GIr)<1) then begin
				GIrw.Location = "MAIN";
				GIrw.Instock = 0;
				matrowput (GIr,0,GIrw);
			end;
			for (i=0;i<matrowcnt(GIr);i=i+1) begin
				matrowget (GIr,i,GIrw);
				GIrw.Instock = 0;
				matrowput (GIr,i,GIrw);
			end;
			RecordStore(GIr,true);
			logtext(0,GIr.Code & "InStock = 0");
		// end;	
	end;
return;
end;



global procedure CollectXMLItems()
begin
	record ORVc ORr;
	area text,replyPr;
	string 255 tstr,code,brand,price,name,paramName,parseString,coding;
	integer i,posa,cnt,paramCnt,j,countstr,s;
	xml xmlreply;
	boolean codeCheck, TrHs;
	vector boolean CodeInstf;
	record GlobalItemVc GIr;
	
	SendWebRequest("maxi.az",443,-1,true,"GET","/bitrix/catalog_export/ozzi.php","text/xml","",false,text,replyPr,1);
	logtext(0,"start");
	xmlreply = ParseXMLArea(replyPr);
	posa = 0;
	cnt = XmlCountChildren(xmlreply,"yml_catalog/shop/offers");
	for(i=0;i<cnt;i=i+1) begin
		brand = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/vendor");
		price = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/price");
		name = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/description");
		if(blank(name)) then begin
			name = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/model");
		end;
		j = 0;
		code = "";
		paramName = XmlGetAttribute(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/param[" & j &"]","name");
		while(nonblank(paramName)) begin
			coding = "";
			coding = ConvertStringFromCodePage("WINDOWS-1251",paramName);
			if(coding == "") then begin
				parseString = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/param[" & j & "]");
				posa = 0;
				ExtractObj(parseString,posa,tstr);
				while(nonblank(tstr)) begin
					codeCheck = false;
					tstr = Trim(tstr);
					if (len(tstr) == 11) then begin
						logtext (0,tstr);
						codeCheck = true;
						for(countstr=0;countstr<len(tstr);countstr=countstr+1) begin
							if((asc(Mid(tstr,countstr,1))<48 or asc(Mid(tstr,countstr,1))>57) and asc(Mid(tstr,countstr,1))!=73 and asc(Mid(tstr,countstr,1))!=78)  then begin
								codeCheck = false;
							end;
						end;
					end;
					if(codeCheck) then begin
						code = tstr;
					end;
					ExtractObj(parseString,posa,tstr);
				end;
			end;
			j = j + 1;
			paramName = XmlGetAttribute(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/param[" & j &"]","name");
		end;
		if(nonblank(code)) then begin 
			queued.CreateGlobalItem(code,brand,price,name);
			MilliSleep(50);
			CodeInstf["ECMXA" & code] = true;
		end;
	end;
	GIr.Code = "ECMXA00000000001";
	TrHs = true;
	while (loopMain(Gir,1,TrHs)) begin
		if (left(GIr.Code,5)!="ECMXA") then begin TrHs = false; end;
		if (TrHs and !CodeInstf[GIr.Code]) then begin
			queued.Instock0(GIr.Code);
			MilliSleep(50);
		end;
	end;
	logtext(0,"end");
	writeareatofile(text,"areafromrequest.txt",0);

return;
end;




global procedure CollectXMLZOOMagItems()
begin
	record ORVc ORr;
	area text,replyPr;
	string 255 tstr,code,brand,price,name,paramName,parseString,coding,qty;
	integer i,posa,cnt,paramCnt,j,countstr,s;
	xml xmlreply;
	boolean codeCheck, TrHs;
	vector boolean CodeInstf;
	record GlobalItemVc GIr;
	val quant;
	
	SendWebRequest("zoomagazin.az",443,-1,true,"GET","/index.php?route=product/xml","text/xml","",false,text,replyPr,10);
	// SendWebRequest("maxi.az",443,-1,true,"GET","/bitrix/catalog_export/ozzi.php","text/xml","",false,text,replyPr,1);
	logtext(0,"start");
	logtext(0,GetAreaLength	(replyPr));
	xmlreply = ParseXMLArea(replyPr);
	posa = 0;
	cnt = XmlCountChildren(xmlreply,"company/products");
	// cnt = XmlCountChildren(xmlreply,"yml_catalog/shop/offers");
	logtext(0,cnt);
	for(i=0;i<cnt;i=i+1) begin
		// brand = XmlGetAttribute(xmlreply,"company/products/product[" & i & "]/brand[" & 0 &"]","name");
		// brand = ConvertStringFromCodePage("CP-1251",brand); 
		brand = XmlGet(xmlreply,"company/products/product[" & i & "]/manufacturer");
		price = XmlGet(xmlreply,"company/products/product[" & i & "]/SalePrice");
		name =  XmlGet(xmlreply,"company/products/product[" & i & "]/name");
		code = XmlGet(xmlreply,"company/products/product[" & i & "]/sku");
		qty = XmlGet(xmlreply,"company/products/product[" & i & "]/quantity");
		if(nonblank(code)) then begin 
			queued.CreateZOOMagGlobalItem(code,brand,price,name,StringToVal(qty,M4Val));
			logtext(0,brand & " brand");
			logtext(0,price & " price");
			logtext(0,name & " name");
			logtext(0,code & " code");
			logtext(0,qty & " qty");
			MilliSleep(50);
			if (StringToVal(qty,M4Val)>0) then begin
				CodeInstf["ZMAZ" & code] = true;
			end;
		end;
	end;
	GIr.Code = "ZMAZ00000000001";
	TrHs = true;
	while (loopMain(Gir,1,TrHs)) begin
		if (left(GIr.Code,4)!="ZMAZ") then begin TrHs = false; end;
		if (TrHs and !CodeInstf[GIr.Code]) then begin
			queued.Instock0(GIr.Code);
			MilliSleep(50);
		end;
	end;
	logtext(0,"end");
	writeareatofile(text,"areafromrequest.txt",0);

return;
end;



global webpublic updating procedure WebCollectXMLZOOMagItems()
begin
	CollectXMLZOOMagItems;
return;
end;





global procedure CollectXMLECAZMagItems()
begin
	record ORVc ORr;
	area text,replyPr;
	string 255 tstr,code,brand,price,name,paramName,parseString,coding,qty,normalprice;
	integer i,posa,cnt,paramCnt,j,countstr,s;
	boolean codeCheck, TrHs;
	vector boolean CodeInstf;
	record GlobalItemVc GIr;
	json jsresponse;
	val quant;
	
	SendWebRequest("api.ecaz.az",443,-1,true,"GET","/services/product/list/","","",false,text,replyPr,5000);
	logtext(0,"start");
	logtext(0,GetAreaLength	(replyPr));

	jsresponse = ParseJSONArea(replyPr);
	posa = 0;
	cnt = JSONCountChildren(jsresponse,"data");
	// cnt = XmlCountChildren(xmlreply,"yml_catalog/shop/offers");
	logtext(0,cnt);
	for(i=0;i<cnt;i=i+1) begin
		normalprice = "";
		brand = JSONGet(jsresponse,"data[0]/["  & i & "]/model_name");
		price = JSONGet(jsresponse,"data[0]/["  & i & "]/price");
		for (j=0;j<len(price);j=j+1) begin
			if(Mid(price,j,1)==",") then begin
				normalprice = normalprice & ".";
			end else begin
				normalprice = normalprice & Mid(price,j,1);
			end;
		end;
		price = normalprice;
		name = JSONGet(jsresponse,"data[0]/["  & i & "]/type_ru");
		code = JSONGet(jsresponse,"data[0]/["  & i & "]/code");
		qty = JSONGet(jsresponse,"data[0]/["  & i & "]/stock");
		if(nonblank(code) and  StringToVal(qty,M4Val) > 0) then begin 
			queued.CreateECAZGlobalItem("ECAZ" & code,brand,price,name,StringToVal(qty,M4Val),1,"",0,"",0,16);
			MilliSleep(50);
			if (StringToVal(qty,M4Val)>0) then begin
				CodeInstf["ECAZ" & code] = true;
			end;
		end;
	end;
	GIr.Code = "ECAZ00000000001";
	TrHs = true;
	while (loopMain(Gir,1,TrHs)) begin
		if (left(GIr.Code,4)!="ECAZ") then begin TrHs = false; end;
		if (TrHs and !CodeInstf[GIr.Code]) then begin
			queued.Instock0(GIr.Code);
			MilliSleep(50);
		end;
	end;
	logtext(0,"end");
	writeareatofile(text,"areafromrequest.txt",0);

return;
end;


global webpublic procedure WebCollectXMLECAZMagItems()
begin
	CollectXMLECAZMagItems;
	return
end;






global webpublic procedure WebGetOfferIDAndArtCodeFromXML()
begin
	record ORVc ORr;
	area text,replyPr;
	string 255 tstr,code,brand,price,name,paramName,parseString,coding,offerID;
	integer i,posa,cnt,paramCnt,j,countstr,s;
	xml xmlreply;
	boolean codeCheck;
	SendWebRequest("maxi.az",443,-1,true,"GET","/bitrix/catalog_export/ozzi.php","text/xml","",false,text,replyPr,1);
	logtext(0,"start");
	xmlreply = ParseXMLArea(replyPr);
	posa = 0;
	cnt = XmlCountChildren(xmlreply,"yml_catalog/shop/offers");
	for(i=0;i<cnt;i=i+1) begin
		brand = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/vendor");
		price = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/price");
		name = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/description");
		if(blank(name)) then begin
			name = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/model");
		end;
		j = 0;
		code = "";
		offerID = XmlGetAttribute(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]","id");
		paramName = XmlGetAttribute(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/param[" & j &"]","name");
		while(nonblank(paramName)) begin
			coding = "";
			coding = ConvertStringFromCodePage("WINDOWS-1251",paramName);
			if(coding == "") then begin
				parseString = XmlGet(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/param[" & j & "]");
				posa = 0;
				ExtractObj(parseString,posa,tstr);
				while(nonblank(tstr)) begin
					codeCheck = false;
					tstr = Trim(tstr);
					if (len(tstr) == 11) then begin
						codeCheck = true;
						for(countstr=0;countstr<len(tstr);countstr=countstr+1) begin
							if(asc(Mid(tstr,countstr,1))<48 or asc(Mid(tstr,countstr,1))>57)  then begin
								codeCheck = false;
							end;
						end;
					end;
					if(codeCheck) then begin
						code = tstr;
					end;
					ExtractObj(parseString,posa,tstr);
				end;
			end;
			j = j + 1;
			paramName = XmlGetAttribute(xmlreply,"yml_catalog/shop/offers/offer[" & i & "]/param[" & j &"]","name");
		end;
		if(nonblank(code)) then begin 
			WebOutString(offerID & "______________" & code );
			weboutstring("<BR>");
		end;
	end;
	logtext(0,"end");
	writeareatofile(text,"areafromrequest.txt",0);

return;
end;




global webpublic procedure WebfindNotBrand()
begin
	record IVVc IVr,oldIVr;
	row IVVc IVrw;
	record TRVc  TRr,oldTRr;
	row TRVc TRrw;
	integer i,rwcnt,trrwcnt,j,dcnt;
	boolean storef,trsoref,TrHs;
	record PUVc PUr;
	record INVc INr;
	row PUVc PUrw;
	
	setcompany(18,false);
	PUr.SerNr = 624;
	if(ReadFirstMain(PUr,1,true)) then begin
		for(i=0;i<matrowcnt(PUr);i=i+1) begin
			matrowget(PUr,i,PUrw);
			WebOutString("<BR>");
			INr.Code = PUrw.ArtCode;
			if(ReadFirstMain(INr,1,true))then begin end;
			WebOutString(INr.Group & " " & INr.Code);
		end;
	end;
	

return;
end;




global updating procedure SaveInstockOneByMP (record GlobalItemVc GIr)
begin
	recordstore(GIr,true);
return;
end;



global webpublic procedure WebSetINstOneInMP()
begin
	record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	
	
	GIr.Code = "";
	while (loopMain(GIr,1,true)) begin
		if (GIr.MainCode=="MP") then begin
			matrowget(GIr,0,GIrw);
			GIrw.Location = "MAIN";
			GIrw.Instock = 1;
			matrowput(GIr,0,GIrw);
			queued.SaveInstockOneByMP(GIr);
			millisleep(50);
		end;
	end;
	
	

return;
end;








global webpublic procedure WebECOrdersReport()
begin
	record ORVc ORr;
	row ORVc ORrw;
	boolean TrHs,testf;
	longint i;
	val Rebate, Sum4WithoutReb, Sum4WhithReb;
	
	SetCompany(29,false);
	ORr.SerNr = 2454;
	TrHs = true;
	while (loopMain(ORr,1,TrHs)) begin
		Sum4WithoutReb = 0;
		Sum4WhithReb = 0;
		Rebate = 0;
		for (i=0;i<matrowcnt(ORr);i=i+1) begin
			matrowget(ORr,i,ORrw);
			Sum4WithoutReb = Sum4WithoutReb + ORrw.Price * ORrw.Quant;
			Sum4WhithReb = Sum4WhithReb + ORrw.Sum;
		end;
		Rebate = Sum4WhithReb * 100 / Sum4WithoutReb;
		Rebate = 100 - Rebate;
		//Rebate = Round(Rebate,SetRoundModeD(0));
		WebOutString(ORr.SerNr & "<_>_<_>" & ORr.ECLoyaltyCard & "<_>_<_>" & Rebate & "<_>_<_>" & Sum4WithoutReb & "<_>_<_>" & Sum4WhithReb);
		WebOutString("<BR>");
	end;
return;
end;






global webpublic updating procedure WebECOrdersUnReserve()
begin
	record ORVc ORr, LocORr, OldLocORr;
	row ORVc ORrw;
	boolean TrHs,testf;
	longint i;
	val Rebate, Sum4WithoutReb, Sum4WhithReb;
	record RcVc RepSpec;
	
	SetCompany(29,false);
	ORr.SerNr = 2545;
	TrHs = true;
	while (loopMain(ORr,1,TrHs)) begin
		if (ORr.SerNr>3706) then begin TrHs = false; end;
		if (TrHs) then begin
			i = 1;
			for (i=1;i<35;i=i+1) begin
				SetCompany(i,false);
				LocORr.OfficialSerNr = "EC_" & ORr.SerNr;
				if (ReadFirstKey("OfficialSerNr",LocORr,1,true)) then begin
					if (LocORr.Closed!=1 and LocORr.Reserved==1) then begin
						RepSpec.f1 = LocORr.SerNr;
						RepSpec.flags[1] = 1;
						RepSpec.flags[0] = 1;
						RepSpec.flags[2] = 0;
						RepSpec.ArtMode = 0;
						RecalcORMn(RepSpec);
					end;
				end;
				LocORr.OfficialSerNr = "EC_" & ORr.SerNr;
				if (ReadFirstKey("OfficialSerNr",LocORr,1,true)) then begin
					if (LocORr.Closed!=1 and LocORr.Reserved==1) then begin
						RecordCopy(OldLocORr,LocORr);
						LocORr.Reserved = 0;
						if (RecordUpdate(OldLocORr,LocORr,true)==0) then begin
							logtext(0,LocORr.SerNr);
						end;
					end;
				end;
			end;
			ResetCompany(29);
		end;
	end;
return;
end;








