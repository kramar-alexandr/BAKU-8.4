external function Integer PayTermType(string);
external updating procedure POCreateInterCompanyOR(record POVc);
external function Integer POApprovalStatus(record POVc,var record AcceptanceRulesVc);
external updating procedure CreateActFromPO(record POVc);
external updating procedure DeletePlannedPayment(string,LongInt,LongInt);
external updating procedure POCreatePlannedPayment(record POVc);
external function Boolean StockRecordForLocationAllowed(string,string,string,date,integer,var Integer,var string);
external procedure VerifyRowObjects(String,String,String,String,var Integer,var String,var Boolean,Array string,Array string,var Integer);
external function LongInt GetCurUserLastNr(string);
external updating procedure FindAcptRulesAndCreateAcceptanceAlert2(Integer,Integer,string,string,string,val,val,string,string,string,string);
external updating procedure CancelApprovalRequestActivities(Integer,string,string,string);
external function Integer VerifyTaxTemplateCode(string,var string);
external function Boolean AcceptanceRulesExists(Integer,string);
external function Boolean UseTaxTemplatesforTaxCalc();
external function Integer SetAcceptanceStatus(Integer,string,val);
external procedure WarnFutureDate(Boolean,Date);
external function Boolean DisallowFutureDateCheck(Boolean,Date,string,Integer);
external function Boolean WillPOQtyCoverReservations(record POVc);
external function Boolean DoesPOHaveReservations(record POVc);
external updating procedure PORemoveUpdateDfncyStock(record POVc);
external function Integer VATType(string);
external function Boolean IsVATCodeDefined(string);
external function Boolean VATAccIsClosed(string,var string,Integer);
external function Boolean CanOKStockRecord(var Integer);
external procedure SwapM4Val(var val,var val);
external updating procedure AssignStockResFromPO(record POVc);
//external updating procedure UpdateAcceptRec(LongInt,string,Integer);
external function Integer CheckRates(string,val,val,val,val,val,var string);
external updating procedure UpdateVARItemsPO(record POVc);
external function Boolean CheckPDExists(string);
//external updating procedure GenerateAcceptRec(string,LongInt,string,string,val);
remote function Boolean POVc_PasteLocation(var record POVc);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external function Boolean ReadFirstItem(string,var record INVc,Boolean,Boolean);
external function Boolean AllowThisItem(string,string,string,Integer);
external function Boolean CorrectM4ValProc(val);
external function Integer CheckObjs(string,string,var string);
external function Boolean CheckPOCQStatVECode(LongInt, string,var Integer);
external function Boolean SerNrTestPOVc(LongInt,Date,var Boolean);
external procedure ConvertToDualBase(var string,date,var val,var val,var val,var val,var val,var val,Boolean);
external updating procedure UpdatePOOut(record POVc,Boolean,Boolean);
external procedure SetPOFlags(record POVc,Boolean);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external procedure GetSalesGroup(string,var string);
external updating procedure UpdateStockResFromPO(record POVc,boolean);
external function Boolean POVc_PasteArtCode(var record POVc,Integer,Boolean);// Edit ************************** Friday, 31 August 2012 16:50:21
external procedure POVc_PasteQuant(var record POVc,Integer);// Edit ************************** Friday, 31 August 2012 16:50:20
external procedure POVc_PastePrice(var record POVc,Integer);// Edit ************************** Tuesday, 11 September 2012 17:22:00
external function roundmode SetRoundModeD(Integer);
remote updating procedure CheckAndCreateClassification(var string,string,boolean);// Edit ************************** Wednesday, 14 August 2013 10:30:58
external function LongInt TimeDiffInSeconds(Time,Time);
external procedure ExtractObj(string,var Integer,var string);// Edit ************************** Friday, 27 March 2015 10:53:32
remote function boolean CompanyIsJWLikeCompany(Integer);
external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);
external updating procedure UpdatePrice(record PLVc);
external procedure LogProcTime(string,longint);
remote procedure POSumup(var record POVc);
remote function boolean PTCCCodesCheck(string);
external function string 60 AddObjectToObjectList(string,string);
remote function Boolean SDVc_PasteArtCode(var record SDVc,Integer,Integer,var string,var string);
external function Boolean IntORchrsum(record IntORVc,Integer);// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 19 11 2020 y. at 9:51:56 AM
external procedure SumupIntOR(var record IntORVc,var val);// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 19 11 2020 y. at 9:52:00 AM
external updating procedure SyncPOInIDG(record POVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 12:05 25.02.2021

SetLangMode(LangRussian,"RUS",0);

//Edit***************************Sasha2,14:44 23.03.2016 {
procedure NoLimitExtractObj(string ostr,var Integer pos,var string rstr)
BEGIN
  string 1 c1;

  rstr = "";
L47:;
  if (pos>=len(ostr)) then begin goto L999; end;
  c1 = Mid(ostr,pos,1); 
  pos = pos + 1;
  if ((c1==",") or (c1==".") or (c1==";")) then begin
    if (len(rstr)==0) then begin 
      goto L47; 
    end;
    goto L888;
  end;
  rstr = rstr & c1;
  goto L47;
L888:;
  if (pos>len(ostr)) then begin goto L999; end;
  c1 = Mid(ostr,pos,1);  
  pos = pos + 1;
  if ((c1==",") or (c1==".")) then begin goto L888; end;
  pos = pos - 1;
L999:;
  RETURN;
END; //Edit***************************Sasha2,14:45 23.03.2016 }

procedure SetPOAcceptanceFlag(var record POVc POr,record POVc prevPOr,LongInt stat)
begin
  val bc1v;
  Boolean testf;

  testf = true;
  switch (stat) begin
    case Rs_update:
      if (prevPOr.OKFlag!=0) then begin
        testf = false;
      end;
    otherwise
      ;
  end;
  if (testf) then begin
    switch (POr.AcceptanceStatus) begin
      case kAcceptanceStatePending:
      case kAcceptanceStateApproved:
      case kAcceptanceStateRejected:
      otherwise
        bc1v = MulRateToBase1(POr.CurncyCode,POr.Sum4,POr.FrRate,POr.ToRateB1,POr.ToRateB2,POr.BaseRate1,POr.BaseRate2,DefaultCurRoundOff);
        POr.AcceptanceStatus = SetAcceptanceStatus(kAcceptancePO,POr.VECode,bc1v);      
    end;
  end;
  return;
end;

global
function LongInt POVcRecordInIndex(record POVc POr,string indexname)
begin
  LongInt res;
  
  res = 1;
  if ((POr.OSFlag==0) or (POr.Sum4<=POr.PrepaidAmount)) then begin 
    if (indexname=="ActSerNr")  then begin res = 0; end;
    if (indexname=="ActTransDate")  then begin res = 0; end;
    if (indexname=="ActVECode")  then begin res = 0; end;
    if (indexname=="ActName")  then begin res = 0; end;
  end;
  if (POr.PUFlag==0) and (POr.PIFlag==0) then begin 
    if (indexname=="ActArtCodeOSFlag")  then begin res = 0; end;
  end;
  if ((POr.PUFlag!=0) or (POr.PIFlag!=0) or (POr.OKFlag!=0)) then begin 
    if (indexname=="VECodeOpen")  then begin res = 0; end;
  end;
  POVcRecordInIndex = res;
  return;
end;

global
function LongInt POVcRecordRemoveTest(var record POVc POr,record POVc PO2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  record DBLockBlock DBLockRec;
  record PUVc PUr;
  Integer actnr;
  record ActVc Actr;
  record RLinkVc RLr;

  res = 1;
  BlockLoad(DBLockRec);
  if (blankdate(DBLockRec.DeleteBeforeDate) or POr.TransDate>DBLockRec.DeleteBeforeDate) then begin
    PUr.PONr = POr.SerNr;
    if (ReadFirstKey("PONr",PUr,1,true)) then begin
      if (long3>0) then begin MessageBox(1560,""); end;
      res = 0;
      goto LPOVcRecordRemoveTest;
    end;    
    if (POr.OKFlag!=0) then begin
      if (long3>0) then begin MessageBox(1560,""); end;
      res = 0;
      goto LPOVcRecordRemoveTest;
    end;
    if (DoesPOHaveReservations(POr)) then begin
      if (long3>0) then begin MessageBox(22065,""); end;
      res = 0;
      goto LPOVcRecordRemoveTest;
    end;
    actnr = 1;
    while (ReadRecordLink(POr,actnr,Actr,RLr)) begin
      if (Actr.TodoFlag==kTodoFlagApproval) then begin
        if (long3>0) then begin MessageBox(22408,""); end;
        res = 0;
        goto LPOVcRecordRemoveTest;
      end;
      actnr = actnr + 1;
    end;
  end;
LPOVcRecordRemoveTest:;
  POVcRecordRemoveTest = res; 
  return;
end;

procedure PasteLocationToPO(string location,record POVc POp)
begin
  record LocationVc Locr;
  
  Locr.Code = location;
  if (ReadFirstMain(Locr,1,true)) then begin
    POp.Location = Locr.Code;
    POp.ShipAddr0 = Locr.Name;
    POp.ShipAddr1 = Locr.Addr0;
    POp.ShipAddr2 = Locr.Addr1;
    POp.ShipAddr3 = Locr.Addr2;
    POp.DelAddr3 = Locr.Addr3;
    POp.DelAddr4 = Locr.Addr4;    
  end;
  return;
end;

global
function LongInt POVcRecordDefaults(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  record UserVc Userr;
  string 255 tstr;
  string 10 curcode;
  val fr,to1,to2,br1,br2;
  record MainStockBlock MSb;
  record AccBlock ARAccb;
  record POSettingBlock POSetb;
  LongInt newnr;
  record SRBlock SRb;
  
  BlockLoad(ARAccb);
  BlockLoad(MSb);
  BlockLoad(POSetb);
  if (POSetb.PUQuant!=0) then begin 
    POr.SetZeroPUQuant = 1;
  end;
  POr.SerNr = -1;
  if (currentcompany==28) then begin
    BlockLoad(SRb);
    if (POr.SerNr<=0) then begin
      newnr = GetCurUserLastNr("POVc");
      if (newnr==-1) then begin newnr = SRb.LastPONr; end;
      POr.SerNr = NextSerNr("POVc",POr.TransDate,newnr,false,"");
    end;
  end;
  POr.TransDate = CurrentDate;
  POr.OKFlag = 0;
  POr.ExportFlag = 0;
  POr.OSFlag = 0;
  POr.InvFlag = 0;
  POr.PIFlag = 0;
  POr.POCOSerNr = -1;
  Userr.Code = CurrentUser;
  if (ReadFirstMain(Userr,1,true)) then begin
    POr.OurContact = Userr.CurOurContact;
    PasteLocationToPO(Userr.Location,POr);
    POr.SalesMan = Userr.Code;
    GetSalesGroup(POr.SalesMan,tstr);
    POr.SalesGroup = tstr;    
  end;
  POr.PayDeal = "";
  POr.CurncyCode = "";
  POr.OrdNr = -1;
  POr.WONr = -1;
  POr.POCQStatNr = -1;  
  curcode = POr.CurncyCode;
  GetFullCurncyRate(curcode,POr.TransDate,fr,to1,to2,br1,br2);
  POr.CurncyCode = curcode;
  POr.FrRate = fr;
  POr.ToRateB1 = to1; 
  POr.ToRateB2 = to2;
  POr.BaseRate1 = br1;
  POr.BaseRate2 = br2;  
  POr.OKPersons = "";
  POr.InvBeforePU = MSb.AllowInvBeforePU;
  POr.ExtraCostsCalculation = MSb.ExtraCostsCalculation;
  if (SingleUserMode) then begin
    POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");
  end;
  POr.NoTAXonVAT = ARAccb.NoTAXonVAT;
  if (currentcompany==28) then begin
    POr.IDStatus = "PO On Enquiry";
    POr.IDIncoterms = "EXW";
  end;
	if(currentcompany==18)then begin
		POr.IDStatus = "PO Confirmed";
	end;
  POVcRecordDefaults = res; 
  return;
end;

global
function LongInt POVcRecordDuplicate(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  Integer i,rwcnt;
  string 10 curcode;
  val fr,to1,to2,br1,br2;
  row POVc POrw;
  record MainStockBlock MainStockRec;

  BlockLoad(MainStockRec);
  POr.SerNr = -1;
  POr.OrdNr = -1;
  POr.WONr = -1;
  POr.POCQStatNr = -1;  
  POr.OKFlag = 0;
  POr.Closed = 0;
	POr.IDGDEAPORef = 0;
  POr.IntORNo = -1;
  rwcnt = MatRowCnt(POr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(POr,i,POrw);
    POrw.Shipd1 = blankval;
    POrw.Shipd2 = blankval;
    POrw.Invd = blankval;
    POrw.WSNr = -1;
    POrw.IntORRow = -1;
//    POrw.PRCode = "";
    MatRowPut(POr,i,POrw);
  end;
  if (SingleUserMode) then begin
    POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");
  end;
  curcode = POr.CurncyCode;
  GetFullCurncyRate(curcode,POr.TransDate,fr,to1,to2,br1,br2);
  POr.CurncyCode = curcode;
  POr.FrRate = fr;
  POr.ToRateB1 = to1; 
  POr.ToRateB2 = to2;
  POr.BaseRate1 = br1;
  POr.BaseRate2 = br2;  
  POr.OKPersons = "";
  POr.AcceptanceBy = "";
  POr.AcceptanceFYI = "";
  POr.DownPaySent = blankval;  
  POr.DownPayRedcd = blankval;  
//  POr.InvBeforePU = MainStockRec.AllowInvBeforePU;//they want this to be copied
  SetPOFlags(POr,false);
  WarnFutureDate(true,POr.TransDate);
  POr.OrderType = kOrderTypeNormal;
  POVcRecordDuplicate = res; 
  return;
end;

procedure AutRecNonStockItem(record POVc POp)
begin
  row POVc POrw;
  Integer i,rwcnt;
  record MainStockBlock MainStockRec;
  record INVc INr;
  Boolean updf;

  BlockLoad(MainStockRec);
  if (MainStockRec.RecevPlainItems==1) then begin
    rwcnt = MatRowCnt(POp);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(POp,i,POrw);
      INr.Code = POrw.ArtCode;
      if (ReadFirstMain(INr,1,true)) then begin
        if ((INr.ItemType==0) or (INr.ItemType==3)) then begin
          if (POrw.Quant>POrw.Shipd1) then begin
            POrw.Shipd1 = POrw.Quant;
            updf = true;
          end;
          if (POrw.Quant>POrw.Shipd2) then begin
            POrw.Shipd2 = POrw.Quant;
            updf = true;
          end;
          if (updf) then begin MatRowPut(POp,i,POrw); end;
        end;
      end;
    end;
  end;
  return;
end;

updating procedure PRPOINStatUp(LongInt posernr,Date td,string project,string artcode,val quantp,val sump,Boolean addf)
begin
  record PRPOINVc PRPOr;
  record PRPOINVc oldPRPOr;
  Boolean found;
  Boolean delf;
  val q,s;
  
  if (blank(artcode)) then begin goto LPRPOINStatUp; end;
  if (blank(project)) then begin goto LPRPOINStatUp; end;
  q = quantp;
  s = sump;
  if ((q!=0) or (s!=0)) then begin
    delf = false;
    PRPOr.POSerNr = posernr;
    PRPOr.Project = project;
    PRPOr.Item = artcode;
    found = ReadFirstMain(PRPOr,3,true);
    RecordCopy(oldPRPOr,PRPOr);
    if (found) then begin
    end else begin
      PRPOr.POSerNr = posernr;
      PRPOr.Project = project;
      PRPOr.Item = artcode;
      PRPOr.TransDate = td;
      PRPOr.POQty = 0;
      PRPOr.POVal = 0;
    end;
    if (addf==false) then begin
      q = -q;
      s = -s;
    end;
    PRPOr.POQty = PRPOr.POQty + q;
    PRPOr.POVal = PRPOr.POVal + s;
    if (PRPOr.POVal==0) then begin delf = true; end;
    if (PRPOr.POQty==0) then begin delf = true; end;
    if (delf==false) then begin
      if (found) then begin
        if (RecordUpdate(oldPRPOr,PRPOr,true)==0) then begin end;
      end else begin
        if (RecordStore(PRPOr,false)) then begin end;
      end;
    end else begin
      if (found==true) then begin
        RecordDelete(oldPRPOr);
      end;
    end;
  end;
LPRPOINStatUp:;
  return;
end;

global
updating procedure UpdatePRPO(record POVc POp,Boolean addf)
begin
  row POVc POrw;
  Integer i,rwcnt;
  string 255 project;
  val valinbase1;

  rwcnt = MatRowCnt(POp);  
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(POp,i,POrw);
    if (POrw.stp==1) then begin
      if (nonblank(POrw.PRCode) or nonblank(POp.PRCode)) then begin
         if (nonblank(POrw.PRCode)) then begin
           project = POrw.PRCode;
         end else begin
           project = POp.PRCode;
         end;
         valinbase1 = MulRateToBase1(POp.CurncyCode,POrw.Sum,POp.FrRate,POp.ToRateB1,POp.ToRateB2,POp.BaseRate1,POp.BaseRate2,DefaultCurRoundOff);
         PRPOINStatUp(POp.SerNr,POp.TransDate,project,POrw.ArtCode,POrw.Quant,valinbase1,addf);      
      end;
    end;
  end;
  return;
end;

global
updating function LongInt POChekItemStockInCompSenderDo(record POVc POp,string Location,integer OldComp,var boolean OtherCurrf)
begin
	row POVc POrw;
  record LocationVc Lcr;
	record SDVc SDr, OldSDr;
	row SDVc SDrw;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	LongInt i, compcnt, rwcnt, j, OldCompany, res;
	boolean TrHs, testf;
	string 255 tstr;
	record ItemStatusVc ISr,IS1r;
	vector integer ItemQty;
	record ItemHistVc IHr;
	vector val ItmRowRemQty;
	
	res = -1;
	
	for (i=0;i<matrowcnt(POp);i=i+1) begin
		matrowget(POp,i,POrw);
		if (nonblank(POrw.ArtCode)) then begin
			ItemQty[POrw.ArtCode] = ItemQty[POrw.ArtCode] + POrw.Quant;
		end;
	end;
	
	OtherCurrf = false;
	for (i=matrowcnt(POp)-1;i>=0;i=i-1) begin
		matrowget(POp,i,POrw);
		ItmRowRemQty[POrw.ArtCode] = ItemQty[POrw.ArtCode];
		if (ItemQty[POrw.ArtCode]>0) then begin
			ISr.Code = POrw.ArtCode;
			ISr.Location = Location;
			if(ReadFirstMain(ISr,2,true)) then begin 
				if (ISr.Instock-ISr.RsrvQty<ItemQty[POrw.ArtCode]) then begin
					res = i;
				end;
			end;
			Lcr.Code = Location;
			if(ReadFirstMain(Lcr,1,true)) then begin
				if(nonblank(Lcr.ConsigStockCode)) then begin
					IS1r.Code = POrw.ArtCode;
					IS1r.Location = Lcr.ConsigStockCode;
					if(ReadFirstMain(IS1r,2,true)) then begin 
						if (IS1r.Instock-IS1r.RsrvQty>=ItemQty[POrw.ArtCode]) then begin
							res = -1;
						end;
					end;
				end;
			end;
		end;
		if (res>-1) then begin
			goto LPOChekItemStockInCompSenderDo; 
		end;
		// TrHs = true;
		// IHr.ArtCode = POrw.ArtCode;
		// while (LoopKey("ArtCode",IHr,1,TrHs)) begin
			// testf = true;
			// if (IHr.ArtCode!=POrw.ArtCode) then begin TrHs = false; testf = false; end;
			// if (ItmRowRemQty[POrw.ArtCode]==0) then begin TrHs = false; testf = false; end;
			// if (IHr.StockAffectf==0) then begin testf = false; end;
			// if (IHr.RemQty<1) then begin testf = false; end;
			// if (nonblank(Lcr.ConsigStockCode) and IHr.Location!=Location and IHr.Location!=Lcr.ConsigStockCode) then begin testf = false; end;
			// if (blank(Lcr.ConsigStockCode) and IHr.Location!=Location) then begin testf = false; end;
			// if (testf) then begin
				// if (IHr.CurncyCode!=POp.CurncyCode) then begin 
					// OtherCurrf = true; 
					// res = i;
					// goto LPOChekItemStockInCompSenderDo; 
				// end else begin
					// ItmRowRemQty[POrw.ArtCode] = ItmRowRemQty[POrw.ArtCode] - IHr.RemQty;
				// end;
			// end;
		// end;
		// resetloop(IHr);
	end;
	LPOChekItemStockInCompSenderDo:;
	
	POChekItemStockInCompSenderDo = res;
  return;
end;



global
updating procedure POCreateSDInCompSenderDo(record POVc POp,string Location,integer OldComp)
begin
	row POVc POrw;
  record LocationVc Lcr;
	record SDVc SDr, OldSDr;
	row SDVc SDrw;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	LongInt i, compcnt, rwcnt, j, curCompany;
	boolean TrHs;
	string 255 tstr, MainPersonsStr;
	record ActVc Actr;
	record UserVc Userr;
	record ItemStatusVc ISr,IS1r;
	
	curCompany = currentcompany;
	Userr.Code = "";
	while (LoopMain(Userr,1,true)) begin
		if (Userr.Location==Location and Userr.AccessGroup=="STORE") then begin
			if (nonblank(MainPersonsStr)) then begin MainPersonsStr = MainPersonsStr & ","; end;
			MainPersonsStr = MainPersonsStr & Userr.Code;
		end;
	end;
	ResetLoop(Userr);
	
	
	RecordNew(SDr);
	SDr.SerNr = NextSerNr("SDVc",SDr.TransDate,-1,false,""); 
	SDr.Location = Location;
	SDr.CostAcc = "41/06";
	SDr.Comment = "ЦЕНТРАЛЬНЫЙ ВОЗВРАТ - переброска";
	if (nonblank(SDr.Location)) then begin
		Lcr.Code = SDr.Location;
		ReadFirstMain(Lcr,1,true);
		SDr.Objects = AddObjectToObjectList(SDr.Objects,Lcr.Objects);
		SDr.Objects = SDr.Objects & ",CENTRAL_RETURN";
	end;
	
	for (i=0;i<matrowcnt(POp);i=i+1) begin
		MatRowGet(POp,i,POrw);
		ClearRow(SDr,SDrw,1);
		Lcr.Code = Location;
		if(ReadFirstMain(Lcr,1,true)) then begin
			if(nonblank(Lcr.ConsigStockCode)) then begin
				ISr.Code = POrw.ArtCode;
				ISr.Location = Location;
				SDrw.Location = Lcr.Code;
				POrw.ConsgType = 0;
				MatRowPut(POp,i,POrw);
				if(ReadfirstMain(ISr,2,true)) then begin
					if(ISr.Instock-ISr.RsrvQty<POrw.Quant) then begin
						IS1r.Code = POrw.ArtCode;
						IS1r.Location = Lcr.ConsigStockCode;
						if(ReadfirstMain(IS1r,2,true)) then begin
							if(IS1r.Instock-IS1r.RsrvQty>=POrw.Quant) then begin
								SDrw.Location = Lcr.ConsigStockCode;
								POrw.ConsgType = 1;
								MatRowPut(POp,i,POrw);
							end;
						end;
					end;
				end;
				SetCompany(OldComp,false);
				recordStore(POp,true);
				ResetCompany(curCompany);
			end;
		end;
		SDrw.ArtCode = POrw.ArtCode;
		SDrw.Qty = POrw.Quant;
		MatRowPut(SDr,i,SDrw);
		SDVc_PasteArtCode(SDr,i,1,tstr,tstr);
	end;
	recordStore (SDr,false);
	RecordCopy(OldSDr,SDr);
	SDr.Reservf = 1;
	if(RecordUpdate(OldSDr,SDr,true)==0) then begin
		createrecordlink(SDr,CurrentCompany,POp,OldComp);
		createrecordlink(POp,OldComp,SDr,CurrentCompany);
		
		recordNew(Actr);
		Actr.SerNr = NextSerNr("ActVc",Actr.TransDate,-1,false,"");
		Actr.TodoFlag = 1; 
		Actr.StartTime = CurrentTime;
		Actr.TransDate = Currentdate;
		Actr.MainPersons = MainPersonsStr;
		Actr.Comment = "Создано списание № " & SDr.SerNr & " для переброски товаров в другой бутик. Если согласны - \"ОК\", если не согл. - снять резерв.";
		Actr.AlarmType = 1;
		recordstore(Actr,true);
		createrecordlink(Actr,currentcompany,SDr,currentcompany);
		createrecordlink(SDr,currentcompany,Actr,currentcompany);
		
	end;	
  return;
end;

global
updating function LongInt POCheckItemStockInCompSender(record POVc POp, var boolean OtherCurrf)
begin
  record LocationVc Lcr;
	record CompaniesBlock Compb;
	LongInt i, OldCompany, res;
	boolean TrHs;
	
	res = -1;
	
	logtext(0,"POCheckItemStockInCompSender");
	
	OldCompany = CurrentCompany;
	blockLoad(Compb);
	for (i=0;i<matrowcnt(Compb);i=i+1) begin
		SetCompany(i+1,false);
		Lcr.Code = "";
		TrHs = true;
		while (LoopMain(Lcr,1,TrHs)) begin
			if (POp.ItemFromOtherSTockObj==Lcr.FOBSuplier) then begin
				TrHs = false;
				res = POChekItemStockInCompSenderDo(POp,Lcr.Code,OldCompany,OtherCurrf);
			end;
		end;
		ResetLoop(Lcr);
	end;
	resetCompany(OldCompany);
	POCheckItemStockInCompSender = res;
  return;
end;





global
updating procedure POCreateSDInCompSender(record POVc POp)
begin
  record LocationVc Lcr;
	record CompaniesBlock Compb;
	LongInt i, OldCompany;
	boolean TrHs;
	
	OldCompany = CurrentCompany;
	blockLoad(Compb);
	for (i=0;i<matrowcnt(Compb);i=i+1) begin
		SetCompany(i+1,false);
		Lcr.Code = "";
		TrHs = true;
		while (LoopMain(Lcr,1,TrHs)) begin
			if (POp.ItemFromOtherSTockObj==Lcr.FOBSuplier) then begin
				TrHs = false;
				POCreateSDInCompSenderDo(POp,Lcr.Code,OldCompany);
			end;
		end;
		ResetLoop(Lcr);
	end;
	resetCompany(OldCompany);
  return;
end;




global
updating procedure POUpdatePOCO(record POVc POp,Boolean negf)
begin
  record POCOVc oldPOCOr;
  record POCOVc POCOr;
  row POCOVc POCOrw;
  row POVc POrw;
  Integer i,rwcnt,pococnt;

  POCOr.SerNr = POp.POCOSerNr;
  if (ReadFirstMain(POCOr,1,true)) then begin
    RecordCopy(oldPOCOr,POCOr);
    pococnt = MatRowCnt(POCOr);
    rwcnt = MatRowCnt(POp);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(POp,i,POrw);
      if (POrw.POCORow!=-1) then begin
        if ((POrw.POCORow<pococnt) and (POrw.POCORow>-1)) then begin
          MatRowGet(POCOr,POrw.POCORow,POCOrw);
          if (negf) then begin
            POCOrw.Ordered = POCOrw.Ordered - POrw.Quant;
          end else begin
            POCOrw.Ordered = POCOrw.Ordered + POrw.Quant;
          end;
          MatRowPut(POCOr,POrw.POCORow,POCOrw);
        end;
      end;
    end;
    if (RecordUpdate(oldPOCOr,POCOr,false)==0) then begin end;
  end;
  return;
end;

/*
wierd stuff
updating procedure POUpdatePOCO(record POVc POr)
begin
  record POCOVc POCOr;
  row POCOVc POCOrw;
  Integer poi,porwcnt;
  Integer i,rwcnt,j;
  val rval;
  record POVc POr1;
  row POVc POrw1;
  array string 20 icode;
  array val ordqty;
  integer maxi;
  longint wPOCONr;
  boolean found,TrHs,testf;
    
  wPOCONr = POr.POCOSerNr;  
  if (wPOCONr>0) then begin
  RecordNew(POr1);
  POr1.POCOSerNr = wPOCONr;
  TrHs = true;
  maxi = 0;
  While (LoopKey("POCOSerNr",POr1,1,TrHs)) begin
    if (POr1.POCOSerNr==wPOCONr) then begin
      rwcnt = MatRowCnt(POr1);
      found = false;
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(POr1,i,POrw1);
        for (j=0;j<maxi;j=j+1) begin
          if (icode[j]==POrw1.ArtCode) then begin
            ordqty[j] = POrw1.Quant+ordqty[j];
            found = true;
            j = maxi;                       
          end;    
        end;
        if (found==false) then begin
          ordqty[maxi] = POrw1.Quant;
          icode[maxi] = POrw1.ArtCode;
          maxi = maxi+1;
        end;
      end;
    end else begin  
      TrHs = false;
    end;  
  end;
   
  POCOr.SerNr = wPOCONr;
  TrHs = true;
  if (ReadFirstMain(POCOr,1,true)) then begin
    rwcnt = MatRowCnt(POCOr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(POCOr,i,POCOrw);
      for (j=0;j<maxi;j=j+1) begin
        if (icode[j]==POCOrw.ArtCode) then begin
          if (ordqty[j]<=POCOrw.Quant) then begin
            POCOrw.Ordered = ordqty[j];
            ordqty[j] = 0;
          end else begin
            POCOrw.Ordered = POCOrw.Quant;
            ordqty[j] = ordqty[j] - POCOrw.Ordered;
          end;
          j = maxi;     
        end;    
      end;
      MatRowPut(POCOr,i,POCOrw);   
    end;
    testf = RecordStore(POCOr,true);
  end;  
  end;
  return;
end;
*/

global
updating function LongInt POVcRecordSave(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  AutRecNonStockItem(POr);
  SetPOFlags(POr,false);
  UpdatePOOut(POr,true,false);
  UpdatePRPO(POr,true);
  if (POr.OKFlag==1) then begin 
    if (SetInSet(CurrentUser,POr.OKPersons)==false) then begin
      if (nonblank(POr.OKPersons)) then begin
        POr.OKPersons = POr.OKPersons & ",";
      end;
      POr.OKPersons = POr.OKPersons & CurrentUser;
    end;
  end;  
  POVcRecordSave = res; 
  return;
end;

global
updating function LongInt POVcRecordUpdate(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  AutRecNonStockItem(POr);
  SetPOFlags(POr,false);
  UpdatePOOut(PO2r,false,false);
  UpdatePOOut(POr,true,false);
  UpdatePRPO(PO2r,false);
  UpdatePRPO(POr,true);
  if (POr.OKFlag==1) and (PO2r.OKFlag==0) then begin 
    if (SetInSet(CurrentUser,POr.OKPersons)==false) then begin
      if (nonblank(POr.OKPersons)) then begin
        POr.OKPersons = POr.OKPersons & ",";
      end;
      POr.OKPersons = POr.OKPersons & CurrentUser;
    end;
  end;  
  POVcRecordUpdate = res; 
  return;
end;

global
updating function LongInt POVcRecordRemove(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  record POShipmDataVc POSDr;
	record POVc IDPOr;
  UpdatePOOut(POr,false,false);
  UpdatePRPO(POr,false);
  UpdateStockResFromPO(POr,true);
  if (currentcompany!=28) then begin
    POSDr.POSerNr = POr.SerNr;
    if (readfirstmain(POSDr,1,true)) then begin
      RecordDelete(POSDr);
    end;
  end;
	if (CurrentCompany==28 and POr.IDGDEAPORef>0) then begin
		SetCompany(18,false);
		IDPOr.SerNr = POr.IDGDEAPORef;
		if (ReadFirstMain(IDPOr,1,true)) then begin
			RecordDelete(IDPOr);
		end;
		ResetCompany(28);
	end;
	if (CurrentCompany==18 and POr.IDGDEAPORef>0) then begin
		SetCompany(28,false);
		IDPOr.SerNr = POr.IDGDEAPORef;
		if (ReadFirstMain(IDPOr,1,true)) then begin
			RecordDelete(IDPOr);
		end;
		ResetCompany(18);
	end;
  POVcRecordRemove = res; 
  return;
end;

updating procedure UpdateIntOrderFromPO(record POVc POp,record POVc PO2p)
begin
  Integer i,rwcnt;
  row POVc POrw;
  record IntORVc oldIntORr;
  record IntORVc IntORr;
  row IntORVc IntORrw;
  Integer orw,orcnt;
  Boolean testf;
  record AcceptanceRulesVc Acptr;
  val v;// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 19 11 2020 y. at 9:53:06 AM

  if (RecordValid(POp)) then begin
    IntORr.SerNr = POp.IntORNo;
  end else begin
    IntORr.SerNr = PO2p.IntORNo;
  end;
  if (ReadFirstMain(IntORr,1,true)) then begin
    RecordCopy(oldIntORr,IntORr)
    orcnt = MatRowCnt(IntORr);    
    if (RecordValid(PO2p)) then begin
			if (PO2p.SerNr!=-1) then begin
				rwcnt = MatRowCnt(PO2p);
				for (i=0;i<rwcnt;i=i+1) begin
					MatRowGet(PO2p,i,POrw);
					if (POrw.IntORRow!=-1) then begin
						orw = POrw.IntORRow;
						if (orw<orcnt) then begin
							MatRowGet(IntORr,orw,IntORrw);
							IntORrw.POOrd = IntORrw.POOrd - POrw.Quant;
							IntORrw.Quant = IntORrw.Quant + POrw.Quant;//Бред немного, но Сабина попросила так сделать // Edit ************************** BPI Ukraine - KramarAlexandr - 05, 08 05 2020 y. at 1:56:05 PM
							if (IntORrw.POOrd==0) then begin IntORrw.POOrd = blankval; end;
							MatRowPut(IntORr,orw,IntORrw);
							IntORchrsum(IntORr,orw);// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 19 11 2020 y. at 9:49:49 AM
						end;
					end;
				end;
			end;
    end;
    if (RecordValid(POp)) then begin
      testf = true;
      i = POApprovalStatus(POp,Acptr);
      if (i!=kAcceptanceStateApproved) and (i!=kAcceptanceStateNotRequired) then begin testf = false; end;
      if (testf) then begin
        rwcnt = MatRowCnt(POp);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(POp,i,POrw);
          if (POrw.IntORRow!=-1) then begin
            orw = POrw.IntORRow;
            if (orw<orcnt) then begin
              MatRowGet(IntORr,orw,IntORrw);
              IntORrw.POOrd = IntORrw.POOrd + POrw.Quant;
							IntORrw.Quant = IntORrw.Quant - POrw.Quant;//Бред немного, но Сабина попросила так сделать // Edit ************************** BPI Ukraine - KramarAlexandr - 05, 08 05 2020 y. at 1:56:05 PM
              if (IntORrw.POOrd==0) then begin IntORrw.POOrd = blankval; end;
              MatRowPut(IntORr,orw,IntORrw);
              IntORchrsum(IntORr,orw);
            end;
          end;
        end;
      end;
    end;
//    SetIntORFlags(IntORr);
		SumupIntOR(IntORr,v);
		IntORr.Total = v;
    if (RecordUpdate(oldIntORr,IntORr,false)==0) then begin // When added IntORVcRecordProtectFields, had to change this to false
    end;
  end;
  return;
end;

global
updating function LongInt POVcRecordSaveAfter(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  CreateActFromPO(POr);
  POUpdatePOCO(POr,false);
  if (POr.IntORNo!=-1) then begin
    UpdateIntOrderFromPO(POr,PO2r);
  end;
  UpdateVARItemsPO(POr);
  if (POr.OKFlag!=0) then begin
    AssignStockResFromPO(POr);
		if (nonblank(POr.ItemFromOtherSTockObj)) then begin
			 POCreateSDInCompSender(POr);
		end;
  end;
  POCreatePlannedPayment(POr);
  if (POr.OKFlag!=0) then begin
    POCreateInterCompanyOR(POr);
  end;
	if (nonblank(POr.IDStatus)) then begin
		POr.UpdStatDate = currentdate;
		recordstore (POr,true);
	end;
	
	if (CurrentCompany==28 or CurrentCompany==18) then begin
		if (FileExists("demoserver")) then begin
			SyncPOInIDG(POr);
		end;
	end;
	
  POVcRecordSaveAfter = res;
  return;
end;

global
updating  function LongInt POVcRecordUpdateAfter(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res,i;
  val bc1v;
	row POVc POrw;
	boolean shipdf, shipd0f;
  
  POUpdatePOCO(PO2r,true);
  POUpdatePOCO(POr,false);
  if ((POr.IntORNo!=-1) and (PO2r.OKFlag==0)) then begin
    UpdateIntOrderFromPO(POr,PO2r);
  end;  
  UpdateVARItemsPO(POr);
  if ((POr.OKFlag!=0) and (PO2r.OKFlag==0)) then begin
    AssignStockResFromPO(POr);
    POCreateInterCompanyOR(POr);
		if (nonblank(POr.ItemFromOtherSTockObj)) then begin
			 POCreateSDInCompSender(POr);
		end;
  end;
  UpdateStockResFromPO(POr,POr.Closed);
  if (PO2r.Sum4!=POr.Sum4) then begin
    DeletePlannedPayment("POVc",POr.SerNr,-1);
    POCreatePlannedPayment(POr);
  end;
	if (POr.IDStatus!=PO2r.IDStatus) then begin
		POr.UpdStatDate = currentdate;
		recordstore (POr,true);
	end;
	if (CurrentCompany==28 or CurrentCompany==18) then begin
		if (FileExists("demoserver")) then begin
			SyncPOInIDG(POr);
		end;
	end;
  POVcRecordUpdateAfter = res;
  return;
end;

global
updating function LongInt POVcRecordRemoveAfter(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  POUpdatePOCO(POr,true);
  PORemoveUpdateDfncyStock(POr);
  if (POr.IntORNo!=-1) then begin
    UpdateIntOrderFromPO(PO2r,POr);
  end;
  POVcRecordRemoveAfter = res;
  return;
end;

global
function Date ConvertPlanShipString(string PlanShip)
begin
  Date res;
  record PlanDeliveryBlock PlanDelRec;

  BlockLoad(PlanDelRec);
  if (PlanDelRec.FieldType==1) then begin
    res = StringToDate(PlanShip);
  end;
  ConvertPlanShipString = res;
  return;
end;

procedure POVcConvertB1ToB2(var val to1p,var val to2p,var val br1p,var val br2p)
begin    
  SwapM4Val(br1p,br2p);
  SwapM4Val(to1p,to2p);
  return;
end;

global
function LongInt POVcRecordImport(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  val t,fr,to1,to2,br1,br2;
  string 5 curncy;
  Boolean gToDualBase,gBase1ToBase2;
  record ConvMasterBlock cvm;

  BlockLoad(cvm);
  if (cvm.DualBaseCurrencyFlag!=0) then begin gToDualBase = true; end;
  if (gToDualBase) then begin
    curncy = POr.CurncyCode;
    fr = POr.FrRate;
    to1 = POr.ToRateB1;
    to2 = POr.ToRateB2;
    br1 = POr.BaseRate1;
    br2 = POr.BaseRate2;
    t = POr.Sum4;
    ConvertToDualBase(curncy,POr.TransDate,fr,to1,to2,br1,br2,t,true);
    POr.CurncyCode = curncy;
    POr.FrRate = fr;
    POr.ToRateB1 = to1;
    POr.ToRateB2 = to2;
    POr.BaseRate1 = br1;
    POr.BaseRate2 = br2;
    POr.Sum4 = t;       
  end;
  if (blankdate(POr.PlanShipDate)) then begin
    POr.PlanShipDate = ConvertPlanShipString(POr.PlanShip);
  end;
  if (cvm.Base1ToBase2Flag!=0) then begin gBase1ToBase2 = true; end;
  if (gBase1ToBase2) then begin
    curncy = POr.CurncyCode;
    to1 = POr.ToRateB1;
    to2 = POr.ToRateB2;
    br1 = POr.BaseRate1;
    br2 = POr.BaseRate2;
    POVcConvertB1ToB2(to1,to2,br1,br2);
    POr.ToRateB1 = to1;
    POr.ToRateB2 = to2;
    POr.BaseRate1 = br1;
    POr.BaseRate2 = br2;
  end;
  if (POr.NoTAXonVAT==-1) then begin
    POr.NoTAXonVAT = 0;
  end;
  POr.PrepaidAmount = blankval;
  SetPOFlags(POr,false);
  POVcRecordImport = res;
  return;
end;

global
updating function LongInt POVcRecordImportAfter(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  Integer err;

  UpdatePRPO(POr,true);
  if (ImportingTextBackup==false and CanOKStockRecord(err)==true) then begin
    UpdatePOOut(POr,true,true);
  end;
  POVcRecordImportAfter = res; 
  return;
end;

function Boolean POReservationsExists(record POVc POr)
begin
  record StockReservVc StockReservr;
  Boolean foundf;
  Boolean res;
  
  res = false;
  StockReservr.Donef = 0;
  StockReservr.ToFileName = kResTypeExistingPO;
  StockReservr.ToSerNr = POr.SerNr;
  foundf = true;
  while (LoopKey("ToItem",StockReservr,3,foundf)) begin
    if (StockReservr.Donef!=0) then begin foundf = false; end;
    if (StockReservr.ToFileName!=kResTypeExistingPO) then begin foundf = false; end;
    if (StockReservr.ToSerNr!=POr.SerNr) then begin foundf = false; end;
    if (foundf) then begin
      res = true;
      foundf = false;
    end;
  end;
  POReservationsExists = res;
  return;
end;

//Edit***************************Sasha2,10:36 21.01.2016 {
procedure FindINGroupViaClass(var record INVc INr)
BEGIN
  record DIVc DIr;
  record ITVc ITr;
  string 20 curdisp;
  integer pos;
  
    if (NonBlank(INr.DispGroups)) then begin
      pos = 0;
      ExtractObj(INr.DispGroups,pos,curdisp);
			while (nonblank(curdisp)) begin
				DIr.Code = curdisp;
				if (readfirstmain(DIr,1,true) and DIr.CType=="Brand") then begin
				  ITr.Comment = DIr.Name;
				  if(readlastkey("Comment",ITr,1,true))then begin
	  				INr.Group = ITr.Code;
	  				pos = len(INr.DispGroups);
	  			end;
				end;
				ExtractObj(INr.DispGroups,pos,curdisp);
			end;
    end;
  
  RETURN;
END; //Edit***************************Sasha2,10:36 21.01.2016 }

global
updating procedure NewINVilleroy(var record POVc POr,integer i,boolean found,var record INVc INr,val fr,val to1,val to2,val br1,val br2)
begin
	row POVc POrw;
	record INVc newINr,IN2r;
	record PLVc PLr;
	record PricePointListVc PPLr;// Edit ************************** Friday, 31 August 2012 15:31:36
  row PricePointListVc PPLrw;// Edit ************************** Friday, 31 August 2012 15:31:36
  integer pi,pmtrw,po,rwcnt;// Edit ************************** Wednesday, 5 September 2012 16:06:18
  boolean changef;
  record DIVc DIr;
  row POVc chPOrw;
  val frrate,torate,price;
	record NewClassifChBlock NCCb;
	
	blockLoad(NCCb);
	
	logtext(0,"NewINVilleroy");
	
	frrate = fr;
	torate = to1;
	
	if(frrate==0)then begin frrate=1; end;
	if(torate==0)then begin torate=1; end;
	
	rwcnt = matrowcnt(POr);
	matrowget(POr,i,POrw);
	if(NCCb.ClassifCheck==0)then begin
		if(found==false)then begin
			if(nonblank(POrw.ArtCode) and nonblank(POrw.Spec) and POrw.Quant>0)then begin
				recordNew(newINr);
				newINr.Code = POrw.ArtCode;
				newINr.Name = POrw.Spec;
				newINr.Unittext = "ШТ";
				newINr.VATCode = "0%";
				if(POr.VECode!="FOB_SKLAD") then begin
					newINr.LastPurchCurncyCode = POr.CurncyCode;
					newINr.LastPurchPrice2 = POrw.Price;
				end;
				newINr.ConsgType = POrw.ConsgType;// Edit ************************** Wednesday, 17 December 2014 09:37:30
				switch(newINr.ConsgType)begin
					case 1:/*newINr.PurchAcc = "41/02"*/;
					case 2:newINr.PurchAcc = "12";
				end;
				if(nonblank(POrw.xClassification))then begin
					newINr.DispGroups = POrw.xClassification;
				end else begin
					newINr.DispGroups = "";
				end;
				FindINGroupViaClass(newINr); //Edit***************************Sasha2,10:54 21.01.2016
				
				newINr.BarCode = POrw.EAN13Code;// Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 19 November 2018 09:46:52
				newINr.AlternativeCode = POrw.Comment;
				
				newINr.RowWeight = POrw.RowWeight;
				newINr.Size = POrw.Size;
				newINr.Metal = POrw.Metal;
				newINr.Colour = POrw.Colour;
				newINr.MajStoneDet = POrw.MajStoneDet;
				newINr.BrcStr = POrw.BrcStr;		//Edit by Victor 18.06.15
				if(POrw.PPNum>0)then begin // Edit ************************** Wednesday, 20 April 2016 11:07:38
					newINr.CPSCode = POrw.PPNum;
				end;
				if(POr.VECode!="FOB_SKLAD") then begin
					newINr.InPrice = round(POrw.Price/frrate*torate,SetRoundModeD(2));
				end;
				recordStore(newINr,true);
				
				POVc_PasteArtCode(POr,i,false);
				POVc_PasteQuant(POr,i);
				
				For(po=0;po<rwcnt;po=po+1) begin // Edit ************************** Friday, 15 February 2013 10:11:45// Edit ************************** Friday, 15 February 2013 10:11:45
					matrowget(POr,po,chPOrw);
					if(chPOrw.ArtCode==newINr.Code)then begin
						POVc_PasteArtCode(POr,po,false);
						POVc_PasteQuant(POr,po);
					end;
				end; 
			end;
		end;
	end;
	if(found==true)then begin
		recordcopy(IN2r,INr);
		changef = false;
		if(NCCb.ClassifCheck==0)then begin
			if(nonblank(POrw.xClassification) and (INr.DispGroups!=POrw.xClassification or blank(INr.Group)))then begin
				changef = true;
				INr.DispGroups = POrw.xClassification;
				FindINGroupViaClass(INr); //Edit***************************Sasha2,10:54 21.01.2016
				
			end;
		end;
		if(nonblank(POrw.Comment) and INr.AlternativeCode!=POrw.Comment)then begin
			changef = true;
			INr.AlternativeCode = POrw.Comment;
		end;
		if(POrw.Price>0 and (POrw.Price!=INr.LastPurchPrice2 or INr.LastPurchCurncyCode!=POr.CurncyCode))then begin
			logtext(0,"changef = true");
			changef = true;
			if(POr.VECode!="FOB_SKLAD") then begin
				INr.LastPurchCurncyCode = POr.CurncyCode;
				INr.LastPurchPrice2 = POrw.Price;
				INr.InPrice = round(POrw.Price/frrate*torate,SetRoundModeD(2));
			end;
		end;
		if(blank(INr.BarCode))then begin
			if(nonblank(POrw.EAN13Code) and INr.BarCode!=POrw.EAN13Code)then begin
				changef = true;
				INr.BarCode = POrw.EAN13Code;
			end;
		end;
		if(NCCb.ClassifCheck==0)then begin
			if(nonblank(POrw.RowWeight) and INr.RowWeight!=POrw.RowWeight)then begin
				changef = true;
				INr.RowWeight = POrw.RowWeight;
			end;
			if(nonblank(POrw.Size) and INr.Size!=POrw.Size)then begin
				changef = true;
				INr.Size = POrw.Size;
			end;
			if(nonblank(POrw.Metal) and INr.Metal!=POrw.Metal)then begin
				changef = true;
				INr.Metal = POrw.Metal;
			end;
			if(nonblank(POrw.Colour) and INr.Colour!=POrw.Colour)then begin
				changef = true;
				INr.Colour = POrw.Colour;
			end;
			if(nonblank(POrw.MajStoneDet) and INr.MajStoneDet!=POrw.MajStoneDet)then begin
				changef = true;
				INr.MajStoneDet = POrw.MajStoneDet;
			end;
		end;
		if(POrw.PPNum>0 and stringtoint(INr.CPSCode)!=POrw.PPNum)then begin
			changef = true;
			INr.CPSCode = POrw.PPNum;
		end;
		
		if(POrw.ConsgType>0 and INr.ConsgType!=POrw.ConsgType)then begin// Edit ************************** Wednesday, 17 December 2014 09:40:07
			changef = true;
			recordcopy(IN2r,INr);
			INr.ConsgType = POrw.ConsgType;
			switch(INr.ConsgType)begin
				case 1:/*INr.PurchAcc = "41/02";*/
				case 2:INr.PurchAcc = "12";
			end;
		end;
		if(POr.AllowOtherVEItem>0)then begin
			changef = true;
		end;
		
		if ((changef) and (INr.LastPriceChange<=POr.TransDate)) then begin
			recordupdate(IN2r,INr,true);
		end;	
		if(POrw.Price==0 and POr.VECode!="FOB_SKLAD")then begin
			if(POr.CurncyCode==INr.LastPurchCurncyCode)then begin
				POrw.Price = INr.LastPurchPrice2;
			end else begin
				CurValToOtherCur(POr.TransDate,INr.LastPurchCurncyCode,INr.LastPurchPrice2,POr.CurncyCode,price,SetRoundModeD(2));
				POrw.Price = round(price,SetRoundModeD(2));
			end;
			matrowput(POr,i,POrw);
		end;
		POVc_PastePrice(POr,i);
	end;
return;
end;



global
updating procedure UpdateINOnly_NewINJW(var record POVc POr,integer i,boolean found,var record INVc INr,val fr,val to1,val to2,val br1,val br2)
begin
	row POVc POrw;
	record INVc newINr,IN2r;
	record PLVc PLr;
	record PricePointListVc PPLr;// Edit ************************** Friday, 31 August 2012 15:31:36
  row PricePointListVc PPLrw;// Edit ************************** Friday, 31 August 2012 15:31:36
  integer pi,pmtrw,po,rwcnt;// Edit ************************** Wednesday, 5 September 2012 16:06:18
  boolean changef;
  record DIVc DIr;
  row POVc chPOrw;
  val frrate,torate,price;
  integer nextNo;
	record NewClassifChBlock NCCb;
	
	blockLoad(NCCb);
  		
	frrate = fr;
	torate = to1;
	
	if(frrate==0)then begin frrate=1; end;
	if(torate==0)then begin torate=1; end;
	
	rwcnt = matrowcnt(POr);
	matrowget(POr,i,POrw);
	
	if(found==true)then begin
		if (blank(POrw.EAN13Code) or (INr.BarCode==POrw.EAN13Code) or (nonblank(POrw.EAN13Code) and blank(INr.BarCode))) then begin
			recordcopy(IN2r,INr);
			changef = false;
			/*if(nonblank(POrw.xClassification) and INr.DispGroups!=POrw.xClassification)then begin
				FindINGroupViaClass(INr);
			end;*/
			if(nonblank(POrw.Comment) and INr.AlternativeCode!=POrw.Comment)then begin
				changef = true;
				INr.AlternativeCode = POrw.Comment;
			end;
			if(POrw.Price>0 and (POrw.Price!=INr.LastPurchPrice2 or INr.LastPurchCurncyCode!=POr.CurncyCode))then begin
				changef = true;
				if(POr.VECode!="FOB_SKLAD") then begin
					INr.LastPurchCurncyCode = POr.CurncyCode;
					INr.LastPurchPrice2 = POrw.Price;
					INr.InPrice = round(POrw.Price/frrate*torate,SetRoundModeD(2));
				end;
			end;
			if(blank(INr.BarCode))then begin
				if(nonblank(POrw.EAN13Code) and INr.BarCode!=POrw.EAN13Code)then begin
					changef = true;
					INr.BarCode = POrw.EAN13Code;
				end;
			end;
			if(NCCb.ClassifCheck==0)then begin
				if(nonblank(POrw.RowWeight) and INr.RowWeight!=POrw.RowWeight)then begin
					changef = true;
					INr.RowWeight = POrw.RowWeight;
				end;
				if(nonblank(POrw.Size) and INr.Size!=POrw.Size)then begin
					changef = true;
					INr.Size = POrw.Size;
				end;
				if(nonblank(POrw.Metal) and INr.Metal!=POrw.Metal)then begin
					changef = true;
					INr.Metal = POrw.Metal;
				end;
				if(nonblank(POrw.Colour) and INr.Colour!=POrw.Colour)then begin
					changef = true;
					INr.Colour = POrw.Colour;
				end;
				if(nonblank(POrw.MajStoneDet) and INr.MajStoneDet!=POrw.MajStoneDet)then begin
					changef = true;
					INr.MajStoneDet = POrw.MajStoneDet;
				end;
				if(nonblank(POrw.Reference) and INr.Reference!=POrw.Reference)then begin
					changef = true;
					INr.Reference = POrw.Reference;
				end;
				
				if(nonblank(POrw.BrcStr) and INr.BrcStr!=POrw.BrcStr)then begin
					changef = true;
					INr.BrcStr = POrw.BrcStr;
				end;
			end;
			
			if(POrw.ConsgType>0 and INr.ConsgType!=POrw.ConsgType)then begin // Edit ************************** Wednesday, 17 December 2014 09:40:07
				changef = true;
				INr.ConsgType = POrw.ConsgType;
				switch(INr.ConsgType) begin
					case 1:/*INr.PurchAcc = "41/02";*/
					case 2:INr.PurchAcc = "12";
				end;
			end;
			
			if ((changef)/* and (INr.LastPriceChange<=POr.TransDate)*/) then begin
				recordupdate(IN2r,INr,true);
			end;	
			if(POrw.Price==0 and POr.VECode!="FOB_SKLAD")then begin
				if(POr.CurncyCode==INr.LastPurchCurncyCode)then begin
					POrw.Price = INr.LastPurchPrice2;
				end else begin
					CurValToOtherCur(POr.TransDate,INr.LastPurchCurncyCode,INr.LastPurchPrice2,POr.CurncyCode,price,SetRoundModeD(2));
					POrw.Price = round(price,SetRoundModeD(2));
				end;
				matrowput(POr,i,POrw);
			end;
			POVc_PastePrice(POr,i);
		end;
	end;
return;
end;

global
updating procedure NewINJW(var record POVc POr,integer i,boolean found,var record INVc INr,val fr,val to1,val to2,val br1,val br2)
begin
	row POVc POrw;
	record INVc newINr,IN2r;
	record PLVc PLr;
	record PricePointListVc PPLr;// Edit ************************** Friday, 31 August 2012 15:31:36
  row PricePointListVc PPLrw;// Edit ************************** Friday, 31 August 2012 15:31:36
  integer pi,pmtrw,po,rwcnt,nextNo;// Edit ************************** Wednesday, 5 September 2012 16:06:18
  boolean changef;
  record DIVc DIr;
  row POVc chPOrw;
  val frrate,torate,price;
	record NewClassifChBlock NCCb;
	
	blockLoad(NCCb);
  		
	frrate = fr;
	torate = to1;
	
	if(frrate==0)then begin frrate=1; end;
	if(torate==0)then begin torate=1; end;
	
	rwcnt = matrowcnt(POr);
	matrowget(POr,i,POrw);
	if(NCCb.ClassifCheck==0)then begin
		if(found==false)then begin
			if(nonblank(POrw.ArtCode) and nonblank(POrw.Spec) and POrw.Quant>0)then begin
				recordNew(newINr);
				newINr.Code = POrw.ArtCode;
				newINr.Name = POrw.Spec;
				newINr.Unittext = "ШТ";
				newINr.VATCode = "0%";
				if(currentcompany==10)then begin
					newINr.Unittext = "EACH";
					newINr.VATCode = ""; //Edit***************************Sasha2,13:04 23.12.2014
				end;
				if(POr.VECode!="FOB_SKLAD") then begin
					newINr.LastPurchCurncyCode = POr.CurncyCode;
					newINr.LastPurchPrice2 = POrw.Price;
				end;
				if(nonblank(POrw.xClassification))then begin
					newINr.DispGroups = POrw.xClassification;
				end else begin
					newINr.DispGroups = "";
				end;
				FindINGroupViaClass(newINr); //Edit***************************Sasha2,10:55 21.01.2016
				
				newINr.BarCode = POrw.EAN13Code;
				newINr.AlternativeCode = POrw.Comment;
				
				newINr.RowWeight = POrw.RowWeight;
				newINr.Size = POrw.Size;
				newINr.Metal = POrw.Metal;
				newINr.Colour = POrw.Colour;
				newINr.MajStoneDet = POrw.MajStoneDet;
				newINr.BrcStr = POrw.BrcStr;
				newINr.Gender = POrw.Gender;
				newINr.Reference = POrw.Reference;
				newINr.ConsgType = POrw.ConsgType; // Edit ************************** Wednesday, 17 December 2014 09:37:30
				switch(newINr.ConsgType) begin
					case 1:/*newINr.PurchAcc = "41/02";*/
					case 2:newINr.PurchAcc = "12";
				end;
				if(POr.VECode!="FOB_SKLAD") then begin
					newINr.InPrice = round(POrw.Price/frrate*torate,SetRoundModeD(2));
				end;
				recordStore(newINr,true);
				
				POVc_PasteArtCode(POr,i,false);
				POVc_PasteQuant(POr,i);
				
				For(po=0;po<rwcnt;po=po+1) begin // Edit ************************** Friday, 15 February 2013 10:11:45// Edit ************************** Friday, 15 February 2013 10:11:45
					matrowget(POr,po,chPOrw);
					if(chPOrw.ArtCode==newINr.Code) then begin
						POVc_PasteArtCode(POr,po,false);
						POVc_PasteQuant(POr,po);
					end;
				end; 
			end;
		end;
	end;
	
	if(found==true)then begin

		//if (INr.BarCode == POrw.EAN13Code and (nonblank(INr.BarCode)) or (blank(INr.BarCode) and  blank(POrw.EAN13Code))) then begin
		if (blank(POrw.EAN13Code) or (INr.BarCode == POrw.EAN13Code) or (nonblank(POrw.EAN13Code) and blank(INr.BarCode))) then begin
				recordcopy(IN2r,INr);
				changef = false;
				if(NCCb.ClassifCheck==0)then begin
					if(nonblank(POrw.xClassification) and (INr.DispGroups!=POrw.xClassification or blank(INr.Group)))then begin
						changef = true;
						INr.DispGroups = POrw.xClassification;
						FindINGroupViaClass(INr); //Edit***************************Sasha2,10:55 21.01.2016
						
					end;
				end;
				
				if(nonblank(POrw.Comment) and INr.AlternativeCode!=POrw.Comment)then begin
					changef = true;
					INr.AlternativeCode = POrw.Comment;
				end;
				if(POrw.Price>0 and (POrw.Price!=INr.LastPurchPrice2 or INr.LastPurchCurncyCode!=POr.CurncyCode))then begin
					changef = true;
					if(POr.VECode!="FOB_SKLAD") then begin
						INr.LastPurchCurncyCode = POr.CurncyCode;
						INr.LastPurchPrice2 = POrw.Price;
						INr.InPrice = round(POrw.Price/frrate*torate,SetRoundModeD(2));
					end;
				end;
				if(blank(INr.BarCode))then begin
					if(nonblank(POrw.EAN13Code) and INr.BarCode!=POrw.EAN13Code)then begin
						changef = true;
						INr.BarCode = POrw.EAN13Code;
					end;
				end;
				if(NCCb.ClassifCheck==0)then begin
					if(nonblank(POrw.RowWeight) and INr.RowWeight!=POrw.RowWeight)then begin
						changef = true;
						INr.RowWeight = POrw.RowWeight;
					end;
					if(nonblank(POrw.Size) and INr.Size!=POrw.Size)then begin
						changef = true;
						INr.Size = POrw.Size;
					end;
					if(nonblank(POrw.Metal) and INr.Metal!=POrw.Metal)then begin
						changef = true;
						INr.Metal = POrw.Metal;
					end;
					if(nonblank(POrw.Colour) and INr.Colour!=POrw.Colour)then begin
						changef = true;
						INr.Colour = POrw.Colour;
					end;
					if(nonblank(POrw.MajStoneDet) and INr.MajStoneDet!=POrw.MajStoneDet)then begin
						changef = true;
						INr.MajStoneDet = POrw.MajStoneDet;
					end;
					if(nonblank(POrw.Reference) and INr.Reference!=POrw.Reference)then begin
						changef = true;
						INr.Reference = POrw.Reference;
					end;
					
					if(nonblank(POrw.BrcStr) and INr.BrcStr!=POrw.BrcStr)then begin
						changef = true;
						INr.BrcStr = POrw.BrcStr;
					end;
				end;
				if(POrw.ConsgType>0 and INr.ConsgType!=POrw.ConsgType)then begin // Edit ************************** Wednesday, 17 December 2014 09:40:07
					changef = true;
					recordcopy(IN2r,INr);
					INr.ConsgType = POrw.ConsgType;
					switch(INr.ConsgType) begin
						case 1:/*INr.PurchAcc = "41/02";*/
						case 2:INr.PurchAcc = "12";
					end;
				end;
				
				if ((changef)/* and (INr.LastPriceChange<=POr.TransDate)*/) then begin
					recordupdate(IN2r,INr,true);
					//recordStore(INr,true);
				end;	
				if(POrw.Price==0 and POr.VECode!="FOB_SKLAD")then begin
					if(POr.CurncyCode==INr.LastPurchCurncyCode)then begin
						POrw.Price = INr.LastPurchPrice2;
					end else begin
						CurValToOtherCur(POr.TransDate,INr.LastPurchCurncyCode,INr.LastPurchPrice2,POr.CurncyCode,price,SetRoundModeD(2));
						POrw.Price = round(price,SetRoundModeD(2));
					end;
					matrowput(POr,i,POrw);
				end;
				POVc_PastePrice(POr,i);
		
		//matrowput(POr,i,POrw);
		end else begin //Edit----------------------------------------------------Dima  27.04.2015
			if(NCCb.ClassifCheck==0)then begin
				if(nonblank(POrw.ArtCode) and nonblank(POrw.Spec) and POrw.Quant>0)then begin
					//recordNew(newINr);
					nextNo = 1;
					newINr.Code = POrw.ArtCode & nextNo;
					while (ReadFirstMain(newINr,1,true)) begin
						nextNo = nextNo + 1;
						newINr.Code = POrw.ArtCode & nextNo;			
					end;
					recordNew(newINr);
					newINr.Code = POrw.ArtCode & nextNo;
					newINr.Name = POrw.Spec;
					newINr.Unittext = "ШТ";
					newINr.VATCode = "0%";
					if(currentcompany==10)then begin
						newINr.Unittext = "EACH";
						newINr.VATCode = ""; //Edit***************************Sasha2,13:04 23.12.2014
					end;
					if(POr.VECode!="FOB_SKLAD") then begin
						newINr.LastPurchCurncyCode = POr.CurncyCode;
						newINr.LastPurchPrice2 = POrw.Price;
					end;
					if(nonblank(POrw.xClassification))then begin
						newINr.DispGroups = POrw.xClassification;
					end else begin
						newINr.DispGroups = "";
					end;
					FindINGroupViaClass(newINr); //Edit***************************Sasha2,10:55 21.01.2016
					
					if(blank(newINr.BarCode))then begin
						newINr.BarCode = POrw.EAN13Code;
					end;
					newINr.AlternativeCode = POrw.Comment;
					
					newINr.RowWeight = POrw.RowWeight;
					newINr.Size = POrw.Size;
					newINr.Metal = POrw.Metal;
					newINr.Colour = POrw.Colour;
					newINr.MajStoneDet = POrw.MajStoneDet;
					newINr.BrcStr = POrw.BrcStr;
					newINr.Gender = POrw.Gender;
					newINr.Reference = POrw.Reference;
					newINr.ConsgType = POrw.ConsgType; // Edit ************************** Wednesday, 17 December 2014 09:37:30
					switch(newINr.ConsgType) begin
						case 1:/*newINr.PurchAcc = "41/02";*/
						case 2:newINr.PurchAcc = "12";
					end;
					if(POr.VECode!="FOB_SKLAD") then begin
						newINr.InPrice = round(POrw.Price/frrate*torate,SetRoundModeD(2));
					end;
					recordStore(newINr,true);
					
					POrw.ArtCode = newINr.Code;
					MatRowPut(POr,i,POrw);
					POVc_PasteArtCode(POr,i,false);
					POVc_PasteQuant(POr,i);
					
					For(po=0;po<rwcnt;po=po+1) begin
						matrowget(POr,po,chPOrw);
						if(chPOrw.ArtCode==newINr.Code) then begin
							POVc_PasteArtCode(POr,po,false);
							POVc_PasteQuant(POr,po);
						end;
					end; 
				end;
			end;
		end;
		
	end;
return;
end;

global
updating procedure NewINLLardo(var record POVc POr,integer i,boolean found,var record INVc INr,val fr,val to1,val to2,val br1,val br2)
begin
	row POVc POrw;
	record INVc newINr,IN2r;
	record PLVc PLr;
	record PricePointListVc PPLr;// Edit ************************** Friday, 31 August 2012 15:31:36
  row PricePointListVc PPLrw;// Edit ************************** Friday, 31 August 2012 15:31:36
  integer pi,pmtrw,po,rwcnt;// Edit ************************** Wednesday, 5 September 2012 16:06:18
  boolean changef;
  record DIVc DIr;
  row POVc chPOrw;
  val frrate,torate,price;
	record NewClassifChBlock NCCb;
	
	blockLoad(NCCb);
  
	frrate = fr;
	torate = to1;
	
	if(frrate==0)then begin frrate=1; end;
	if(torate==0)then begin torate=1; end;
	
	rwcnt = matrowcnt(POr);
	matrowget(POr,i,POrw);
	if(NCCb.ClassifCheck==0)then begin
		if(found==false)then begin
			if(nonblank(POrw.ArtCode) and nonblank(POrw.Spec) and POrw.Quant>0)then begin
				recordNew(newINr);
				newINr.Code = POrw.ArtCode;
				newINr.Name = POrw.Spec;
				newINr.Unittext = "ШТ";
				newINr.VATCode = "0%";
				if(POr.VECode!="FOB_SKLAD") then begin
					newINr.LastPurchCurncyCode = POr.CurncyCode;
					newINr.LastPurchPrice2 = POrw.Price;
				end;
				newINr.ConsgType = POrw.ConsgType;// Edit ************************** Wednesday, 17 December 2014 09:37:30
				switch(newINr.ConsgType)begin
					case 1:/*newINr.PurchAcc = "41/02";*/
					case 2:newINr.PurchAcc = "12";
				end;
				if(nonblank(POrw.xClassification))then begin
					newINr.DispGroups = POrw.xClassification;
				end else begin
					newINr.DispGroups = "GENERAL";
				end;
				FindINGroupViaClass(newINr);//Edit***************************Sasha2,10:51 21.01.2016
							
				newINr.AlternativeCode = POrw.EAN13Code;
				if(POr.VECode!="FOB_SKLAD") then begin
					newINr.InPrice = round(POrw.Price/frrate*torate,SetRoundModeD(2));
				end;
				recordStore(newINr,true);
				
				POVc_PasteArtCode(POr,i,false);
				POVc_PasteQuant(POr,i);
				
				For(po=0;po<rwcnt;po=po+1) begin// Edit ************************** Friday, 15 February 2013 10:11:45// Edit ************************** Friday, 15 February 2013 10:11:45
					matrowget(POr,po,chPOrw);
					if(chPOrw.ArtCode==newINr.Code)then begin
						POVc_PasteArtCode(POr,po,false);
						POVc_PasteQuant(POr,po);
					end;
				end; 
			end;
		end;
	end;
	if(found==true)then begin
		recordcopy(IN2r,INr);
		changef = false;
		if(nonblank(POrw.Spec) and INr.Name!=POrw.Spec)then begin
			changef = true;
			INr.Name = POrw.Spec;
		end;
		if(NCCb.ClassifCheck==0)then begin
			if(nonblank(POrw.xClassification) and (INr.DispGroups!=POrw.xClassification or blank(INr.Group)))then begin
				changef = true;
				INr.DispGroups = POrw.xClassification;
				FindINGroupViaClass(INr); //Edit***************************Sasha2,10:51 21.01.2016	
			end;
		end;
		if(nonblank(POrw.EAN13Code) and INr.AlternativeCode!=POrw.EAN13Code)then begin
			changef = true;
			INr.AlternativeCode = POrw.EAN13Code;
		end;
		if(POrw.Price>0 and (POrw.Price!=INr.LastPurchPrice2 or INr.LastPurchCurncyCode!=POr.CurncyCode))then begin
			changef = true;
			if(POr.VECode!="FOB_SKLAD") then begin
				INr.LastPurchCurncyCode = POr.CurncyCode;
				INr.LastPurchPrice2 = POrw.Price;
				INr.InPrice = round(POrw.Price/frrate*torate,SetRoundModeD(2));
			end;
		end;
		if(POrw.ConsgType>0 and INr.ConsgType!=POrw.ConsgType)then begin// Edit ************************** Wednesday, 17 December 2014 09:40:07
			changef = true;
			recordcopy(IN2r,INr);
			INr.ConsgType = POrw.ConsgType;
			switch(INr.ConsgType)begin
				case 1:/*INr.PurchAcc = "41/02";*/
				case 2:INr.PurchAcc = "12";
			end;
		end;
		
		if ((changef)/* and (INr.LastPriceChange<=POr.TransDate)*/) then begin
			recordupdate(IN2r,INr,true);
		end;	
		if(POrw.Price==0 and POr.VECode!="FOB_SKLAD")then begin
			if(POr.CurncyCode==INr.LastPurchCurncyCode)then begin
				POrw.Price = INr.LastPurchPrice2;
			end else begin
				CurValToOtherCur(POr.TransDate,INr.LastPurchCurncyCode,INr.LastPurchPrice2,POr.CurncyCode,price,SetRoundModeD(2));
				POrw.Price = round(price,SetRoundModeD(2));
			end;
			matrowput(POr,i,POrw);
		end;
		POVc_PastePrice(POr,i);
		
		//matrowput(POr,i,POrw);
	end;
return;
end;

global
updating procedure NewINSwarowski(var record POVc POr,integer i,boolean found,var record INVc INr,val fr,val to1,val to2,val br1,val br2)
begin
	row POVc POrw;
	record INVc newINr,IN2r;
	record PLVc PLr,PL2r;
	record PricePointListVc PPLr;// Edit ************************** Friday, 31 August 2012 15:31:36
  row PricePointListVc PPLrw;// Edit ************************** Friday, 31 August 2012 15:31:36
  integer pi,pmtrw,po,rwcnt;// Edit ************************** Wednesday, 5 September 2012 16:06:18
  boolean changef;
  record DIVc DIr;
  row POVc chPOrw;
  val qty,price;
	record NewClassifChBlock NCCb;
	
	blockLoad(NCCb);
  	
  	rwcnt = matrowcnt(POr);
		matrowget(POr,i,POrw);
	if(NCCb.ClassifCheck==0)then begin
		if(found==false)then begin
			if(nonblank(POrw.ArtCode) and nonblank(POrw.Spec) and POrw.Quant>0)then begin
				recordNew(newINr);
				newINr.Code = POrw.ArtCode;
				newINr.Name = POrw.Spec;
				newINr.Unittext = "ШТ";
				newINr.VATCode = "0%";
				if(POr.VECode!="FOB_SKLAD") then begin
					newINr.LastPurchCurncyCode = POr.CurncyCode;
					newINr.LastPurchPrice2 = POrw.Price;
				end;
				newINr.DispGroups = POrw.xClassification;
				newINr.AlternativeCode = POrw.EAN13Code;
				newINr.CPSCode = POrw.PPNum;
				newINr.ConsgType = POrw.ConsgType;// Edit ************************** Wednesday, 17 December 2014 09:37:30
				switch(newINr.ConsgType)begin
					case 1:/*newINr.PurchAcc = "41/02";*/
					case 2:newINr.PurchAcc = "12";
				end;
				recordStore(newINr,true);
				if(POr.VECode!="FOB_SKLAD") then begin
					recordNew(PLr);
					PLr.PLCode  = "RRP";
					PLr.ArtCode = newINr.Code;
					PLr.Comment = POrw.Spec;
					PPLr.TransDate = CurrentDate;
					if(POrw.PPNum>0)then begin
						loopbackkey("TransDate",PPLr,1,true);
						pmtrw = matrowcnt(PPLr);
						if(POrw.PPNum<=pmtrw)then begin
							matrowget(PPLr,POrw.PPNum-1,PPLrw);
							PLr.ExVatPrice = PPLrw.Price*POrw.VEQuant/POrw.Quant;
							PLr.ExVatPrice = round(PLr.ExVatPrice,SetRoundModeD(0));
							PLr.CurncyCode = "";
							if(PLr.ExVatPrice==0)then begin PLr.ExVatPrice=1; end;
							newINr.InPrice = PPLrw.Cost;
							RecordStore(newINr,true);
						end;
					end;
					recordStore(PLr,true);
					UpdatePrice(PLr);
				end;
				POVc_PasteArtCode(POr,i,false);
				POVc_PasteQuant(POr,i);
				matrowget(POr,i,POrw);
				POrw.Price = newINr.InPrice/POrw.VEQuant*POrw.Quant;
				matrowput(POr,i,POrw);
				POVc_PastePrice(POr,i);
				
				For(po=0;po<rwcnt;po=po+1) begin// Edit ************************** Friday, 15 February 2013 10:11:45// Edit ************************** Friday, 15 February 2013 10:11:45
					matrowget(POr,po,chPOrw);
					if(chPOrw.ArtCode==newINr.Code)then begin
						POVc_PasteArtCode(POr,po,false);
						POVc_PasteQuant(POr,po);
					end;
				end; 
			end;
		end;
	end;
	if(found==true)then begin
		recordcopy(IN2r,INr);
		changef = false;
		if(nonblank(POrw.Spec) and INr.Name!=POrw.Spec)then begin
			changef = true;
			INr.Name = POrw.Spec;
		end;
		/*if(nonblank(POrw.xClassification) and INr.DispGroups!=POrw.xClassification)then begin
			changef = true;
			INr.DispGroups = POrw.xClassification;
		end;*/
		if(NCCb.ClassifCheck==0)then begin
			if(nonblank(POrw.xClassification) and blank(INr.DispGroups))then begin	// Edit by Victor 24.11.14
				changef = true;
				INr.DispGroups = POrw.xClassification;
			end;
		end;

		if(nonblank(POrw.EAN13Code) and INr.AlternativeCode!=POrw.EAN13Code)then begin
			changef = true;
			INr.AlternativeCode = POrw.EAN13Code;
		end;
		if(POrw.PPNum>0 and stringtoint(INr.CPSCode)!=POrw.PPNum)then begin
			changef = true;
			INr.CPSCode = POrw.PPNum;
		end;

		if(POrw.ConsgType>0 and INr.ConsgType!=POrw.ConsgType)then begin// Edit ************************** Wednesday, 17 December 2014 09:40:07
			changef = true;
			recordcopy(IN2r,INr);
			INr.ConsgType = POrw.ConsgType;
			switch(INr.ConsgType)begin
				case 1:/*INr.PurchAcc = "41/02";*/
				case 2:INr.PurchAcc = "12";
			end;
			recordupdate(IN2r,INr,true);
		end;
		if(changef)then begin
			if(POr.VECode!="FOB_SKLAD") then begin
				PLr.PLCode  = "RRP";
				PLr.ArtCode = INr.Code;
				if(readfirstmain(PLr,2,true))then begin
					recordcopy(PL2r,PLr);
					PPLr.TransDate = CurrentDate;
						if(POrw.PPNum>0)then begin
							loopbackkey("TransDate",PPLr,1,true);
							pmtrw = matrowcnt(PPLr);
							if(POrw.PPNum<=pmtrw)then begin
								matrowget(PPLr,POrw.PPNum-1,PPLrw);
								qty = POrw.VEQuant/POrw.Quant;
								if(qty==0)then begin qty = 1; end;
								INr.InPrice = PPLrw.Cost*qty;// Edit ************************** Wednesday, 13 February 2013 18:08:27
								if(PLr.DonotRecalculate==0)then begin
									PLr.ExVatPrice = PPLrw.Price*POrw.VEQuant/POrw.Quant;
									PLr.ExVatPrice = round(PLr.ExVatPrice,SetRoundModeD(0));
									PLr.CurncyCode = "";
									if(PLr.ExVatPrice==0)then begin PLr.ExVatPrice=1; end;
								end;
							end;
						end;
					recordUpdate(PL2r,PLr,true);
				end else begin
					recordNew(PLr);
						PLr.PLCode  = "RRP";
						PLr.ArtCode = INr.Code;
						PLr.Comment = POrw.Spec;
						PPLr.TransDate = CurrentDate;
						if(POrw.PPNum>0)then begin
							loopbackkey("TransDate",PPLr,1,true);
							pmtrw = matrowcnt(PPLr);
							if(POrw.PPNum<=pmtrw)then begin
								matrowget(PPLr,POrw.PPNum-1,PPLrw);
								PLr.ExVatPrice = PPLrw.Price*POrw.VEQuant/POrw.Quant;
								PLr.ExVatPrice = round(PLr.ExVatPrice,SetRoundModeD(0));
								PLr.CurncyCode = "";
								if(PLr.ExVatPrice==0)then begin PLr.ExVatPrice=1; end;
								qty = POrw.VEQuant/POrw.Quant;
								if(qty==0)then begin qty = 1; end;
								INr.InPrice = PPLrw.Cost*qty;// Edit ************************** Wednesday, 13 February 2013 18:08:27;
							end;
						end;
					recordStore(PLr,true);
					UpdatePrice(PLr);
				end;
			end;
			if ((changef) and (INr.LastPriceChange<=POr.TransDate)) then begin
				recordupdate(IN2r,INr,true);
			end;
			if(POrw.Price==0 and POr.VECode!="FOB_SKLAD")then begin
				if(POr.CurncyCode==INr.LastPurchCurncyCode)then begin
					POrw.Price = INr.LastPurchPrice2;
				end else begin
					CurValToOtherCur(POr.TransDate,INr.LastPurchCurncyCode,INr.LastPurchPrice2,POr.CurncyCode,price,SetRoundModeD(2));
					POrw.Price = round(price,SetRoundModeD(2));
				end;
				matrowput(POr,i,POrw);
			end;
			matrowput(POr,i,POrw);
			POVc_PastePrice(POr,i);
			For(po=0;po<i;po=po+1) begin// Edit ************************** Friday, 15 February 2013 10:11:45// Edit ************************** Friday, 15 February 2013 10:11:45
				matrowget(POr,po,chPOrw);
				if(chPOrw.ArtCode==INr.Code)then begin
					chPOrw.PPNum = POrw.PPNum;
					matrowput(POr,po,chPOrw);
					POVc_PasteArtCode(POr,po,false);
					POVc_PasteQuant(POr,po);
				end;
			end; 
			//matrowput(POr,i,POrw);
		end;
	end;
return;
end;


procedure CheckItemForVendor(string VECode,string ArtCode,integer rownr,var longint res)// Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 11 December 2017 15:10:16
begin
	record ItemHistVc IHr;
	record PUVc PUr;
	
	res = 0;
	if(currentcompany!=9 and currentcompany!=10 and currentcompany!=28 and currentcompany!=18)then begin
		IHr.ArtCode = ArtCode;
		IHr.FileName = "PUVc";
		if(readfirstkey("FNArtCode",IHr,2,false))then begin
			if(IHr.FileName=="PUVc" and IHr.ArtCode==ArtCode)then begin
				PUr.SerNr = IHr.TransNr;
				if(readfirstmain(PUr,1,true))then begin
					IF(NONBLANK(PUr.VECode))THEN BEGIN
						if(VECode!=PUr.VECode and left(PUr.VECode,3)!="FOB" and VECode!="FOB_SKLAD")then begin
							RecordCheckError(35115,"",rownr,"ArtCode");      
							res = 35115;
						end;
					END;
				end;
			end;
		end;
	end;

return;
end;


global
updating function Integer ValidatePORecord(var record POVc POr,record POVc PO2r,LongInt stat,LongInt long4,Boolean disperrf,var string errmsg)
begin
  LongInt res;
  record PRVc PRr;
  record POrderClassVc POCr;
  record POSettingBlock POSettingRec;
  Integer insertmode,updatemode,curcomp;
  string 255 tstr,errstr,objstr;
  Integer i,rwcnt,errcode,k,mtrw;
  LongInt oldnr,newnr;
  Boolean gentrans,found,transf;
  row POVc POrw;
  record INVc INr,INcheck;// Edit ************************** Saturday, 19 August 2017 12:13:08
  record CUVc VEr;
  record PlanDeliveryBlock PDb;
  Integer prevvt,curvt;
  Boolean check,testf2,TrHs;
  record LocationVc Locationr;
  record TaxTemplateVc TTr;
  record SRBlock SRb;
  record SerNrTrackBlock SNrb;
  Array string 255 otcheckaccs;
  Array string 255 otcheckobjtyps;
  Integer otcheckcnt;
  Boolean initotcheckf;    
  transaction string 255 gRuniningMaint;
  record AccVc Accr;
  LongInt l;
  record INVc newINr;// Edit ************************** Friday, 31 August 2012 15:16:22
  record PLVc PLr;// Edit ************************** Friday, 31 August 2012 15:16:36
  record PricePointListVc PPLr;// Edit ************************** Friday, 31 August 2012 15:31:36
  row PricePointListVc PPLrw;// Edit ************************** Friday, 31 August 2012 15:31:36
  integer pi,pmtrw,po;// Edit ************************** Wednesday, 5 September 2012 16:06:18
  boolean changef, testf;
  record DIVc DIr;
  row POVc chPOrw;
  integer lenth,lenth2,t,pos;
  string 100 tclass,tclass2,fullclass;
  boolean findclass, consigconsolf, custcostchf, svCurf;
  val fr,to1,to2,br1,br2;
	record DiCheckBlock DiCb;
	row DiCheckBlock DiCbw;
	vector string 255 diCheckTypes;
	string 255 type,outdisps,mes,ostr,nostr,obj,set,currrow;
	record BackOrderBlock BOb;
	record POVc oldPOr;
	record RLinkVc RLr;
	integer rilnk;
	record PUVc PUr;
	record NewClassifChBlock NCCb;
  record ObjVc Objr;
	integer itemType;
	val ChCustCost;
	record ORVc ORr;
	record ItemDuplicatesVc IDr;  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:42 17.08.2020
	integer ErrRow;
	record BPIBrandVc BBr;
	string 255 vendors;
	boolean findVendors, OtherCurrf,TrHs2,ACCf;
	record LocationVc Locr;
	vector boolean consStock;
	record SHVc SHr;

	res = 0;
  GetFullCurncyRate(POr.CurncyCode,currentdate,fr,to1,to2,br1,br2);
	
	TrHs2 = true;
	Locr.Code = "";
	While(LoopMain(Locr,1,TrHs2)) begin	
		if(nonblank(Locr.ConsigStockCode)) then begin
			consStock[Locr.ConsigStockCode] = true;
			if(POr.Location==Locr.ConsigStockCode) then begin TrHs2 = false; end;
		end;
	end;
	ResetLoop(Locr);
	// Edit Start ---------------------------------------------- Edit Start
	
	
	BlockLoad(BOb);  
  insertmode = 1;
  updatemode = 2;
  
  BlockLoad(SRb);
  if (long4>0) then begin
    check = true;
  end else begin
    check = false;
  end;
  BlockLoad(SNrb);
  BlockLoad(POSettingRec);
  rwcnt = MatRowCnt(POr);
	
	if (CurrentCompany==18 and stat==updatemode and POr.OKFlag==0 and PO2r.OKFlag!=0 and POr.IDGDEAPORef>0) then begin
		if (ReadRecordLink(POr,1,ORr,RLr)) then begin 
			if (ReadRecordLink(ORr,1,SHr,RLr)) then begin
				if (SHr.OKFlag==1) then begin
					RecordCheckError(36393,"",-1,"SerNr");      
					res = -1;
					goto LPOVcRecordCheck;
				end;
			end;
		end;
	end;
	
	if (CurrentCompany==28 and stat==updatemode and POr.OKFlag==0 and PO2r.OKFlag!=0) then begin
		if (ReadRecordLink(POr,1,PUr,RLr)) then begin 
			RecordCheckError(36393,"",-1,"SerNr");      
			res = -1;
			goto LPOVcRecordCheck;
		end;
	end;
	
	
  if (stat==Rs_update) then begin
    if (POr.SerNr<=0) and (PO2r.OKFlag==0) then begin
      POr.SerNr = PO2r.SerNr;
    end;
  end;  
  if (stat==Rs_update) then begin
    if (PO2r.OKFlag!=0) then begin
      goto LPOVcRecordCheck;
    end;
  end;
  oldnr = POr.SerNr;
  if (POr.SerNr<=0) then begin
    newnr = GetCurUserLastNr("POVc");
    if (newnr==-1) then begin newnr = SRb.LastPONr; end;
    POr.SerNr = NextSerNr("POVc",POr.TransDate,newnr,false,"");
  end;
	if (blank(POr.Location) and CurrentCompany==28) then begin
		RecordCheckError(1058,"",-1,"Location");      
    res = -1; 
    goto LPOVcRecordCheck;
	end;
  if (SerNrTestPOVc(POr.SerNr,POr.TransDate,gentrans)==false) then begin
    if (disperrf) then begin
      RecordCheckError(1557,"",-1,"SerNr");      
    end;
    res = 1557; 
    goto LPOVcRecordCheck;
  end;
  if (DisallowFutureDateCheck(disperrf,POr.TransDate,"TransDate",-1)) then begin
    res = -1;
    goto LPOVcRecordCheck;
  end;
  
  
  //Wednesday, 13 November 2013 16:24:21
	if(nonblank(POr.CustomsCost))then begin
		ChCustCost = 0;
		custcostchf = true;
		for (i=0;i<matrowcnt(POr);i=i+1) begin
			matrowget(POr,i,POrw);
			ChCustCost = ChCustCost + StringToVal(POrw.CustomsCost,M4Val) * POrw.Quant;
			if(POrw.Price==0)then begin custcostchf = false; end;
		end;
		ChCustCost = ChCustCost + 10;
		if(POr.CustomsCost>ChCustCost and custcostchf) then begin
			RecordCheckError(36326,"",-1,"CustomsCost");      
			res = 36326;
			goto LPOVcRecordCheck;
		end;
	end;
	
	if(Left(POr.VECode,3)=="FOB" and !(CurrentCompany==28 and POr.IDReguester=="Client"))  then begin
		if (nonblank(POr.Location)) then begin
			Locr.Code = POr.Location;
			if(ReadFirstMain(Locr,1,true)) then begin
				if(blank(Locr.FOBSuplier)) then begin
					RecordCheckError(36380,"",-1,"Location");      
					res = -1;
					goto LPOVcRecordCheck;
				end;
			end;
		end;
	end;
	for (i=0;i<matrowcnt(POr);i=i+1) begin
		matrowget(POr,i,POrw);
		if(consStock[POr.Location] and currentcompany==18) then begin
			POrw.ConsgType = 1;
			POrw.CostAcc = "41/02";
			matrowput(POr,i,POrw);
			matrowget(POr,i,POrw);
		end;
		if(stat==Rs_update)then begin
			if(!consStock[POr.Location] and consStock[PO2r.Location] and currentcompany==18) then begin
				if(POrw.ConsgType==1)then begin
					POrw.ConsgType = 0;
					POrw.CostAcc = "41/01";
					matrowput(POr,i,POrw);
					matrowget(POr,i,POrw);
				end;
			end;
		end;
		if (nonblank(POrw.ArtCode)) then begin
			INr.Code = POrw.ArtCode;
			if (ReadFIrstMain(INr,1,true)) then begin
				findVendors = false;
				if(Left(POr.VECode,3)=="FOB") then begin findVendors = true; end;
				if(nonblank(INr.BPIBrand) and findVendors==false and currentcompany==18) then begin
					BBr.Code = INr.BPIBrand;
					if(ReadFirstMain(BBr,1,true)) then begin
						pos = 0;
						vendors = "";
						ExtractObj(BBr.Vendor,pos,vendors);
						while(nonblank(vendors))begin
							if(vendors==POr.VECode) then begin
								findVendors = true;
							end;
							ExtractObj(BBr.Vendor,pos,vendors);
						end;
					end;
				end;
				if(findVendors==false and currentcompany==18 and INr.ConsgType<3 and POr.Location!="CWH_I") then begin
					RecordCheckError(36375,"",i,"ArtCode");      
					res = -1;
					goto LPOVcRecordCheck;
				end;
				IDr.DupCode = POrw.ArtCode;
				TrHs = true;
				while (loopkey("DupCode",IDr,1,TrHs)) begin
					testf = true;
					if (IDr.DupCode!=POrw.ArtCode) then begin TrHs = false; testf = false; end;
					if (IDr.DupBrandCode!=INr.BPIBrand) then begin  testf = false; end;
					if (testf and Left(POr.VECode,3)!="FOB") then begin
						RecordCheckError(36369,"",i,"ArtCode");      
						res = -1;
						goto LPOVcRecordCheck;
					end;
				end;
				ResetLoop(IDr);
			end;
		end;
	end;
	
	
	
	if(POr.OKFlag==0)then begin
		POr.OKDate = "";
	end;
	if(POr.OrderDoneFlag==0)then begin
		POr.OrderDoneDate = "";
	end;
	if(stat==insertmode)then begin
		if(POr.OKFlag==1)then begin
			if (blankdate(POr.IDMfrFinDate) and (CurrentCompany==28 or CurrentCompany==18)) then begin
				RecordCheckError(36370,"",-1,"IDMfrFinDate");      
				res = 36370;
				goto LPOVcRecordCheck;
			end;
			POr.OKDate = currentdate;
		end;
		if(POr.OrderDoneFlag==1 and blank(POr.OrderDoneDate))then begin
			POr.OrderDoneDate = currentdate;
		end;
	end;
	if (CurrentCompany==18) then begin
		ACCf = false;
		i = 0;
		pos = 0;
		ExtractObj(POr.Objects,i,obj);
		while(nonblank(obj)) begin
			Objr.Code = obj;
			if(ReadFirstMain(Objr,1,true)) then begin
				if(Objr.OTCode=="ACC") then begin
					ACCf = true;
				end;
			end;
			ExtractObj(POr.Objects,i,obj);
		end;
		if(stat==updatemode)then begin
			if(POr.OKFlag==1 and PO2r.OKFlag==0)then begin
				if (!ACCf and currentuser!="SA3") then begin
					RecordCheckError(36383,"",-1,"Objects");      
					res = 36383;
					goto LPOVcRecordCheck;
				end;
			end;
		end;
		if(stat==insertmode)then begin
			if(POr.OKFlag==1)then begin
				if (!ACCf and currentuser!="SA3") then begin
					RecordCheckError(36383,"",-1,"Objects");      
					res = 36383;
					goto LPOVcRecordCheck;
				end;
			end;
		end;
	end;
	if(stat==updatemode)then begin
		if(POr.OKFlag==1 and PO2r.OKFlag==0)then begin
			if (blankdate(POr.IDMfrFinDate) and (CurrentCompany==28 or CurrentCompany==18)) then begin
				RecordCheckError(36370,"",-1,"IDMfrFinDate");      
				res = 36370;
				goto LPOVcRecordCheck;
			end;
			POr.OKDate = currentdate;
		end;
		if(POr.OrderDoneFlag==1 and blank(POr.OrderDoneDate))then begin
			POr.OrderDoneDate = currentdate;
		end;
		PUr.PONr = PO2r.SerNr;
		if(ReadFirstKey("PONr",PUr,1,true) and PUr.PONr>0)then begin
			if(PO2r.SerNr!=POr.SerNr)then begin
				RecordCheckError(1067,"",-1,"SerNr");      
				res = 1067;
				goto LPOVcRecordCheck;
			end;
			if(PO2r.Reference!=POr.Reference)then begin
				RecordCheckError(1067,"",-1,"Reference");      
				res = 1067;
				goto LPOVcRecordCheck;
			end;
			if(PO2r.IDRefPRNum!=POr.IDRefPRNum)then begin
				RecordCheckError(1067,"",-1,"IDRefPRNum");      
				res = 1067;
				goto LPOVcRecordCheck;
			end;
		end;
	end;
	
	// Edit End ---------------------------------------------- Edit End
	if(POr.ShipCostOKFlag==1 and POr.ExtraCostInPU==1)then begin
		RecordCheckError(36281,"",-1,"ExtraCostInPU");      
		res = 36281;
		goto LPOVcRecordCheck;
	end;
	
	if(POr.CustomsCostOKFlag==1 and POr.ExtraCostInPU==1)then begin
		RecordCheckError(36281,"",-1,"ExtraCostInPU");      
		res = 36281;
		goto LPOVcRecordCheck;
	end;
	
	if (POr.VECode == "FOB_SKLAD" and POr.OKFlag==0 and PO2r.OKFlag==1 and left(CurrentUser,2)!="SA") then begin
		curcomp = currentcompany;
		SetCompany(18,false);
		ORr.OfficialSerNr = POr.SerNr & ":" &  curcomp;
		if (ReadFirstKey("OfficialSerNr",ORr,1,true)) then begin
			RecordCheckError(36356,"",-1,"SerNr");      
			res = 36356;
			goto LPOVcRecordCheck;
		end;
		ResetCompany(curcomp);
	end;
	
	
	if(currentcompany==28)then begin
		if(nonblank(POr.Reference))then begin
			TrHs = true;
			oldPOr.Reference = POr.Reference;
			while(loopkey("Reference",oldPOr,1,TrHs))begin
				if(oldPOr.Reference!=POr.Reference)then begin
					TrHs = false;
				end;
				if(TrHs)then begin
					if(oldPOr.SerNr!=POr.SerNr)then begin
						RecordCheckError(1545,"",-1,"Reference");      
						res = 1545;
						goto LPOVcRecordCheck;
					end;
				end;
			end;
		end;
	end;
	
	// if (nonblank(POr.PayDeal) and !PTCCCodesCheck(POr.PayDeal)) then begin
		// RecordCheckError(36343,"",-1,"PayDeal");      
		// res = 36343;
		// goto LPOVcRecordCheck;
	// end;
	
	if(stat==updatemode)then begin
		if(POr.OKFlag==1 and PO2r.OKFlag==0 and  POr.CheckCurncyCode!=POr.CurncyCode)then begin	// Edit by Victor 20.11.14
			RecordCheckError(31098,"",-1,"CheckCurncyCode");      
			res = 31098;
			goto LPOVcRecordCheck;
		end;
	end;
	if(stat==insertmode)then begin
		if(POr.OKFlag==1 and  POr.CheckCurncyCode!=POr.CurncyCode)then begin	// Edit by Victor 20.11.14
			RecordCheckError(31098,"",-1,"CheckCurncyCode");      
			res = 31098;
			goto LPOVcRecordCheck;
		end;
	end;
  
  
  transf = false;
  if (POr.OKFlag==1) then begin
    if (stat==insertmode) then begin transf = true; end;
    if (stat==updatemode) then begin
      if (PO2r.OKFlag==0) then begin transf = true; end;
    end;
  end;
  if (transf) then begin
    if (UserCanAction("POOK",true)==false) then begin
      if (disperrf) then begin
        RecordCheckError(1274,StringFromStringSet(3,"POOK"),-1,"SerNr");      
      end;
      res = 1274;
      goto LPOVcRecordCheck;
    end;
  end;  
  if (RecordValid(PO2r)) then begin
    if (PO2r.OKFlag!=0) and (POr.OKFlag!=1)  then begin
      if (UserCanAction("UnOKPO",true)==false) and (UserCanAction("UnOKAll",true)==false) then begin
        if (disperrf) then begin
          RecordCheckError(1274,StringFromStringSet(3,"UnOKPO"),-1,"SerNr");      
        end;
        res = 1274;
        goto LPOVcRecordCheck;
      end;
      if (POReservationsExists(POr)) then begin
        if (disperrf) then begin
          RecordCheckError(1274,"",-1,"SerNr");      
        end;
        res = 1274;
        goto LPOVcRecordCheck;
      end;
    end;  
  end;
  if (currentcompany!=28 and currentcompany!=18) then begin
    if (CheckPDExists(POr.PayDeal)==false) then begin
      if (disperrf) then begin
        RecordCheckError(1256,"",-1,"PayDeal");      
      end;
      res = 1256;
      goto LPOVcRecordCheck;        
    end; 
  end;
  switch (PayTermType(POr.PayDeal)) begin
    case kInvoiceTypeCredit:
      RecordCheckError(1227,POr.PayDeal,-1,"PayDeal");      
      res = -1;
      goto LPOVcRecordCheck;
    case kInvoiceTypeEmployee:
      RecordCheckError(1958,"",-1,"PayDeal");      
      res = -1;
      goto LPOVcRecordCheck;
  end;
  
  if (CheckPOCQStatVECode(POr.POCQStatNr,POr.VECode,i)==false) then begin
    if (disperrf) then begin
      RecordCheckError(i,"",-1,"POCQStatNr");      
    end;
    res = i; 
    goto LPOVcRecordCheck;
  end;  
  //if (currentcompany!=28) then begin??????
    VEr.Code = POr.VECode;
    if (ReadFirstMain(VEr,1,true)==false) then begin
      if (disperrf) then begin
        RecordCheckError(1205,"",-1,"VECode");      
      end;
      res = 1205; 
      goto LPOVcRecordCheck;
    end;
  //end;
  if (VEr.blockedFlag!=0) then begin
    if (disperrf) then begin
      RecordCheckError(20872,POr.VECode,-1,"VECode");      
    end;
    res = -1;
    goto LPOVcRecordCheck;
  end;
  if (nonblank(VEr.VECurncyCode)) then begin
    if (VEr.VECurncyCode!=POr.CurncyCode) then begin
      if (disperrf) then begin
        RecordCheckError(1217,"",-1,"CurncyCode");
      end;
      res = -1;
      goto LPOVcRecordCheck;
    end;
  end;      
  
  if(currentcompany!=28)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 28 August 2018 10:15:00
		if (rwcnt==0) then begin
			if (disperrf) then begin
				RecordCheckError(1030,"",-1,"SerNr");      
			end;
			res = 1030; 
			goto LPOVcRecordCheck;
		end;
  end;
  if (nonblank(POr.PRCode)) then begin
    PRr.Code = POr.PRCode;
    if (ReadFirstMain(PRr,1,true)==false) then begin
      if (disperrf) then begin
        RecordCheckError(1232,"",-1,"PRCode");      
      end;
      res = 1232; 
      goto LPOVcRecordCheck;
    end;
    if (PRr.Terminated!=0) then begin
      if (disperrf) then begin
        RecordCheckError(1232,"",-1,"PRCode");      
      end;
      res = 1232; 
      goto LPOVcRecordCheck;
    end;        
  end;  
  if (nonblank(POr.Location)) then begin
    Locationr.Code = POr.Location;
    if (ReadFirstMain(Locationr,1,true)==false) then begin
      RecordCheckError(1290,"",-1,"Location");      
      res = -1;
      goto LPOVcRecordCheck;
    end;
  end;
	if(currentcompany==28) then begin
		Objr.Code = POr.IDPrjNum;
		if(ReadFirstMain(Objr,1,true)) then begin
			if(!SetInSet(POr.IDPrjNum,POr.Objects)) then begin
				if(blank(POr.Objects)) then begin
					errcode = CheckObjs("",POr.IDPrjNum,errstr);
					if(errcode==0) then begin
						POr.Objects = POr.IDPrjNum;
					end;
				end else begin
					errcode = CheckObjs("",POr.Objects & "," & POr.IDPrjNum,errstr);
					if(errcode==0) then begin
						POr.Objects = POr.Objects & "," & POr.IDPrjNum;
					end else begin
						i = 0;
						pos = 0;
						set = "";
						ExtractObj(POr.Objects,i,obj);
						while(nonblank(obj)) begin
							Objr.Code = obj;
							if(pos!=0) then begin
								set = set & ",";
							end;
							pos = pos+1;
							if(ReadFirstMain(Objr,1,true)) then begin
								if(Objr.OTCode=="PRC") then begin
									set = set & POr.IDPrjNum;
								end else begin
									set = set & obj;
								end;
							end;
							ExtractObj(POr.Objects,i,obj);
						end;
						POr.Objects = set;
					end;
				end;
			end;	
		end;
	end;
	
  if (nonblank(POr.Objects)) then begin     
    errcode = CheckObjs("",POr.Objects,errstr);
    if (errcode!=0) then begin
      if (disperrf) then begin
        RecordCheckError(errcode,errstr,-1,"Objects");      
      end;
      res = errcode; 
      goto LPOVcRecordCheck;
    end;
  end;  
  if (check) then begin
  if (POSettingRec.ReqPOClass==1) then begin
    if (blank(POr.POClass)) then begin
      if (disperrf) then begin
        RecordCheckError(20096,"",-1,"POClass");
      end;
      res = 20096;
      goto LPOVcRecordCheck;  
    end;
  end;  
  end;
  if (nonblank(POr.POClass)) then begin
    POCr.Code = POr.POClass;
    if (ReadFirstMain(POCr,1,true)==false) then begin
      if (disperrf) then begin
        RecordCheckError(20097,"",-1,"POClass");
      end;
      res = 20097;
      goto LPOVcRecordCheck;
    end;
  end;
  if (WillPOQtyCoverReservations(POr)==false) then begin
    if (disperrf) then begin
      RecordCheckError(22066,"",-1,"SerNr");
    end;
    res = 22066;
    goto LPOVcRecordCheck;
  end;
  if (HasLocalization("PRT")) then begin
    VEr.Code = POr.VECode;
    if (ReadFirstMain(VEr,1,true)) then begin
      if (blank(VEr.VATNr)) then begin
        RecordCheckError(20275,"",-1,"VECode");      
        res = -1;
        goto LPOVcRecordCheck;
      end;
    end;
  end;
	if (stat==updatemode) then begin
		if ((POr.OKFlag!=0) and (PO2r.OKFlag==0)) then begin
			if (nonblank(POr.ItemFromOtherSTockObj)) then begin
				ErrRow = POCheckItemStockInCompSender(POr,OtherCurrf);
				if (ErrRow>-1) then begin
					if (OtherCurrf) then begin
						RecordCheckError(36382,"",ErrRow,"ArtCode");      
						res = -1;
						goto LPOVcRecordCheck;
					end else begin
						RecordCheckError(36373,"",ErrRow,"ArtCode");      
						res = -1;
						goto LPOVcRecordCheck;
					end;
				end;
				
				i = 0;
				set = "";
				ExtractObj(POr.Objects,i,obj);
				while(nonblank(obj)) begin
					Objr.Code = obj;
					if(ReadFirstMain(Objr,1,true)) then begin
						if(Objr.OTCode=="STORE") then begin
							set = obj;
						end;
					end;
					ExtractObj(POr.Objects,i,obj);
				end;
				if (blank(set)) then begin
					if (matrowcnt(POr) > 0) then begin
						matrowget(POr,0,POrw);
						if (nonblank(POrw.Objects)) then begin
							i = 0;
							ExtractObj(POrw.Objects,i,obj);
							while(nonblank(obj)) begin
								Objr.Code = obj;
								if(ReadFirstMain(Objr,1,true)) then begin
									if(Objr.OTCode=="STORE") then begin
										if (nonblank(POr.Objects)) then begin POr.Objects = POr.Objects & ","; end;
										POr.Objects = POr.Objects & obj;
										set = obj;
									end;
								end;
								ExtractObj(POrw.Objects,i,obj);
							end;
						end;
					end;
					if (blank(set)) then begin
						RecordCheckError(36378,"",-1,"Objects");      
						res = -1;
						goto LPOVcRecordCheck;
					end;
				end;
			end;
		end;
	end;
	
	if (stat==insertmode) then begin
		if (POr.OKFlag!=0) then begin
			if (nonblank(POr.ItemFromOtherSTockObj)) then begin
				ErrRow = POCheckItemStockInCompSender(POr,OtherCurrf);
				if (ErrRow>-1) then begin
					if (OtherCurrf) then begin
						RecordCheckError(36382,"",ErrRow,"ArtCode");      
						res = -1;
						goto LPOVcRecordCheck;
					end else begin
						RecordCheckError(36373,"",ErrRow,"ArtCode");      
						res = -1;
						goto LPOVcRecordCheck;
					end;
				end;
				
				i = 0;
				set = "";
				ExtractObj(POr.Objects,i,obj);
				while(nonblank(obj)) begin
					Objr.Code = obj;
					if(ReadFirstMain(Objr,1,true)) then begin
						if(Objr.OTCode=="STORE") then begin
							set = obj;
						end;
					end;
					ExtractObj(POr.Objects,i,obj);
				end;
				if (blank(set)) then begin
					RecordCheckError(36373,"",-1,"Objects");      
					res = -1;
					goto LPOVcRecordCheck;
				end;
			end;
		end;
	end;
	
  found = true; 
  if (stat==updatemode) then begin
    if (POr.Closed!=0) and (PO2r.Closed==0) then begin
      found = false; 
    end;
  end;
  if (found) then begin
    errcode = CheckRates(POr.CurncyCode,POr.FrRate,POr.ToRateB1,POr.ToRateB2,POr.BaseRate1,POr.BaseRate2,tstr);
    if (errcode!=0) then begin
      if (disperrf) then begin
        RecordCheckError(errcode,"",-1,tstr);      
      end;
      res = errcode; 
      goto LPOVcRecordCheck;
    end;        
  end;
  prevvt = -1;
	svCurf = true;
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(POr,i,POrw);
    INr.Code = POrw.ArtCode;
		if (readfirstmain(INr,1,true)) then begin
    end;
    
		if (CurrentCompany==28 and blank(INr.BPIBrand) and nonblank(INr.Code)) then begin
			RecordCheckError(36389,"",i,"ArtCode");      
			res = -1;
			goto LPOVcRecordCheck;
		end;
		
		
		if(i==0) then begin
			itemType = POrw.ItemConsgType;
		end;
		if(itemType!=POrw.ItemConsgType) then begin
			if (disperrf) then begin
        RecordCheckError(36288,"",i,"ItemConsgType");      
      end;
			res = 36288;
			goto LPOVcRecordCheck;
		end;	
    if (IsStandardProduct) then begin
      if (HasLocalization("POL")) then begin
        if (len(POrw.Spec)>35) then begin
          RecordCheckError(22139,"",i,"Spec");      
          res = -1;
          goto LPOVcRecordCheck;
        end;
      end;
    end;
		if (currentcompany!=28 and currentcompany!=29 and currentcompany!=13) then begin
			INr.Code = POrw.ArtCode;
			if (readfirstmain(INr,1,true)) then begin
				if (blank(INr.BPIBrand)) then begin
					RecordCheckError(36345,"",i,"ArtCode");      
					res = -1;
					goto LPOVcRecordCheck;
				end;
			end;
		end;
		
		if(CurrentCompany==18)then begin
			//INr.Code = POrw.ArtCode;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 17 11 2020 y. at 11:45:25 AM
			//if(ReadFirstMain(INr,1,true))then begin//Перенес на верх
				if(POrw.ConsgType==1)then begin
					if(nonblank(POr.FrRate))then begin
						POrw.RowCost2 = (POrw.Price * 0.15) * (POr.ToRateB1/POr.FrRate);
						consigconsolf = true;
					end else begin
						POrw.RowCost2 = POrw.Price * 0.15;
						consigconsolf = true;
					end;
				end else begin
				//if(INr.ConsgType!=1 and (POrw.RowCost1!=0 or POrw.RowCost2!=0))then begin
					POrw.RowCost1 = 0;
					POrw.RowCost2 = 0;
					consigconsolf = true;
				end;
			//end;
			if (POr.POClass=="S_IDE" and blank(POr.IDPrjNum)) then begin
				RecordCheckError(36392,"",-1,"IDPrjNum");      
				res = -1;
				goto LPOVcRecordCheck;
			end;
		end;
		
		if(currentcompany!=28 and currentcompany!=29 and currentcompany!=18)then begin
			if(nonblank(POrw.ArtCode) and svCurf)then begin
				currrow = POrw.BrndCurrCode;
				svCurf = false;
			end;
			if(nonblank(POrw.BrndCurrCode))then begin
				if(nonblank(POrw.ArtCode) and currrow!=POrw.BrndCurrCode)then begin
					RecordCheckError(36334,"",i,"BrndCurrCode");
					res = 36334; 
					goto LPOVcRecordCheck;
				end;
				if(nonblank(POrw.ArtCode) and currrow!=POr.CurncyCode)then begin
					RecordCheckError(36334,"",-1,"CurncyCode");
					res = 36334; 
					goto LPOVcRecordCheck;
				end;
			end;

		end;
		
    switch (POrw.stp) begin
      case 1:
        if (HasLocalization("FIN,LTU,LVA")==false and nonblank(POrw.VATCode)) then begin
          curvt = VATType(POrw.VATCode);
          if (curvt==kVATTypeReversed) or (prevvt==kVATTypeReversed) then begin
            if (curvt!=prevvt) and (prevvt!=-1) then begin
              if (disperrf) then begin
                RecordCheckError(20270,"",i,"VATCode");      
              end;
              res = 20270; 
              goto LPOVcRecordCheck;
            end;
          end;
        end;
        prevvt = curvt;
        
        if (nonblank(POrw.VATCode)) then begin
          if (VATAccIsClosed(POrw.VATCode,tstr,1)) then begin
            if (disperrf) then begin
              RecordCheckError(1258,tstr,i,"VATCode");      
            end;
            res = 1258; 
            goto LPOVcRecordCheck;
          end;          
          if (IsVATCodeDefined(POrw.VATCode)==false) then begin
            if (disperrf) then begin
              RecordCheckError(1120,POrw.VATCode,i,"VATCode");      
            end;
            res = 1120; 
            goto LPOVcRecordCheck;
          end;
        end;
				if(currentcompany==18) then begin
					if(Blank(POrw.Price) or POrw.Price==0) then begin
						if(POrw.ConsgType<2)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 17 11 2020 y. at 11:52:17 AM
							RecordCheckError(36291,"",i,"Price");
							res = 36291;
							goto LPOVcRecordCheck;
						end;
					end;
				end;
        
        if (nonblank(POrw.ArtCode) and POr.AllowOtherVEItem==0) then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 11 December 2017 15:04:09
        	CheckItemForVendor(POr.VECode,POrw.ArtCode,i,res);
        	if(res>0)then begin
        		goto LPOVcRecordCheck;
        	end;
        end;
        if (UseTaxTemplatesforTaxCalc) then begin
          if (nonblank(POrw.ArtCode)) then begin
            if (blank(POrw.TaxTemplateCode)) then begin
              if (disperrf) then begin
                RecordCheckError(24201,"",i,"TaxTemplateCode");      
              end;
              res = 24201;
              goto LPOVcRecordCheck;
            end;
            errcode = VerifyTaxTemplateCode(POrw.TaxTemplateCode,tstr);
            if (errcode!=0) then begin
              if (disperrf) then begin
                RecordCheckError(errcode,tstr,i,"TaxTemplateCode");                
              end;
              res = 1120; 
              goto LPOVcRecordCheck;
            end;
          end;
        end else begin
          if (blank(POrw.VATCode) and (POrw.Sum!=0)) and (VEr.ExportFlag==0) then begin
            if (disperrf) then begin
              RecordCheckError(1134,"",i,"VATCode");      
            end;
            res = 1134; 
            goto LPOVcRecordCheck;
          end;
        end;
        if (CorrectM4ValProc(POrw.vRebate)==false) then begin
          if (disperrf) then begin
            RecordCheckError(1019,"",i,"vRebate");      
          end;
          res = 1019; 
          goto LPOVcRecordCheck;
        end;
        if (nonblank(POrw.PRCode)) then begin
          PRr.Code = POrw.PRCode;
          if (ReadFirstMain(PRr,1,true)==false) then begin
            if (disperrf) then begin
              RecordCheckError(1232,"",i,"PRCode");      
            end;
            res = 1232; 
            goto LPOVcRecordCheck;
          end;
          if (PRr.Terminated!=0) then begin
            if (disperrf) then begin
              RecordCheckError(1232,"",i,"PRCode");      
            end;
            res = 1232; 
            goto LPOVcRecordCheck;
          end;        
        end;  
//        if (nonblank(POrw.Objects)) then begin     
          VerifyRowObjects("PL",POr.Objects,POrw.Objects,POrw.CostAcc,errcode,errstr,initotcheckf,otcheckaccs,otcheckobjtyps,otcheckcnt);                        
          if (errcode!=0) then begin
            if (disperrf) then begin
              RecordCheckError(errcode,errstr,i,"Objects");      
            end;
            res = errcode; 
            goto LPOVcRecordCheck;
          end;
//        end;          
        if (nonblank(POrw.ArtCode)) and (gRuniningMaint!="GenPOFromORMn1") then begin     
          if (blank(POr.PlanShip)) then begin
            if (blank(POrw.PlanShipRow)) then begin
              if (check) then begin
                BlockLoad(PDb);
                if (PDb.ForcePlanDelDate!=0) then begin
                  if (disperrf) then begin
                    RecordCheckError(1058," " & USetStr(2040),i,"PlanShipRow"); 
                  end;
                  res = 1058; 
                  goto LPOVcRecordCheck;
                end;
              end;
            end;
          end;
        end;
        if (nonblank(POrw.CostAcc)) then begin
          Accr.AccNumber = POrw.CostAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,POrw.CostAcc,i,"CostAcc");      
            res = -1; 
            goto LPOVcRecordCheck;
          end else begin
            if (Accr.blockedFlag!=0) then begin
              RecordCheckError(1258,POrw.CostAcc,i,"CostAcc");      
              res = -1; 
              goto LPOVcRecordCheck;
            end;
            if (Accr.GroupAcc!=0) then begin
              RecordCheckError(1084,POrw.CostAcc,i,"CostAcc");      
              res = -1; 
              goto LPOVcRecordCheck;
            end;
          end;
        end;
				
        if (nonblank(POrw.ArtCode)) then begin
          if (POrw.Quant<0) then begin
            if (disperrf) then begin
              RecordCheckError(1574,"",i,"Quant");      
            end;
            res = 1574;
            goto LPOVcRecordCheck;
          end;
          if (StockRecordForLocationAllowed("POVc",POr.Location,POrw.ArtCode,POr.TransDate,POr.OKFlag,errcode,errstr)==false) then begin
            RecordCheckError(errcode,errstr,i,"ArtCode");      
            res = -1;
            goto LPOVcRecordCheck;
          end;
          found = ReadFirstItem(POrw.ArtCode,INr,true,false);
					blockLoad(NCCb);
          if(NCCb.ClassifCheck==0)then begin
						if(currentcompany!=13)then begin
							fullclass = uppercase(POrw.xClassification);
							POrw.xClassification = "";
							
							lenth = 0; //Edit***************************Sasha2,16:02 29.01.2016 {
							k = 0;
							NoLimitExtractObj(fullclass,lenth,tclass);
							while (nonblank(tclass)) begin
								lenth2 = lenth;
								NoLimitExtractObj(fullclass,lenth2,tclass2);
								if (nonblank(tclass2)) then begin
									if (k==0) then begin
										switch (currentcompany) begin 
											case 1:CheckAndCreateClassification(tclass,"MODEL",false);
											case 2:CheckAndCreateClassification(tclass,"BRAND",true);
			
											case 4:CheckAndCreateClassification(tclass,"BRAND",true);
											case 5:CheckAndCreateClassification(tclass,"BRAND",true);
											case 6:CheckAndCreateClassification(tclass,"BRAND",true);
											case 7:CheckAndCreateClassification(tclass,"BRAND",true);
											case 8:CheckAndCreateClassification(tclass,"BRAND",true);
											case 11:CheckAndCreateClassification(tclass,"MODEL",false);
											case 12:CheckAndCreateClassification(tclass,"BRAND",true);
											case 14:CheckAndCreateClassification(tclass,"BRAND",true);
											case 15:CheckAndCreateClassification(tclass,"BRAND",true);
											case 16:CheckAndCreateClassification(tclass,"BRAND",true);
											case 25:CheckAndCreateClassification(tclass,"BRAND",true);
											otherwise CheckAndCreateClassification(tclass,"",false);
										end;
									end else begin
										 CheckAndCreateClassification(tclass,"",false);
									end;
								end else begin
									switch (currentcompany) begin 
										case 1:CheckAndCreateClassification(tclass,"MODEL",false);
										case 2:CheckAndCreateClassification(tclass,"MODEL",false);
										
										case 4:CheckAndCreateClassification(tclass,"MODEL",false);
										case 5:CheckAndCreateClassification(tclass,"MODEL",false);
										case 6:CheckAndCreateClassification(tclass,"MODEL",false);
										case 7:CheckAndCreateClassification(tclass,"MODEL",false);
										case 8:CheckAndCreateClassification(tclass,"MODEL",false);
										case 11:CheckAndCreateClassification(tclass,"MODEL",false);
										case 12:CheckAndCreateClassification(tclass,"MODEL",false);
										case 14:CheckAndCreateClassification(tclass,"MODEL",false);
										case 15:CheckAndCreateClassification(tclass,"BRAND",true);
										case 16:CheckAndCreateClassification(tclass,"MODEL",false);
										case 25:CheckAndCreateClassification(tclass,"MODEL",false);
										otherwise CheckAndCreateClassification(tclass,"",false);
									end;
								end;
								findclass = true;
								DIr.Code = tclass;
								if(readfirstmain(DIr,1,findclass)) begin
									if(DIr.Code==tclass and findclass)then begin
										POrw.xClassification = POrw.xClassification & DIr.Code & ",";
										findclass = false;
									end;
								end;
								if(findclass)then begin
									DIr.Name = tclass;
									if(readfirstkey("Name",DIr,1,findclass))then begin
										if(uppercase(DIr.Name)==tclass and findclass)then begin
											POrw.xClassification = POrw.xClassification & DIr.Code & ",";
											findclass = false;
										end;
									end;
								end;
								k = k + 1;
								NoLimitExtractObj(fullclass,lenth,tclass);
							end; //Edit***************************Sasha2,16:02 29.01.2016 }

							lenth = len(POrw.xClassification);
							if(mid(POrw.xClassification,lenth-1,1)==",")then begin
								POrw.xClassification = mid(POrw.xClassification,0,lenth-1);
							end;

							matrowput(POr,i,POrw);
							matrowget(POr,i,POrw);
						end else begin
							if(blank(POrw.xClassification))then begin
								RecordCheckError(2214,"",i,"xClassification");      
								res = 2214; 
								goto LPOVcRecordCheck;
							end;
							
							k = 0;
							ExtractObj(POrw.xClassification,k,tclass);
							while (nonblank(tclass)) begin
								if(nonblank(tclass))then begin
									DIr.Code = tclass;
									if(!readfirstmain(DIr,1,true))then begin
										RecordCheckError(2214,"",i,"xClassification");      
										res = 2214; 
										goto LPOVcRecordCheck;
									end;
								end;
								ExtractObj(POrw.xClassification,k,tclass);
							end;
						end;
					end;
          
          if (nonblank(POrw.EAN13Code)) then begin		//Edit----------------------Dima  27.04.2015
          	INcheck.BarCode = POrw.EAN13Code;
          	if (ReadFirstKey("BarCode",INcheck,1,true)) then begin
							if (INcheck.Code != POrw.ArtCode) then begin
									RecordCheckError(31312,". " &INcheck.Code & " " & POrw.ArtCode,i,"EAN13Code");      
									res = 31312; 
									goto LPOVcRecordCheck;	
							end;
						end;
						if (currentcompany==3) then begin //Edit***************************Sasha2,12:55 20.01.2016 {
						  if (NonBlank(INr.BarCode) and INr.BarCode!=POrw.EAN13Code) then begin
						    RecordCheckError(35029,". " & INr.BarCode & " != " & POrw.EAN13Code,i,"EAN13Code");      
								res = 35029; 
								goto LPOVcRecordCheck;
						  end;
						end; //Edit***************************Sasha2,12:56 20.01.2016 }
          end;
          if(NCCb.ClassifCheck==0)then begin
						pos = 0;
						testf2 = false;
						TrHs = true;
						ExtractObj(POrw.xClassification,pos,ostr);
						while (nonblank(ostr) and TrHs) begin
							DIr.CType = "TYPE";
							DIr.Code = ostr;
							if(readfirstkey("CType",DIr,2,true))then begin testf2 = true; TrHs = false; end;
							ExtractObj(POrw.xClassification,pos,ostr);
						end;
						
						if(testf2)THEN BEGIN
							pos = 0;
							testf2 = false;
							TrHs = true;
							ExtractObj(POrw.xClassification,pos,ostr);
							while (nonblank(ostr) and TrHs) begin
								DIr.CType = "BRAND";
								DIr.Code = ostr;
								if(readfirstkey("CType",DIr,2,true))then begin testf2 = true; TrHs = false; end;
								ExtractObj(POrw.xClassification,pos,ostr);
							end;
						END;
						
						if(testf2==false and BOb.BackOrderMark==1)then begin
							RecordCheckError(35150,POrw.ArtCode,i,"xClassification");
							MessageBox(0,"введите классификацию типа \"BRAND и TYPE\"!");
							res = 35150; 
							goto LPOVcRecordCheck;
						end;
					end;
					if(BOb.BackOrderMark==1 and blank(POrw.Spec))then begin
						RecordCheckError(1854,"",i,"Spec");
						res = 1854; 
						goto LPOVcRecordCheck;
					end;
					
					if(CurrentCompany!=9) then begin			
						if(blank(POrw.VATCode))then begin
							POrw.VATCode = "0%";
						end;
						matrowput(POr,i,POrw);
						matrowget(POr,i,POrw);
						found = ReadFirstItem(POrw.ArtCode,INr,true,true);// Edit ************************** Friday, 31 August 2012 16:21:48
						if(found!=false and POrw.ConsgType!=0 and CurrentCompany!=28) then begin
							INr.ConsgType = POrw.ConsgType;
						end;
						if (found==false or blank(POrw.Spec)) then begin
							if (disperrf) then begin
								RecordCheckError(1120,POrw.ArtCode,i,"ArtCode");      
							end;
							errmsg = POrw.ArtCode;
							res = 1120; 
							goto LPOVcRecordCheck;
						end;
						if (found==false and nonblank(POrw.Spec) and blank(POrw.UnitCode)) then begin 
							POrw.UnitCode = "ШТ"; 
							matrowput(POr,i,POrw);
						end;
						
						if(POrw.Quant==0 and POr.OKFlag==1 and BOb.BackOrderMark==1)then begin
							RecordCheckError(1854,"",i,"Quant");
							res = 1854; 
							goto LPOVcRecordCheck;
						end;
          end;
					if(CurrentCompany==9) then begin
						found = ReadFirstItem(POrw.ArtCode,INr,true,true);// Edit ************************** Friday, 31 August 2012 16:21:48
						if (found==false or blank(POrw.Spec)) then begin
							if (disperrf) then begin
								RecordCheckError(1120,POrw.ArtCode,i,"ArtCode");      
							end;
							errmsg = POrw.ArtCode;
							res = 1120; 
							goto LPOVcRecordCheck;
						end;
						if (found==false and nonblank(POrw.Spec) and blank(POrw.UnitCode)) then begin 
							POrw.UnitCode = "ШТ"; 
							matrowput(POr,i,POrw);
						end;
						
						if(POrw.Quant==0 and POr.OKFlag==1 and BOb.BackOrderMark==1)then begin
							RecordCheckError(1854,"",i,"Quant");
							res = 1854; 
							goto LPOVcRecordCheck;
						end;
					end;	
          if (INr.Terminated!=0) and (POrw.Shipd2==0) and (POrw.Invd==0) then begin
            if (disperrf) then begin
              RecordCheckError(21447,POrw.ArtCode,i,"ArtCode");      
            end;
            res = 21447; 
            goto LPOVcRecordCheck;
          end;
          if (long4!=10) then begin
            if (POrw.Quant<POrw.Shipd1) then begin
              if ((INr.ItemType!=kItemTypePlain) and (INr.ItemType!=kItemTypeService)) then begin
                if (disperrf) then begin
                  RecordCheckError(1302,"",i,"Quant");      
                end;
                res = 1302;
                goto LPOVcRecordCheck;
              end;
            end;
          end;
          switch (INr.SerNrf) begin
            case 1:
              if (SNrb.BulkSerialNos!=0) then begin
              end else begin
                l = POrw.Quant;
                if ((POrw.Quant - l)!=0) then begin
                  if (disperrf) then begin
                    RecordCheckError(1242,"",i,"SerialNr");
                  end;
                  res = 1242; 
                  goto LPOVcRecordCheck;
                end;
              end;
            case 2:
            otherwise
              if (INr.SerNrf<1) then begin
                if (POrw.StockType==kStockTypeConsigment) then begin
                  if (disperrf) then begin
                    RecordCheckError(1953,"",i,"StockType");      
                  end;
                  res = 1953;
                  goto LPOVcRecordCheck;
                end;
                if (POrw.TREO==kTREO) then begin
                  RecordCheckError(1953,"",i,"TREO");
                  res = -1;
                  goto LPOVcRecordCheck;
                end;
              end; 
          end;       
          if (INr.ItemType==2) then begin
            if (disperrf) then begin
              RecordCheckError(1826,POrw.ArtCode,i,"ArtCode");      
            end;
            res = 1826; 
            goto LPOVcRecordCheck;
          end;
          tstr = POr.PRCode;
          if (nonblank(POrw.PRCode)) then begin
            tstr = POrw.PRCode;
          end;
          if (AllowThisItem("POVc",tstr,POrw.ArtCode,INr.ItemType)==false) then begin
            if (disperrf) then begin
              RecordCheckError(1285,POrw.ArtCode,i,"ArtCode");      
            end;
            res = 1285; 
            goto LPOVcRecordCheck;
          end;
					changef = false;
					if(stat==updatemode) then begin if(PO2r.OKFlag==0 and POr.OKFlag!=0) then begin changef = true; end; end;
					if(stat==insertmode) then begin if(POr.OKFlag!=0) then begin changef = true; end; end;
          if ((POrw.Quant>0) and (POr.Closed==0) and changef) then begin
						switch(currentcompany)begin
							case 1:NewINSwarowski(POr,i,found,INr,fr,to1,to2,br1,br2);// Edit ************************** Monday, 18 February 2013 09:36:54// Edit ************************** Monday, 18 February 2013 09:36:55// Edit ************************** Monday, 18 February 2013 09:36:57
							case 2:NewINLLardo(POr,i,found,INr,fr,to1,to2,br1,br2);

							case 4:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);
							case 5:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);
							case 6:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);
							case 7:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);
							case 8:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);
							
							case 10:NewINJW(POr,i,found,INr,fr,to1,to2,br1,br2);
							case 11:NewINSwarowski(POr,i,found,INr,fr,to1,to2,br1,br2);	// Edit by Victor 08.12.14	
							case 12:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);	// Edit by Victor 08.12.14	
							case 13:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);	// Edit ************************** Wednesday, 25 March 2015 15:46:51
							case 14:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2); // Edit ************************** Wednesday, 6 May 2015 10:24:06
							case 15:NewINJW(POr,i,found,INr,fr,to1,to2,br1,br2);		//Edit-------------------Vitalii 13:08 09.12.2015
							case 16:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);
							case 17:NewINJW(POr,i,found,INr,fr,to1,to2,br1,br2);
							case 25:NewINVilleroy(POr,i,found,INr,fr,to1,to2,br1,br2);// Edit ************************** Thursday, 19 May 2016 12:30:51
							otherwise
							  if (CompanyIsJWLikeCompany(currentcompany)) then begin
									if(BOb.BackOrderMark==1)then begin
										NewINJW(POr,i,found,INr,fr,to1,to2,br1,br2);
									end;
							    UpdateINOnly_NewINJW(POr,i,found,INr,fr,to1,to2,br1,br2);
							  end;
						end;
						matrowget(POr,i,POrw);
					end;
        end;
    end;
    //POrw.UnitCode = INr.UnitCode;
    matrowget(POr,i,POrw);
    if(nonblank(POrw.ArtCode) and blank(POrw.UnitCode))then begin // Edit ************************** Thursday, 14 February 2013 16:51:26
			RecordCheckError(1058,"",i,"UnitCode");
    end;
    /*if(currentcompany!=3 and currentcompany!=1)then begin
			if(nonblank(POrw.ArtCode) and POrw.Price==0 and POr.OKFlag>0)then begin// Edit ************************** Thursday, 14 February 2013 16:51:27
				RecordCheckError(1058,"",i,"Price");
			end;
    end;*/
	end;
	if(consigconsolf)then begin
		POSumUp(POr);
	end;
	
	
	
	
LPOVcRecordCheck:;
  if (res!=0) then begin POr.SerNr = oldnr; end;  
	logtext(0,res & " ResPO");
  ValidatePORecord = res;
  return;
end;

global
updating function LongInt POVcRecordCheck(var record POVc POr,record POVc PO2r,LongInt stat,LongInt along4)
begin
  LongInt res,long4;
  string 255 errmsg;
  transaction Boolean gMaintenance;
  longint curtick;
	
	curtick = getcurtick();
  logtext(0,"POVcRecordCheck");  
  
  res = 0;
  long4 = along4;
  if (gMaintenance) then begin
    long4 = 0;
  end;
  if (ValidatePORecord(POr,PO2r,stat,long4,true,errmsg)!=0) then begin
    res = -1;
  end;
  POVcRecordCheck = res;
	
	LogProcTime("POVcRecordCheck",getcurtick()-curtick); 
  RETURN;
END;


global updating procedure UpdateINReferenceFromPOMn(record RcVc RepSpec)
begin
	record POVc POr;
	record INVc INr;
	row POVc POrw;
	integer i,mtrw;
	longint curtick;
	
	curtick = getcurtick();
	POr.SerNr = -1;
	while(loopmain(POr,1,true))begin
		mtrw = matrowcnt(POr);
		For(i=0;i<mtrw;i=i+1) begin
	  	matrowget(POr,i,POrw);
	  	if(nonblank(POrw.ArtCode))then begin
	  		if(nonblank(POrw.Reference))then begin
	  			INr.Code = POrw.ArtCode;
	  			if(readfirstmain(INr,1,true))then begin
	  				If(INr.Reference!=POrw.Reference)then begin
	  					INr.Reference = POrw.Reference;
	  					recordStore(INr,true);
	  				end;
	  			end;
	  		end;
	  	end;
		end; 		
	end;
	LogProcTime("UpdateINReferenceFromPOMn",getcurtick()-curtick); 
return;
end;