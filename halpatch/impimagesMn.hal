//server-only
external function Boolean GetObjBal(string,string,var record ObjBalVc);
external procedure ExtractObj(string,var Integer,var string);
external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val); //Edit***************************Sasha2,11:28 06.03.2015
external function roundmode DefaultRoundMode();
external function Boolean PasteInvIn2IPr(var record IPVc,Integer,Date,var val,Boolean,var Boolean);
external procedure IPVc_PasteRecVal(var record IPVc,Integer);
external updating function LongInt IPVcRecordCheck(var record IPVc,record IPVc,LongInt,LongInt);// Edit ************************** Friday, 13 March 2015 18:18:29
external function Boolean TRVc_PasteObjects(var record TRVc,Integer);
external procedure PUVc_PasteLocation(var record PUVc,Integer); //Edit***************************Sasha2,11:37 07.04.2015
external function Boolean PUVc_PasteArtCode(var record PUVc,Integer,var string,var string); //Edit***************************Sasha2,12:10 07.04.2015
external function Integer PUVc_PasteQuant(var record PUVc,Integer); //Edit***************************Sasha2,12:13 07.04.2015
external procedure PUCalcCostPrice(string,val,Integer,Integer,string,string,
                                   val,val,val,val,val,
                                   val,val,val,val,val,val,
                                   string,var val,val,var val,string,Integer); //Edit***************************Sasha2,13:04 08.04.2015
external procedure PUSumUp(var record PUVc); //Edit***************************Sasha2,13:09 08.04.2015
external procedure CalculateIVVcPoints(var record IVVc);// Edit ************************** Thursday, 28 May 2015 11:14:54
external procedure CreateEAN128(var string); //Edit***************************Sasha2,17:02 08.07.2015
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode); //Edit***************************Sasha2,17:17 08.07.2015
external procedure NextM4Number(string,var string); //Edit***************************Sasha2,12:12 11.08.2015
external function string 255 StrReplace(string,string,string);//Edit-------------------Vitalii 17:06 08.09.2015
external procedure ExtractObj(string,var Integer,var string); //Edit***************************Sasha2,14:00 16.12.2015
external function string 20 ReturnFieldDIType(string,boolean); //Edit***************************Sasha2,14:56 16.12.2015
external procedure FBSumup(var record FBVc); //Edit***************************Sasha2,17:40 29.01.2016
external function roundmode SetRoundModeD(Integer); //Edit***************************Sasha2,10:49 01.02.2016
external procedure TRSumup(var record TRVc,var val); //Edit***************************Sasha2,11:29 01.02.2016
external function val AbsoluteVal(val); //Edit***************************Sasha2,13:04 01.02.2016
external function Boolean TRVc_PasteAccNumber(var record TRVc,Integer,Integer,Boolean); //Edit***************************Sasha2,17:32 01.02.2016
external updating function LongInt PastePUInVI(record PUVc,var record VIVc,var string,Boolean,Boolean,Boolean,Boolean,Boolean,Boolean,Boolean,Boolean,string); //Edit***************************Sasha2,17:34 09.02.2016
external function LongInt GetCurUserLastNr(string); //Edit***************************Sasha2,17:40 09.02.2016
external function Boolean GetAccName(string,var string,Integer); //Edit***************************Sasha2,17:56 09.02.2016
external function Boolean PUVc_PasteVECode(var record PUVc); //Edit***************************Sasha2,9:42 10.02.2016
external procedure VICalcVals(var record VIVc); //Edit***************************Sasha2,11:43 10.02.2016
external procedure VISumup(record VIVc,var val); //Edit***************************Sasha2,12:09 10.02.2016
external procedure PUVc_PasteCostPrice(var record PUVc,Integer); //Edit***************************Sasha2,11:38 04.04.2016
external function Boolean IsDigit(string);
external procedure IVDchsum(var record IVVc,Integer); //Edit***************************Sasha2,16:45 01.06.2016
external function Boolean IVDchrsum(var record IVVc,Integer); //Edit***************************Sasha2,16:46 01.06.2016
external function string 20 ReturnFieldDITypeNotJW(string); //Edit***************************Sasha2,16:50 14.06.2016
external function Boolean SetInSet2(string,string);
external updating procedure CalcPriceListsMn(record RcVc); //Edit***************************Sasha2,10:15 31.03.2017
external function Boolean TimeInRange(Time,Time,Time); //Edit***************************Sasha2,11:26 27.07.2017
external function string 255 imgStrReplace(string);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
external updating procedure CreateLoyalActivity(record LoyaltyCardVc,string);// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 4 January 2018 14:02:12
external function string 255 NormalizeSetString(string);// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 3 April 2018 12:00:28
external updating procedure UpdatePlanned(string,string,string,LongInt,Date,val,Integer,val,val,Boolean);
external updating procedure CalcPriceListsMn(record RcVc);
external procedure INCatSClassArrayOnOpen(var Array string,var Integer); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger11:55 06.08.2018
external procedure ExtractObj(string,var Integer,var string);
remote function Boolean GetItemPriceDiscount3(string,val,var record INVc,string,val,val,val,val,val,string,string,string,string,
                                                var val,var string,var val,var string,var val,var string,Integer,var Boolean,Date,Time,
                                                string,Boolean,var Boolean,string,var string,var val,string,string,var string);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external procedure CheckFlush(var Integer,Integer);
external function string 255 DelDublicates(string);// Edit ************************** Tuesday, 31 October 2017 17:47:41
external procedure stripendingspaces	(	var string );
external updating procedure UpdatePrice(record PLVc);
external procedure ExtractObj(string,var Integer,var string);
remote updating procedure UnReservLinkedFromWebORVc(var record ORVc,Boolean); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger15:43 06.12.2018
remote function Boolean StockMovVc_PasteArtCode(var record StockMovVc,Integer,Integer,var array string); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:22 13.12.2018
remote procedure StockMovVc_PasteSerialNr(var record StockMovVc,Integer,var array string); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:22 13.12.2018
remote function Boolean StockMovVc_PasteQuant(var record StockMovVc,Integer); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:23 13.12.2018
remote procedure FormatUpperCaseCode(var string);
external procedure GetPriceItemForIN(record INVc,var val,var val);//Edit_________________ABR 22.01.19
external procedure GetPriceItem1(string,var val,var val);//Edit_________________ABR 22.01.19
external procedure GetPriceItem(string,var val,var val);//Edit_________________ABR 22.01.19
external function Boolean PasteActTypeInAct(string,var record ActVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger15:46 12.02.2019
external function Boolean GetItemPriceDiscount3CRM(string,val,var record INVc,string,val,val,val,val,val,string,string,string,string,
                                                var val,var string,var val,var string,var val,var string,Integer,var Boolean,Date,Time,
                                                string,Boolean,var Boolean,string,var string,var val,string,string,var string,var string,var record MarcCampVc);// Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 15 April 2019 09:42:24
external function Boolean GetItemPriceDiscount3(string,val,var record INVc,string,val,val,val,val,val,string,string,string,string,
                                                var val,var string,var val,var string,var val,var string,Integer,var Boolean,Date,Time,
                                                string,Boolean,var Boolean,string,var string,var val,string,string,var string);// Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 15 April 2019 10:15:34
external function Date DateFromString(string,string);
remote procedure NextM4SerialNumber(string,var string);
remote procedure HandleNewIN2DClassCode(var record NewINVc, integer);
remote function Boolean GetTempItemPrice(var val,string,var string, date,var string); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 11:04 19.06.2019
external procedure LogProcTime(string,longint);
external updating procedure SendUpdateLoyaltyCardToCRM(var record LoyaltyCardVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger13:07 12.09.2018
remote updating procedure CollectConsItemsMn(record RcVc);
external procedure FindUserMailboxName(string,var string,var string);
external updating function Boolean SendMailFromSystem(string,string,string,string,LongInt,Integer,string);
external updating function Boolean SendSMSFromSystem(string,string,string,string);
external procedure ExtractObj(string,var Integer,var string);
external function Boolean SendNotificationToUser(string,string);
external procedure HandleIDEANewIN2DClassCode(var record IDEANewINVc, integer);
external procedure NextCode(string,var string);
remote procedure TRVc_PasteDebVal(var record TRVc,Integer);	  //  by Ira
remote procedure TRVc_PasteCredVal(var record TRVc,Integer);	  //  by Ira
external procedure TRSumup(var record TRVc,var val);	   //  by Ira
external updating procedure updateGIrAuto(record GlobalItemVc,vector val);  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 11:33 15.03.2021
external function Boolean FindStringInString(string,string);// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 16 03 2021 y. at 1:26:03 PM
external function Integer FindFirstPosStringInString( string, string); //Edit----------------------Dima  02.03.2015
external procedure TimeStamps(var row GlobalItemVc,val,string); //Edit **********************************************Vas-P	06/07/2021
external procedure GIWasUpdated(record GlobalItemVc,record GlobalItemVc,string); //Edit **********************************************Vas-P	14/07/2021
SetLangMode(LangRussian,"RUS",0);



global //Edit***************************Sasha2,14:27 02.08.2016 {
procedure CalcEANCHS(var string str)
begin
integer c1,c2,lenth,i,chsum,litle;
val sum;
  sum = 0;
  lenth = len(str);
  if (lenth==12)then begin
    for(i=0;i<12;i=i+2)begin
      c1 = evaltoval(mid(str,i,1));
      c2 = evaltoval(mid(str,i+1,1));
      c2=c2*3;
      sum = sum+c1+c2;
    end;
    if(round(sum/10,SetRoundModeD(0))>sum/10) then begin
      litle = round(sum/10,SetRoundModeD(0))-1;
    end else begin
      litle = round(sum/10,SetRoundModeD(0));
    end;
    chsum  = 10-(10*(sum/10-litle));
    if(chsum==10) then begin chsum = 0; end;
    str = str & chsum;
  end else begin
    str = "";
  end;
  
return;
end;





global
webpublic updating procedure WebReimportBTRxBrands()
begin
	record BPIBrandVc BPIr;
	record BTRxBrandVc BTRxr;
	record GlobalItemVc GIr,LogGIr;
	BTRxr.Code = "BRND9999";
	while (LoopBackKey("Code",BTRxr,1,true))begin
		RecordDelete(BTRxr);
	end;
	resetloop(BTRxr);
	BPIr.Code = "";
	while (loopmain(BPIr,1,true))begin
		BTRxr.Code = BPIr.Code;
		BTRxr.Name = BPIr.Name;
		RecordStore(BTRxr,true);
	end;
	GIr.Code = "";
	while (LoopMain(GIr,1,true))begin
		if(GIr.BPIBrand!=left(GIr.Code,8))then begin
			recordcopy(LogGIr,GIr);
			GIr.BPIBrand = left(GIr.Code,8);
			GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 45");
			RecordStore(GIr,true);
		end;
	end;
return
end;





global
updating procedure TempPricesObjMn()
begin
	record IVVc IVr;
	row IVVc IVrw;
	integer i, mtrw;
	val TPrice;
	string 255 ItemCode, tpcurrency, obj;
	date tdp;
	boolean TrHs;
	
	IVr.TransDate = AddDay(CurrentDate,-1);
	TrHs = true;
	while (loopkey("TransDateCust",IVr,1,TrHs)) begin
		if(IVr.TransDate<AddDay(CurrentDate,-1)) then begin TrHs = false; end;
		if(TrHs)then begin
			mtrw = matrowcnt(IVr);
			for (i=0;i<mtrw;i=i+1) begin
				tdp = IVr.TransDate;
				matrowget (IVr,i,IVrw);
				ItemCode = IVrw.ArtCode;
				if(GetTempItemPrice(TPrice,ItemCode,tpcurrency,tdp,obj) and IVr.PriceList=="RRP") then begin
					if(nonblank(obj))then begin
						if(nonblank(IVrw.Objects))then begin IVrw.Objects = IVrw.Objects & ","; end;
						IVrw.Objects = IVrw.Objects & obj;
						// logtext(0,obj & "IV record: " & IVr.SerNr);
						matrowPUt(IVr,i,IVrw);
						recordStore(IVr,true);
					end;
				end;
			end;
		end;
	end;
return
end;




global
updating procedure Replace3levcatinGIMn(Record RcVc RepSpec)
begin
	record GlobalItemVc GIr,LogGIr;
	integer i, mtrw;
	val TPrice;
	string 255 ItemCode, tpcurrency, obj;
	date tdp;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr, BSLLastCoder;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder,old3cetr;
	boolean testf, TrHs;
	string 255 catName, catNameRUS, catNameAZ, OldCode, sCatName, tCatName,tstr,new3cat;
	vector string 200 tlvelto2;
	integer pos;
	longint curtick;
	
	curtick = getcurtick();
	BtrxThirdLevelCatr.Code = RepSpec.f2;
	if(readfirstmain(BtrxThirdLevelCatr,1,true))then begin
		GIr.Code = "";
		while (loopMain(Gir,1,true)) begin
			if(SetInSet(RepSpec.f1,Gir.BTRxThirdLevCat)) then begin
				pos = 0;
				new3cat = "";
				ExtractObj(GIr.BTRxThirdLevCat,pos,tstr);
				recordcopy(LogGIr,GIr);
				while(nonblank(tstr))begin
					if(nonblank(tstr) and left(tstr,5)!="THLVL")then begin
						if(nonblank(new3cat))then begin
							new3cat = new3cat & "," & tstr;
						end else begin
							new3cat = tstr;
						end;
					end;
					if(nonblank(tstr) and left(tstr,5)=="THLVL")then begin
						if(nonblank(new3cat))then begin
							new3cat = new3cat & "," & RepSpec.f2;
						end else begin
							new3cat = RepSpec.f2;
						end;
						BtrxThirdLevelCatr.Code = RepSpec.f2;
						if(ReadFirstMain(BtrxThirdLevelCatr,1,true))then begin 
							GIr.BTRxSecondLevCat = BtrxThirdLevelCatr.PathScndCode;
							BtrxSecondLevelCatr.Code = GIr.BTRxSecondLevCat;
							if(readfirstmain(BtrxSecondLevelCatr,1,true))then begin
								GIr.BTRxFirstLevCat = BtrxSecondLevelCatr.PathFrstCode;
							end;
						end;
					end;
					ExtractObj(GIr.BTRxThirdLevCat,pos,tstr);
				end;
				GIr.BTRxThirdLevCat = new3cat;
				GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 45");
				recordstore(GIr,true);
			end;
		end;
		if(RepSpec.flags[1]==1)then begin
			BtrxThirdLevelCatr.Code = RepSpec.f1;
			if(ReadFirstMain(BtrxThirdLevelCatr,1,true))then begin
				recorddelete(BtrxThirdLevelCatr);
			end;
		end;
	end;
	LogProcTime("Replace3levcatinGIMn",getcurtick()-curtick);
return
end;



















global 
function boolean CheckGlblBtrxClass (string ClCode)
begin
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	boolean res;
	integer OldComp;
	
	OldComp = CurrentCompany;
	
	setcompany(1,false)
	res = false;
	if(nonblank(ClCode))then begin
		BTRxBrandr.Code = ClCode;
		if(readFirstMain(BTRxBrandr,1,true))then begin res = true; end;
		BTRxMaterialr.Code = ClCode;
		if(readFirstMain(BTRxMaterialr,1,true))then begin res = true; end;
		BTRxColorr.Code = ClCode;
		if(readFirstMain(BTRxColorr,1,true))then begin res = true; end;
		BTRxSizer.Code = ClCode;
		if(readFirstMain(BTRxSizer,1,true))then begin res = true; end;
		BTRxSexr.Code = ClCode;
		if(readFirstMain(BTRxSexr,1,true))then begin res = true; end;
		BTRxPlatingr.Code = ClCode;
		if(readFirstMain(BTRxPlatingr,1,true))then begin res = true; end;
		BTRxStoner.Code = ClCode;
		if(readFirstMain(BTRxStoner,1,true))then begin res = true; end;
		BTRxStrapr.Code = ClCode;
		if(readFirstMain(BTRxStrapr,1,true))then begin res = true; end;
		BTRxOdourr.Code = ClCode;
		if(readFirstMain(BTRxOdourr,1,true))then begin res = true; end;
		BtrxInternalCatr.Code = ClCode;
		if(readFirstMain(BtrxInternalCatr,1,true))then begin res = true; end;
		BtrxFirstLevelCatr.Code = ClCode;
		if(readFirstMain(BtrxFirstLevelCatr,1,true))then begin res = true; end;
		BtrxSecondLevelCatr.Code = ClCode;
		if(readFirstMain(BtrxSecondLevelCatr,1,true))then begin res = true; end;
		BtrxThirdLevelCatr.Code = ClCode;
		if(readFirstMain(BtrxThirdLevelCatr,1,true))then begin res = true; end;
		BtrxCertificater.Code = ClCode;
		if(readFirstMain(BtrxCertificater,1,true))then begin res = true; end;
		BtrxWatchMechanr.Code = ClCode;
		if(readFirstMain(BtrxWatchMechanr,1,true))then begin res = true; end;
		BtrxPowerReserver.Code = ClCode;
		if(readFirstMain(BtrxPowerReserver,1,true))then begin res = true; end;
		BtrxWatchGrader.Code = ClCode;
		if(readFirstMain(BtrxWatchGrader,1,true))then begin res = true; end;
		BtrxPhoneModelr.Code = ClCode;
		if(readFirstMain(BtrxPhoneModelr,1,true))then begin res = true; end;
		BtrxFillingr.Code = ClCode;
		if(readFirstMain(BtrxFillingr,1,true))then begin res = true; end;
		BtrxTyper.Code = ClCode;
		if(readFirstMain(BtrxTyper,1,true))then begin res = true; end;
		BtrxWatResr.Code = ClCode;
		if(readFirstMain(BtrxWatResr,1,true))then begin res = true; end;
	end;
	resetcompany(oldComp);
	CheckGlblBtrxClass = res;
return
end;

global  
webpublic updating procedure WebCleanGlblBtrxClassMn ()
begin
	record GlobalItemVc GIr;
	boolean Storef;
	
	GIr.Code = "";
	// While (loopmain(GIr,1,true)) begin
		// Storef = false;
		// if(!CheckGlblBtrxClass(GIr.BTRxInterCatClass))then begin GIr.BTRxInterCatClass = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxFirstLevCat))then begin GIr.BTRxFirstLevCat = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxSecondLevCat))then begin GIr.BTRxSecondLevCat = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxThirdLevCat))then begin GIr.BTRxThirdLevCat = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BPIBrand))then begin GIr.BPIBrand = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BPIMaterial))then begin GIr.BPIMaterial = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BPIPlating))then begin GIr.BPIPlating = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.Cert))then begin GIr.Cert = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxWatchMechanism))then begin GIr.BTRxWatchMechanism = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxPowerReserve))then begin GIr.BTRxPowerReserve = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxStrapColour))then begin GIr.BTRxStrapColour = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BPIColor))then begin GIr.BPIColor = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BPIOdour))then begin GIr.BPIOdour = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxPhoneModel))then begin GIr.BTRxPhoneModel = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxType))then begin GIr.BTRxType = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxStrapMat))then begin GIr.BTRxStrapMat = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxFilling))then begin GIr.BTRxFilling = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BPISex))then begin GIr.BPISex = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BPISize))then begin GIr.BPISize = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxProdColour))then begin GIr.BTRxProdColour = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxChainMaterial))then begin GIr.BTRxChainMaterial = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxWatchGradeA))then begin GIr.BTRxWatchGradeA = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxWatchGradeB))then begin GIr.BTRxWatchGradeB = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxWatchGradeC))then begin GIr.BTRxWatchGradeC = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxStoneA))then begin GIr.BTRxStoneA = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxStoneB))then begin GIr.BTRxStoneB = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxStoneC))then begin GIr.BTRxStoneC = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxBracelMat))then begin GIr.BTRxBracelMat = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxWatterRes))then begin GIr.BTRxWatterRes = ""; Storef = true; end;
		// if(!CheckGlblBtrxClass(GIr.BTRxFingerGirth))then begin GIr.BTRxFingerGirth = ""; Storef = true; end;
		// if(Storef)then begin
			// RecordStore(Gir,true);
			// logtext(0,GIr.Code);
		// end;
		
	// end;
return
end;



global 
updating procedure CreateLoyaltyCardRemote(record CUVc CUr,var record LoyaltyCardVc LCr)
begin
	record LoyaltyCardVc LoyaltyCardr,oldLCr;
	string 50 code;
	longint newcode;
	boolean foundf,TrHs,testf;
	date bd;
	
	oldLCr.CustCode = CUr.Code;
	TrHs = true;
	foundf = false;
	while(loopkey("ActCustCode",oldLCr,1,TrHs))begin
		testf = true;
		if(oldLCr.CustCode!=CUr.Code)then begin TrHs = false; testf = false; end;
		
		if(currentcompany!=25)then begin
			if(oldLCr.LCMLevel!="1")then begin testf = false; end;
		end else begin
			if(oldLCr.LCMLevel!="CASACOIN")then begin testf = false; end;
		end;
		if(left(oldLCr.SerNr,2)=="ID")then begin testf = false; end;
		
		if(TrHs)then begin
			if(testf)then begin
				foundf = true;
				LCr.SerNr = "";
				LCr.CustCode = oldLCr.CustCode;
				LCr.LCMLevel = oldLCr.LCMLevel;
				LCr.CustName = oldLCr.CustName;
				LCr.StartDate = bd;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 16 06 2021 y. at 1:13:38 PM
				LoyaltyCardr.SerNr = "9999999999999";
				readlastmain(LoyaltyCardr,1,false);
				code = left(LoyaltyCardr.SerNr,12);
				code = right(code,9);
				newcode = stringtolongint(code);
				newcode = newcode+1;
				code = "999" & newcode;
				CalcEANCHS(code);
				LCr.SerNr = code;			
			end else begin
				if(left(oldLCr.LCMLevel,4)=="EMPL")then begin
					foundf = true;
					LCr.SerNr = "";
					LCr.CustCode = oldLCr.CustCode;
					LCr.LCMLevel = oldLCr.LCMLevel;
					LCr.CustName = oldLCr.CustName;
					LCr.StartDate = bd;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 16 06 2021 y. at 1:13:44 PM
					LoyaltyCardr.SerNr = "2001999999999";
					readlastmain(LoyaltyCardr,1,false);
					if(len(LoyaltyCardr.SerNr)!=13)then begin
						LoyaltyCardr.SerNr = "2001000000000";
					end;
					code = left(LoyaltyCardr.SerNr,12);
					code = right(code,9);
					newcode = stringtolongint(code);
					newcode = newcode+1;
					code = "200" & newcode;
					CalcEANCHS(code);
					LCr.SerNr = code;	
				end;
			end;
		end;
	end;
	
	if(foundf==false)then begin
		resetloop(oldLCr)
		TrHs = true;
		while(loopkey("CustCode",oldLCr,1,TrHs))begin
			testf = true;
			if(oldLCr.CustCode!=CUr.Code)then begin TrHs = false; testf = false; end;
			if(currentcompany!=25)then begin
				if(oldLCr.LCMLevel!="1")then begin testf = false; end;
			end else begin
				if(oldLCr.LCMLevel!="CASACOIN")then begin testf = false; end;
			end;
			if(left(oldLCr.SerNr,2)=="ID")then begin testf = false; end;
			
			if(TrHs)then begin
				if(testf)then begin
					foundf = true;
					LCr.SerNr = "";
					LCr.CustCode = oldLCr.CustCode;
					LCr.LCMLevel = oldLCr.LCMLevel;
					LCr.CustName = oldLCr.CustName;
					LCr.StartDate = bd;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 16 06 2021 y. at 1:13:48 PM
					LoyaltyCardr.SerNr = "9999999999999";
					readlastmain(LoyaltyCardr,1,false);
					code = left(LoyaltyCardr.SerNr,12);
					code = right(code,9);
					newcode = stringtolongint(code);
					newcode = newcode+1;
					code = "999" & newcode;
					CalcEANCHS(code);
					LCr.SerNr = code;			
				end else begin
					if(left(oldLCr.LCMLevel,4)=="EMPL")then begin
						foundf = true;
						LCr.SerNr = "";
						LCr.CustCode = oldLCr.CustCode;
						LCr.LCMLevel = oldLCr.LCMLevel;
						LCr.CustName = oldLCr.CustName;
						LCr.StartDate = bd;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 16 06 2021 y. at 1:13:53 PM
						LoyaltyCardr.SerNr = "2001999999999";
						readlastmain(LoyaltyCardr,1,false);
						if(len(LoyaltyCardr.SerNr)!=13)then begin
							LoyaltyCardr.SerNr = "2001000000000";
						end;
						code = left(LoyaltyCardr.SerNr,12);
						code = right(code,9);
						newcode = stringtolongint(code);
						newcode = newcode+1;
						code = "200" & newcode;
						CalcEANCHS(code);
						LCr.SerNr = code;	
					end;
				end;
			end;
		end;	
	end;


	if(foundf==false)then begin
		if(left(CUr.Code,2)!="ID" or CUr.EmployeeType==0)then begin
			resetloop(LoyaltyCardr);
			LoyaltyCardr.SerNr = "9999999999999";
			readlastmain(LoyaltyCardr,1,false);
			code = left(LoyaltyCardr.SerNr,12);
			code = right(code,9);
			newcode = stringtolongint(code);
			newcode = newcode+1;
			code = "999" & newcode;
			CalcEANCHS(code);
			LCr.SerNr = code;
			LCr.CustCode = CUr.Code;
			LCr.LCMLevel = "1";
			if(currentcompany==25)then begin
				LCr.LCMLevel = "CASACOIN";
			end;
			LCr.StartDate = bd;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 16 06 2021 y. at 1:14:00 PM
			LCr.CustName = CUr.Name;
		end else begin
			foundf = true;
			LCr.SerNr = "";
			LCr.CustCode = CUr.Code;
			LCr.LCMLevel = "EMPL";
			LCr.CustName = CUr.Name;
			LCr.StartDate = bd;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 16 06 2021 y. at 1:14:05 PM
			LoyaltyCardr.SerNr = "2001999999999";
			readlastmain(LoyaltyCardr,1,false);
			if(len(LoyaltyCardr.SerNr)!=13)then begin
				LoyaltyCardr.SerNr = "2001000000000";
			end;
			code = left(LoyaltyCardr.SerNr,12);
			code = right(code,9);
			newcode = stringtolongint(code);
			newcode = newcode+1;
			code = "200" & newcode;
			CalcEANCHS(code);
			LCr.SerNr = code;	
		end;
	end;
	
return;
end;

global 
function boolean HasOpenActivity(string user)
begin
	record ActVc Actr;
	boolean TrHs,testf,res;
	
	res = false;
	
	Actr.OKFlag=0;
	TrHs = true;
	While(loopkey("OKFlag",Actr,1,TrHs)) begin
		testf = true;
	  if(Actr.OKFlag>0)then begin TrHs=false; end;	  
	  
	  if(TrHs)then begin
	  	if(SetInSet2(user,Actr.MainPersons))then begin
	  		res = true;
	  	end;
	  end;	
	end; 
	
	HasOpenActivity = res;

return;
end;

procedure Gen0EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+a;
  i3 = asc(mid(str,3,1))+a;
  i4 = asc(mid(str,4,1))+a;
  i5 = asc(mid(str,5,1))+a;
  i6 = asc(mid(str,6,1))+a;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen1EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+a;
  i3 = asc(mid(str,3,1))+b;
  i4 = asc(mid(str,4,1))+a;
  i5 = asc(mid(str,5,1))+b;
  i6 = asc(mid(str,6,1))+b;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen2EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+a;
  i3 = asc(mid(str,3,1))+b;
  i4 = asc(mid(str,4,1))+b;
  i5 = asc(mid(str,5,1))+a;
  i6 = asc(mid(str,6,1))+b;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen3EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+a;
  i3 = asc(mid(str,3,1))+b;
  i4 = asc(mid(str,4,1))+b;
  i5 = asc(mid(str,5,1))+b;
  i6 = asc(mid(str,6,1))+a;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen4EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+b;
  i3 = asc(mid(str,3,1))+a;
  i4 = asc(mid(str,4,1))+a;
  i5 = asc(mid(str,5,1))+b;
  i6 = asc(mid(str,6,1))+b;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen5EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+b;
  i3 = asc(mid(str,3,1))+b;
  i4 = asc(mid(str,4,1))+a;
  i5 = asc(mid(str,5,1))+a;
  i6 = asc(mid(str,6,1))+b;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen6EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+b;
  i3 = asc(mid(str,3,1))+b;
  i4 = asc(mid(str,4,1))+b;
  i5 = asc(mid(str,5,1))+a;
  i6 = asc(mid(str,6,1))+a;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen7EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+b;
  i3 = asc(mid(str,3,1))+a;
  i4 = asc(mid(str,4,1))+b;
  i5 = asc(mid(str,5,1))+a;
  i6 = asc(mid(str,6,1))+b;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen8EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+b;
  i3 = asc(mid(str,3,1))+a;
  i4 = asc(mid(str,4,1))+b;
  i5 = asc(mid(str,5,1))+b;
  i6 = asc(mid(str,6,1))+a;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
  res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

procedure Gen9EAN(string str, var string res)
begin
integer i,i0,i1,i2,i3,i4,i5,i6,a,b,c;
  i0 = asc(mid(str,0,1));
  a=17;
  b=27;
  c=49;
  res = res & chr(i0);
  i1 = asc(mid(str,1,1))+a;
  i2 = asc(mid(str,2,1))+b;
  i3 = asc(mid(str,3,1))+b;
  i4 = asc(mid(str,4,1))+a;
  i5 = asc(mid(str,5,1))+b;
  i6 = asc(mid(str,6,1))+a;
  res = res & chr(i1) & chr(i2) & chr(i3) & chr(i4) & chr(i5) & chr(i6) & "*";
  for(i=7;i<13;i=i+1) begin
    res = res & chr(asc(mid(str,i,1))+c);
  end;
  res = res & "+";
end;

global 
function CreateEAN13(var string str)
begin
integer lenth,i,c;
string 5 c0,ci;
string 20 res;
boolean testf;
  lenth = len(str);
  testf = true;
  if(lenth!=13) then begin testf = false; end;
  for(i=0;i<lenth;i=i+1)begin
    c=asc(mid(str,i,1));
    if(c<48 or c>57) then begin testf = false; end;
  end;
  res = "";
  if(testf) then begin
    c0 = mid(str,0,1);
    switch(c0) begin
      case "0":Gen0EAN(str,res);
      case "1":Gen1EAN(str,res);
      case "2":Gen2EAN(str,res);
      case "3":Gen3EAN(str,res);
      case "4":Gen4EAN(str,res);
      case "5":Gen5EAN(str,res);
      case "6":Gen6EAN(str,res);
      case "7":Gen7EAN(str,res);
      case "8":Gen8EAN(str,res);
      case "9":Gen9EAN(str,res);
    end;
  end;
str = res;
return
end;

global //Edit***************************Sasha2,14:27 02.08.2016 {
procedure StringValIncrement(var string barcode,Integer increment)
begin
  integer lenght,i,lastindex,leftover,base,incr;
  array integer digit;
  boolean testf;
    
    testf = true;
    lenght = len(barcode);
    incr = increment;
    for (i=0;i<lenght;i=i+1) begin
      digit[i] = StringToInt(mid(barcode,i,1));
      lastindex = i;
    end;
    digit[lastindex] = digit[lastindex] + incr;
    while (digit[lastindex]>9 and testf) begin
      leftover = Mod(digit[lastindex],10);
      base = digit[lastindex] - leftover;
      if (base>0) then begin
        digit[lastindex] = leftover;
        incr = base/10;
        lastindex = lastindex - 1;
        digit[lastindex] = digit[lastindex] + incr;
      end;
      if (lastindex==0 and digit[lastindex]>9) then begin
        testf = false;
      end;
    end;
    barcode = "";
    if (testf) then begin
      for (i=0;i<lenght;i=i+1) begin
        barcode = barcode & digit[i];
      end;
    end;
 
  return; 
end; //Edit***************************Sasha2,14:27 02.08.2016 }

global //Edit***************************Sasha2,14:53 12.04.2016 {
function boolean CompanyIsJWLikeCompany(Integer curcomp)
begin
  Boolean res;
  
    res = false;
    switch (curcomp) begin
	  //case 1: res=true;  // swarowski dobavil ********** Irkan 07.02.2020??????????
      case 3: res=true;
      case 17: res=true;
	  //case 16: res=true;  // xtravaganza dobavil ********** Irkan 07.02.2020??????????
      case 19: res=true;
      case 20: res=true;
      case 21: res=true;
      case 22: res=true;
      case 23: res=true;
      case 24: res=true;
      case 27: res=true;
    end;
  
    CompanyIsJWLikeCompany = res;
  return
end; //Edit***************************Sasha2,14:53 12.04.2016 ]

//Edit***************************Sasha2,12:12 18.12.2015 {
function string 10 PrepareDICode(string indisp)
begin
  string 10 res,newdisp;
  integer i,lenth;
  string 1 c;
  
    res = "";
    newdisp = left(indisp,10);
    lenth = len(newdisp); 
    if (lenth>0) then begin
      for (i=0;i<lenth;i=i+1) begin
        c= Mid(newdisp,i,1);
        if (c==" " or c=="." or c==",") then begin
          res = res & "_";
        end else begin
          res = res & c;
        end;
      end;
      res = UpperCase(res);
    end;
    
  PrepareDICode = res;
  return;
end; //Edit***************************Sasha2,12:12 18.12.2015 }

global //Edit***************************Sasha2,14:00 16.12.2015 {
procedure HandleNewINDClassmCode(var record NewINVc newINr, integer rownr)
begin
record DIVc DIr;
record INVc INr;
row INVc INrw;
row NewINVc newINrw;
vector string 255 diTypes;
string 20 disp;
integer pos;
Boolean foundf;
  
  if (rownr>-1) then begin
    matrowget(newINr,rownr,newINrw);
		INr.Code = newINrw.Code;
		if (ReadFirstMain(INr,1,true)) then begin
			if(currentcompany==28) then begin
				if(nonblank(INr.Category)) then begin newINrw.Category = INr.Category; end;
				if(nonblank(INr.Group))then begin newINrw.GroupCl=INr.Group;end;
				matrowget(INr,0,INrw);
				if(nonblank(INrw.Text)) then begin newINrw.UserStr1 = INrw.Text; end;
			end;
  		if(nonblank(INr.Name))then begin newINrw.Name=INr.Name;  end;
  		if(nonblank(INr.Unittext))then begin newINrw.Unittext=INr.Unittext;end;
  		if(nonblank(INr.Objects))then begin newINrw.Objects=INr.Objects;  end;
  		if(INr.UPrice1>0)then begin newINrw.UPrice1=INr.UPrice1;end;
  		if(INr.ItemType>-1)then begin newINrw.ItemType=INr.ItemType; end;
  		if(nonblank(INr.Group))then begin newINrw.Group=INr.Group;end;
  		if(INr.SerNrf>=0)then begin newINrw.SerNrf=INr.SerNrf;end;
  		if(nonblank(INr.BarCode))then begin newINrw.BarCode=INr.BarCode;end;
  		if(nonblank(INr.VATCode))then begin newINrw.VATCode=INr.VATCode;end;
  		//if(nonblank(INr.LastPurchCurncyCode))then begin newINrw.LastPurchCurncyCode=INr.LastPurchCurncyCode;end;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 09 06 2020 y. at 5:28:58 PM
  		//if(INr.LastPurchPrice2>0)then begin newINrw.LastPurchPrice2=INr.LastPurchPrice2; end;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 09 06 2020 y. at 5:29:03 PM
  		if(nonblank(INr.AlternativeCode))then begin newINrw.AlternativeCode=INr.AlternativeCode;end;
  		if(nonblank(INr.NotForSales))then begin newINrw.NotForSales=INr.NotForSales; end; 
  		if(nonblank(INr.MajStoneDet))then begin newINrw.MajStoneDet=INr.MajStoneDet;end; 
  		if(nonblank(INr.Colour))then begin newINrw.Colour=INr.Colour;end;
  		if(nonblank(INr.Metal))then begin newINrw.Metal=INr.Metal;end;
  		if(nonblank(INr.RowWeight))then begin newINrw.RowWeight=INr.RowWeight;end;
  		if(nonblank(INr.Size))then begin newINrw.Size=INr.Size;end; 
  		if(nonblank(INr.Reference))then begin newINrw.Reference=INr.Reference;end; 
  		if(nonblank(INr.CPSCode))then begin newINrw.CPSCode=INr.CPSCode;end; 
  		if (NonBlank(INr.MainDisp)) then begin
  		  newINrw.Type=INr.MainDisp;
  		  if (NonBlank(INr.DispGroups)) then begin
  		    pos = 0;
  		    foundf = false;
  		    ExtractObj(INr.DispGroups,pos,disp);
			    while(nonblank(disp)) begin
			      DIr.Code = disp;
			      if (ReadFirstMain(DIr,1,true) and NonBlank(DIr.CType)) then begin
			        if (blank(diTypes[DIr.CType])) then begin
			          diTypes[DIr.CType] = DIr.Code;
			        end else begin
			          diTypes[DIr.CType] = diTypes[DIr.CType] & "," & DIr.Code;
			        end;
			        foundf = true;
			      end;
    			  ExtractObj(INr.DispGroups,pos,disp);
    			end;
    			if (foundf) then begin
    			  if (NonBlank(diTypes[ReturnFieldDIType("BrandSC",false)])) then begin
              newINrw.BrandSC = diTypes[ReturnFieldDIType("BrandSC",false)];
            end;
            
			  if (NonBlank(diTypes[ReturnFieldDIType("Weight",false)])) then begin
              newINrw.Weight = stringtoval(diTypes[ReturnFieldDIType("Weight",false)],M4Val);
            end;
			
            if (NonBlank(diTypes[ReturnFieldDIType("Collection",false)])) then begin
              newINrw.Collection = diTypes[ReturnFieldDIType("Collection",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif30",false)])) then begin
              newINrw.classif30 = diTypes[ReturnFieldDIType("classif30",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif31",false)])) then begin
              newINrw.classif31 = diTypes[ReturnFieldDIType("classif31",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Style",false)])) then begin
              newINrw.Style = diTypes[ReturnFieldDIType("Style",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif32",false)])) then begin
              newINrw.classif32 = diTypes[ReturnFieldDIType("classif32",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("WatchType",false)])) then begin
              newINrw.WatchType = diTypes[ReturnFieldDIType("WatchType",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("GenderSC",false)])) then begin
              newINrw.GenderSC = diTypes[ReturnFieldDIType("GenderSC",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Dial",false)])) then begin
              newINrw.Dial = diTypes[ReturnFieldDIType("Dial",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Strap",false)])) then begin
              newINrw.Strap = diTypes[ReturnFieldDIType("Strap",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Material",false)])) then begin
              newINrw.Material = diTypes[ReturnFieldDIType("Material",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif33",false)])) then begin
              newINrw.classif33 = diTypes[ReturnFieldDIType("classif33",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif34",false)])) then begin
              newINrw.classif34 = diTypes[ReturnFieldDIType("classif34",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("PrecStones",false)])) then begin
              newINrw.PrecStones = diTypes[ReturnFieldDIType("PrecStones",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Mechanism",false)])) then begin
              newINrw.Mechanism = diTypes[ReturnFieldDIType("Mechanism",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Function",false)])) then begin
              newINrw.Function = diTypes[ReturnFieldDIType("Function",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("WaterResist",false)])) then begin
              newINrw.WaterResist = diTypes[ReturnFieldDIType("WaterResist",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Diameter",false)])) then begin
              newINrw.Diameter = diTypes[ReturnFieldDIType("Diameter",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Category",false)])) then begin
              newINrw.Category = diTypes[ReturnFieldDIType("Category",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Division",false)])) then begin
              newINrw.Division = diTypes[ReturnFieldDIType("Division",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("WeightOfMat",false)])) then begin
              newINrw.WeightOfMat = diTypes[ReturnFieldDIType("WeightOfMat",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Diamonds",false)])) then begin
              newINrw.Diamonds = diTypes[ReturnFieldDIType("Diamonds",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("DiamondsCarat",false)])) then begin
              newINrw.DiamondsCarat = diTypes[ReturnFieldDIType("DiamondsCarat",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("SolidStones05",false)])) then begin
              newINrw.SolidStones05 = diTypes[ReturnFieldDIType("SolidStones05",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("PrecAndSemiPrec",false)])) then begin
              newINrw.PrecAndSemiPrec = diTypes[ReturnFieldDIType("PrecAndSemiPrec",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("RingSizes",false)])) then begin
              newINrw.RingSizes = diTypes[ReturnFieldDIType("RingSizes",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Carat",false)])) then begin
              newINrw.Carat = diTypes[ReturnFieldDIType("Carat",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("ClaritySC",false)])) then begin
              newINrw.ClaritySC = diTypes[ReturnFieldDIType("ClaritySC",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Color",false)])) then begin
              newINrw.Color = diTypes[ReturnFieldDIType("Color",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("ColorOfMat",false)])) then begin
              newINrw.ColorOfMat = diTypes[ReturnFieldDIType("ColorOfMat",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("ShapeCut",false)])) then begin
              newINrw.ShapeCut = diTypes[ReturnFieldDIType("ShapeCut",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Description",false)])) then begin
              newINrw.Description = diTypes[ReturnFieldDIType("Description",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Art",false)])) then begin
              newINrw.Art = diTypes[ReturnFieldDIType("Art",false)];
            end;
    			end;
  		  end;
  		end else begin
  		  if(nonblank(INr.DispGroups))then begin newINrw.DispGroups=INr.DispGroups;end;
  		  pos = 0;
		    foundf = false;
		    ExtractObj(INr.DispGroups,pos,disp);
		    while(nonblank(disp)) begin
		      DIr.Code = disp;
		      if (ReadFirstMain(DIr,1,true) and NonBlank(DIr.CType)) then begin
		        if (blank(diTypes[DIr.CType])) then begin
		          diTypes[DIr.CType] = DIr.Code;
		        end else begin
		          diTypes[DIr.CType] = diTypes[DIr.CType] & "," & DIr.Code;
		        end;
		        foundf = true;
		      end;
  			  ExtractObj(INr.DispGroups,pos,disp);
  			end;
  			if (foundf) then begin
          newINrw.BrandSC = diTypes[ReturnFieldDITypeNotJW("BrandSC")];  
          newINrw.classif30 = diTypes[ReturnFieldDITypeNotJW("classif30")];
          newINrw.Category = diTypes[ReturnFieldDITypeNotJW("Category")];
          newINrw.classif31 = diTypes[ReturnFieldDITypeNotJW("classif31")];
          newINrw.Collection = diTypes[ReturnFieldDITypeNotJW("Collection")];
          newINrw.Metal = diTypes[ReturnFieldDITypeNotJW("Metal")];
          newINrw.WeightOfMat = diTypes[ReturnFieldDITypeNotJW("WeightOfMat")];
          if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Carat")])) then begin
            newINrw.Carat = diTypes[ReturnFieldDITypeNotJW("Carat")];
          end;
          if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Size")])) then begin
            newINrw.Size = diTypes[ReturnFieldDITypeNotJW("Size")];
          end;
          if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Colour")])) then begin
            newINrw.Colour = diTypes[ReturnFieldDITypeNotJW("Colour")];
          end;
  			end;
  		end;
  		
		end;
	  matrowput(newINr,rownr,newINrw);
  end;

return;
end; //Edit***************************Sasha2,14:00 16.12.2015 }

global //Edit***************************ABR,16:37 23.07.2019 {
procedure HandleNewINDClassmAltCode(var record NewINVc newINr, integer rownr)
begin
record DIVc DIr;
record INVc INr;
row INVc INrw;
row NewINVc newINrw;
vector string 255 diTypes;
string 20 disp;
integer pos;
Boolean foundf;
  
  if (rownr>-1) then begin
    matrowget(newINr,rownr,newINrw);
		if(currentcompany==28) then begin
			if(newINrw.ConsgType==1) then begin
				newINrw.SerNrf = 2;
			end else begin
				newINrw.SerNrf = 0;
			end;
		end;
		if(nonblank(newINrw.AlternativeCode)) then begin
			INr.AlternativeCode = newINrw.AlternativeCode;
			if (ReadFirstKey("DIAlternativeCode",INr,1,true)) then begin
				newINrw.Code = INr.Code;
				if(nonblank(INr.Group))then begin newINrw.GroupCl=INr.Group;end;
				if(nonblank(INr.Category))then begin newINrw.Category=INr.Category;  end;
				if(nonblank(INr.Name))then begin newINrw.Name=INr.Name;  end;
				if(nonblank(INr.Unittext))then begin newINrw.Unittext=INr.Unittext;end;
				if(nonblank(INr.Objects))then begin newINrw.Objects=INr.Objects;  end;
				if(INr.UPrice1>0)then begin newINrw.UPrice1=INr.UPrice1;end;
				if(INr.ItemType>-1)then begin newINrw.ItemType=INr.ItemType; end;
				if(nonblank(INr.Group))then begin newINrw.Group=INr.Group;end;
				if(INr.SerNrf>=0)then begin newINrw.SerNrf=INr.SerNrf;end;
				if(nonblank(INr.BarCode))then begin newINrw.BarCode=INr.BarCode;end;
				if(nonblank(INr.VATCode))then begin newINrw.VATCode=INr.VATCode;end;
				//if(nonblank(INr.LastPurchCurncyCode))then begin newINrw.LastPurchCurncyCode=INr.LastPurchCurncyCode;end;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 09 06 2020 y. at 5:29:11 PM
				//if(INr.LastPurchPrice2>0)then begin newINrw.LastPurchPrice2=INr.LastPurchPrice2; end;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 09 06 2020 y. at 5:29:19 PM
				if(nonblank(INr.AlternativeCode))then begin newINrw.AlternativeCode=INr.AlternativeCode;end;
				if(nonblank(INr.NotForSales))then begin newINrw.NotForSales=INr.NotForSales; end; 
				if(nonblank(INr.MajStoneDet))then begin newINrw.MajStoneDet=INr.MajStoneDet;end; 
				if(nonblank(INr.Colour))then begin newINrw.Colour=INr.Colour;end;
				if(nonblank(INr.Metal))then begin newINrw.Metal=INr.Metal;end;
				if(nonblank(INr.RowWeight))then begin newINrw.RowWeight=INr.RowWeight;end;
				if(nonblank(INr.Size))then begin newINrw.Size=INr.Size;end; 
				if(nonblank(INr.Reference))then begin newINrw.Reference=INr.Reference;end; 
				if(nonblank(INr.CPSCode))then begin newINrw.CPSCode=INr.CPSCode;end; 
				if(nonblank(INr.Size))then begin newINrw.Size=INr.Size;end;
				if(nonblank(INr.ConsgType))then begin newINrw.ConsgType=INr.ConsgType;end;
				matrowget(INr,0,INrw);
				if(nonblank(INrw.Text)) then begin newINrw.UserStr1 = INrw.Text; end;
				if(currentcompany==28 and INr.ConsgType==1) then begin
					newINrw.SerNrf = 2;
				end;
				if (NonBlank(INr.MainDisp)) then begin
					newINrw.Type=INr.MainDisp;
					if (NonBlank(INr.DispGroups)) then begin
						pos = 0;
						foundf = false;
						ExtractObj(INr.DispGroups,pos,disp);
						while(nonblank(disp)) begin
							DIr.Code = disp;
							if (ReadFirstMain(DIr,1,true) and NonBlank(DIr.CType)) then begin
								if (blank(diTypes[DIr.CType])) then begin
									diTypes[DIr.CType] = DIr.Code;
								end else begin
									diTypes[DIr.CType] = diTypes[DIr.CType] & "," & DIr.Code;
								end;
								foundf = true;
							end;
							ExtractObj(INr.DispGroups,pos,disp);
						end;
						if (foundf) then begin
							if (NonBlank(diTypes[ReturnFieldDIType("BrandSC",false)])) then begin
								newINrw.BrandSC = diTypes[ReturnFieldDIType("BrandSC",false)];
							end;
							
					if (NonBlank(diTypes[ReturnFieldDIType("Weight",false)])) then begin
								newINrw.Weight = stringtoval(diTypes[ReturnFieldDIType("Weight",false)],M4Val);
							end;
				
							if (NonBlank(diTypes[ReturnFieldDIType("Collection",false)])) then begin
								newINrw.Collection = diTypes[ReturnFieldDIType("Collection",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("classif30",false)])) then begin
								newINrw.classif30 = diTypes[ReturnFieldDIType("classif30",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("classif31",false)])) then begin
								newINrw.classif31 = diTypes[ReturnFieldDIType("classif31",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Style",false)])) then begin
								newINrw.Style = diTypes[ReturnFieldDIType("Style",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("classif32",false)])) then begin
								newINrw.classif32 = diTypes[ReturnFieldDIType("classif32",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("WatchType",false)])) then begin
								newINrw.WatchType = diTypes[ReturnFieldDIType("WatchType",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("GenderSC",false)])) then begin
								newINrw.GenderSC = diTypes[ReturnFieldDIType("GenderSC",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Dial",false)])) then begin
								newINrw.Dial = diTypes[ReturnFieldDIType("Dial",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Strap",false)])) then begin
								newINrw.Strap = diTypes[ReturnFieldDIType("Strap",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Material",false)])) then begin
								newINrw.Material = diTypes[ReturnFieldDIType("Material",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("classif33",false)])) then begin
								newINrw.classif33 = diTypes[ReturnFieldDIType("classif33",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("classif34",false)])) then begin
								newINrw.classif34 = diTypes[ReturnFieldDIType("classif34",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("PrecStones",false)])) then begin
								newINrw.PrecStones = diTypes[ReturnFieldDIType("PrecStones",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Mechanism",false)])) then begin
								newINrw.Mechanism = diTypes[ReturnFieldDIType("Mechanism",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Function",false)])) then begin
								newINrw.Function = diTypes[ReturnFieldDIType("Function",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("WaterResist",false)])) then begin
								newINrw.WaterResist = diTypes[ReturnFieldDIType("WaterResist",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Diameter",false)])) then begin
								newINrw.Diameter = diTypes[ReturnFieldDIType("Diameter",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Category",false)])) then begin
								newINrw.Category = diTypes[ReturnFieldDIType("Category",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Division",false)])) then begin
								newINrw.Division = diTypes[ReturnFieldDIType("Division",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("WeightOfMat",false)])) then begin
								newINrw.WeightOfMat = diTypes[ReturnFieldDIType("WeightOfMat",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Diamonds",false)])) then begin
								newINrw.Diamonds = diTypes[ReturnFieldDIType("Diamonds",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("DiamondsCarat",false)])) then begin
								newINrw.DiamondsCarat = diTypes[ReturnFieldDIType("DiamondsCarat",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("SolidStones05",false)])) then begin
								newINrw.SolidStones05 = diTypes[ReturnFieldDIType("SolidStones05",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("PrecAndSemiPrec",false)])) then begin
								newINrw.PrecAndSemiPrec = diTypes[ReturnFieldDIType("PrecAndSemiPrec",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("RingSizes",false)])) then begin
								newINrw.RingSizes = diTypes[ReturnFieldDIType("RingSizes",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Carat",false)])) then begin
								newINrw.Carat = diTypes[ReturnFieldDIType("Carat",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("ClaritySC",false)])) then begin
								newINrw.ClaritySC = diTypes[ReturnFieldDIType("ClaritySC",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Color",false)])) then begin
								newINrw.Color = diTypes[ReturnFieldDIType("Color",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("ColorOfMat",false)])) then begin
								newINrw.ColorOfMat = diTypes[ReturnFieldDIType("ColorOfMat",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("ShapeCut",false)])) then begin
								newINrw.ShapeCut = diTypes[ReturnFieldDIType("ShapeCut",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Description",false)])) then begin
								newINrw.Description = diTypes[ReturnFieldDIType("Description",false)];
							end;
							
							if (NonBlank(diTypes[ReturnFieldDIType("Art",false)])) then begin
								newINrw.Art = diTypes[ReturnFieldDIType("Art",false)];
							end;
						end;
					end;
				end else begin
					if(nonblank(INr.DispGroups))then begin newINrw.DispGroups=INr.DispGroups;end;
					pos = 0;
					foundf = false;
					ExtractObj(INr.DispGroups,pos,disp);
					while(nonblank(disp)) begin
						DIr.Code = disp;
						if (ReadFirstMain(DIr,1,true) and NonBlank(DIr.CType)) then begin
							if (blank(diTypes[DIr.CType])) then begin
								diTypes[DIr.CType] = DIr.Code;
							end else begin
								diTypes[DIr.CType] = diTypes[DIr.CType] & "," & DIr.Code;
							end;
							foundf = true;
						end;
						ExtractObj(INr.DispGroups,pos,disp);
					end;
					if (foundf) then begin
						newINrw.BrandSC = diTypes[ReturnFieldDITypeNotJW("BrandSC")];  
						newINrw.classif30 = diTypes[ReturnFieldDITypeNotJW("classif30")];
						newINrw.Category = diTypes[ReturnFieldDITypeNotJW("Category")];
						newINrw.classif31 = diTypes[ReturnFieldDITypeNotJW("classif31")];
						newINrw.Collection = diTypes[ReturnFieldDITypeNotJW("Collection")];
						newINrw.Metal = diTypes[ReturnFieldDITypeNotJW("Metal")];
						newINrw.WeightOfMat = diTypes[ReturnFieldDITypeNotJW("WeightOfMat")];
						if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Carat")])) then begin
							newINrw.Carat = diTypes[ReturnFieldDITypeNotJW("Carat")];
						end;
						if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Size")])) then begin
							//newINrw.Size = diTypes[ReturnFieldDITypeNotJW("Size")];
						end;
						if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Colour")])) then begin
							newINrw.Colour = diTypes[ReturnFieldDITypeNotJW("Colour")];
						end;
					end;
				end;
  		end;
		end;
	  matrowput(newINr,rownr,newINrw);
  end;

return;
end; //Edit********************ABR

global updating procedure ImportImagesMn(record RcVc RepSpec)
begin
record INVc INr;
integer filesi,i;
string 200 path,filename,itemname;
integer comp;
longint curtick;

curtick = getcurtick(); 
  comp = currentcompany;
  path = "Table_files";
  
  filesi = countfilesindir(path);
  for (i=0;i<filesi;i=i+1) begin
    filename = GetFileNameInDir(path,i);
    
    if(setinset(".jpg",right(filename,4)) or setinset(".png",right(filename,4)))then begin
      itemname = left(filename,len(filename)-4);
      INr.Code = itemname;
      if(readfirstmain(INr,1,true))then begin
        if(INr.Code==itemname)then begin
          RecordLinkFile(path & "\\" & filename,0,INr,comp);
        end;
      end;
    end;
    
  end;
  LogProcTime("ImportImagesMn",getcurtick()-curtick);
return;
end;

global updating procedure CUChangeCurMn(record RcVc RepSpec)
begin
record CUVc CUr;
record CurncyCodeVc CCr;
string 10 curncy;
longint curtick;

curtick = getcurtick();
  
  if(nonblank(RepSpec.f1))then begin
    CCr.CurncyCode = RepSpec.f1;
    if(readfirstmain(CCr,1,true))then begin
      if(CCr.CurncyCode==RepSpec.f1)then begin
        CUr.Code = "";
        curncy = RepSpec.f1;
        while(loopmain(CUr,1,true))begin
          if(CUr.CurncyCode!=curncy)then begin
            CUr.CurncyCode=curncy;
            recordStore(CUr,true);
          end;
        end;
      end else begin
        messagebox(1120,"");
      end;
    end else begin
        messagebox(1120,"");
    end;
  end else begin
    if(RepSpec.flags[0]>0)then begin
      CUr.Code = "";
      curncy = "";
      while(loopmain(CUr,1,true))begin
        if(CUr.CurncyCode!=curncy)then begin
          CUr.CurncyCode=curncy;
          recordStore(CUr,true);
        end;
      end;
    end;
  end;
	LogProcTime("CUChangeCurMn",getcurtick()-curtick);
return;
end;

global updating procedure CUChangeBALMn(record RcVc RepSpec)
begin
record CUVc CUr;
record CurncyCodeVc CCr;
string 10 curncy;
  
  
CUr.Code = "";
while(loopmain(CUr,1,true))begin
	if(CUr.OnAccount<1)then begin
		CUr.OnAccount=1;
		recordStore(CUr,true);
	end;
end;
    
return;
end;


global updating procedure INChangeCSTMn(record RcVc RepSpec)
begin
record INVc INr;
longint curtick;

curtick = getcurtick();
  INr.Code = "";
  While(loopmain(INr,1,true))begin
    if(INr.UpdateCost>0 or INr.SRUpdateCost>0)then begin
      INr.UpdateCost=0; 
      INr.SRUpdateCost = 0;
      recordStore(INr,true);
    end;
  end;
  LogProcTime("INChangeCSTMn",getcurtick()-curtick);
return;
end;


global updating procedure FIXIHMn(record RcVc RepSpec)
begin
	record INVc INr;
	record PUVc PUr;
	row PUVc PUrw;
	record IVVc IVr;
	row IVVc IVrw;
	record StockMovVc SMr;
	row StockMovVc SMrw;
	val rate;
	integer i,mtrw;
	date fd;
	record ItemHistVc IHr,IH2r;
	boolean TrHs,testf;
	longint curtick;
	
	curtick = getcurtick();
	/*
	IVr.SerNr = 2976;
	readfirstmain(IVr,1,true);
		matrowdelete(IVr,2);
		matrowget(IVr,1,IVrw);
			IVrw.Sum = 63;
			IVrw.Points = 63;
		matrowPUt(IVr,1,IVrw);
	
	recordstore(IVr,true);*/
	
	rate = 1.1;
	
	fd = stringtodate("29/11/2011");
	
	/*IHr.TransDate = fd;
	IHr.FileName = "StockMovVc";
	TrHs = true;
	while(loopkey("FNTransDate",IHr,2,TrHs))begin
		testf = true;
		if(IHr.TransDate<fd)then begin TrHs = false; testf = false; end;
		
		if(testf)then begin
			if(IHr.Qty<0)then begin
				IH2r.SerNr = IHr.Source;
				if(readfirstmain(IH2r,1,true) and IH2r.TransDate>=fd and IH2r.FileName=="PUVc")then begin
					PUr.SerNr = IH2r.TransNr;
					readfirstmain(PUr,1,true);
					if(PUr.CurncyCode=="AZN")then begin
						SMr.SerNr = IHr.TransNr;
						readfirstmain(SMr,1,true);
						matrowget(SMr,IHr.Row,SMrw);
						SMrw.NewPrice = round(SMrw.NewPrice * rate,defaultcurroundoff);
						SMrw.OldPrice = round(SMrw.OldPrice * rate,defaultcurroundoff);
						SMrw.FIFORowVal = round(SMrw.FIFORowVal * rate,defaultcurroundoff);
						SMrw.SentNewPrice = round(SMrw.SentNewPrice * rate,defaultcurroundoff);
						SMrw.SentOldPrice = round(SMrw.SentOldPrice * rate,defaultcurroundoff);
						SMrw.SentFIFORowVal = round(SMrw.SentFIFORowVal * rate,defaultcurroundoff);
						matrowput(SMr,IHr.Row,SMrw);
						recordStore(SMr,true);
					end;
				end;
			end;
		end;
	end;
	resetloop(IHr);*/
	
	
	IHr.TransDate = fd;
	IHr.FileName = "IVVc";
	TrHs = true;
	while(loopkey("FNTransDate",IHr,2,TrHs))begin
		testf = true;
		if(IHr.TransDate<fd)then begin testf = false; TrHs = false; end;
		if(IHr.Qty<0)then begin testf = false; end;
		
		if(testf)then begin
			IH2r.FileName = "PUVc";
			IH2r.ArtCode = IHr.ArtCode;
			IH2r.TransDate = IHr.TransDate;
			if(readlastkey("FNArtCode",IH2r,3,false) and IH2r.TransDate>=fd)then begin
				PUr.SerNr = IH2r.TransNr;
				readfirstmain(PUr,1,true);
				if(PUr.CurncyCode=="AZN")then begin
					IVr.SerNr = IHr.TransNr;
					readfirstmain(IVr,1,true);
					matrowget(IVr,IHr.Row,IVrw);
					IVrw.FIFO = round(IVrw.FIFO * rate,defaultcurroundoff);
					IVrw.FIFORowVal = round(IVrw.FIFORowVal * rate,defaultcurroundoff);
					matrowput(IVr,IHr.Row,IVrw);
					recordStore(IVr,true);
				end;
			end;
		end;
	end;
	resetloop(IHr);
	
	/*PUr.TransDate = fd;
	TrHs = true;
	while(loopkey("TransDate",PUr,1,TrHs))begin
		testf = true;
		if(PUr.TransDate<fd)then begin testf = false; TrHs = false; end;
		if(PUr.CurncyCode=="EUR")then begin testf = false; end;
		
		if(testf)then begin
			mtrw = matrowcnt(PUr);
			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(PUr,i,PUrw);
	  			PUrw.CostPrice = round(PUrw.CostPrice*rate,defaultcurroundoff);
	  			//PUrw.UPrice = PUrw.UPrice*rate;
	  			PUrw.Sum = round(PUrw.Sum*rate,defaultcurroundoff);
	  		matrowput(PUr,i,PUrw);
			end; 
			PUr.CurncyCode = "EUR";
			PUr.Comment = "AZN -> EUR";
			recordstore(PUr,true);
		end;
		
	end;*/
	
  LogProcTime("FIXIHMn",getcurtick()-curtick);
return;
end;


global updating procedure FixIVChangeBackMn()
begin
	record IVVc IVr;
	row IVVc IVrw;
	integer i,mtrw;
	boolean putin;
	
	IVr.SerNr = "";
	while(loopmain(IVr,1,true))begin
		putin = false;
		if(IVr.RetnValue>0)then begin
			mtrw = matrowcnt(IVr);
			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(IVr,i,IVrw);
	  		if(IVrw.stp==kInvoiceRowTypeCashPayment)then begin
					IVrw.Sum = IVrw.Sum - IVr.RetnValue;
					IVr.RetnValue = 0;
					IVr.RetValue = 0;
					matrowput(IVr,i,IVrw);
					putin = true;
	  		end;
			end; 			
		end;
		if(putin)then begin
			recordstore(IVr,true);
		end;
	end;
return;
end;

global updating procedure CreateGlobalLocationsMn()
begin
	record GlobalLocationVc Glocr;
	record LocationVc Locr;
	record CompaniesBlock CBb;
	row CompaniesBlock CBrw;
	integer mtrw,i;
	
	blockload(CBb);
	mtrw = matrowcnt(CBb);
	For(i=0;i<mtrw;i=i+1) begin
	  if (SetCompany(i+1,false)) then begin
			Locr.Code = "";
			while(loopmain(Locr,1,true))begin
				recordnew(Glocr);
				Glocr.Code = Locr.Code;
				Glocr.Name = Locr.Name;
				Glocr.Company = i+1;
				recordStore(GLocr,true);
			end;
			resetloop(Locr);
		ResetCompany(i+1);  
  	end;
	end; 
	
return;
end;




global updating procedure UNOKStockFinDockMn()
begin
	record IVVc IVr;
	record PUVc PUr;
	record StockMovVc SMr;
	record SDVc SDr;
	record SHVc SHr;
	record IPVc IPr;
	record ORVc ORr;
	record RetVc Retr;
	
	
	IVr.SerNr = -1;
	PUr.SerNr = -1;
	SMr.SerNr = -1;
	SDr.SerNr = -1;
	SHr.SerNr = -1;
	IPr.SerNr = -1;
	ORr.SerNr = -1;
	Retr.SerNr = -1;
	
	while(loopmain(IVr,1,true))begin
		IVr.OKFlag = 0;	
		recordStore(IVr,true);	
	end;
	while(loopmain(PUr,1,true))begin
		PUr.OKFlag = 0;	
		recordStore(PUr,true);	
	end;
	while(loopmain(SMr,1,true))begin
		SMr.OrdFlag = 0;	
		SMr.SentOKFlag = 0;
		SMr.OKFlag = 0;
		recordStore(SMr,true);	
	end;
	while(loopmain(SDr,1,true))begin
		SDr.OKFlag = 0;	
		recordStore(SDr,true);	
	end;
	while(loopmain(SHr,1,true))begin
		SHr.OKFlag = 0;	
		recordStore(SHr,true);	
	end;
	while(loopmain(IPr,1,true))begin
		IPr.OKFlag = 0;	
		recordStore(IPr,true);	
	end;
	/*while(loopmain(ORr,1,true))begin
		ORr.OKFlag = 0;	
		recordStore(ORr,true);	
	end;*/
	while(loopmain(Retr,1,true))begin
		Retr.OKFlag = 0;	
		recordStore(Retr,true);	
	end;
	
return;
end;


global updating procedure DellAccAndMainMn()
begin
	record AccVc Accr;
	record TRVc TRr;
	
	Accr.AccNumber = "";
	while(loopmain(Accr,1,true))begin
		recorddelete(Accr);
		stepback(Accr);
	end;
	
	TRr.IntYc = -1;
	while(loopmain(TRr,1,true))begin
		recorddelete(TRr);
		stepback(TRr);
	end;
  
return;
end;

global updating procedure DellNewINMn()
begin
	record INVc INr;
	record RHistVc RHistr;
  record RHistVc RHist2r;
  Boolean Accs;
  record CUVc CUr;
  string 200 tstr;
  boolean testf,TrHs;
  
  
	while(loopmain(INr,1,true))begin
		
		tstr = BuildRecordIdStr(INr,currentcompany);
		Accs = true;
		RHist2r.RecidStr = tstr;
		if (ReadFirstKey("RecidStr",RHist2r,1,true)) then begin
			if(RHist2r.TransDate==stringtodate("04/11/2014"))then begin
				if(RHist2r.TransTime>stringtotime("18:36:00") and RHist2r.TransTime<stringtotime("18:37:00"))then begin
					testf = true;
					if(setinset("CARRERA_CA",INr.DispGroups))then begin testf = false; end;
					if(setinset("DUPONT",INr.DispGroups))then begin testf = false; end;
					if(setinset("LEO_PIZZO",INr.DispGroups))then begin testf = false; end;
					if(setinset("PASQUALE_B",INr.DispGroups))then begin testf = false; end;
					if(setinset("STEPHEN_WE",INr.DispGroups))then begin testf = false; end;
					if(setinset("UTOPIA",INr.DispGroups))then begin testf = false; end;
					if(setinset("VICTOR_MAY",INr.DispGroups))then begin testf = false; end;
					if(setinset("ZANCAN",INr.DispGroups))then begin testf = false; end;
					
					if(testf)then begin
						logtext(0,"delete " & INr.Code & " Date & time: " & RHist2r.TransDate & " " & RHist2r.TransTime);
						recorddelete(INr);
						stepback(INr);
					end;
					
				end;
			end;
		end;
		
	end;
	
return;
end;


global updating procedure ChangeAccInPO()
begin
	record POVc POr;
	row POVc POrw;
	integer i,mtrw;
	boolean findf;
	
	
	while(loopmain(POr,1,true))begin
		mtrw = matrowcnt(POr);
		if(mtrw>0)then begin
			findf = false;
			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(POr,i,POrw);
				if(nonblank(POrw.CostAcc) and POrw.CostAcc!="41/01")then begin
					POrw.CostAcc = "41/01";
					matrowput(POr,i,POrw);
					findf = true;
				end;
			end; 
			if(findf)then begin
				recordStore(POr,true);
			end;
		end;
	end;

return;
end;


global updating procedure MoveRowUPInTRVcMn(record RcVc RepSpec)
begin
	record TRVc TRr;
	row TRVc TRrw;
	boolean TrHs, testf;
	integer mtrw,i;
	longint curtick;
	
	curtick = getcurtick();
	TRr.IntYc=IVYc;
	TrHs = true;
	while(loopmain(TRr,1,TrHs))begin
		if(TRr.IntYc!=IVYc)then begin TrHs = false; end;
		
		
		if(TrHs)then begin	
			testf = false;
			mtrw = matrowcnt(TRr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(TRr,i,TRrw);	  
				if(TRrw.AccNumber=="51" and i>0)then begin
					matrowdelete(TRr,i);
					matrowinsert(TRr,0,TRrw);
					testf = true;				
				end;
				matrowget(TRr,i,TRrw);	  
				if(TRrw.AccNumber=="50" and i>0)then begin
					matrowdelete(TRr,i);
					matrowinsert(TRr,0,TRrw);
					testf = true;				
				end;
			end; 
			if(testf)then begin
				recordstore(TRr,true);
			end;
		end;
	end;
	LogProcTime("MoveRowUPInTRVcMn",getcurtick()-curtick);
return;
end;


global updating procedure ChangeAccInTRVcMn(record RcVc RepSpec)
begin
	record TRVc TRr;
	row TRVc TRrw;
	boolean TrHs, testf;
	integer mtrw,i;
	record AccVc Accr;
	string 100 comment,obj,comment2;
	record ObjBalVc ObjBalr;
	integer pos;
	longint curtick;
	
	curtick = getcurtick();
	Accr.AccNumber="45";
	readfirstmain(Accr,1,true);
	comment = Accr.Comment;
	Accr.AccNumber="47";
	readfirstmain(Accr,1,true);
	comment2 = Accr.Comment;
	
	
	TRr.IntYc=IVYc;
	TrHs = true;
	while(loopmain(TRr,1,TrHs))begin
		if(TRr.IntYc!=IVYc)then begin TrHs = false; end;
		
		
		if(TrHs)then begin	
			testf = false;
			mtrw = matrowcnt(TRr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(TRr,i,TRrw);	  
				if(TRrw.AccNumber=="46" and nonblank(TRrw.VATCode) and TRrw.DebVal>0)then begin
					TRrw.AccNumber="47";
					TRrw.Comment=comment2;
					matrowput(TRr,i,TRrw);
					testf = true;
				end;
				if(TRrw.AccNumber=="46" and blank(TRrw.VATCode))then begin
					
					/*balrfound = GetObjBal("46","",ObjBalr);
					AddBalance(ObjBalr,TRr.TransDate,"transdebit",-TRrw.DebVal,"transcredit",-TRrw.CredVal,"",blankval,"",blankval,"",blankval,"",blankval);
					
					pos = 0;
					obj = "";
					ExtractObj(TRrw.Objects,pos,obj);
					While (nonblank(obj)) begin
						if(nonblank(obj))then begin
							balrfound = GetObjBal("46",obj,ObjBalr);
							AddBalance(ObjBalr,TRr.TransDate,"transdebit",-TRrw.DebVal,"transcredit",-TRrw.CredVal,"",blankval,"",blankval,"",blankval,"",blankval);
						end;
						ExtractObj(TRrw.Objects,pos,obj);
					end;*/
					
					
					TRrw.AccNumber="45";
					TRrw.Comment=comment;
					matrowput(TRr,i,TRrw);
					
					/*balrfound = GetObjBal("45","",ObjBalr);
					AddBalance(ObjBalr,TRr.TransDate,"transdebit",TRrw.DebVal,"transcredit",TRrw.CredVal,"",blankval,"",blankval,"",blankval,"",blankval);
					
					pos = 0;
					obj = "";
					ExtractObj(TRrw.Objects,pos,obj);
					While (nonblank(obj)) begin
						if(nonblank(obj))then begin
							balrfound = GetObjBal("45",obj,ObjBalr);
							AddBalance(ObjBalr,TRr.TransDate,"transdebit",TRrw.DebVal,"transcredit",TRrw.CredVal,"",blankval,"",blankval,"",blankval,"",blankval);
						end;
						ExtractObj(TRrw.Objects,pos,obj);
					end;*/
					
					
					testf = true;				
				end;
			end; 
			if(testf)then begin
				recordstore(TRr,true);
			end;
		end;
	end;
	LogProcTime("ChangeAccInTRVcMn",getcurtick()-curtick);
return;
end;


global updating procedure Remove54AccToOtherTRVcMn(record RcVc RepSpec)
begin
	record TRVc TRr;
	row TRVc TRrw;
	boolean TrHs, testf;
	integer mtrw,i;
	record AccVc Accr;
	string 100 comment,obj,comment2;
	record ObjBalVc ObjBalr;
	integer pos;
	longint curtick;
	
	curtick = getcurtick();
	Accr.AccNumber="58";
	readfirstmain(Accr,1,true);
	comment = Accr.Comment;

	
	
	TRr.IntYc=OPYc;
	TrHs = true;
	while(loopmain(TRr,1,TrHs))begin
		if(TRr.IntYc!=OPYc)then begin TrHs = false; end;
		
		if(TrHs)then begin	
			testf = false;
			mtrw = matrowcnt(TRr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(TRr,i,TRrw);	  
				if(TRrw.AccNumber=="52")then begin
					TRrw.AccNumber="58";
					TRrw.Comment=comment;
					matrowput(TRr,i,TRrw);
					testf = true;
				end;
			end; 
			if(testf)then begin
				recordstore(TRr,true);
			end;
		end;
	end;
	LogProcTime("Remove54AccToOtherTRVcMn",getcurtick()-curtick);
return;
end;




function Boolean FindSubString( string Search, string Source )
begin
	integer i,length,lengthSource,diff;
	string 150 temp,str,inStr;
	boolean res;
	
	res=false;
	length=len(Search);
	lengthSource=len(Source);
	diff=lengthSource-length;

	str=UpperCase(Search);   
	inStr=UpperCase(Source);		
	if (diff<0) then begin
	goto	breakFunction;
	end;
	
	for(i=0;i<=diff;i=i+1) begin
	 temp=mid(inStr,i,length);
	 if(temp==str) then begin
	 	res = true;
	 	goto breakFunction;
	 end;	
	end;

	breakFunction:; // goto
	FindSubString=res;
return;  
end;


global
updating procedure  ConsignmentTypeMn(record RcVc RepSpec)	//Edit----------------------Dima 17.12.2014
begin
  record INVc INr;
  record DIVc DIr;
  record AccVc Accr;
  boolean TrHs,next,type1,type2;
  string 30 code,class;
  integer pos;
  boolean changef;
	longint curtick;
	
	curtick = getcurtick();
	TrHs = true;
	type1 = false;
	type2 = false;

	Accr.AccNumber = "41/02";
	if (ReadFirstMain(Accr,1,true)) then begin
	type1 = true;
	end;

	Accr.AccNumber = "12";
	if (ReadFirstMain(Accr,1,true)) then begin
	type2 = true;
	end;


	while (LoopMain(INr,1,TrHs)) begin
		changef = false;
		next = true;
		
		/*if(setinset("30",INr.DispGroups) or setinset("31",INr.DispGroups) or setinset("32",INr.DispGroups) or setinset("33",INr.DispGroups) or setinset("34",INr.DispGroups) or setinset("35",INr.DispGroups))then begin
			INr.ConsgType = 2;
			INr.PurchAcc = "12";
			changef = true;
			RecordStore(INr,true);  
		end;*/
		code = INr.Code;
		if (type1==true) then begin
			if (Right(code,2)=="VR") then begin 	//first type
				// INr.ConsgType = 1;
				// INr.PurchAcc = "41/02";
				changef = true;
				next = false;
			end;	
		end;
		
		if((next==true) and (type2==true)) then begin			//second type
			class = "";
			pos = 0;
			ExtractObj(INr.DispGroups,pos,class);
			while(nonblank(class))begin
				DIr.Code = class;
				readfirstmain(DIr,1,true);
				if(FindSubString("POS",DIr.Code) or FindSubString("POS",DIr.Name))then begin
					INr.ConsgType = 2;
					INr.PurchAcc = "12";
					changef = true;
				end;
				ExtractObj(INr.DispGroups,pos,class);
			end;
		end;
		
		if(changef)then begin
      RecordStore(INr,true);           
    end;      
	end;
	LogProcTime("ConsignmentTypeMn",getcurtick()-curtick);
  return;
end;

global
updating procedure ChangeSalesAccInORRowsMn(record RcVc RepSpec) //Edit***************************Sasha2,12:02 23.12.2014 {
begin
  record ORVc ORr;
  row ORVc ORrw;
  integer rwcnt,i;
  Boolean found;
  string 10 acc;
  longint curtick;
		
		curtick = getcurtick();
  	acc = "" & 46;
  	while (LoopMain(ORr,1,true)) begin
  		found = false;
  		rwcnt = MatRowCnt(ORr);
  		for (i=0;i<rwcnt;i=i+1) begin
  			MatRowGet(ORr,i,ORrw);
  			if (ORrw.stp==1 and NonBlank(ORrw.ArtCode)) then begin
	  			ORrw.SalesAcc = acc;
	  			found = true;
	  			MatRowPut(ORr,i,ORrw);
	  		end;	
  		end;
  		if (found) then begin
  			RECORDSTORE(ORr,true);
  		end;
  	end;
	LogProcTime("ChangeSalesAccInORRowsMn",getcurtick()-curtick);
  return;
end; //Edit***************************Sasha2,14:09 23.12.2014 }

global
updating procedure AnnulateVATDupontMn(record RcVc RepSpec) //Edit***************************Sasha2,12:02 23.12.2014 {
begin
  record INVc INr;
  Boolean found;
  longint curtick;
		curtick = getcurtick();
  	if (currentcompany==10) then begin
  		while (LoopMain(INr,1,true)) begin
	  		found = false;
	  		if (NonBlank(INr.VATCode)) then begin
	  			INr.VATCode = "";
	  			found = true;
	  		end;
	  		if (found) then begin
	  			RECORDSTORE(INr,true);
	  		end;
  		end;
  	end;
	LogProcTime("AnnulateVATDupontMn",getcurtick()-curtick);
  return;
end; //Edit***************************Sasha2,14:09 23.12.2014 }



global
updating procedure  AccCostFrom411To4101Mn(record RcVc RepSpec)	//Edit----------------------Dima 17.12.2014
begin
	record CUVc CUr;
	boolean TrHs;

	TrHs = true;

	while (LoopMain(CUr,1,TrHs)) begin
		
		if ((CUr.AccCost=="41/1") and (CUr.VEType==1)) then begin
				CUr.AccCost = "41/01";
				RecordStore(CUr,true); 
		end;
        
	end;

  return;
end;



global updating procedure RemoveVIVcInTRVcMn()	//Edit-------------------------Dima 02.03.2015
begin
	record TRVc TRr;
	boolean TrHs;	
	
	TRr.IntYc=VIYc;
	TrHs = true;
	while(loopmain(TRr,1,TrHs))begin

		if(TRr.IntYc!=VIYc)then begin TrHs = false; end;		
		
		if(TrHs)then begin	
    	RecordDelete(TRr);
    	StepBack(TRr);
		end;

	end;
	
return;
end;




global updating procedure RemoveOldTRVcRecordsMn()	//Edit-------------------------Dima 03.03.2015
begin
	record TRVc TRr;
	boolean TrHs;


	TrHs = true;
	while(loopmain(TRr,1,TrHs))begin
		
		if(blank(TRr.DSum))then begin	
    	RecordDelete(TRr);
    	StepBack(TRr);
		end;

	end;
	
return;
end;

global updating procedure UpdateTransDateInORMn()
begin
	record ORVc ORr;
	row ORVc ORrw;
	record ItemHistVc IHr;
	integer i,mtrw;
	
	
	while(loopmain(ORr,1,true))begin
		if(nonblank(ORr.PlanShip))then begin
			mtrw = matrowcnt(ORr);
			for(i=0;i<mtrw;i=i+1)begin
				matrowget(ORr,i,ORrw);
				if(nonblank(ORrw.ArtCode))then begin
					if(ORrw.Shipd2<ORrw.Quant and ORrw.Quant>0)then begin
						IHr.FileName = "Fut3ORVc";
						IHr.TransNr = ORr.SerNr;
						IHr.Row = i;
						if (ReadFirstKey("FNTransNr",IHr,3,true)==false) then begin
							UpdatePlanned(ORrw.ArtCode,ORr.Location,"Fut3ORVc",ORr.SerNr,ORr.PlanShipDate,-(ORrw.Quant-ORrw.Shipd2),i,-(ORrw.Quant-ORrw.Shipd2),ORrw.Quant*ORrw.BasePrice,true);
						end;
					end;
				end;
			end;
			/*ORr.PlanShipDate = stringtodate(ORr.PlanShip);
			ORr.PlanShip = ORr.PlanShipDate;
			mtrw = matrowcnt(ORr);
			for(i=0;i<mtrw;i=i+1)begin
				matrowget(ORr,i,ORrw);
				if(ORrw.Shipd2==ORrw.Quant)then begin
					IHr.FileName = "Fut3ORVc";
					IHr.TransNr = ORr.SerNr;
					IHr.Row = i;
					if (ReadFirstKey("FNTransNr",IHr,3,true)) then begin
						RecordDelete(IHr);
					end;
				end;
			end;
			//logtext(0,"Update OrdDate OR " & ORr.SerNr);
			recordstore(ORr,true);*/
		end;
	end;

return;
end;




global updating procedure PasteSNINMn()
begin
	record INVc INr;
	record IdINSNOneBlock IINSNOb;
	row IdINSNOneBlock IINSNOrw;
	vector val MidSNBigg;
	array string 255 astr;
	integer acnt,i,rwcnt,pos;
	string 255 strcd;
	record DIVc DIr;
	vector boolean catef;
	
	if(currentcompany==28)then begin
		INCatSClassArrayOnOpen(astr,acnt);
		
		for (i=0;i<acnt;i=i+1) begin
			catef[left(astr[i],4)] = true;
		end;
		
		
		
		INr.Code = "";
		while (LoopMain(INr,1,true)) begin
			if(nonblank(INr.Code))then begin
				if(catef[left(INr.Code,4)])then begin
					// INr.Category = left(INr.Code,4);
					// INr.SNOne = left(INr.Code,10);
					// INr.CompletCode = right(INr.Code,1);
					// INr.SN = INr.Code;
					if(StringToInt(mid(INr.Code,5,5))>MidSNBigg[INr.Category])then begin MidSNBigg[INr.Category] = StringToInt(mid(INr.Code,5,5)); end;
				end;
				// pos = 0;
				// if(nonblank(INr.DispGroups))then begin
					// ExtractObj(INr.DispGroups,pos,strcd);
					// while (nonblank(strcd)) begin
						// DIr.Code = strcd;
						// if(readfirstmain(DIr,1,true))then begin
							// if(DIr.CType=="COLOUR")then begin INr.Colour = DIr.Code; end;
							// if(DIr.CType=="MODEL")then begin INr.Reference = DIr.Code; end;	
						// end;
						// ExtractObj(INr.DispGroups,pos,strcd);
					// end;
				// end;
				//RecordStore(INr,true);
			end;
		end;
		ResetLoop(INr);
		
		BlockStore(IINSNOb);
		
		//BlockLoad(IINSNOb);
		rwcnt = matrowcnt(IINSNOb);
		for (i=0;i<acnt;i=i+1)begin
			if(MidSNBigg[left(astr[i],4)]>0)then begin
				IINSNOrw.Category = left(astr[i],4);
				IINSNOrw.SNMiddle = MidSNBigg[left(astr[i],4)];
				MatRowPut(IINSNOb,rwcnt,IINSNOrw);
				rwcnt = rwcnt + 1;
			end;
		end;
		BlockStore(IINSNOb);
	end;

return;
end;









global updating procedure TransferingCurValueBetweenFieldsMn()	//Edit-------------------------Dima 03.03.2015
begin
	record PUVc PUr;
	record POVc POr;
	record ORVc ORr;
	record IVVc IVr;
	record VIVc VIr;
	record StockMovVc	SMr;
	boolean TrHs;


	TrHs = true;
	While(LoopMain(PUr,1,TrHs)) begin
		if ((PUr.CurncyCode=="EUR") and blank(PUr.ToRateB1)) then begin
				PUr.ToRateB1 = PUr.ToRateB2;
				PUr.ToRateB2 = blankval;
				RecordStore(PUr,true);
		end;
	end;

	TrHs = true;
	While(LoopMain(POr,1,TrHs)) begin
		if ((POr.CurncyCode=="EUR") and blank(POr.ToRateB1)) then begin
				POr.ToRateB1 = POr.ToRateB2;
				POr.ToRateB2 = blankval;
				RecordStore(POr,true);
		end;
	end;

	TrHs = true;
	While(LoopMain(ORr,1,TrHs)) begin
		if ((ORr.CurncyCode=="EUR") and blank(ORr.ToRateB1)) then begin
				ORr.ToRateB1 = ORr.ToRateB2;
				ORr.ToRateB2 = blankval;
				RecordStore(ORr,true);
		end;
	end;

	TrHs = true;
	While(LoopMain(SMr,1,TrHs)) begin
		if ((SMr.CurncyCode=="EUR") and blank(SMr.ToRateB1)) then begin
				SMr.ToRateB1 = SMr.ToRateB2;
				SMr.ToRateB2 = blankval;
				RecordStore(SMr,true);
		end;
	end;

	TrHs = true;
	While(LoopMain(IVr,1,TrHs)) begin
		if ((IVr.CurncyCode=="EUR") and blank(IVr.ToRateB1)) then begin
				IVr.ToRateB1 = IVr.ToRateB2;
				IVr.ToRateB2 = blankval;
				RecordStore(IVr,true);
		end;
	end;

	TrHs = true;
	While(LoopMain(VIr,1,TrHs)) begin
		if ((VIr.CurncyCode=="EUR") and blank(VIr.ToRateB1)) then begin
				VIr.ToRateB1 = VIr.ToRateB2;
				VIr.ToRateB2 = blankval;
				RecordStore(VIr,true);
		end;
	end;

	
return;
end;

global //Edit***************************Sasha2,13:58 03.02.2015 {
updating procedure SetBrandSwarowskiMn()
begin
	record INVc INr;
	boolean TrHs;
	integer oldcompany;
	
	oldcompany = CurrentCompany;
	if (SetCompanyCode(1,false)) then begin
	   INr.Code = "";
	   TrHs = true;
	   while(loopmain(INr,1,TrHs)) begin
  		if(TrHs)then begin
  		  if (Blank(INr.DispGroups)) then begin
  		    INr.DispGroups = "SW";
  		  end else begin
  		    INr.DispGroups = "SW," & INr.DispGroups;
  		  end;	
      	RECORDSTORE(INr,true);
  		end;
	   end;
	end;
	
	ResetCompany(oldcompany);
	
return;
end; //Edit***************************Sasha2,14:51 03.02.2015 }

global updating procedure RemoveNotValidItemsFromCreativeMn()	//Edit***************************Sasha2,16:29 12.02.2015 {
begin
	record INVc INr;
	boolean TrHs;
  integer oldcompany,cnt;

	oldcompany = CurrentCompany;
	if (SetCompanyCode(9,false)) then begin
  	TrHs = true;cnt = 0;
  	INr.Code = "";
  	while(loopmain(INr,1,TrHs))begin
  		if(INr.SyncFlags<1)then begin	
      	RecordDelete(INr);
      	StepBack(INr);cnt = cnt + 1;
  		end;
  	end;
  end;
  
  ResetCompany(oldcompany);
	
return;
end; //Edit***************************Sasha2,16:29 12.02.2015 }



/*global updating procedure RevertINGroups3050Mn()	//Edit----------------------Dima  13.02.2015
begin
  record INVc INr;
	record ITVc ITr,ITr2;

	while (LoopMain(INr,1,true)) begin

			if((Right(INr.Group,2)=="3%")  or (Right(INr.Group,2) =="5%") or (Right(INr.Group,2) =="7%")) then begin

						ITr.Code = INr.Group;
						if (ReadFirstMain(ITr,1,true)) then begin
									ITr2.Comment = ITr.Comment;
									if(ReadLastKey("Comment",ITr2,1,true) and (Right(ITr2.Code,2) != "3%") and (Right(ITr2.Code,2) != "5%") and (Right(ITr2.Code,2) != "7%")) then begin

												INr.Group = ITr2.Code;
												RecordStore(INr,true);
									end;
						end;
			end;		
	end;
	
return;
end;*/

global updating procedure RevertINGroups3050Mn()	//Edit----------------------Dima  13.02.2015
begin
  record INVc INr;
	record ITVc ITr,ITr2;

	while (LoopMain(INr,1,true)) begin
		if(nonblank(INr.RebGroup)) then begin
			INr.RebGroup = "";
			RecordStore(INr,true);
		end;		
	end;
	
return;
end;


global updating procedure Change84to8401and8402TRVcMn(record RcVc RepSpec)//Edit----------------------Dima  17.02.2015
begin
	record TRVc TRr;
	row TRVc TRrw;
	boolean TrHs, store,testf;
	integer mtrw,i;
	date dateFrom;

	dateFrom = RepSpec.sStartDate;	


	TRr.IntYc=IPYc;
	TrHs = true;
	while(loopmain(TRr,1,TrHs))begin
		if(TRr.IntYc!=IPYc) then begin TrHs = false; end;
			testf = false;
			store = false;
		if (TRr.TransDate >= dateFrom) then begin testf = true; end;
		
			if(TrHs and testf) then begin	
				mtrw = matrowcnt(TRr);
				For(i=0;i<mtrw;i=i+1) begin
						matrowget(TRr,i,TRrw);	  
						if(TRrw.AccNumber=="84")then begin
							TRrw.AccNumber="84/02";
							matrowput(TRr,i,TRrw);
							store = true;
						end;
				end;
				if (store) then begin
						RecordStore(TRr,true);
				end;	 
    	
			end;
	end;

	RecordClear(TRr);
	TRr.IntYc=OPYc;
	TrHs = true;
	while(loopmain(TRr,1,TrHs))begin
		if(TRr.IntYc!=OPYc) then begin TrHs = false; end;
			testf = false;
			store = false;
		if (TRr.TransDate >= dateFrom) then begin testf = true; end;
		
		if(TrHs and testf)then begin	
			mtrw = matrowcnt(TRr);
			For(i=0;i<mtrw;i=i+1) begin
					matrowget(TRr,i,TRrw);	  
					if(TRrw.AccNumber=="84")then begin
						TRrw.AccNumber="84/01";
						matrowput(TRr,i,TRrw);
						store = true;
					end;
			end;
			if (store) then begin
					RecordStore(TRr,true);
			end;	 

		end;
	end;
	
return;
end;



global
updating procedure  CUADDCredOnACCMn(record RcVc RepSpec)	//Edit----------------------Dima 17.12.2014
begin
	record CUVc CUr;
	boolean TrHs;
	longint curtick;
	
	curtick = getcurtick();
	TrHs = true;

	while (LoopMain(CUr,1,TrHs)) begin
		
		if (CUr.VEType==1) then begin
			CUr.OnAccAccAP = "64";
			CUr.AccCost = "41/01";
			RecordStore(CUr,true); 
		end;
		if (CUr.CUType==1) then begin
			CUr.OnAccAccAP = "63";
			CUr.AccCost = "";
			RecordStore(CUr,true); 
		end;
        
	end;
	LogProcTime("CUADDCredOnACCMn",getcurtick()-curtick);
  return;
end;



global updating procedure RecalculateINVcCosts_EURMn(record RcVc RepSpec)	//Edit----------------------Dima  26.02.2015
begin
	record INVc INr;
	record BaseCurBlock BCb;
	val newCost,rate;
	string 5 cur;
	longint curtick;
	
	curtick = getcurtick();
	BlockLoad(BCb);
	cur = BCb.BaseCur1;	//default "AZN"
	CurValToOtherCur(CurrentDate,"EUR",1.0,cur,rate,DefaultCurRoundOff);    

  While(loopmain(INr,1,true))	begin
    if((INr.LastPurchCurncyCode=="EUR") and nonblank(INr.LastPurchPrice2))then begin    
			INr.InPrice = INr.LastPurchPrice2 * rate;
			recordStore(INr,true);
    end else begin
			INr.InPrice = INr.InPrice*rate;
			recordStore(INr,true);					
		end;
  end;
  LogProcTime("RecalculateINVcCosts_EURMn",getcurtick()-curtick);
return;
end;



global updating procedure AddGSVcMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record GlobalStoresVc GSr;
	record LocationVc LCr;
	integer CompQty,i,OldComp;
	
	
	CompQty = 28;
	OldComp = CurrentCompany;
	
	for (i=0;i<CompQty;i=i+1)begin
		SetCompany(i+1,false);
		ResetLoop(LCr);
		LCr.Code = "";
		while (LoopMain(LCr,1,true)) begin
			GSr.Code = LCr.Code;
			if(ReadFirstMain(GSr,1,true))then begin
				GSr.Code = LCr.Code;
				GSr.Name = LCr.Name;
				GSr.Addr01 = LCr.Addr0;
				GSr.Addr02 = LCr.Addr1;
				GSr.Addr03 = LCr.Addr2;
				GSr.Addr04 = LCr.Addr3;
				GSr.Addr05 = LCr.Addr4;
				
				//GSr.Phone = LCr.Phone;
				//GSr.Email = LCr.Email;
				GSr.Phone = LCr.Phone;//"";
				GSr.Email = LCr.Email;//"";
				//LCr.Phone = "";
				//LCr.Email = "";
				RecordStore(GSr,true);
			end else begin
				RecordNew(GSr);
				GSr.Code = LCr.Code;
				GSr.Name = LCr.Name;
				GSr.Addr01 = LCr.Addr0;
				GSr.Addr02 = LCr.Addr1;
				GSr.Addr03 = LCr.Addr2;
				GSr.Addr04 = LCr.Addr3;
				GSr.Addr05 = LCr.Addr4;
				GSr.Phone = LCr.Phone;
				GSr.Email = LCr.Email;
				RecordStore(GSr,true);
			end;
		end;
		ResetLoop(LCr);
	end;
	ResetCompany(OldComp);
  return;
end;





global updating procedure PasteRebCodeLCVCMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record CUVc CUr;
	record LoyaltyCardVc LCr,oldLCr;
	
	/*LCr.SerNr = "";
	while (loopmain(LCr,1,true)) begin
		if(nonblank(LCr.CustCode))then begin
			CUr.Code = LCr.CustCode;
			if(ReadFirstMain(CUr,1,true))then begin
				if(nonblank(CUr.RebCode) and LCr.RebCodeCRM!=CUr.RebCode)then begin
					recordcopy(oldLCr,LCr);
					LCr.RebCodeCRM = CUr.RebCode;
					RecordUpdate(oldLCr,LCr,true);
				end;
			end;
		end;
	end;
	resetloop(LCr);*/
  return;
end;

global updating procedure PasteRebCodeLCVCbyCU(record CUVc CUr) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
	record LoyaltyCardVc LCr,oldLCr;
	boolean TrHs;
	
	/*TrHs = true;//Disabled // Edit ************************** BPI Ukraine - KramarAlexandr - 03, 14 04 2021 y. at 4:31:50 PM
	LCr.CustCode = CUr.Code;
	while (loopkey("CustCode",LCr,1,TrHs)) begin
		if(nonblank(LCr.CustCode) and LCr.CustCode==CUr.Code)then begin
			if(nonblank(CUr.RebCode) and LCr.RebCodeCRM!=CUr.RebCode)then begin
				recordcopy(oldLCr,LCr);
				LCr.RebCodeCRM = CUr.RebCode;
				RecordUpdate(oldLCr,LCr,true);
			end;
		end else begin
			TrHs = false;
		end;
	end;*/
	resetloop(LCr);
  return;
end;










global webpublic updating procedure offWebPasteOldClassifINVCMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record INVc INr;
	Integer i,oldcomp;
	oldcomp = currentcompany;
	for (i=1;i<29;i=i+1)begin
		logtext(0,"WebPasteOldClassifINVCMn " & i);
		setcompany(i,false);
		INr.Code = "";
		while (loopmain(INr,1,true)) begin
			if(blank(INr.OldDispGroups))then begin
				INr.OldDispGroups = INr.DispGroups;
				RecordStore(INr,true);
			end;
			//logtext(0,INr.OldDispGroups & " <> " & i);
			//RecordStore(INr,true);
		end;
		resetloop(INr);
	end;
	ResetCompany(oldcomp);
  return;
end;





global webpublic updating procedure WebCleanStocksInGlobalItemMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record GlobalItemVc GIr,LogGIr;
	row GlobalItemVc GIrw;
	Integer i,oldcomp,pos,mtrw;
	record WEBReservStock WRSb;
	vector boolean vLoc;
	string 255 sLocSet, sLoc;
	
	oldcomp = currentcompany;
	for (i=1;i<34;i=i+1)begin
		logtext(0,"WebCleanStocksInGlobalItemMn " & i);
		setcompany(i,false);
		blockload(WRSb);
		pos = 0;
		sLocSet = WRSb.ResStockSet;
		ExtractObjWithSeparator(",",sLocSet,true,pos,sLoc);
		while (nonblank(sLoc)) begin
			vLoc[sLoc] = true;
			ExtractObjWithSeparator(",",sLocSet,true,pos,sLoc);
		end;
	end;
	ResetCompany(oldcomp);
	GIr.Code = "";
	while (LoopMain(GIr,1,true)) begin
		mtrw = matrowcnt(GIr);
		for (i=mtrw-1;i>=0;i=i-1) begin
			matrowget(GIr,i,GIrw);
			if(!vLoc[GIrw.Location]) begin
				// logtext(0,GIrw.Location & "  " & vLoc[GIrw.Location]);
				recordcopy(LogGIr,GIr);
				matrowdelete(GIr,i);
				GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 46");
				recordStore(GIr,true);
			end;
		end;
		
	end;
  return;
end;

global updating procedure CleanStocksInGlobalItemMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record GlobalItemVc GIr,LogGIr;
	row GlobalItemVc GIrw;
	Integer i,oldcomp,pos,mtrw;
	record WEBReservStock WRSb;
	vector boolean vLoc;
	string 255 sLocSet, sLoc;
	
	oldcomp = currentcompany;
	for (i=1;i<30;i=i+1)begin
		logtext(0,"CleanStocksInGlobalItemMn " & i);
		setcompany(i,false);
		blockload(WRSb);
		pos = 0;
		sLocSet = WRSb.ResStockSet;
		ExtractObjWithSeparator(",",sLocSet,true,pos,sLoc);
		while (nonblank(sLoc)) begin
			vLoc[sLoc] = true;
			ExtractObjWithSeparator(",",sLocSet,true,pos,sLoc);
		end;
	end;
	ResetCompany(oldcomp);
	GIr.Code = "";
	while (LoopMain(GIr,1,true)) begin
		mtrw = matrowcnt(GIr);
		for (i=mtrw-1;i>=0;i=i-1) begin
			matrowget(GIr,i,GIrw);
			if(!vLoc[GIrw.Location]) begin
				// logtext(0,GIrw.Location & "  " & vLoc[GIrw.Location]);
				recordcopy(LogGIr,GIr);
				matrowdelete(GIr,i);
				GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 47");
				recordStore(GIr,true);
			end;
		end;
		
	end;
  return;
end;




global webpublic updating procedure offWebRestoreeOldClassifINVCMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record INVc INr;
	Integer i,oldcomp;
	record DIVc OldDIr;
	record OldDIVc DIr;
	
	oldcomp = currentcompany;
		logtext(0,"WebPasteOldClassifINVCMn " & i);
		setcompany(13,false);
		
		DIr.Code = "";
		while (loopmain(DIr,1,true)) begin
			if(nonblank(DIr.Code))then begin
				OldDIr.Code = DIr.Code;
				if(!ReadFirstMain(OldDIr,1,true))then begin
					recordnew(OldDIr);
					OldDIr.Code = DIr.Code;
					OldDIr.Name = DIr.Name;
					OldDIr.DispGroups = DIr.DispGroups;
					OldDIr.CType = DIr.CType;
					OldDIr.colnr = DIr.colnr;
					OldDIr.CCat = DIr.CCat;
					OldDIr.Name_RU = DIr.Name_RU;
					OldDIr.Name_AZ = DIr.Name_AZ;
					OldDIr.SyncFlag = DIr.SyncFlag;
					OldDIr.TempFlag = DIr.TempFlag;
					OldDIr.SavedCount = DIr.SavedCount;
					RecordStore(OldDIr,true);
				end;
			end;
		end;
		
  return;
end;


global webpublic updating procedure WebFillWeightAndCarratMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record INVc INr;
	Integer i,oldcomp,pos;
	boolean changed;
	string 100 class,weight,carat,tstr;
	record DIVc DIr;
	vector string 50 vweight,vcarat;
	
		logtext(0,"WebFillWeightAndCarratMn");
		setcompany(3,false);
		
		/*DIr.Code = "";
		while(loopmain(DIr,1,true))begin
			if(DIr.CType=="D_CARAT")then begin
				vcarat[DIr.Code] = DIr.Name;
			end;
			if(DIr.CType=="WEIGHT")then begin
				vweight[DIr.Code] = DIr.Name;
			end;
		end;*/
		
		INr.Code = "";
		while (loopmain(INr,1,true)) begin
			changed = false;
			/*weight = "";
			carat = "";
			ExtractObj(INr.OldDispGroups,pos,tstr);
			while (NonBlank(tstr)) begin
				if(nonblank(vcarat[tstr]))then begin
					carat = vcarat[tstr];
					if(blank(INr.MajStoneDet))then begin
						INr.MajStoneDet = carat;
						changed = true;
					end;
				end;
				if(nonblank(vweight[tstr]))then begin
					weight = vweight[tstr];
					if(blank(INr.MajStoneDet))then begin
						INr.RowWeight = weight;
						changed = true;
					end;
				end;
				
				ExtractObj(INr.OldDispGroups,pos,tstr);
			end;	*/		
			
			if(nonblank(INr.RowWeight))then begin
				weight = "";
				For(i=0;i<len(INr.RowWeight);i=i+1) begin
					if(i<len(INr.RowWeight)-2)then begin
	  			if(mid(INr.RowWeight,i,2)=="WM")then begin
	  				i=i+1;
	  			end else begin
	  				weight = weight & mid(INr.RowWeight,i,1);
	  			end;
	  			end else begin
	  				weight = weight & mid(INr.RowWeight,i,1);
	  			end;
				end; 
				if(weight!=INr.RowWeight)then begin
					changed = true;
					INr.RowWeight = weight;
					// logtext(0,INr.Code & " " & INr.RowWeight & " -> " & weight);
				end;
			end;
			if(nonblank(INr.MajStoneDet))then begin
				weight = "";
				For(i=0;i<len(INr.MajStoneDet);i=i+1) begin
					if(i<len(INr.MajStoneDet)-2)then begin
	  			if(mid(INr.MajStoneDet,i,2)=="WM")then begin
	  				i=i+1;
	  			end else begin
	  				weight = weight & mid(INr.MajStoneDet,i,1);
	  			end;
	  			end else begin
	  				weight = weight & mid(INr.MajStoneDet,i,1);
	  			end;
				end; 
				if(weight!=INr.MajStoneDet)then begin
					changed = true;
					INr.MajStoneDet = weight;
					// logtext(0,INr.Code & " " & INr.MajStoneDet & " -> " & weight);
				end;
			end;
			
			/*if(left(INr.RowWeight,2)=="WM")then begin
				INr.RowWeight = right(INr.RowWeight,len(INr.RowWeight)-2);
				changed = true;
			end;
			if(left(INr.MajStoneDet,2)=="WM")then begin
				INr.MajStoneDet = right(INr.MajStoneDet,len(INr.MajStoneDet)-2);
				changed = true;
			end;*/
			
			if(changed)then begin
				// logtext(0,INr.Code & " - " & INr.MajStoneDet & " - " & INr.RowWeight);
				recordstore(INr,true);
			end;
			
		end;
		resetloop(INr);
  return;
end;


global updating procedure FillIVLocMn()
begin
record IVVc IVr;
row IVVc IVrw;
boolean TsTr,testf;
integer oldComp,i, compQty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;

BlockLoad(Compb);
	
oldComp = currentcompany;	
CompQty = matrowcnt(Compb);
	
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0)then begin
			SetCompany(i+1,false);	
			TsTr = true;
			ResetLoop(IVr);
			IVr.Location = "";
			while(LoopKey("Location",IVr,1,TsTr)) begin
				testf = true;
				If(IVr.Location!="") then begin TsTr = false; testf = false; end;
				If(IVr.ECOMMERCEOrdf!=1) then begin testf = false; end;
				if(testf) then begin
					matrowget(IVr,0,IVrw);
					if(nonblank(IVrw.Location)) then begin
						IVr.Location = IVrw.Location;
						RecordStore(IVr,true);
						StepBack(IVr);
					end else begin
						logtext(0,"row loc is blank in comp" & currentcompany & " " & IVr.SerNr);
					end;
				end;
			end;
		end;	
	end;
SetCompany(oldComp,false);
return;
end;

global updating procedure NonBlankYearCopyToBlankHighMn(record RcVc RepSpec)
begin
	record INVc INr;
	integer i, oldcompany, rwcnt;
	boolean TrHs,filter;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	string 255 tstr;
	LongInt cnt, cnt2;
	
	TrHs = true;	
	
	SetCompany(CurrentCompany,false);
	cnt = 0;
	cnt2 = 0;
	INr.Code = "";
	while (LoopMain(INr,1,TrHs)) begin
		cnt = cnt + 1;
		if(INr.Year != blankval)then begin
			if(blank(INr.High)) then begin
				tstr = ValToString(INr.Year,M4UVal,"",",",0);
				INr.High=tstr;
				RecordStore(INr,true);
				logtext(0, "UPDATED: " & INr.Code & " High: " & INr.High & " Company: " & CurrentCompany);
				cnt2 = cnt2 + 1;
			end;
		end;
	end;
	ResetLoop(INr);
	
	logtext(0, "----------------------------------");
	logtext(0, " company = " & CurrentCompany);
	logtext(0, " items = " & cnt);
	logtext(0, " updated = " & cnt2);
	logtext(0, "----------------------------------");
	MessageBox(0, "UPDATED: " & cnt2 & " rows.");
	

	/*oldcompany = CurrentCompany;
	BlockLoad(Compb);
	rwcnt = MatRowCnt(Compb); 
	for (i=0;i<rwcnt;i=i+1) begin
		SetCompany(i+1,false);
		cnt = 0;
		cnt2 = 0;
		INr.Code = "";
		while (LoopMain(INr,1,TrHs)) begin
			cnt = cnt + 1;
			if(INr.Year != blankval)then begin
				
				if(blank(INr.High)) then begin
					tstr = ValToString(INr.Year,M4UVal,"",",",0);
					INr.High=tstr;
					RecordStore(INr,true);
					logtext(0, "UPDATED: " & INr.Code & " High: " & INr.High & " Company: " & (i+1));
					cnt2 = cnt2 + 1;
				end;
			end;
		end;
		ResetLoop(INr);
		
		logtext(0, "----------------------------------");
		logtext(0, " company = " & (i+1));
		logtext(0, " items = " & cnt);
		logtext(0, " updated = " & cnt2);
		logtext(0, "----------------------------------");
		MessageBox(0, "UPDATED: " & cnt2 & " rows.");
		
	  end;
	
	ResetCompany(oldcompany);*/
	
return;
end;

global updating procedure ReFillClassificationMn(record RcVc RepSpec) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger11:06 06.05.2019
begin
  record INVc INr;
	Integer i,oldcomp,j,CompQty,pos;
	boolean TrHs, DIf;
	string 100 class,weight,carat,tstr;
	record DIVc DIr;
	vector string 50 vweight,vcarat;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	longint curtick;

		curtick = getcurtick();
		BlockLoad(Compb);
		logtext(0,"ReFillClassificationMn");
		oldcomp = CurrentCompany;
		if(RepSpec.flags[0]==1)then begin
			CompQty = MatRowCnt(Compb);
		end else begin	
			CompQty = 1;
		end;
		for (j=0;j<CompQty;j=j+1)begin
			matrowget(Compb,j,Comprw);
			if((Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(j+1) or j+1==3) and j+1!=10) or RepSpec.flags[0]==0)then begin
				if(RepSpec.flags[0]==1)then begin
					SetCompany(j+1,false);
				end;
				INr.Code = "";
				TrHs = true;
				while (loopmain(INr,1,TrHs)) begin
					// logtext(0,"IN code" & INr.Code);
					if (INr.BPIMaterial==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="MATERIAL")then begin
										INr.BPIMaterial = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIMaterial = "";
							end;
						end else begin
							INr.BPIMaterial = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIColor==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="COLOUR")then begin
										INr.BPIColor = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIColor = "";
							end;
						end else begin
							INr.BPIColor = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIShape==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="SHAPE")then begin
										INr.BPIShape = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIShape = "";
							end;
						end else begin
							INr.BPIShape = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPISize==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="SIZE")then begin
										INr.BPISize = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPISize = "";
							end;
						end else begin
							INr.BPISize = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIUse==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="USE")then begin
										INr.BPIUse = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIUse = "";
							end;
						end else begin
							INr.BPIUse = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPISex==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="SEX")then begin
										INr.BPISex = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPISex = "";
							end;
						end else begin
							INr.BPISex = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIPlating==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="PLATING")then begin
										INr.BPIPlating = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIPlating = "";
							end;
						end else begin
							INr.BPIPlating = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIClarity==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="CLARITY")then begin
										INr.BPIClarity = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIClarity = "";
							end;
						end else begin
							INr.BPIClarity = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIWeight==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="WEIGHT")then begin
										INr.BPIWeight = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIWeight = "";
							end;
						end else begin
							INr.BPIWeight = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPICut==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="CUT")then begin
										INr.BPICut = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPICut = "";
							end;
						end else begin
							INr.BPICut = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIStone==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="STONE")then begin
										INr.BPIStone = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIStone = "";
							end;
						end else begin
							INr.BPIStone = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIStrap==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="STRAP")then begin
										INr.BPIStrap = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIStrap = "";
							end;
						end else begin
							INr.BPIStrap = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
					if (INr.BPIOdour==RepSpec.f1) then begin
						if(blank(RepSpec.f2))then begin
							pos = 0;
							class = "";
							DIf = false;
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								if(readfirstmain(DIr,1,true))then begin
									if(DIr.CType=="ODOUR")then begin
										INr.BPIOdour = class;
										DIf = true;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
							if(!DIf)then begin
								INr.BPIOdour = "";
							end;
						end else begin
							INr.BPIOdour = RepSpec.f2;
						end;
						RecordStore(INr,true);
					end;
				end;
				ResetLoop(INr);
			end;
		end;
		ResetCompany(oldComp);
		LogProcTime("ReFillClassificationMn",getcurtick()-curtick);
  return;
end;








global webpublic updating procedure offWebCloneOldDIVcfrDIVcMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record  DIVc DIr;
	record  OldDIVc OldDIr;
	Integer i,oldcomp;
	boolean JWLikef,compf;
	oldcomp = currentcompany;
	JWLikef = true;
	for (i=1;i<29;i=i+1)begin
		setcompany(i,false);
		/*compf = false;
		if(CompanyIsJWLikeCompany(currentcompany))then begin
			if(JWLikef)then begin
				setcompany(i,false);
				compf = true;
				JWLikef = false;
			end;
		end else begin
			setcompany(i,false);
			compf = true;
		end;
		if(compf)then begin*/
			DIr.Code = "";
			while (loopmain(DIr,1,true)) begin
				if(nonblank(DIr.Code))then begin
					OldDIr.Code = DIr.Code;
					if(!ReadFirstMain(OldDIr,1,true))then begin
						OldDIr.Code = DIr.Code;
						OldDIr.Name = DIr.Name;
						OldDIr.DispGroups = DIr.DispGroups;
						OldDIr.CType = DIr.CType;
						OldDIr.colnr = DIr.colnr;
						OldDIr.CCat = DIr.CCat;
						OldDIr.Name_RU = DIr.Name_RU;
						OldDIr.Name_AZ = DIr.Name_AZ;
						OldDIr.SyncFlag = DIr.SyncFlag;
						OldDIr.TempFlag = DIr.TempFlag;
						OldDIr.SavedCount = DIr.SavedCount;
						RecordStore(OldDIr,true);
					end;
				end;
			end;
			resetloop(DIr);
		//end;
	end;
	ResetCompany(oldcomp);
  return;
end;


global webpublic updating procedure WebDeleetDIVcMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record  DIVc DIr;
	Integer i,oldcomp;
	boolean JWLikef,compf;
	oldcomp = currentcompany;
	JWLikef = true;
	for (i=1;i<29;i=i+1)begin
		if(i!=9 and i!=10 and i!=28)then begin
			setcompany(i,false);
			DIr.Code = "";
			while (loopmain(DIr,1,true)) begin
				recorddelete(DIr);
				stepback(DIr);
			end;		
		end;	
	end;
	ResetCompany(oldcomp);
  return;
end;


global
Procedure AddToSet(var string res,string addstr)
begin

	if(nonblank(res))then begin
		if(nonblank(addstr))then begin
			res = res & "," & addstr;
		end;
	end else begin
		res = addstr;
	end;

return;
end;


global updating procedure GlobalItemVcfFrDIMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger10:31 21.08.2018
begin
  record GlobalItemVc GIr,mainGIr,LogGIr;
	row GlobalItemVc GIrw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	integer CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	row INVc INrw;

	while(loopmain(GIr,1,true))begin
		recorddelete(GIr);
		stepback(GIr);
	end;
	
	
	CompQty = 29;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	
	
	
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i+1,Comprw);
		if(Comprw.ActiveStatus==0)then begin
			SetCompany(i+1,false);
			
			blockload(WRSb);
			aloccnt = 0;
			LCr.Code = "";
			while (LoopMain(LCr,1,true)) begin
				aloc[aloccnt] = LCr.Code;
				aloccnt = aloccnt + 1;
			end;
			resetloop(LCr);
			
			TrHs = true;
			if(CompanyIsJWLikeCompany(CurrentCompany) and CurrentCompany!=3)then begin TrHs = false; end;
			if(TrHs)then begin
				DIr.CType = "BRAND";
				TrHs1 = true;
				While(loopkey("CType",DIr,1,TrHs1))begin
					if(DIr.CType!="BRAND")then begin TrHs1 = false; end;
					if(TrHs1)then begin
						if(vbrandcode[DIr.Code]==false)then begin	
							vbrandcode[DIr.Code] = true;
							vbrandname[DIr.Code] = DIr.Code;
						end;
					end;
				end;
				resetloop(DIr);
			end;
			
			ResetLoop(INr);
			INr.Code = "";
			while(loopmain(INr,1,TrHs)) begin
				if(blank(INr.MainCode)) then begin
					if(nonblank(INr.BPIBrand)) then begin
						ISr.Code = INr.Code;
						ISr.Location = ";;;";
						testf = false;
						if(ReadFirstMain(ISr,2,true))then begin end;
						if(ISr.Instock>0)then begin testf = true; end;

						if(testf)then begin
							class = "";
							pos = 0;
							BrandName = "";
							BrandCode = "";
							if(false)then begin
								ExtractObj(INr.DispGroups,pos,class);
								while(nonblank(class))begin
									if(nonblank(class))then begin
										if(vbrandcode[class])then begin
											BrandName = vbrandname[class];
											BrandCode = class;
										end;
										DIr.Code = class;
										if(readfirstmain(DIr,1,true))then begin
											if(DIr.CType=="BRAND")then begin
												BrandName = DIr.Name;
												BrandCode = DIr.Code;
											end;
										end;
									end;
									ExtractObj(INr.DispGroups,pos,class);
								end;
							end;
							if(nonblank(INr.BPIBrand))then begin
								BPIBr.Code = INr.BPIBrand;
								readfirstmain(BPIBr,1,true);
								BrandName = BPIBr.Name;
								BrandCode = BPIBr.Code;
							end;
							CurCode = "AZN";
							
							GetFullCurncyRate(CurCode,CurrentDate,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2);
							quant = 1;
							recordcopy(oldINr,INr);
							//if (GetItemPriceDiscount3(oldINr.Code,quant,oldINr,CurCode,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,"","","RRP","0%",price,curitemname,ITRebate,vatcode,baseprice,salesacc,exportflag,calcprice,currentdate,currenttime,"NONAME",true,dummyf,"",tax2code,tax2prc,"","",taxtemplatecode)) then begin
							GetPriceItem(INr.Code,price,ITRebate);
							//end;
							
							GIr.Code = INr.BPIBrand & "_" & INr.Code;
							
							//logtext(0,GIr.Code);
							if(ReadFirstMain(GIr,1,true))then begin
								recordcopy(LogGIr,GIr);
								GIr.MainItemFlag = 0;
								GIr.IsVariant = 0;
								INr.GlobalArtCode = GIr.Code;
								RecordStore(INr,true);
								/*if(nonblank(INr.MainCode)) then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 06, 02 05 2020 y. at 9:31:53 PM
									INr.Code = INr.MainCode;
									if(readFirstMain(INr,1,true))then begin
										mainGIr.Code = INr.BPIBrand & "_" & INr.Code;
										if(readfirstmain(mainGIr,1,true))then begin
											mainGIr.IsVariant = 1;
											recordstore(mainGIr,true);
											GIr.IsVariant = 1;
											GIr.MainCode = mainGIr.Code;
											GIr.MainItemFlag = 1;
										end;
									end;
								end;*/
								/*GIr.HansaCode = INr.Code;
								GIr.HansaName = INr.Name;
								GIr.Brand = BrandName;
								GIr.Classification = INr.DispGroups;
								GIr.Price = price;
								GIr.Rebate = ITRebate;
								GIr.ConsgType = INr.ConsgType;*/
								For(li=0;li<aloccnt;li=li+1) begin
									if(setinset(aloc[li],WRSb.ResStockSet))then begin
										ISr.Code = INr.Code;
										ISr.Location = aloc[li];
										if(ReadFirstMain(ISr,2,true))then begin
											GIrw.Location = ISr.Location;
											TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 58");
											GIrw.Instock = ISr.Instock - ISr.RsrvQty;
											GIrw.Code = GIr.Code;
											if(GIrw.Instock<0) then begin GIrw.Instock = 0; end;
											//if(ISr.RsrvQty>0)then begin logtext(0,ISr.Code & "<>" & ISr.RsrvQty); end;
											MatRowGet(GIr,matrowcnt(GIr),GIrw);
											if(blank(GIrw.Location))then begin
												MatRowPut(GIr,matrowcnt(GIr),GIrw);
											end;
										end;
									end;
								end;
								GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 48");
								RecordStore(GIr,true);
								CheckFlush(flushcnt,100);
								flcnt = flcnt + 1;
								if(flcnt>1000)then begin
									flcnt = 0;
									//logtext(0,"Update " & INr.Code);
								end;
							end else begin
								RecordNew(GIr);
								recordcopy(LogGIr,GIr);
								GIr.MainItemFlag = 0;
								GIr.IsVariant = 0;
								GIr.Code = INr.BPIBrand & "_" & INr.Code;
									INr.GlobalArtCode = GIr.Code;
									RecordStore(INr,true);
									/*if(nonblank(INr.MainCode)) then begin//Disabled// Edit ************************** BPI Ukraine - KramarAlexandr - 06, 02 05 2020 y. at 9:31:30 PM
										INr.Code = INr.MainCode;
										if(readFirstMain(INr,1,true))then begin
											mainGIr.Code = INr.BPIBrand & "_" & INr.Code;
											if(readfirstmain(mainGIr,1,true))then begin
												mainGIr.IsVariant = 1;
												recordstore(mainGIr,true);
												GIr.IsVariant = 1;
												GIr.MainCode = mainGIr.Code;
												GIr.MainItemFlag = 1;
											end;
										end;
									end;*/
								GIr.HansaCode = INr.Code;
								GIr.HansaName = INr.Name;
								GIr.Brand = BrandName;
								//GIr.Classification = INr.DispGroups;
								
								
								AddToSet(GIr.Classification,INr.BPIBrand);
								AddToSet(GIr.Classification,INr.BPICollection);
								AddToSet(GIr.Classification,INr.BPIGroup);
								AddToSet(GIr.Classification,INr.BPISubGroup);
								AddToSet(GIr.Classification,INr.BPICategory);
								AddToSet(GIr.Classification,INr.BPIMaterial);
								AddToSet(GIr.Classification,INr.BPIColor);
								AddToSet(GIr.Classification,INr.BPIShape);
								AddToSet(GIr.Classification,INr.BPISize);
								AddToSet(GIr.Classification,INr.BPIUse);
								AddToSet(GIr.Classification,INr.BPISex);
								AddToSet(GIr.Classification,INr.BPIPlating);
								AddToSet(GIr.Classification,INr.BPIClarity);
								AddToSet(GIr.Classification,INr.BPIWeight);
								AddToSet(GIr.Classification,INr.BPICut);
								AddToSet(GIr.Classification,INr.BPIStone);
								AddToSet(GIr.Classification,INr.BPIStrap);
								AddToSet(GIr.Classification,INr.BPIOdour);
								
								GIr.BPIBrand = INr.BPIBrand;
								GIr.BPICollection = INr.BPICollection;
								GIr.BPIGroup = INr.BPIGroup;
								GIr.BPISubGroup = INr.BPISubGroup;
								GIr.BPICategory = INr.BPICategory;
								GIr.BPIMaterial = INr.BPIMaterial;
								GIr.BPIColor = INr.BPIColor;
								GIr.BPIShape = INr.BPIShape;
								GIr.BPISize = INr.BPISize;
								GIr.BPIUse = INr.BPIUse;
								GIr.BPISex = INr.BPISex;
								GIr.BPIPlating = INr.BPIPlating;
								GIr.BPIClarity = INr.BPIClarity;
								GIr.BPIWeight = INr.BPIWeight;
								GIr.BPICut = INr.BPICut;
								GIr.BPIStone = INr.BPIStone;
								GIr.BPIStrap = INr.BPIStrap;
								GIr.BPIOdour = INr.BPIOdour;
								GIr.BTRxGiftClass = INr.BTRxGiftClass;
								GIr.BTRxInterCatClass = INr.BTRxInterCatClass;
								GIr.BTRxFirstLevCat = INr.BTRxFirstLevCat;
								GIr.BTRxSecondLevCat = INr.BTRxSecondLevCat;
								GIr.BTRxThirdLevCat = INr.BTRxThirdLevCat;
								GIr.AlternativeCode = INr.AlternativeCode;
								GIr.Cert = INr.Cert;
								GIr.BTRxWatchMechanism = INr.BTRxWatchMechanism;
								GIr.BTRxPowerReserve = INr.BTRxPowerReserve;
								GIr.BPIStrap = INr.BPIStrap;
								GIr.BTRxStrapColour = INr.BTRxStrapColour;
								GIr.BTRxPlacerScatt = INr.BTRxPlacerScatt;
								GIr.BTRxPhoneModel = INr.BTRxPhoneModel;
								GIr.BTRxFilling = INr.BTRxFilling;
								GIr.Depth = INr.Depth;
								GIr.Width = INr.Width;
								GIr.Height = INr.Height;
								GIr.BTRxDiam = INr.BTRxDiam;
								GIr.Volume = INr.Volume;
								GIr.Weight = INr.Weight;
								GIr.BTRxProdColour = INr.BTRxProdColour;
								GIr.BTRxChainMaterial = INr.BTRxChainMaterial;
								GIr.BTRxWatchGradeA = INr.BTRxWatchGradeA;
								GIr.BTRxWatchGradeB = INr.BTRxWatchGradeB;
								GIr.BTRxWatchGradeC = INr.BTRxWatchGradeC;
								GIr.BTRxStoneA = INr.BTRxStoneA;
								GIr.BTRxStoneScattA = INr.BTRxStoneScattA;
								GIr.BTRxStoneB = INr.BTRxStoneB;
								GIr.BTRxStoneScattB = INr.BTRxStoneScattB;
								GIr.BTRxStoneC = INr.BTRxStoneC;
								GIr.BTRxStoneScattC = INr.BTRxStoneScattC;
								GIr.BTRxLimitedGood = INr.BTRxLimitedGood;
								
								logtext(0,"GlobalItemVcfFrDIMn :  Code -" & GIr.Code & " Global item price = " & price);
								GIr.Price = price;
								GIr.Rebate = ITRebate;
								GIr.ConsgType = INr.ConsgType;
								
								For(li=0;li<aloccnt;li=li+1) begin
									ISr.Code = INr.Code;
									ISr.Location = aloc[li];
									if(ReadFirstMain(ISr,2,true))then begin
										GIrw.Location = ISr.Location;
										TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 59");
										GIrw.Instock = ISr.Instock - ISr.RsrvQty;
										GIrw.Code = GIr.Code;
										if(GIrw.Instock<0) then begin GIrw.Instock = 0; end;
										//if(ISr.RsrvQty>0)then begin logtext(0,ISr.Code & "<>" & ISr.RsrvQty); end;
										MatRowPut(GIr,matrowcnt(GIr),GIrw);
									end;
								end;
								GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 49");
								RecordStore(GIr,true);
								CheckFlush(flushcnt,100);
								flcnt = flcnt + 1;
								if(flcnt>1000)then begin
									flcnt = 0;
									//logtext(0,"Store " & INr.Code);
								end;
							end;
						end;	
					end else begin if(nonblank(INr.BPIGroup)) then begin
						//logtext(0, CurrentCompany & "  " & INr.Code);
						end;
					end;	
				end;
			end;
			ResetLoop(INr);
			INr.Code = "";
			while(loopmain(INr,1,TrHs)) begin
			if(nonblank(INr.MainCode)) then begin
				if(nonblank(INr.BPIBrand)) then begin
					ISr.Code = INr.Code;
					ISr.Location = ";;;";
					testf = false;
					if(ReadFirstMain(ISr,2,true))then begin end;
					if(ISr.Instock>0)then begin testf = true; end;

					if(testf)then begin
						class = "";
						pos = 0;
						BrandName = "";
						BrandCode = "";
						if(false)then begin
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								if(nonblank(class))then begin
									if(vbrandcode[class])then begin
										BrandName = vbrandname[class];
										BrandCode = class;
									end;
									DIr.Code = class;
									if(readfirstmain(DIr,1,true))then begin
										if(DIr.CType=="BRAND")then begin
											BrandName = DIr.Name;
											BrandCode = DIr.Code;
										end;
									end;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
						end;
						if(nonblank(INr.BPIBrand))then begin
							BPIBr.Code = INr.BPIBrand;
							readfirstmain(BPIBr,1,true);
							BrandName = BPIBr.Name;
							BrandCode = BPIBr.Code;
						end;
						CurCode = "AZN";
						
						GetFullCurncyRate(CurCode,CurrentDate,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2);
						quant = 1;
						recordcopy(oldINr,INr);
						//if (GetItemPriceDiscount3(oldINr.Code,quant,oldINr,CurCode,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,"","","RRP","0%",price,curitemname,ITRebate,vatcode,baseprice,salesacc,exportflag,calcprice,currentdate,currenttime,"NONAME",true,dummyf,"",tax2code,tax2prc,"","",taxtemplatecode)) then begin
						GetPriceItem(INr.Code,price,ITRebate);
						//end;
						
						GIr.Code = INr.BPIBrand & "_" & INr.Code;
						if(ReadFirstMain(GIr,1,true))then begin
							recordcopy(LogGIr,GIr);
							GIr.MainItemFlag = 0;
							GIr.IsVariant = 0;
							INr.GlobalArtCode = GIr.Code;
							RecordStore(INr,true);
							/*if(nonblank(INr.MainCode)) then begin//Disabled//// Edit ************************** BPI Ukraine - KramarAlexandr - 06, 02 05 2020 y. at 9:31:05 PM
								INr.Code = INr.MainCode;
								if(readFirstMain(INr,1,true))then begin
									mainGIr.Code = INr.BPIBrand & "_" & INr.Code;
									if(readfirstmain(mainGIr,1,true))then begin
										mainGIr.IsVariant = 1;
										recordstore(mainGIr,true);
										GIr.IsVariant = 1;
										GIr.MainCode = mainGIr.Code;
										GIr.MainItemFlag = 1;
									end;
								end;
							end;*/
							For(li=0;li<aloccnt;li=li+1) begin
								if(setinset(aloc[li],WRSb.ResStockSet))then begin
									ISr.Code = INr.Code;
									ISr.Location = aloc[li];
									if(ReadFirstMain(ISr,2,true))then begin
										GIrw.Location = ISr.Location;
										TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 60");
										GIrw.Instock = ISr.Instock - ISr.RsrvQty;
										if(GIrw.Instock<0) then begin GIrw.Instock = 0; end;
										GIrw.Code = GIr.Code;
										//if(ISr.RsrvQty>0)then begin logtext(0,ISr.Code & "<>" & ISr.RsrvQty); end;
										MatRowPut(GIr,matrowcnt(GIr),GIrw);
									end;
								end;
							end; 
							GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 50");
							RecordStore(GIr,true);
							CheckFlush(flushcnt,100);
							flcnt = flcnt + 1;
							if(flcnt>1000)then begin
								flcnt = 0;
								//logtext(0,"Update " & INr.Code);
							end;
						end else begin
							RecordNew(GIr);
							recordcopy(LogGIr,GIr);
							GIr.MainItemFlag = 0;
							GIr.IsVariant = 0;
							GIr.Code = INr.BPIBrand & "_" & INr.Code;
								INr.GlobalArtCode = GIr.Code;
								RecordStore(INr,true);
								/*if(nonblank(INr.MainCode)) then begin//Disabled // Edit ************************** BPI Ukraine - KramarAlexandr - 06, 02 05 2020 y. at 9:30:41 PM
									INr.Code = INr.MainCode;
									if(readFirstMain(INr,1,true))then begin
										mainGIr.Code = INr.BPIBrand & "_" & INr.Code;
										if(readfirstmain(mainGIr,1,true))then begin
											mainGIr.IsVariant = 1;
											recordstore(mainGIr,true);
											GIr.IsVariant = 1;
											GIr.MainCode = mainGIr.Code;
											GIr.MainItemFlag = 1;
										end;
									end;
								end;*/
							GIr.BTRxGiftClass = INr.BTRxGiftClass;
							GIr.HansaCode = INr.Code;
							GIr.HansaName = INr.Name;
							for(j=0;j<matrowcnt(INr);j=j+1) begin
								matrowget(INr,j,INrw);
								if(INrw.LangCode=="RUS") then begin
									GIr.NameRUS = INrw.Text;
								end;
								if(INrw.LangCode=="AZ") then begin
									GIr.NameAZ = INrw.Text;
								end;
							end;
							GIr.Brand = BrandName;
							//GIr.Classification = INr.DispGroups;
							
							
							AddToSet(GIr.Classification,INr.BPIBrand);
							AddToSet(GIr.Classification,INr.BPICollection);
							AddToSet(GIr.Classification,INr.BPIGroup);
							AddToSet(GIr.Classification,INr.BPISubGroup);
							AddToSet(GIr.Classification,INr.BPICategory);
							AddToSet(GIr.Classification,INr.BPIMaterial);
							AddToSet(GIr.Classification,INr.BPIColor);
							AddToSet(GIr.Classification,INr.BPIShape);
							AddToSet(GIr.Classification,INr.BPISize);
							AddToSet(GIr.Classification,INr.BPIUse);
							AddToSet(GIr.Classification,INr.BPISex);
							AddToSet(GIr.Classification,INr.BPIPlating);
							AddToSet(GIr.Classification,INr.BPIClarity);
							AddToSet(GIr.Classification,INr.BPIWeight);
							AddToSet(GIr.Classification,INr.BPICut);
							AddToSet(GIr.Classification,INr.BPIStone);
							AddToSet(GIr.Classification,INr.BPIStrap);
							AddToSet(GIr.Classification,INr.BPIOdour);
							
							GIr.BPIBrand = INr.BPIBrand;
							GIr.BPICollection = INr.BPICollection;
							GIr.BPIGroup = INr.BPIGroup;
							GIr.BPISubGroup = INr.BPISubGroup;
							GIr.BPICategory = INr.BPICategory;
							GIr.BPIMaterial = INr.BPIMaterial;
							GIr.BPIColor = INr.BPIColor;
							GIr.BPIShape = INr.BPIShape;
							GIr.BPISize = INr.BPISize;
							GIr.BPIUse = INr.BPIUse;
							GIr.BPISex = INr.BPISex;
							GIr.BPIPlating = INr.BPIPlating;
							GIr.BPIClarity = INr.BPIClarity;
							GIr.BPIWeight = INr.BPIWeight;
							GIr.BPICut = INr.BPICut;
							GIr.BPIStone = INr.BPIStone;
							GIr.BPIStrap = INr.BPIStrap;
							GIr.BPIOdour = INr.BPIOdour;
							GIr.BTRxGiftClass = INr.BTRxGiftClass;
							GIr.BTRxInterCatClass = INr.BTRxInterCatClass;
							GIr.BTRxFirstLevCat = INr.BTRxFirstLevCat;
							GIr.BTRxSecondLevCat = INr.BTRxSecondLevCat;
							GIr.BTRxThirdLevCat = INr.BTRxThirdLevCat;
							GIr.AlternativeCode = INr.AlternativeCode;
							GIr.Cert = INr.Cert;
							GIr.BTRxWatchMechanism = INr.BTRxWatchMechanism;
							GIr.BTRxPowerReserve = INr.BTRxPowerReserve;
							GIr.BPIStrap = INr.BPIStrap;
							GIr.BTRxStrapColour = INr.BTRxStrapColour;
							GIr.BTRxPlacerScatt = INr.BTRxPlacerScatt;
							GIr.BTRxPhoneModel = INr.BTRxPhoneModel;
							GIr.BTRxFilling = INr.BTRxFilling;
							GIr.Depth = INr.Depth;
							GIr.Width = INr.Width;
							GIr.Height = INr.Height;
							GIr.BTRxDiam = INr.BTRxDiam;
							GIr.Volume = INr.Volume;
							GIr.Weight = INr.Weight;
							GIr.BTRxProdColour = INr.BTRxProdColour;
							GIr.BTRxChainMaterial = INr.BTRxChainMaterial;
							GIr.BTRxWatchGradeA = INr.BTRxWatchGradeA;
							GIr.BTRxWatchGradeB = INr.BTRxWatchGradeB;
							GIr.BTRxWatchGradeC = INr.BTRxWatchGradeC;
							GIr.BTRxStoneA = INr.BTRxStoneA;
							GIr.BTRxStoneScattA = INr.BTRxStoneScattA;
							GIr.BTRxStoneB = INr.BTRxStoneB;
							GIr.BTRxStoneScattB = INr.BTRxStoneScattB;
							GIr.BTRxStoneC = INr.BTRxStoneC;
							GIr.BTRxStoneScattC = INr.BTRxStoneScattC;
							GIr.BTRxLimitedGood = INr.BTRxLimitedGood;

							
							logtext(0,"GlobalItemVcfFrDIMn Code: " & GIr.Code & " Global item price = " & price);
							GIr.Price = price;
							GIr.Rebate = ITRebate;
							GIr.ConsgType = INr.ConsgType;
							
							For(li=0;li<aloccnt;li=li+1) begin
								ISr.Code = INr.Code;
								ISr.Location = aloc[li];
								if(ReadFirstMain(ISr,2,true))then begin
									GIrw.Location = ISr.Location;
									TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 61");
									GIrw.Instock = ISr.Instock - ISr.RsrvQty;
									GIrw.Code = GIr.Code;
									if(GIrw.Instock<0) then begin GIrw.Instock = 0; end;
									//if(ISr.RsrvQty>0)then begin logtext(0,ISr.Code & "<>" & ISr.RsrvQty); end;
									MatRowGet(GIr,matrowcnt(GIr),GIrw);
									if(blank(GIrw.Location))then begin
										MatRowPut(GIr,matrowcnt(GIr),GIrw);
									end;
								end;
							end; 
							GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 51");
							RecordStore(GIr,true);
							CheckFlush(flushcnt,100);
							flcnt = flcnt + 1;
							if(flcnt>1000)then begin
								flcnt = 0;
								//logtext(0,"Store " & INr.Code);
							end;
						end;
					end;	
				end else begin if(nonblank(INr.BPIGroup)) then begin
					//logtext(0, CurrentCompany & "  " & INr.Code);
					end;
				end;	
			end;
			end;
			ResetLoop(INr);
		end;
	end;
	ResetCompany(OldComp);
  return;
end;



global updating procedure QResetMinusResItemStat(record ItemStatusVc ISr)
begin
	ISr.RsrvQty = 0;
	recordstore(ISr,true);
	// logtext(0,"Company > " & CurrentCompany & " Item > " ISr.Code);
return;
end;



global webpublic procedure WebResetMinusResQtyMn()
begin
	record ItemStatusVc ISr;
	integer CompQty;
	longint i;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;

	blockload(Compb);
	 
	CompQty = 34;
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and i+1!=29 and i+1!=18)then begin
			if (SetCompany(i+1,false)) then begin
				ISr.Code = "";
				while (loopMain(ISr,1,true)) begin
					if (ISr.RsrvQty<0) then begin
						queued.QResetMinusResItemStat(ISr);
						MilliSleep(30);
					end;
				end;
				resetLoop(ISr);
			end;
		end;
	end;
	
	
	
	
return;
end;


global updating procedure GlobalItemVcRecStPrMn(record RcVc RepSpec) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger10:31 21.08.2018
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname;
	vector val vlocinst,vpricereb;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	i=0;
	IDr.OrigCode = "";
	while (loopMain(IDr,1,true)) begin
		if (!OrigCodes[IDr.OrigBrandCode & "_" & IDr.OrigCode]) then begin
			OrigCodes[IDr.OrigBrandCode & "_" & IDr.OrigCode] = true;
			OrigBrandCodes[IDr.OrigBrandCode & "_" & IDr.OrigCode] = IDr.OrigBrandCode;
			aOrigGlobalCodes[i] = IDr.OrigBrandCode & "_" & IDr.OrigCode;
			i=i+1;
		end;
	end;
	ResetLoop(IDr);
	OrGCcnt = i;
	
	
	TrHs1=true;
	if(nonblank(RepSpec.f1)) then begin
		GIr.Code = RepSpec.f1;
		logtext(0,GIr.Code);
	end else begin
		GIr.Code = "";
	end;
	// logtext(0,"GlobalItemVcRecStPrMn " & GIr.Code);
	addtexttoarea("{\"items\":\{" & chr(13) & chr(10),fillitems);
	isfirst = false;
	while (loopmain(GIr,1,TrHs1)) begin
		testf = true;
		if(nonblank(RepSpec.f1) and GIr.Code!=RepSpec.f1)then begin TrHs1 = false; testf = false; end;
		if(OrigCodes[GIr.Code]) then begin testf = false; end;
		if(testf)then begin
			
			ClearVector(vcomp);
			ClearVector(vloc);
			ClearVector(vlocinst);
			updateGIrAuto(GIr,vpricereb);
			recordcopy(OldGir,GIr);
			for (j=matrowcnt(GIr)-1;j>=0;j=j-1) begin
				matrowdelete(GIr,j);
			end;
			for (i=0;i<CompQty;i=i+1)begin
				matrowget(Compb,i,Comprw);
				if(Comprw.ActiveStatus==0 and i+1!=29)then begin
					
					entf = false;
					SetCompany(i+1,false);

					INr.Code = GIr.HansaCode;
					if (ReadFirstMain(INr,1,true)) then begin
						if (left(GIr.Code,8)==INr.BPIBrand) then begin
							blockload(WRSb);
							aloccnt = 0;
							LCr.Code = "";
							while (LoopMain(LCr,1,true)) begin
								aloc[aloccnt] = LCr.Code;
								vlocname[LCr.Code] = LCr.Name;	//Edit **********************************************Vas-P	10/08/2021
								aloccnt = aloccnt + 1;
							end;
							resetloop(LCr);
							
							TrHs = true;
							
							for(li=0;li<aloccnt;li=li+1) begin
								locfnd = false;
								if(setinset(aloc[li],WRSb.ResStockSet))then begin
									ISr.Code = GIr.HansaCode;
									ISr.Location = aloc[li];
									for(j=0;j<matrowcnt(GIr);j=j+1) begin
										MatRowGet(GIr,j,GIrw);
										if(GIrw.Location==ISr.Location) then begin
											locfnd = true;
											if(ReadFirstMain(ISr,2,true))then begin
												if(GIrw.Instock!=(ISr.Instock-ISr.RsrvQty) or CurrentCompany==1)then begin
													// logtext(0,ISr.Code & "<> Old" & GIrw.Instock & "<> New" & (ISr.Instock - ISr.RsrvQty));
													TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 62");
													GIrw.Instock = ISr.Instock - ISr.RsrvQty;
													GIrw.Code = GIr.Code;
													if(GIrw.Instock<0) then begin GIrw.Instock = 0; end;
													// if (CurrentCompany==1 and GIrw.Instock==1) then begin
														// GIrw.Instock = 0;
													// end;
													MatRowPut(GIr,j,GIrw);
													vcomp[i+1] = Comprw.CompName;	//Edit **********************************************Vas-P	10/08/2021
													vloc[GIrw.Location] = i+1;	//Edit **********************************************Vas-P	10/08/2021
													vlocinst[GIrw.Location] = GIrw.Instock;	//Edit **********************************************Vas-P	10/08/2021
													entf = true;
												end;
											end;	
										end;
									end;
									if(locfnd==false)then begin
										GIrw.Location = aloc[li];
										if(ReadFirstMain(ISr,2,true))then begin
										  for(k=0;k<matrowcnt(OldGir);k=k+1)begin
                        matrowget(OldGir,k,OldGirw);
                        if(OldGirw.Location==GIrw.Location)then begin
                          GIrw.Instock = OldGirw.Instock;
                          GIrw.CurrentDate = OldGirw.CurrentDate;
                          GIrw.CurrentTime = OldGirw.CurrentTime;
                          GIrw.TimeStamp = OldGirw.TimeStamp;
                        end;
                      end;
                      TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 621");
											GIrw.Instock = ISr.Instock - ISr.RsrvQty;
											GIrw.Code = GIr.Code;
											// if (CurrentCompany==1 and GIrw.Instock==1) then begin
												// GIrw.Instock = 0;
											// end;
											entf = true;
											MatRowPut(GIr,matrowcnt(GIr),GIrw);
											vcomp[i+1] = Comprw.CompName;	//Edit **********************************************Vas-P	10/08/2021
											vloc[GIrw.Location] = i+1;	//Edit **********************************************Vas-P	10/08/2021
											vlocinst[GIrw.Location] = GIrw.Instock;	//Edit **********************************************Vas-P	10/08/2021
										end;
									end;	
								end; 
							end;	
							if(entf)then begin
								GIWasUpdated(GIr,OldGir," GIWasUpdatedlog 52");
								RecordStore(GIr,true);
								// logtext(0,GIr.Code);
							end;
						end;
					end;
				end;
			end;
			//Edit **********************************************Vas-P	10/08/2021

			if(matrowcnt(GIr)>0)then begin
				GetVectorTags(vcomp,acomp);
				GetVectorTags(vloc,alocation);
				
				if(isfirst)then begin
					addtexttoarea("," & chr(13) & chr(10),fillitems);
				end;
				isfirst = true;
				
				addtexttoarea("\"" & GIr.Code & "\":{" & chr(13) & chr(10),fillitems);
				addtexttoarea("\"productName\":\"" & GIr.HansaName & "\"," & chr(13) & chr(10),fillitems);
				addtexttoarea("\"company\":\[{" & chr(13) & chr(10),fillitems);
				isfirst2 = false;
				for(i=0;i<acomp.length;i=i+1)begin
					if(isfirst2)then begin
						addtexttoarea("," & chr(13) & chr(10),fillitems);
					end;
					isfirst2 = true;
					addtexttoarea("\"" & vcomp[acomp[i]] & "\":{" & chr(13) & chr(10),fillitems);
					addtexttoarea("\"productPrice\":\"" & vpricereb[acomp[i] & ";" & "price"] & "\"," & chr(13) & chr(10),fillitems);
					addtexttoarea("\"productDiscount\":\"" & vpricereb[acomp[i] & ";" & "rebate"] & "\"," & chr(13) & chr(10),fillitems);
					addtexttoarea("\"stocks\":\{" & chr(13) & chr(10),fillitems);
					isfirst3 = false;
					for(j=0;j<alocation.length;j=j+1)begin
						if(vloc[alocation[j]]==acomp[i])then begin
							if(isfirst3)then begin
								addtexttoarea("," & chr(13) & chr(10),fillitems);
							end;
							isfirst3 = true;
							addtexttoarea("\"" & alocation[j] & "\":{" & chr(13) & chr(10),fillitems);
							addtexttoarea("\"stockname\":\"" & vlocname[alocation[j]] & "\"," & chr(13) & chr(10),fillitems);
							addtexttoarea("\"instock\":\"" & vlocinst[alocation[j]] & "\"" & chr(13) & chr(10),fillitems);
							addtexttoarea("}" & chr(13) & chr(10),fillitems);
						end;
					end;
					addtexttoarea("}" & chr(13) & chr(10),fillitems);
					addtexttoarea("}" & chr(13) & chr(10),fillitems);
				end;
				addtexttoarea("}" & chr(13) & chr(10),fillitems);
				addtexttoarea("]" & chr(13) & chr(10),fillitems);
				addtexttoarea("}" & chr(13) & chr(10),fillitems);
				fn = "webcust/fillitems.txt";
				WriteAreaToFile(fillitems,fn,0);
				//Edit **********************************************Vas-P	10/08/2021
			end;
		end;
	end;	
	ResetLoop(GIr);
	addtexttoarea("}" & chr(13) & chr(10),fillitems);
	addtexttoarea("}",fillitems);
	/*for (y=0;y<OrGCcnt;y=y+1) begin 
		GIr.Code = aOrigGlobalCodes[y];
		if (ReadFirstMain(GIr,1,true)) then begin
		  recordcopy(OldGir,GIr);
			for (j=matrowcnt(GIr)-1;j>=0;j=j-1) begin
				matrowdelete(GIr,j);
			end;
			for (i=0;i<CompQty;i=i+1)begin
				matrowget(Compb,i,Comprw);
				if(Comprw.ActiveStatus==0/* and (!CompanyIsJWLikeCompany(i+1) or (i+1)==3)*//*)then begin
					entf = false;
					SetCompany(i+1,false);
					INr.Code = GIr.HansaCode;
					if (ReadFirstMain(INr,1,true)) then begin
						if (left(GIr.Code,8)==INr.BPIBrand) then begin
							blockload(WRSb);
							aloccnt = 0;
							LCr.Code = "";
							while (LoopMain(LCr,1,true)) begin
								aloc[aloccnt] = LCr.Code;
								aloccnt = aloccnt + 1;
							end;
							resetloop(LCr);
							TrHs = true;
							For(li=0;li<aloccnt;li=li+1) begin
								locfnd = false;
								if(setinset(aloc[li],WRSb.ResStockSet))then begin
									if (GIr.Code=="BRND0129_04062WG") then begin
										logtext(0,GIrw.Instock & " 22");
									end;
									ISr.Code = GIr.HansaCode;
									ISr.Location = aloc[li];
									for(j=0;j<matrowcnt(GIr);j=j+1) begin
										MatRowGet(GIr,j,GIrw);
										if(GIrw.Location==ISr.Location) then begin
											if (GIr.Code=="BRND0129_04062WG") then begin
												logtext(0,GIrw.Instock & " 25");
											end;
											locfnd = true;
											if(ReadFirstMain(ISr,2,true))then begin
												if(GIrw.Instock!=(ISr.Instock-ISr.RsrvQty) or CurrentCompany==1)then begin
													if (GIr.Code=="BRND0129_04062WG") then begin
														logtext(0,GIrw.Instock & " 10");
													end;
													// logtext(0,ISr.Code & "<> Old" & GIrw.Instock & "<> New" & (ISr.Instock - ISr.RsrvQty) & "OrigItem");
													for(k=0;k<matrowcnt(OldGir);k=k+1)begin
													  matrowget(OldGir,k,OldGirw);
													  if(OldGirw.Location==GIrw.Location)then begin
													    GIrw.Instock = OldGirw.Instock;
													    GIrw.CurrentDate = OldGirw.CurrentDate;
                              GIrw.CurrentTime = OldGirw.CurrentTime;
                              GIrw.TimeStamp = OldGirw.TimeStamp;
													  end;
													end;
													TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 63");
													GIrw.Instock = ISr.Instock - ISr.RsrvQty;
													GIrw.Code = GIr.Code;
													if(GIrw.Instock<0) then begin GIrw.Instock = 0; end;
													// if (CurrentCompany==1 and GIrw.Instock==1) then begin
														// GIrw.Instock = 0;
													// end;
													MatRowPut(GIr,j,GIrw);
													entf = true;
												end;
											end;	
										end;
									end;
									if(locfnd==false)then begin
										GIrw.Location = aloc[li];
										if(ReadFirstMain(ISr,2,true))then begin
											if (GIr.Code=="BRND0129_04062WG") then begin
												logtext(0,GIrw.Instock & " 13");
											end;
											TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 64");
											GIrw.Instock = ISr.Instock - ISr.RsrvQty;
											GIrw.Code = GIr.Code;
											// if (CurrentCompany==1 and GIrw.Instock==1) then begin
												// GIrw.Instock = 0;
											// end;
											entf = true;
											MatRowPut(GIr,matrowcnt(GIr),GIrw);
										end;
									end;	
								end; 
							end;	
						end;
					end;
				end;
			end;
			ResetLoop(IDr);
			GIWasUpdated(GIr,OldGir," GIWasUpdatedlog 53");
			RecordStore(GIr,true);
			IDr.OrigCode = right(GIr.Code,len(GIr.Code)-9);
			RecordCopy(OldGir,GIr);
			TrHs = true;
			while (loopmain(IDr,1,TrHs)) begin
				testf1 = true;
				if (IDr.OrigCode!=right(GIr.Code,len(GIr.Code)-9)) then begin TrHs = false; testf1 = false; end;
				if (IDr.OrigBrandCode!=left(GIr.Code,8)) then begin testf1 = false; end;
				if (testf1) then begin
					DupGir.Code = IDr.DupBrandCode & "_" & IDr.DupCode;
					if (ReadFirstMain(DupGir,1,true)) then begin
						for (k=0;k<matrowcnt(DupGir);k=k+1) begin
							matrowget(DupGir,k,DupGirw);
							if (DupGIrw.Instock>0) then begin
								locfnd = false;
								for (j=0;j<matrowcnt(GIr);j=j+1) begin
									matrowget(GIr,j,GIrw);
									if (GIrw.Location==DupGirw.Location) then begin
										if (GIr.Code=="BRND0129_04062WG") then begin
											logtext(0,GIrw.Instock & "15");
										end;
										locfnd = true;
										TimeStamps(GIrw,GIrw.Instock + DupGIrw.Instock," TimeStamplog 65");
										GIrw.Instock = GIrw.Instock + DupGIrw.Instock;
										GIrw.Code = GIr.Code;
										// logtext (0,GIr.Code & " O <> D " & DupGir.Code & " Location " & GIrw.Location & " InStock " & DupGIrw.Instock);
										matrowput(GIr,j,GIrw);
										GIWasUpdated(GIr,OldGir," GIWasUpdatedlog 54");
										recordUpdate(OldGir,GIr,true);
									end;
								end;
								if (!locfnd) then begin
									if (GIr.Code=="BRND0129_04062WG") then begin
										logtext(0,GIrw.Instock & "14");
									end;
									GIrw.Location = DupGirw.Location;
									TimeStamps(GIrw,DupGIrw.Instock," TimeStamplog 66");
									GIrw.Instock = DupGIrw.Instock;
									GIrw.Code = GIr.Code;
									
									MatRowPut(GIr,matrowcnt(GIr),GIrw);
									GIWasUpdated(GIr,OldGir," GIWasUpdatedlog 55");
									recordUpdate(OldGir,GIr,true);
								end;
							end;
						end;
					end;
				end;
			end;
			// logtext(0,GIr.Code);
		end;
	end;
	ResetLoop(GIr);
	ResetCompany(OldComp);*/
  return;
end;






global webpublic updating procedure WebGlobalItemVcRecalcSTOCKMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger10:31 21.08.2018
begin
  record GlobalItemVc GIr,mainGIr,LogGIr;
	row GlobalItemVc GIrw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	integer CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	
	
	CompQty = 28;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	TrHs1=true;

	GIr.Code = "";
	logtext(0,"start WebGlobalItemVcRecalcSTOCKMn");
	while(loopmain(GIr,1,TrHs1))begin
		for (i=0;i<CompQty;i=i+1)begin
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0)then begin
				entf = false;
				SetCompany(i+1,false);
				blockload(WRSb);
				aloccnt = 0;
				LCr.Code = "";
				while (LoopMain(LCr,1,true)) begin
					aloc[aloccnt] = LCr.Code;
					aloccnt = aloccnt + 1;
				end;
				resetloop(LCr);
				
				TrHs = true;
				recordcopy(LogGIr,GIr);
				for(li=0;li<aloccnt;li=li+1) begin
					locfnd = false;
					if(setinset(aloc[li],WRSb.ResStockSet))then begin
						ISr.Code = GIr.HansaCode;
						ISr.Location = aloc[li];
						for(j=0;j<matrowcnt(GIr);j=j+1) begin
							MatRowGet(GIr,j,GIrw);
							if(GIrw.Location==ISr.Location) then begin
								locfnd = true;
								if(ReadFirstMain(ISr,2,true))then begin
									if(GIrw.Instock!=(ISr.Instock-ISr.RsrvQty))then begin
										// logtext(0,ISr.Code & "<> Old" & GIrw.Instock & "<> New" & (ISr.Instock - ISr.RsrvQty));
										TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 67");
										GIrw.Instock = ISr.Instock - ISr.RsrvQty;
										GIrw.Code = GIr.Code;
										if(GIrw.Instock<0) then begin GIrw.Instock = 0; end;
										MatRowPut(GIr,j,GIrw);
										entf = true;
									end;
								end;	
							end;
						end;
						if(locfnd==false)then begin
							GIrw.Location = aloc[li];
							if(ReadFirstMain(ISr,2,true))then begin
                TimeStamps(GIrw,ISr.Instock - ISr.RsrvQty," TimeStamplog 68");
								GIrw.Instock = ISr.Instock - ISr.RsrvQty;
								GIrw.Code = GIr.Code;
								if(GIrw.Instock<0) then begin GIrw.Instock = 0; end;
								entf = true;
								MatRowPut(GIr,matrowcnt(GIr),GIrw);
							end;
						end;	
					end; 
				end;	
				if(entf)then begin
					GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 56");
					RecordStore(GIr,true);
				end;
			end;
		end;
	end;	
	logtext(0,"finish WebGlobalItemVcRecalcSTOCKMn");
	ResetCompany(OldComp);
	return;
end;







global updating procedure GlobalBrandsVcfFrDIMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record GlobalBrandsVc GBr;
	record DIVc Dir;
	integer CompQty,i,OldComp;
	boolean TrHs;
	
	
	CompQty = 28;
	OldComp = CurrentCompany;
	
	for (i=0;i<CompQty;i=i+1)begin
		SetCompany(i+1,false);
		ResetLoop(Dir);
		TrHs = true;
		DIr.CType = "BRAND";
		while (loopkey("CType",DIr,1,TrHs)) begin
			if(DIr.CType!="BRAND") then begin TrHs = false; end;
			if(TrHs)then begin
				GBr.Code = DIr.Code;
				if(ReadFirstMain(GBr,1,true))then begin
					GBr.Code = DIr.Code;
					GBr.Name = DIr.Name;
					RecordStore(GBr,true);
				end else begin
					recordnew(GBr);
					GBr.Code = DIr.Code;
					GBr.Name = DIr.Name;
					RecordStore(GBr,true);
				end;
			end;
		end;
	end;
	ResetCompany(OldComp);
  return;
end;

global updating procedure DeleteCUVcMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
record CUVc CUr;
CUr.Code = "";
while(LoopMain(CUr,1,true)) begin
	if(left(CUr.Code,4)=="IDA1" or CUr.Code=="10000" or left(CUr.Code,4)=="IDA3") then begin
		RecordDelete(CUr);
		StepBack(Cur);
	end;	
end;	
return;
end;

/*
global updating procedure GlobalClassVcfFrDIMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  record GlobalClassificationsVc GBr;
  record GlobalBrandsVc GBrr;
	record DIVc Dir;
	integer CompQty,i,OldComp;
	boolean TrHs;
	record BPIBrandVc BPIBrandr;
	record BPICollectionVc BPICollectionr;
	record BPIGroupVc BPIGroupr;
	record BPISubGroupVc BPISubGroupr;
	record BPICategoryVc BPICategoryr;
	record BPIMaterialVc BPIMaterialr;
	record BPIColorVc BPIColorr;
	record BPIShapeVc BPIShaper;
	record BPISizeVc BPISizer;
	record BPIUseVc BPIUser;
	record BPISexVc BPISexr;
	record BPIPlatingVc BPIPlatingr;
	record BPIClarityVc BPIClarityr;
	record BPIWeightVc BPIWeightr;
	record BPICutVc BPICutr;
	record BPIStoneVc BPIStoner;
	record BPIStrapVc BPIStrapr;
	record BPIOdourVc BPIOdourr;
	
	BPIOdourr.Code = "";
	while(loopmain(BPIOdourr,1,true))begin
		GBr.Code = BPIOdourr.Code;
		GBr.Name = BPIOdourr.Name;
		GBr.Type = "ODOUR";
		recordstore(GBr,true);
	end;
	
	BPIStrapr.Code = "";
	while(loopmain(BPIStrapr,1,true))begin
		GBr.Code = BPIStrapr.Code;
		GBr.Name = BPIStrapr.Name;
		GBr.Type = "STRAP";
		recordstore(GBr,true);
	end;
	
	BPIStoner.Code = "";
	while(loopmain(BPIStoner,1,true))begin
		GBr.Code = BPIStoner.Code;
		GBr.Name = BPIStoner.Name;
		GBr.Type = "STONE";
		recordstore(GBr,true);
	end;
	
	BPICutr.Code = "";
	while(loopmain(BPICutr,1,true))begin
		GBr.Code = BPICutr.Code;
		GBr.Name = BPICutr.Name;
		GBr.Type = "CUT";
		recordstore(GBr,true);
	end;
	
	BPIWeightr.Code = "";
	while(loopmain(BPIWeightr,1,true))begin
		GBr.Code = BPIWeightr.Code;
		GBr.Name = BPIWeightr.Name;
		GBr.Type = "WEIGHT";
		recordstore(GBr,true);
	end;
	
	BPIClarityr.Code = "";
	while(loopmain(BPIClarityr,1,true))begin
		GBr.Code = BPIClarityr.Code;
		GBr.Name = BPIClarityr.Name;
		GBr.Type = "CLARITY";
		recordstore(GBr,true);
	end;
	
	BPIPlatingr.Code = "";
	while(loopmain(BPIPlatingr,1,true))begin
		GBr.Code = BPIPlatingr.Code;
		GBr.Name = BPIPlatingr.Name;
		GBr.Type = "PLATING";
		recordstore(GBr,true);
	end;
	
	BPISexr.Code = "";
	while(loopmain(BPISexr,1,true))begin
		GBr.Code = BPISexr.Code;
		GBr.Name = BPISexr.Name;
		GBr.Type = "SEX";
		recordstore(GBr,true);
	end;
	
	BPIUser.Code = "";
	while(loopmain(BPIUser,1,true))begin
		GBr.Code = BPIUser.Code;
		GBr.Name = BPIUser.Name;
		GBr.Type = "USE";
		recordstore(GBr,true);
	end;
	
	BPISizer.Code = "";
	while(loopmain(BPISizer,1,true))begin
		GBr.Code = BPISizer.Code;
		GBr.Name = BPISizer.Name;
		GBr.Type = "SIZE";
		recordstore(GBr,true);
	end;
	
	BPIShaper.Code = "";
	while(loopmain(BPIShaper,1,true))begin
		GBr.Code = BPIShaper.Code;
		GBr.Name = BPIShaper.Name;
		GBr.Type = "SHAPE";
		recordstore(GBr,true);
	end;
	
	
	BPIColorr.Code = "";
	while(loopmain(BPIColorr,1,true))begin
		GBr.Code = BPIColorr.Code;
		GBr.Name = BPIColorr.Name;
		GBr.Type = "COLOR";
		recordstore(GBr,true);
	end;
	
	BPIMaterialr.Code = "";
	while(loopmain(BPIMaterialr,1,true))begin
		GBr.Code = BPIMaterialr.Code;
		GBr.Name = BPIMaterialr.Name;
		GBr.Type = "MATERIAL";
		recordstore(GBr,true);
	end;
	
	BPICategoryr.Code = "";
	while(loopmain(BPICategoryr,1,true))begin
		GBr.Code = BPICategoryr.Code;
		GBr.Name = BPICategoryr.Name;
		GBr.Type = "CATEGORY";
		recordstore(GBr,true);
	end;
	
	BPISubGroupr.Code = "";
	while(loopmain(BPISubGroupr,1,true))begin
		GBr.Code = BPISubGroupr.Code;
		GBr.Name = BPISubGroupr.Name;
		GBr.Type = "SUBGROUP";
		recordstore(GBr,true);
	end;
	
	BPIGroupr.Code = "";
	while(loopmain(BPIGroupr,1,true))begin
		GBr.Code = BPIGroupr.Code;
		GBr.Name = BPIGroupr.Name;
		GBr.Type = "GROUP";
		recordstore(GBr,true);
	end;
	
	BPICollectionr.Code = "";
	while(loopmain(BPICollectionr,1,true))begin
		GBr.Code = BPICollectionr.Code;
		GBr.Name = BPICollectionr.Name;
		GBr.Type = "COLLECT";
		recordstore(GBr,true);
	end;
	
	BPIBrandr.Code = "";
	while(loopmain(BPIBrandr,1,true))begin
		GBr.Code = BPIBrandr.Code;
		GBr.Name = BPIBrandr.Name;
		GBr.Type = "BRAND";
		recordstore(GBr,true);
		GBrr.Code = BPIBrandr.Code;
		GBrr.Name = BPIBrandr.Name;
		recordstore(GBrr,true);
	end;
	
	CompQty = 28;
	OldComp = CurrentCompany;
	
	for (i=0;i<CompQty;i=i+1)begin
		SetCompany(i+1,false);
		ResetLoop(Dir);
		TrHs = true;
		DIr.CType = "";
		while (loopkey("CType",DIr,1,TrHs)) begin
			if(true)then begin
				GBr.Code = DIr.Code;
				if(ReadFirstMain(GBr,1,true))then begin
				end else begin
					recordnew(GBr);
					GBr.Code = DIr.Code;
					GBr.Name = DIr.Name;
					GBr.Type = DIr.CType;
					RecordStore(GBr,true);
				end;
			end;
		end;
	end;
	ResetCompany(OldComp);
  return;
end;


*/




global updating procedure GlobalClassVcfFrDIMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
  //record GlobalClassificationsVc GBr;
  record GlobalBrandsVc GBrr;
	record DIVc GBr;
	integer CompQty,i,OldComp;
	boolean TrHs;
	record BPIBrandVc BPIBrandr;
	record BPICollectionVc BPICollectionr;
	record BPIGroupVc BPIGroupr;
	record BPISubGroupVc BPISubGroupr;
	record BPICategoryVc BPICategoryr;
	record BPIMaterialVc BPIMaterialr;
	record BPIColorVc BPIColorr;
	record BPIShapeVc BPIShaper;
	record BPISizeVc BPISizer;
	record BPIUseVc BPIUser;
	record BPISexVc BPISexr;
	record BPIPlatingVc BPIPlatingr;
	record BPIClarityVc BPIClarityr;
	record BPIWeightVc BPIWeightr;
	record BPICutVc BPICutr;
	record BPIStoneVc BPIStoner;
	record BPIStrapVc BPIStrapr;
	record BPIOdourVc BPIOdourr;
	
	BPIOdourr.Code = "";
	while(loopmain(BPIOdourr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIOdourr.Code;
		GBr.Name = BPIOdourr.Name;
		GBr.CType = "ODOUR";
		recordstore(GBr,false);
	end;
	
	BPIStrapr.Code = "";
	while(loopmain(BPIStrapr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIStrapr.Code;
		GBr.Name = BPIStrapr.Name;
		GBr.CType = "STRAP";
		recordstore(GBr,false);
	end;
	
	BPIStoner.Code = "";
	while(loopmain(BPIStoner,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIStoner.Code;
		GBr.Name = BPIStoner.Name;
		GBr.CType = "STONE";
		recordstore(GBr,false);
	end;
	
	BPICutr.Code = "";
	while(loopmain(BPICutr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPICutr.Code;
		GBr.Name = BPICutr.Name;
		GBr.CType = "CUT";
		recordstore(GBr,false);
	end;
	
	BPIWeightr.Code = "";
	while(loopmain(BPIWeightr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIWeightr.Code;
		GBr.Name = BPIWeightr.Name;
		GBr.CType = "WEIGHT";
		recordstore(GBr,false);
	end;
	
	BPIClarityr.Code = "";
	while(loopmain(BPIClarityr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIClarityr.Code;
		GBr.Name = BPIClarityr.Name;
		GBr.CType = "CLARITY";
		recordstore(GBr,false);
	end;
	
	BPIPlatingr.Code = "";
	while(loopmain(BPIPlatingr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIPlatingr.Code;
		GBr.Name = BPIPlatingr.Name;
		GBr.CType = "PLATING";
		recordstore(GBr,false);
	end;
	
	BPISexr.Code = "";
	while(loopmain(BPISexr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPISexr.Code;
		GBr.Name = BPISexr.Name;
		GBr.CType = "SEX";
		recordstore(GBr,false);
	end;
	
	BPIUser.Code = "";
	while(loopmain(BPIUser,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIUser.Code;
		GBr.Name = BPIUser.Name;
		GBr.CType = "USE";
		recordstore(GBr,false);
	end;
	
	BPISizer.Code = "";
	while(loopmain(BPISizer,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPISizer.Code;
		GBr.Name = BPISizer.Name;
		GBr.CType = "SIZE";
		recordstore(GBr,false);
	end;
	
	BPIShaper.Code = "";
	while(loopmain(BPIShaper,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIShaper.Code;
		GBr.Name = BPIShaper.Name;
		GBr.CType = "SHAPE";
		recordstore(GBr,false);
	end;
	
	
	BPIColorr.Code = "";
	while(loopmain(BPIColorr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIColorr.Code;
		GBr.Name = BPIColorr.Name;
		GBr.CType = "COLOR";
		recordstore(GBr,false);
	end;
	
	BPIMaterialr.Code = "";
	while(loopmain(BPIMaterialr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIMaterialr.Code;
		GBr.Name = BPIMaterialr.Name;
		GBr.CType = "MATERIAL";
		recordstore(GBr,false);
	end;
	
	BPICategoryr.Code = "";
	while(loopmain(BPICategoryr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPICategoryr.Code;
		GBr.Name = BPICategoryr.Name;
		GBr.CType = "CATEGORY";
		recordstore(GBr,false);
	end;
	
	BPISubGroupr.Code = "";
	while(loopmain(BPISubGroupr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPISubGroupr.Code;
		GBr.Name = BPISubGroupr.Name;
		GBr.CType = "SUBGROUP";
		recordstore(GBr,false);
	end;
	
	BPIGroupr.Code = "";
	while(loopmain(BPIGroupr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIGroupr.Code;
		GBr.Name = BPIGroupr.Name;
		GBr.CType = "GROUP";
		recordstore(GBr,false);
	end;
	
	BPICollectionr.Code = "";
	while(loopmain(BPICollectionr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPICollectionr.Code;
		GBr.Name = BPICollectionr.Name;
		GBr.CType = "COLLECT";
		recordstore(GBr,false);
	end;
	
	BPIBrandr.Code = "";
	while(loopmain(BPIBrandr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIBrandr.Code;
		GBr.Name = BPIBrandr.Name;
		GBr.CType = "BRAND";
		recordstore(GBr,false);
		/*GBrr.Code = BPIBrandr.Code;
		GBrr.Name = BPIBrandr.Name;
		recordstore(GBrr,false);*/
	end;
	/*
	CompQty = 28;
	OldComp = CurrentCompany;
	for (i=0;i<CompQty;i=i+1)begin
		SetCompany(i+1,false);
		ResetLoop(Dir);
		TrHs = true;
		DIr.CType = "";
		while (loopkey("CType",DIr,1,TrHs)) begin
			if(true)then begin
				GBr.Code = DIr.Code;
				if(ReadFirstMain(GBr,1,true))then begin
				end else begin
					recordnew(GBr);
					GBr.Code = DIr.Code;
					GBr.Name = DIr.Name;
					GBr.CType = DIr.CType;
					RecordStore(GBr,true);
				end;
			end;
		end;
	end;
	ResetCompany(OldComp);*/
  return;
end;



global webpublic updating procedure WebBPIClassVcfFrDIMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:53 12.02.2021
begin
	record BPICollectionVc Collectr;
	record DIVc DIr;
	boolean TrHs, TrHs2;
	string 255 OldCode, tmpCode;
	
	SetCompany(28,false);
	DIr.CType = "MODEL";
	TrHs = true;
	while (loopKey("CType",DIr,1,TrHs)) begin
		if (DIr.CType!="MODEL") then begin TrHs = false; end;
		if (TrHs) then begin
			Collectr.Name = DIr.Name;
			if (!ReadFirstKey("Name",Collectr,1,true)) then begin
				if (blank(tmpCode)) then begin
					Collectr.Code = "COLL99999";
					TrHs2 = true;
					while (LoopBackKey("Code",Collectr,1,TrHs2)) begin
						OldCode = Collectr.Code;
						TrHs2 = false;
					end;
					ResetLoop(Collectr);
					if(blank(OldCode))then begin OldCode = "COLL00000"; end;
				end else begin
					OldCode = tmpCode;
				end;
				recordnew(Collectr);
				NextCode(OldCode,Collectr.Code);
				Collectr.Name = DIr.Name;
				tmpCode = Collectr.Code;
				recordinsert(Collectr,true);
				OldCode = "";
			end;
		end;
	end;
	ResetLoop(DIr);

return;
end;




global webpublic updating procedure WebGlobalClassVcfFrDIMn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
	record DIVc GBr;
	integer CompQty,i,OldComp;
	boolean TrHs;
	record BPIBrandVc BPIBrandr;
	record BPICollectionVc BPICollectionr;
	record BPIGroupVc BPIGroupr;
	record BPISubGroupVc BPISubGroupr;
	record BPICategoryVc BPICategoryr;
	record BPIMaterialVc BPIMaterialr;
	record BPIColorVc BPIColorr;
	record BPIShapeVc BPIShaper;
	record BPISizeVc BPISizer;
	record BPIUseVc BPIUser;
	record BPISexVc BPISexr;
	record BPIPlatingVc BPIPlatingr;
	record BPIClarityVc BPIClarityr;
	record BPIWeightVc BPIWeightr;
	record BPICutVc BPICutr;
	record BPIStoneVc BPIStoner;
	record BPIStrapVc BPIStrapr;
	record BPIOdourVc BPIOdourr;
	
	setcompany(3,false);
	
	BPIOdourr.Code = "";
	while(loopmain(BPIOdourr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIOdourr.Code;
		GBr.Name = BPIOdourr.Name;
		GBr.CType = "ODOUR";
		recordstore(GBr,false);
	end;
	
	BPIStrapr.Code = "";
	while(loopmain(BPIStrapr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIStrapr.Code;
		GBr.Name = BPIStrapr.Name;
		GBr.CType = "STRAP";
		recordstore(GBr,false);
	end;
	
	BPIStoner.Code = "";
	while(loopmain(BPIStoner,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIStoner.Code;
		GBr.Name = BPIStoner.Name;
		GBr.CType = "STONE";
		recordstore(GBr,false);
	end;
	
	BPICutr.Code = "";
	while(loopmain(BPICutr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPICutr.Code;
		GBr.Name = BPICutr.Name;
		GBr.CType = "CUT";
		recordstore(GBr,false);
	end;
	
	BPIWeightr.Code = "";
	while(loopmain(BPIWeightr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIWeightr.Code;
		GBr.Name = BPIWeightr.Name;
		GBr.CType = "WEIGHT";
		recordstore(GBr,false);
	end;
	
	BPIClarityr.Code = "";
	while(loopmain(BPIClarityr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIClarityr.Code;
		GBr.Name = BPIClarityr.Name;
		GBr.CType = "CLARITY";
		recordstore(GBr,false);
	end;
	
	BPIPlatingr.Code = "";
	while(loopmain(BPIPlatingr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIPlatingr.Code;
		GBr.Name = BPIPlatingr.Name;
		GBr.CType = "PLATING";
		recordstore(GBr,false);
	end;
	
	BPISexr.Code = "";
	while(loopmain(BPISexr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPISexr.Code;
		GBr.Name = BPISexr.Name;
		GBr.CType = "SEX";
		recordstore(GBr,false);
	end;
	
	BPIUser.Code = "";
	while(loopmain(BPIUser,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIUser.Code;
		GBr.Name = BPIUser.Name;
		GBr.CType = "USE";
		recordstore(GBr,false);
	end;
	
	BPISizer.Code = "";
	while(loopmain(BPISizer,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPISizer.Code;
		GBr.Name = BPISizer.Name;
		GBr.CType = "SIZE";
		recordstore(GBr,false);
	end;
	
	BPIShaper.Code = "";
	while(loopmain(BPIShaper,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIShaper.Code;
		GBr.Name = BPIShaper.Name;
		GBr.CType = "SHAPE";
		recordstore(GBr,false);
	end;
	
	BPIColorr.Code = "";
	while(loopmain(BPIColorr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIColorr.Code;
		GBr.Name = BPIColorr.Name;
		GBr.CType = "COLOR";
		recordstore(GBr,false);
	end;
	
	BPIMaterialr.Code = "";
	while(loopmain(BPIMaterialr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIMaterialr.Code;
		GBr.Name = BPIMaterialr.Name;
		GBr.CType = "MATERIAL";
		recordstore(GBr,false);
	end;
	
	BPICategoryr.Code = "";
	while(loopmain(BPICategoryr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPICategoryr.Code;
		GBr.Name = BPICategoryr.Name;
		GBr.CType = "CATEGORY";
		recordstore(GBr,false);
	end;
	
	BPISubGroupr.Code = "";
	while(loopmain(BPISubGroupr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPISubGroupr.Code;
		GBr.Name = BPISubGroupr.Name;
		GBr.CType = "SUBGROUP";
		recordstore(GBr,false);
	end;
	
	BPIGroupr.Code = "";
	while(loopmain(BPIGroupr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIGroupr.Code;
		GBr.Name = BPIGroupr.Name;
		GBr.CType = "GROUP";
		recordstore(GBr,false);
	end;
	
	BPICollectionr.Code = "";
	while(loopmain(BPICollectionr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPICollectionr.Code;
		GBr.Name = BPICollectionr.Name;
		GBr.CType = "COLLECT";
		recordstore(GBr,false);
	end;
	
	BPIBrandr.Code = "";
	while(loopmain(BPIBrandr,1,true))begin
		RecordNew(GBr);
		GBr.Code = BPIBrandr.Code;
		GBr.Name = BPIBrandr.Name;
		GBr.CType = "BRAND";
		recordstore(GBr,false);
	end;

  return;
end;




global updating procedure PasteItemGroupByClassMn(record RcVc RepSpec) 
begin
	record INVc INr;
	record ITVc ITr;
	record DIVc DIr;
	boolean testf,findf,changef;
	integer pos;
	string 20 class;
	longint curtick;
	
	curtick = getcurtick();
	INr.Code = "";
	while(loopmain(INr,1,true))begin
		class = "";
		pos = 0;
		changef = false;
		ExtractObj(INr.DispGroups,pos,class);
		while(nonblank(class))begin
			DIr.Code = class;
			if(readfirstmain(DIr,1,true))then begin
				if(DIr.CType=="BRAND")then begin
					ITr.Comment = DIr.Name;
					if(readlastkey("Comment",ITr,1,true))then begin
						INr.Group = ITr.Code;
					end;
					changef = true;
				end;
			end;
			ExtractObj(INr.DispGroups,pos,class);
		end;
		if(changef)then begin
			recordstore(INr,true);
		end;
	end;
	LogProcTime("PasteItemGroupByClassMn",getcurtick()-curtick);
return;
end;

global //Edit***************************Sasha2,11:22 06.03.2015 {
updating procedure CalcINVcLastPurchPriceMn(record RcVc RepSpec)
begin
	record INVc INr,oldINr;
	record ItemHistVc IHr;
  val from,to1,to2,base1,base2,cost;
  date td;
  boolean changef;
  string 20 eurcurncy;
  record ItemStatusVc ISr;
	longint curtick;
	
	curtick = getcurtick();
	eurcurncy = "EUR";
	td = CurrentDate;
	GetFullCurncyRate(eurcurncy,td,from,to1,to2,base1,base2);
	
	INr.Code = "";
	while (loopmain(INr,1,true)) begin
    IHr.ArtCode = INr.Code;
    IHr.FileName = "PUVc";
    if (ReadLastKey("FNArtCode",IHr,2,true) and IHr.ArtCode==INr.Code and IHr.FileName=="PUVc") then begin
      cost = IHr.TotCostPriceCurncy/IHr.Qty;
      if (cost<0) then begin
        cost = cost * (-1);
      end;
      ISr.Code = IHr.ArtCode;
    	ISr.Location = ";;;";
    	if(readfirstmain(ISr,1,true) and ISr.Instock>0)then begin
				if(IHr.CurncyCode==INr.LastPurchCurncyCode and round(INr.LastPurchPrice2,defaultcurroundoff)<round(cost,defaultcurroundoff))then begin
					recordcopy(oldINr,INr);
					INr.LastPurchPrice2 = IHr.TotCostPriceCurncy/IHr.Qty;
					recordupdate(oldINr,INr,true);
				end;
      end;
    end;
	end;
	LogProcTime("CalcINVcLastPurchPriceMn",getcurtick()-curtick);
return;
end; //Edit***************************Sasha2,11:22 06.03.2015 }

global //Edit***************************Sasha2,10:38 19.06.2017 {
updating procedure SetUpdateCostINToLastPurchPriceMn(record RcVc RepSpec)
begin
	record INVc INr,oldINr;
	record ItemHistVc IHr;
	record PUVc PUr;
	row PUVc PUrw;
  boolean changef,testf;
  val cost;
	longint curtick;
	
	curtick = getcurtick();
	INr.Code = "";
	while (loopmain(INr,1,true)) begin
	  testf = true;
	  if (INr.UpdateCost==1) then begin testf = false; end;
	  if (testf) then begin
  	  IHr.ArtCode = INr.Code;
      IHr.FileName = "PUVc";
      if (ReadLastKey("FNArtCode",IHr,2,true) and IHr.ArtCode==INr.Code and IHr.FileName=="PUVc") then begin
        cost = round(IHr.TotCostPriceCurncy/IHr.Qty,defaultcurroundoff);
        if (IHr.TotCostPriceCurncy==0) then begin
          PUr.SerNr = IHr.TransNr;
          if (ReadFirstMain(PUr,1,true)) then begin
            MatRowGet(PUr,IHr.Row,PUrw);
            if (PUrw.ArtCode==IHr.ArtCode) then begin
              cost = round(PUrw.Sum/PUrw.Quant,defaultcurroundoff);
            end;
          end;
        end;
        if (cost<0) then begin
          cost = cost * (-1);
        end;
        //recordcopy(oldINr,INr);
        INr.UpdateCost = 1;
				if(IHr.CurncyCode!=INr.LastPurchCurncyCode or round(INr.LastPurchPrice2,defaultcurroundoff)!=cost)then begin
					INr.LastPurchCurncyCode = IHr.CurncyCode;
					INr.LastPurchPrice2 = cost;
				end;
				if (recordStore(INr,true)) then begin
				  LogText(0,"Was changed cost flag in item #" & INr.Code);
				end else begin
				  LogText(0,"Problem to save item #" & INr.Code);
				end;
      end;
	  end;
	end;
	LogProcTime("SetUpdateCostINToLastPurchPriceMn",getcurtick()-curtick);
return;
end; //Edit***************************Sasha2,10:38 19.06.2017 }


global
procedure CalcINVcLastPurchPriceRn(record RcVc RepSpec)
begin
	record INVc INr,oldINr;
	record ItemHistVc IHr;
  val from,to1,to2,base1,base2,cost;
  date td;
  boolean changef;
  string 20 eurcurncy;
  record ItemStatusVc ISr;
	longint curtick;
	
	curtick = getcurtick();
	startreportnoheaderjob("Wrong Last Purch price. report");
		
	eurcurncy = "EUR";
	td = CurrentDate;
	GetFullCurncyRate(eurcurncy,td,from,to1,to2,base1,base2);
	
	startformat(15);
		outstring(0,0,"Item Code",false);
		outstring(70,0,"Item Name",false);
		outstring(140,0,"Current Purchase price",false);
		outstring(200,0,"Current Currency",false);
		outstring(260,0,"Last Purchase price",false);
		outstring(300,0,"Last Currency",false);
		outstring(350,0,"Diff",false);
	endformat;
	
	INr.Code = "";
	while (loopmain(INr,1,true)) begin
    IHr.ArtCode = INr.Code;
    IHr.FileName = "PUVc";
    if (ReadLastKey("FNArtCode",IHr,2,false) and IHr.ArtCode==INr.Code and IHr.FileName=="PUVc") then begin
    	ISr.Code = IHr.ArtCode;
    	ISr.Location = ";;;";
    	if(readfirstmain(ISr,1,true) and ISr.Instock>0)then begin
				cost = IHr.TotCostPriceCurncy/IHr.Qty;
			
				if(IHr.CurncyCode==INr.LastPurchCurncyCode and round(INr.LastPurchPrice2,defaultcurroundoff)<round(cost,defaultcurroundoff))then begin				
					startformat(15);
						outstring(0,0,INr.Code,false);
						outstring(70,0,INr.Name,false);
						outstring(140,0,INr.LastPurchPrice2,false);
						outstring(200,0,INr.LastPurchCurncyCode,false);
						outstring(260,0,cost,false);
						outstring(300,0,IHr.CurncyCode,false);
						outstring(350,0,cost - INr.LastPurchPrice2,false);
					endformat;
				
				end;
      end;

      
    end;
	end;
	
	endjob;
		LogProcTime("CalcINVcLastPurchPriceRn",getcurtick()-curtick);
return;
end;


global
procedure BPIBrandRn(record RcVc RepSpec)
begin
	record BPIBrandVc BRNDr;
  
	
	startreportnoheaderjob("Brand report");
	startformat(15);
		outstring(0,0,"Brand Code",false);
		outstring(50,0,"Brand Name",false);
		outstring(110,0,"Supplier Code",false);
		outstring(150,0,"CWH Code",false);
		outstring(210,0,"Br. Developer Code",false);
		outstring(280,0,"Br. Lead Time",false);
		outstring(340,0,"Br. Production Time",false);
		outstring(410,0,"Br. Freight Type",false);
		outstring(470,0,"Stock Group",false);
	endformat;
	
	BRNDr.Code = "";
	while (loopmain(BRNDr,1,true)) begin
		startformat(15);
			outstring(0,0,BRNDr.Code,false);
			outstring(50,0,BRNDr.Name,false);
			outstring(110,0,BRNDr.Vendor,false);
			outstring(150,0,BRNDr.CWHCode,false);
			outstring(210,0,BRNDr.BrndMngr,false);
			outstring(280,0,BRNDr.CalculatedLeadTime,false);
			outstring(340,0,BRNDr.PlanShipDaysMin,false);
			if(BRNDr.DeliveryWay==0)then begin
				outstring(420,0,"By plane",false);
			end;
			if(BRNDr.DeliveryWay==1)then begin
				outstring(420,0,"By car",false);
			end;
			if(BRNDr.DeliveryWay==2)then begin
				outstring(420,0,"By ship",false);
			end;
			outstring(470,0,BRNDr.StockGroup,false);
		endformat;
	end;
	
	endjob;
	
return;
end;

global
procedure BlankBrandRn(record RcVc RepSpec)
begin
record INVc INr;
integer i,CompOld;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
record DIVc DIr;
boolean testf;
integer pos;
string 100 class;
longint curtick;
	curtick = getcurtick();
	StartReportnoheaderjob(" ");
	startformat(15);
		outstring(0,0," ",false);
		outstring(0,0,".",false);
	endformat;	
	INr.Code = "";
	while(LoopMain(INr,1,true)) begin
		testf = false;
		pos = 0;
		ExtractObj(INr.DispGroups,pos,class);
		while(nonblank(class))begin
			DIr.Code = class;
			readfirstmain(DIr,1,true);
			if(DIr.CType=="BRAND")then begin
				testf = true;
			end;
			ExtractObj(INr.DispGroups,pos,class);
		end;
		if(!testf) then begin
			startformat(15);
				outstring(0,0,INr.Code,false);
				outstring(0,0,INr.DispGroups,false);
			endformat;	
		end;
	end;
endjob;	

LogProcTime("BlankBrandRn",getcurtick()-curtick);
return;
end;

global function val GetClientItemStatusRes(string itemcode)
begin
	record ClientItemStatusVc CISr;
	val res;
	boolean TrHs;
	
	TrHs = true;
	CISr.ItemCode = itemcode;
	while(loopmain(CISr,1,TrHs))begin
		if(CISr.ItemCode!=itemcode)then begin
			TrHs = false;
		end;
		
		if(TrHs)then begin
			res = res + CISr.Quant;
		end;
	end;
	
	GetClientItemStatusRes = res;
return;
end;

global
procedure StockInAllCompRn(record RcVc RepSpec)
begin
record INVc INr,IN2r;
integer i,CompOld,CompQty;
record DIVc DIr;
boolean testf;
integer pos;
string 100 class;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
record ItemStatusVc ISr,IS2r;
boolean TrHs;
record LocationVc Locr;
boolean instock;
longint curtick;	
record ConsItemVc CIr;
val clientres;

	// WebSyncCustomerSales;
	
	BlockLoad(Compb);
	
	CompOld = currentcompany;
	CompQty = matrowcnt(Compb);
	
	curtick = getcurtick();
	StartReportnoheaderjob("  ");
	
	INr.Code = RepSpec.f1;
	if(!ReadFirstMain(INr,1,true)) then begin
		INr.BarCode = RepSpec.f1;
		if(!ReadFirstKey("BarCode",INr,1,true)) then begin
			INr.AlternativeCode = RepSpec.f1;
			If(!ReadFirstKey("AlternativeCode",INr,1,true)) then begin
				goto StockInAllCompRnEnd;
			end;
		end;
	end;
	instock = false;
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0)then begin
			SetCompany(i+1,false);
			/*If(nonblank(INr.GlobalArtCode)) then begin
				IN2r.Code = Right(INr.GlobalArtCode,Len(INr.GlobalArtCode)-9);
			end else begin 	IN2r.Code = INr.Code; end;
				if(!ReadFirstMain(IN2r,1,true)) then begin
					goto skipcomp;
				end;	
				
			if(IN2r.BPIBrand!=INr.BPIBrand) then begin 
				if(nonblank(RepSpec.f2)) then begin 
					if(RepSpec.f2!=IN2r.BPIBrand) then begin
						goto skipcomp;
					end;
				end;	
			end;*/
			
			IN2r.Code = INr.Code;
			if(currentcompany!=18)then begin
				if(!ReadFirstMain(IN2r,1,true)) then begin
					goto skipcomp;
				end else begin
					if(IN2r.BPIBrand!=INr.BPIBrand) then begin
						goto skipcomp;
					end;
				end;
			end else begin
				CIr.LocCode = INr.Code;
				CIr.BrandCode = INr.BPIBrand;
				if(readfirstkey("LocCodeBrand",CIr,2,true))then begin
					IN2r.Code = CIr.Code;
					if(!ReadFirstMain(IN2r,1,true)) then begin
						goto skipcomp;
					end else begin
						if(IN2r.BPIBrand!=INr.BPIBrand) then begin
							goto skipcomp;
						end;
					end;
				end else begin
					goto skipcomp;
				end;
			end;
			
			ISr.Code = IN2r.Code;
			ISr.Location = ";;;";
			clientres = blankval;
			if(currentcompany==18)then begin
				clientres = GetClientItemStatusRes(ISr.Code);
			end;
			if(ReadFirstMain(ISr,2,true) and (ISr.Instock-ISr.RsrvQty)>0) then begin
				Black_Divider(0,1);
				startformat(15);
					outstring(0,0,"Company - " & Comprw.CompName ,false);
				endformat;
				gray_divider(0,1);
					startformat(15);
						outstring(50,0,"",false);
						outstring(120,0,"",false);
						outstring(180,0,".",false);
						outstring(300,0," ",false);
						outstring(350,0,"",false);
						outstring(400,0,"",false);
					endformat;	
				resetloop(IS2r);
				TrHs = true;
				IS2r.Code = ISr.Code;
				while(loopmain(IS2r,1,TrHs))begin
					if(IS2r.Code!=ISr.Code)then begin TrHs = false; end;
					
					if(TrHs and IS2r.Location!=ISr.Location)then begin
							instock = true;
							startformat(15);
							outstring(0,0,IS2r.Location,false);
							Locr.Code = IS2r.Location;
							readfirstmain(Locr,1,true);
							outstring(50,0,Locr.Name,false);
							if(currentcompany!=18)then begin
								outstring(120,"dblINVc",IN2r.Code ,false);
							end else begin
								outstring(120,0,INr.Code ,false);
							end;
							outstring(180,0,IN2r.Name ,false);
							if(blank(IS2r.Instock)) then begin
								outstring(300,0,"0",false);
							end else begin	
								outstring(300,0,IS2r.Instock,false);
							end;	
							if(blank(IS2r.RsrvQty)) then begin
								outstring(350,0,"0",false);
							end else begin	
								outstring(350,0,IS2r.RsrvQty+clientres,false);
							end;	
							if(blank(IS2r.Instock) and blank(IS2r.RsrvQty)) then begin
								outstring(400,0,"0",false);
							end else begin	
								outstring(400,0,IS2r.Instock-IS2r.RsrvQty-clientres,false);
							end;		
							endformat;
					end;
				end;
			end;	
		end;
		skipcomp:;
	end;
	if(!instock) then begin
		startformat(15);
		outstring(0,0,"   ",false);
		outstring(100,"dblINVc",INr.Code ,false);
		outstring(200,0,INr.Name ,false);
		endformat;		
	end;		
StockInAllCompRnEnd:;

	SetCompany(CompOld,false);
	LogProcTime("StockInAllCompRn",getcurtick()-curtick);
	
endjob;	

return;
end;







global
procedure StockGroupsInAllCompRn(record RcVc RepSpec)
begin
record INVc INr,IN2r;
integer i,CompOld,CompQty;
record DIVc DIr;
boolean testf;
integer pos;
string 100 class, stockGroup, Brand;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
record ItemStatusVc ISr,IS2r;
boolean TrHs, TrHs1;
record LocationVc Locr;
boolean instock;
record BPIBrandVc BPIBrandr;
record BPICollectionVc BPICollectionr;
record BPIGroupVc BPIGroupr;
record BPISubGroupVc BPISubGroupr;
record BPICategoryVc BPICategoryr;
record BPIMaterialVc BPIMaterialr;
record BPIColorVc BPIColorr;
record BPIShapeVc BPIShaper;
record BPISizeVc BPISizer;
record BPIUseVc BPIUser;
record BPISexVc BPISexr;
record BPIPlatingVc BPIPlatingr;
record BPIClarityVc BPIClarityr;
record BPIWeightVc BPIWeightr;
record BPICutVc BPICutr;
record BPIStoneVc BPIStoner;
record BPIStrapVc BPIStrapr;
record BPIOdourVc BPIOdourr;
vector string 255 vClass;
longint curtick;
		
	BlockLoad(Compb);
	
	CompOld = currentcompany;
	CompQty = matrowcnt(Compb);
	
	curtick = getcurtick();
	BPIBrandr.Code = "";
	while (loopMain(BPIBrandr,1,true)) begin 
		vClass [BPIBrandr.Code] = BPIBrandr.Name;
	end;
	
	BPICollectionr.Code = "";
	while (loopMain(BPICollectionr,1,true)) begin 
		vClass [BPICollectionr.Code] = BPICollectionr.Name;
	end;
	BPIGroupr.Code = "";
	while (loopMain(BPIGroupr,1,true)) begin 
		vClass [BPIGroupr.Code] = BPIGroupr.Name;
	end;
	BPISubGroupr.Code = "";
	while (loopMain(BPISubGroupr,1,true)) begin 
		vClass [BPISubGroupr.Code] = BPISubGroupr.Name;
	end;	
	BPICategoryr.Code = "";
	while (loopMain(BPICategoryr,1,true)) begin 
		vClass [BPICategoryr.Code] = BPICategoryr.Name;
	end;	
	BPIMaterialr.Code = "";
	while (loopMain(BPIMaterialr,1,true)) begin 
		vClass [BPIMaterialr.Code] = BPIMaterialr.Name;
	end;	
	BPIColorr.Code = "";
	while (loopMain(BPIColorr,1,true)) begin 
		vClass [BPIColorr.Code] = BPIColorr.Name;
	end;	
	BPIShaper.Code = "";
	while (loopMain(BPIShaper,1,true)) begin 
		vClass [BPIShaper.Code] = BPIShaper.Name;
	end;	
	BPISizer.Code = "";
	while (loopMain(BPISizer,1,true)) begin 
		vClass [BPISizer.Code] = BPISizer.Name;
	end;	
	BPIUser.Code = "";
	while (loopMain(BPIUser,1,true)) begin 
		vClass [BPIUser.Code] = BPIUser.Name;
	end;	
	BPISexr.Code = "";
	while (loopMain(BPISexr,1,true)) begin 
		vClass [BPISexr.Code] = BPISexr.Name;
	end;	
	BPIPlatingr.Code = "";
	while (loopMain(BPIPlatingr,1,true)) begin 
		vClass [BPIPlatingr.Code] = BPIPlatingr.Name;
	end;	
	BPIClarityr.Code = "";
	while (loopMain(BPIClarityr,1,true)) begin 
		vClass [BPIClarityr.Code] = BPIClarityr.Name;
	end;	
	BPICutr.Code = "";
	while (loopMain(BPICutr,1,true)) begin 
		vClass [BPICutr.Code] = BPICutr.Name;
	end;	
	BPIStoner.Code = "";
	while (loopMain(BPIStoner,1,true)) begin 
		vClass [BPIStoner.Code] = BPIStoner.Name;
	end;	
	BPIStrapr.Code = "";
	while (loopMain(BPIStrapr,1,true)) begin 
		vClass [BPIStrapr.Code] = BPIStrapr.Name;
	end;	
	BPIOdourr.Code = "";
	while (loopMain(BPIOdourr,1,true)) begin 
		vClass [BPIOdourr.Code] = BPIOdourr.Name;
	end;	
	vClass [""] = "";

	StartReportnoheaderjob("   ");
		startformat(15);
			outstring(4,0," ",false);
			outstring(50,0,"",false);
			outstring(120,0,".",false);
			outstring(180,0,".",false);
			outstring(300,0," ",false);
			outstring(350,0,"",false);
			outstring(400,0,"",false);
			outstring(400,0,"",false);
			outstring(400,0,"",false);
			outstring(400,0,"Brand",false);
			outstring(400,0,"Collection",false);
			outstring(400,0,"Group",false);
			outstring(400,0,"SubGroup",false);
			outstring(400,0,"Category",false);
			outstring(400,0,"Material",false);
			outstring(400,0,"Color",false);
			outstring(400,0,"Shape",false);
			outstring(400,0,"Size",false);
			outstring(400,0,"Use",false);
			outstring(400,0,"Sex",false);
			outstring(400,0,"Plating",false);
			outstring(400,0,"Clarity",false);
			outstring(400,0,"Weight",false);
			outstring(400,0,"Cut",false);
			outstring(400,0,"Stone",false);
			outstring(400,0,"Strap",false);
			outstring(400,0,"Odour",false);
		endformat;	
		for (i=0;i<CompQty;i=i+1)begin
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0)then begin
				SetCompany(i+1,false);
				logtext(0,i+1 & " - company StockGroupsInAllCompRn");
				TrHs = true;
				switch (currentcompany) begin
						case 4: stockGroup = "Sonata MMC"; 
						case 8: stockGroup = "Sonata MMC";
						case 7: stockGroup = "Eleqant R MMC";
						case 5: stockGroup = "Eleqant R MMC";
						case 2: stockGroup = "Eleqant R MMC";
						case 1: stockGroup = "Eleqant R MMC";
						case 16: stockGroup = "Ellips MMC";
						case 25: stockGroup = "Ellips MMC";
						case 3: stockGroup = "Islahat MMC";
						case 24: stockGroup = "Islahat MMC";
						case 20: stockGroup = "Islahat MMC";
						case 17: stockGroup = "Islahat MMC";
						case 23: stockGroup = "Islahat MMC";
						case 21: stockGroup = "Islahat MMC";
						case 22: stockGroup = "Islahat MMC";
						case 19: stockGroup = "hef-doeuvre MMC";
						case 28: stockGroup = "Italdizain QSC";
						case 31: stockGroup = "Italdizain QSC";
						case 13: stockGroup = "Italdizain QSC";
						case 30: stockGroup = "Italdizain QSC";
				end;
				INr.Code = "";
				while (loopMain(INr,1,TrHs)) begin
					if(currentcompany==18)then begin
						BPIBrandr.Code = INr.BPIBrand;
						if(ReadFirstMain(BPIBrandr,1,true))then begin
							stockGroup = BPIBrandr.StockGroup;
						end;
					end;
					Brand = "";
					pos = 0;
					class = "";
					ExtractObj(INr.DispGroups,pos,class);
					while(nonblank(class))begin
						DIr.Code = class;
						readfirstmain(DIr,1,true);
						if(DIr.CType=="BRAND")then begin
							Brand = DIr.Name;
						end;
						ExtractObj(INr.DispGroups,pos,class);
					end;
					ISr.Code = INr.Code;
					TrHs1 = true;
					while (loopmain(ISr,1,TrHs1)) begin
						testf = true;
						if(ISr.Location==";;;")then begin testf = false; end;
						if(ISr.Instock==0)then begin testf = false; end;
						if(ISr.Code!=INr.Code)then begin TrHs1 = false; end;
						if(blank(stockGroup))then begin testf = false; end;
						if(nonblank(RepSpec.f1) and RepSpec.f1!=stockGroup)then begin testf = false; end;
						if(testf and TrHs1)then begin
							startformat(15);
								outstring(4,0,stockGroup,false);
								outstring(50,0,INr.Code,false);
								outstring(120,0,INr.Name,false);
								outstring(180,0,ISr.Location,false);
								outstring(300,0,ISr.Instock,false);
								outstring(350,0,ISr.RsrvQty,false);
								outstring(400,0,INr.LastPurchPrice,false);
								outstring(400,0,INr.LastPurchCurncyCode,false);
								outstring(500,0,Comprw.CompName,false);
								if(currentcompany==28)then begin
									outstring(4,0,Brand,false);
								end else begin
									outstring(4,0,vClass[INr.BPIBrand],false);
								end;
								outstring(50,0,vClass[INr.BPICollection],false);
								outstring(120,0,vClass[INr.BPIGroup],false);
								outstring(180,0,vClass[INr.BPISubGroup],false);
								outstring(300,0,vClass[INr.BPICategory],false);
								outstring(350,0,vClass[INr.BPIMaterial],false);
								outstring(400,0,vClass[INr.BPIColor],false);
								outstring(500,0,vClass[INr.BPIShape],false);
								outstring(4,0,vClass[INr.BPISize],false);
								outstring(50,0,vClass[INr.BPIUse],false);
								outstring(120,0,vClass[INr.BPISex],false);
								outstring(180,0,vClass[INr.BPIPlating],false);
								outstring(300,0,vClass[INr.BPIClarity],false);
								outstring(350,0,vClass[INr.BPIWeight],false);
								outstring(400,0,vClass[INr.BPICut],false);
								outstring(500,0,vClass[INr.BPIStone],false);
								outstring(180,0,vClass[INr.BPIStrap],false);
								outstring(300,0,vClass[INr.BPIOdour],false);
							endformat;	
						end;
					end;
					resetLoop(ISr);
				end;
				ResetLoop(INr);
			end;
		end;
		ResetCompany(CompOld);
		logtext(0,"StockGroupsInAllCompRn END");
	endjob;	
	LogProcTime("StockGroupsInAllCompRn",getcurtick()-curtick);
return;
end;











global
procedure CodeBrandRn(record RcVc RepSpec)
begin
	record INVc INr;
	integer i, o;
	boolean codef;
	vector string 255 codeBrnd;
	vector integer codeQty;
	longint curtick;
	
	curtick = getcurtick();
	startreportnoheaderjob("Brand report");
	startformat(15);
		outstring(0,0,"Item Code",false);
		outstring(70,0,"Brand Code",false);
	endformat;
	o = currentcompany;
	for(i=0;i<34;i=i+1)begin
		setcompany(i+1,false);
		INr.Code = "";
		while (loopmain(INr,1,true)) begin
			if(!setinset(INr.BPIBrand,codeBrnd[INr.Code]))then begin
				if(blank(codeBrnd[INr.Code]))then begin
					codeBrnd[INr.Code] = INr.BPIBrand;
				end else begin
					codeBrnd[INr.Code] = codeBrnd[INr.Code] & "," & INr.BPIBrand;
					codef = true;
				end;
			end;
			if(codef)then begin
				startformat(15);
					outstring(0,0,INr.Code,false);
					outstring(70,0,INr.BPIBrand,false);
				endformat;
				codef = false;
			end;
		end;
		resetloop(INr);
	end;
	ResetCompany(o);
	endjob;
	logProcTime("CodeBrandRn",getcurtick()-curtick);
return;
end;











global
procedure GlobalNamesGIRn(record RcVc RepSpec)
begin
	record GlobalItemVc GIr;
	integer i, o;
	boolean codef;
	vector string 255 codeBrnd;
	vector integer codeQty;
	
	startreportnoheaderjob("Brand report");
	startformat(15);
		outstring(0,0,"Item Code",false);
		outstring(70,0,"Name EN",false);
		outstring(70,0,"Name RUS",false);
		outstring(70,0,"Name AZ",false);
	endformat;
	GIr.Code = "";
	while (loopMain(GIr,1,true)) begin
		startformat(15);
			outstring(0,0,GIr.Code,false);
			outstring(70,0,GIr.Name,false);
			outstring(70,0,GIr.NameRUS,false);
			outstring(70,0,GIr.NameAZ,false);
		endformat;
	end;
	resetLoop(GIr);
	endjob;
return;
end;










global
updating procedure CopyDebCredToCurrencyDebCred_TRVcMn()
Begin
	record MainVc Mainr;
	record TRVc TRr;
	row TRVc TRrw;
	integer rwcnt,i;
	boolean TrHs;
	
	
	Mainr.AccNumber = "50";
	TrHs = true;
	
	While(LoopMain(Mainr,1,true)) begin
		if (Mainr.AccNumber != "50") then begin
			TrHs = false;	
		end;
		
		if (TrHs) then begin
			TRr.Number = Mainr.TransNr;
			TRr.IntYc = Mainr.IntYc;
			if (ReadFirstMain(TRr,2,true)) then begin
					rwcnt = MatRowCnt(TRr);
					for(i=0; i<rwcnt; i=i+1) begin
						MatRowGet(TRr,i,TRrw);
						if (TRrw.AccNumber=="50"  and  TRrw.Curncy=="AZN") then begin
								TRrw.CurDebVal = TRrw.DebVal;
								TRrw.CurCredVal = TRrw.CredVal;
								MatRowPut(TRr,i,TRrw);
						end;						
					end;
					RecordStore(TRr,true);
			end;
		
		end;
		
		
	end;	


end;


updating
function boolean CreateIPVcFromLoyaltyPoints(longint invoiceNr, val payment,string machine)
begin
	record IPVc IPr,IP2r;
	row IPVc IPrw;
	val chk;
  Boolean installmentf,boolres;
  val fr,to1,to2,b;
  string 20 cur;
  longint res;
  integer rwcnt,i;
  string 100 objects; 
  record TRVc TRr,oldTRr;
  row TRVc TRrw; 
	
	RecordNew(IPr);
	
	IPrw.InvoiceNr = invoiceNr;
	MatRowPut(IPr,0,IPrw);
	PasteInvIn2IPr(IPr,0,IPr.TransDate,chk,false,installmentf);
	MatRowGet(IPr,0,IPrw);
	cur = IPrw.RecCurncy;
	GetFullCurncyRate(cur,currentdate,fr,to1,to2,b,b);
	if(fr==0 or to1==0)then begin
		fr = 1;
		to1 = 1;
	end;
	
	
	IPrw.RecVal = payment*fr/to1;
	matrowput(IPr,0,IPrw);
	IPVc_PasteRecVal(IPr,0);
	IPr.PayMode = "LC";
	IPr.OKFlag = 1;
	
	res = -1;
	res = IPVcRecordCheck(IPr,IP2r,1,1);
	IPr.MachineName = machine;
	if(res==0)then begin
		boolres = RecordInsert(IPr,true);
	end;
	
	
	if (boolres!=false) then begin				//Edit----------------------Dima  02.04.2015
			objects = "";
			TRr.Number = IPr.SerNr;
			TRr.IntYc = IPYc;
			if (ReadFirstMain(TRr,2,true)) then begin
				RecordCopy(oldTRr,TRr);
				rwcnt = MatRowCnt(TRr);
				for(i=0;i<rwcnt;i=i+1) begin
						MatRowGet(TRr,i,TRrw);
						if (nonblank(TRrw.Objects)) then begin
							objects = objects & TRrw.Objects & ",";
						end;	
				end;
				
				for(i=0;i<rwcnt;i=i+1) begin
						MatRowGet(TRr,i,TRrw);
						if (blank(TRrw.Objects)) then begin
							 TRrw.Objects = objects;
							 MatRowPut(TRr,i,TRrw);
							 TRVc_PasteObjects(TRr,i);
						end;
				end;
				RecordUpdate(oldTRr,TRr,true);
			end;
	end;
	
	
CreateIPVcFromLoyaltyPoints = boolres;
return;
end;

global
updating procedure DebtDistribMn(record RcVc RepSpec)
Begin
	integer rwcnt,i;
	boolean TrHs,testf,testf2;
	record CUVc CUr;
	String 100 message;
	record LoyaltyCardVc LCr;
	record ARVc ARr,AR2r;
	record IVVc IVr;
	row IVVc IVrw;
	val sum,totalPrice,coefDiscount,points,restPoints,payment;
	integer serNr;
	longint invnr;
	
	invnr = RepSpec.long2;
	
	if(blank(RepSpec.d1Code)) then begin 
		message = "Empty Customer field";
		goto LDebtDistribMn;
	end;
	
	if(RepSpec.long1==-1) then begin 
		message = "Empty Points field";
		goto LDebtDistribMn;
	end;
	
	CUr.Code = RepSpec.d1Code;
	if(readFirstMain(CUr, 1, true)==false)then begin
		message = "Client code not found";
		goto LDebtDistribMn;
	end;
	
	LCr.CustCode = RepSpec.d1Code;
	if (ReadFirstKey("ActCustCode",LCr,1,true)) then begin
		
		if(LCr.Closed != 0) then begin
			message = "Loyalty card is closed " & LCr.Closed ;
			goto LDebtDistribMn;
		end;
		
		if((LCr.PointsBalance < RepSpec.long1) or (LCr.PointsBalance==0))then begin
			message = "There are less points in the Loyalty card then written.";
		end;
		
		restPoints = RepSpec.long1;
		ARr.CustCode = RepSpec.d1Code;
		TrHs = true;
		while (LoopKey("CustCode",ARr,1,TrHs)) begin
			testf = true;
			if (CUr.Code!=ARr.CustCode) then begin TrHs = false; testf = false; end;
			if (restPoints<=0) then begin TrHs = false; testf = false; end;
			if (ARr.BookRVal<=0) then begin  testf = false; end;
			 
			if (testf) then begin 
				testf2 = true;
				if(invnr>-1 and ARr.InvoiceNr!=invnr)then begin testf2 = false; end;
				
				
				if(testf2)then begin  
					IVr.SerNr = ARr.InvoiceNr;
					if(ReadFirstMain(IVr,1,true)) then begin
						rwcnt = MatRowCnt(IVr);
						totalPrice = 0;
						for(i=0;i<rwcnt;i=i+1) begin
							MatRowGet(IVr,i,IVrw);
							if(IVrw.stp==kInvoiceRowTypeNormal) then begin
								totalPrice = totalPrice + IVrw.Price*IVrw.Quant;
							end;
						end;
						coefDiscount = IVr.Sum4/totalPrice;
						points = round(ARr.BookRVal/coefDiscount,SetRoundModeD(0));
					
						if (points>restPoints) then begin
							points = restPoints;
							payment = Round(points*coefDiscount,SetRoundModeD(0));	
							if (CreateIPVcFromLoyaltyPoints(IVr.SerNr,payment,IVr.MachineName)) then begin
								LCr.PointsBalance = LCr.PointsBalance - points;
								RecordStore(LCr,true);
								restPoints = 0;
								AR2r.InvoiceNr=IVr.SerNr;
								if(!readfirstmain(AR2r,1,true))then begin
									stepback(ARr);
								end;
							end;	
						end else begin	
							payment = ARr.BookRVal;	
							if (CreateIPVcFromLoyaltyPoints(IVr.SerNr,payment,IVr.MachineName)) then begin
								LCr.PointsBalance = LCr.PointsBalance - points;
								RecordStore(LCr,true);
								restPoints = restPoints - points;
								AR2r.InvoiceNr=IVr.SerNr;
								if(!readfirstmain(AR2r,1,true))then begin
									stepback(ARr);
								end;
							end;	
						end;
					end;
				end;				
			end;
		end; 
	end else begin
		message = "Loyalty Card not found or not exist.";
		goto LDebtDistribMn;
	end;
	
	LDebtDistribMn:;
	if (nonblank(message)) then begin Messagebox(0,message); end;
	
end;


global
updating procedure AllAcc_CopyDebCredToCurrencyDebCred_TRVcMn()
Begin
	record TRVc TRr;
	row TRVc TRrw;
	record BaseCurBlock BCb;
	record CompaniesBlock CBb;
	row CompaniesBlock CBrw;
	integer rwcnt,i,j,mtrw;
	boolean TrHs,rec;
	integer CurCompany;
	

	  
	  		BlockLoad(BCb);
				TrHs = true;	
				While(LoopMain(TRr,1,TrHs)) begin
					
					if (TrHs) then begin
  			
								rwcnt = MatRowCnt(TRr);
								rec = false;
								for(i=0; i<rwcnt; i=i+1) begin
									MatRowGet(TRr,i,TRrw);
									if ((blank(TRrw.CurDebVal) and blank(TRrw.CurCredVal)) and (TRrw.Curncy==BCb.BaseCur1 or blank(TRrw.Curncy))) then begin
											TRrw.CurDebVal = TRrw.DebVal;
											TRrw.CurCredVal = TRrw.CredVal;
											rec = true;
											if (blank(TRrw.Curncy)) then begin
													TRrw.Curncy = BCb.BaseCur1;
											end;
											MatRowPut(TRr,i,TRrw);
									end;
									if(blank(TRrw.Curncy))then begin
										TRrw.Curncy = BCb.BaseCur1;
										rec = true;
										MatRowPut(TRr,i,TRrw);
									end;										
								end;
								if(TRr.DiffVal!=0)then begin
									TRr.DiffVal=blankval;
									rec = true;
								end;
								if(TRr.Diff2Val!=0)then begin
									TRr.Diff2Val=blankval;
									rec = true;
								end;
								if (rec) then begin
									RecordStore(TRr,true);
								end;	
												
					end;		
					
				end;			


end;


global updating procedure SetBackSalesGroupVcMn(record RcVc RepSpec)
begin
	record IVVc IVr;
	
	
	while(loopmain(IVr,1,true))begin
		if(blank(IVr.SalesGroup))then begin
			switch(IVr.MachineName)begin
				case"JW1":IVr.SalesGroup = "GJW1";recordstore(IVr,true);
				case"JW2":IVr.SalesGroup = "GJW2";recordstore(IVr,true);
				case"JW3":IVr.SalesGroup = "GJW3";recordstore(IVr,true);
				case"JW4":IVr.SalesGroup = "GJW4";recordstore(IVr,true);
				case"JW5":IVr.SalesGroup = "GJW5";recordstore(IVr,true);
				case"JW6":IVr.SalesGroup = "GJW6";recordstore(IVr,true);
				case"JW7":IVr.SalesGroup = "GJW7";recordstore(IVr,true);
				case"JW8":IVr.SalesGroup = "GJW8";recordstore(IVr,true);
			end;
		end;
	end;
	

return;
end;

//Edit-------------------Vitalii 13:02 08.09.2015
updating procedure CheckAndCreateClassificationTest(string class,string classname,string classtype)
begin
	boolean res;
	record DIVc DIr;
	record CTypeVc CTyper;
	string 200 newclassname,c;
	integer i,lenth,zercnt;
	boolean testf;
	res = false;

	DIr.Code = class;
	if (readfirstmain(DIr,1,true)) then begin
		res = true;
	end;
	DIr.Name = class;
	if (readfirstkey("Name",DIr,1,true)) then begin
		res = true;
	end;
	DIr.Name = StrReplace(class,"_"," ");
	if (readfirstkey("Name",DIr,1,true)) then begin
		res = true;
	end;
	if (res==false) then begin
		recordnew(DIr);
		DIr.Code = class;
		DIr.Name = classname;
		DIr.CType = classtype;
		recordStore(DIr,true);
	end;
	return;
end;
//Edit-------------------Vitalii 13:02 08.09.2015


//Edit***************************Sasha2,18:11 20.04.2015 {
updating procedure LookUpClassAndGroups(var record INVc INr,integer currcomp,array string arrClass,array string arrClassName,array string arrClassType,integer acNum,string groupCode,string groupComment)//Edit-------------------Vitalii 16:57 08.09.2015
begin
	record DIVc DIr;
	record ITVc ITr;
	string 100 tclass,fullclass;
	boolean findclass,foundgroup;
	integer k,lenth;
	if(currcomp!=13)then begin
		INr.DispGroups = "";
		for (k=0;k<acNum;k=k+1) begin
			findclass = false;
			CheckAndCreateClassificationTest(arrClass[k],arrClassName[k],arrClassType[k]);
			DIr.Code = arrClass[k];
			if (readfirstmain(DIr,1,true) and !setinset(DIr.Code,INr.DispGroups)) then begin
				INr.DispGroups = INr.DispGroups & DIr.Code & ",";
				findclass = true;
			end;
			if !findclass then begin
				DIr.Name = arrClass[k];
				if (readfirstkey("Name",DIr,1,true) and !setinset(DIr.Code,INr.DispGroups)) then begin
					INr.DispGroups = INr.DispGroups & DIr.Code & ",";
					findclass = true;
				end;
			end;
		end;
		for(k=0;k<acNum;k=k+1) begin
			findclass = false;
			CheckAndCreateClassificationTest(arrClass[k],arrClassName[k],arrClassType[k]);
			DIr.Name = arrClassName[k];
			if (readfirstkey("Name",DIr,1,true)) then begin
				findclass = true;
			end;
			if !findclass then begin
				CheckAndCreateClassificationTest(arrClass[k],StrReplace(arrClassName[k],"_"," "),arrClassType[k]);
				DIr.Name = StrReplace(arrClassName[k],"_"," ");
				if (readfirstkey("Name",DIr,1,true)) then begin
					findclass = true;
				end;
			end;
			if (findclass and !setinset(DIr.Code,INr.DispGroups)) then begin
				INr.DispGroups = INr.DispGroups & DIr.Code & ",";
			end;
		end;
	end;
	if(mid(INr.DispGroups,len(INr.DispGroups)-1,1)==",") then begin
		INr.DispGroups = mid(INr.DispGroups,0,len(INr.DispGroups)-1);
	end;

	ITr.Code = groupCode;
	if(readfirstmain(ITr,1,true)) then begin
		INr.Group = ITr.Code;
		foundgroup = true;
	end; 
	if !foundgroup then begin
		ITr.Comment = groupComment;
		if(readlastkey("Comment",ITr,1,true)) then begin
			INr.Group = ITr.Code;
			foundgroup = true;
		end;
	end;
	if !foundgroup then begin
		ITr.Code = StrReplace(mid(groupComment,0,5)," ","_");
		if(readfirstmain(ITr,1,true)) then begin
			INr.Group = ITr.Code;
			foundgroup = true;
		end; 
	end;
	if !foundgroup then begin
		ITr.Code = groupCode;
		ITr.Comment = groupComment;
		recordStore(ITr,true);
		INr.Group = ITr.Code;
	end;
	return;
end; //Edit***************************Sasha2,18:11 20.04.2015 }






procedure updating AddFormulaToPricelist(string groupCode,record PFormVc PFormr)		//Edit----------------------Dima  14.09.2015
begin
  record PLDefVc PLdefr;
  row PLDefVc PLDefrw,PLDefrwNew;
  record PFormVc PForm2r,PFormrNew;
  integer rwcnt2,j;
  boolean found;
  
  found = false;
  PLdefr.Code = "RRP";
  	if (ReadFirstMain(PLdefr,1,true)) then begin
			rwcnt2 = MatRowCnt(PLdefr);
			for(j=0;j<rwcnt2;j=j+1) begin
				MatRowGet(PLdefr,j,PLDefrw);
				if (PLDefrw.ItemCode==groupCode) then begin
						j=rwcnt2;
						found = true;
				end;
			end;
			if (found==false) then begin
				PForm2r.Code = PFormr.Code;
				if (ReadFirstMain(PForm2r,1,true)) then Begin					
				end else begin
					RecordCopy(PFormrNew,PFormr);
					RecordInsert(PFormrNew,true);
				end;
				
				if (rwcnt2>0) then begin
					MatRowGet(PLdefr,0,PLDefrw);
					CopyRow(PLdefr,PLDefrw,PLDefrwNew);
					PLDefrwNew.ItemCode = groupCode;
					PLDefrwNew.Formula = PFormr.Code;
					MatRowInsert(PLdefr,rwcnt2,PLDefrwNew);
					RecordStore(PLdefr,true);
				end;					
			end;			
		end; 	  

end;

//Edit***************************Sasha2,11:38 18.03.2016 {
procedure SplitIVrByCurrency(var array record IVVc curIV,record IVVc IVr,var array string currs,var Integer curcnt)
begin
  record ItemHistVc IHr;
  vector boolean curIncluded;
  Vector string 10 curindex;
  record IVVc vectIVr;
  row IVVc vectIVrw,IVrw;
  Boolean TrHs;
  Integer rwcnt;
  val qty;
    
    IHr.FileName = "IVVc";
    IHr.TransNr = IVr.SerNr;
    TrHs = true;
    while (LoopKey("FNTransNr",IHr,2,TrHs)) begin
      if (IHr.FileName!="IVVc" or IHr.TransNr!=IVr.SerNr) then begin TrHs = false; end;
      if (TrHs) then begin
      	if(blank(IHr.CurncyCode))then begin
      		IHr.CurncyCode = "AZN";
      	end;
        if (curIncluded[IHr.CurncyCode]) then begin
          vectIVr = curIV[curindex[IHr.CurncyCode]];
        end else begin
          RECORDNEW(vectIVr);
          vectIVr.CustCode = IVr.CustCode;
          vectIVr.SerNr = IVr.SerNr;
          vectIVr.PriceList = IVr.PriceList;
          if(blank(IHr.CurncyCode))then begin
          	IHr.CurncyCode = "AZN";
          end;
          vectIVr.CurncyCode = IHr.CurncyCode;
          curIncluded[IHr.CurncyCode] = true;
          currs[curcnt] = IHr.CurncyCode;
          curindex[IHr.CurncyCode] = curcnt;
          curcnt = curcnt + 1;
        end;
        rwcnt = MatRowCnt(vectIVr);
        ClearRow(vectIVr,vectIVrw,1);
        qty = -IHr.Qty;
        vectIVrw.ArtCode = IHr.ArtCode;
        vectIVrw.Quant = qty;
        vectIVrw.FIFO = IHr.TotCostPrice/qty;
        vectIVrw.FIFORowVal = IHr.TotCostPriceCurncy/qty;
        MatRowGet(IVr,IHr.Row,IVrw);
        vectIVrw.Sum = (IVrw.Sum/IVrw.Quant)*qty;
        MatRowPut(vectIVr,rwcnt,vectIVrw);
        curIV[curindex[IHr.CurncyCode]] = vectIVr;
      end;
    end;
  
  return;
end; //Edit***************************Sasha2,11:38 18.03.2016 }

global
updating procedure DelBadIHrec363Mn()
begin
  record ItemHistVc IHr;
  vector boolean curIncluded;
  Vector string 10 curindex;
  record IVVc vectIVr;
  row IVVc vectIVrw,IVrw;
  Boolean TrHs;
  Integer rwcnt;
  val qty;
    
    /*IHr.FileName = "PUVc";
    IHr.TransNr = 363;
    TrHs = true;
    while (LoopKey("FNTransNr",IHr,2,TrHs)) begin
      if (IHr.FileName!="PUVc" or IHr.TransNr!=363) then begin TrHs = false; end;
      if (TrHs) then begin
        recorddelete(IHr);
        stepback(IHr);
      end;
    end;*/
  
  return;
end;


global //Edit***************************Sasha2,11:25 07.04.2015 {
updating procedure CreatePufromIVforPLHandle(record RcVc RepSpec,integer curcomp,var string errmsg)
begin
  record IVVc IVr;
  row IVVc IVrw;
  record PUVc PUr;
  row PUVc PUrw;
  record INVc INr,IN2r;
  record DIVc DIr;//Edit-------------------Vitalii 14:19 08.09.2015
  record ITVc ITr;//Edit-------------------Vitalii 14:19 08.09.2015
  array string 10 arrClass;//Edit-------------------Vitalii 14:23 08.09.2015
  array string 50 arrClassName;//Edit-------------------Vitalii 14:23 08.09.2015
  array string 10 arrClassType;//Edit-------------------Vitalii 14:28 09.09.2015
  string 5 groupCode;//Edit-------------------Vitalii 9:28 09.09.2015
  string 50 groupComment;//Edit-------------------Vitalii 9:28 09.09.2015
  integer i,k,rwcnt,lenth,acNum;
  string 255 warning,inwarn,compname,tstr,VECode;
  string 100 tclass,fullclass;
  record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  val p,s,totpucost,diffval,t,totivsum;
  Boolean chsum,findclass,tocompf;
  record PLDefVc PLdefr;
  row PLDefVc PLDefrw;
  record PFormVc PFormr;		//Edit----------------------Dima  14.09.2015
  integer rwcnt2,j,m,curcnt;
  record VIVc VIr; //Edit***************************Sasha2,17:37 09.02.2016
  row VIVc VIrw; //Edit***************************Sasha2,17:37 09.02.2016
  LongInt newnr; //Edit***************************Sasha2,17:40 09.02.2016
  record SRBlock SRRec; //Edit***************************Sasha2,17:40 09.02.2016
  record BaseCurBlock BCb,targetBCb; //Edit***************************Sasha2,10:07 10.02.2016
  record LocationVc Locr,Loc1r; //Edit***************************Sasha2,13:46 10.02.2016
  array record IVVc curIV; //Edit***************************Sasha2,11:35 18.03.2016
  array string 20 currs; //Edit***************************Sasha2,14:47 18.03.2016
  val fr,to1,to2,br1,br2; //Edit***************************Sasha2,15:14 18.03.2016
  string 5 curcode,sourcecurcode; //Edit***************************Sasha2,15:14 18.03.2016
	record ConsCompBlock CCBb;
  record StockMovVc StockMovr;
	row StockMovVc StockMovrw;
	array string 255 aWarning;
	boolean testCoinItems;
	record CoinEANCodeVc CoinEANCoder;
	integer stockRow;
	
		BlockLoad(CCBb);
    IVr.SerNr = RepSpec.long1;
    ReadFirstMain(IVr,1,true);
    sourcecurcode = IVr.CurncyCode;
    BlockLoad(BCb);
    if (SetCompanyCode("" & RepSpec.flags[0],false)) then begin
	
      BlockLoad(targetBCb);
      RESETCOMPANY(curcomp);
    end else begin
      errmsg = "Switching to target company failed";
      goto LCreatePufromIVforPLHandle1;
    end;
     
    BlockLoad(Compb);
    rwcnt = matrowcnt(Compb);
    for(i=0;i<rwcnt;i=i+1)begin
  		matrowget(Compb,i,Comprw);
  		if(CurrentCompany==(i+1))then begin
        compname = Comprw.CompName;
        i = rwcnt;
  		end;
  	end;
  	Loc1r.Code = IVr.Location;
		if(ReadFirstMain(Loc1r,1,true)) then begin
			if(nonblank(Loc1r.FOBSuplier)) then begin
				VECode = Loc1r.FOBSuplier;
			end;	
		end;	
  	SplitIVrByCurrency(curIV,IVr,currs,curcnt);
  	for (m=0;m<curcnt;m=m+1) begin
    	tocompf = false;
    	if (SetCompanyCode("" & RepSpec.flags[0],false)) then begin
    	  IVr = curIV[m];
        RECORDNEW(PUr);
		Locr.Code = RepSpec.f1;
		if(ReadFirstMain(Locr,1,true))then begin
			PUr.Location = Locr.Code;
			PUVc_PasteLocation(PUr,-1);
		end else begin
			messagebox(0,"  !");
			goto LCreatePufromIVforPLHandle1;
		end;
		if(blank(VECode)) then begin
			PUr.VECode = IVr.CustCode;
			PUVc_PasteVECode(PUr);
		end else begin
			PUr.VECode = VECode;
			PUVc_PasteVECode(PUr);
		end;	
        PUr.VEName = "Invoice # " & IVr.SerNr & " from company " & compname & " (" & (m+1) & " Receipt from " & curcnt & ")";
        if (currs[m]!=targetBCb.BaseCur1) then begin
          curcode = currs[m];
          fr = blankval;
          to1 = blankval;
          to2 = blankval;
          br1 = blankval;
          br2 = blankval;
          GetFullCurncyRate(curcode,PUr.TransDate,fr,to1,to2,br1,br2);
          if (curcode!=currs[m]) then begin
            errmsg = "No currency " & currs[m] & " in target company";
            goto LCreatePufromIVforPLHandle1;
          end;
          PUr.CurncyCode = curcode;
          PUr.FrRate = fr;
          PUr.ToRateB1 = to1; 
          PUr.ToRateB2 = to2;
          PUr.BaseRate1 = br1;
          PUr.BaseRate2 = br2;
        end;
        if (PUr.SerNr<=0) then begin
           PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,-1,false,"");
        end;
        totivsum = 0;
        RESETCOMPANY(curcomp);
        tocompf = true;
      end;
      
      if (tocompf) then begin
        rwcnt = MatRowCnt(IVr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(IVr,i,IVrw);
          if (NonBlank(IVrw.ArtCode)) then begin
            //ClearStringArray(arrClass);
        		//ClearStringArray(arrClassName);
        		
        		acNum = 0;
        		groupCode = "";
        		groupComment = "";
        		INr.Code = IVrw.ArtCode;
            ReadFirstMain(INr,1,true);
        		fullclass = INr.DispGroups;
        		fullclass = uppercase(fullclass);
        		INr.DispGroups = "";
        		k = 0;
        		ExtractObj(fullclass,k,tclass);
        		while (NonBlank(tclass)) begin
        		  findclass = false;
      				DIr.Code = tclass;
      				if(readfirstmain(DIr,1,true)) begin
      					arrClass[acNum] = DIr.Code;
      					arrClassName[acNum] = DIr.Name;
      					arrClassType[acNum] = DIr.CType;
      					acNum = acNum + 1;
      					findclass = true;
      				end;
      				if(findclass)then begin
      					DIr.Name = tclass;
      					if(readfirstkey("Name",DIr,1,true)) then begin
      						arrClass[acNum] = DIr.Code;
      						arrClassName[acNum] = DIr.Name;
      						arrClassType[acNum] = DIr.CType;
      						acNum = acNum + 1;
      						findclass = true;
      					end;
      				end;
        		  ExtractObj(fullclass,k,tclass);
        		end;

        		groupCode = INr.Group;
        		ITr.Code = groupCode;
        		readfirstmain(ITr,1,true);
        		groupComment = ITr.Comment;
        		
        		//For PriceList updating  ___Edit----------------------Dima  14.09.2015
          	PLdefr.Code = "RRP";
          	if (ReadFirstMain(PLdefr,1,true)) then begin
        			rwcnt2 = MatRowCnt(PLdefr);
        			for(j=0;j<rwcnt2;j=j+1) begin
        				MatRowGet(PLdefr,j,PLDefrw);
        				if (PLDefrw.ItemCode==groupCode) then begin
        						PFormr.Code = PLDefrw.Formula;
        						ReadFirstMain(PFormr,1,true);
        				end;
        			end;
        		end;
						if(CCBb.OKFlag==1)then begin
							if (SetCompanyCode("" & RepSpec.flags[0],false)) then begin
								//AddFormulaToPricelist(groupCode,PFormr);	//Edit----------------------Dima  14.09.2015
								//AddFormulaToPricelist commented // Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 29 October 2018 15:13:32
								IN2r.Code = INr.AlternativeCode;
								if (!ReadFirstMain(IN2r,1,true)) then begin
									IN2r.Code = INr.Code;
									if(!ReadFirstMain(IN2r,1,true))then begin
										RecordNew(IN2r);
										RecordCopy (IN2r,INr);
										LookUpClassAndGroups(IN2r,curcomp,arrClass,arrClassName,arrClassType,acNum,groupCode,groupComment);
										RECORDSTORE(IN2r,false);
									end;
								end else begin
									if(IN2r.BPIBrand!=INr.BPIBrand)then begin
										IN2r.Code = INr.Code;
										if(!ReadFirstMain(IN2r,1,true))then begin
											RecordNew(IN2r);
											RecordCopy (IN2r,INr);
											LookUpClassAndGroups(IN2r,curcomp,arrClass,arrClassName,arrClassType,acNum,groupCode,groupComment);
											RECORDSTORE(IN2r,false);
										end;
									end;
								end;
								ClearRow(PUr,PUrw,1);
								PUrw.ArtCode = INr.Code;
								MatRowPut(PUr,i,PUrw);
								PUVc_PasteArtCode(PUr,i,warning,inwarn);
								MatRowGet(PUr,i,PUrw);
								PUrw.Quant = IVrw.Quant;
								MatRowPut(PUr,i,PUrw);
								//PUVc_PasteQuant(PUr,i);//Commented Edit ************************** BPI Ukraine - KramarAlexandr - 02, 06 08 2019 y. at 3:34:00 PM
								MatRowGet(PUr,i,PUrw);
								PUrw.UPrice = IVrw.FIFORowVal;
								PUrw.SerialNr = IVrw.SerialNr;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 25 09 2019 y. at 9:41:17 AM
								/*PUCalcCostPrice(PUrw.ArtCode,PUrw.UPrice,PUr.InclVAT,PUr.NoTAXonVAT,PUrw.Extra,PUr.CurncyCode,
												PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,
												PUrw.ShipCost,PUrw.RowCost1,PUrw.RowCost2,PUrw.RowCost3,PUrw.RowCost4,PUrw.RowCost5,
												PUrw.CustomsCost,p,PUrw.Quant,s,PUrw.VATCode,PUr.ExportFlag);
								PUrw.CostPrice = p;
								PUrw.Sum = s;*/
								PUrw.CostPrice = IVrw.FIFO;
								MatRowPut(PUr,i,PUrw);
								PUVc_PasteCostPrice(PUr,i);
								MatRowGet(PUr,i,PUrw);
								PUrw.Extra = blankval;// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 1 August 2019 16:24:38
								//s = IVrw.FIFO*IVrw.Quant;
								//PUrw.Sum = s;
								totivsum = totivsum + Round(IVrw.Sum,DefaultRoundMode);
								chsum = true;
								MatRowPut(PUr,i,PUrw);
								RESETCOMPANY(curcomp);
							end;
						end else begin
							if (SetCompanyCode("" & RepSpec.flags[0],false)) then begin
								//AddFormulaToPricelist(groupCode,PFormr);	//Edit----------------------Dima  14.09.2015
								//AddFormulaToPricelist commented // Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 29 October 2018 15:13:32
								IN2r.Code = IVrw.ArtCode;
								if (!ReadFirstMain(IN2r,1,true)) then begin
									LookUpClassAndGroups(INr,curcomp,arrClass,arrClassName,arrClassType,acNum,groupCode,groupComment);
									RECORDSTORE(INr,false);
								end;
								ClearRow(PUr,PUrw,1);
								k = MatRowCnt(PUr);
								PUrw.ArtCode = IVrw.ArtCode;
								MatRowPut(PUr,k,PUrw);
								PUVc_PasteArtCode(PUr,k,warning,inwarn);
								MatRowGet(PUr,k,PUrw);
								PUrw.Quant = IVrw.Quant;
								MatRowPut(PUr,k,PUrw);
								//PUVc_PasteQuant(PUr,k);//Commented Edit ************************** BPI Ukraine - KramarAlexandr - 02, 06 08 2019 y. at 3:34:03 PM
								MatRowGet(PUr,k,PUrw);
								PUrw.UPrice = IVrw.FIFORowVal;
								PUrw.SerialNr = IVrw.SerialNr;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 25 09 2019 y. at 9:41:17 AM
								/*PUCalcCostPrice(PUrw.ArtCode,PUrw.UPrice,PUr.InclVAT,PUr.NoTAXonVAT,PUrw.Extra,PUr.CurncyCode,
												PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,
												PUrw.ShipCost,PUrw.RowCost1,PUrw.RowCost2,PUrw.RowCost3,PUrw.RowCost4,PUrw.RowCost5,
												PUrw.CustomsCost,p,PUrw.Quant,s,PUrw.VATCode,PUr.ExportFlag);
								PUrw.CostPrice = p;
								PUrw.Sum = s;*/
								PUrw.CostPrice = IVrw.FIFO;
								MatRowPut(PUr,k,PUrw);
								PUVc_PasteCostPrice(PUr,k);
								MatRowGet(PUr,k,PUrw);
								PUrw.Extra = blankval;// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 1 August 2019 16:24:38
								//s = IVrw.FIFO*IVrw.Quant;
								//PUrw.Sum = s;
								totivsum = totivsum + Round(IVrw.Sum,DefaultRoundMode);
								chsum = true;
								MatRowPut(PUr,k,PUrw);
								
								matrowget(PUr,k,PUrw);
								RESETCOMPANY(curcomp);
							end;
						end;
          end;
        end;
        if (SetCompanyCode("" & RepSpec.flags[0],false)) then begin
          if (NonBlank(Locr.Objects)) then begin
            rwcnt = MatRowCnt(PUr);
            for (i=0;i<rwcnt;i=i+1) begin
              matrowget(PUr,i,PUrw);
              if (NonBlank(PUrw.Objects)) then begin
                PUrw.Objects = PUrw.Objects & "," & Locr.Objects;
              end else begin
                PUrw.Objects = Locr.Objects;
              end;
              matrowput(PUr,i,PUrw);
            end;
          end;
          if (chsum) then begin
            PUSumUp(PUr);
          end;
          if (RECORDSTORE(PUr,false)) then begin
						CreateRecordLink(IVr,curcomp,PUr,RepSpec.flags[0]);
						CreateRecordLink(PUr,RepSpec.flags[0],IVr,curcomp);
            if(currentcompany==25 and (IVr.CustCode=="FOB_CASACOIN1" or IVr.CustCode=="FOB_CASACOIN2")) then begin
							RecordNew(StockMovr); 
							IVr.SerNr = RepSpec.long1;
							ReadFirstMain(IVr,1,true);
							StockMovr.TypeCoin = 5;
							StockMovr.FrLocation = IVr.Location;
							StockMovr.ToLocation = RepSpec.f1;
							StockMovr.TransDate = CurrentDate;
							StockMovr.SentCoin = 1;
							StockMovr.SerNr = NextSerNr("StockMovVc",StockMovr.TransDate,-1,false,"");
							StockMovr.Comment = "Transfer to DROMAS";
							rwcnt = MatRowCnt(IVr);
							stockRow = 0;
							for (i=0;i<rwcnt;i=i+1) begin
								matrowget(IVr,i,IVrw);
								testCoinItems = true;
								INr.Code = IVrw.ArtCode;
								if(ReadFirstMain(INr,1,true)) then begin
									StockMovrw.BarCode = INr.BarCode;
									if(len(StockMovrw.BarCode)!=13) then begin
										testCoinItems = false;
									end;
								end;
								if(testCoinItems) then begin
									CoinEANCoder.EANNumber = StockMovrw.BarCode;
									if(ReadFirstKey("EANNumber",CoinEANCoder,1,true)) then begin
										matrowput(StockMovr,stockRow,StockMovrw);
										StockMovrw.Quant = IVrw.Quant;
										matrowput(StockMovr,stockRow,StockMovrw);
										StockMovVc_PasteQuant(StockMovr,stockRow);
										StockMovrw.ArtCode = IVrw.ArtCode;
										matrowput(StockMovr,stockRow,StockMovrw);
										StockMovVc_PasteArtCode(StockMovr,stockRow,1,aWarning);
										matrowget(StockMovr,stockRow,StockMovrw);
										matrowput(StockMovr,stockRow,StockMovrw);
										stockRow = stockRow + 1;
									end;	
								end;	
							end;	
							if(matrowcnt(StockMovr)>0)then begin
								if(RecordStore(StockMovr,true)) then begin 
									CreateRecordLink(IVr,CurrentCompany,StockMovr,CurrentCompany);  
									CreateRecordLink(StockMovr,CurrentCompany,IVr,CurrentCompany);  
								end;
							end;	
						end;
            RECORDNEW(VIr);
            PastePUInVI(PUr,VIr,warning,false,false,false,false,false,false,false,false,IVr.PriceList); //Edit***************************Sasha2,17:13 18.03.2016
            if (VIr.SerNr<=0) then begin
              newnr = GetCurUserLastNr("VIVc");
              if (newnr==-1) then begin
                newnr = SRRec.LastVINr;
              end;
              VIr.SerNr = NextSerNr("VIVc",VIr.TransDate,newnr,false,"");
            end;  
            if (VIr.SerNr<=0) then begin goto LCreatePufromIVforPLHandle; end;  
            if (MatRowCnt(VIr)>0) then begin
              rwcnt = MatRowCnt(VIr);
              totpucost = 0;
              for (i=0;i<rwcnt;i=i+1) begin
                matrowget(VIr,i,VIrw);
                if(VIrw.stp==1)then begin
									totpucost = totpucost + VIrw.Sum;
                end;
              end;
              diffval = totivsum - totpucost;
              if (diffval!=0) then begin
                ClearRow(VIr,VIrw,1);
                VIrw.AccNumber = "76";
                if (GetAccName(VIrw.AccNumber,tstr,60)) then begin end;
                VIrw.Comment = tstr; 
                VIrw.Objects = "128";
                VIrw.Sum = diffval;
                VIrw.qty = 1;
								VIrw.Objects = NormalizeSetString(VIrw.Objects);// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 3 April 2018 14:02:28
                MatRowPut(VIr,MatRowCnt(VIr),VIrw);
                VIr.PayVal = VIr.PayVal + diffval;
                if (NonBlank(Locr.Objects)) then begin
                  rwcnt = MatRowCnt(VIr);
                  for (i=0;i<rwcnt;i=i+1) begin
                    matrowget(VIr,i,VIrw);
                    if(!SetinSet(Locr.Objects,VIrw.Objects))then begin
											if (NonBlank(VIrw.Objects)) then begin
												VIrw.Objects = VIrw.Objects & "," & Locr.Objects;
											end else begin
												VIrw.Objects = Locr.Objects;
											end;
                    end;
                    VIrw.Objects = NormalizeSetString(VIrw.Objects);
                    matrowput(VIr,i,VIrw);
                  end;
                end;
                VICalcVals(VIr);
                VISumup(VIr,t);
              end;
              if (RecordStore(VIr,false)) then begin
                CreateRecordLink(PUr,CurrentCompany,VIr,CurrentCompany);  
                CreateRecordLink(VIr,CurrentCompany,PUr,CurrentCompany);  
              end;
            end;
            
LCreatePufromIVforPLHandle:;
    
            if (BCb.BaseCur1!=sourcecurcode or BCb.BaseCur1!=targetBCb.BaseCur1) then begin
              errmsg = "Source company currency does not match with source Invoice currency or target Receipt currency";
            end;
          end;
          RESETCOMPANY(curcomp);
        end;
      end else begin
        errmsg = "Switching to target company failed";
        goto LCreatePufromIVforPLHandle1;
      end;
  	end;

LCreatePufromIVforPLHandle1:;
    
  return;
end; //Edit***************************Sasha2,11:25 07.04.2015 }





global updating procedure SetEURBinPricesMn(record RcVc RepSpec)	//Edit----------------------Dima  17.04.2015
begin
	record PLVc PLr;
	record INVc INr;
	
	if (CurrentCompany==3) then begin //Jewellery

		While(LoopMain(PLr,1,true)) begin	
			INr.Code = PLr.ArtCode;
			if (ReadFirstMain(INr,1,true)) begin
				if (SetInSet("CARTIER",INr.DispGroups)) then begin
						PLr.CurncyCode = "EURB";	
						RecordStore(PLr,true);
						UpdatePrice(PLr);
				end;
			end;	
		end;
	
	end;

return;
end;


global updating procedure SetCurrencyinPricesMn(record RcVc RepSpec)	//Edit----------------------Dima  17.04.2015
begin
	record PLVc PLr;
	record INVc INr;
	record DIVc DIr;
	
	string 30 brand,curncy;
	
	brand = RepSpec.f1;
	curncy = RepSpec.f2;
	
	DIr.Code = brand;
	if (ReadFirstMain(DIr,1,true)) then begin
		if (DIr.CType!="BRAND") then begin
			LogText(0,"The type of classification isn't a brand");		
			goto LSetCurrencyinPricesMn;
		end;	
	end;
	
	if (CurrentCompany==3) then begin //Jewellery

		While(LoopMain(PLr,1,true)) begin	
			INr.Code = PLr.ArtCode;
			if (ReadFirstMain(INr,1,true)) begin
				if (SetInSet(brand,INr.DispGroups)) then begin
						PLr.CurncyCode = curncy;	
						RecordStore(PLr,true);
						UpdatePrice(PLr);
				end;
			end;	
		end;
	
	end;

LSetCurrencyinPricesMn:;
return;
end;

global updating procedure FixStockMovMn()
begin
	record StockMovVc SMr;
	row StockMovVc SMrw;
	record ItemHistVc IHr;
	integer i,mtrw;
	boolean TrHs,testf,changed;
	val outcost;
	
	SMr.TransDate = stringtodate("10/04/2015");
	while(loopkey("TransDate",SMr,1,true))begin
		changed = false;
		mtrw = matrowcnt(SMr);
		For(i=0;i<mtrw;i=i+1) begin
	  	matrowget(SMr,i,SMrw);
	  	if(SMrw.Quant>0)then begin
	  		IHr.FileName = "StockMovVc";
	  		IHr.TransNr = SMr.SerNr;
	  		IHr.Row = i;
	  		TrHs = true;
	  		outcost = blankval;
	  		while(loopkey("FNTransNr",IHr,3,TrHs))begin
	  			if(IHr.FileName!="StockMovVc" or IHr.TransNr!=SMr.SerNr or IHr.Row!=i)then begin TrHs = false; end;
	  			
	  			if(TrHs and SMr.FrLocation==IHr.Location)then begin
	  				if(IHr.Qty<0)then begin
	  					outcost = outcost + IHr.TotCostPrice;
	  				end;
	  			end;
	  		end;
	  		resetloop(IHr);
	  		//messagebox(0,outcost & " " & SMrw.FIFORowVal);
	  		//if(outcost!=SMrw.FIFORowVal)then begin
	  			changed = true;
	  			SMrw.FIFORowVal = outcost;
	  			SMrw.SentOldPrice = SMrw.SentFIFORowVal/SMrw.Quant;      
					SMrw.SentOldPrice = Round(SMrw.SentOldPrice,SetRoundModeD(5));
					SMrw.SentNewPrice = SMrw.SentOldPrice;
					SMrw.OldPrice = SMrw.FIFORowVal/SMrw.Quant;      
					SMrw.OldPrice = Round(SMrw.OldPrice,SetRoundModeD(5));
					SMrw.NewPrice = SMrw.OldPrice;
					matrowput(SMr,i,SMrw);
	  		//end;
	  		
	  	end;
		end;
		if(changed)then begin
			recordStore(SMr,true);
		end; 
	end;


return;
end;


global updating procedure AddClassGroupToIN()
begin
	record INVc INr;
	record DIVc DIr;
	record ITVc ITr;
	integer i,pos;
	string 20 class;
	
	while(loopmain(INr,1,true))begin
		if(blank(INr.Group) or blank(INr.DispGroups))then begin
			if(blank(INr.Group) and nonblank(INr.DispGroups))then begin
				pos = 0;
				ExtractObj(INr.DispGroups,pos,class);
				if(nonblank(class))then begin
					DIr.Code = class;
					if(readfirstmain(DIr,1,true))then begin
						ITr.Comment = DIr.Name;
						if(readfirstkey("Comment",ITr,1,true))then begin
							INr.Group = ITr.Code;
							recordstore(INr,true);
						end;
					end;
				end;
			end;
			
			if(nonblank(INr.Group) and blank(INr.DispGroups))then begin
					ITr.Code = INr.Group;
					if(readfirstmain(ITr,1,true))then begin
						DIr.Name = ITr.Comment;
						if(readfirstkey("Name",DIr,1,true))then begin
							INr.DispGroups = DIr.Code;
							recordstore(INr,true);
						end;
					end;
			end;
			
		end;
	end;

return;
end;



global updating procedure SetDebAcc63ToIPMn()
begin
	record IPVc IPr;
	row IPVc IPrw;
	integer i,rwcnt;
	boolean change;
	
	
	While(LoopMain(IPr,1,true)) begin
		rwcnt = MatRowCnt(IPr);
		change = false;
		for(i=0;i<rwcnt;i=i+1) begin
				MatRowGet(IPr,i,IPrw);
				if (nonblank(IPrw.CUPNr) and (IPrw.ARAcc!="63")) then begin
						IPrw.ARAcc = "63";
						MatRowPut(IPr,i,IPrw);
						change = true;
				end;
		end;
		
		if (change) then begin
			RecordStore(IPr,true);		
		end;	
	end;	


return;
end;



global updating procedure CleaningPUMn() //Edit----------------------Dima  26.05.2015
begin
	record PUVc PUr;
	Boolean TrHs;
	
	
	TrHs = true;
	while (LoopMain(PUr,1,TrHs)) begin
	  if (TrHs) then begin
	    RecordDelete(PUr);
	    StepBack(PUr);
	  end;
	end;	
	return;
end;






global updating procedure CleaningINMn() //Edit----------------------Dima  26.05.2015
begin
	record INVc INr;
	Boolean TrHs;
	
	
	TrHs = true;
	while (LoopMain(INr,1,TrHs)) begin
	  if (TrHs) then begin
	    RecordDelete(INr);
	    StepBack(INr);
	  end;
	end;	
	return;
end;



global procedure CloseAllAlarms()
begin
	record ActVc Actr;
	record AlarmVc Alr, UUIDAlr, newAlr, OldAlr;
	boolean TrHs,testf, TrHs2;
	integer err, wn;
	Boolean res;
  string 255 person;
  Integer pos;
  string 255 mailboxnr,to,recidstr;
  Integer oldcomp;
	
	TrHs = true;
	while (TrHs) begin
		wn = 0;
		wn = FindWindow("AlarmWClass");
		if(wn==0)then begin TrHs = false; end;
		if(TrHs)then begin
			CloseWindow(wn);
		end;
	end;

return
end;


global updating procedure AlarmECMessageMn()
begin
	record ActVc Actr;
	record AlarmVc Alr, UUIDAlr, newAlr, OldAlr;
	boolean TrHs,testf, TrHs2;
	integer err, wn;
	Boolean res;
  string 255 person;
  Integer pos;
  string 255 mailboxnr,to,recidstr;
  Integer oldcomp;
	vector boolean Personf;
	
	AllClientsRemoteAsync.CloseAllAlarms;
	
	TrHs = true;
	Actr.OKFlag = 0;
	
	while(loopkey("OKFlag",Actr,1,TrHs))begin
		testf = true;
		if(Actr.OKFlag!=0)then begin 
			TrHs = false;
			testf = false;
		end; 
		if(left(Actr.Comment,22)!="   " or Actr.TransDate!=CurrentDate)then begin testf = false; end;
		if(testf)then begin
			Alr.ActSerNr = Actr.SerNr;
			TrHs2 = true;
			while (loopbackkey("ActSerNr",Alr,1,TrHs2)) begin
				if(Alr.CompNo==currentcompany)then begin
					if(Alr.OKFlag==1 and !Personf[Alr.MainPersons])then begin
						RecordCopy(OldAlr,Alr);
						Alr.OKFlag = 0;
						Personf[Alr.MainPersons] = true;
						err = RecordUpdate(OldAlr,Alr,true);
					end;
					TrHs2 = false;
				end;
			end;
			resetLoop(Alr);
		end;
	end;
return
end;



/*
global webpublic updating procedure AlarmECUnMessageMn()
begin
	record ActVc Actr;
	record AlarmVc Alr, OldAlr;
	boolean TrHs,testf;
	integer i;
	for(i=0;i<34;i=i+1)begin
		setcompany(i+1,false);
		TrHs = true;
		Actr.OKFlag = 0;
		while(loopkey("OKFlag",Actr,1,TrHs))begin
			testf = true;
			//if(Actr.OKFlag!=0)then begin TrHs = false; end; 
			//if(left(Actr.Comment,22)!="   " or Actr.TransDate!=CurrentDate)then begin testf = false; end;
			if(testf)then begin
				Alr.ActSerNr = Actr.SerNr;
				if(ReadFirstKey("ActSerNr",Alr,1,true))then begin
					RecordCopy(OldAlr,Alr);
					Alr.OKFlag = 1;
					RecordUpdate(OldAlr,Alr,true);
				end;
			end;
		end;
	end;
return
end;
*/
global webpublic updating procedure WebAlarmECUnMessageMn()
begin
	record ActVc Actr;
	record AlarmVc Alr, OldAlr;
	boolean TrHs,testf;
	integer i, Alrcnt;
	array LongInt UnOkAlrms;
	
	setCompany(4,false);
	TrHs = true;
	Alr.OKFlag = 0;
	i = 0;
	while (loopKey("OKFlag",Alr,1,TrHs))begin
		// if (Alr.OKFlag != 0) then begin TrHs = false; end;
		if (TrHs) then begin
			UnOkAlrms[i] = Alr.SerNr;
			i=i+1;
		end;
	end;
	Alrcnt = i;
	for (i=0;i<Alrcnt;i=i+1) begin
		Alr.SerNr = UnOkAlrms[i];
		if (ReadFirstMain(Alr,1,true)) then begin
			RecordCopy(OldAlr,Alr);
			Alr.OKFlag = 1;
			RecordUpdate(OldAlr,Alr,true);
		end;
	end;
return
end;

global updating procedure ReOkCLOUTVcMn() //Edit----------------------Dima  26.05.2015
begin
	record CLOutVc CLOutr, UnOKCLOUTr;
	
	
	logtext(0,"Cleaning CLOutr");
	while (LoopMain(CLOutr,1,true)) begin
		CLOutr.OKFlag = 0;
		if(RecordStore(CLOutr,true)) then begin
			RecordCopy(UnOKCLOUTr,CLOutr);
			CLOutr.OKFlag = 1;
			if(RecordUpdate(UnOKCLOUTr,CLOutr,true)==0)then begin
			end;
		end;
	end;
	
	
	
return
end;




global updating procedure CleaningMn() //Edit----------------------Dima  26.05.2015
begin
	record CLInVc CLInr;//No
	record CLOutVc CLOutr;//No
	record IPVc IPr;//ok
	record OPVc OPr;//ok
	record IVVc IVr;//ok
	record VIVc VIr;//ok
	record POVc POr;//ok
	record SHVc SHr;//ok
	record PUVc PUr;//ok
	record SDVc SDr;//ok
	record StockMovVc StockMovr;//ok
	record RetVc Retr;//ok
	record RetPUVc RetPUr;//ok
	record ORVc ORr;//ok
	record TRVc TRr;//ok
	record FBVc FBr;//ok
	record ItemHistVc IHr;//ok
	record ItemStatusVc ISr;//ok
	record PPVc PPr;//ok
	record NewINVc NINr;//ok
	record TruckDataVc TDr;//ok
	record LocationVc Locr;//ok
	record ActVc Actr;//ok
	record ERVc ERr;//ok
	record OSDVc OSDr;//ok
	record PosVc Posr;//ok
	record PLVc PLr;//ok
	record MainVc Mainr;//ok
	record POShipmDataVc POShipmDatar;//ok
	record PlannedPaymentVc PlannedPaymentr;//ok
	record INVc INr;//ok
	record APVc APr;
	Boolean TrHs;
	
	
	
	
	logtext(0,"Cleaning APVc");
	TrHs = true;
	while (LoopMain(APr,1,TrHs)) begin
	  if (TrHs) then begin
	    RecordDelete(APr);
	    StepBack(APr);
	  end;
	end;	
	// logtext(0,"Cleaning INr");
	// TrHs = true;
	// while (LoopMain(INr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(INr);
	    // StepBack(INr);
	  // end;
	// end;	
	// logtext(0,"Cleaning PlannedPaymentr");
	// TrHs = true;
	// while (LoopMain(PlannedPaymentr,1,TrHs)) begin 
	  // if (TrHs) then begin
	    // RecordDelete(PlannedPaymentr);
	    // StepBack(PlannedPaymentr);
	  // end;
	// end;	
		
	// logtext(0,"Cleaning POShipmDatar");	
	// TrHs = true;
	// while (LoopMain(POShipmDatar,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(POShipmDatar);
	    // StepBack(POShipmDatar);
	  // end;
	// end;	
		
	// logtext(0,"Cleaning Mainr");
	// TrHs = true;
	// while (LoopMain(Mainr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(Mainr);
	    // StepBack(Mainr);
	  // end;
	// end;	
	// logtext(0,"Cleaning PLr");// Edit ************************** BPI Ukraine - KramarAlexandr - 05, 29 03 2019 y. at 2:57:44 PM
	// TrHs = true;
	// while (LoopMain(PLr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(PLr);
	    // StepBack(PLr);
	  // end;
	// end;
		
	// logtext(0,"Cleaning Posr");
	// TrHs = true;
	// while (LoopMain(Posr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(Posr);
	    // StepBack(Posr);
	  // end;
	// end;

	// logtext(0,"Cleaning OSDr");
	// TrHs = true;
	// while (LoopMain(OSDr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(OSDr);
	    // StepBack(OSDr);
	  // end;
	// end;
	
	// logtext(0,"Cleaning ERr");
	// TrHs = true;
	// while (LoopMain(ERr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(ERr);
	    // StepBack(ERr);
	  // end;
	// end;
		
	// logtext(0,"Cleaning Actr");
	// TrHs = true;
	// while (LoopMain(Actr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(Actr);
	    // StepBack(Actr);
	  // end;
	// end;
		
	// logtext(0,"Cleaning Locr");
	// TrHs = true;
	// while (LoopMain(Locr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(Locr);
	    // StepBack(Locr);
	  // end;
	// end;
		
	// logtext(0,"Cleaning TDr");
	// TrHs = true;
	// while (LoopMain(TDr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(TDr);
	    // StepBack(TDr);
	  // end;
	// end;
	// logtext(0,"Cleaning CLInr");
	// TrHs = true;
	// while (LoopMain(CLInr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(CLInr);
	    // StepBack(CLInr);
	  // end;
	// end;
	
	// logtext(0,"Cleaning CLOutr");
	// TrHs = true;
	// while (LoopMain(CLOutr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(CLOutr);
	    // StepBack(CLOutr);
	  // end;
	// end;

	// logtext(0,"Cleaning IPr");
	// TrHs = true;
	// while (LoopMain(IPr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(IPr);
	    // StepBack(IPr);
	  // end;
	// end;
	
	// logtext(0,"Cleaning IVr");
	// TrHs = true;
	// while (LoopMain(IVr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(IVr);
	    // StepBack(IVr);
	  // end;
	// end;

	// logtext(0,"Cleaning VIr");
	// TrHs = true;
	// while (LoopMain(VIr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(VIr);
	    // StepBack(VIr);
	  // end;
	// end;

	// logtext(0,"Cleaning POr");
	// TrHs = true;
	// while (LoopMain(POr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(POr);
	    // StepBack(POr);
	  // end;
	// end;

	// logtext(0,"Cleaning OPr");
	// TrHs = true;
	// while (LoopMain(OPr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(OPr);
	    // StepBack(OPr);
	  // end;
	// end;

	// logtext(0,"Cleaning SHr");
	// TrHs = true;
	// while (LoopMain(SHr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(SHr);
	    // StepBack(SHr);
	  // end;
	// end;

	// logtext(0,"Cleaning PUr");
	// TrHs = true;
	// while (LoopMain(PUr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(PUr);
	    // StepBack(PUr);
	  // end;
	// end;

	// logtext(0,"Cleaning SDr");
	// TrHs = true;
	// while (LoopMain(SDr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(SDr);
	    // StepBack(SDr);
	  // end;
	// end;
	
	// logtext(0,"Cleaning StockMovr");
	// TrHs = true;
	// while (LoopMain(StockMovr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(StockMovr);
	    // StepBack(StockMovr);
	  // end;
	// end;
	
	// logtext(0,"Cleaning Retr");
	// TrHs = true;
	// while (LoopMain(Retr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(Retr);
	    // StepBack(Retr);
	  // end;
	// end;

	// logtext(0,"Cleaning RetPUr");
	// TrHs = true;
	// while (LoopMain(RetPUr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(RetPUr);
	    // StepBack(RetPUr);
	  // end;
	// end;

	// logtext(0,"Cleaning ORr");
	// TrHs = true;
	// while (LoopMain(ORr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(ORr);
	    // StepBack(ORr);
	  // end;
	// end;

	// logtext(0,"Cleaning TRr");
	// TrHs = true;
	// while (LoopMain(TRr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(TRr);
	    // StepBack(TRr);
	  // end;
	// end;

	// logtext(0,"Cleaning FBr");
	// TrHs = true;
	// while (LoopMain(FBr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(FBr);
	    // StepBack(FBr);
	  // end;
	// end;

	// logtext(0,"Cleaning IHr");
	// TrHs = true;
	// while (LoopMain(IHr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(IHr);
	    // StepBack(IHr);
	  // end;
	// end;

	// logtext(0,"Cleaning ISr");
	// TrHs = true;
	// while (LoopMain(ISr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(ISr);
	    // StepBack(ISr);
	  // end;
	// end;

	// logtext(0,"Cleaning PPr");
	// TrHs = true;
	// while (LoopMain(PPr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(PPr);
	    // StepBack(PPr);
	  // end;
	// end;
	// 
	// logtext(0,"Cleaning NINr");
	// TrHs = true;
	// while (LoopMain(NINr,1,TrHs)) begin
	  // if (TrHs) then begin
	    // RecordDelete(NINr);
	    // StepBack(NINr);
	  // end;
	// end;
	//

return;
end;


global  //Edit***************************Sasha2,14:00 26.05.2015 {
updating procedure SetInvoiceInvalidDateMn()
begin
	record IVVc IVr;

	IVr.SerNr = -1;
	While(LoopMain(IVr,1,true)) begin
	  if (IVr.Invalid!=0) then begin
	    IVr.InvalidDate = IVr.InvDate;
		  RECORDSTORE(IVr,true);
	  end;
	end;	

return;
end; //Edit***************************Sasha2,14:00 26.05.2015 }




// Edit Start ---------------------------------------------- Edit Start
	//Wednesday, 8 July 2015 16:07:17
	
procedure NumToHexExcel(string instr,var string res)
BEGIN
  string 16 hexs;
  LongInt l,i;
  string 255 tstr;
  
  res = "";
  l = FirstInRange(instr,10);
  hexs = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  for (i=0;i<8;i=i+1) begin
    tstr = tstr & Mid(hexs,BitAnd(l,25),1);
    l = l/26;
  end;
  for (i=len(tstr);i>=0;i=i-1) begin
    res = res & Mid(tstr,i,1);
  end;  
  RETURN;
END;

	// Edit End ---------------------------------------------- Edit End
	

global updating procedure FixLoyaltyPointMn()
begin
	string 100 res1,res2;
	
	res1 = 1;
	NumToHexExcel(res1,res2);
	/*ecord IVVc IVr;
	record LoyaltyCardVc LCr;
	area log;
	roundmode rnd;
	
	rnd = DefaultCurRoundoff;
  rnd.decimals = 0;
  rnd.mode = kRoundingModeHalfUp;
	
	IVr.SerNr = -1;
	while(loopmain(IVr,1,true))begin
		if(IVr.InvType==kInvoiceTypeDownpayment and IVr.OKFlag==1 and IVr.Invalid==0)then begin
			if(blank(IVr.LoyaltyCardNr))then begin
				LCr.CustCode = IVr.CustCode;
				if (ReadFirstKey("ActCustCode",LCr,1,true)) then begin
					IVr.LoyaltyCardNr = LCr.SerNr;
					IVr.LCMLevel = LCr.LCMLevel;
					CalculateIVVcPoints(IVr);
					recordStore(IVr,true);
					if(IVr.Points!=0)then begin
						LCr.PointsBalance = LCr.PointsBalance + round(IVr.Points,rnd);
						recordstore(LCr,true);
						AddTextToArea(IVr.SerNr & chr(9),log);
						AddTextToArea(IVr.CustCode & chr(9),log);
						AddTextToArea(IVr.Addr0 & chr(9),log);
						AddTextToArea(IVr.LoyaltyCardNr & chr(9),log);
						AddTextToArea(round(IVr.Points,rnd) & chr(9),log);
						AddTextToArea(chr(13) & chr(10),log);
					end;
					
				end;
			end;
		end;
	end;
	setfileonserver(true);
	createfile("log.txt");
	closefile;
	writeareatofile(log,"log.txt",0);
	setfileonserver(false);*/
	
return;
end;


global updating procedure PasteCategoryToCUMn()	//Edit by Victor 14.07.15
begin
	record CUVc CUr;
	boolean TrHs;

	TrHs = true;

	while (LoopMain(CUr,1,TrHs)) begin
		
		if (CUr.CUType==1) then begin
				CUr.CustCat = "NONAM";
				RecordStore(CUr,true); 
		end;
        
	end;
	
return;
end;

//Edit***************************Sasha2,10:39 20.04.2016 {
function string 255 ExtractNumericFromString(string s)
begin
  integer i;
  string 255 res;
  
  res = "";
  for (i=0;i<len(s);i=i+1) begin
    if (IsDigit(mid(s,i,1))==true) then begin
      res = res & mid(s,i,1);
    end;
  end;
  
  ExtractNumericFromString = res;
  return;
end; //Edit***************************Sasha2,10:39 20.04.2016 }

function val Get_Zebra_Price(integer switchf,string code,string basecur,var string stockcur,var string printcur)
begin
  record INVc INr;
  record PLVc PLr;// Edit ************************** Tuesday, 1 April 2014 13:12:18
	record PLDefVc PLDr;// Edit ************************** Tuesday, 1 April 2014 13:17:21
  val fr,to1,to2,br1,br2;// Edit ************************** Friday, 17 April 2015 18:53:45
  val price;
  roundmode rnd;
  string 5 cur;
  string 50 CRMid,campid,currebcode;
  record IVVc IVr;
  row IVVc IVrw;
  record MarcCampVc MCr;
  record UserVc User;
  val discountprice,vreb,baseprice,tax2prc;
  string 255 curitemname,salesacc,vatcode,tax2code,taxtemplatecode;
	Boolean calcpricef,dummyf;
  Boolean test2f,remoteconnection;
  record TemporaryPricesVc tempPLVc;
  val newprice;
  string 10 newcur,obj;
  	//pechat stikerov s 5/1/16 tolko v u.e. vo vseh company // Edit ************************** Tuesday, 5 January 2016 10:44:24
  	
    price = blankval;
    //printcur = "";
    switch(currentcompany)begin
      case 2: stockcur = basecur; printcur = "AZN";
      case 5: stockcur = basecur; printcur = "AZN";
      case 6: stockcur = basecur; printcur = "AZN";
      case 7: stockcur = basecur; printcur = "AZN";
      case 8: stockcur = basecur; printcur = "AZN";
      case 15: stockcur = basecur; printcur = "AZN";
      //case 16: stockcur = basecur; printcur = stockcur;
      case 16: stockcur = basecur; printcur = "AZN";// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 19 08 2019 y. at 2:43:53 PM
      otherwise printcur = "y.e.";
    end;
    
    switch (switchf) begin
      case 0:
        PLr.PLCode = "RRP";
  	    PLr.ArtCode = code;
  	    readfirstmain(PLr,2,true)
  	    price = PLr.ExVatPrice;
      case 1:
        PLr.PLCode = "RRP";
    	  PLr.ArtCode = code;
    	  if(readfirstmain(PLr,2,true))then begin
    	  	PLDr.Code = "RRP";
    			cur = "";
    			readfirstmain(PLDr,1,true);
    			cur = PLr.CurncyCode;
    			if (blank(cur)) then begin
    			  cur = PLDr.CurncyCode;
    			end;
    			if(blank(cur))then begin
    				cur = basecur;
    			end;
    			rnd = DefaultValRoundoff;
    			rnd.decimals = 0;
    			rnd.mode = kRoundingModeHalfUp;
    			/*if(CompanyIsJWLikeCompany(currentcompany))then begin// Edit ************************** Thursday, 21 September 2017 11:43:51
						rnd.mode = kRoundingModeHalfDown;
    				rnd.step = kRoundingStep5;
    			end;*/
    			
    			if(GetTempItemPrice(newprice,INr.Code,newcur,currentdate,obj))then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 01 07 2019 y. at 11:15:47 AM
						price = newprice;
						cur = newcur;
					end;
    			
    			if(cur!=stockcur and nonblank(stockcur))then begin // Edit ************************** Tuesday, 5 January 2016 10:46:17
    			  printcur = stockcur;
    			  CurValToOtherCur(CurrentDate,cur,PLr.ExVatPrice,printcur,price,rnd); 
    			end else begin
    				printcur = cur;
    				price = PLr.ExVatPrice;
    				if(newprice!=0)then begin
							price = newprice;
						end;
    			end;
    	  end;
    end;
		  	
  	switch(currentcompany)begin
      case 2:;
      case 5:;
      case 6:;
      case 7:;
      case 8:;
      case 15:;
      case 16:;// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 19 08 2019 y. at 2:56:15 PM
        /*INr.Code = code;
        if (ReadFirstMain(INr,1,true) and stringtoint(INr.CPSCode)>0) then begin
          printcur = "PP " & stringtoint(INr.CPSCode);
          price = blankval;
        end else begin
          printcur = "";
          price = blankval;
        end;*/
      otherwise printcur = "y.e.";
    end;
    
  	if(currentcompany==32)then begin
  		INr.Code = code;
  		if (ReadFirstMain(INr,1,true)) then begin
  			recordnew(IVr);
  			IVrw.ArtCode = INr.Code;
  			IVrw.Quant = 1;
  			IVr.RebCode = "0%";
  			IVr.CustCode = "NONAME";
  			IVr.CurncyCode = "AZN";
  			User.MinPLCode = "RRP";
  			IVr.TransDate = currentdate;
				if (GetItemPriceDiscount3(IVrw.ArtCode,IVrw.Quant,INr,IVr.CurncyCode,
													IVr.FrRate,IVr.ToRateB1,IVr.ToRateB2,IVr.BaseRate1,IVr.BaseRate2,
													IVr.LangCode,IVr.CustCat,User.MinPLCode,IVr.RebCode,
													price,curitemname,vreb,vatcode,baseprice,salesacc,
													0,calcpricef,IVr.TransDate,IVr.TransTime,IVr.CustCode,true,dummyf,IVr.PayDeal,tax2code,tax2prc,IVr.Region,IVr.Location,taxtemplatecode)) then begin
				end;
				
				
				if(vreb!=0)then begin
					price = round(price*(1-vreb/100),SetRoundModeD(0));
				end;
				printcur = "AZN";
			end;
  	
  	end;
  	
  	if(GetTempItemPrice(newprice,code,newcur,currentdate,obj))then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 01 07 2019 y. at 11:15:47 AM
			price = newprice;
			printcur = newcur;
		end;
  	
  Get_Zebra_Price = price;
  return;
end;

global
function boolean CheckIfBarcodeIsDigits(string bcode)
begin
  Boolean res;
  integer strlen,i;
    
    strlen = len(bcode);
    res = true;
    for (i=0;i<strlen;i=i+1) begin
      if (Asc(mid(bcode,i,1))<48 or Asc(mid(bcode,i,1))>57) then begin
        res = false;
        i = strlen;
      end;
    end;
    
    CheckIfBarcodeIsDigits = res;
  return;
end;

global
updating procedure CheckBarcodeValue(var record INVc INr,var string bcode)
begin
  Boolean proceedf;
  record INVc IN2r,oldINr;
  string 20 barcodenr;
        
    bcode = INr.Code;
    if(nonblank(INr.BarCode))then begin
    	bcode = INr.BarCode;
    	if(len(INr.BarCode)<=len(INr.Code))then begin
    		bcode = INr.BarCode;
    	end;
    end;
    proceedf = !CheckIfBarcodeIsDigits(bcode);
    if (proceedf and len(bcode)<=12) then begin
      goto LCheckBarcodeValue;
    end;
    if (proceedf and Nonblank(INr.BarCode) and len(bcode)>len(INr.BarCode)) then begin
      bcode = INr.BarCode;
      proceedf = !CheckIfBarcodeIsDigits(bcode);
    end;
    if (proceedf and len(bcode)<=12) then begin
      goto LCheckBarcodeValue;
    end; 
    if (proceedf and Nonblank(INr.AlternativeCode) and len(bcode)>len(INr.AlternativeCode)) then begin
      bcode = INr.AlternativeCode;
      proceedf = !CheckIfBarcodeIsDigits(bcode);
    end;
    if (proceedf and blank(INr.AlternativeCode) and NonBlank(INr.BarCode)) then begin
      INr.AlternativeCode = INr.BarCode;
      INr.BarCode = "";
    end;
    
    if(INr.BarCode==INr.AlternativeCode)then begin
    	INr.BarCode = "";
    end;
    if(INr.BarCode==INr.Code)then begin
    	INr.BarCode = "";
    end;
    
    if (proceedf and blank(INr.BarCode) and len(bcode)>12) then begin
      IN2r.BarCode = "IN_BC999999";
      if (ReadLastKey("BarCode",IN2r,1,false)) then begin
        if (mid(IN2r.BarCode,0,5)=="IN_BC" and len(IN2r.BarCode)==11) then begin
          if (IN2r.BarCode=="IN_BC999999") then begin
            goto LCheckBarcodeValue;
          end;
  LCheckBarcodeValueRepeat:;        
          NextM4Number(IN2r.BarCode,barcodenr);
          IN2r.Code = barcodenr;
          if (ReadFirstmain(IN2r,1,true)) then begin
            if (IN2r.Code=="IN_BC999999") then begin
              goto LCheckBarcodeValue;
            end;
            goto LCheckBarcodeValueRepeat;
          end;
          IN2r.AlternativeCode = barcodenr;
          if (ReadFirstKey("AlternativeCode",IN2r,1,true)) then begin
            if (IN2r.AlternativeCode=="IN_BC999999") then begin
              goto LCheckBarcodeValue;
            end;
            goto LCheckBarcodeValueRepeat;
          end;
        end else begin
          barcodenr = "IN_BC000001";
          IN2r.BarCode = "IN_BC000001";
          if (ReadFirstKey("BarCode",IN2r,1,true)) then begin
            goto LCheckBarcodeValue;
          end;
        end;
        if (nonblank(barcodenr) and barcodenr!="1") then begin
        	recordcopy(oldINr,INr);
          INr.BarCode = barcodenr;
          // Logtext(0,"INr.Code " & INr.Code);
          // Logtext(0,"INr.UUID " & INr.UUID);
          recordstore(INr,true);
          bcode = barcodenr;
        end;
      end;
    end;
  
  LCheckBarcodeValue:;
    
  return;
end;

global //Edit***************************Sasha2,16:59 08.07.2015 {
updating procedure Handle_Zebra_Printing(record RcVc RepSpec,var area aLabel,var integer K,string fromplace,record ZebraPrinterBlock ZPb)
begin
  record PUVc newPUr;
  record INVc INr;
  record ItemStatusVc ISr;
  record BaseCurBlock BCb;// Edit ************************** Tuesday, 1 April 2014 13:17:21
  row PUVc newPUrw;
  record DIVc DIr;
  integer i,mtrw,lenth,h,j,rwcnt,pos,zebraQty,curcomp;
  boolean TrHs,testf,caratf,onlyPrintQuantf;
  string 50 frin,toin;
  longint qty;
  string 200 tstr;
  string 5 basecur,stockcur,printcur;
  LongInt frompu,topu;
  record PUVc PUr;
  row PUVc PUrw;
  record StockMovVc SMr;
  row StockMovVc SMrw;
      
    k=0;
    recordnew(newPUr);
    blockload(BCb);
    basecur = BCb.BaseCur1;
    
    
		switch (RepSpec.f2) begin
		  case "CARTIER":
		    stockcur = "EUR";
		    caratf = true;
		  //case "CHOPARD":
		  //case "ELLUX":
		  case "GRAFF":
		    stockcur = "USD";
		    caratf = true;
		  //case "JW":
		  //case "RCOL1":
		  //case "RCOL2":
		  //case "RC_DG":
		  //case "TIMEPIECES":
		  otherwise
		  	
		    //stockcur = basecur;
		    stockcur = "";
		    caratf = true;
		end;
		switch (fromplace) begin
		  case "FromStock":
    		frin = firstinrange(RepSpec.f1,20);
    		toin = lastinrange(RepSpec.f1,20);
    		INr.Code = frin; 
    		TrHs = true;
		    while(loopmain(INr,1,TrHs)) begin
    			testf = true;
    			if(nonblank(toin) and INr.Code>toin)then begin TrHs = false; testf = false; end;
    			ISr.Code = INr.Code;
    			qty = 0;
    			if(nonblank(RepSpec.f2))then begin
    				ISr.Location = RepSpec.f2;
    			end else begin
    				ISr.Location = ";;;";
    			end;
    			if(readfirstmain(ISr,2,true))then begin
    				qty = ISr.Instock;
    			end;
    			if(qty>0)then begin
						if(nonblank(RepSpec.f2))then begin
							if(RepSpec.long1>0 and RepSpec.long1<qty)then begin qty = RepSpec.long1; end;
						end else begin
							if(RepSpec.long1>0)then begin qty = RepSpec.long1; end;
						end;
					end else begin
						if(blank(RepSpec.f2))then begin
							if(RepSpec.long1>0)then begin qty = RepSpec.long1; end;
						end;
					end;
    			if(qty<=0)then begin testf = false; end;
    			if(nonblank(RepSpec.f3) and setinset(RepSpec.f3,INr.DispGroups)==false)then begin testf = false; end;
    			if(RepSpec.flags[2]<=0 and INr.ConsgType==2) then begin testf = false; end;
    			if(INr.ConsgType>2) then begin testf = false; end;
    			if(nonblank(RepSpec.f4) and RepSpec.f4!=INr.BPIBrand)then begin testf = false; end;
					if(nonblank(RepSpec.f5) and RepSpec.f5!=INr.BPISubGroup)then begin testf = false; end;

    			if(testf)then begin
    				For(i=0;i<qty;i=i+1) begin
    				  matrowget(newPUr,k,newPUrw);
              CheckBarcodeValue(INr,tstr);
              newPUrw.Spec = tstr;
              newPUrw.ArtCode = INr.Code; 
              newPUrw.UPrice = Get_Zebra_Price(1,INr.Code,basecur,stockcur,printcur);
              newPUrw.Comment = printcur;
              pos = 0;
              
              newPUrw.SerialNr = INr.MajStoneDet;
              newPUrw.VEItemCode = INr.RowWeight;
              
              ExtractObj(INr.DispGroups,pos,tstr);
              while (NonBlank(tstr)) begin
                DIr.Code = tstr;
                ReadFirstMain(DIr,1,true);
                if (caratf and DIr.CType=="D_CARAT") then begin
                  newPUrw.SerialNr = DIr.Name;
                end;
                if (DIr.CType=="WEIGHT" and blank(newPUrw.VEItemCode)) then begin
                  newPUrw.VEItemCode = DIr.Name;
                end;
                ExtractObj(INr.DispGroups,pos,tstr);
              end;
              if (caratf and Blank(newPUrw.SerialNr)) then begin
                newPUrw.SerialNr = INr.MajStoneDet;
              end;
              if (Blank(newPUrw.VEItemCode)) then begin
                newPUrw.VEItemCode = INr.RowWeight;
              end;
              matrowput(newPUr,k,newPUrw);
              k=k+1;
    				end;
    			end; 
    		end;
    	case "PUVc":
    	  frompu = FirstInRange(RepSpec.f1,20);
        topu = LastInRange(RepSpec.f1,20);
        if nonblank(RepSpec.f1) then begin 
          PUr.SerNr = frompu;
        end;  
        TrHs = true;
        while (LoopMain(PUr,1,TrHs)) begin
          testf = true;
          if (TrHs) then begin
            if (topu!=-1) then begin
              if (PUr.SerNr>topu) then begin
                TrHs = false;
                testf = false;
              end;
            end;
          end;
          if nonblank(RepSpec.LastAcc) then begin 
            if (RepSpec.LastAcc<>PUr.VECode) then begin 
              testf = false;
            end;
          end;
      		
          if (testf) then begin
            onlyPrintQuantf = false; //Edit***************************Sasha2,11:48 19.05.2016 {
            rwcnt = MatRowCnt(PUr);
            for (i=0;i<rwcnt;i=i+1) begin
              MatRowGet(PUr,i,PUrw);
              if (PUrw.PrintQuant>0) then begin
                onlyPrintQuantf = true;
                i = rwcnt;
              end;
            end; //Edit***************************Sasha2,11:48 19.05.2016 }
            for (i=0;i<rwcnt;i=i+1) begin
              testf = true;
              MatRowGet(PUr,i,PUrw);
              INr.Code = PUrw.ArtCode;
              if (blank(PUrw.ArtCode) or !ReadFirstMain(INr,1,true)) then begin testf = false; end;  
              if(RepSpec.flags[2]<=0 and INr.ConsgType==2) then begin testf = false; end;
              if(INr.ConsgType>2) then begin testf = false; end;
              if(onlyPrintQuantf and PUrw.PrintQuant==0) then begin testf = false; end; //Edit***************************Sasha2,11:55 19.05.2016
              if (testf) then begin
                if (onlyPrintQuantf and PUrw.PrintQuant>0) then begin //Edit***************************Sasha2,11:59 19.05.2016
                  zebraQty = PUrw.PrintQuant;
                end else begin
                  zebraQty = PUrw.Quant;
                end;
                for (j=0;j<zebraQty;j=j+1) begin
      						matrowget(newPUr,k,newPUrw);
                  CheckBarcodeValue(INr,tstr);
                  newPUrw.Spec = tstr;
                  newPUrw.ArtCode = INr.Code;
                  newPUrw.UPrice = Get_Zebra_Price(1,INr.Code,basecur,stockcur,printcur);
                  newPUrw.Comment = printcur;
                  
                  if (caratf)begin
										newPUrw.SerialNr = INr.MajStoneDet;
                  end;
             			newPUrw.VEItemCode = INr.RowWeight;
                  
                  pos = 0;
                  ExtractObj(INr.DispGroups,pos,tstr);
                  while (NonBlank(tstr)) begin
                    DIr.Code = tstr;
                    ReadFirstMain(DIr,1,true);
                    if (caratf and DIr.CType=="D_CARAT") then begin
                      newPUrw.SerialNr = DIr.Name;
                    end;
                    if (DIr.CType=="WEIGHT" and blank(newPUrw.VEItemCode)) then begin
                      newPUrw.VEItemCode = DIr.Name;
                    end;
                    ExtractObj(INr.DispGroups,pos,tstr);
                  end;
                  if (caratf and Blank(newPUrw.SerialNr)) then begin
                    newPUrw.SerialNr = INr.MajStoneDet;
                  end;
                  if (Blank(newPUrw.VEItemCode)) then begin
                    newPUrw.VEItemCode = INr.RowWeight;
                  end;
                  matrowput(newPUr,k,newPUrw);
                  k=k+1;
                end;
              end;
            end;
          end; 
        end;
      case "StockMovVc":
    	  frompu = FirstInRange(RepSpec.f1,20);
        topu = LastInRange(RepSpec.f1,20);
        if nonblank(RepSpec.f1) then begin 
          SMr.SerNr = frompu;
        end;  
        TrHs = true;
        while (LoopMain(SMr,1,TrHs)) begin
          testf = true;
          if (TrHs) then begin
            if (topu!=-1) then begin
              if (SMr.SerNr>topu) then begin
                TrHs = false;
                testf = false;
              end;
            end;
          end;
          if (testf) then begin
            rwcnt = MatRowCnt(SMr);
            for (i=0;i<rwcnt;i=i+1) begin
              testf = true;
              MatRowGet(SMr,i,SMrw);
              INr.Code = SMrw.ArtCode;
              if (blank(SMrw.ArtCode) or !ReadFirstMain(INr,1,true)) then begin testf = false; end;  
              if(RepSpec.flags[2]<=0 and INr.ConsgType==2) then begin testf = false; end;
              if(INr.ConsgType>2) then begin testf = false; end;
              if (testf) then begin     					
                for (j=0;j<SMrw.Quant;j=j+1) begin
      						matrowget(newPUr,k,newPUrw);
                  CheckBarcodeValue(INr,tstr);
                  newPUrw.Spec = tstr;
                  newPUrw.ArtCode = INr.Code;
                  newPUrw.UPrice = Get_Zebra_Price(1,INr.Code,basecur,stockcur,printcur);
                  newPUrw.Comment = printcur;
                  newPUrw.SerialNr = INr.MajStoneDet;
              		newPUrw.VEItemCode = INr.RowWeight;
                  pos = 0;
                  ExtractObj(INr.DispGroups,pos,tstr);
                  while (NonBlank(tstr)) begin
                    DIr.Code = tstr;
                    ReadFirstMain(DIr,1,true);
                    if (caratf and DIr.CType=="D_CARAT") then begin
                      newPUrw.SerialNr = DIr.Name;
                    end;
                    if (DIr.CType=="WEIGHT" and blank(newPUrw.VEItemCode)) then begin
                      newPUrw.VEItemCode = DIr.Name;
                    end;
                    ExtractObj(INr.DispGroups,pos,tstr);
                  end;
                  if (caratf and Blank(newPUrw.SerialNr)) then begin
                    newPUrw.SerialNr = INr.MajStoneDet;
                  end;
                  if (Blank(newPUrw.VEItemCode)) then begin
                    newPUrw.VEItemCode = INr.RowWeight;
                  end;
                  matrowput(newPUr,k,newPUrw);
                  k=k+1;
                end;
              end;
            end;
          end; 
        end;
      otherwise
		end;
    
    if(k>0)then begin
      
      SetAreaZeroSize(aLabel);
      curcomp = currentcompany;
      /*switch(curcomp)begin
      	case 19: addtexttoarea("q576" & chr(13) & chr(10),aLabel); //Set Label Width 72 mm
				case 22: addtexttoarea("q576" & chr(13) & chr(10),aLabel); //Set Label Width 72 mm
      otherwise 
      	addtexttoarea("q592" & chr(13) & chr(10),aLabel); //Set Label Width 74 mm
      end;*/
      addtexttoarea("q592" & chr(13) & chr(10),aLabel);//74  for all
      /*switch(curcomp)begin
      	case 16: addtexttoarea("496" & chr(13) & chr(10),aLabel); //Set Label Width 63 mm
      	case 23: addtexttoarea("496" & chr(13) & chr(10),aLabel); //Set Label Width 63 mm
				case 22: addtexttoarea("496" & chr(13) & chr(10),aLabel); //Set Label Width 63 mm
				case 21: addtexttoarea("496" & chr(13) & chr(10),aLabel); //Set Label Width 63 mm
      end;*/
      //addtexttoarea("q432" & chr(13) & chr(10),aLabel); //Set Label Width 54 mm
      addtexttoarea("Q80" & chr(13) & chr(10),aLabel); //Set Label Height 10mm
      if(ZPb.ParamIn1>0)then begin
      	if(ZPb.ParamIn1<16)then begin
      		addtexttoarea("D" & ZPb.ParamIn1 & chr(13) & chr(10),aLabel); //print density
      	end else begin
      		addtexttoarea("D15" & chr(13) & chr(10),aLabel); //print density
      	end;
      end else begin
				addtexttoarea("D15" & chr(13) & chr(10),aLabel); //print density
      end;
      
      addtexttoarea("I8,C" & chr(13) & chr(10),aLabel); //appropriate character set for printing and display (KDU) "C": Wi1n2d5o1ws Cyrillic
      addtexttoarea("FK\"1\"" & chr(13) & chr(10),aLabel); //iDelete forms from memory
      addtexttoarea("FS\"1\"" & chr(13) & chr(10),aLabel); // Store Form
      addtexttoarea("V00,30,N,\"\"" & chr(13) & chr(10),aLabel); // Define Variable
      addtexttoarea("V01,30,N,\"\"" & chr(13) & chr(10),aLabel); // Define Variable
      addtexttoarea("V02,15,N,\"\"" & chr(13) & chr(10),aLabel); // Define Variable
      addtexttoarea("V03,15,N,\"\"" & chr(13) & chr(10),aLabel); // Define Variable
      addtexttoarea("V04,10,N,\"\"" & chr(13) & chr(10),aLabel); // Define Variable
      addtexttoarea("V05,10,N,\"\"" & chr(13) & chr(10),aLabel); // Define Variable
      addtexttoarea("V06,3,N,\"\"" & chr(13) & chr(10),aLabel); // Define Variable V05 - Number of label sets
      //addtexttoarea("X50,145,5,408,250" & chr(13) & chr(10),aLabel); // draw a box shape
      addtexttoarea("B24,1,0,1,1,2,40,N,V00" & chr(13) & chr(10),aLabel); // print standard bar codes
      addtexttoarea("A24,44,0,1,1,1,N,V01" & chr(13) & chr(10),aLabel); // Prints an ASCII text string
      addtexttoarea("A200,1,0,2,1,1,N,V02" & chr(13) & chr(10),aLabel); // Prints an ASCII text string
      addtexttoarea("A200,20,0,2,1,1,N,V03" & chr(13) & chr(10),aLabel); // Prints an ASCII text string
      addtexttoarea("A200,44,0,2,1,1,N,V04" & chr(13) & chr(10),aLabel); // Prints an ASCII text string
      addtexttoarea("A260,44,0,2,1,1,N,V05" & chr(13) & chr(10),aLabel); // Prints an ASCII text string
      addtexttoarea("PAV06" & chr(13) & chr(10),aLabel); // to automatically print the form
      addtexttoarea("FE" & chr(13) & chr(10),aLabel); // command is used to end a form store sequence.
      addtexttoarea(chr(13) & chr(10),aLabel);
      
      mtrw = MatRowCnt(newPUr);
      for (i=0;i<mtrw;i=i+1) begin
        MatRowGet(newPUr,i,newPUrw);
        if (nonblank(newPUrw.ArtCode)) then begin
          addtexttoarea("FR\"1\"" & chr(13) & chr(10),aLabel); // to retrieve a form that was previously stored in memory
          addtexttoarea("?" & chr(13) & chr(10),aLabel); //command signals the printer to fill-in variable or counter prompt data field
          addtexttoarea(newPUrw.Spec & chr(13) & chr(10),aLabel);
          addtexttoarea(newPUrw.ArtCode & chr(13) & chr(10),aLabel);
          addtexttoarea(newPUrw.SerialNr & chr(13) & chr(10),aLabel);
          addtexttoarea(newPUrw.VEItemCode & chr(13) & chr(10),aLabel);
          addtexttoarea(newPUrw.Comment & chr(13) & chr(10),aLabel);
          if (newPUrw.UPrice==0 or newPUrw.UPrice==BlankVal) then begin
            addtexttoarea("" & chr(13) & chr(10),aLabel);    
          end else begin
            if(right(ValToString(newPUrw.UPrice,M4Val,"",".",0),2)=="00")then begin
            	addtexttoarea(ValToString(newPUrw.UPrice,M4Val,"",".",1) & chr(13) & chr(10),aLabel); 
            end else begin
            	addtexttoarea(ValToString(newPUrw.UPrice,M4Val,"",".",0) & chr(13) & chr(10),aLabel); 
            end;
          end;
          addtexttoarea("1" & chr(13) & chr(10),aLabel);
          addtexttoarea(chr(13) & chr(10),aLabel);
        end;
      end; 
    end;
    
  return;
end;  //Edit***************************Sasha2,16:59 08.07.2015 }


global updating procedure SetNewCurrencyinPricesMn(record RcVc RepSpec)	//Edit----------------------Dima  17.04.2015
begin
	record PLVc PLr;	
	string 10 curncy1,curncy2;
	longint curtick;
	
	curtick = getcurtick();
	curncy1 = RepSpec.f1;
	curncy2 = RepSpec.f2;
		

	While(LoopMain(PLr,1,true)) begin	
		if (PLr.CurncyCode==curncy1) then begin
				PLr.CurncyCode = curncy2;
				RecordStore(PLr,true);
				UpdatePrice(PLr);
		end;			
	end;
	LogText(0,"Prices were changed. From " & curncy1 & " to " & curncy2);
	LogProcTime("SetNewCurrencyinPricesMn",getcurtick()-curtick);

return;
end;

global //Edit***************************Sasha2,13:42 06.11.2015 {
updating procedure DeleteCertainDIMn(record RcVc RepSpec)
begin
	record INVc INr;
	record DIVc DIr;
	Boolean savef;
	string 10 curdisp;
	string 255 dispbuildstr;
	Integer pos;
	longint curtick;

	curtick = getcurtick();
   if (blank(RepSpec.f1)) then begin
     goto LDeleteCertainDIMn;
   end;
   
   INr.Code = "";
   While(LoopMain(INr,1,true)) begin
  	 dispbuildstr = "";
  	 savef = false;
  	 pos = 0;
  	 ExtractObj(INr.DispGroups,pos,curdisp);
  	 while (NonBlank(curdisp)) begin
  	   if (SetInSet2(curdisp,RepSpec.f1)) then begin
  	     savef = true;
  	   end else begin
  	     if (blank(dispbuildstr)) then begin
  	       dispbuildstr = curdisp;
  	     end else begin
  	       dispbuildstr = dispbuildstr & "," & curdisp;
  	     end;
  	   end;
  	   ExtractObj(INr.DispGroups,pos,curdisp);
  	 end;
  	 if (savef) then begin
	     INr.DispGroups = dispbuildstr;
	     RECORDSTORE(INr,true);
	   end;
   end;
   LogProcTime("DeleteCertainDIMn",getcurtick()-curtick);
LDeleteCertainDIMn:;   

return;
end; //Edit***************************Sasha2,13:42 06.11.2015 }

global //Edit***************************Sasha2,13:42 06.11.2015 {
updating procedure RenameCertainDIMn(record RcVc RepSpec)
begin
	record INVc INr;
	record DIVc DIr;
	Boolean savef;
	string 10 curdisp;
	string 255 dispbuildstr;
	Integer pos;
	longint curtick;
	
	curtick = getcurtick();
   if (blank(RepSpec.f1) or blank(RepSpec.f2)) then begin
     goto LRenameCertainDIMn;
   end;
   
   INr.Code = "";
   While(LoopMain(INr,1,true)) begin
  	 dispbuildstr = "";
  	 savef = false;
  	 pos = 0;
  	 ExtractObj(INr.DispGroups,pos,curdisp);
  	 while (NonBlank(curdisp)) begin
  	   if (curdisp==RepSpec.f1) then begin
  	     if (blank(dispbuildstr)) then begin
  	       dispbuildstr = RepSpec.f2;
  	     end else begin
  	       dispbuildstr = dispbuildstr & "," & RepSpec.f2;
  	     end;
  	     savef = true;
  	   end else begin
  	     if (blank(dispbuildstr)) then begin
  	       dispbuildstr = curdisp;
  	     end else begin
  	       dispbuildstr = dispbuildstr & "," & curdisp;
  	     end;
  	   end;
  	   ExtractObj(INr.DispGroups,pos,curdisp);
  	 end;
  	 if (savef) then begin
	     INr.DispGroups = dispbuildstr;
	     RECORDSTORE(INr,true);
	   end;
   end;
   LogProcTime("RenameCertainDIMn",getcurtick()-curtick);
LRenameCertainDIMn:;   

return;
end; //Edit***************************Sasha2,13:42 06.11.2015 }

global ///Edit***************************Sasha2,14:41 21.01.2016 {
updating procedure CurrencyRateToBase1RateMn(record RcVc RepSpec)
begin
	record BaseERVc BERr;
	record ERVc ERr;
	record BaseCurBlock BSr;
	Boolean TrHs;
	longint curtick;
		
		curtick = getcurtick();
    if (blank(RepSpec.f1)) then begin
      goto LCurrencyRateToBaseRateMn;
    end;
    BlockLoad(BSr);
    if (BSr.BaseCur1==RepSpec.f1 or BSr.BaseCur2!=RepSpec.f1) then begin
      goto LCurrencyRateToBaseRateMn;
    end;
   
    TrHs = true;
    ERr.CurncyCode = RepSpec.f1;
    while (LoopMain(ERr,1,TrHs)) begin
      if (ERr.CurncyCode!=RepSpec.f1) then begin TrHs = false; end;
      if (TrHs) then begin
        Recordnew(BERr);
        BERr.Date = ERr.Date;
        BERr.Rate1 = ERr.ToRate1;
        BERr.Rate2 = ERr.FrRate;
        recordstore(BERr,true);
      end;
    end;
   
  LCurrencyRateToBaseRateMn:;   
	LogProcTime("CurrencyRateToBase1RateMn",getcurtick()-curtick);
  return;
end; //Edit***************************Sasha2,14:41 21.01.2016 }

global ///Edit***************************Sasha2,14:41 21.01.2016 {
updating procedure BaseERToggleMn(record RcVc RepSpec)
begin
	record BaseERVc BERr,oldBERr,tempBERr;
	record BaseCurBlock BSr;
	longint curtick;

		curtick = getcurtick();
		BlockLoad(BSr);
		if (Blank(BSr.BaseCur1) and Blank(BSr.BaseCur1)) then begin
		  goto LBaseERToggleMn;
		end;
		RECORDNEW(tempBERr);
    while (LoopMain(BERr,1,true)) begin
      if (NonBlank(BERr.Rate1) and NonBlank(BERr.Rate2)) then begin
        //RecordCopy(oldBERr,BERr);
        tempBERr.Rate1 = BERr.Rate1;
        BERr.Rate1 = BERr.Rate2;
        BERr.Rate2 = tempBERr.Rate1;
        RecordStore(BERr,true);
        //RecordUpdate(oldBERr,BERr,true);
      end;
      
    end;
    
  LBaseERToggleMn:;
	LogProcTime("BaseERToggleMn",getcurtick()-curtick);
  return;
end; //Edit***************************Sasha2,14:41 21.01.2016 }

global //Edit***************************Sasha2,11:15 29.01.2016 {
updating procedure SetModelYDMn(record RcVc RepSpec)
begin
	record DIVc DIr;
	longint curtick;
	
	curtick = getcurtick();
	while(loopmain(DIr,1,true))begin
		if (Blank(DIr.CType)) then begin
		  DIr.CType = "MODEL";
		  RECORDSTORE(DIr,true);
		end;
	end;
	LogProcTime("SetModelYDMn",getcurtick()-curtick);
return;
end; //Edit***************************Sasha2,11:15 29.01.2016 }

global //Edit***************************Sasha2,11:15 29.01.2016 {
updating procedure RecalcFBFToCurMn()
begin
  record FBVc FBr;
  row FBVc FBrw;
  record TRVc TRr;
  row TRVc TRrw;
  vector val rates;
  string 7 monthyear;
  Boolean testf,tosavef,TrHs;
  integer rwcnt,i;
  val minval,t;
  date mindate;
    
    rates["1_2014"] = 0.7841;
    rates["2_2014"] = 0.7841;
    rates["3_2014"] = 0.7841;
    rates["4_2014"] = 0.7841;
    rates["5_2014"] = 0.7841;
    rates["6_2014"] = 0.7841;
    rates["7_2014"] = 0.7841;
    rates["8_2014"] = 0.7841;
    rates["9_2014"] = 0.7841;
    rates["10_2014"] = 0.7841;
    rates["11_2014"] = 0.7841;
    rates["12_2014"] = 0.7841;
    rates["1_2015"] = 0.7865;
    rates["2_2015"] = 0.867;
    rates["3_2015"] = 1.055;
    rates["4_2015"] = 1.059;
    rates["5_2015"] = 1.05;
    rates["6_2015"] = 1.05;
    rates["7_2015"] = 1.051;
    rates["8_2015"] = 1.053;
    rates["9_2015"] = 1.051;
    rates["10_2015"] = 1.05;
    rates["11_2015"] = 1.053;
    rates["12_2015"] = 1.292;
    rates["1_2016"] = 1.703;
    /*rates["2_2016"] = 1;
    rates["3_2016"] = 1;
    rates["4_2016"] = 1;
    rates["5_2016"] = 1;
    rates["6_2016"] = 1;
    rates["7_2016"] = 1;
    rates["8_2016"] = 1;
    rates["9_2016"] = 1;
    rates["10_2016"] = 1;
    rates["11_2016"] = 1;
    rates["12_2016"] = 1;*/
    
    minval = 0;
    
    FBr.SerNr = -1;
    while (LoopMain(FBr,1,true)) begin
      testf = true;
      monthyear = GetMonth(FBr.TransDate) & "_" & GetYear(FBr.TransDate);
      if (rates[monthyear]==0) then begin testf = false; end;
      if (testf) then begin
        rwcnt = MatRowCnt(FBr);
        if (rwcnt>0) then begin
          tosavef = false;
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(FBr,i,FBrw);
            if (AbsoluteVal(FBrw.DebVal)>minval) then begin
              tosavef = true;
              FBrw.DebVal = Round(FBrw.DebVal/rates[monthyear],SetRoundModeD(2));
              if (AbsoluteVal(FBrw.Deb2Val)>minval) then begin
                FBrw.Deb2Val = Round(FBrw.Deb2Val/rates[monthyear],SetRoundModeD(2));
              end;
            end;
            if (AbsoluteVal(FBrw.CredVal)>minval) then begin
              tosavef = true;
              FBrw.CredVal = Round(FBrw.CredVal/rates[monthyear],SetRoundModeD(2));
              if (AbsoluteVal(FBrw.Cred2Val)>minval) then begin
                FBrw.Cred2Val = Round(FBrw.Cred2Val/rates[monthyear],SetRoundModeD(2));
              end;
            end;
            MatRowPut(FBr,i,FBrw);
          end;
          if (tosavef) then begin
            FBSumup(FBr);
            RECORDSTORE(FBr,true);
          end;
        end;
      end;
    end;
    
    TrHs = true;
    mindate = StringToDate("1/02/2016");
    //TRr.TransDate = mindate;
    //TRr.Number = -1;
    while (LoopKey("TransDate",TRr,1,TrHs)) begin
      testf = true;
      monthyear = GetMonth(TRr.TransDate) & "_" & GetYear(TRr.TransDate);
      if (rates[monthyear]==0) then begin testf = false; end;
      if (TRr.TransDate>=mindate) then begin testf = false; TrHs = false; end;
      if (testf) then begin
        rwcnt = MatRowCnt(TRr);
        if (rwcnt>0) then begin
          tosavef = false;
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(TRr,i,TRrw);
            if (TRrw.stp==1) then begin
              if (AbsoluteVal(TRrw.DebVal)>minval) then begin
                tosavef = true;
                TRrw.DebVal = Round(TRrw.DebVal/rates[monthyear],SetRoundModeD(2));
                TRrw.FrRate = 1;
                TRrw.ToRateB1 = TRrw.DebVal/TRrw.CurDebVal;
              end;
              if (AbsoluteVal(TRrw.CredVal)>minval) then begin
                tosavef = true;
                TRrw.CredVal = Round(TRrw.CredVal/rates[monthyear],SetRoundModeD(2));
                TRrw.FrRate = 1;
                TRrw.ToRateB1 = TRrw.CredVal/TRrw.CurCredVal;
              end;
              MatRowPut(TRr,i,TRrw);
            end;
          end;
          if (tosavef) then begin
            TRSumup(TRr,t);
            t = TRr.DSum - AbsoluteVal(TRr.CSum);
            if (t!=0) then begin
              ClearRow(TRr,TRrw,1);
              TRrw.AccNumber = "84/02";
              MatRowInsert(TRr,rwcnt,TRrw);
              TRVc_PasteAccNumber(TRr,1,rwcnt,true);
              MatRowGet(TRr,rwcnt,TRrw);
              if (t>0) then begin
                TRrw.CredVal = t;
              end else begin
                TRrw.DebVal = AbsoluteVal(t);
              end;
              MatRowPut(TRr,rwcnt,TRrw);
              TRSumup(TRr,t);
            end;
            RECORDSTORE(TRr,true);
          end;
        end;
      end;
    end;

return;
end; //Edit***************************Sasha2,11:15 29.01.2016 }



global updating procedure FixItemHistoryMn()		//Edit----------------------Dima  04.02.2016
begin
	record ItemHistVc  IHr;
	record CompaniesBlock CBb;
	row CompaniesBlock CBrw;	
	integer cnt,mtrw,i;
	cnt=0;

	blockload(CBb);
	mtrw = matrowcnt(CBb);
	For(i=0;i<mtrw;i=i+1) begin
	  if (SetCompany(i+1,false)) then begin
	  
			LogText(0,"Company " & i);
			while(LoopMain(IHr,1,true)) begin
				if ((IHr.RemCostPriceCurncy - IHr.TotCostPriceCurncy/IHr.Qty*IHr.RemQty) < -0.001 or (IHr.RemCostPriceCurncy - IHr.TotCostPriceCurncy/IHr.Qty*IHr.RemQty) > 0.001) then begin
  		
					//IHr.RemCostPrice = IHr.TotCostPrice/IHr.Qty*IHr.RemQty;
					IHr.RemCostPriceCurncy = IHr.TotCostPriceCurncy/IHr.Qty*IHr.RemQty;
					RecordStore(IHr,true);
					cnt = cnt + 1;
					LogText(0,"ItemHistvc fixed  " & IHr.SerNr);
				end;	  				
			end;
			ResetLoop(IHr);
		ResetCompany(i+1);  
  	end;
	end; 	
	LogText(0,cnt & " records were restored");
end;


global //Edit***************************Sasha2,16:43 08.02.2016 {
updating procedure RenameCertainDI1Mn(record RcVc RepSpec)
begin
	record INVc INr;
	record DIVc DIr;
	Boolean savef;
	string 10 curdisp,disp1,disp2;
	string 255 dispbuildstr;
	Integer pos;
	longint curtick;

	curtick = getcurtick();
   if (blank(RepSpec.f1) or blank(RepSpec.f2)) then begin
     goto LRenameCertainDIMn;
   end;
   
   INr.Code = "";
   While(LoopMain(INr,1,true)) begin
  	 dispbuildstr = "";
  	 savef = false;
  	 pos = 0;
  	 ExtractObj(INr.DispGroups,pos,curdisp);
  	 while (NonBlank(curdisp)) begin
  	   if (curdisp==RepSpec.f1) then begin
  	     /*if (blank(dispbuildstr)) then begin
  	       dispbuildstr = RepSpec.f2;
  	     end else begin
  	       dispbuildstr = dispbuildstr & "," & RepSpec.f2;
  	     end;*/
  	     savef = true;
  	   end else begin
  	     if (blank(dispbuildstr)) then begin
  	       dispbuildstr = curdisp;
  	     end else begin
  	       dispbuildstr = dispbuildstr & "," & curdisp;
  	     end;
  	   end;
  	   ExtractObj(INr.DispGroups,pos,curdisp);
  	 end;
  	 if (savef) then begin
  	   pos = 0;
  	   ExtractObj(RepSpec.f2,pos,disp1);
  	   ExtractObj(RepSpec.f2,pos,disp2);
  	   if (NonBlank(disp1) and NonBlank(disp2)) then begin
    	   INr.MainDisp = disp1;
    	   if (disp1==disp2) then begin
    	     INr.DispGroups = disp1 & "," & dispbuildstr;
    	   end else begin
    	     INr.DispGroups = disp1 & "," & dispbuildstr & "," & disp2;
    	   end;
  	     RECORDSTORE(INr,true);
  	   end;
	   end;
   end;
   LogProcTime("RenameCertainDI1Mn",getcurtick()-curtick);
LRenameCertainDIMn:;   

return;
end; //Edit***************************Sasha2,16:43 08.02.2016 }

global //Edit***************************Sasha2,14:29 19.02.2016 {
updating procedure AggregateDataToJWMn(record RcVc RepSpec)
begin
	record INVc frINr,syncINr;
	record PLVc frPLr,toPLr;
	record ItemStatusVc ISr;
	record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
	integer oldcompany,sourcecomp,jwcomp,rwcnt,i,j,pldefcnt;
	Boolean includecompf,TrHs,testf,TrHs1;
	string 20 curitem;
	vector string 20 pldefartcode;
	vector val pldefprice;
	array string 10 pldeflist;
	LongInt foundflag;
	longint curtick;
		
		curtick = getcurtick();
		oldcompany = CurrentCompany;
		jwcomp = 3;
		BlockLoad(Compb);
    rwcnt = MatRowCnt(Compb);  
    for (j=0;j<rwcnt;j=j+1) begin
    	MatRowGet(Compb,j,Comprw);
    	includecompf = false;
    	switch (StringToInt(Comprw.CompCode)) begin //   .
    	  case 3: includecompf = false;
    	  otherwise 
    	    if (CompanyIsJWLikeCompany(StringToInt(Comprw.CompCode))) then begin
    	      includecompf = true;
    	    end else begin
    	      includecompf = false;
    	    end;
    	end;
    	if (includecompf) then begin
      	if (SetCompanyCode(Comprw.CompCode,false) and Comprw.ActiveStatus==0) then begin
      	  sourcecomp = CurrentCompany;
      	  ISr.Location = ";;;";
      	  TrHs1 = true;
      	  while (LoopKey("Location",ISr,1,TrHs1)) begin
      	    testf = true;
      	    if (ISr.Location!=";;;") then begin TrHs1 = false; end;
      	    if (TrHs1) then begin
      	      curitem = ISr.Code;
      	      frINr.Code = ISr.Code;
      	      if (ReadFirstMain(frINr,1,true)) then begin
        	      TrHs = true;
        	      pldefcnt = 0;
        	      frPLr.ArtCode = frINr.Code;
        	      while (LoopKey("ArtCode",frPLr,1,TrHs)) begin
        	        testf = true;
        	        if (frPLr.ArtCode!=frINr.Code) then begin TrHs = false; testf = false; end;
        	        if (testf) then begin 
        	          if (pldefartcode[frPLr.PLCode]!=frINr.Code) then begin
          	          pldefartcode[frPLr.PLCode] = frINr.Code;
          	          pldefprice[frPLr.PLCode] = frPLr.ExVatPrice;
          	          pldeflist[pldefcnt] = frPLr.PLCode;
          	          pldefcnt = pldefcnt + 1;
        	          end;
        	        end;
        	      end; RESETLOOP(frPLr);
        	      if (SetCompanyCode(jwcomp,false)) then begin
        	        syncINr.SyncFlag = 9999999999; //For WEB sync {
                  if (ReadLastKey("SyncFlag",syncINr,1,false)) then begin
                	  foundflag = syncINr.SyncFlag;
                  end;
                  frINr.SyncFlag = foundflag + 1;
                  frINr.SavedCount = syncINr.SavedCount + 1; //For WEB sync }
        	        if (RECORDSTORE(frINr,true)) then begin
        	          LogText(0,"ArtCode stored (From comp " & sourcecomp & " to comp " & CurrentCompany & "):" & Chr(9) & frINr.Code);
        	          for (i=0;i<pldefcnt;i=i+1) begin
        	            if (pldefartcode[pldeflist[i]]==frINr.Code) then begin
          	            toPLr.PLCode = pldeflist[i];
          	            toPLr.ArtCode = frINr.Code;
          	            if (ReadFirstMain(toPLr,2,true)) then begin
          	              toPLr.ExVatPrice = pldefprice[pldeflist[i]];
          	              if (RECORDSTORE(toPLr,true)) then begin
          	                LogText(0,"Price updated (From comp " & sourcecomp & " to comp " & CurrentCompany & "):" & Chr(9) & toPLr.ArtCode & Chr(9) & toPLr.PLCode & Chr(9) & toPLr.ExVatPrice);
          	              end;
          	            end else begin
          	              RECORDNEW(toPLr);
          	              toPLr.PLCode = pldeflist[i];
          	              toPLr.ArtCode = frINr.Code;
          	              toPLr.Comment = frINr.Name;
          	              toPLr.ExVatPrice = pldefprice[pldeflist[i]];
          	              if (RECORDSTORE(toPLr,true)) then begin
          	                LogText(0,"Price created (From comp " & sourcecomp & " to comp " & CurrentCompany & "):" & Chr(9) & toPLr.ArtCode & Chr(9) & toPLr.PLCode & Chr(9) & toPLr.ExVatPrice);
          	              end;
          	            end;  
        	            end;
        	          end;
        	        end;
        	        ResetCompany(sourcecomp);
        	      end;  
      	      end;
      	    end;
      	  end; RESETLOOP(ISr);
    		end;
    	end;
  	end;
	
	ResetCompany(oldcompany);
      
  LogProcTime("AggregateDataToJWMn",getcurtick()-curtick);    
LAggregateDataToJWMn:;   

return;
end; //Edit***************************Sasha2,14:28 19.02.2016 }



global //Edit_-_-_-_-_-_-_-_-Anton 11:28 07.06.2018
updating procedure CheckCurencyINVcMn(record RcVc RepSpec)
begin
	record INVc INr;
	record PUVc PUr;
	record ItemStatusVc ISr;
	row PUVc PUrw;
	LongInt rwcnt,i,oldcomp,cnt,j;
	record CompaniesBlock Cb;
	row CompaniesBlock Comprw;
	vector string 255 CheckProdCurencyV;
	array string 255 CheckProdCurencyAr;
	boolean TrHs;
	record PLDefVc PLDr;
	record PLVc PLr;
	longint curtick;
	
	curtick = getcurtick();
	PUr.SerNr = 0;
	cnt = 0;
	while(LoopMain(PUr,1,true)) begin
		if(PUr.PONr==-1 and PUr.CurncyCode!="AZN")then begin
			rwcnt = MatRowCnt(PUr);
			for(i=0;i<rwcnt;i=i+1)begin
				MatRowGet(PUr,i,PUrw);
				INr.Code = PUrw.ArtCode;
				if(ReadFirstMain(INr,1,true))then begin
					if(PUr.CurncyCode!=INr.LastPurchCurncyCode)then begin
						if(INr.LastPurchCurncyCode=="AZN" and INr.InPrice!=INr.LastPurchPrice2)then begin
							// logtext(0," PUSerNr> " & PUr.SerNr & " Code> " & INr.Code & " PUVc> " & PUr.CurncyCode & " INVc> " & INr.LastPurchCurncyCode);
							CheckProdCurencyV[INr.Code] = PUr.CurncyCode;
							CheckProdCurencyAr[cnt] = INr.Code;
							cnt = cnt + 1; 
						end;
					end;
				end;
			end;
		end;
	end;
	oldcomp = currentcompany;
	ResetLoop(PUr);
	for(i=1;i<26;i=i+1)begin
		if(SetCompany(i,false))then begin
			for(j=0;j<cnt;j=j+1)begin
				ISr.Code = CheckProdCurencyAr[j];
				TrHs = true;
				while(loopmain(ISr,1,TrHs)) begin
					if(ISr.Code!=CheckProdCurencyAr[j])then begin TrHs = false; end;
					if(ISr.Location!=";;;" and TrHs)then begin 
						logtext(0," CompNr> " & i & " Code> " & ISr.Code & " ourCode> " & CheckProdCurencyAr[j] & " Location> " & ISr.Location & " instock> " & ISr.Instock);
					end;
				end;
				ResetLoop(ISr);
			end;
		end;
	end;
	ResetCompany(oldcomp);
	for(j=0;j<cnt;j=j+1)begin
		ISr.Code = CheckProdCurencyAr[j];
		TrHs = true;
		PLDr.Code="";
		INr.Code = ISr.Code;
		if(ReadFirstMain(INr,1,true))then begin
			// logtext(0," CompNr> " & oldcomp & " Code> " & INr.LastPurchCurncyCode & " -> " & CheckProdCurencyV[INr.Code]);
			INr.LastPurchCurncyCode = CheckProdCurencyV[INr.Code];
			RecordStore(INr,true);
			
			While(loopmain(PLDr,1,true))begin
				if(matrowcnt(PLDr)>0)then begin
					if(PLDr.Code!="RRP")then begin
						PLr.PLCode = PLDr.Code;
						PLr.ArtCode = ISr.Code;
						readfirstmain(PLr,2,true);
						recorddelete(PLr);
						recordnew(RepSpec);
						RepSpec.f1 = PLDr.Code;
						RepSpec.f2 = ISr.Code;
						CalcPriceListsMn(RepSpec);
					end;
				end;
			end;
		end;
		ResetLoop(PLDr);
	end;
	LogProcTime("CheckCurencyINVcMn",getcurtick()-curtick);    
return;
end;



global //Edit***************************Sasha2,15:52 23.03.2016 {
updating procedure AggregateDispsJWMn(record RcVc RepSpec)
begin
	record INVc INr;
	record DIVc DIr;
	Boolean savef,foundf,collf,metalf;
	string 20 maindi,curdisp,collstr,metalstr;
	string 255 dispbuildstr,postfix;
	Integer pos;
  longint curtick;

	curtick = getcurtick();
  INr.Code = "";
  While(LoopMain(INr,1,true)) begin
  	if (NonBlank(INr.Reference) or NonBlank(INr.Metal) or NonBlank(INr.RowWeight) or NonBlank(INr.MajStoneDet)) then begin
      foundf = false;
      maindi = "";
      if (blank(INr.MainDisp)) then begin
        pos = 0;
      	ExtractObj(INr.DispGroups,pos,curdisp);
      	while (NonBlank(curdisp)) begin
          DIr.Code = curdisp;
          if (ReadFirstMain(DIr,1,true) and DIr.CType=="TYPE") then begin
            maindi = curdisp;
            pos = len(INr.DispGroups);
            foundf = true;
          end;
      	  ExtractObj(INr.DispGroups,pos,curdisp);
      	end;
      end else begin
        maindi = INr.MainDisp;
        foundf = true;
      end;
      if (foundf) then begin
        collf = false;
        metalf = false;
        savef = false;
        dispbuildstr = "";
        postfix = "";
        switch (maindi) begin
          case "ACCESSORIE":
            if (NonBlank(INr.Reference)) then begin
		          savef = true;
		          collf = true;
		          collstr = "COLL_A";
		          postfix = " Accessories";
		        end;
		        if (NonBlank(INr.Metal)) then begin
		          savef = true;
		          metalf = true;
		          metalstr = "MATERIAL_A";
		          postfix = " Accessories";
		        end;
          case "JEWELLERY":
            if (NonBlank(INr.Reference)) then begin
		          savef = true;
		          collf = true;
		          collstr = "COLL_J";
		          postfix = " Jewellery";
		        end;
		        if (NonBlank(INr.Metal)) then begin
		          savef = true;
		          metalf = true;
		          metalstr = "MATERIAL_J";
		          postfix = " Jewellery";
		        end;
		        if (NonBlank(INr.RowWeight)) then begin
		          savef = true;
		          DIr.Code = PrepareDICode("WM" & INr.RowWeight);
		          DIr.CType = "WEIGHT";
		          if (ReadFirstKey("CType",DIr,2,true)==false) then begin
		          	recordnew(DIr);
		            DIr.Code = PrepareDICode("WM" & INr.RowWeight);
		            DIr.Name = INr.RowWeight;
		            DIr.CType = "WEIGHT";
		            RECORDSTORE(DIr,true);
		          end;
		          if (blank(dispbuildstr)) then begin
         	      dispbuildstr = DIr.Code;
         	    end else begin
          	    dispbuildstr = dispbuildstr & "," & DIr.Code;
          	  end;
		        end;
		        if (NonBlank(INr.MajStoneDet)) then begin
		          savef = true;
		          DIr.Code = PrepareDICode("DC" & INr.MajStoneDet);
		          DIr.CType = "D_CARAT";
		          if (ReadFirstKey("CType",DIr,2,true)==false) then begin
		          	recordnew(DIr);
		            DIr.Code = PrepareDICode("DC" & INr.MajStoneDet);
		            DIr.Name = INr.MajStoneDet;
		            DIr.CType = "D_CARAT";
		            RECORDSTORE(DIr,true);
		          end;
		          if (blank(dispbuildstr)) then begin
         	      dispbuildstr = DIr.Code;
         	    end else begin
          	    dispbuildstr = dispbuildstr & "," & DIr.Code;
          	  end;
		        end;
          case "WATCH":
            if (NonBlank(INr.Reference)) then begin
		          savef = true;
		          collf = true;
		          collstr = "COLL_W";
		          postfix = " Watch";
		        end;
		        if (NonBlank(INr.Metal)) then begin
		          savef = true;
		          metalf = true;
		          metalstr = "MATERIAL_W";
		          postfix = " Watch";
		        end;
        end;
        postfix = ""; //Edit***************************Sasha2,17:47 07.06.2016
        if (collf) then begin
          savef = true;
          DIr.Code = PrepareDICode(INr.Reference);
          DIr.CType = collstr;
          if (ReadFirstKey("CType",DIr,2,true)==false) then begin
          	recordnew(DIr);
            DIr.Code = PrepareDICode(INr.Reference);
            DIr.Name = INr.Reference & postfix;
            DIr.CType = collstr;
            RECORDSTORE(DIr,true);
          end;
          if (blank(dispbuildstr)) then begin
     	      dispbuildstr = DIr.Code;
     	    end else begin
      	    dispbuildstr = dispbuildstr & "," & DIr.Code;
      	  end;
		    end;
		    if (metalf) then begin
          savef = true;
          DIr.Code = PrepareDICode(INr.Metal);
          DIr.CType = metalstr;
          if (ReadFirstKey("CType",DIr,2,true)==false) then begin
          	recordnew(DIr);
            DIr.Code = PrepareDICode(INr.Metal);
            DIr.Name = INr.Metal & postfix;
            DIr.CType = metalstr;
            RECORDSTORE(DIr,true);
          end;
          if (blank(dispbuildstr)) then begin
     	      dispbuildstr = DIr.Code;
     	    end else begin
      	    dispbuildstr = dispbuildstr & "," & DIr.Code;
      	  end;
		    end;
        if (savef and NonBlank(dispbuildstr)) then begin
          if (NonBlank(INr.DispGroups)) then begin
      	    INr.DispGroups = INr.DispGroups & "," & dispbuildstr;
      	  end else begin
      	    INr.DispGroups = dispbuildstr;
      	  end;
      	  RECORDSTORE(INr,true);
        end;
      end; 	  
  	end;
  end;
   LogProcTime("AggregateDispsJWMn",getcurtick()-curtick);    
LAggregateDispsJWMn:;   

return;
end; //Edit***************************Sasha2,15:52 23.03.2016 }

global //Edit***************************Sasha2,13:44 01.06.2016 {
function string 255 SaboPromotion(var record IVVc IVr,string opearation)
begin
  string 255 res,artList;
  record INVc INr;
  row IVVc IVrw;
  integer i,rwcnt;
  val saboSum;
  Boolean foundBrasletf;
  
    res = "";
    artList = "KA0001-001-12-L16,KA0001-001-12-L17,KA0001-001-12-L18,KA0001-001-12-L19,KA0001-001-12-L20,KA0001-001-12-L21,KA0001-001-12-L22,KA0001-001-12-L23";
    if (CurrentCompany==16 and ((CurrentDate >= StringToDate("2/06/2016") and CurrentDate <= StringToDate("12/06/2016")) or CurrentUser=="SA" or CurrentUser=="SA1")) then begin
      rwcnt = MatRowCnt(IVr);
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(IVr,i,IVrw);
        if (NonBlank(IVrw.ArtCode)) then begin
          INr.Code = IVrw.ArtCode;
          if (ReadFirstMain(INr,1,true) and INr.Group=="TH_SA") then begin
            if (SetInSet(IVrw.ArtCode,artList) and IVrw.vRebate==100) then begin
              foundBrasletf = true;
            end else begin
              saboSum = saboSum + IVrw.Sum;
            end;
          end;
        end;
      end;
      switch (opearation) begin
        case "paste":
          if (saboSum>=300 and foundBrasletf==false) then begin
            MatRowGet(IVr,rwcnt-1,IVrw);
            if (SetInSet(IVrw.ArtCode,artList) and (saboSum-IVrw.Sum)>=300) then begin
              IVrw.vRebate = 100;
              MatRowPut(IVr,rwcnt-1,IVrw);
              if (IVDchrsum(IVr,rwcnt-1)) then begin
                IVDchsum(IVr,rwcnt-1);
              end;
            end else begin
              res = "Promotional bracelet could be gifted";
            end;
          end;  
        case "check":
          if (saboSum<300 and foundBrasletf==true) then begin
            res = "\"Thomas Sabo\" total is less than 300 AZN for promotional bracelet";
          end;
        case "deletedrow":
          if (saboSum>=300 and foundBrasletf==false) then begin
            res = "Verify \"Thomas Sabo\" items for promotional bracelet";
          end;
      end;
    end;
  
  SaboPromotion = res;
  return;
end; //Edit***************************Sasha2,13:44 01.06.2016 }



global updating procedure FixLocalMachineMn()
begin
	record IVVc IVr;
	
	while(loopmain(IVr,1,true))begin
		
		if(IVr.MachineName=="KASSA2")then begin
			IVr.MachineName = "CC2";
			recordstore(IVr,true);
		end;
		if(IVr.Location=="KASSA1")then begin
			IVr.MachineName = "CC1";
			recordstore(IVr,true);
		end;
		
		/*if(IVr.MachineName=="KASSA")then begin
			IVr.MachineName = "X1";
			recordstore(IVr,true);
		end;
		if(IVr.MachineName=="KASSA.EXT2")then begin
			IVr.MachineName = "X2";
			recordstore(IVr,true);
		end;
		if(IVr.MachineName=="KASSA.EXT")then begin
			IVr.MachineName = "X1";
			recordstore(IVr,true);
		end;*/
	end;
	

return;
end;

global 
updating procedure RemovePostfixInDispMn()
begin
	record DIVc Dir;
	integer lenA,lenJ,lenW;
	
	 lenA = len(" Accessories");
	 lenJ = len(" Jewellery");
	 lenW = len(" Watch");
	
  	while(loopmain(Dir,1,true))begin
  	  if (len(Dir.Name)>lenA and (Dir.CType=="COLL_A" or Dir.CType=="MATERIAL_A")) then begin
  	    if (Right(Dir.Name,lenA)==" Accessories") then begin
  	      Dir.Name = left(Dir.Name,len(Dir.Name) - lenA);
  	      RECORDSTORE(Dir,true);
  	    end;
  	  end else begin
  	    if (len(Dir.Name)>lenJ and (Dir.CType=="COLL_J" or Dir.CType=="MATERIAL_J")) then begin
  	      if (Right(Dir.Name,lenJ)==" Jewellery") then begin
    	      Dir.Name = left(Dir.Name,len(Dir.Name) - lenJ);
    	      RECORDSTORE(Dir,true);
    	    end;
  	    end else begin
  	      if (len(Dir.Name)>lenW and (Dir.CType=="COLL_W" or Dir.CType=="MATERIAL_W")) then begin
  	        if (Right(Dir.Name,lenW)==" Watch") then begin
      	      Dir.Name = left(Dir.Name,len(Dir.Name) - lenW);
      	      RECORDSTORE(Dir,true);
      	    end;
  	      end;
  	    end;
  	  end;
  	end;
	

return;
end;

global 
updating procedure FixItemDIMn()
begin
  record INVc INr;
  record DIVc DIr;
  record LetVc Letr;
  array string 50 aTypeCode,aTypeName;
  integer pos,i,ln;
  string 50 class;
  boolean testf,TrHs;
  
  DIr.CType = "TYPE";
  TrHs = true;
  while (loopkey("CType",DIr,1,TrHs)) begin
    if(DIr.CType!="TYPE")then begin TrHs = false; end;
    if(TrHs)then begin
      aTypeCode[i] = DIr.Code;
      aTypeName[i] = DIr.Name;
      i = i + 1;
    end;
  end;
  ln = aTypeCode.length;
  INr.Code = "";
  while (loopmain(INr,1,true)) begin
    testf = true;
    pos = 0;
    class = "";
    ExtractObj(INr.DispGroups,pos,class);
    while (nonblank(class)) begin
      DIr.Code = class;
      readfirstmain(DIr,1,true);
      if (DIr.CType=="TYPE") then begin
        testf = false;
      end;
      ExtractObj(INr.DispGroups,pos,class);
      if (!testf) then begin
        class = "";
      end;
    end;
    if (testf) then begin
      RecordClear(Letr);
      AddToText(INr.Name,Letr);
      for (i=0;i<ln;i=i+1) begin
        if (StringInText(aTypeName[i],Letr)) then begin
          if (right(INr.DispGroups,1)==",") then begin
            INr.DispGroups = INr.DispGroups & aTypeCode[i];
          end else begin
            INr.DispGroups = INr.DispGroups & "," & aTypeCode[i];
          end;
          i = ln;
        end;
      end;
      RecordStore(INr,true);
    end;
  end;
  
  
  return;
end;

global updating procedure FixSomeIHCostMn()
begin
	record ItemHistVc IHr,sourceIHr;
	record StockMovVc SMr;
	row StockMovVc SMrw;
	record SHVc SHr;
	row SHVc SHrw;
	record IVVc IVr;
	row IVVc IVrw;
	record SDVc SDr;
	row SDVc SDrw;
	record RetVc Retr;
	row RetVc Retrw;
	record ProdVc Prodr;
	row ProdVc Prodrw;
	record POVc POr;
  row POVc POrw;
  record PUVc PUr,PU2r;
  row PUVc PUrw,PU2rw;
	
  boolean TrHs,testf;
	val wrongSum,wrongcost,propercost,propercostcur,qty;
	integer mtrw,mi;
  area tmparea,tmparea1;
  string 255 fn;
	
	PUr.SerNr = "448";
  readfirstmain(PUr,1,true);
  mtrw = matrowcnt(PUr);
	for (mi=0;mi<mtrw;mi=mi+1) begin
    matrowget(PUr,mi,PUrw);
    if ((PUrw.Quant>1) and (PUrw.CostPrice>0)) then  begin
      AddTextToArea("----- item " & PUrw.ArtCode & " -----" & chr(13) & chr(10),tmparea);
      qty = PUrw.Quant;
      wrongSum = PUrw.Sum;
      wrongcost = PUrw.CostPrice;
      propercost = PUrw.CostPrice/qty;
      propercostcur = PUrw.UPrice/qty;
      IHr.ArtCode = PUrw.ArtCode;
      IHr.TransDate = PUr.TransDate;
      TrHs = true;
      resetloop(IHr);
      while (loopkey("ArtCode",IHr,2,TrHs)) begin
        testf = true;
        if (IHr.ArtCode!=PUrw.ArtCode) then begin TrHs = false; testf = false; end;
        if (IHr.TransDate<PUr.TransDate) then begin testf = false; end;
        if ((IHr.TotCostPrice/IHr.Qty)!=wrongcost) and ((IHr.TotCostPrice/IHr.Qty)!=-wrongcost) and
           ((IHr.TotCostPrice)!=wrongSum) and ((IHr.TotCostPrice)!=-wrongSum) then begin testf = false; end;
        if (testf) then begin
          if (IHr.Qty<0) then begin
						IHr.TotCostPrice = -propercost*IHr.Qty;
            IHr.TotCostPriceCurncy = -propercostcur*IHr.Qty;
					end else begin
						IHr.TotCostPrice = propercost*IHr.Qty;
            IHr.TotCostPriceCurncy = propercostcur*IHr.Qty;
					end;
          if (nonblank(IHr.RemQty) and (IHr.RemQty!=0)) then begin
            IHr.RemCostPrice = propercost*IHr.RemQty;
            IHr.RemCostPriceCurncy = propercostcur*IHr.RemQty;
          end;
          switch(IHr.FileName)begin
            case "PUVc":
              PU2r.SerNr = IHr.TransNr;
              if (readfirstmain(PU2r,1,true)) then begin
                matrowget(PU2r,IHr.Row,PU2rw);
                  PUrw.CostPrice = propercost;
                  PUrw.UPrice = propercostcur;
                  PUrw.Sum = propercost*qty;
                  POr.SerNr = PUr.PONr;
                  if (readfirstmain(POr,1,true)) then begin
                    matrowget(POr,PUrw.OrdRow,POrw);
                    POrw.Price = propercost;
                    POrw.Sum = propercost*qty;
                    matrowput(POr,PUrw.OrdRow,POrw);
                    recordstore(POr,true);
                    AddTextToArea("POVc - " & POr.SerNr & " " & PUrw.OrdRow & chr(13) & chr(10),tmparea);
                  end;
                matrowput(PU2r,IHr.Row,PU2rw);
                recordstore(PU2r,true);
                AddTextToArea(IHr.FileName & " - " & IHr.TransNr & " " & IHr.Row & chr(13) & chr(10),tmparea);
              end;
						case "SHVc":
              SHr.SerNr = IHr.TransNr;
              if(readfirstmain(SHr,1,true))then begin
                matrowget(SHr,IHr.Row,SHrw);
                  SHrw.FIFO = propercost;
                  SHrw.FIFORowVal = propercost * SHrw.Ship;
                matrowput(SHr,IHr.Row,SHrw);
                recordstore(SHr,true);
                AddTextToArea(IHr.FileName & " - " & IHr.TransNr & " " & " item - " & IHr.Row & chr(13) & chr(10),tmparea);
              end;
						case "SDVc":
              SDr.SerNr = IHr.TransNr;
              if(readfirstmain(SDr,1,true))then begin
                matrowget(SDr,IHr.Row,SDrw);
                  SDrw.FIFO = propercost;
                  SDrw.FIFORowVal = propercost * SDrw.Qty;
                matrowput(SDr,sourceIHr.Row,SDrw);
                recordstore(SDr,true);
                AddTextToArea(IHr.FileName & " - " & IHr.TransNr & " " & " item - " & IHr.Row & chr(13) & chr(10),tmparea);
              end;
						case "RetVc":
              Retr.SerNr = IHr.TransNr;
              if(readfirstmain(Retr,1,true))then begin
                matrowget(Retr,IHr.Row,Retrw);
                  Retrw.UPrice = propercost;
                  Retrw.CostPrice = propercost;
                matrowput(Retr,sourceIHr.Row,Retrw);
                recordstore(Retr,true);
                AddTextToArea(IHr.FileName & " - " & IHr.TransNr & " " & " item - " & IHr.Row & chr(13) & chr(10),tmparea);
              end;
						case "IVVc":
              IVr.SerNr = IHr.TransNr;
              if(readfirstmain(IVr,1,true))then begin
                matrowget(IVr,IHr.Row,IVrw);
                  IVrw.BasePrice = propercost;
                  IVrw.rowGP = IVrw.Quant*IVrw.Price*(1-IVrw.vRebate/100) - propercost * IVrw.Quant;
                  IVrw.FIFO = propercost;
                  IVrw.FIFORowVal = propercost * IVrw.Quant;
                matrowput(IVr,IHr.Row,IVrw);
                recordstore(IVr,true);
                AddTextToArea(IHr.FileName & " - " & IHr.TransNr & " " & " item - " & IHr.Row & chr(13) & chr(10),tmparea);
              end;
						case "StockMovVc":
              AddTextToArea(IHr.TransNr & " " & IHr.Row & " item - " & PUrw.ArtCode & chr(13) & chr(10),tmparea1);
              /*SMr.SerNr = IHr.TransNr;
              if(readfirstmain(SMr,1,true))then begin
                matrowget(SMr,sourceIHr.Row,SMrw);
                  SMrw.OldPrice = propercost;
                  SMrw.NewPrice = propercost;
                  SMrw.FIFORowVal = propercost * SMrw.Quant;
                matrowput(SMr,IHr.Row,SMrw);
                recordstore(SMr,true);
              end;*/
						case "ProdVc":
              Prodr.SerNr = IHr.TransNr;
              if(readfirstmain(Prodr,1,true))then begin
                matrowget(Prodr,IHr.Row,Prodrw);
                  Prodrw.ItemCost = propercost;
                  if(Prodrw.InQty>0)then begin
                    Prodrw.FIFORowVal = propercost * Prodrw.InQty;
                  end;
                  if(Prodrw.OutQty>0)then begin
                    Prodrw.FIFORowVal = propercost * Prodrw.OutQty;
                  end;
                matrowput(Prodr,IHr.Row,Prodrw);
                recordstore(Prodr,true);
                AddTextToArea(IHr.FileName & " - " & IHr.TransNr & " " & " item - " & IHr.Row & chr(13) & chr(10),tmparea);
              end;
            otherwise
              AddTextToArea(IHr.FileName & " - " & IHr.TransNr & " " & " item - " & PUrw.ArtCode & IHr.Row & " otherwise" & chr(13) & chr(10),tmparea);
					end;
          recordstore(IHr,true);
        end;
      end;
    end;
  end;
  if (windowsmode==1) then begin
    fn = "FixSomeIHCostMn.log";
  end else begin
    fn = "/FixSomeIHCostMn.log";
  end;
  if (fileexists(fn)) then begin
    delete_file(fn);
  end;
  writeareatofile(tmparea,fn,1);
  if (windowsmode==1) then begin
    fn = "StockMovTOFIX.log";
  end else begin
    fn = "/StockMovTOFIX.log";
  end;
  if (fileexists(fn)) then begin
    delete_file(fn);
  end;
  writeareatofile(tmparea1,fn,1);
  return;
end;

global //Edit***************************Sasha2,15:26 01.02.2017 {
updating procedure FixTRCurBalanceIfBaseCurMn()
begin
  record BaseCurBlock BCb;
  record IVVc IVr;
  record MainVc mainr;
  record TRVc TRr;
	row TRVc TRrw;
  Array string 10 AccList;
  Array string 100 CustomersList;
  vector val CustomerDiffBalance;
  vector boolean CustomerAddedToList;
  integer i,j,acccount,rwcnt;
  string 30 customer;
  boolean TrHs,testf,storeF;
  val diffBal;
  
    AccList[0] = "62";
    AccList[1] = "75/02";
    acccount = AccList.length;
    BlockLoad(BCb);
    
    CustomersList[0] = "BLANKCUSTOMER";
    CustomerAddedToList["BLANKCUSTOMER"] = true;
    
    for (i=0;i<acccount;i=i+1) begin
  		/*for (j=0;j<CustomersList.length;j=j+1) begin
    		CustomerDiffBalance[CustomersList[j]] = blankval;
		  end; */
      
      mainr.AccNumber = AccList[i];
  		TrHs = true;
  		while (LoopMain(mainr,1,TrHs)) begin
  			if ((mainr.AccNumber!=AccList[i]))  then begin
  				TrHs = false;	
  			end;
  			if (TrHs) then begin
  				if (mainr.FileName=="TRVc") then begin
  					TRr.Number = mainr.TransNr;
  					TRr.IntYc = mainr.IntYc;
  					if (ReadFirstMain(TRr,2,true)) then begin
  						if (mainr.TransDate==TRr.TransDate) then begin
  						  storeF = false;
  							/*IVr.CustCode = "";
  							if (TRr.IntYc==IVYc) then begin
  							  IVr.SerNr = TRr.Number;
  								ReadFirstMain(IVr,1,true);
  							end;*/
  							rwcnt = MatRowCnt(TRr);
  							for (j=0;j<rwcnt;j=j+1) begin
  								MatRowGet(TRr,j,TRrw);
  								testf = true;
  								if ((TRrw.AccNumber!=AccList[i]) or (TRrw.ovst==1) or (TRrw.stp!=1)) then begin testf = false; end;
  								if (TRrw.Curncy!=BCb.BaseCur1) then begin testf = false; end;
  								if (TRrw.CredVal<>0 and TRrw.CredVal==TRrw.CurCredVal) then begin testf = false; end;
  								if (TRrw.DebVal<>0 and TRrw.DebVal==TRrw.CurDebVal) then begin testf = false; end;
  								if (testf) then begin
										/*customer = TRrw.CompCode;
										if (blank(customer)) then begin
											customer = TRrw.CustCode;
										end;
										if (blank(customer) and TRr.IntYc==IVYc) then begin
											customer = IVr.CustCode;
										end;
										if (blank(customer)) then begin
											customer = "BLANKCUSTOMER";
										end;
										if (CustomerAddedToList[customer]==false) then begin
											CustomersList[CustomersList.length] = customer;
											CustomerAddedToList[customer] = true;
										end;*/
										
										if (TRrw.CredVal<>0) then begin
										  TRrw.CurCredVal = TRrw.CredVal;
										  MatRowPut(TRr,j,TRrw);
										  storeF = true;
										end else begin
										  if (TRrw.DebVal<>0) then begin
										    TRrw.CurDebVal = TRrw.DebVal;
										    MatRowPut(TRr,j,TRrw);
										    storeF = true;
										  end;
										end;
  								end;
  							end;
  							if (storeF) then begin
  							  RECORDSTORE(TRr,true); LogText(0," Transaction:" & TRr.IntYc & "." & TRr.Number & Chr(9) & "(Check code \"" & TRr.IntYc & "\" to get document allias)" );
  							end;
  						end;
  					end;
  				end;
  			end;
  		end;
  		ResetLoop(mainr);
      
    end;
    

  return;
end; //Edit***************************Sasha2,15:26 01.02.2017 }

global //Edit***************************Sasha2,9:56 31.03.2017 {
updating procedure UpdateSellPricesViaCustomRatesMn(record RcVc RepSpec)
begin
  record RcVc RepSpec2;
  record INVc INr;
  record PLVc PLr;
  Boolean testf;
  val EURrate,USDrate,CHFrate;
  roundmode rnd;
  longint curtick;
	
	curtick = getcurtick();
    rnd = DefaultValRoundoff;
    rnd.decimals = 0;
    rnd.step = kRoundingStepNone;
    rnd.mode = kRoundingModeHalfUp;
    
    if (NonBlank(RepSpec.f1)) then begin
      EURrate = AbsoluteVal(RepSpec.vals0);
      USDrate = AbsoluteVal(RepSpec.vals1);
      CHFrate = AbsoluteVal(RepSpec.vals2);
      
      RECORDNEW(RepSpec2);
      RepSpec2.f1 = "RRP";
      RepSpec2.f3 = RepSpec.f1; //item group
      CalcPriceListsMn(RepSpec2);
      
      INr.Code = "";
      while (LoopMain(INr,1,true)) begin
        testf = true;
        if (NonBlank(RepSpec.f1) and RepSpec.f1!=INr.Group) then begin testf = false; end;
        if (NonBlank(RepSpec.f2) and SetInSet(RepSpec.f2,INr.DispGroups)==false) then begin testf = false; end;
        if (testf) then begin
          PLr.PLCode = "RRP";
          PLr.ArtCode = INr.Code;
          if (ReadFirstMain(PLr,2,true)) then begin
            if (PLr.ExVatPrice<>0) then begin
              switch (PLr.CurncyCode) begin
                case "EUR":
                  if (EURrate<>0) then begin
                    PLr.ExVatPrice = Round(PLr.ExVatPrice*EURrate,rnd);
                    PLr.CurncyCode = "AZN";
                    RECORDSTORE(PLr,true);
										UpdatePrice(PLr);
                  end;
                case "USD":
                  if (USDrate<>0) then begin
                    PLr.ExVatPrice = Round(PLr.ExVatPrice*USDrate,rnd);
                    PLr.CurncyCode = "AZN";
                    RECORDSTORE(PLr,true);
										UpdatePrice(PLr);
                  end;
                case "CHF":
                  if (CHFrate<>0) then begin
                    PLr.ExVatPrice = Round(PLr.ExVatPrice*CHFrate,rnd);
                    PLr.CurncyCode = "AZN";
                    RECORDSTORE(PLr,true);
										UpdatePrice(PLr);
                  end;
              end;
            end;
          end;
        end;
      end;
         
    end;
	LogProcTime("UpdateSellPricesViaCustomRatesMn",getcurtick()-curtick);    
  return;
end; //Edit***************************Sasha2,9:56 31.03.2017 }

global //Edit***************************Sasha2,9:56 31.03.2017 {
updating procedure SetItemGroupByClassificationMn(record RcVc RepSpec)
begin
  record INVc INr;
  Boolean testf;
	longint curtick;
	
	curtick = getcurtick();
    if (NonBlank(RepSpec.f1) and NonBlank(RepSpec.f2)) then begin
      INr.Code = "";
      while (LoopMain(INr,1,true)) begin
        testf = true;
        if (SetInSet(RepSpec.f2,INr.DispGroups)==false) then begin testf = false; end;
        if (testf) then begin
          INr.Group = RepSpec.f1;
          RECORDSTORE(INr,true);
        end;
      end;
    end;
	LogProcTime("SetItemGroupByClassificationMn",getcurtick()-curtick);   
  return;
end; //Edit***************************Sasha2,9:56 31.03.2017 }

global
procedure ParsePhones(string inpphone, var integer arrlen, var array string phones)
begin
  integer i,chrcode;
  string 1 char;

  char = "";
  chrcode = 0;
  for (i=0;i<=arrlen;i=i+1) begin
    phones[i] = "";
  end;
  arrlen = 0;
  for (i=0;i<len(inpphone);i=i+1) begin
    char = mid(inpphone,i,1);
    chrcode = asc(char);
    if ((chrcode>=48) and (chrcode<=57) or char=="+") then begin
      phones[arrlen] = phones[arrlen] & char;
    end;
    if ((char==",") or (char==".") or (char==";")) then begin
      arrlen = arrlen + 1;
    end;
  end;
  
  return;
end;


global
updating procedure CUVcPhoneClearMn()
begin
  record CUVc CUr;
  string 255 phone;
  integer i,chrcode;
  string 1 char;
  
  while (LoopMain(CUr,1,true)) begin
    char = "";
    chrcode = 0;
    phone = "";
    for (i=0;i<len(CUr.Phone);i=i+1) begin
      char = mid(CUr.Phone,i,1);
      chrcode = asc(char);
      if ((chrcode>=48) and (chrcode<=57)) then begin
        phone = phone & char;
      end;
    end;
    CUr.Phone = phone;
    
    char = "";
    chrcode = 0;
    phone = "";
    for (i=0;i<len(CUr.AltPhone);i=i+1) begin
      char = mid(CUr.AltPhone,i,1);
      chrcode = asc(char);
      if ((chrcode>=48) and (chrcode<=57)) then begin
        phone = phone & char;
      end;
    end;
    CUr.AltPhone = phone;
    
    char = "";
    chrcode = 0;
    phone = "";
    for (i=0;i<len(CUr.Mobile);i=i+1) begin
      char = mid(CUr.Mobile,i,1);
      chrcode = asc(char);
      if ((chrcode>=48) and (chrcode<=57)) then begin
        phone = phone & char;
      end;
    end;
    CUr.Mobile = phone;
    RecordStore(CUr,true);
  end;
  
  return;
end;

global
updating procedure FillPhoneVcMn()
begin
  record CUVc CUr;
  record PhoneVc Phoner;
  array string 255 phones;
  integer i,phonesqty;
  
  Phoner.PhoneNum = "";
	while(loopmain(Phoner,1,true))begin
		recorddelete(Phoner);
		stepback(Phoner);
	end;
  
  while (LoopMain(CUr,1,true)) begin
    if nonblank(CUr.Phone) then begin
      ParsePhones(CUr.Phone,phonesqty,phones);
      for (i=0;i<=phonesqty;i=i+1) begin
        recordnew(Phoner);
        Phoner.PhoneNum = phones[i];
        Phoner.CUCode = CUr.Code;
        recordStore(Phoner,true);
      end;
    end;
    if nonblank(CUr.AltPhone) then begin
      ParsePhones(CUr.AltPhone,phonesqty,phones);
      for (i=0;i<=phonesqty;i=i+1) begin
        recordnew(Phoner);
        Phoner.PhoneNum = phones[i];
        Phoner.CUCode = CUr.Code;
        recordStore(Phoner,true);
      end;
    end;
    if nonblank(CUr.Mobile) then begin
      ParsePhones(CUr.Mobile,phonesqty,phones);
      for (i=0;i<=phonesqty;i=i+1) begin
        recordnew(Phoner);
        Phoner.PhoneNum = phones[i];
        Phoner.CUCode = CUr.Code;
        recordStore(Phoner,true);
      end;
    end;
  end;
  
  return;
end;

global //Edit***************************Sasha2,11:02 23.05.2017 {
updating procedure CopyLoyaltyBalanceToNewCard(var record LoyaltyCardVc newLoyaltyCardr)
begin
  record LoyaltyCardVc LoyaltyCardr,oldLoyaltyCardr;
  Boolean TrHs,testf,foundf;  
    
    if (NonBlank(newLoyaltyCardr.CustCode) and newLoyaltyCardr.PointsBalance==BlankVal) then begin
      LoyaltyCardr.CustCode = newLoyaltyCardr.CustCode;
      TrHs = true;
      while (LoopBackKey("ActCustCode",LoyaltyCardr,1,TrHs)) begin
        testf = true;
        if (LoyaltyCardr.CustCode!=newLoyaltyCardr.CustCode) then begin TrHs = false; testf = false; end;
        if (LoyaltyCardr.SerNr==newLoyaltyCardr.SerNr) then begin testf = false; end;
        if (LoyaltyCardr.LCMLevel!=newLoyaltyCardr.LCMLevel) then begin testf = false; end;
        if (testf) then begin
          foundf = true;
          TrHs = false;
        end;
      end;
    end;
    if (foundf) then begin
      newLoyaltyCardr.PointsBalance = LoyaltyCardr.PointsBalance;
      newLoyaltyCardr.StartBalance = LoyaltyCardr.PointsBalance;
      newLoyaltyCardr.PointsBalanceTotal = LoyaltyCardr.PointsBalanceTotal;
      newLoyaltyCardr.CashbackLevelPoints = LoyaltyCardr.CashbackLevelPoints;
      RecordCopy(oldLoyaltyCardr,LoyaltyCardr);
      LoyaltyCardr.Closed = 1;
      recordstore(LoyaltyCardr,true);
      //if (RecordUpdate(oldLoyaltyCardr,LoyaltyCardr,false)==0) then begin 
        LogText(0,"Loyalty card was closed #" & LoyaltyCardr.SerNr);
        SendUpdateLoyaltyCardToCRM(LoyaltyCardr);
      //end;
      CreateLoyalActivity(LoyaltyCardr,"CLOSED");
    end;

  return;
end; //Edit***************************Sasha2,11:02 23.05.2017 }

global updating procedure SetCustomRabateMn()
begin
	record CUVc CUr;
	boolean testf;
	
	while(loopmain(CUr,1,true))begin
		testf = true;
		//if(blank(CUr.CustCat))then begin testf = false; end;
		//if(CUr.CustCat=="")then begin testf = false; end;
		if(CUr.CUType==0)then begin testf = false; end;
		
		if(testf and blank(CUr.RebCode))then begin
			CUr.RebCode = "0%";
			recordstore(CUr,true);
		end;
	end;
	
return;
end;

global //Edit***************************Sasha2,16:37 19.06.2017 {
updating procedure FindCostForItemWithEmptyCostMn(record RcVc RepSpec)
begin
  record ItemHistVc IHr;
  record PUVc PUr;
	row PUVc PUrw;
  Boolean TrHs,testf,saveF;
  string 5 curncy;
  val itemCost;
	longint curtick;
	
	curtick = getcurtick();
    if (NonBlank(RepSpec.f1)) then begin
      TrHs = true;
      IHr.ArtCode = RepSpec.f1;
      while (LoopKey("ArtCode",IHr,1,TrHs)) begin
        testf = true;
        if (IHr.ArtCode!=RepSpec.f1) then begin TrHs = false; testf = false; end;
        if (IHr.StockAffectf==0) then begin testf = false; end;
        if (testf) then begin
          saveF = false;
          if (IHr.FileName=="PUVc") then begin
            itemCost = IHr.TotCostPriceCurncy/IHr.Qty;
            curncy = IHr.CurncyCode;
            if (itemCost==0 or Blank(curncy)) then begin
              PUr.SerNr = IHr.TransNr;
              if (ReadFirstMain(PUr,1,true)) then begin
                MatRowGet(PUr,IHr.Row,PUrw);
                if (PUrw.ArtCode==IHr.ArtCode) then begin
                  itemCost = round(PUrw.Sum/PUrw.Quant,defaultcurroundoff);
                  curncy = PUr.CurncyCode;
                end;
              end;
            end;
          end else begin
            if (NonBlank(curncy) and itemCost>0) then begin
              if (IHr.TotCostPriceCurncy==0 or IHr.CurncyCode!=curncy) then begin
                IHr.TotCostPriceCurncy = AbsoluteVal(IHr.Qty)*itemCost;
                IHr.CurncyCode = curncy;
                if (IHr.RemQty>0) then begin
                  IHr.RemCostPriceCurncy = IHr.RemQty*itemCost;
                end;
                saveF = true;
              end;
            end;
          end;
          if (saveF) then begin
            RECORDSTORE(IHr,true);
          end;
        end;
      end;
    end;
	LogProcTime("FindCostForItemWithEmptyCostMn",getcurtick()-curtick);   
  return;
end; //Edit***************************Sasha2,16:38 19.06.2017 }


global updating procedure AddPModeMn(record RcVc RepSpec)
begin
	record PMBlock PMb;
	row PMBlock PMrw;
	integer i,mtrw;
	longint curtick;
	
	curtick = getcurtick();
	blockload(PMb);
	
	mtrw = matrowcnt(PMb);
	
	if(nonblank(RepSpec.f1) and nonblank(RepSpec.f2))then begin
		PMrw.Code = RepSpec.f1;
		PMrw.AccNr = RepSpec.f2;
		PMrw.Comment = RepSpec.f3;
		PMrw.Objects = RepSpec.f4;
		matrowput(PMb,mtrw,PMrw);
		blockstore(PMb);
		logtext(0,"AddPModeMn");
	end;
	
	LogProcTime("AddPModeMn",getcurtick()-curtick);  
return;
end;

global updating procedure AddVATCodeMn(record RcVc RepSpec)
begin
	record VATCodeBlock VCb;
	row VATCodeBlock VCrw;
	integer i,mtrw;
	longint curtick;
	
	curtick = getcurtick();
	blockload(VCb);
	
	mtrw = matrowcnt(VCb);
	
	if(nonblank(RepSpec.f1))then begin
		VCrw.VATCode = RepSpec.f1;
		VCrw.ExVatpr = RepSpec.vals0;
		VCrw.IncVatpr = RepSpec.vals1;
		VCrw.SalesVATAcc = RepSpec.f2;
		VCrw.PaySalesVATAcc = RepSpec.f3;
		
		matrowput(VCb,mtrw,VCrw);
		blockstore(VCb);
	end;
	
	LogProcTime("AddVATCodeMn",getcurtick()-curtick);  
return;
end;

global //Edit***************************Sasha2,17:24 13.07.2017 {
procedure CheckForCashbackCorrection(var record IVVc IVr,val initCBPercent,val paidViaPoints,var roundmode rnd)
begin
  record LCCashbackCorrectionVc LCCBCorr;
  row LCCashbackCorrectionVc LCCBCorrw;
  row IVVc IVrw;
  record INVc INr;
  record BaseCurBlock BCb;
  Boolean corrFound;
  date blankd;
  Integer i,rwcnt,ivRwcnt;
  val ivTotal,ivTotalB,rowSum,rowsPoints,promotionCBPercent,rowCBPercent;
  vector val groupCBPercent,itemCBPercent;
  vector boolean groupCBPercentF,itemCBPercentF;
  Boolean TrHs,testf,foundF;
  Time ivTime;
  
    BlockLoad(BCb);
    if (NonBlank(IVr.LCMLevel)) then begin
      ivTotal = IVr.Sum4;
      ivTime = IVr.TransTime;
      if (BlankTime(ivTime)) then begin
        ivTime = CurrentTime;
      end;
      LCCBCorr.LCMLevel = IVr.LCMLevel;
      LCCBCorr.CustomerPercentLevel = initCBPercent;
      LCCBCorr.FromDate = IVr.InvDate;
      TrHs = true;
      corrFound = false;
      while (LoopBackKey("LCMLevel",LCCBCorr,3,TrHs)) begin
        testf = true;
        if (LCCBCorr.LCMLevel!=IVr.LCMLevel or LCCBCorr.CustomerPercentLevel!=initCBPercent) then begin TrHs = false; testf = false; end;
        if (DateInRange(IVr.InvDate,LCCBCorr.FromDate,LCCBCorr.ToDate)==false) then begin TrHs = false; testf = false; end;
        if (NonBlankTime(LCCBCorr.FromTime) and  NonBlankTime(LCCBCorr.ToTime) and TimeInRange(ivTime,LCCBCorr.FromTime,LCCBCorr.ToTime)==false) then begin testf = false; end;
        if (testf) then begin
          corrFound = true;
          TrHs = false;
        end;
      end; RESETLOOP(LCCBCorr);     
      
      if (corrFound==false) then begin //!!!!!! if a necessity to separate blankdate LCCashbackCorrectionVc records according to time range will appear, update LCCashbackCorrectionVcRecordCheck(...) too
        LCCBCorr.LCMLevel = IVr.LCMLevel;
        LCCBCorr.CustomerPercentLevel = initCBPercent;
        LCCBCorr.FromDate = blankd;
        corrFound = ReadFirstKey("LCMLevel",LCCBCorr,3,true);
        if (corrFound) then begin
          if (LCCBCorr.LCMLevel!=IVr.LCMLevel or LCCBCorr.CustomerPercentLevel!=initCBPercent) then begin corrFound = false; end;
          if (NonBlankDate(LCCBCorr.FromDate) or NonBlankDate(LCCBCorr.ToDate)) then begin corrFound = false; end;
        end;
      end;
      if (corrFound) then begin
        promotionCBPercent = LCCBCorr.CashbackPercent;
        rnd.decimals = LCCBCorr.RndTo;
        rwcnt = MatRowCnt(LCCBCorr);
        if (rwcnt>0) then begin
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(LCCBCorr,i,LCCBCorrw);
            switch (LCCBCorrw.CodeType) begin
              case 0:
                groupCBPercent[LCCBCorrw.ITCode] = LCCBCorrw.CashbackPercent;
                groupCBPercentF[LCCBCorrw.ITCode] = true;
              case 1:
                itemCBPercent[LCCBCorrw.ITCode] = LCCBCorrw.CashbackPercent;
                itemCBPercentF[LCCBCorrw.ITCode] = true;
            end;
          end;
          ivRwcnt = MatRowCnt(IVr);
          if (ivRwcnt>0) then begin
            for (i=0;i<ivRwcnt;i=i+1) begin
              MatRowGet(IVr,i,IVrw);
              if (IVrw.stp==kInvoiceRowTypeNormal and NonBlank(IVrw.ArtCode)) then begin
                INr.Code = IVrw.ArtCode;
                if (ReadFirstMain(INr,1,true)) then begin
                  foundF = false;
                  if (itemCBPercentF[INr.Code]) then begin
                    rowCBPercent = itemCBPercent[INr.Code];
                    foundF = true;
                  end;
                  if (foundF==false and groupCBPercentF[INr.Group]) then begin
                    rowCBPercent = groupCBPercent[INr.Group];
                    foundF = true;
                  end;
                  if (foundF) then begin
                    ivTotal = ivTotal - IVrw.Sum;
                    rowSum = IVrw.Sum;
                    if (IVr.CurncyCode!=BCb.BaseCur1) then begin
                      rowSum = MulRateToBase1(IVr.CurncyCode,IVrw.Sum,IVr.FrRate,IVr.ToRateB1,IVr.ToRateB2,IVr.BaseRate1,IVr.BaseRate2,DefaultCurRoundOff);
                    end;
                    rowsPoints = rowsPoints + Round((rowSum - (paidViaPoints*IVrw.Sum/IVr.Sum4))*rowCBPercent/100,rnd);
                    //LogText(0,IVrw.ArtCode & " gave points: " & Round((rowSum - (paidViaPoints*IVrw.Sum/IVr.Sum4))*rowCBPercent/100,rnd));
                  end;
                end;
              end;
            end;
          end;
        end;
        ivTotalB = ivTotal;
        if (IVr.CurncyCode!=BCb.BaseCur1) then begin
          ivTotalB = MulRateToBase1(IVr.CurncyCode,ivTotal,IVr.FrRate,IVr.ToRateB1,IVr.ToRateB2,IVr.BaseRate1,IVr.BaseRate2,DefaultCurRoundOff);
        end;
        IVr.Points = Round((ivTotalB - (paidViaPoints*ivTotal/IVr.Sum4))*promotionCBPercent/100,rnd) + rowsPoints;
        //LogText(0,"IVr.Points: " & IVr.Points);
      end;
    end;
    
  return;
end; //Edit***************************Sasha2,17:25 13.07.2017 }

global //Edit***************************Sasha2,15:10 07.07.2017 {
procedure CalculateIVVcCashbackPoints(var record IVVc IVr,Boolean noCheck)
begin 
  record LCCashbackLevelVc LCCBLevelr;
  row LCCashbackLevelVc LCCBLevelrw;
  row IVVc IVrw,IV2rw;
  record IVVc IV2r;
  record LoyaltyCardVc LoyaltyCardr;
  record BaseCurBlock BCb;
  roundmode rnd;
  Boolean found;
  Integer i,rwcnt,rowcnt,rwcnt2,j;
  val loyCardPointsBalance,cashbackPercent,paidViaPoints,sum,sumbal,percent,points;
  	
  BlockLoad(BCb);
	sumbal = 0;
	points = 0;
    LoyaltyCardr.SerNr = IVr.LoyaltyCardNr;
    if ((nonblank(IVr.LoyaltyCardNr) and ReadFirstMain(LoyaltyCardr,1,true)) or noCheck) then begin
      rnd = DefaultValRoundoff;
      rnd.decimals = 2;
      rnd.mode = kRoundingModeHalfUp;
      loyCardPointsBalance = LoyaltyCardr.CashbackLevelPoints;
			rowcnt = MatRowCnt(IVr);
			
			for(i=0;i<rowcnt;i=i+1) begin
				matrowget(IVr,i,IVrw);
				if(IVrw.stp==kInvoiceRowTypeNormal and IVrw.Sum<0) then begin
					IV2r.SerNr = IVrw.IVForRetNr;
					ReadFirstMain(IV2r,1,true);
					rwcnt2 = matrowcnt(IV2r);// Edit ************************** BPI Ukraine - KramarAlexandr - Wednesday, 7 August 2019 16:33:22
					For(j=0;j<rwcnt2;j=j+1) begin
	  				matrowget(IV2r,j,IV2rw);
	  				if(IV2rw.ArtCode=="CASHBACKCARD")then begin
	  					if(IV2r.Points>=10)then begin
	  						IV2r.Points = IV2r.Points - 10;
	  						IV2r.Sum4 = IV2r.Sum4 - 10;
	  					end;
	  				end;
					end; 
					
					
					percent = IV2r.Points/IV2r.Sum4;
					points = points +  Round((IVrw.Sum)*percent,rnd);
					sumbal = sumbal + IVrw.Sum;
				end;	
			end;
				LCCBLevelr.LCMLevel = IVr.LCMLevel;
				found = ReadFirstMain(LCCBLevelr,1,true);
				if (found) then begin
				
					rnd.decimals = LCCBLevelr.RndTo;
					rwcnt = MatRowCnt(LCCBLevelr);
					for (i=0;i<rwcnt;i=i+1) begin
						MatRowGet(LCCBLevelr,i,LCCBLevelrw);
						if (LCCBLevelrw.FromPoints<=loyCardPointsBalance and LCCBLevelrw.CashbackPercent>0) then begin
						
							if (LCCBLevelrw.ToPoints>=loyCardPointsBalance or LCCBLevelrw.ToPoints==BlankVal) then begin
								cashbackPercent = LCCBLevelrw.CashbackPercent;
								i = rwcnt;
							end;
						end;
					end;
					if (cashbackPercent!=0) then begin
						rwcnt = MatRowCnt(IVr);
						for (i=0;i<rwcnt;i=i+1) begin
							MatRowGet(IVr,i,IVrw);
							switch (IVrw.stp) begin
								case kInvoiceRowTypeLoyaltyPointsPayment:
									if(IVrw.Points>0)then begin
										paidViaPoints = paidViaPoints + IVrw.Points;
									end;
							end;
						end;
						sum = IVr.Sum4;
						if (IVr.CurncyCode!=BCb.BaseCur1) then begin
							sum = MulRateToBase1(IVr.CurncyCode,IVr.Sum4,IVr.FrRate,IVr.ToRateB1,IVr.ToRateB2,IVr.BaseRate1,IVr.BaseRate2,DefaultCurRoundOff);
						end;
				sum = sum - sumbal;
				// logtext(0,"sum " & sum);
						IVr.Points = Round((sum - paidViaPoints)*cashbackPercent/100,rnd);
				// logtext(0,"Points " & IVr.Points);
				CheckForCashbackCorrection(IVr,cashbackPercent,paidViaPoints,rnd);
				IVr.Points = IVr.Points + points;
			end;	
		
      end;
    end;
return;
end;	

procedure MakeReItemsMatrixFind(var record SHVc SHr, Boolean clearRows)
begin
  record IVVc IVr, ECIVr;
  row IVVc IVrw, ECIVrw;
  row SHVc SHrw;
  record CompaniesBlock Compb;
  record INVc INr;
  row CompaniesBlock Comprw;
  boolean TrHs,testf,insertf,SwarECRetf;
  record ItemHistVc IHr;
  string 100 tstr,artcode,compname,compnr;
  date todate;
  Integer rwcnt,lastRowPos,i,ecIVcnt,j;
  val tval;
	record ORVc ORr, ECORr;
	record RLinkVc RLr;
  artcode = SHr.DelAddrCode;
  todate = SHr.ShipDate;
  
  INr.Code = artcode;
  testf = ReadFirstMain(INr,1,true);
  if (testf==false) then begin
    INr.AlternativeCode = artcode;
    testf = ReadFirstKey("AlternativeCode",INr,1,true);
    if (testf) then begin
      artcode = INr.Code;
    end;
  end;
  if (testf==false) then begin
    INr.BarCode = artcode;
    testf = ReadFirstKey("BarCode",INr,1,true);
    if (testf) then begin
      artcode = INr.Code;
    end;
  end;
  
  BlockLoad(Compb);
  rwcnt = MatRowCnt(Compb);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Compb,i,Comprw);
    if (StringToInt(Comprw.CompCode)==CurrentCompany) then begin
      compnr = Comprw.CompCode;
      compname = Comprw.CompName;
      i = rwcnt;
    end;
  end;
  
  if (clearRows) then begin
    rwcnt = MatRowCnt(SHr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowDelete(SHr,i);
      rwcnt = MatRowCnt(SHr);
      i = i-1;
    end;
  end;
  
  IHr.FileName = "IVVc";
  IHr.ArtCode = artcode;
  IHr.TransDate = todate;
  TrHs = true;
  while(loopkey("FNArtCode",IHr,3,TrHs)) begin
  	testf = true;
  	if(currentcompany==1)then begin
			if(IHr.TransDate!=todate)then begin TrHs = false; testf = false; end;
  	end else begin
			if(IHr.TransDate<todate)then begin TrHs = false; testf = false; end;
  	end;
  	if(IHr.ArtCode!=artcode or IHr.FileName!="IVVc")then begin TrHs = false; testf = false; end;
  	if(IHr.Invalid==1)then begin testf=false; end;
  	if(IHr.StockAffectf!=1 and left(IHr.SerialNr,2)!="EC") then begin testf = false; end; //Edit***************************Sasha2,15:25 20.05.2015
  	if(IHr.Qty>=0) then begin testf = false; end; //Edit***************************Sasha2,10:51 23.05.2016
  	if(testf)then begin
  		
			IVr.SerNr = IHr.TransNr;
			if(readfirstmain(IVr,1,true))then begin
				if(nonblank(SHr.Addr3))then begin
					// logtext(0,"SHr.Addr3 " & SHr.Addr3);
					// logtext(0,"IVr.TaxTransactionCode " & IVr.TaxTransactionCode);
					//testf = FindStringInString(SHr.Addr3,IVr.TaxTransactionCode);
					if(FindFirstPosStringInString(uppercase(SHr.Addr3),uppercase(IVr.TaxTransactionCode))==-1)then begin
						testf = false;
					end;
				end;
				matrowget(IVr,IHr.Row,IVrw);
				if(IVrw.ArtCode==artcode and testf)then begin
				  rwcnt = MatRowCnt(SHr);
				  lastRowPos = 0 /*rwcnt-1*/;
				  insertf = true;
				  if (MatRowCnt(SHr)==0) then begin
				    ClearRow(SHr,SHrw,1);
				  end else begin
				    matrowget(SHr,lastRowPos,SHrw);
				    if (SHrw.stp==IHr.Row and SHrw.OrdRow==IHr.TransNr) then begin
				      insertf = false;
				    end else begin
				      ClearRow(SHr,SHrw,1);
				    end;
				  end;
					SHrw.ArtCode = artcode;
					if(currentcompany>1)then begin
						SHrw.BestBefore = IHr.TransDate;
					end;
					SHrw.Ship = SHrw.Ship + AbsoluteVal(IHr.Qty);
					if(IVr.ECOMMERCEOrdf==1 and CurrentCompany==1)then begin
						if(ReadRecordLink(IVr,1,ORr,RLr))then begin
							if(ReadRecordLink(ORr,1,ECORr,RLr) and SetCompany(29,false) and ReadFirstMain(ECORr,1,true))then begin
								if(ReadRecordLink(ECORr,1,ECIVr,RLr))then begin
									ecIVcnt = matrowcnt(ECIVr);
									for(j=0;j<ecIVcnt;j=j+1)begin
										matrowget(ECIVr,j,ECIVrw);
										if(ECIVrw.SerialNr==IVrw.SerialNr)then begin
											SHrw.BasePrice = ECIVrw.Price;
											SHrw.TAX2Reb = SHrw.TAX2Reb + (ECIVrw.Price - (ECIVrw.Price * 0.01 * ECIVrw.vRebate)) * AbsoluteVal(IHr.Qty);
											SHrw.CustArtCode = "FOBE_COMMERCE(" & ECIVr.Addr0 & ")";
											SwarECRetf = true;
										end;
									end;
								end;
								resetcompany(1);
							end;
						end;
					end else begin
						SHrw.BasePrice = IVrw.Price;
					end;
					if (IVrw.vRebate>0) then begin
					  SHrw.PosCode = 0+IVrw.vRebate & "%";
					end;
					if(!SwarECRetf)then begin SHrw.TAX2Reb = SHrw.TAX2Reb + (IVrw.Sum/IVrw.Quant)*AbsoluteVal(IHr.Qty); end;
					SHrw.Location = IHr.Location;
					if(!SwarECRetf)then begin SHrw.CustArtCode = IVr.CustCode; end;
					SHrw.Spec = IVr.Addr0;
					SHrw.OrdRow = IHr.TransNr;
					SHrw.FIFO = SHrw.FIFO + IHr.TotCostPrice;
					if (NonBlank(SHrw.TAX2Code) and SHrw.TAX2Code!=IHr.CurncyCode) then begin
						CurValToOtherCur(IHr.InDate,IHr.CurncyCode,IHr.TotCostPriceCurncy,SHrw.TAX2Code,tval,DefaultCurRoundOff);
						SHrw.FIFORowVal = SHrw.FIFORowVal + tval;
						SHrw.TAX2Code = IHr.CurncyCode;
					end else begin
						SHrw.FIFORowVal = SHrw.FIFORowVal + IHr.TotCostPriceCurncy;
						SHrw.TAX2Code = IHr.CurncyCode;
					end;
					SHrw.stp = IHr.Row;
					SHrw.VARList = compname;
					SHrw.Source = compnr;
					SHrw.PackageDesc = IVr.TaxTransactionCode;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 16 03 2021 y. at 1:23:30 PM
					if (insertf) then begin
					  MatRowInsert(SHr,0/*rwcnt*/,SHrw);
					end else begin
					  MatRowPut(SHr,lastRowPos,SHrw);
					end;
					SwarECRetf = false;
        end;
			end;
  	end;
  end; RESETLOOP(IHr);
 
LMakeReItemsMatrixFind:;   
      
  return;
end;

global 
procedure FindReItemsMatrix(var record SHVc SHr)
begin
  integer oldcomp;
  
    oldcomp = CurrentCompany;
    MakeReItemsMatrixFind(SHr,true);
    if (CompanyIsJWLikeCompany(oldcomp) and oldcomp!=3) then begin
      if (SetCompanyCode("3",false)) then begin
        MakeReItemsMatrixFind(SHr,false);
        RESETCOMPANY(oldcomp);
      end;
    end;
  
return;
end;

global 
procedure FindReItems(string artcode, date todate,var array string artcodes,var integer counter)
begin
record IVVc IVr;
row IVVc IVrw;
boolean TrHs,testf;
record ItemHistVc IHr;
string 100 tstr;

  counter = 0;
  IHr.FileName = "IVVc";
  IHr.ArtCode = artcode;
  IHr.TransDate = todate;
  TrHs = true;
  while(loopkey("FNArtCode",IHr,3,TrHs))begin
  	testf = true;
  	if(currentcompany==1)then begin
			if(IHr.TransDate!=todate)then begin TrHs = false; testf = false; end;
  	end else begin
			if(IHr.TransDate<todate)then begin TrHs = false; testf = false; end;
  	end;
  	if(IHr.ArtCode!=artcode or IHr.FileName!="IVVc")then begin TrHs = false; testf = false; end;
  	if(IHr.Invalid==1)then begin testf=false; end;
  	if(IHr.StockAffectf!=1) then begin testf = false; end; //Edit***************************Sasha2,15:25 20.05.2015
  	if(testf)then begin
  		
			IVr.SerNr = IHr.TransNr;
			if(readfirstmain(IVr,1,true))then begin
				matrowget(IVr,IHr.Row,IVrw);
				if(IVrw.ArtCode==artcode)then begin
					tstr = artcode;
					if(currentcompany>1)then begin
						tstr = tstr  & chr(9) & IVr.TransDate;
					end;
          artcodes[counter] = tstr;
          artcodes[counter] = artcodes[counter] & chr(9) & IVrw.Quant;
          artcodes[counter] = artcodes[counter] & chr(9) & IVrw.Price;
          artcodes[counter] = artcodes[counter] & chr(9) & 0+IVrw.vRebate & "%";
          artcodes[counter] = artcodes[counter] & chr(9) & IVrw.Sum;
          artcodes[counter] = artcodes[counter] & chr(9) & IVr.Location;
          artcodes[counter] = artcodes[counter] & chr(9) & "      " & IVr.CustCode;
          artcodes[counter] = artcodes[counter] & chr(9) & "      " & IVr.Addr0;
          artcodes[counter] = artcodes[counter] & chr(9) & "      #" & IVr.SerNr; //Edit***************************Sasha2,12:39 03.07.2015
          artcodes[counter] = artcodes[counter] & chr(9) & IHr.Row; //Edit***************************Sasha2,12:39 03.07.2015
          artcodes[counter] = artcodes[counter] & chr(9); //Edit***************************Sasha2,13:39 03.07.2015
          counter = counter + 1;
        end;
			end;
  	end;
  end;
  
  
return;
end;

global //Edit***************************Sasha2,10:55 08.09.2017 {
function Boolean DenyOperationsWithBlockedCustomer(record CUVc CUr,string fromFunctOrRecord) 
begin
  Boolean res;
    
    res = true;
    
    if (UserCanAction("AllowOperateAllForBlockedCustomer",false)) then begin
      res = false;
    end;
    
    switch (fromFunctOrRecord) begin
      case "SHVc":
        if (UserCanAction("AllowOperateSHForBlockedCustomer",false)) then begin
          res = false;
        end;
    end;
  
    DenyOperationsWithBlockedCustomer = res;
  return;
end; //Edit***************************Sasha2,10:55 08.09.2017 }


global updating procedure FixShopCoefMn(record RcVc RepSpec) //Edit-------------------Vitalii 15:24 09.10.2017
begin
  record ShopCoefVc SCr;
  record ShopCoef2Vc SC2r;
  boolean TrHs;
  integer oldcompany,i,rwcnt;
  record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  longint curtick;
	
	curtick = getcurtick();
  oldcompany = CurrentCompany;
  BlockLoad(Compb);
  rwcnt = MatRowCnt(Compb); 
	for (i=0;i<rwcnt;i=i+1) begin
    SetCompany(i+1,false);
    resetloop(SCr);
    TrHs = true;
    while (loopmain(SCr,2,TrHs)) begin
      recordnew(SC2r);
      SC2r.Shop = SCr.Shop;
      SC2r.Date = SCr.Date;
      SC2r.Coef = SCr.Coef;
      recordStore(SC2r,true);
    end;
  end;
	LogProcTime("FixShopCoefMn",getcurtick()-curtick);  
	ResetCompany(oldcompany);
  return;
end;

global
procedure FindAndStoreINVcImgLink(record INVc INr, integer compnr, var string myfullpath, var string myfilename)
begin
  record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  string 50 incode,incodeurl,inalt,inalturl,inbar,inbarurl;
  boolean urlenc;
  integer pos,oldcompany;
  boolean testOLDFolder;
	record BPIBrandVc BPIr;
	string 255 name;
	integer i,CompQty;
	record INVc tempINr;
  //logtext(0,"FindAndStoreINVcImgLink");
  oldcompany = CurrentCompany;
  SetCompany(compnr,false);
  BlockLoad(Compb);
  MatRowGet(Compb,compnr-1,Comprw);
  myfullpath = "";
  myfilename = "";
  urlenc = false;
  
  incode = imgStrReplace(INr.Code);
  incodeurl = urlencode(incode);
  inalt = imgStrReplace(INr.AlternativeCode);
  inalturl = urlencode(inalt);
  inbar = imgStrReplace(INr.BarCode);
  inbarurl = urlencode(inbar);
  BPIr.Code = INr.BPIBrand;
	name = "BRND_";
	if(ReadFirstMain(BPIr,1,true)) then begin
		for(i=0;i<len(BPIr.Name);i=i+1) begin
			if((ASC(mid(BPIr.Name,i,1)) >= 65 and ASC(mid(BPIr.Name,i,1)) <= 90  ) or ( ASC(mid(BPIr.Name,i,1)) >= 97 and  ASC(mid(BPIr.Name,i,1)) <= 122 ) or (ASC(mid(BPIr.Name,i,1))==95)) then begin
				name = name & mid(BPIr.Name,i,1);
			end else begin
				name = name & "_";
			end;
		end;
	end;
  if fileexists("webcust/" & name & "/" & incodeurl & ".jpg") and nonblank(incodeurl) then begin
    myfilename = incodeurl & ".jpg";
    urlenc = true;
  end;
  
  if (blank(myfilename) and nonblank(incodeurl)) then begin
    if fileexists("webcust/" & name & "/" & incodeurl & ".JPG") then begin
      myfilename = incodeurl & ".JPG";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(incodeurl)) then begin
    if fileexists("webcust/" & name & "/" & incodeurl & ".png") then begin
      myfilename = incodeurl & ".png";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(incodeurl)) then begin
    if fileexists("webcust/" & name & "/" & incodeurl & ".PNG") then begin
      myfilename = incodeurl & ".PNG";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalturl)) then begin
    if fileexists("webcust/" & name & "/" & inalturl & ".jpg") then begin
      myfilename = inalturl & ".jpg";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalturl)) then begin
    if fileexists("webcust/" & name & "/" & inalturl & ".JPG") then begin
      myfilename = inalturl & ".JPG";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalturl)) then begin
    if fileexists("webcust/" & name & "/" & inalturl & ".png") then begin
      myfilename = inalturl & ".png";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalturl)) then begin
    if fileexists("webcust/" & name & "/" & inalturl & ".PNG") then begin
      myfilename = inalturl & ".PNG";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbarurl)) then begin
    if fileexists("webcust/" & name & "/" & inbarurl & ".jpg") then begin
      myfilename = inbarurl & ".jpg";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbarurl)) then begin
    if fileexists("webcust/" & name & "/" & inbarurl & ".JPG") then begin
      myfilename = inbarurl & ".JPG";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbarurl)) then begin
    if fileexists("webcust/" & name & "/" & inbarurl & ".png") then begin
      myfilename = inbarurl & ".png";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbarurl)) then begin
    if fileexists("webcust/" & name & "/" & inbarurl & ".PNG") then begin
      myfilename = inbarurl & ".PNG";
      urlenc = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(incode)) then begin
    if fileexists("webcust/" & name & "/" & incode & ".jpg") then begin
      myfilename = incode & ".jpg";
    end;
  end;
  
  if (blank(myfilename) and nonblank(incode)) then begin
    if fileexists("webcust/" & name & "/" & incode & ".JPG") then begin
      myfilename = incode & ".JPG";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & name & "/" & incode & ".png") then begin
      myfilename = incode & ".png";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & name & "/" & incode & ".PNG") then begin
      myfilename = incode & ".PNG";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalt)) then begin
    if fileexists("webcust/" & name & "/" & inalt & ".jpg") then begin
      myfilename = inalt & ".jpg";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalt)) then begin
    if fileexists("webcust/" & name & "/" & inalt & ".JPG") then begin
      myfilename = inalt & ".JPG";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalt)) then begin
    if fileexists("webcust/" & name & "/" & inalt & ".png") then begin
      myfilename = inalt & ".png";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalt)) then begin
    if fileexists("webcust/" & name & "/" & inalt & ".PNG") then begin
      myfilename = inalt & ".PNG";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & name & "/" & inbar & ".jpg") then begin
      myfilename = inbar & ".jpg";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & name & "/" & inbar & ".JPG") then begin
      myfilename = inbar & ".JPG";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & name & "/" & inbar & ".png") then begin
      myfilename = inbar & ".png";
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & name & "/" & inbar & ".PNG") then begin
      myfilename = inbar & ".PNG";
    end;
  end;
    
	if (blank(myfilename) and nonblank(incodeurl)) then begin
		if fileexists("webcust/" & Comprw.ShortName & "/" & incodeurl & ".jpg") and nonblank(incodeurl) then begin
			myfilename = incodeurl & ".jpg";
			urlenc = true;
			testOLDFolder = true;
		end;
	end;
	
	if (blank(myfilename) and nonblank(incodeurl)) then begin
		if fileexists("webcust/" & Comprw.ShortName & "/" & incodeurl & ".JPG") and nonblank(incodeurl) then begin
			myfilename = incodeurl & ".JPG";
			urlenc = true;
			testOLDFolder = true;
		end;
	end;
	
  if (blank(myfilename) and nonblank(incodeurl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & incodeurl & ".png") then begin
      myfilename = incodeurl & ".png";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(incodeurl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & incodeurl & ".PNG") then begin
      myfilename = incodeurl & ".PNG";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalturl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inalturl & ".jpg") then begin
      myfilename = inalturl & ".jpg";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalturl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inalturl & ".JPG") then begin
      myfilename = inalturl & ".JPG";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalturl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inalturl & ".png") then begin
      myfilename = inalturl & ".png";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalturl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inalturl & ".PNG") then begin
      myfilename = inalturl & ".PNG";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbarurl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inbarurl & ".jpg") then begin
      myfilename = inbarurl & ".jpg";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbarurl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inbarurl & ".JPG") then begin
      myfilename = inbarurl & ".JPG";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbarurl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inbarurl & ".png") then begin
      myfilename = inbarurl & ".png";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbarurl)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inbarurl & ".PNG") then begin
      myfilename = inbarurl & ".PNG";
      urlenc = true;
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(incode)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & incode & ".jpg") then begin
      myfilename = incode & ".jpg";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(incode)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & incode & ".JPG") then begin
      myfilename = incode & ".JPG";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & incode & ".png") then begin
      myfilename = incode & ".png";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & incode & ".PNG") then begin
      myfilename = incode & ".PNG";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalt)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inalt & ".jpg") then begin
      myfilename = inalt & ".jpg";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalt)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inalt & ".JPG") then begin
      myfilename = inalt & ".JPG";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalt)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inalt & ".png") then begin
      myfilename = inalt & ".png";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inalt)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inalt & ".PNG") then begin
      myfilename = inalt & ".PNG";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inbar & ".jpg") then begin
      myfilename = inbar & ".jpg";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inbar & ".JPG") then begin
      myfilename = inbar & ".JPG";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inbar & ".png") then begin
      myfilename = inbar & ".png";
			testOLDFolder = true;
    end;
  end;
  
  if (blank(myfilename) and nonblank(inbar)) then begin
    if fileexists("webcust/" & Comprw.ShortName & "/" & inbar & ".PNG") then begin
      myfilename = inbar & ".PNG";
			testOLDFolder = true;
    end;
  end;
	if(currentcompany==18 and blank(myfilename)) then begin
		CompQty = matrowcnt(Compb);
		for (i=0;i<CompQty;i=i+1)begin
			if(i!=18 and blank(myfilename)) then begin
				matrowget(Compb,i,Comprw);
				SetCompany(i+1,false);
				tempINr.Code = INr.AlternativeCode;
				if(ReadFirstMain(tempINr,1,true)) then begin
					if(tempINr.BPIBrand==INr.BPIBrand) then begin
						if (blank(myfilename) and nonblank(inalt)) then begin
							if fileexists("webcust/" & Comprw.ShortName & "/" & inalt & ".jpg") then begin
								myfilename = inalt & ".jpg";
								testOLDFolder = true;
							end;
						end;

						if (blank(myfilename) and nonblank(inalt)) then begin
							if fileexists("webcust/" & Comprw.ShortName & "/" & inalt & ".JPG") then begin
								myfilename = inalt & ".JPG";
								testOLDFolder = true;
							end;
						end;

						if (blank(myfilename) and nonblank(inalt)) then begin
							if fileexists("webcust/" & Comprw.ShortName & "/" & inalt & ".png") then begin
								myfilename = inalt & ".png";
								testOLDFolder = true;
							end;
						end;

						if (blank(myfilename) and nonblank(inalt)) then begin
							if fileexists("webcust/" & Comprw.ShortName & "/" & inalt & ".PNG") then begin
								myfilename = inalt & ".PNG";
								testOLDFolder = true;
							end;
						end;
					end;
				end;
				if(nonblank(myfilename)) then begin
					i = CompQty;
				end;
			end;
		end;
	end;
  
  if(testOLDFolder) then begin
		if (nonblank(myfilename)) then begin
			if (!urlenc) then begin
				if (myfilename!=urlencode(myfilename)) then begin
					renamefile("webcust/" & Comprw.ShortName & "/" & myfilename,"webcust/" & Comprw.ShortName & "/" & urlencode(myfilename));
					myfilename = urlencode(myfilename);
				end;
			end;
			myfullpath = "webcust/" & Comprw.ShortName & "/" & myfilename;
		end;
	end else begin
		if (nonblank(myfilename)) then begin
			if (!urlenc) then begin
				if (myfilename!=urlencode(myfilename)) then begin
					renamefile("webcust/" & name & "/" & myfilename,"webcust/" & name & "/" & urlencode(myfilename));
					myfilename = urlencode(myfilename);
				end;
			end;
			myfullpath = "webcust/" & name & "/" & myfilename;
		end;
	end;	
  ResetCompany(oldcompany);
  return;
end;

/*global
procedure FillImgInINVcMn(record RcVc RepSpec)
begin
  record CompaniesBlock Compb;
  record INVc INr;
  row CompaniesBlock Comprw;
  integer oldcompany,i,rwcnt;
  string 255 fullpath,filename;
  longint curtick;
	
	curtick = getcurtick();
  oldcompany = CurrentCompany;
  BlockLoad(Compb);
  rwcnt = MatRowCnt(Compb); 
	for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Compb,i,Comprw);
    SetCompany(i+1,false);
    resetloop(INr);
    INr.Code = "";
    while loopmain(INr,1,true) begin
      FindAndStoreINVcImgLink(INr,i+1,fullpath,filename);
    end;
  end;
	
	ResetCompany(oldcompany);
  LogProcTime("FillImgInINVcMn",getcurtick()-curtick); 
  return;
  end;
*/
  
global
procedure RemDoublURLEncInImgMn(record RcVc RepSpec)
begin
  //  %25   //Edit-------------------Vitalii 12:37 14.11.2017
  integer filescnt,i,j,rwcnt;
  string 255 path,filename,filenametmp;
  record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  longint curtick;
	record BPIBrandVc BPBr;
	
	curtick = getcurtick();
  BlockLoad(Compb);
  rwcnt = MatRowCnt(Compb); 
	for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Compb,i,Comprw);
    
    path = "webcust/" & Comprw.ShortName  & "/";
    
    filescnt = countfilesindir(path);
    for (j=0;j<filescnt;j=j+1) begin
      filenametmp = GetFileNameInDir(path,j);
      filename = filenametmp;
      while (filename!=urldecode(filename)) begin
        filename = urldecode(filename);
      end;
      filename = urlencode(filename);
      renamefile("webcust/" & Comprw.ShortName & "/" & filenametmp,"webcust/" & Comprw.ShortName & "/" & filename);
    end;
  end;
	 BPBr.Code = ""; 
	while(LoopMain(BPBr,1,true)) begin
    
    path = "webcust/" & BPBr.Name & "/";
    
    filescnt = countfilesindir(path);
    for (j=0;j<filescnt;j=j+1) begin
      filenametmp = GetFileNameInDir(path,j);
      filename = filenametmp;
      while (filename!=urldecode(filename)) begin
        filename = urldecode(filename);
      end;
      filename = urlencode(filename);
      renamefile("webcust/" & BPBr.Name & "/" & filenametmp,"webcust/" & BPBr.Name & "/" & filename);
    end;
  end;
  LogProcTime("RemDoublURLEncInImgMn",getcurtick()-curtick); 
  return;
  
end;

global updating procedure ChangeOptionalFeaturedMn()
begin
	record ModuleBlock MBb;
	
	blockload(MBb);
		MBb.ReportSlots = 8;
		MBb.WebRequestThreads = 8;
		MBb.HTTPThreads = 4;
	blockstore(MBb);
return;
end;


global updating procedure FixPOSButtonsMn()
begin
	record POSButtonsVc POSButtonsr,oldPOSButtonsr;
	row POSButtonsVc POSButtonsrw;
	record CompaniesBlock CBb;
	row CompaniesBlock Comprw;
	integer i,j,mtrw,rwcnt;
	
	logtext(0,"FixPOSButtonsMn");
	
	blockload(CBb);
	mtrw = matrowcnt(CBb);
	For(i=0;i<mtrw;i=i+1) begin
	  matrowget(CBb,i,Comprw);
	  if (SetCompany(i+1,false)) then begin
	  	logtext(0,"Comp " & i);
	  	POSButtonsr.WindowClass = "";
			while(loopmain(POSButtonsr,1,true))begin
				/*rwcnt = matrowcnt(POSButtonsr);
				For(j=0;j<rwcnt;j=j+1) begin
	  			matrowget(POSButtonsr,j,POSButtonsrw);
	  			if(POSButtonsrw.ButtonType>=100)then begin
						POSButtonsrw.ButtonType = POSButtonsrw.ButtonType + 100;
						matrowput(POSButtonsr,j,POSButtonsrw);
					end;
				end; */
				recordcopy(oldPOSButtonsr,POSButtonsr);
				POSButtonsr.WindowClass = "IVDClass";
				recordupdate(oldPOSButtonsr,POSButtonsr,false);
			end;
			resetloop(POSButtonsr);
		end;
	end; 
	

return;
end;

global updating procedure DelSpacesInAltCodeMn()
begin
	record INVc INr;
	boolean find,updf;
	record ObjVc Objr;
	
	while(loopmain(INr,1,true))begin
		updf = false;
		find = true;
		while(find)begin
			if(left(INr.AlternativeCode,1)==" ")then begin
				INr.AlternativeCode = right(INr.AlternativeCode,len(INr.AlternativeCode)-1);
				updf = true;
			end else begin
				find = false;
			end;
		end;
		
		find = true;
		while(find)begin
			if(right(INr.AlternativeCode,1)==" ")then begin
				INr.AlternativeCode = left(INr.AlternativeCode,len(INr.AlternativeCode)-1);
				updf = true;
			end else begin
				find = false;
			end;
		end;
		if(nonblank(INr.Objects))then begin
			Objr.Code = INr.Objects;
			if(readfirstmain(Objr,1,true))then begin
				if(Objr.OTCode=="STORE")then begin
					INr.Objects = "";
					updf = true;
				end;
			end else begin
				INr.Objects = "";
				updf = true;
			end;
		end;
		
		if(updf)then begin
			// logtext(0,INr.Code & " " & INr.AlternativeCode);
			recordstore(INr,true);
		end;
		
	end;
	
return;
end;


global //Edit***************************Sasha2,10:38 19.06.2017 {
updating procedure FixFourSeasonsItemsPriceMn(record RcVc RepSpec)
begin
	record INVc INr,oldINr;
	record ItemHistVc IHr;
	record PUVc PUr,PU2r;
	row PUVc PUrw,PU2rw;
	integer i,j,mtrw,cbrw;
  boolean changef,testf,TrHs;
  val cost;
  record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  integer curcomp,arcnt;
  date bldate;
  vector val itemprice,inprice,inpriceazn;
  vector string 25 curcode;
  array string 100 artcodes; 
  vector boolean vart;
  vector date vartdate,moddate;
	record RcVc RepSpec1;// Edit ************************** Thursday, 21 February 2013 09:43:50
  record PLDefVc PLDr;// Edit ************************** Thursday, 21 February 2013 09:45:29
	longint curtick;
	
	curtick = getcurtick();
	blockload(Compb);
	cbrw = matrowcnt(Compb);
	curcomp = currentcompany;
	
	startreportnoheaderjob("FixFourSeasonsItemsPriceMn");
	
	PUr.SerNr = 37;
	while(loopmain(PUr,1,true))begin
		testf = true;
		
		if(testf)then begin
			mtrw = matrowcnt(PUr);
			// logtext(0,"PU " & PUr.SerNr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(PUr,i,PUrw);
				INr.Code = PUrw.ArtCode;
				// logtext(0,"PU item" & INr.Code);
				if(ReadFirstMain(INr,1,true))then begin
					if(INr.LastPriceChange==stringtodate("9/11/2017"))then begin
					
						if(vart[INr.Code]==false)then begin
							vart[INr.Code] = true;
							artcodes[arcnt] = INr.Code;
							arcnt = arcnt + 1;
						end;
						if(vartdate[INr.Code]<PUr.TransDate)then begin
							vartdate[INr.Code] = stringtodate("9/11/2017");
							inprice[INr.Code] = PUrw.UPrice;
							curcode[INr.Code] = INr.LastPurchCurncyCode;
						end;
					end;
				end;
			end; 
		end;
	end;
	
	
	For(j=0;j<cbrw;j=j+1) begin
		if(CompanyIsJWLikeCompany(j) and j!=27)then begin
			if(setcompany(j,false))then begin
				For(i=0;i<arcnt;i=i+1) begin				
					IHr.ArtCode = artcodes[i];
					IHr.TransDate = vartdate[artcodes[i]];
					TrHs = true;
					logtext(0,"Company " & j);
					while(loopbackkey("ArtCode",IHr,2,TrHs))begin
						testf = true;
						if(IHr.ArtCode!=artcodes[i])then begin TrHs = false; testf = false; end;
						if(IHr.FileName!="PUVc")then begin testf = false; end;
						if(IHr.TransDate<moddate[artcodes[i]])then begin testf = false; TrHs = false; end;
					
						if(testf)then begin
							// logtext(0,"IHr " & IHr.TransDate & " " & IHr.FileName);
							PU2r.SerNr = IHr.TransNr;
							if(readfirstmain(PU2r,1,true))then begin
								matrowget(PU2r,IHr.Row,PU2rw);
								if(curcode[artcodes[i]]==PU2r.CurncyCode)then begin
									itemprice[artcodes[i]] = PU2rw.UPrice;
									inpriceazn[artcodes[i]] = PU2rw.CostPrice;
									moddate[artcodes[i]] = PUr.TransDate;
								end;
							end;
							TrHs = false;
						end;
					
					end;
					resetloop(IHr);
				end; 
			end;
		end;
		resetcompany(curcomp);
	end; 
	
	For(i=0;i<arcnt;i=i+1) begin	
		INr.Code = artcodes[i];
		if(readfirstmain(INr,1,true))then begin
			INr.LastPurchPrice2 = itemprice[artcodes[i]];
			INr.InPrice = inpriceazn[artcodes[i]];
			INr.LastPriceChange = currentdate;
			recordstore(INr,true);
			PLDr.Code="";
			While(loopmain(PLDr,1,true))begin
				if(matrowcnt(PLDr)>0)then begin
					RepSpec1.f1 = PLDr.Code;
					RepSpec1.f2 = INr.Code;
					CalcPriceListsMn(RepSpec1);
				end;
			end;
			resetloop(PLDr);
		end;
		StartFormat(15);
			outstring(0,0,artcodes[i],false);
			outstring(50,0,inprice[artcodes[i]],false);
			outstring(100,0,itemprice[artcodes[i]],false);
			outstring(150,0,curcode[artcodes[i]],false);								
		endformat;
	end;
	
	endjob;
	LogProcTime("FixFourSeasonsItemsPriceMn",getcurtick()-curtick); 
return;
end; //Edit***************************Sasha2,10:38 19.06.2017 }






global  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger16:19 01.08.2018
updating procedure CrtgroupsfrclassifMn(record RcVc RepSpec)
begin
	record ITVc ITr;
	record DIVc DIr;
	record INVc INr;
	string 255 cmd;
	Integer pos;
	vector string 255 GroupCodes, BrandName;
	longint curtick;
	
	curtick = getcurtick();
	DIr.Code = "";
	While (loopmain(DIr,1,true)) begin
		if(DIr.CType=="BRAND")then begin 
			ITr.Comment = DIr.Name;
			BrandName[DIr.Code] = DIr.Name;
			if(!readfirstkey("Comment",ITr,1,true))then begin
				RecordNew(ITr);
				ITr.Code = right(DIr.Code,5);
				ITr.Comment = DIr.Name;
				ITr.ClassType = DIr.CType;
				ITr.Objects = DIr.Code;
				RecordStore(ITr,true);
			end;
		end;
	end;
	resetloop(DIr);
	ITr.Code = "";
	while (loopmain(ITr,1,true)) begin
		if(ITr.ClassType=="BRAND")then begin
			GroupCodes[ITr.Comment] = ITr.Code;
		end;
	end;
	resetloop(ITr);
	INr.Code = "";
	while(loopmain(INr,1,true))begin
		if(nonblank(INr.DispGroups))then begin
		pos = 0;
			ExtractObj(INr.DispGroups,pos,cmd);
			while (nonblank(cmd)) begin
				if(nonblank(BrandName[cmd]))then begin
					if(nonblank(GroupCodes[BrandName[cmd]]))then begin
						INr.Group = GroupCodes[BrandName[cmd]];
						RecordStore(INr,true);
					end;
				end;
				ExtractObj(INr.DispGroups,pos,cmd);
			end;
		end;
	end;
	resetloop(INr);
	LogProcTime("CrtgroupsfrclassifMn",getcurtick()-curtick); 
return;
end;  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger16:19 01.08.2018






global updating procedure UpdateDocMn()
begin
	record DocVc Docr;
	row DocVc Docrw;
	integer i,rwcnt;
	roundmode rnd;
	
	rnd.decimals = 0;
	rnd.step = kRoundingStep5;
	
	Docr.Code = "POFORM1";
	if(readfirstmain(Docr,1,true))then begin
		rwcnt = matrowcnt(Docr);
		
		For(i=0;i<rwcnt;i=i+1) begin
	  	matrowget(Docr,i,Docrw);
	  	if(Docrw.unitType==4)then begin
	  		Docrw.unitStyle = 10;
	  		Docrw.unitWidth = round(Docrw.unitWidth,rnd);
	  		matrowput(Docr,i,Docrw);
	  	end;
	  	if(Docrw.unitType==1)then begin
	  		Docrw.unitStyle = 10;
	  		Docrw.unitWidth = round(Docrw.unitWidth,rnd);
	  		matrowput(Docr,i,Docrw);
	  	end;
		end; 
		recordstore(Docr,true);
	end;
	
	
return;
end;

global updating procedure FISOMn()
begin
  record CUVc CUr;
  record ObjVc Objr;
  
  if (currentcompany==28) then begin
    CUr.Code = "";
    while (loopmain(CUr,1,true)) begin
      if (CUr.VECat=="IDEA") then begin
        Objr.Code = CUr.Code;
        if(readfirstmain(Objr,1,true))then begin
          CUr.VEObjects = Objr.Code;
          RecordStore(CUr,true);
        end else begin
          Objr.Comment = CUr.Name;
          if(readfirstkey("Comment",Objr,1,true))then begin
            CUr.VEObjects = Objr.Code;
            RecordStore(CUr,true);
          end;
        end;
      end;
    end;
  end;
  return;
end;


global updating procedure TROperMn(var Record RcVc RepSpec)  //  by Ira
begin
	record TRVc oldTRr, TRr;
	row TRVc TRrw, TRrw2, TRrw3;
	record AccVc Accr;
	integer mtrw, i,compnr;
	val tval;
	boolean testf, testf1, testf2,TrHs,changed;
	record IVVc IVr;
	string 10 rkey;
	integer counter;
	area alog;
	record CompaniesBlock CBb;
	date curdate,bldate;
	
	compnr = 1;
	blockload(CBb);
	if(RepSpec.flags[1]==0)then begin
		RepSpec.flags[1] = 1;
	end;
	for(compnr=RepSpec.flags[1];compnr<=matrowcnt(CBb);compnr=compnr+1)begin
		if(compnr!=18)then begin
			setcompany(compnr,false);
			if(nonblank(RepSpec.f1))then begin
				IVr.SerNr = stringtolongint(RepSpec.f1);
				rkey = "SerNr";
			end else begin
				IVr.InvDate = currentdate;
				if(nonblankdate(RepSpec.d1))then begin
					IVr.InvDate = RepSpec.d1;
				end;
				rkey = "InvDate";
			end;
	
			if(nonblankdate(RepSpec.d1))then begin
				rkey = "InvDate";
				IVr.InvDate = RepSpec.d1;
				IVr.SerNr = stringtolongint(RepSpec.f1);
			end;
			resetloop(IVr);
			TrHs = true;
			curdate = addmonth(currentdate,-1);
			curdate.day = 1;
			while(loopbackkey(rkey,IVr,2,TrHs))begin
					if(rkey=="InvDate" and IVr.InvDate<curdate)then begin
						TrHs = false;
						RepSpec.d1 = bldate;
						RepSpec.f1 = "";
					end;
					if(rkey=="SerNr" and IVr.SerNr!=stringtolongint(RepSpec.f1))then begin
						TrHs = false;
					end;
			
					if(TrHs)then begin
					TRr.Number = IVr.SerNr;
					TRr.IntYc = IVYc;
					if(readFirstMain(TRr,2,true)) then begin
						RecordCopy(oldTRr,TRr);
						mtrw = matrowcnt(TRr);
						testf = true;
						for (i=0;i<mtrw;i=i+1) begin
							matrowget (TRr,i,TRrw);
							testf2 = true;
							if(TRrw.ovst!=0 or TRrw.stp!=1) then begin testf2 = false; end;
							if(testf2) then begin
								if(TRrw.AccNumber=="68/01") then begin
									testf = false;
								end;
							end;
						end;
						if(testf)then begin
							testf = false;
							for (i=0;i<mtrw;i=i+1) begin
								matrowget (TRr,i,TRrw);
								testf2 = true;
								if(TRrw.ovst!=0 or TRrw.stp!=1) then begin testf2 = false; end;
								if(testf2) then begin
									if(TRrw.AccNumber=="46" or TRrw.AccNumber=="47") then begin
										testf = true;
									end;
								end;
							end;
						end;
						//resetLoop(TRr);// 
						if(testf)then begin
							changed = false;
							for (i=0;i<mtrw;i=i+1) begin
								matrowget(TRr,i,TRrw);
								testf2 = true;
								if(TRrw.ovst!=0 or TRrw.stp!=1) then begin testf2 = false; end;
								if(testf2) then begin
									if(TRrw.AccNumber=="46" or TRrw.AccNumber=="47") then begin
										clearrow(TRr,TRrw2,1);
										clearrow(TRr,TRrw3,1);
										TRrw2.AccNumber = TRrw.AccNumber;
										TRrw2.Objects = TRrw.Objects;
										TRrw2.Curncy = TRrw.Curncy;
										Accr.AccNumber = TRrw2.AccNumber;
										if(readFirstMain(Accr,1,true)) then begin
											TRrw2.Comment = Accr.Comment;
										end;
					
										if(nonblank(TRrw.CredVal)) then begin
											TRrw2.DebVal = round(TRrw.CredVal * 18 / 118, defaultcurroundoff);
											TRrw2.CurDebVal = round(TRrw.CurCredVal * 18 / 118, defaultcurroundoff);
										end else begin
											TRrw2.CredVal = round(TRrw.DebVal * 18 / 118, defaultcurroundoff);
											TRrw2.CurCredVal = round(TRrw.CurDebVal * 18 / 118, defaultcurroundoff);
										end;
										matrowPUt(TRr,matrowcnt(TRr),TRrw2);
										if(nonblank(TRrw2.CredVal)) then begin
											TRVc_PasteCredVal(TRr,matrowcnt(TRr)-1);
										end else begin
											TRVc_PasteDebVal(TRr,matrowcnt(TRr)-1);
										end;
			
										TRrw3.AccNumber = "68/01";
										TRrw3.Objects = TRrw.Objects;
										TRrw3.Curncy = "AZN";
					
										Accr.AccNumber = TRrw3.AccNumber;
										if(readFirstMain(Accr,1,true)) then begin
											TRrw3.Comment = Accr.Comment;
										end;
					
										TRrw3.CredVal = TRrw2.DebVal;
										TRrw3.CurCredVal = TRrw3.CredVal;
										TRrw3.DebVal = TRrw2.CredVal;
										TRrw3.CurDebVal = TRrw3.DebVal;
										matrowPUt(TRr,matrowcnt(TRr),TRrw3);
										if(nonblank(TRrw2.CredVal)) then begin
											TRVc_PasteCredVal(TRr,matrowcnt(TRr)-1);
										end else begin
											TRVc_PasteDebVal(TRr,matrowcnt(TRr)-1);
										end;
										TRSumup(TRr,tval);
										changed = true;
									end;	
								end;
							end;
							if(changed)then begin
								if (RecordUpdate(oldTRr,TRr,true)==0) then begin 
					
								end else begin
									setareazerosize(alog);
									addtexttoarea(currentcompany & " problemm " & IVr.SerNr & chr(13) & chr(10),alog);
									writeareatofile(alog,"TROperMn_log.txt",1);
								end;
								counter = counter + 1;
								if(counter>20)then begin						
									counter = 0;
									RepSpec.d1 = TRr.TransDate;
									RepSpec.f1 = IVr.SerNr;
									RepSpec.flags[1] = currentcompany;
									queued.TROperMn(RepSpec);
									goto lEndThis;
								end;
							end;
						end;
						//recordStore(TRr,true);
					end;
				end;
			end;
		end;
	end;
	lEndThis:;
	
return;
end;

global webpublic updating procedure WebTROperMn()
begin
	record RcVc RepSpec;
	
	if(nonblank(webgetarg("compnr")))then begin
		setcompany(stringtoint(webgetarg("compnr")),false);
		TROperMn(RepSpec);
	end;
	
return;
end;

global updating procedure FixDublDispMn()
begin
	record INVc INr;

	while(loopmain(INr,1,true))begin
		if(nonblank(INr.DispGroups))then begin
			if(DelDublicates(INr.DispGroups)!=INr.DispGroups)then begin
				// logtext(0,INr.Code & " " & INr.DispGroups & " -> " & DelDublicates(INr.DispGroups));
				INr.DispGroups = DelDublicates(INr.DispGroups);
				recordstore(INr,true);
			end;
		end;
	end;
	
return;
end;


global updating procedure DelARPayMn()
begin
	record ARPayVc ARPayr;

	ARPayr.CUPNr = 720;
	if(readfirstmain(ARPayr,1,true))then begin
		recorddelete(ARPayr);
	end;
	
return;
end;

webpublic global procedure WebGetAllGroupsNames()
begin
	record ITVc ITr;
	record BPIBrandVc BPIBr;
	area brands;
	integer i;
	
	
	while(loopmain(BPIBr,1,true))begin
		addtexttoarea(BPIBr.Code & chr(9) & BPIBr.Name & chr(13) & chr(10),brands);
	end;
	
	For(i=1;i<29;i=i+1) begin
	  setcompany(i,false);
	  resetloop(ITr);
	  ITr.Code = "";
	  while(LoopMain(ITr,1,true))begin	  
			addtexttoarea(ITr.Code & chr(9) & ITr.Comment & chr(13) & chr(10),brands);
	  end;
	end; 
	
	writeareatofile(brands,"brands.txt",0);
	
return;
end;


webpublic global updating procedure offWebGetErrorBrands()
begin
	record ITVc ITr;
	record BPIBrandVc BPIBr;
	area brands;
	integer i;
	record INVc INr;
	
	For(i=1;i<29;i=i+1) begin
	  setcompany(i,false);
	  resetloop(INr);
	  INr.Code = "";
	  while(LoopMain(INr,1,true))begin	  
	  	if(nonblank(INr.BPIGroup))then begin
	  		if(blank(INr.BPIBrand))then begin
	  			
	  			weboutstring(currentcompany & " " & INr.Code);
	  			if(nonblank(INr.Group))then begin
	  				ITr.Code = INr.Group;
	  				if(readfirstmain(ITr,1,true))then begin
	  					BPIBr.Name = ITr.Comment;
	  					if(readfirstkey("Name",BPIBr,1,true))then begin
	  						weboutstring("  " & BPIBr.Code & " " & BPIBr.Name);
	  						INr.BPIBrand = BPIBr.Code;
	  						INr.DispGroups = BPIBr.Code & "," & INr.DispGroups; 
	  						INr.DispGroups = DelDublicates(INr.DispGroups);
	  						recordstore(INr,true);
	  					end;
	  				end;
	  			end else begin
	  				if(i==25)then begin
	  					INr.BPIBrand = "BRND0046";
	  					INr.DispGroups = BPIBr.Code & "," & INr.DispGroups; 
	  					INr.DispGroups = DelDublicates(INr.DispGroups);
	  					recordstore(INr,true);
	  				end;
	  			end;
	  			
	  			weboutstring("<BR>");
	  		end;
	  	end;
	  end;
	end; 
	
	writeareatofile(brands,"brands.txt",0);
	
return;
end;

procedure AddToSet(var string set,string toadd)
begin
	
	if(nonblank(toadd))then begin
		if(nonblank(set))then begin
			if(!setinset(toadd,set))then begin
				set = set & "," & toadd;
			end;
		end else begin
			set = toadd;
		end;
	end;

return;
end;

webpublic global updating procedure offWeb2UpdateDispGroupsOld()
begin
	record ITVc ITr;
	record BPIBrandVc BPIBr;
	area brands;
	integer i;
	record INVc INr;
	
	For(i=1;i<29;i=i+1) begin
		if(CompanyIsJWLikeCompany(i)==false or i==3)then begin
			setcompany(i,false);
			resetloop(INr);
			INr.Code = "";
			while(LoopMain(INr,1,true))begin	  
				if(nonblank(INr.BPIBrand))then begin
				
				
					//INr.OldDispGroups = INr.DispGroups;
					INr.DispGroups = "";
					if (nonblank(INr.BPIBrand)) then begin AddToSet(INr.DispGroups,INr.BPIBrand); end;
					if (nonblank(INr.BPICollection)) then begin AddToSet(INr.DispGroups,INr.BPICollection); end;
					if (nonblank(INr.BPIGroup)) then begin AddToSet(INr.DispGroups,INr.BPIGroup); end;
					if (nonblank(INr.BPISubGroup)) then begin AddToSet(INr.DispGroups,INr.BPISubGroup); end;
					if (nonblank(INr.BPICategory)) then begin AddToSet(INr.DispGroups,INr.BPICategory); end;
					if (nonblank(INr.BPIMaterial)) then begin AddToSet(INr.DispGroups,INr.BPIMaterial); end;
					if (nonblank(INr.BPIColor)) then  begin AddToSet(INr.DispGroups,INr.BPIColor); end;
					if (nonblank(INr.BPIShape)) then begin AddToSet(INr.DispGroups,INr.BPIShape); end;
					if (nonblank(INr.BPISize)) then begin AddToSet(INr.DispGroups,INr.BPISize); end;
					if (nonblank(INr.BPISex)) then begin AddToSet(INr.DispGroups,INr.BPISex); end;
					if (nonblank(INr.BPIPlating)) then begin AddToSet(INr.DispGroups,INr.BPIPlating); end;
					if (nonblank(INr.BPIClarity)) then begin AddToSet(INr.DispGroups,INr.BPIClarity); end;
					if (nonblank(INr.BPIWeight)) then begin AddToSet(INr.DispGroups,INr.BPIWeight); end;
					if (nonblank(INr.BPICut)) then begin AddToSet(INr.DispGroups,INr.BPICut); end;
					if (nonblank(INr.BPIStone)) then begin AddToSet(INr.DispGroups,INr.BPIStone); end;
					if (nonblank(INr.BPIStrap)) then begin AddToSet(INr.DispGroups,INr.BPIStrap); end;
					if (nonblank(INr.BPIOdour)) then begin AddToSet(INr.DispGroups,INr.BPIOdour); end;
					recordstore(INr,true);
				
					//weboutstring("<BR>");
				end;
			end;
		end;
	end; 
		
return;
end;

global updating procedure BPIFixDublDispMn()
begin
	record INVc INr;
	string 100 res,class;
	integer i,pos;
	record DIVc DIr;
	boolean TrHs;
	for(i=1;i<29;i=i+1) begin
	  SetCompany(i,false);
		INr.Code="";
		TrHs=true;
		while(loopmain(INr,1,TrHs))begin
			if(INr.BPIBrand=="BRND0041") then begin INr.BPIBrand="BRND0040"; RecordStore(INr,true); end;
			if(INr.BPIBrand=="BRND0121") then begin INr.BPIBrand="BRND0120"; RecordStore(INr,true);end;
			if(INr.BPIBrand=="BRND0159") then begin INr.BPIBrand="BRND0158";RecordStore(INr,true); end;
			if(INr.BPIBrand=="BRND0186") then begin INr.BPIBrand="BRND0185";RecordStore(INr,true); end;
			If(SetInSet("BRND0041",INr.DispGroups)) then begin
				pos = 0;
				class = "";
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="BRAND")then begin
						res=res & "BRND0040,";
					end else begin
						res=res&class&",";
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				res=Left(res,len(res)-1);
				INr.DispGroups=res;
				RecordStore(INr,true);
			end;
			If(SetInSet("BRND0121",INr.DispGroups)) then begin
				pos = 0;
				class = "";
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="BRAND")then begin
						res=res & "BRND0120,";
					end else begin
						res=res&class&",";
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				res=Left(res,len(res)-1);
				INr.DispGroups=res;
				RecordStore(INr,true);
			end;
			If(SetInSet("BRND0159",INr.DispGroups)) then begin
				pos = 0;
				class = "";
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="BRAND")then begin
						res=res & "BRND0158,";
					end else begin
						res=res&class&",";
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				res=Left(res,len(res)-1);
				INr.DispGroups=res;
				RecordStore(INr,true);
			end;
			If(SetInSet("BRND0186",INr.DispGroups)) then begin
				pos = 0;
				class = "";
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="BRAND")then begin
						res=res & "BRND0185,";
					end else begin
						res=res&class&",";
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				res=Left(res,len(res)-1);
				INr.DispGroups=res;
				RecordStore(INr,true);
			end;
		end;
		ResetLoop(INr);
	end;	
return;
end;







webpublic global updating procedure offWebUpdateDispGroupsOld()
begin
	record ITVc ITr;
	record BPIBrandVc BPIBr;
	area brands;
	integer i;
	record INVc INr;
	
	For(i=1;i<29;i=i+1) begin
		if(CompanyIsJWLikeCompany(i)==false or i==3)then begin
			setcompany(i,false);
			resetloop(INr);
			INr.Code = "";
			while(LoopMain(INr,1,true))begin	  
				if(nonblank(INr.BPIBrand))then begin
				
				
					//INr.OldDispGroups = INr.DispGroups;
					INr.DispGroups = "";
					if (nonblank(INr.BPIBrand)) then begin AddToSet(INr.DispGroups,INr.BPIBrand); end;
					if (nonblank(INr.BPICollection)) then begin AddToSet(INr.DispGroups,INr.BPICollection); end;
					if (nonblank(INr.BPIGroup)) then begin AddToSet(INr.DispGroups,INr.BPIGroup); end;
					if (nonblank(INr.BPISubGroup)) then begin AddToSet(INr.DispGroups,INr.BPISubGroup); end;
					if (nonblank(INr.BPICategory)) then begin AddToSet(INr.DispGroups,INr.BPICategory); end;
					if (nonblank(INr.BPIMaterial)) then begin AddToSet(INr.DispGroups,INr.BPIMaterial); end;
					if (nonblank(INr.BPIColor)) then  begin AddToSet(INr.DispGroups,INr.BPIColor); end;
					if (nonblank(INr.BPIShape)) then begin AddToSet(INr.DispGroups,INr.BPIShape); end;
					if (nonblank(INr.BPISize)) then begin AddToSet(INr.DispGroups,INr.BPISize); end;
					if (nonblank(INr.BPISex)) then begin AddToSet(INr.DispGroups,INr.BPISex); end;
					if (nonblank(INr.BPIPlating)) then begin AddToSet(INr.DispGroups,INr.BPIPlating); end;
					if (nonblank(INr.BPIClarity)) then begin AddToSet(INr.DispGroups,INr.BPIClarity); end;
					if (nonblank(INr.BPIWeight)) then begin AddToSet(INr.DispGroups,INr.BPIWeight); end;
					if (nonblank(INr.BPICut)) then begin AddToSet(INr.DispGroups,INr.BPICut); end;
					if (nonblank(INr.BPIStone)) then begin AddToSet(INr.DispGroups,INr.BPIStone); end;
					if (nonblank(INr.BPIStrap)) then begin AddToSet(INr.DispGroups,INr.BPIStrap); end;
					if (nonblank(INr.BPIOdour)) then begin AddToSet(INr.DispGroups,INr.BPIOdour); end;
					recordstore(INr,true);
				
					//weboutstring("<BR>");
				end;
			end;
		end;
	end; 
		
return;
end;






webpublic global updating procedure WebUpdateJewDispGroupsOld()
begin
	record ITVc ITr;
	record BPIBrandVc BPIBr;
	area brands;
	integer i,OldComp;
	record INVc INr;
	OldComp = currentcompany;
	setcompany(3,false);
	if(CurrentCompany==3)then begin
		resetloop(INr);
		INr.Code = "";
		while(LoopMain(INr,1,true))begin	  
			if(nonblank(INr.BPIBrand))then begin
			
			
				//INr.OldDispGroups = INr.DispGroups;
				
				if (nonblank(INr.BPIBrand)) then begin AddToSet(INr.DispGroups,INr.BPIBrand); end;
				if (nonblank(INr.BPICollection)) then begin AddToSet(INr.DispGroups,INr.BPICollection); end;
				if (nonblank(INr.BPIGroup)) then begin AddToSet(INr.DispGroups,INr.BPIGroup); end;
				if (nonblank(INr.BPISubGroup)) then begin AddToSet(INr.DispGroups,INr.BPISubGroup); end;
				if (nonblank(INr.BPICategory)) then begin AddToSet(INr.DispGroups,INr.BPICategory); end;
				if (nonblank(INr.BPIMaterial)) then begin AddToSet(INr.DispGroups,INr.BPIMaterial); end;
				if (nonblank(INr.BPIColor)) then  begin AddToSet(INr.DispGroups,INr.BPIColor); end;
				if (nonblank(INr.BPIShape)) then begin AddToSet(INr.DispGroups,INr.BPIShape); end;
				if (nonblank(INr.BPISize)) then begin AddToSet(INr.DispGroups,INr.BPISize); end;
				if (nonblank(INr.BPISex)) then begin AddToSet(INr.DispGroups,INr.BPISex); end;
				if (nonblank(INr.BPIPlating)) then begin AddToSet(INr.DispGroups,INr.BPIPlating); end;
				if (nonblank(INr.BPIClarity)) then begin AddToSet(INr.DispGroups,INr.BPIClarity); end;
				if (nonblank(INr.BPIWeight)) then begin AddToSet(INr.DispGroups,INr.BPIWeight); end;
				if (nonblank(INr.BPICut)) then begin AddToSet(INr.DispGroups,INr.BPICut); end;
				if (nonblank(INr.BPIStone)) then begin AddToSet(INr.DispGroups,INr.BPIStone); end;
				if (nonblank(INr.BPIStrap)) then begin AddToSet(INr.DispGroups,INr.BPIStrap); end;
				if (nonblank(INr.BPIOdour)) then begin AddToSet(INr.DispGroups,INr.BPIOdour); end;
				recordstore(INr,true);
			
				//weboutstring("<BR>");
			end;
		end;
	end;
		
	resetcompany(OldComp);
return;
end;








global updating procedure BPIFixDublDispMn()
begin
	record INVc INr;
	string 100 res,class;
	integer i,pos;
	record DIVc DIr;
	boolean TrHs;
	for(i=1;i<29;i=i+1) begin
	  SetCompany(i,false);
		INr.Code="";
		TrHs=true;
		while(loopmain(INr,1,TrHs))begin
			if(INr.BPIBrand=="BRND0041") then begin INr.BPIBrand="BRND0040"; RecordStore(INr,true); end;
			if(INr.BPIBrand=="BRND0121") then begin INr.BPIBrand="BRND0120"; RecordStore(INr,true);end;
			if(INr.BPIBrand=="BRND0159") then begin INr.BPIBrand="BRND0158";RecordStore(INr,true); end;
			if(INr.BPIBrand=="BRND0186") then begin INr.BPIBrand="BRND0185";RecordStore(INr,true); end;
			If(SetInSet("BRND0041",INr.DispGroups)) then begin
				pos = 0;
				class = "";
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="BRAND")then begin
						res=res & "BRND0040,";
					end else begin
						res=res&class&",";
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				res=Left(res,len(res)-1);
				INr.DispGroups=res;
				RecordStore(INr,true);
			end;
			If(SetInSet("BRND0121",INr.DispGroups)) then begin
				pos = 0;
				class = "";
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="BRAND")then begin
						res=res & "BRND0120,";
					end else begin
						res=res&class&",";
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				res=Left(res,len(res)-1);
				INr.DispGroups=res;
				RecordStore(INr,true);
			end;
			If(SetInSet("BRND0159",INr.DispGroups)) then begin
				pos = 0;
				class = "";
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="BRAND")then begin
						res=res & "BRND0158,";
					end else begin
						res=res&class&",";
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				res=Left(res,len(res)-1);
				INr.DispGroups=res;
				RecordStore(INr,true);
			end;
			If(SetInSet("BRND0186",INr.DispGroups)) then begin
				pos = 0;
				class = "";
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="BRAND")then begin
						res=res & "BRND0185,";
					end else begin
						res=res&class&",";
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				res=Left(res,len(res)-1);
				INr.DispGroups=res;
				RecordStore(INr,true);
			end;
		end;
		ResetLoop(INr);
	end;	
return;
end;






global webpublic updating procedure WebFillCountVaych() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger15:37 24.10.2018
begin
record MaxNumGiftBlock MNGb;
 integer i;
	for(i=29;i>0;i=i-1) begin
	  SetCompany(i,false);
		blockload(MNGb)
		MNGb.Count=1;
		blockstore(MNGb);
	end;	
end;

global webpublic updating procedure WEBBPIBrandFillMn()
begin
	record BPIBrandVc BBr;
	vector string 100 vgrp;
	record INVc INr;
	record ITVc ITr;
	integer i;
	boolean TrHs,testf;
	vector string 50 vBrandCode;
	
	while(loopmain(BBr,1,true))begin
		vBrandCode[BBr.Name] = BBr.Code;
	end;

	setcompany(1,false);
	INr.Code="";
	while(LoopMain(INr,1,true)) begin
		if(blank(INr.BPIBrand))then begin
			INr.BPIBrand = "BRND0171";
			RecordStore(INr,true);
		end;
	end;
			ResetLoop(INr);
		for(i=2;i<29;i=i+1) begin
			if(i!=9 and i!=28 and (i==3 or !CompanyIsJWLikeCompany(i)))then begin
				SetCompany(i,false);
				ITr.Code="";
				TrHs=true;
				while(LoopMain(ITr,1,TrHs)) begin
					vgrp[ITr.Code]=ITr.Comment;
				end;
				ResetLoop(ITr);
				INr.Code="";
				TrHs=true;
				while(LoopMain(INr,1,TrHs)) begin
					testf = false;
					If(nonblank(INr.Group) And blank(INr.BPIBrand)) then begin
						testf=true;
						
						If(INr.Group=="ANTON") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT"; end;
						If(INr.Group=="BOCHI") then begin vgrp[INr.Group]= "Bochic"; end;
						If(INr.Group=="CV") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="DINH_") then begin vgrp[INr.Group]= "DINH VAN"; end;
						If(INr.Group=="GUCCI") then begin vgrp[INr.Group]= "GUCCI"; end;
						/*If(INr.Group=="HULCH") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="JACOB") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="JW") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="JUDIT") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="LALHO") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="LUGBA") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="MARVI") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="NANIS") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="PACHY") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="PHONE") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="RC_DI") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="SILVE") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="SLG") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="SUTRA") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="TAG_H") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="THEOF") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="TP") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="UN_PH") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="VANDE") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
						If(INr.Group=="WRT") then begin vgrp[INr.Group]= "CHRONOVISION"; end;*/
						
						
						If(vgrp[INr.Group]=="Somma kids bedlinen") then begin vgrp[INr.Group]= "SOMMA"; end;
						If(vgrp[INr.Group]=="GLASHUTTE") then begin vgrp[INr.Group]= "GLASHUTTE ORIGINAL"; end;
						If(vgrp[INr.Group]=="LEPEE") then begin vgrp[INr.Group]= "L'EPEE" ; end;
						If(vgrp[INr.Group]=="Carrera Carrera") then begin vgrp[INr.Group]= "CARRERA Y CARRERA" ; end;
						If(vgrp[INr.Group]=="Zancan Silver/Steel") then begin vgrp[INr.Group]= "Zancan" ; end;
						If(vgrp[INr.Group]=="LALIQUE PARFUME REGULAR") then begin vgrp[INr.Group]= "LALIQUE PARFUME" ; end;
						If(vgrp[INr.Group]=="Stephen Webster Silver") then begin vgrp[INr.Group]= "STEPHEN WEBSTER" ; end;
						If(vgrp[INr.Group]=="SHAUNLEANE") then begin vgrp[INr.Group]= "SHAUN LEANE" ; end;
						If(vgrp[INr.Group]=="SIA Home Fashion") then begin vgrp[INr.Group]= "SIA HOME" ; end;
						If(vgrp[INr.Group]=="ALEXANDRE TURPAULT()") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
						If(vgrp[INr.Group]=="ALEXANDRE TURPAULT()") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
						If(vgrp[INr.Group]=="ALEXANDRE TURPAULT()") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
						If(vgrp[INr.Group]=="Andrea-house") then begin vgrp[INr.Group]= "ANDREA HOUSE" ; end;
						If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANDREA HOUSE" ; end;
						If(vgrp[INr.Group]=="ANVERSA( )") then begin vgrp[INr.Group]= "ANVERSA" ; end;
						If(vgrp[INr.Group]=="Antonini") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
						If(vgrp[INr.Group]=="ALEXANDRE TURPAULT()") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
						If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
						If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
						If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
						If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
						If(vgrp[INr.Group]=="Apm ART DECO") then begin vgrp[INr.Group]= "APM MONACO" ; end;
						If(vgrp[INr.Group]=="Apm GRAPHITE") then begin vgrp[INr.Group]= "APM MONACO" ; end;
						If(vgrp[INr.Group]=="Apm LUMIERE") then begin vgrp[INr.Group]= "APM MONACO" ; end;
						If(vgrp[INr.Group]=="Apm XL") then begin vgrp[INr.Group]= "APM MONACO" ; end;
						If(vgrp[INr.Group]=="Aquanova (Terry)") then begin vgrp[INr.Group]= "AQUANOVA" ; end;
						If(vgrp[INr.Group]=="Aquanova (Accessories)") then begin vgrp[INr.Group]= "AQUANOVA" ; end;
						If(vgrp[INr.Group]=="BACCARAT BARWARE") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT BEAUTY") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT CUT STEMWARE") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT DECORATIVE ITEMS") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT DECORATIVE PIECES") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT DESK ITEMS") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT JEWELLERY") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT LIGHTS") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT LIMITED EDITIONS") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT PITCHER,JUGS,BOTTLES") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT REPLACEMENT STEMWARE") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BACCARAT TABLEWARE SUNDRIES") then begin vgrp[INr.Group]= "BACCARAT" ; end;
						If(vgrp[INr.Group]=="BEKA LOW COST") then begin vgrp[INr.Group]= "BEKA" ; end;
						If(vgrp[INr.Group]=="BERNARDAUD GIFT") then begin vgrp[INr.Group]= "BERNARDAUD" ; end;
						If(vgrp[INr.Group]=="BERNARDAUD PORCELAIN") then begin vgrp[INr.Group]= "BERNARDAUD" ; end;
						If(vgrp[INr.Group]=="BERNARDAUD JEWELLERY") then begin vgrp[INr.Group]= "BERNARDAUD" ; end;
						If(vgrp[INr.Group]=="Bodum for Coin") then begin vgrp[INr.Group]= "BODUM" ; end;
						If(vgrp[INr.Group]=="BOSS()") then begin vgrp[INr.Group]= "BOSS" ; end;
						If(vgrp[INr.Group]=="BOSS()") then begin vgrp[INr.Group]= "BOSS" ; end;
						If(vgrp[INr.Group]=="BRABANTIA KITCHEN") then begin vgrp[INr.Group]= "BRABANTIA" ; end;
						If(vgrp[INr.Group]=="BRABANTIA LOW COST") then begin vgrp[INr.Group]= "BRABANTIA" ; end;
						If(vgrp[INr.Group]=="Brabantiya") then begin vgrp[INr.Group]= "BRABANTIA" ; end;
						If(vgrp[INr.Group]=="Buckley Accessories") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
						If(vgrp[INr.Group]=="Buckley BOHO") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
						If(vgrp[INr.Group]=="Buckley Rock") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
						If(vgrp[INr.Group]=="Buckley romantic") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
						If(vgrp[INr.Group]=="Buckley Timeless") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
						If(vgrp[INr.Group]=="BUGATTI LUXURY") then begin vgrp[INr.Group]= "BUGATTI" ; end;
						If(vgrp[INr.Group]=="Calvin Klein ()") then begin vgrp[INr.Group]= "CALVIN KLEIN" ; end;
						If(vgrp[INr.Group]=="Calvin Klein ()") then begin vgrp[INr.Group]= "CALVIN KLEIN" ; end;
						If(vgrp[INr.Group]=="Calvin Klein ()") then begin vgrp[INr.Group]= "CALVIN KLEIN" ; end;
						If(vgrp[INr.Group]=="CHRISTOFLE ()") then begin vgrp[INr.Group]= "CHRISTOFLE" ; end;
						If(vgrp[INr.Group]=="CHRISTOFLE ()") then begin vgrp[INr.Group]= "CHRISTOFLE" ; end;
						If(vgrp[INr.Group]=="CHRISTOFLE ()") then begin vgrp[INr.Group]= "CHRISTOFLE" ; end;
						If(vgrp[INr.Group]=="CHRISTOFLE ()") then begin vgrp[INr.Group]= "CHRISTOFLE" ; end;
						If(vgrp[INr.Group]=="CINELLI (Duvets)") then begin vgrp[INr.Group]= "CINELLI" ; end;
						If(vgrp[INr.Group]=="CINELLI (Pillows)") then begin vgrp[INr.Group]= "CINELLI" ; end;
						If(vgrp[INr.Group]=="Cofur aht") then begin vgrp[INr.Group]= "COFUR" ; end;
						If(vgrp[INr.Group]=="Cogal Robe") then begin vgrp[INr.Group]= "COGAL" ; end;
						If(vgrp[INr.Group]=="DEKORATIEF  LOW COST") then begin vgrp[INr.Group]= "DEKORATIEF" ; end;
						If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
						If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
						If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
						If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
						If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
						If(vgrp[INr.Group]=="DIBBERN Porcelain") then begin vgrp[INr.Group]= "DIBBERN" ; end;
						If(vgrp[INr.Group]=="DONDI SVAD ( )") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="DONDI SVAD (  )") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="DONDI SVAD (  )") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="DONDI SVAD ()") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="DONDI SVAD ()") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="DONDI SVAD ()") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="DONDI SVAD (Specail offer)") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="Dupon") then begin vgrp[INr.Group]= "Dupont" ; end;
						If(vgrp[INr.Group]=="EDG Accessories") then begin vgrp[INr.Group]= "EDG" ; end;
						If(vgrp[INr.Group]=="EDG FLOWERS") then begin vgrp[INr.Group]= "EDG" ; end;
						If(vgrp[INr.Group]=="Egizia Promo") then begin vgrp[INr.Group]= "EGIZIA" ; end;
						If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER" ; end;
						If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER" ; end;
						If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER" ; end;
						If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER" ; end;
						If(vgrp[INr.Group]=="FFRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
						If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
						If(vgrp[INr.Group]=="FRETTE( )") then begin vgrp[INr.Group]= "FRETTE" ; end;
						If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
						If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
						If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
						If(vgrp[INr.Group]=="GLASHUTTE") then begin vgrp[INr.Group]= "GLASHUTTE ORIGINAL" ; end;
						If(vgrp[INr.Group]=="GREGGIO ARGENTO CORNICA") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO CESA ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO CESA CUTLERY") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO DOGALE ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO GREGGIO ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO GREGGIO CUTLERY") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO LOVELIES ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO MASSINI ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO OLRY ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO OLRY CUTLERY") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO ROYAL COLLECTION") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO SILVERPLATE") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="GREGGIO SILVERPLATE CUTLERY") then begin vgrp[INr.Group]= "GREGGIO" ; end;
						If(vgrp[INr.Group]=="HEREND()") then begin vgrp[INr.Group]= "HEREND" ; end;
						If(vgrp[INr.Group]=="HAVILAND TABLEWARE") then begin vgrp[INr.Group]= "HAVILAND" ; end;
						If(vgrp[INr.Group]=="GUZZINI FORME CASA") then begin vgrp[INr.Group]= "GUZZINI" ; end;
						If(vgrp[INr.Group]=="HEREND()") then begin vgrp[INr.Group]= "HEREND" ; end;
						If(vgrp[INr.Group]=="HEREND()") then begin vgrp[INr.Group]= "HEREND" ; end;
						If(vgrp[INr.Group]=="HERING ACCESSORIES") then begin vgrp[INr.Group]= "HEREND" ; end;
						If(vgrp[INr.Group]=="HERING GLASSES") then begin vgrp[INr.Group]= "HEREND" ; end;
						If(vgrp[INr.Group]=="HERING PORCELAIN") then begin vgrp[INr.Group]= "HEREND" ; end;
						If(vgrp[INr.Group]=="HOMMERS") then begin vgrp[INr.Group]= "HOMERS" ; end;
						If(vgrp[INr.Group]=="HOMMERS DS") then begin vgrp[INr.Group]= "HOMERS" ; end;
						If(vgrp[INr.Group]=="IVV EVERYDAY") then begin vgrp[INr.Group]= "IVV" ; end;
						If(vgrp[INr.Group]=="IVV Novelties ") then begin vgrp[INr.Group]= "IVV" ; end;
						If(vgrp[INr.Group]=="IVV POS") then begin vgrp[INr.Group]= "IVV" ; end;
						If(vgrp[INr.Group]=="IVV PROMO") then begin vgrp[INr.Group]= "IVV" ; end;
						If(vgrp[INr.Group]=="JAIMIES discounted") then begin vgrp[INr.Group]= "JAIMIES" ; end;
						If(vgrp[INr.Group]=="Jalla()") then begin vgrp[INr.Group]= "JALLA" ; end;
						If(vgrp[INr.Group]=="Jalla()") then begin vgrp[INr.Group]= "JALLA" ; end;
						If(vgrp[INr.Group]=="Jalla()") then begin vgrp[INr.Group]= "JALLA" ; end;
						If(vgrp[INr.Group]=="Jalla()") then begin vgrp[INr.Group]= "JALLA" ; end;
						If(vgrp[INr.Group]=="JARDIN SECRET()") then begin vgrp[INr.Group]= "JARDIN SECRET" ; end;
						If(vgrp[INr.Group]=="JARDIN SECRET()") then begin vgrp[INr.Group]= "JARDIN SECRET" ; end;
						If(vgrp[INr.Group]=="JUDITH RIPKA SILVER") then begin vgrp[INr.Group]= "JUDITH RIPKA" ; end;
						If(vgrp[INr.Group]=="Kaiser Gourmet") then begin vgrp[INr.Group]= "KAISER" ; end;
						If(vgrp[INr.Group]=="KARE Accessories") then begin vgrp[INr.Group]= "KARE" ; end;
						If(vgrp[INr.Group]=="KARE Furniture") then begin vgrp[INr.Group]= "KARE" ; end;
						If(vgrp[INr.Group]=="KARE Price Hero") then begin vgrp[INr.Group]= "KARE" ; end;
						If(vgrp[INr.Group]=="Kate International Down production") then begin vgrp[INr.Group]= "KATE INTERNATIONAL" ; end;
						If(vgrp[INr.Group]=="Kate International Textile") then begin vgrp[INr.Group]= "KATE INTERNATIONAL" ; end;
						If(vgrp[INr.Group]=="Katrine Leuze") then begin vgrp[INr.Group]= "KATRIN LEUZE" ; end;
						If(vgrp[INr.Group]=="Kauffman") then begin vgrp[INr.Group]= "KAUFFMANN" ; end;
						If(vgrp[INr.Group]=="kauffman Duvet") then begin vgrp[INr.Group]= "KAUFFMANN" ; end;
						If(vgrp[INr.Group]=="kauffman Pillow") then begin vgrp[INr.Group]= "KAUFFMANN" ; end;
						If(vgrp[INr.Group]=="LA JACUARD FRANCAIS") then begin vgrp[INr.Group]= "LE JACQUARD" ; end;
						If(vgrp[INr.Group]=="LALIQUE GENERAL") then begin vgrp[INr.Group]= "LALIQUE" ; end;
						If(vgrp[INr.Group]=="LALIQUE JEWELERY") then begin vgrp[INr.Group]= "LALIQUE" ; end;
						If(vgrp[INr.Group]=="LALIQUE PARFUME JAQUAR") then begin vgrp[INr.Group]= "LALIQUE PARFUME" ; end;
						If(vgrp[INr.Group]=="LALIQUE PARFUME REGULAR") then begin vgrp[INr.Group]= "LALIQUE PARFUME" ; end;
						If(vgrp[INr.Group]=="LALIQUE PARFUME CRYSTAL") then begin vgrp[INr.Group]= "LALIQUE PARFUME" ; end;
						If(vgrp[INr.Group]=="LE_CREUSET_CAST") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
						If(vgrp[INr.Group]=="LE_CREUSET_CERA") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
						If(vgrp[INr.Group]=="LE_CREUSET_KET") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
						If(vgrp[INr.Group]=="LE_CREUSET_MIL") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
						If(vgrp[INr.Group]=="LE_CREUSET_STON") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
						If(vgrp[INr.Group]=="LENOX ACCESSORIES") then begin vgrp[INr.Group]= "LENOX" ; end;
						If(vgrp[INr.Group]=="LENOX BUTTERFLY MEDOW") then begin vgrp[INr.Group]= "LENOX" ; end;
						If(vgrp[INr.Group]=="LENOX CRYSTAL") then begin vgrp[INr.Group]= "LENOX" ; end;
						If(vgrp[INr.Group]=="LENOX DISNEY") then begin vgrp[INr.Group]= "LENOX" ; end;
						If(vgrp[INr.Group]=="LENOX NEW YEAR") then begin vgrp[INr.Group]= "LENOX" ; end;
						If(vgrp[INr.Group]=="LENOX TABLEWARE") then begin vgrp[INr.Group]= "LENOX" ; end;
						If(vgrp[INr.Group]=="Louis De poortere") then begin vgrp[INr.Group]= "LOUIS DE POORTERE" ; end;
						If(vgrp[INr.Group]=="Luxenter EDURNE") then begin vgrp[INr.Group]= "LUXENTER" ; end;
						If(vgrp[INr.Group]=="Luxenter HAPPY GEMS") then begin vgrp[INr.Group]= "LUXENTER" ; end;
						If(vgrp[INr.Group]=="Luxenter MOMENTS") then begin vgrp[INr.Group]= "LUXENTER" ; end;
						If(vgrp[INr.Group]=="Luxenter SILVER") then begin vgrp[INr.Group]= "LUXENTER" ; end;
						If(vgrp[INr.Group]=="MILLEFIORI  MILLEFIORI") then begin vgrp[INr.Group]= "MILLEFIORI" ; end;
						If(vgrp[INr.Group]=="Misaki CULTURED GOLD") then begin vgrp[INr.Group]= "MISAKI" ; end;
						If(vgrp[INr.Group]=="Misaki CULTURED RHODIUM") then begin vgrp[INr.Group]= "MISAKI" ; end;
						If(vgrp[INr.Group]=="Misaki CULTURED ROSE GOLD") then begin vgrp[INr.Group]= "MISAKI" ; end;
						If(vgrp[INr.Group]=="Misaki HAND MADE GLASS PEARLS GOLD") then begin vgrp[INr.Group]= "MISAKI" ; end;
						If(vgrp[INr.Group]=="Misaki HAND MADE GLASS PEARLS RHODIUM") then begin vgrp[INr.Group]= "MISAKI" ; end;
						If(vgrp[INr.Group]=="Misaki HAND MADE GLASS PEARLS ROSE GOLD") then begin vgrp[INr.Group]= "MISAKI" ; end;
						If(vgrp[INr.Group]=="Misaki HAND MADE GLASS PEARLS STEEL") then begin vgrp[INr.Group]= "MISAKI" ; end;
						If(vgrp[INr.Group]=="MOSER ARMUDU") then begin vgrp[INr.Group]= "MOSER" ; end;
						If(vgrp[INr.Group]=="MOSER BAKU") then begin vgrp[INr.Group]= "MOSER" ; end;
						If(vgrp[INr.Group]=="MOSER CRYSTAL SETS") then begin vgrp[INr.Group]= "MOSER" ; end;
						If(vgrp[INr.Group]=="MOSER VASES&ACCESSORIES") then begin vgrp[INr.Group]= "MOSER" ; end;
						If(vgrp[INr.Group]=="NINA RICCI()") then begin vgrp[INr.Group]= "NINA RICCI" ; end;
						If(vgrp[INr.Group]=="NINA RICCI()") then begin vgrp[INr.Group]= "NINA RICCI" ; end;
						If(vgrp[INr.Group]=="PLAUENER ()") then begin vgrp[INr.Group]= "PLAUENER" ; end;
						If(vgrp[INr.Group]=="PLAUENER ()") then begin vgrp[INr.Group]= "PLAUENER" ; end;
						If(vgrp[INr.Group]=="PLAUENER ()") then begin vgrp[INr.Group]= "PLAUENER" ; end;
						If(vgrp[INr.Group]=="RALPH LAUIREN HOME()") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
						If(vgrp[INr.Group]=="RALPH LAUREN HOME()") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
						If(vgrp[INr.Group]=="RALPH LAUREN HOME()") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
						If(vgrp[INr.Group]=="RALPH LAUREN HOME( )") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
						If(vgrp[INr.Group]=="Raulph Lauren ") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
						If(vgrp[INr.Group]=="ROBB&BERKING ACCESSORIES") then begin vgrp[INr.Group]= "ROBBE BERKING" ; end;
						If(vgrp[INr.Group]=="ROBB&BERKING CUTLERY") then begin vgrp[INr.Group]= "ROBBE BERKING" ; end;
						If(vgrp[INr.Group]=="Rosenthal ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
						If(vgrp[INr.Group]=="Rosenthal ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
						If(vgrp[INr.Group]=="Rosenthal Studio-Line ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
						If(vgrp[INr.Group]=="Rosenthal Studio-Line ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
						If(vgrp[INr.Group]=="Rosenthal Studio-Line ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
						If(vgrp[INr.Group]=="Sambonet Kids ") then begin vgrp[INr.Group]= "SAMBONET" ; end;
						If(vgrp[INr.Group]=="Sambonet promo") then begin vgrp[INr.Group]= "SAMBONET" ; end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
						If(vgrp[INr.Group]=="Schlossberg (classic)") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
						If(vgrp[INr.Group]=="Schlossberg (Special Offer)") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
						If(vgrp[INr.Group]=="SCHOTT ZWIESEL POS") then begin vgrp[INr.Group]= "SCHOTT ZWIESEL" ; end;
						If(vgrp[INr.Group]=="SCHOTT ZWIESEL PROMO") then begin vgrp[INr.Group]= "SCHOTT ZWIESEL" ; end;
						If(vgrp[INr.Group]=="Schott Zwiesl Promo") then begin vgrp[INr.Group]= "SCHOTT ZWIESEL" ; end;
						If(vgrp[INr.Group]=="SIA HOME FASHION") then begin vgrp[INr.Group]= "SIA HOME" ; end;
						If(vgrp[INr.Group]=="SIA Home Fashion") then begin vgrp[INr.Group]= "SIA HOME" ; end;
						If(vgrp[INr.Group]=="Somma throws") then begin vgrp[INr.Group]= "SOMMA" ; end;
						If(vgrp[INr.Group]=="Stephen Webster Silver") then begin vgrp[INr.Group]= "STEPHEN WEBSTER" ; end;
						If(vgrp[INr.Group]=="Svad Dondi Bedcovers") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="Svad Dondi Textile") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
						If(vgrp[INr.Group]=="Thomas Sabo Charm Club") then begin vgrp[INr.Group]= "THOMAS SABO" ; end;
						If(vgrp[INr.Group]=="Thomas Sabo Sterling Silver") then begin vgrp[INr.Group]= "THOMAS SABO" ; end;
						If(vgrp[INr.Group]=="TOMMY HILFIGER()") then begin vgrp[INr.Group]= "TOMMY HILFIGER" ; end;
						If(vgrp[INr.Group]=="TOMMY HILFIGER()") then begin vgrp[INr.Group]= "TOMMY HILFIGER" ; end;
						If(vgrp[INr.Group]=="TVS LOW COST") then begin vgrp[INr.Group]= "TVS" ; end;
						If(vgrp[INr.Group]=="VAN_REMORT") then begin vgrp[INr.Group]= "VAN REMORTEL" ; end;
						If(vgrp[INr.Group]=="Versace ()") then begin vgrp[INr.Group]= "VERSACE" ; end;
						If(vgrp[INr.Group]=="Versace ()") then begin vgrp[INr.Group]= "VERSACE" ; end;
						If(vgrp[INr.Group]=="Versace ()") then begin vgrp[INr.Group]= "VERSACE" ; end;
						If(vgrp[INr.Group]=="Versace ()") then begin vgrp[INr.Group]= "VERSACE" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Accessories") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Christmas") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Classic") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Country") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Cutlery") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Home Decor") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Kids") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Metropolitan") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="VILLEROY & BOCH Stemware") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
						If(vgrp[INr.Group]=="WEDGWOOD GIFTS&ACCESSORIES") then begin vgrp[INr.Group]= "WEDGWOOD" ; end;
						If(vgrp[INr.Group]=="WEISSFEE GUESTBOOK ") then begin vgrp[INr.Group]= "WEDGWOOD" ; end;
						If(vgrp[INr.Group]=="Weissfee bedlinen") then begin vgrp[INr.Group]= "WEISSFEE " ; end;
						If(vgrp[INr.Group]=="WEISSFEE NAPKIN") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
						If(vgrp[INr.Group]=="WEISSFEE PLACEMAT") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
						If(vgrp[INr.Group]=="WEISSFEE TABLECENTER") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
						If(vgrp[INr.Group]=="WEISSFEE TABLECLOTH") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
						If(vgrp[INr.Group]=="Weissfee terry") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
						If(vgrp[INr.Group]=="WMF Accessories") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Bistro") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Black Line") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF COFFEE MACHINES") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Consumer electrics") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Cookware") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Cutlery") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Frying pans") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF HOTEL") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Kettles") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Kids") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Knives") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Pressure cookers") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Profi") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="WMF Tea pots") then begin vgrp[INr.Group]= "WMF" ; end;
						If(vgrp[INr.Group]=="y.Delorme ") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="YANKEE CANDLE  CLASSIC COLLECTION") then begin vgrp[INr.Group]= "YANKEE CANDLE" ; end;
						If(vgrp[INr.Group]=="YANKEE CANDLE ACCESSORIES") then begin vgrp[INr.Group]= "YANKEE CANDLE" ; end;
						If(vgrp[INr.Group]=="YANKEE CANDLE POS") then begin vgrp[INr.Group]= "YANKEE CANDLE" ; end;
						If(vgrp[INr.Group]=="Yves Delorme ( Laurence Tavernier )") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="YVES DELORME (.  )") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="YVES DELORME()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="Zancan Silver/Steel") then begin vgrp[INr.Group]= "Zancan" ; end;
						If(vgrp[INr.Group]=="LE_CREUSET_CAST ") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
						If(vgrp[INr.Group]=="Louis De poortere") then begin vgrp[INr.Group]= "LOUIS DE POORTERE" ; end;
						If(vgrp[INr.Group]=="EDG FLOWERS ") then begin vgrp[INr.Group]= "EDG" ; end;
						If(vgrp[INr.Group]=="CoinCasa") then begin vgrp[INr.Group]= "COIN CASA" ; end;
						If(vgrp[INr.Group]=="NACHTMANN FOR COIN") then begin vgrp[INr.Group]= "NACHTMANN" ; end;
						If(vgrp[INr.Group]=="EDG Accessories") then begin vgrp[INr.Group]= "EDG" ; end;
						If(vgrp[INr.Group]=="Bodum for Coin ") then begin vgrp[INr.Group]= "BODUM" ; end;
						If(vgrp[INr.Group]=="CINELLI (Duvets)  ") then begin vgrp[INr.Group]= "CINELLI" ; end;
						If(vgrp[INr.Group]=="CINELLI (Pillows)  ") then begin vgrp[INr.Group]= "CINELLI" ; end;
						If(vgrp[INr.Group]=="Cogal Towel") then begin vgrp[INr.Group]= "COGAL" ; end;
						If(vgrp[INr.Group]=="EDG FLOWERS") then begin vgrp[INr.Group]= "EDG " ; end;
						If(vgrp[INr.Group]=="EDG Accessories") then begin vgrp[INr.Group]= "EDG " ; end;
						If(vgrp[INr.Group]=="Kaiser Gourmet ") then begin vgrp[INr.Group]= "KAISER" ; end;
						If(vgrp[INr.Group]=="Buckley Timeless") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
						If(vgrp[INr.Group]=="Buckley BOHO") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
						If(vgrp[INr.Group]=="Aquanova (Terry)") then begin vgrp[INr.Group]= "AQUANOVA" ; end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
						If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
						If(vgrp[INr.Group]=="Cofur aht") then begin vgrp[INr.Group]= "COFUR " ; end;
						If(vgrp[INr.Group]=="DEKORATIEF  LOW COST") then begin vgrp[INr.Group]= "DEKORATIEF  " ; end;
						If(vgrp[INr.Group]=="Buckley Timeless") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ; end;
						If(vgrp[INr.Group]=="Buckley Rock") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ; end;
						If(vgrp[INr.Group]=="Buckley BOHO") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ; end;
						If(vgrp[INr.Group]=="Buckley Accessories") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ; end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ; end;
						If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
						If(vgrp[INr.Group]=="ALEXANDRE TURPAULT() ") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT " ; end;
						If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER " ; end;
						If(vgrp[INr.Group]=="Aquanova (Terry) ") then begin vgrp[INr.Group]= "AQUANOVA" ; end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ; end;
						If(vgrp[INr.Group]=="ALEXANDRE TURPAULT() ") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT " ; end;
						If(vgrp[INr.Group]=="Yves Delorme ( Laurence Tavernier )  ") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
						If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
						If(vgrp[INr.Group]=="Somma throws") then begin vgrp[INr.Group]= "SOMMA " ; end;
						If(vgrp[INr.Group]=="WEDGWOOD TABLEWARE") then begin vgrp[INr.Group]= "WEDGWOOD" ; end;
						If(vgrp[INr.Group]=="ALEXANDRE TURPAULT() ") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT " ;  end;
						If(vgrp[INr.Group]=="HERING PORCELAIN") then begin vgrp[INr.Group]= "HERING" ;  end;
						If(vgrp[INr.Group]=="BACCARAT TABLEWARE") then begin vgrp[INr.Group]= "BACCARAT" ;  end;
						If(vgrp[INr.Group]=="WEISSFEE GUESTBOOK") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
						If(vgrp[INr.Group]=="WEISSFEE NAPKIN ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
						If(vgrp[INr.Group]=="Rosenthal ()") then begin vgrp[INr.Group]= "ROSENTHAL" ;  end;
						If(vgrp[INr.Group]=="Andrea-house ") then begin vgrp[INr.Group]= "ANDREA HOUSE" ;  end;
						If(vgrp[INr.Group]=="SIA Home Fashion ") then begin vgrp[INr.Group]= "SIA HOME" ;  end;
						If(vgrp[INr.Group]=="WEISSFEE NAPKIN ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
					
					
						If(vgrp[INr.Group]=="ALESSI POS") then begin vgrp[INr.Group]= "ALESSI" ;  end;
						If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ;  end;
						If(vgrp[INr.Group]=="Buckley romantic") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ;  end;
						If(vgrp[INr.Group]=="BUGATTI LUXURY") then begin vgrp[INr.Group]= "BUGATTI " ;  end;
						If(vgrp[INr.Group]=="ChronoVision Movers") then begin vgrp[INr.Group]= "CHRONOVISION" ;  end;
						If(vgrp[INr.Group]=="Classic Porcelain") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="CRISTOFLE JEWELLERY") then begin vgrp[INr.Group]= "CHRISTOFLE" ;  end;
						If(vgrp[INr.Group]=="DAUM PRESTIGE") then begin vgrp[INr.Group]= "DAUM" ;  end;
						If(vgrp[INr.Group]=="Dinh Van ") then begin vgrp[INr.Group]= "DINH VAN" ;  end;
						If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER " ;  end;
						If(vgrp[INr.Group]=="GREGGIO CUSTOMIZED") then begin vgrp[INr.Group]= "GREGGIO" ;  end;
						If(vgrp[INr.Group]=="Gres") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="HELIO") then begin vgrp[INr.Group]= "HELIOS" ;  end;
						If(vgrp[INr.Group]=="HERING ACCESSORIES") then begin vgrp[INr.Group]= "HERING" ;  end;
						If(vgrp[INr.Group]=="HERING GLASSES") then begin vgrp[INr.Group]= "HERING" ;  end;
						If(vgrp[INr.Group]=="High Porcelain") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="Hulchi Belluni ") then begin vgrp[INr.Group]= "HULCHI BELLUNI" ;  end;
						If(vgrp[INr.Group]=="LE_CREUSET_MIL ") then begin vgrp[INr.Group]= "LE CREUSET" ;  end;
						If(vgrp[INr.Group]=="Lighting") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="Light&Living*3") then begin vgrp[INr.Group]= "LIGHT&LIVING" ;  end;
						If(vgrp[INr.Group]=="Louis De poortere  ") then begin vgrp[INr.Group]= "LOUIS DE POORTERE" ;  end;
						If(vgrp[INr.Group]=="Luxenter EDURNE") then begin vgrp[INr.Group]= "LUXENTER " ;  end;
						If(vgrp[INr.Group]=="Matt Porcelain") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="Naturo Fantastic") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="Others") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="ReDeco") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
						If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
						If(vgrp[INr.Group]=="Schlossberg (classic)") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
						If(vgrp[INr.Group]=="Schlossberg (Special Offer)") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
						If(vgrp[INr.Group]=="SIA_High") then begin vgrp[INr.Group]= "SIA HOME" ;  end;
						If(vgrp[INr.Group]=="Table Lamp") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="Tag Heuer") then begin vgrp[INr.Group]= "TAG HEUER " ;  end;
						If(vgrp[INr.Group]=="The Fifth Season") then begin vgrp[INr.Group]= "ROBERTO COIN" ;  end;
						If(vgrp[INr.Group]=="WEISSFEE GUESTBOOK ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
						If(vgrp[INr.Group]=="WEISSFEE NAPKIN ") then begin vgrp[INr.Group]= "WEISSFEE " ;  end;
						If(vgrp[INr.Group]=="WEISSFEE NAPKINS") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
						If(vgrp[INr.Group]=="WEISSFEE PLACEMAT ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
						If(vgrp[INr.Group]=="WEISSFEE RUNNER ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
						If(vgrp[INr.Group]=="WEISSFEE TABLECENTER ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
						If(vgrp[INr.Group]=="Weissfee terry") then begin vgrp[INr.Group]= "WEISSFEE " ;  end;
						If(vgrp[INr.Group]=="Zancan Watches ") then begin vgrp[INr.Group]= "Zancan" ;  end;
						If(vgrp[INr.Group]=="Consignment (  )") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="De Bethune CHF") then begin vgrp[INr.Group]= "DAUM" ;  end;
						If(vgrp[INr.Group]=="Cento") then begin vgrp[INr.Group]= "ROBERTO COIN" ;  end;
						If(vgrp[INr.Group]=="DUPON") then begin vgrp[INr.Group]= "Dupont" ;  end;
						If(vgrp[INr.Group]=="Morellato") then begin vgrp[INr.Group]= "JUST CAVALLI" ;  end;
						If(vgrp[INr.Group]=="ANDREA_ACC") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="Andrea Accessories") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="ANDREA_EKS") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="ANDREA_FU") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="Andrea-house ") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="Andrea-K") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="Andrea-K-Accessories") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="Andrea-K-Ekspo                            ") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="Andrea-K-Furniture") then begin vgrp[INr.Group]= "KARE" ;  end;
						If(vgrp[INr.Group]=="Consignment (  )") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="SOHER") then begin vgrp[INr.Group]= "LLADRO" ;  end;
						If(vgrp[INr.Group]=="Sambonet") then begin vgrp[INr.Group]= "Paderno" ;  end;
						If(vgrp[INr.Group]=="PADERNO") then begin vgrp[INr.Group]= "SAMBONET" ;  end;
						If(vgrp[INr.Group]=="Morellato") then begin vgrp[INr.Group]= "MASERATI" ;  end;
						If(vgrp[INr.Group]=="KOSTA BODA") then begin vgrp[INr.Group]= "ORREFORS" ;  end;
						If(vgrp[INr.Group]=="Morellato") then begin vgrp[INr.Group]= "TRUSSARDI" ;  end;
					
					
						if(testf) then begin
							//BBr.Name=vgrp[INr.Group];
							//If(ReadFirstKey("Name",BBr,1,true)) then begin
							if(nonblank(vBrandCode[vgrp[INr.Group]]))then begin
								INr.BPIBrand=vBrandCode[vgrp[INr.Group]];//BBr.Code;
								recordStore(INr,true);
							end else begin
								logtext(0,"NotFound Brand " & vgrp[INr.Group] & " <- " & INr.Group);
							end;
							//end;	
						end;
					end;
				end;	
			end;
		end;	
		logtext(0,"Finish WEBBPIBrandFillMn");
return;
end;

global updating procedure BPIBrandAddClassMn()
begin
	record BPIBrandVc BBr;
	record DIVc DIr;
	record INVc INr;
	integer i,pos;
	string 100 class,tmp;
	boolean TrHs,testf,Brndf;
	
	for(i=1;i<29;i=i+1) begin
		if(/*!CompanyIsJWLikeCompany(i) or */i==3)	then begin
			SetCompany(i,false);
			logtext(0,"Comp:" & i);
			INr.Code="";
			while(LoopMain(INr,1,true)) begin
				If(nonblank(INr.DispGroups) And nonblank(INr.BPIBrand)) then begin
					Brndf = false;
					pos = 0;
					tmp="";
					ExtractObj(INr.DispGroups,pos,class);
					while(nonblank(class)) begin
						DIr.Code = class;
						if(readfirstmain(DIr,1,true)) then begin 
							if(Dir.CType=="BRAND")then begin
								tmp=tmp & INr.BPIBrand & ",";
								Brndf = true;
							end else begin 		
								tmp=tmp & class & ","; 
							end;
						end;
						ExtractObj(INr.DispGroups,pos,class);
					end;
					if(!Brndf)then begin
						INr.DispGroups = INr.DispGroups & "," & INr.BPIBrand;
					end;
					RecordStore(INr,true);
				end;	
				if(blank(INr.DispGroups) And nonblank(INr.BPIBrand)) then begin
					INr.DispGroups = INr.BPIBrand;
					RecordStore(INr,true);
				end;			
			end;
			ResetLoop(INr);
		end;	
	end;
return
end;	




global updating procedure BPIBrandAddifEmptMn()
begin
	record BPIBrandVc BBr;
	record DIVc DIr;
	record INVc INr;
	integer i,pos;
	string 100 class,tmp;
	boolean TrHs,testf,Brndf;
	
	for(i=1;i<29;i=i+1) begin
		if(!CompanyIsJWLikeCompany(i) or i==3)	then begin
			SetCompany(i,false);
			logtext(0,"Comp:" & i);
			INr.Code="";
			while(LoopMain(INr,1,true)) begin
				If(nonblank(INr.DispGroups) And nonblank(INr.BPIBrand)) then begin
					Brndf = false;
					pos = 0;
					tmp="";
					ExtractObj(INr.DispGroups,pos,class);
					while(nonblank(class)) begin
						DIr.Code = class;
						if(readfirstmain(DIr,1,true)) then begin 
							if(Dir.CType=="BRAND")then begin
								tmp=tmp & INr.BPIBrand & ",";
								Brndf = true;
							end else begin 		
								tmp=tmp & class & ","; 
							end;
						end;
						ExtractObj(INr.DispGroups,pos,class);
					end;
					if(!Brndf)then begin
						INr.DispGroups = INr.DispGroups & "," & INr.BPIBrand;
					end;
					RecordStore(INr,true);
				end;	
				if(blank(INr.DispGroups) And nonblank(INr.BPIBrand)) then begin
					INr.DispGroups = INr.BPIBrand;
					RecordStore(INr,true);
				end;			
			end;
			ResetLoop(INr);
		end;	
	end;
return
end;	





global webpublic updating procedure offWebBPIBrandCheck()// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 18 December 2018 12:59:33
begin
	record BPIBrandVc BBr;
	record DIVc DIr;
	record INVc INr;
	integer i,pos;
	string 100 class,tmp;
	boolean TrHs,testf;
		
	for(i=1; i<29;i=i+1) begin
		if(!CompanyIsJWLikeCompany(i) or i==3)	then begin
			SetCompany(i,false);
			logtext(0,"Comp:" & i);
			INr.Code="";
			while(LoopMain(INr,1,true)) begin
				If(nonblank(INr.DispGroups) And nonblank(INr.BPIBrand)) then begin
					if(!setinset(INr.BPIBrand,INr.DispGroups))then begin
						logtext(0,"BPIBrandAddClassMn " & i & " item " & INr.Code & " = " & INr.BPIBrand & " -> " & INr.DispGroups);
						if(INr.BPIBrand=="BRND0242" and setinset("BRND0189",INr.DispGroups))then begin
							INr.BPIBrand = "BRND0189";
							recordstore(INr,true);
							logtext(0,INr.Code & " Stored");
						end;
						
						if(INr.BPIBrand=="BRND0250" and setinset("BRND0174",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.BPIBrand=="BRND0241" and setinset("BRND0149",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.BPIBrand=="BRND0004" and !setinset("BRND0004",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						if(INr.BPIBrand=="BRND0049" and !setinset("BRND0049",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						if(INr.BPIBrand=="BRND0242" and !setinset("BRND0242",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.BPIBrand=="BRND0253" and !setinset("BRND0253",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.BPIBrand=="BRND0008" and !setinset("BRND0008",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.BPIBrand=="BRND0071" and !setinset("BRND0071",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.BPIBrand=="BRND0021" and !setinset("BRND0021",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.BPIBrand=="BRND0130" and !setinset("BRND0130",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.BPIBrand=="BRND0046" and !setinset("BRND0046",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						
						if(INr.BPIGroup=="GROUP0052" and !setinset("GROUP0052",INr.DispGroups))then begin
							goto lWebBPIBrandCheck;
						end;
						
						if(INr.DispGroups==INr.OldDispGroups and nonblank(INr.BPIBrand))then begin
							goto lWebBPIBrandCheck;
						end;
						

						
						if(left(INr.DispGroups,5)=="GROUP")then begin
lWebBPIBrandCheck:;
							INr.DispGroups = "";
							if (nonblank(INr.BPIBrand)) then begin AddToSet(INr.DispGroups,INr.BPIBrand); end;
							if (nonblank(INr.BPICollection)) then begin AddToSet(INr.DispGroups,INr.BPICollection); end;
							if (nonblank(INr.BPIGroup)) then begin AddToSet(INr.DispGroups,INr.BPIGroup); end;
							if (nonblank(INr.BPISubGroup)) then begin AddToSet(INr.DispGroups,INr.BPISubGroup); end;
							if (nonblank(INr.BPICategory)) then begin AddToSet(INr.DispGroups,INr.BPICategory); end;
							if (nonblank(INr.BPIMaterial)) then begin AddToSet(INr.DispGroups,INr.BPIMaterial); end;
							if (nonblank(INr.BPIColor)) then  begin AddToSet(INr.DispGroups,INr.BPIColor); end;
							if (nonblank(INr.BPIShape)) then begin AddToSet(INr.DispGroups,INr.BPIShape); end;
							if (nonblank(INr.BPISize)) then begin AddToSet(INr.DispGroups,INr.BPISize); end;
							if (nonblank(INr.BPISex)) then begin AddToSet(INr.DispGroups,INr.BPISex); end;
							if (nonblank(INr.BPIPlating)) then begin AddToSet(INr.DispGroups,INr.BPIPlating); end;
							if (nonblank(INr.BPIClarity)) then begin AddToSet(INr.DispGroups,INr.BPIClarity); end;
							if (nonblank(INr.BPIWeight)) then begin AddToSet(INr.DispGroups,INr.BPIWeight); end;
							if (nonblank(INr.BPICut)) then begin AddToSet(INr.DispGroups,INr.BPICut); end;
							if (nonblank(INr.BPIStone)) then begin AddToSet(INr.DispGroups,INr.BPIStone); end;
							if (nonblank(INr.BPIStrap)) then begin AddToSet(INr.DispGroups,INr.BPIStrap); end;
							if (nonblank(INr.BPIOdour)) then begin AddToSet(INr.DispGroups,INr.BPIOdour); end;
							recordstore(INr,true);
							logtext(0,INr.Code & " Stored");
						end;
					end;			
				end;
			end;
			ResetLoop(INr);
		end;	
	end;
	
return
end;	


global webpublic updating procedure WebClearMainCode()// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 18 December 2018 12:59:33
begin
	record BPIBrandVc BBr;
	record DIVc DIr;
	record INVc INr;
	integer i,pos;
	string 100 class,tmp;
	boolean TrHs,testf;
		
	for(i=1; i<29;i=i+1) begin
		if(!CompanyIsJWLikeCompany(i) or i==3)	then begin
			SetCompany(i,false);
			logtext(0,"Comp:" & i);
			INr.Code="";
			while(LoopMain(INr,1,true)) begin
				If(nonblank(INr.MainCode) And INr.MainCode==INr.Code) then begin
					INr.MainCode = "";
					logtext(0,"Clear mainCode " & INr.Code);
					recordstore(INr,true);
				end;
			end;
			ResetLoop(INr);
			
		end;	
	end;
	
return
end;	

global webpublic updating procedure WebTripSpace() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger15:37 24.10.2018
begin
record BPIBrandVc BBr;
string 100 oldstr,nstr;
  setcompany(1,false);
  BBr.Code="";
	while(LoopMain(BBr,1,true)) begin
	  oldstr=BBr.Name;
		stripendingspaces(BBr.Name);
	  nstr=BBr.Name;
		if(oldstr!=nstr) then begin end;
		RecordStore(BBr,true);
	end;
	logtext(0,"finish Web trip");
return;
end;	

global webpublic updating procedure WebFillModule()//Edit_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-ABR 10:02 26.10.2018
begin
	record BPICollectionVc BCr;
	record DIVc DIr;
	record INVc INr;
	integer i,pos,comp;
	string 100 class,tmp;
	vector string 100 vcol;
	boolean TrHs,testf;
	
	BCr.Code="";
	while(LoopMain(BCr,1,true)) begin
		vcol[uppercase(BCr.Name)]=BCr.Code;
	end;	
	comp=stringtoint(webgetarg("CompNr"));
	SetCompany(comp,false);
	INr.Code="";
	while(LoopMain(INr,1,true)) begin
		If(nonblank(INr.DispGroups) And blank(INr.BPICollection)) then begin
			pos = 0;
			ExtractObj(INr.DispGroups,pos,class);
			while(nonblank(class)) begin
				DIr.Code = class;
				if(readfirstmain(DIr,1,true)) then begin 
					if(Dir.CType=="MODEL")then begin
							INr.BPICollection=vcol[DIr.Name & "S"];
							RecordStore(INr,true);
					end; 
				end;
				ExtractObj(INr.DispGroups,pos,class);
			end;
		end;
	end;	
	ResetLoop(INr);
	logtext(0,"finish Web trip");
return;
end;	


global updating procedure BPIBrandGroupMn(record RcVc RepSpec)
begin
	record INVc INr;
	record oldDIVc DIr;
	string 100 tmp,class;
	integer pos;
	boolean testf;
	longint curtick;
	
	curtick = getcurtick();
	if(nonblank(RepSpec.f1) And nonblank(RepSpec.f2)) then begin
		while(loopmain(INr,1,true))begin
			If(INr.Group==RepSpec.f2) then begin
				INr.BPIBrand=RepSpec.f1;
				pos = 0;
				tmp="";
				testf=true;
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class)) begin
					DIr.Code = class;
					if(readfirstmain(DIr,1,true)) then begin 
						if(Dir.CType=="BRAND")then begin
							testf=false;
							tmp=tmp & RepSpec.f1 & ",";
						end else begin 		
							tmp=tmp & class & ","; 
						end;
					end;					
					ExtractObj(INr.DispGroups,pos,class);
				end;
				left(tmp,Len(tmp)-1);
				INr.DispGroups=tmp;
				RecordStore(INr,true);
				if(testf) then begin
				  if(nonblank(tmp)) then begin
						tmp=tmp & ","&RepSpec.f1;
					end else begin 
							tmp=tmp  & RepSpec.f1;
					end;
					INr.DispGroups=tmp;
					RecordStore(INr,true);
				end;	
			end;	
		end;
	end;
	
	LogProcTime("BPIBrandGroupMn",getcurtick()-curtick); 
return;
end;



global updating procedure CCCollectionModelMn(record RcVc RepSpec)
begin
	record INVc INr;
	record OldDIVc DIr;
	string 100 tmp,class;
	integer pos;
	boolean testf;
	longint curtick;
	
	curtick = getcurtick();
	if(currentcompany==25)then begin
		ResetLoop(INr);
		INr.Code = "";
		while(loopmain(INr,1,true))begin
			pos = 0;
			ExtractObj(INr.OldDispGroups,pos,class);
			while(nonblank(class)) begin
				DIr.Code = class;
				if(readfirstmain(DIr,1,true)) then begin 
					if(Dir.CType=="BRAND")then begin
						INr.SN = DIr.Code;
						INr.MainDisp = DIr.Name;
					end;
					if(Dir.CType=="MODEL")then begin
						INr.SNOne = DIr.Name;
					end;
				end;					
				ExtractObj(INr.OldDispGroups,pos,class);
			end;
			RecordStore(INr,true);
		end;
		ResetLoop(INr);
	end;
	LogProcTime("CCCollectionModelMn",getcurtick()-curtick); 
return;
end;


webpublic global updating procedure WebGroupToBrand()
begin
record INVc INr;
integer i,pos;
string 20 group,obj;
string 255 class;
boolean testf;
logtext(0,"start");
for(i=1;i<29;i=i+1) begin
	if( i==3 or !CompanyIsJWLikeCompany(i))then begin
		setcompany(i,false);
		INr.Code = "";
		while(LoopMain(INr,1,true)) begin
			testf=false;
			/*if(INr.BPIBrand=="BRND0013") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0025"; testf=true; end;
			if(INr.BPIBrand=="BRND0010") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0030"; testf=true; end;
			if(INr.BPIBrand=="BRND0025") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0050"; testf=true; end;
			if(INr.BPIBrand=="BRND0035") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0033"; testf=true; end;
			if(INr.BPIBrand=="BRND0039") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0029"; testf=true; end;
			if(INr.BPIBrand=="BRND0046") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0049"; testf=true; end;
			if(INr.BPIBrand=="BRND0057") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0031"; testf=true; end;
			if(INr.BPIBrand=="BRND0066") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0027"; testf=true; end;
			if(INr.BPIBrand=="BRND0075") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0048"; testf=true; end;
			if(INr.BPIBrand=="BRND0221") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0013"; testf=true; end;
			if(INr.BPIBrand=="BRND0099") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0026"; testf=true; end;
			if(INr.BPIBrand=="BRND0107") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0044"; testf=true; end;
			if(INr.BPIBrand=="BRND0113") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0022"; testf=true; end;
			if(INr.BPIBrand=="BRND0114") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0035"; testf=true; end;
			if(INr.BPIBrand=="BRND0117") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0023"; testf=true; end;
			if(INr.BPIBrand=="BRND0129") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0036"; testf=true; end;
			if(INr.BPIBrand=="BRND0198") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0042"; testf=true; end;*/
			if(INr.BPIBrand=="BRND0138") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0051"; testf=true; end;
			/*if(INr.BPIBrand=="BRND0142") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0045"; testf=true; end;
			if(INr.BPIBrand=="BRND0152") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0037"; testf=true; end;
			if(INr.BPIBrand=="BRND0171") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0034"; testf=true; end;
			if(INr.BPIBrand=="BRND0172") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0032"; testf=true; end;
			if(INr.BPIBrand=="BRND0180") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0043"; testf=true; end;
			if(INr.BPIBrand=="BRND0187") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0047"; testf=true; end;
			if(INr.BPIBrand=="BRND0189") then begin group = INr.BPIGroup; INr.BPIGroup = "GROUP0028"; testf=true; end;*/
			if(testf) then begin
				if(setinset(group,INr.DispGroups)) then begin
					obj = "";
					pos = 0;
					class = "";
					ExtractObj(INr.DispGroups,pos,obj);
					while(nonblank(obj)) begin
						if(obj==group) then begin
							class = class & "," & INr.BPIGroup;
						end else begin
							class = class & "," & obj;
						end;
						ExtractObj(INr.DispGroups,pos,obj);
					end;	
					class = Right(class,len(class)-1);
					INr.DispGroups = class;
				end else begin
					if(nonblank(INr.DispGroups)) then begin
						INr.DispGroups = INr.BPIGroup;
					end else begin
						INr.DispGroups = INr.DispGroups & "," & INr.BPIGroup;
					end;
				end;
				RecordStore(INr,true);
			end;
		end;	
		ResetLoop(INr);
	end;
end;	
logtext(0,"end");
return;
end;	


global updating procedure POQtyResetMn(record RcVc RepSpec)
begin
	record ItemStatusVc ISr;
	record POVc POr;
	row POVc POrw;
	vector integer UnOkPOQty, POQty;
	boolean testf;
	integer i, mtrw;
	longint curtick;
	
	curtick = getcurtick();
	POr.SerNr = -1;
	while (loopmain(POr,1,true))begin
		testf = true;
		if(POr.TransDate<AddYear(CurrentDate,-1) and POr.OKFlag==0)then begin
			POr.Closed = 1;
			testf = false;
			if(RecordStore(POr,true))then begin
				//logtext(0,Chr(9) & POr.SerNr & Chr(9) & POr.TransDate & Chr(9) & "Closed by \"POQtyResetMn\"");
			end;
		end;
		if(testf)then begin
			mtrw = matrowcnt(POr);
			for (i=0;i<mtrw;i=i+1)begin
				matrowget(POr,i,POrw);
				UnOkPOQty[POrw.ArtCode & "_" & POr.Location] = UnOkPOQty[POrw.ArtCode & "_" & POr.Location] + (POrw.Quant - POrw.Shipd2);
				UnOkPOQty[POrw.ArtCode & "_" & ";;;"] = UnOkPOQty[POrw.ArtCode & "_" & ";;;"] + (POrw.Quant - POrw.Shipd2);
				if(POr.OKFlag==1)then begin
					POQty[POrw.ArtCode & "_" & POr.Location] = POQty[POrw.ArtCode & "_" & POr.Location] + (POrw.Quant - POrw.Shipd2);
					POQty[POrw.ArtCode & "_" & ";;;"] = POQty[POrw.ArtCode & "_" & ";;;"] + (POrw.Quant - POrw.Shipd2);
				end;
			end;
		end;
	end;
	resetloop(POr);
	ISr.Code = "";
	while (LoopMain(ISr,1,true)) begin
		ISr.POQty = 0;
		ISr.POUnOKQty = 0;
		if(POQty[ISr.Code & "_" & ISr.Location]>0)then begin
			ISr.POQty = POQty[ISr.Code & "_" & ISr.Location];
		end;
		if(UnOkPOQty[ISr.Code & "_" & ISr.Location]>0)then begin
			ISr.POUnOKQty = UnOkPOQty[ISr.Code & "_" & ISr.Location];
		end;
		if(RecordStore(ISr,true))then begin
			//logtext(0,Chr(9) & ISr.Code & Chr(9) & ISr.POQty & Chr(9) & ISr.POUnOKQty & Chr(9) & ISr.Location);
		end;
	end;
	ResetLoop(ISr);
	LogProcTime("POQtyResetMn",getcurtick()-curtick); 
return;
end;


global updating procedure OutOrderMn(record RcVc RepSpec)
begin
	record INVc INr;
	longint curtick;
	
	curtick = getcurtick();
	if(nonblank(RepSpec.f1)) then begin
		INr.Code = "";
		while(LoopMain(INr,1,true)) begin
			if(SetInSet(RepSpec.f1,INr.DispGroups)) then begin
				INr.OutOfOrder = 1;
				RecordStore(INr,true);
			end;
		end;
	end;
	LogProcTime("OutOrderMn",getcurtick()-curtick); 
return;
end;



global updating procedure DelECOrLocReserves()
begin
	record ORVc ORr, LocORr;
	record RLinkVc RLr; 
	boolean TrHs;
	integer notenr;
	ORr.OrdDate = AddDay(CurrentDate,-7);
	TrHs = true;
	while (LoopKey("OrdDate",ORr,1,TrHs))begin
		if(ORr.OrdDate>AddDay(CurrentDate,-2))then begin
			TrHs = false;
		end;
		if(TrHs and ORr.OrderConfirmed!=1)then begin
			notenr = 1;
			while (ReadRecordLink(ORr,notenr,LocORr,RLr))begin
				UnReservLinkedFromWebORVc(LocORr, true);
				notenr = notenr + 1;
			end;
		end;
	end;
return;
end;



global updating procedure DelECOrLocReservesMn(record RcVc RepSpec)
begin
longint curtick;

	curtick = getcurtick();
	DelECOrLocReserves;
	
	LogProcTime("DelECOrLocReservesMn",getcurtick()-curtick); 
return;
end;


global
updating function Boolean MakeECActFromSMRet(var record StockMovVc SMr,var record ActVc Actr)
begin
  Boolean res;
  record ActTypeGrVc ATGRr;
  record ActTypeVc ATr;
  record ASTBlock ASTRec;
  record UserVc USr;
  record CUVc CUr;
  Boolean savef;
  Integer curcomp;
	record ECommManUserBlock EUSTb;
	blockload(EUSTb);
	
  curcomp = CurrentCompany;
  BlockLoad(ASTRec);
  Actr.TransDate = SMr.TransDate;
  Actr.OKFlag = 0;
  Actr.SerNr = NextSerNr("ActVc",Actr.TransDate,-1,false,"");
  Actr.TodoFlag = 1;  
  Actr.StartTime = CurrentTime;
  Actr.ActType = ASTRec.GenSalesInv;
  if (PasteActTypeInAct("",Actr)) then begin
  end;
  Actr.Comment = "  \"" & SMr.FrLocation & "\"       \"" & SMr.ToLocation & "\".  " & SMr.SerNr & ".";
  Actr.MainPersons = EUSTb.UserStockSet;
	Actr.TodoFlag = 1;
	Actr.CalTimeFlag = kCalTimeFlagTime;
	Actr.AlarmType = 1;
	Actr.SymbNr = 3;
  savef = true;
LMakeActFromSubSys_IVVc:;
  if (savef) then begin 
    ATr.Code = Actr.ActType;
    if (ReadFirstMain(ATr,1,true)) then begin
      Actr.ItemCode = ATr.ItemCode;
    end;  
    if (RecordStore(Actr,false)) then begin
      CreateRecordLink(Actr,curcomp,SMr,curcomp);  
      CreateRecordLink(SMr,curcomp,Actr,curcomp);  
      res = true;
    end;
  end;  
  MakeECActFromSMRet = res;
  return;
end;





global updating procedure CreateStockMvFromRetStock()
begin
	record ItemStatusVc ISr;
	record ItemHistVc IHr;
	integer ItQt,i;
	boolean TrHs, TrHs2, testf, testf2;
	string 255 Location;
	vector integer vItQt;
	array string 255 ItCode, ItSrNr, aWarning;
	record StockMovVc StockMovr;
  row StockMovVc StockMovrw;
  row PUVc PUrw;
  Integer rwcnt,smrwcnt,j;
  record MainStockBlock MainRec;
  string 20 toposcode,lastpalletitem;
  record INVc INr;
  record LocationVc LocRec;
  Boolean storesmf, res;  
	record ActVc Actr;
	vector boolean StockMItf;
	
	logtext(0,"Arbeiten!!!");
	
	Location = "RETURN";
	
	if(currentcompany==29)then begin
		TrHs = true;
		ISr.Location = Location;
		while (loopkey("Location",ISr,1,TrHs)) begin
			testf = true;
			if(ISr.Location!=Location)then begin TrHs = false; testf = false; end;
			if(ISr.Instock<=0)then begin testf = false; end;
			if(testf)then begin
				IHr.FileName = "RetVc";
				IHr.ArtCode = ISr.Code;
				IHr.TransDate = addday(CurrentDate,-1);
				IHr.SerNr = "";
				TrHs2 = true;
				while (loopkey("FNArtCode",IHr,4,TrHs2)) begin
					testf2 = true;
					if(IHr.FileName!="RetVc")then begin TrHs2 = false; end;
					if(IHr.ArtCode!=ISr.Code)then begin TrHs2 = false; end;
					if(IHr.TransDate!=addday(CurrentDate,-1))then begin TrHs2 = false; end;
					if(IHr.Location!=Location)then begin testf2 = false; end;
					if(TrHs2 and testf2)then begin
						ItCode[ItQt] = IHr.ArtCode;
						ItSrNr[ItQt] = IHr.SerialNr;
						vItQt[ItSrNr[ItQt]] = IHr.Qty;
						ItQt = ItQt + 1;
					end;
				end;
				resetloop(IHr);
			end;
		end;
		
		rwcnt = ItQt;
		for (i=0;i<rwcnt;i=i+1) begin
			StockMItf[ItSrNr[i]] = true;
			IHr.FileName = "StockMovVc";
			IHr.ArtCode = ItCode[i];
			IHr.TransDate = addyear(CurrentDate,-2);
			IHr.SerNr = "";
			TrHs2 = true;
			while (loopkey("FNArtCode",IHr,4,TrHs2)) begin
				testf2 = true;
				if(IHr.FileName!="StockMovVc")then begin TrHs2 = false; end;
				if(IHr.ArtCode!=ItCode[i])then begin TrHs2 = false; end;
				if(IHr.TransDate<addyear(CurrentDate,-2))then begin TrHs2 = false; end;
				if(IHr.SerialNr!=ItSrNr[i])then begin testf2 = false; end;
				if(IHr.Location!=Location)then begin testf2 = false; end;
				if(TrHs2 and testf2)then begin
					StockMovr.SerNr = IHr.TransNr;
					if(ReadFirstMain(StockMovr,1,true))then begin
						if(StockMovr.FrLocation==Location and StockMovr.ToLocation=="MAIN")then begin
							StockMItf[ItSrNr[i]] = false;
						end;
					end;
				end;
			end;
			resetloop(IHr);
		end;
		
		
		
		
		if(ItQt>0)then begin
			RecordNew(StockMovr);  
			StockMovr.FrLocation = Location;
			StockMovr.ToLocation = "MAIN";
			StockMovr.TransDate = CurrentDate;
			StockMovr.SerNr = NextSerNr("StockMovVc",StockMovr.TransDate,-1,false,"");
			j = 0;
			rwcnt = ItQt;
			for (i=0;i<rwcnt;i=i+1) begin
				if(StockMItf[ItSrNr[i]])then begin
					StockMovrw.ArtCode = ItCode[i];
					matrowput(StockMovr,i-j,StockMovrw);
					StockMovVc_PasteArtCode(StockMovr,i,1,aWarning);
					matrowget(StockMovr,i-j,StockMovrw);
					matrowput(StockMovr,i-j,StockMovrw);
					StockMovrw.SerialNr = ItSrNr[i];
					matrowput(StockMovr,i-j,StockMovrw);
					StockMovVc_PasteSerialNr(StockMovr,i,aWarning);
					matrowget(StockMovr,i-j,StockMovrw);
					matrowput(StockMovr,i-j,StockMovrw);
					StockMovrw.Quant = vItQt[ItSrNr[i]];
					matrowput(StockMovr,i-j,StockMovrw);
					res = StockMovVc_PasteQuant(StockMovr,i);
					matrowget(StockMovr,i-j,StockMovrw);
					matrowput(StockMovr,i-j,StockMovrw);
				end else begin
					j = j + 1;
				end;
			end;
			
			if (RecordInsert(StockMovr,true)) then begin
				MakeECActFromSMRet(StockMovr,Actr);
			end;
		end;
	end;
return;
end;



global updating procedure CreateStockMvFromRetStockMn(record RcVc RepSpec)
begin
	longint curtick;
	
	curtick = getcurtick();
	CreateStockMvFromRetStock;
	
	LogProcTime("CreateStockMvFromRetStockMn",getcurtick()-curtick); 
return;
end;














global webpublic updating procedure WEBJWSAPMn()
begin
	record INVc INr;
	record OldDIVc DIr;
	string 100 tmp,class;
	integer pos;
	boolean testf;
	setcompany(3,false);
	ResetLoop(INr);
	INr.Code = "";
	while(loopmain(INr,1,true))begin
		pos = 0;
		ExtractObj(INr.OldDispGroups,pos,class);
		while(nonblank(class)) begin
			DIr.Code = class;
			if(readfirstmain(DIr,1,true)) then begin 
				if(Dir.CType=="SAP")then begin
					INr.SN = DIr.Name;
				end;
			end;					
			ExtractObj(INr.OldDispGroups,pos,class);
		end;
		RecordStore(INr,true);
	end;
	ResetLoop(INr);
	
return;
end;







global webpublic updating procedure offWEBBrandMn()
begin
	record INVc INr;
	record OldDIVc DIr;
	string 100 tmp,class;
	integer pos;
	boolean testf;
	setcompany(3,false);
		ResetLoop(INr);
		INr.Code = "";
		while(loopmain(INr,1,true))begin
			if(nonblank(INr.BPIBrand) and !SetInSet(INr.BPIBrand,INr.DispGroups))then begin
				INr.DispGroups = INr.DispGroups & "," & INr.BPIBrand;
				RecordStore(INr,true);
			end;
		end;
		ResetLoop(INr);
return;
end;











global webpublic updating procedure WEBBPIBrandFillJWMn()
begin
	record BPIBrandVc BBr;
	vector string 100 vgrp;
	record INVc INr;
	record ITVc ITr;
	integer i;
	boolean TrHs,testf;
	vector string 50 vBrandCode;

	while(loopmain(BBr,1,true))begin
		vBrandCode[BBr.Name] = BBr.Code;
	end;

	setcompany(3,false);
		INr.Code="";

		ResetLoop(INr);
		ITr.Code="";
		TrHs=true;
		while(LoopMain(ITr,1,TrHs)) begin
			vgrp[ITr.Code]=ITr.Comment;
		end;
		ResetLoop(ITr);
		INr.Code="";
		TrHs=true;
		while(LoopMain(INr,1,TrHs)) begin
			testf = false;
			If(nonblank(INr.Group) And blank(INr.BPIBrand)) then begin
				testf=true;
				
				If(INr.Group=="ANTON") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT"; end;
				If(INr.Group=="BOCHI") then begin vgrp[INr.Group]= "Bochic"; end;
				If(INr.Group=="CV") then begin vgrp[INr.Group]= "CHRONOVISION"; end;
				If(INr.Group=="DINH_") then begin vgrp[INr.Group]= "DINH VAN"; end;
				If(INr.Group=="GUCCI") then begin vgrp[INr.Group]= "GUCCI"; end;					
				
				If(vgrp[INr.Group]=="Somma kids bedlinen") then begin vgrp[INr.Group]= "SOMMA"; end;
				If(vgrp[INr.Group]=="GLASHUTTE") then begin vgrp[INr.Group]= "GLASHUTTE ORIGINAL"; end;
				If(vgrp[INr.Group]=="LEPEE") then begin vgrp[INr.Group]= "L'EPEE" ; end;
				If(vgrp[INr.Group]=="Carrera Carrera") then begin vgrp[INr.Group]= "CARRERA Y CARRERA" ; end;
				If(vgrp[INr.Group]=="Zancan Silver/Steel") then begin vgrp[INr.Group]= "Zancan" ; end;
				If(vgrp[INr.Group]=="LALIQUE PARFUME REGULAR") then begin vgrp[INr.Group]= "LALIQUE PARFUME" ; end;
				If(vgrp[INr.Group]=="Stephen Webster Silver") then begin vgrp[INr.Group]= "STEPHEN WEBSTER" ; end;
				If(vgrp[INr.Group]=="SHAUNLEANE") then begin vgrp[INr.Group]= "SHAUN LEANE" ; end;
				If(vgrp[INr.Group]=="SIA Home Fashion") then begin vgrp[INr.Group]= "SIA HOME" ; end;
				If(vgrp[INr.Group]=="ALEXANDRE TURPAULT()") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
				If(vgrp[INr.Group]=="ALEXANDRE TURPAULT()") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
				If(vgrp[INr.Group]=="ALEXANDRE TURPAULT()") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
				If(vgrp[INr.Group]=="Andrea-house") then begin vgrp[INr.Group]= "ANDREA HOUSE" ; end;
				If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANDREA HOUSE" ; end;
				If(vgrp[INr.Group]=="ANVERSA( )") then begin vgrp[INr.Group]= "ANVERSA" ; end;
				If(vgrp[INr.Group]=="Antonini") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
				If(vgrp[INr.Group]=="ALEXANDRE TURPAULT()") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT" ; end;
				If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
				If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
				If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
				If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
				If(vgrp[INr.Group]=="Apm ART DECO") then begin vgrp[INr.Group]= "APM MONACO" ; end;
				If(vgrp[INr.Group]=="Apm GRAPHITE") then begin vgrp[INr.Group]= "APM MONACO" ; end;
				If(vgrp[INr.Group]=="Apm LUMIERE") then begin vgrp[INr.Group]= "APM MONACO" ; end;
				If(vgrp[INr.Group]=="Apm XL") then begin vgrp[INr.Group]= "APM MONACO" ; end;
				If(vgrp[INr.Group]=="Aquanova (Terry)") then begin vgrp[INr.Group]= "AQUANOVA" ; end;
				If(vgrp[INr.Group]=="Aquanova (Accessories)") then begin vgrp[INr.Group]= "AQUANOVA" ; end;
				If(vgrp[INr.Group]=="BACCARAT BARWARE") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT BEAUTY") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT CUT STEMWARE") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT DECORATIVE ITEMS") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT DECORATIVE PIECES") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT DESK ITEMS") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT JEWELLERY") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT LIGHTS") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT LIMITED EDITIONS") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT PITCHER,JUGS,BOTTLES") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT REPLACEMENT STEMWARE") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BACCARAT TABLEWARE SUNDRIES") then begin vgrp[INr.Group]= "BACCARAT" ; end;
				If(vgrp[INr.Group]=="BEKA LOW COST") then begin vgrp[INr.Group]= "BEKA" ; end;
				If(vgrp[INr.Group]=="BERNARDAUD GIFT") then begin vgrp[INr.Group]= "BERNARDAUD" ; end;
				If(vgrp[INr.Group]=="BERNARDAUD PORCELAIN") then begin vgrp[INr.Group]= "BERNARDAUD" ; end;
				If(vgrp[INr.Group]=="BERNARDAUD JEWELLERY") then begin vgrp[INr.Group]= "BERNARDAUD" ; end;
				If(vgrp[INr.Group]=="Bodum for Coin") then begin vgrp[INr.Group]= "BODUM" ; end;
				If(vgrp[INr.Group]=="BOSS()") then begin vgrp[INr.Group]= "BOSS" ; end;
				If(vgrp[INr.Group]=="BOSS()") then begin vgrp[INr.Group]= "BOSS" ; end;
				If(vgrp[INr.Group]=="BRABANTIA KITCHEN") then begin vgrp[INr.Group]= "BRABANTIA" ; end;
				If(vgrp[INr.Group]=="BRABANTIA LOW COST") then begin vgrp[INr.Group]= "BRABANTIA" ; end;
				If(vgrp[INr.Group]=="Brabantiya") then begin vgrp[INr.Group]= "BRABANTIA" ; end;
				If(vgrp[INr.Group]=="Buckley Accessories") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
				If(vgrp[INr.Group]=="Buckley BOHO") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
				If(vgrp[INr.Group]=="Buckley Rock") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
				If(vgrp[INr.Group]=="Buckley romantic") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
				If(vgrp[INr.Group]=="Buckley Timeless") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
				If(vgrp[INr.Group]=="BUGATTI LUXURY") then begin vgrp[INr.Group]= "BUGATTI" ; end;
				If(vgrp[INr.Group]=="Calvin Klein ()") then begin vgrp[INr.Group]= "CALVIN KLEIN" ; end;
				If(vgrp[INr.Group]=="Calvin Klein ()") then begin vgrp[INr.Group]= "CALVIN KLEIN" ; end;
				If(vgrp[INr.Group]=="Calvin Klein ()") then begin vgrp[INr.Group]= "CALVIN KLEIN" ; end;
				If(vgrp[INr.Group]=="CHRISTOFLE ()") then begin vgrp[INr.Group]= "CHRISTOFLE" ; end;
				If(vgrp[INr.Group]=="CHRISTOFLE ()") then begin vgrp[INr.Group]= "CHRISTOFLE" ; end;
				If(vgrp[INr.Group]=="CHRISTOFLE ()") then begin vgrp[INr.Group]= "CHRISTOFLE" ; end;
				If(vgrp[INr.Group]=="CHRISTOFLE ()") then begin vgrp[INr.Group]= "CHRISTOFLE" ; end;
				If(vgrp[INr.Group]=="CINELLI (Duvets)") then begin vgrp[INr.Group]= "CINELLI" ; end;
				If(vgrp[INr.Group]=="CINELLI (Pillows)") then begin vgrp[INr.Group]= "CINELLI" ; end;
				If(vgrp[INr.Group]=="Cofur aht") then begin vgrp[INr.Group]= "COFUR" ; end;
				If(vgrp[INr.Group]=="Cogal Robe") then begin vgrp[INr.Group]= "COGAL" ; end;
				If(vgrp[INr.Group]=="DEKORATIEF  LOW COST") then begin vgrp[INr.Group]= "DEKORATIEF" ; end;
				If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
				If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
				If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
				If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
				If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
				If(vgrp[INr.Group]=="DIBBERN Porcelain") then begin vgrp[INr.Group]= "DIBBERN" ; end;
				If(vgrp[INr.Group]=="DONDI SVAD ( )") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="DONDI SVAD (  )") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="DONDI SVAD (  )") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="DONDI SVAD ()") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="DONDI SVAD ()") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="DONDI SVAD ()") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="DONDI SVAD (Specail offer)") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="Dupon") then begin vgrp[INr.Group]= "Dupont" ; end;
				If(vgrp[INr.Group]=="EDG Accessories") then begin vgrp[INr.Group]= "EDG" ; end;
				If(vgrp[INr.Group]=="EDG FLOWERS") then begin vgrp[INr.Group]= "EDG" ; end;
				If(vgrp[INr.Group]=="Egizia Promo") then begin vgrp[INr.Group]= "EGIZIA" ; end;
				If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER" ; end;
				If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER" ; end;
				If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER" ; end;
				If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER" ; end;
				If(vgrp[INr.Group]=="FFRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
				If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
				If(vgrp[INr.Group]=="FRETTE( )") then begin vgrp[INr.Group]= "FRETTE" ; end;
				If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
				If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
				If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
				If(vgrp[INr.Group]=="GLASHUTTE") then begin vgrp[INr.Group]= "GLASHUTTE ORIGINAL" ; end;
				If(vgrp[INr.Group]=="GREGGIO ARGENTO CORNICA") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO CESA ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO CESA CUTLERY") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO DOGALE ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO GREGGIO ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO GREGGIO CUTLERY") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO LOVELIES ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO MASSINI ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO OLRY ACCESSORIES") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO OLRY CUTLERY") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO ROYAL COLLECTION") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO SILVERPLATE") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="GREGGIO SILVERPLATE CUTLERY") then begin vgrp[INr.Group]= "GREGGIO" ; end;
				If(vgrp[INr.Group]=="HEREND()") then begin vgrp[INr.Group]= "HEREND" ; end;
				If(vgrp[INr.Group]=="HAVILAND TABLEWARE") then begin vgrp[INr.Group]= "HAVILAND" ; end;
				If(vgrp[INr.Group]=="GUZZINI FORME CASA") then begin vgrp[INr.Group]= "GUZZINI" ; end;
				If(vgrp[INr.Group]=="HEREND()") then begin vgrp[INr.Group]= "HEREND" ; end;
				If(vgrp[INr.Group]=="HEREND()") then begin vgrp[INr.Group]= "HEREND" ; end;
				If(vgrp[INr.Group]=="HERING ACCESSORIES") then begin vgrp[INr.Group]= "HEREND" ; end;
				If(vgrp[INr.Group]=="HERING GLASSES") then begin vgrp[INr.Group]= "HEREND" ; end;
				If(vgrp[INr.Group]=="HERING PORCELAIN") then begin vgrp[INr.Group]= "HEREND" ; end;
				If(vgrp[INr.Group]=="HOMMERS") then begin vgrp[INr.Group]= "HOMERS" ; end;
				If(vgrp[INr.Group]=="HOMMERS DS") then begin vgrp[INr.Group]= "HOMERS" ; end;
				If(vgrp[INr.Group]=="IVV EVERYDAY") then begin vgrp[INr.Group]= "IVV" ; end;
				If(vgrp[INr.Group]=="IVV Novelties ") then begin vgrp[INr.Group]= "IVV" ; end;
				If(vgrp[INr.Group]=="IVV POS") then begin vgrp[INr.Group]= "IVV" ; end;
				If(vgrp[INr.Group]=="IVV PROMO") then begin vgrp[INr.Group]= "IVV" ; end;
				If(vgrp[INr.Group]=="JAIMIES discounted") then begin vgrp[INr.Group]= "JAIMIES" ; end;
				If(vgrp[INr.Group]=="Jalla()") then begin vgrp[INr.Group]= "JALLA" ; end;
				If(vgrp[INr.Group]=="Jalla()") then begin vgrp[INr.Group]= "JALLA" ; end;
				If(vgrp[INr.Group]=="Jalla()") then begin vgrp[INr.Group]= "JALLA" ; end;
				If(vgrp[INr.Group]=="Jalla()") then begin vgrp[INr.Group]= "JALLA" ; end;
				If(vgrp[INr.Group]=="JARDIN SECRET()") then begin vgrp[INr.Group]= "JARDIN SECRET" ; end;
				If(vgrp[INr.Group]=="JARDIN SECRET()") then begin vgrp[INr.Group]= "JARDIN SECRET" ; end;
				If(vgrp[INr.Group]=="JUDITH RIPKA SILVER") then begin vgrp[INr.Group]= "JUDITH RIPKA" ; end;
				If(vgrp[INr.Group]=="Kaiser Gourmet") then begin vgrp[INr.Group]= "KAISER" ; end;
				If(vgrp[INr.Group]=="KARE Accessories") then begin vgrp[INr.Group]= "KARE" ; end;
				If(vgrp[INr.Group]=="KARE Furniture") then begin vgrp[INr.Group]= "KARE" ; end;
				If(vgrp[INr.Group]=="KARE Price Hero") then begin vgrp[INr.Group]= "KARE" ; end;
				If(vgrp[INr.Group]=="Kate International Down production") then begin vgrp[INr.Group]= "KATE INTERNATIONAL" ; end;
				If(vgrp[INr.Group]=="Kate International Textile") then begin vgrp[INr.Group]= "KATE INTERNATIONAL" ; end;
				If(vgrp[INr.Group]=="Katrine Leuze") then begin vgrp[INr.Group]= "KATRIN LEUZE" ; end;
				If(vgrp[INr.Group]=="Kauffman") then begin vgrp[INr.Group]= "KAUFFMANN" ; end;
				If(vgrp[INr.Group]=="kauffman Duvet") then begin vgrp[INr.Group]= "KAUFFMANN" ; end;
				If(vgrp[INr.Group]=="kauffman Pillow") then begin vgrp[INr.Group]= "KAUFFMANN" ; end;
				If(vgrp[INr.Group]=="LA JACUARD FRANCAIS") then begin vgrp[INr.Group]= "LE JACQUARD" ; end;
				If(vgrp[INr.Group]=="LALIQUE GENERAL") then begin vgrp[INr.Group]= "LALIQUE" ; end;
				If(vgrp[INr.Group]=="LALIQUE JEWELERY") then begin vgrp[INr.Group]= "LALIQUE" ; end;
				If(vgrp[INr.Group]=="LALIQUE PARFUME JAQUAR") then begin vgrp[INr.Group]= "LALIQUE PARFUME" ; end;
				If(vgrp[INr.Group]=="LALIQUE PARFUME REGULAR") then begin vgrp[INr.Group]= "LALIQUE PARFUME" ; end;
				If(vgrp[INr.Group]=="LALIQUE PARFUME CRYSTAL") then begin vgrp[INr.Group]= "LALIQUE PARFUME" ; end;
				If(vgrp[INr.Group]=="LE_CREUSET_CAST") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
				If(vgrp[INr.Group]=="LE_CREUSET_CERA") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
				If(vgrp[INr.Group]=="LE_CREUSET_KET") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
				If(vgrp[INr.Group]=="LE_CREUSET_MIL") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
				If(vgrp[INr.Group]=="LE_CREUSET_STON") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
				If(vgrp[INr.Group]=="LENOX ACCESSORIES") then begin vgrp[INr.Group]= "LENOX" ; end;
				If(vgrp[INr.Group]=="LENOX BUTTERFLY MEDOW") then begin vgrp[INr.Group]= "LENOX" ; end;
				If(vgrp[INr.Group]=="LENOX CRYSTAL") then begin vgrp[INr.Group]= "LENOX" ; end;
				If(vgrp[INr.Group]=="LENOX DISNEY") then begin vgrp[INr.Group]= "LENOX" ; end;
				If(vgrp[INr.Group]=="LENOX NEW YEAR") then begin vgrp[INr.Group]= "LENOX" ; end;
				If(vgrp[INr.Group]=="LENOX TABLEWARE") then begin vgrp[INr.Group]= "LENOX" ; end;
				If(vgrp[INr.Group]=="Louis De poortere") then begin vgrp[INr.Group]= "LOUIS DE POORTERE" ; end;
				If(vgrp[INr.Group]=="Luxenter EDURNE") then begin vgrp[INr.Group]= "LUXENTER" ; end;
				If(vgrp[INr.Group]=="Luxenter HAPPY GEMS") then begin vgrp[INr.Group]= "LUXENTER" ; end;
				If(vgrp[INr.Group]=="Luxenter MOMENTS") then begin vgrp[INr.Group]= "LUXENTER" ; end;
				If(vgrp[INr.Group]=="Luxenter SILVER") then begin vgrp[INr.Group]= "LUXENTER" ; end;
				If(vgrp[INr.Group]=="MILLEFIORI  MILLEFIORI") then begin vgrp[INr.Group]= "MILLEFIORI" ; end;
				If(vgrp[INr.Group]=="Misaki CULTURED GOLD") then begin vgrp[INr.Group]= "MISAKI" ; end;
				If(vgrp[INr.Group]=="Misaki CULTURED RHODIUM") then begin vgrp[INr.Group]= "MISAKI" ; end;
				If(vgrp[INr.Group]=="Misaki CULTURED ROSE GOLD") then begin vgrp[INr.Group]= "MISAKI" ; end;
				If(vgrp[INr.Group]=="Misaki HAND MADE GLASS PEARLS GOLD") then begin vgrp[INr.Group]= "MISAKI" ; end;
				If(vgrp[INr.Group]=="Misaki HAND MADE GLASS PEARLS RHODIUM") then begin vgrp[INr.Group]= "MISAKI" ; end;
				If(vgrp[INr.Group]=="Misaki HAND MADE GLASS PEARLS ROSE GOLD") then begin vgrp[INr.Group]= "MISAKI" ; end;
				If(vgrp[INr.Group]=="Misaki HAND MADE GLASS PEARLS STEEL") then begin vgrp[INr.Group]= "MISAKI" ; end;
				If(vgrp[INr.Group]=="MOSER ARMUDU") then begin vgrp[INr.Group]= "MOSER" ; end;
				If(vgrp[INr.Group]=="MOSER BAKU") then begin vgrp[INr.Group]= "MOSER" ; end;
				If(vgrp[INr.Group]=="MOSER CRYSTAL SETS") then begin vgrp[INr.Group]= "MOSER" ; end;
				If(vgrp[INr.Group]=="MOSER VASES&ACCESSORIES") then begin vgrp[INr.Group]= "MOSER" ; end;
				If(vgrp[INr.Group]=="NINA RICCI()") then begin vgrp[INr.Group]= "NINA RICCI" ; end;
				If(vgrp[INr.Group]=="NINA RICCI()") then begin vgrp[INr.Group]= "NINA RICCI" ; end;
				If(vgrp[INr.Group]=="PLAUENER ()") then begin vgrp[INr.Group]= "PLAUENER" ; end;
				If(vgrp[INr.Group]=="PLAUENER ()") then begin vgrp[INr.Group]= "PLAUENER" ; end;
				If(vgrp[INr.Group]=="PLAUENER ()") then begin vgrp[INr.Group]= "PLAUENER" ; end;
				If(vgrp[INr.Group]=="RALPH LAUIREN HOME()") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
				If(vgrp[INr.Group]=="RALPH LAUREN HOME()") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
				If(vgrp[INr.Group]=="RALPH LAUREN HOME()") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
				If(vgrp[INr.Group]=="RALPH LAUREN HOME( )") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
				If(vgrp[INr.Group]=="Raulph Lauren ") then begin vgrp[INr.Group]= "RALPH LAUREN HOME" ; end;
				If(vgrp[INr.Group]=="ROBB&BERKING ACCESSORIES") then begin vgrp[INr.Group]= "ROBBE BERKING" ; end;
				If(vgrp[INr.Group]=="ROBB&BERKING CUTLERY") then begin vgrp[INr.Group]= "ROBBE BERKING" ; end;
				If(vgrp[INr.Group]=="Rosenthal ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
				If(vgrp[INr.Group]=="Rosenthal ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
				If(vgrp[INr.Group]=="Rosenthal Studio-Line ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
				If(vgrp[INr.Group]=="Rosenthal Studio-Line ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
				If(vgrp[INr.Group]=="Rosenthal Studio-Line ()") then begin vgrp[INr.Group]= "ROSENTHAL" ; end;
				If(vgrp[INr.Group]=="Sambonet Kids ") then begin vgrp[INr.Group]= "SAMBONET" ; end;
				If(vgrp[INr.Group]=="Sambonet promo") then begin vgrp[INr.Group]= "SAMBONET" ; end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
				If(vgrp[INr.Group]=="Schlossberg (classic)") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
				If(vgrp[INr.Group]=="Schlossberg (Special Offer)") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
				If(vgrp[INr.Group]=="SCHOTT ZWIESEL POS") then begin vgrp[INr.Group]= "SCHOTT ZWIESEL" ; end;
				If(vgrp[INr.Group]=="SCHOTT ZWIESEL PROMO") then begin vgrp[INr.Group]= "SCHOTT ZWIESEL" ; end;
				If(vgrp[INr.Group]=="Schott Zwiesl Promo") then begin vgrp[INr.Group]= "SCHOTT ZWIESEL" ; end;
				If(vgrp[INr.Group]=="SIA HOME FASHION") then begin vgrp[INr.Group]= "SIA HOME" ; end;
				If(vgrp[INr.Group]=="SIA Home Fashion") then begin vgrp[INr.Group]= "SIA HOME" ; end;
				If(vgrp[INr.Group]=="Somma throws") then begin vgrp[INr.Group]= "SOMMA" ; end;
				If(vgrp[INr.Group]=="Stephen Webster Silver") then begin vgrp[INr.Group]= "STEPHEN WEBSTER" ; end;
				If(vgrp[INr.Group]=="Svad Dondi Bedcovers") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="Svad Dondi Textile") then begin vgrp[INr.Group]= "SVAD DONDI" ; end;
				If(vgrp[INr.Group]=="Thomas Sabo Charm Club") then begin vgrp[INr.Group]= "THOMAS SABO" ; end;
				If(vgrp[INr.Group]=="Thomas Sabo Sterling Silver") then begin vgrp[INr.Group]= "THOMAS SABO" ; end;
				If(vgrp[INr.Group]=="TOMMY HILFIGER()") then begin vgrp[INr.Group]= "TOMMY HILFIGER" ; end;
				If(vgrp[INr.Group]=="TOMMY HILFIGER()") then begin vgrp[INr.Group]= "TOMMY HILFIGER" ; end;
				If(vgrp[INr.Group]=="TVS LOW COST") then begin vgrp[INr.Group]= "TVS" ; end;
				If(vgrp[INr.Group]=="VAN_REMORT") then begin vgrp[INr.Group]= "VAN REMORTEL" ; end;
				If(vgrp[INr.Group]=="Versace ()") then begin vgrp[INr.Group]= "VERSACE" ; end;
				If(vgrp[INr.Group]=="Versace ()") then begin vgrp[INr.Group]= "VERSACE" ; end;
				If(vgrp[INr.Group]=="Versace ()") then begin vgrp[INr.Group]= "VERSACE" ; end;
				If(vgrp[INr.Group]=="Versace ()") then begin vgrp[INr.Group]= "VERSACE" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Accessories") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Christmas") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Classic") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Country") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Cutlery") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Home Decor") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Kids") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Metropolitan") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="VILLEROY & BOCH Stemware") then begin vgrp[INr.Group]= "VILLEROY & BOCH" ; end;
				If(vgrp[INr.Group]=="WEDGWOOD GIFTS&ACCESSORIES") then begin vgrp[INr.Group]= "WEDGWOOD" ; end;
				If(vgrp[INr.Group]=="WEISSFEE GUESTBOOK ") then begin vgrp[INr.Group]= "WEDGWOOD" ; end;
				If(vgrp[INr.Group]=="Weissfee bedlinen") then begin vgrp[INr.Group]= "WEISSFEE " ; end;
				If(vgrp[INr.Group]=="WEISSFEE NAPKIN") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
				If(vgrp[INr.Group]=="WEISSFEE PLACEMAT") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
				If(vgrp[INr.Group]=="WEISSFEE TABLECENTER") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
				If(vgrp[INr.Group]=="WEISSFEE TABLECLOTH") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
				If(vgrp[INr.Group]=="Weissfee terry") then begin vgrp[INr.Group]= "WEISSFEE" ; end;
				If(vgrp[INr.Group]=="WMF Accessories") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Bistro") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Black Line") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF COFFEE MACHINES") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Consumer electrics") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Cookware") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Cutlery") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Frying pans") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF HOTEL") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Kettles") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Kids") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Knives") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Pressure cookers") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Profi") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="WMF Tea pots") then begin vgrp[INr.Group]= "WMF" ; end;
				If(vgrp[INr.Group]=="y.Delorme ") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="YANKEE CANDLE  CLASSIC COLLECTION") then begin vgrp[INr.Group]= "YANKEE CANDLE" ; end;
				If(vgrp[INr.Group]=="YANKEE CANDLE ACCESSORIES") then begin vgrp[INr.Group]= "YANKEE CANDLE" ; end;
				If(vgrp[INr.Group]=="YANKEE CANDLE POS") then begin vgrp[INr.Group]= "YANKEE CANDLE" ; end;
				If(vgrp[INr.Group]=="Yves Delorme ( Laurence Tavernier )") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="YVES DELORME (.  )") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="YVES DELORME ()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="YVES DELORME()") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="Zancan Silver/Steel") then begin vgrp[INr.Group]= "Zancan" ; end;
				If(vgrp[INr.Group]=="LE_CREUSET_CAST ") then begin vgrp[INr.Group]= "LE CREUSET" ; end;
				If(vgrp[INr.Group]=="Louis De poortere") then begin vgrp[INr.Group]= "LOUIS DE POORTERE" ; end;
				If(vgrp[INr.Group]=="EDG FLOWERS ") then begin vgrp[INr.Group]= "EDG" ; end;
				If(vgrp[INr.Group]=="CoinCasa") then begin vgrp[INr.Group]= "COIN CASA" ; end;
				If(vgrp[INr.Group]=="NACHTMANN FOR COIN") then begin vgrp[INr.Group]= "NACHTMANN" ; end;
				If(vgrp[INr.Group]=="EDG Accessories") then begin vgrp[INr.Group]= "EDG" ; end;
				If(vgrp[INr.Group]=="Bodum for Coin ") then begin vgrp[INr.Group]= "BODUM" ; end;
				If(vgrp[INr.Group]=="CINELLI (Duvets)  ") then begin vgrp[INr.Group]= "CINELLI" ; end;
				If(vgrp[INr.Group]=="CINELLI (Pillows)  ") then begin vgrp[INr.Group]= "CINELLI" ; end;
				If(vgrp[INr.Group]=="Cogal Towel") then begin vgrp[INr.Group]= "COGAL" ; end;
				If(vgrp[INr.Group]=="EDG FLOWERS") then begin vgrp[INr.Group]= "EDG " ; end;
				If(vgrp[INr.Group]=="EDG Accessories") then begin vgrp[INr.Group]= "EDG " ; end;
				If(vgrp[INr.Group]=="Kaiser Gourmet ") then begin vgrp[INr.Group]= "KAISER" ; end;
				If(vgrp[INr.Group]=="Buckley Timeless") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
				If(vgrp[INr.Group]=="Buckley BOHO") then begin vgrp[INr.Group]= "BUCKLEY LONDON" ; end;
				If(vgrp[INr.Group]=="Aquanova (Terry)") then begin vgrp[INr.Group]= "AQUANOVA" ; end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG" ; end;
				If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ; end;
				If(vgrp[INr.Group]=="Cofur aht") then begin vgrp[INr.Group]= "COFUR " ; end;
				If(vgrp[INr.Group]=="DEKORATIEF  LOW COST") then begin vgrp[INr.Group]= "DEKORATIEF  " ; end;
				If(vgrp[INr.Group]=="Buckley Timeless") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ; end;
				If(vgrp[INr.Group]=="Buckley Rock") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ; end;
				If(vgrp[INr.Group]=="Buckley BOHO") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ; end;
				If(vgrp[INr.Group]=="Buckley Accessories") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ; end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ; end;
				If(vgrp[INr.Group]=="DESCAMPS()") then begin vgrp[INr.Group]= "DESCAMPS" ; end;
				If(vgrp[INr.Group]=="ALEXANDRE TURPAULT() ") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT " ; end;
				If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER " ; end;
				If(vgrp[INr.Group]=="Aquanova (Terry) ") then begin vgrp[INr.Group]= "AQUANOVA" ; end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ; end;
				If(vgrp[INr.Group]=="ALEXANDRE TURPAULT() ") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT " ; end;
				If(vgrp[INr.Group]=="Yves Delorme ( Laurence Tavernier )  ") then begin vgrp[INr.Group]= "YVES DELORME" ; end;
				If(vgrp[INr.Group]=="FRETTE()") then begin vgrp[INr.Group]= "FRETTE" ; end;
				If(vgrp[INr.Group]=="Somma throws") then begin vgrp[INr.Group]= "SOMMA " ; end;
				If(vgrp[INr.Group]=="WEDGWOOD TABLEWARE") then begin vgrp[INr.Group]= "WEDGWOOD" ; end;
				If(vgrp[INr.Group]=="ALEXANDRE TURPAULT() ") then begin vgrp[INr.Group]= "ALEXANDRE TURPAULT " ;  end;
				If(vgrp[INr.Group]=="HERING PORCELAIN") then begin vgrp[INr.Group]= "HERING" ;  end;
				If(vgrp[INr.Group]=="BACCARAT TABLEWARE") then begin vgrp[INr.Group]= "BACCARAT" ;  end;
				If(vgrp[INr.Group]=="WEISSFEE GUESTBOOK") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
				If(vgrp[INr.Group]=="WEISSFEE NAPKIN ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
				If(vgrp[INr.Group]=="Rosenthal ()") then begin vgrp[INr.Group]= "ROSENTHAL" ;  end;
				If(vgrp[INr.Group]=="Andrea-house ") then begin vgrp[INr.Group]= "ANDREA HOUSE" ;  end;
				If(vgrp[INr.Group]=="SIA Home Fashion ") then begin vgrp[INr.Group]= "SIA HOME" ;  end;
				If(vgrp[INr.Group]=="WEISSFEE NAPKIN ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
			
			
				If(vgrp[INr.Group]=="ALESSI POS") then begin vgrp[INr.Group]= "ALESSI" ;  end;
				If(vgrp[INr.Group]=="ANVERSA()") then begin vgrp[INr.Group]= "ANVERSA" ;  end;
				If(vgrp[INr.Group]=="Buckley romantic") then begin vgrp[INr.Group]= "BUCKLEY LONDON " ;  end;
				If(vgrp[INr.Group]=="BUGATTI LUXURY") then begin vgrp[INr.Group]= "BUGATTI " ;  end;
				If(vgrp[INr.Group]=="ChronoVision Movers") then begin vgrp[INr.Group]= "CHRONOVISION" ;  end;
				If(vgrp[INr.Group]=="Classic Porcelain") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="CRISTOFLE JEWELLERY") then begin vgrp[INr.Group]= "CHRISTOFLE" ;  end;
				If(vgrp[INr.Group]=="DAUM PRESTIGE") then begin vgrp[INr.Group]= "DAUM" ;  end;
				If(vgrp[INr.Group]=="Dinh Van ") then begin vgrp[INr.Group]= "DINH VAN" ;  end;
				If(vgrp[INr.Group]=="Fischbacher ()") then begin vgrp[INr.Group]= "CHRISTIAN FISCHBACHER " ;  end;
				If(vgrp[INr.Group]=="GREGGIO CUSTOMIZED") then begin vgrp[INr.Group]= "GREGGIO" ;  end;
				If(vgrp[INr.Group]=="Gres") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="HELIO") then begin vgrp[INr.Group]= "HELIOS" ;  end;
				If(vgrp[INr.Group]=="HERING ACCESSORIES") then begin vgrp[INr.Group]= "HERING" ;  end;
				If(vgrp[INr.Group]=="HERING GLASSES") then begin vgrp[INr.Group]= "HERING" ;  end;
				If(vgrp[INr.Group]=="High Porcelain") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="Hulchi Belluni ") then begin vgrp[INr.Group]= "HULCHI BELLUNI" ;  end;
				If(vgrp[INr.Group]=="LE_CREUSET_MIL ") then begin vgrp[INr.Group]= "LE CREUSET" ;  end;
				If(vgrp[INr.Group]=="Lighting") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="Light&Living*3") then begin vgrp[INr.Group]= "LIGHT&LIVING" ;  end;
				If(vgrp[INr.Group]=="Louis De poortere  ") then begin vgrp[INr.Group]= "LOUIS DE POORTERE" ;  end;
				If(vgrp[INr.Group]=="Luxenter EDURNE") then begin vgrp[INr.Group]= "LUXENTER " ;  end;
				If(vgrp[INr.Group]=="Matt Porcelain") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="Naturo Fantastic") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="Others") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="ReDeco") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
				If(vgrp[INr.Group]=="Schlossberg ()") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
				If(vgrp[INr.Group]=="Schlossberg (classic)") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
				If(vgrp[INr.Group]=="Schlossberg (Special Offer)") then begin vgrp[INr.Group]= "SCHLOSSBERG " ;  end;
				If(vgrp[INr.Group]=="SIA_High") then begin vgrp[INr.Group]= "SIA HOME" ;  end;
				If(vgrp[INr.Group]=="Table Lamp") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="Tag Heuer") then begin vgrp[INr.Group]= "TAG HEUER " ;  end;
				If(vgrp[INr.Group]=="The Fifth Season") then begin vgrp[INr.Group]= "ROBERTO COIN" ;  end;
				If(vgrp[INr.Group]=="WEISSFEE GUESTBOOK ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
				If(vgrp[INr.Group]=="WEISSFEE NAPKIN ") then begin vgrp[INr.Group]= "WEISSFEE " ;  end;
				If(vgrp[INr.Group]=="WEISSFEE NAPKINS") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
				If(vgrp[INr.Group]=="WEISSFEE PLACEMAT ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
				If(vgrp[INr.Group]=="WEISSFEE RUNNER ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
				If(vgrp[INr.Group]=="WEISSFEE TABLECENTER ") then begin vgrp[INr.Group]= "WEISSFEE" ;  end;
				If(vgrp[INr.Group]=="Weissfee terry") then begin vgrp[INr.Group]= "WEISSFEE " ;  end;
				If(vgrp[INr.Group]=="Zancan Watches ") then begin vgrp[INr.Group]= "Zancan" ;  end;
				If(vgrp[INr.Group]=="Consignment (  )") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="De Bethune CHF") then begin vgrp[INr.Group]= "DAUM" ;  end;
				If(vgrp[INr.Group]=="Cento") then begin vgrp[INr.Group]= "ROBERTO COIN" ;  end;
				If(vgrp[INr.Group]=="DUPON") then begin vgrp[INr.Group]= "Dupont" ;  end;
				If(vgrp[INr.Group]=="Morellato") then begin vgrp[INr.Group]= "JUST CAVALLI" ;  end;
				If(vgrp[INr.Group]=="ANDREA_ACC") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="Andrea Accessories") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="ANDREA_EKS") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="ANDREA_FU") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="Andrea-house ") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="Andrea-K") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="Andrea-K-Accessories") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="Andrea-K-Ekspo                            ") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="Andrea-K-Furniture") then begin vgrp[INr.Group]= "KARE" ;  end;
				If(vgrp[INr.Group]=="Consignment (  )") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="SOHER") then begin vgrp[INr.Group]= "LLADRO" ;  end;
				If(vgrp[INr.Group]=="Sambonet") then begin vgrp[INr.Group]= "Paderno" ;  end;
				If(vgrp[INr.Group]=="PADERNO") then begin vgrp[INr.Group]= "SAMBONET" ;  end;
				If(vgrp[INr.Group]=="Morellato") then begin vgrp[INr.Group]= "MASERATI" ;  end;
				If(vgrp[INr.Group]=="KOSTA BODA") then begin vgrp[INr.Group]= "ORREFORS" ;  end;
				If(vgrp[INr.Group]=="Morellato") then begin vgrp[INr.Group]= "TRUSSARDI" ;  end;
				
				If(vgrp[INr.Group]=="JUDITHRIPKA") then begin vgrp[INr.Group]= "JUDITH RIPKA";  end;
				If(vgrp[INr.Group]=="LALIQUE HOME") then begin vgrp[INr.Group]= "LALIQUE";  end;
				If(vgrp[INr.Group]=="") then begin vgrp[INr.Group]= "";  end;
				If(vgrp[INr.Group]=="") then begin vgrp[INr.Group]= "";  end;
				If(vgrp[INr.Group]=="") then begin vgrp[INr.Group]= "";  end;
				If(vgrp[INr.Group]=="") then begin vgrp[INr.Group]= "";  end;
				If(vgrp[INr.Group]=="") then begin vgrp[INr.Group]= "";  end;
				If(vgrp[INr.Group]=="") then begin vgrp[INr.Group]= "";  end;
				If(vgrp[INr.Group]=="") then begin vgrp[INr.Group]= "";  end;
				If(vgrp[INr.Group]=="") then begin vgrp[INr.Group]= "";  end;
			
				if(testf) then begin
					if(nonblank(vBrandCode[vgrp[INr.Group]]))then begin
						INr.BPIBrand=vBrandCode[vgrp[INr.Group]];//BBr.Code;
						recordStore(INr,true);
					end else begin
						logtext(0,INr.Code & " NotFound Brand| " & vgrp[INr.Group] & " <- " & INr.Group);
					end;
					//end;	
				end;
			end;
		end;	
		logtext(0,"Finish WEBBPIBrandFillMn");
return;
end;




global webpublic updating procedure offWEBBPISubGroupFillJWMn()
begin
	record BPISubGroupVc BSGr;
	vector string 100 vtp;
	record INVc INr;
	record OldDIVc DIr;
	integer i;
	boolean TrHs,testf;
	vector string 50 vSPGRPCode;
	
	BSGr.Code = "";
	while(loopmain(BSGr,1,true))begin
		vSPGRPCode[BSGr.Name] = BSGr.Code;
	end;

	setcompany(3,false);
	INr.Code="";

	ResetLoop(INr);
	DIr.Code="";
	TrHs=true;
	while(LoopMain(DIr,1,TrHs)) begin
		if(Dir.CType=="TYPE")then begin
			vtp[DIr.Code]=DIr.Name;
		end;
	end;
	ResetLoop(DIr);
	INr.Code="";
	TrHs=true;
	while(LoopMain(INr,1,TrHs)) begin
		testf = false;
		if(nonblank(INr.MainDisp) And blank(INr.BPISubGroup)) then begin
			testf=true;
			If(vtp[INr.MainDisp]=="Jewellery") then begin vtp[INr.MainDisp]= "Jewelry"; end;
			If(vtp[INr.MainDisp]=="Watch") then begin vtp[INr.MainDisp]= "Watches"; end;
			If(vtp[INr.MainDisp]=="POSM") then begin vtp[INr.MainDisp]= "POS"; end;
			If(vtp[INr.MainDisp]=="") then begin vtp[INr.MainDisp]= ""; end;
			If(vtp[INr.MainDisp]=="") then begin vtp[INr.MainDisp]= ""; end;
			If(vtp[INr.MainDisp]=="") then begin vtp[INr.MainDisp]= ""; end;
			
			
			
			
			if(testf) then begin
				if(nonblank(vSPGRPCode[vtp[INr.MainDisp]]))then begin
					INr.BPISubGroup=vSPGRPCode[vtp[INr.MainDisp]];
					if(!setinset(INr.BPISubGroup,INr.DispGroups))then begin INr.DispGroups = INr.DispGroups & "," & INr.BPISubGroup; end;
					recordStore(INr,true);
				end else begin
					logtext(0,INr.Code & " NotFound SubGroup| " & vtp[INr.MainDisp] & " <- " & INr.MainDisp);
				end;
			end;
		end;
	end;	
	logtext(0,"Finish WEBBPISubGroupFillJWMn");
return;
end;


global webpublic updating procedure offWEB31FillJWMn()
begin
	record BPISubGroupVc BSGr;
	vector string 100 vtp;
	record INVc INr;
	record OldDIVc DIr;
	integer i;
	boolean TrHs,testf,foundf;
	vector string 50 vSPGRPCode;
	string 100 tstr;
	
	BSGr.Code = "";
	while(loopmain(BSGr,1,true))begin
		vSPGRPCode[BSGr.Name] = BSGr.Code;
	end;

	setcompany(3,false);
	INr.Code="";

	ResetLoop(INr);
	DIr.Code="";
	TrHs=true;

	ResetLoop(DIr);
	INr.Code="";
	TrHs=true;
	while(LoopMain(INr,1,TrHs)) begin
		testf = false;
		
		tstr = "";
		foundf = true;
		if(setinset("30",INr.OldDispGroups))then begin foundf = false; tstr = tstr & ",30"; end;
		if(setinset("31",INr.OldDispGroups))then begin foundf = false; tstr = tstr & ",31"; end;
		if(setinset("32",INr.OldDispGroups))then begin foundf = false; tstr = tstr & ",32"; end;
		if(setinset("33",INr.OldDispGroups))then begin foundf = false; tstr = tstr & ",33"; end;
		if(setinset("34",INr.OldDispGroups))then begin foundf = false; tstr = tstr & ",34"; end;
		if(setinset("35",INr.OldDispGroups))then begin foundf = false; tstr = tstr & ",35"; end;
		
		if(!foundf)then begin
			if(left(tstr,1)==",")then begin
				tstr = right(tstr,len(tstr)-1);
				INr.DispGroups = INr.DispGroups & "," & tstr;
				recordstore(INr,true);
				// Logtext(0,INr.Code & " -> " & INr.DispGroups);
				
			end;
		end;
		
		
	end;	
	logtext(0,"Finish WEBBPISubGroupFillJWMn");
return;
end;

global webpublic updating procedure offWEBChangeBrandsMn()
begin
	record BPISubGroupVc BSGr;
	vector string 100 vtp;
	record INVc INr;
	record OldDIVc DIr;
	integer i,pos;
	boolean TrHs,testf,foundf;
	vector string 50 vSPGRPCode;
	string 100 tstr,tempstr,newdisps;
	
	BSGr.Code = "";
	while(loopmain(BSGr,1,true))begin
		vSPGRPCode[BSGr.Name] = BSGr.Code;
	end;
	
	for(i=1;i<28;i=i+1)begin
		setcompany(i,false);

		INr.Code="";
		TrHs=true;
		while(LoopMain(INr,1,TrHs)) begin
			testf = false;
		
		
			if(INr.BPIBrand=="BRND0159")then begin
				INr.BPIBrand = "BRND0158";
				if(setinset("BRND0159",INr.DispGroups))then begin
					pos = 0;
  			  newdisps = "";
          ExtractObj(INr.DispGroups,pos,tempstr);
          while (nonblank(tempstr)) begin
							if (tempstr=="BRND0159") then begin
								newdisps = tempstr & "," "BRND0158";
							end else begin
								newdisps = newdisps & "," & tempstr;
							end;
						ExtractObj(INr.DispGroups,pos,tempstr);
					end;
					INr.DispGroups = newdisps;
				end;
				if(left(INr.DispGroups,1)==",")then begin
					INr.DispGroups = right(INr.DispGroups,len(INr.DispGroups)-1);
				end;
				// logtext(0,currentcompany & " - " & INr.Code & " -> " & INr.DispGroups);
				recordstore(INr,true);
			end;
		end;	
		resetloop(INr);
	end;
	
	logtext(0,"Finish WEBBPISubGroupFillJWMn");
return;
end;


global webpublic updating procedure WEBShowBPIBrandsMn()
begin
	record BPIBrandVc BBr;
	record CUVc CUr;
	
	while(loopmain(BBr,1,true))begin
		CUr.Name = BBr.Name;
		if(readfirstkey("Name",CUr,1,true)==false)then begin
			logtext(0,BBr.Code & " - " & BBr.Name);
		end;
	end;
	
	
	
return;
end;

/*global procedure SendLogAction(Integer x1,Integer x2,Integer x3,string x4,string x5)
begin
	
	logtext(0,"SendLogAction");
	
return;
end;

global procedure SendLogAction4(Integer x1,Integer x2 ,Integer x3,string x4 ,string x5)
begin
	
	logtext(0,"SendLogAction4");
	
return;
end;*/


global updating procedure ImpOldContIn()
begin
	record CUVc CUr;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,color,size;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield0 = ImportField;
		if(nonblank(sfield0))then begin
			FormatUpperCaseCode(sfield0);
			sfield1 = ImportField;
			sfield2 = ImportField;
			sfield3 = ImportField;
			sfield4 = ImportField;
			CUr.Code = sfield0;
			if(!ReadFirstMain(CUr,1,true))then begin
				RecordNew(CUr);
				CUr.Code = sfield0;
				CUr.Name = sfield1;
				CUr.Phone = sfield2;
				CUr.DelAddr0 = sfield3;
				CUr.CustCat = "NONAM";
				CUr.Classification = "IDNONAME,SW1";
				CUr.CUType = 1;
				CUr.PLCode = "RRP";
				CUr.RebCode = "0%";
				CUr.SalesMan = "SA";
				CUr.VATCode = "0%";
				CUr.OnAccAccAP = "63";
				CUr.CreateLocation = "SA";
				CUr.DateCreated = CurrentDate;
				CUr.blockedFlag = 1;
				CUr.RemndrFlag = 1;
				CUr.InterestFlag = 1;
				CUr.OnAccount = 1;
				CUr.IDOldCUCode = sfield0;
				RecordStore(CUr,True);
			end;
		end;
		NextImportLine(true);
	end;
	return;
end;

global webpublic procedure WebBlankrow() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger10:31 21.08.2018
begin
  record GlobalItemVc GIr;
	row GlobalItemVc GIrw;
	GIr.Code = "";
	SetCompany(1,false);
	logtext(0,"Start");
	while(LoopMain(GIr,1,true)) begin
		if(MatRowCnt(GIr)>0) then begin
			matrowget(GIr,0,GIrw);
			if(blank(GIrw.Location)) then begin
			end;	
		end;
	end;
	logtext(0,"end");
return;
end;

global webpublic updating procedure WebFillBlankrow() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger10:31 21.08.2018
begin
  record GlobalItemVc GIr,LogGIr;
	row GlobalItemVc GIrw;
	integer i;
	
	GIr.Code = "";
	SetCompany(1,false);
	logtext(0,"Start");
	while(LoopMain(GIr,1,true)) begin
		recordcopy(LogGIr,GIr);
		if(MatRowCnt(GIr)>0) then begin
			matrowget(GIr,0,GIrw);
			if(blank(GIrw.Location)) then begin
				for(i=MatRowCnt(GIr)-1;i>-1;i=i-1) begin
					matrowget(GIr,i,GIrw);
					if(blank(GIrw.Location)) then begin
						matrowdelete(GIr,i);
					end;
				end;
				GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 57");
				RecordStore(GIr,true);
			end;	
		end;
	end;
	logtext(0,"end");
return;
end;




global webpublic updating procedure WebORNUMNORMrow() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger10:31 21.08.2018
begin
  record ORVc ORr;
	
	SetCompany(28,false);
	ORr.SerNr = "190001";
	if(readFirstMain(ORr,1,true))then begin
		ORr.CustOrdNr = "IP9-0002";
		ORr.RefStr = "IP9-0002";
		if(recordstore(ORr,true))then begin
			logtext(0,"yes");
		end;
	end;
return;
end;




global 
updating procedure ImportBrandIn()
begin
string 50 code,brand,class,referense,color;
integer pos;
record INVc INr;
record DIVc DIr,DIrC,DIrR;
string 255 fullclass;
boolean brandin,colorin,refin,TrHs;	
	while (TestEOF()==false) begin
		code = ImportField;
		brand = ImportField;
		referense = ImportField;
		color = ImportField;
		INr.Code = code;
		if(ReadFirstMain(INr,1,true)) then begin
			brandin = false;
			colorin = false;
			refin = false;
			pos = 0;
			class = "";
			fullclass = "";
			DIrR.Name = referense;
			DIrC.Name = color;
			TrHs = true;
			while (LoopKey("Name",DIrR,1,TrHs))  begin
				if(DIrR.CType=="MODEL") then begin
					referense = DIrR.Code;
					TrHs = false;
				end;	
			end;	
			resetloop(DIrR);
			TrHs = true;
			while (LoopKey("Name",DIrC,1,TrHs))  begin
				if(DIrC.CType=="COLOUR") then begin
					color = DIrC.Code;
					TrHs = false;
				end;	
			end;
			resetloop(DIrC);
				INr.Reference = referense;
				INr.Colour = color;	
			ExtractObj(INr.DispGroups,pos,class);
			while(nonblank(class))begin
				DIr.Code = class;
				readfirstmain(DIr,1,true);
				if(DIr.CType=="BRAND")then begin
					brandin = true; 
					if(blank(fullclass)) then begin
						fullclass = brand;
					end else begin
						fullclass = fullclass & "," & brand;
					end;	
				end else begin	
					if(DIr.CType=="COLOUR" and nonblank(color))then begin
						colorin = true; 
						if(blank(fullclass)) then begin
							fullclass = color;
						end else begin
							fullclass = fullclass & "," & color;
						end;					
					end else begin
						if(DIr.CType=="MODEL" and nonblank(referense))then begin
							refin = true; 
							if(blank(fullclass)) then begin
								fullclass = referense;
							end else begin
								fullclass = fullclass & "," & referense;
							end;	
						end else begin		
							if(blank(fullclass)) then begin
								fullclass = class;
							end else begin
								fullclass = fullclass & "," & class;
							end;	
						end;
					end;
				end;	
				ExtractObj(INr.DispGroups,pos,class);
			end;
			INr.DispGroups = fullclass;
			if(blank(INr.DispGroups)) then begin
					INr.DispGroups = brand & "," & referense & "," & color;
				end else begin
				if(!refin and nonblank(referense)) then begin
					INr.DispGroups = INr.DispGroups & "," & referense;
				end;	
				if(!colorin and nonblank(color)) then begin
					INr.DispGroups = INr.DispGroups & "," & color;
				end;	
				if(!brandin and nonblank(brand)) then begin
					INr.DispGroups = INr.DispGroups & "," & brand;
				end;	
			end;	
			RecordStore(INr,true);
			referense = "";
			color = "";
		end;
		NextImportLine(true);
	end;

return;
end;

global 
updating procedure ImportBrandIn2()
begin
string 50 code,brandName,brand,class,referense,color;
integer pos,i;
record INVc INr;
record DIVc DIr,DIr2,DIrR,DIrC;
string 255 fullclass;
boolean TrHs,brandin, colorin,refin;	
	while (TestEOF()==false) begin
		code = ImportField;
		brandName = ImportField;
		referense = ImportField;
		color = ImportField;
		INr.Code = code;
		if(ReadFirstMain(INr,1,true)) then begin
			INr.DispGroups = "";
			brand = "";
			brandin = false;
			colorin = false;
			refin = false;
			DIrR.Name = referense;
			DIrC.Name = color;
			TrHs = true;
			while (LoopKey("Name",DIrR,1,TrHs))  begin
				if(DIrR.CType=="MODEL") then begin
					referense = DIrR.Code;
					TrHs = false;
				end;	
			end;	
			resetloop(DIrR);
			TrHs = true;
			while (LoopKey("Name",DIrC,1,TrHs))  begin
				if(DIrC.CType=="COLOUR") then begin
					color = DIrC.Code;
					TrHs = false;
				end;	
			end;
			resetloop(DIrC);
				INr.Reference = referense;
				INr.Colour = color;	
			pos = 0;
			class = "";
			fullclass = "";
			ExtractObj(INr.DispGroups,pos,class);
				DIr2.Name = brandName;
					TrHs = true;
					while(LoopKey("Name",DIr2,1,TrHs)) begin
						if(DIr2.Name==brandName and DIr2.CType=="BRAND") then begin
							TrHs = false;
							brand = DIr2.Code;
						end;
					end;
					ResetLoop(DIr2);
			while(nonblank(class))begin
				DIr.Code = class;
				readfirstmain(DIr,1,true);
				if(DIr.CType=="BRAND")then begin
					brandin = true;
					if(blank(fullclass)) then begin
						fullclass = brand;
					end else begin
						if(nonblank(brand)) then begin
							fullclass = fullclass & "," & brand;
						end;	
					end;
				end else begin	
					if(DIr.CType=="COLOUR" and nonblank(color))then begin
						colorin = true; 
						if(blank(fullclass)) then begin
							fullclass = color;
						end else begin
							fullclass = fullclass & "," & color;
						end;					
					end else begin
						if(DIr.CType=="MODEL" and nonblank(referense))then begin
							refin = true; 
							if(blank(fullclass)) then begin
								fullclass = referense;
							end else begin
								fullclass = fullclass & "," & referense;
							end;		
						end else begin
							if(blank(fullclass)) then begin
								fullclass = class;
							end else begin
								fullclass = fullclass & "," & class;
							end;		
						end;
					end;
				end;	
				ExtractObj(INr.DispGroups,pos,class);
			end;
			INr.DispGroups = fullclass;
			if(blank(INr.DispGroups)) then begin
					INr.DispGroups = brand & "," & referense & "," & color;
			end else begin
				if(!refin and nonblank(referense)) then begin
					INr.DispGroups = INr.DispGroups & "," & referense;
				end;	
				if(!colorin and nonblank(color)) then begin
					INr.DispGroups = INr.DispGroups & "," & color;
				end;	
				if(!brandin and nonblank(brand)) then begin
					INr.DispGroups = INr.DispGroups & "," & brand;
				end;	
			end;			
			RecordStore(INr,true);
		end;
		NextImportLine(true);
	end;

return;
end;


global 
updating procedure ImportBrandAndGroupIn()
begin
string 50 code,brandold,brand,class,group,color;
integer pos,i;
record INVc INr;
record DIVc DIr;
string 255 fullclass;
boolean TrHs,brandin, colorin,refin;	
	while (TestEOF()==false) begin
		code = ImportField;
		brand = ImportField;
		group = ImportField;
		INr.Code = code;
		if(ReadFirstMain(INr,1,true)) then begin
			i=0;
			ExtractObj(INr.DispGroups,i,class);
			fullclass = "";
			while(nonblank(class)) begin
				if(class==INr.BPIGroup) then begin 
					fullclass = fullclass & group & ",";
				end else begin	
					if(class==INr.BPIBrand)then begin
						fullclass = fullclass & brand & ",";
					end else begin  	
						fullclass = fullclass & class & ",";
					end;
				end;	
				ExtractObj(INr.DispGroups,i,class);
			end;
			fullclass = left(fullclass,len(fullclass)-1);
			INr.DispGroups = fullclass;
			if(Blank(INr.DispGroups)) then begin
				INr.DispGroups = brand & "," & group;
			end;
			INr.BPIBrand = brand;
			INr.BPIGroup = group;
			RecordStore(INr,true);
		end;
		NextImportLine(true);
	end;

return;
end;







global 
updating procedure ImportSizeCreativeIn()
begin
string 50 code,brandold,size,class,group,color;
integer pos,i;
record INVc INr;
record DIVc DIr;
string 255 fullclass;
boolean TrHs,brandin, colorin,refin;	
	INr.Code = "";
	while (LoopMain(INr,1,true))begin
		if(nonblank(INr.Size))then begin
			INr.Size = "";
			RecordStore(INr,true);
		end;
	end;
	resetloop(INr);
	while (TestEOF()==false) begin
		size = "";
		code = ImportField;
		size = ImportField;
		INr.Code = code;
		if(ReadFirstMain(INr,1,true)) then begin
			INr.Size = size;
			RecordStore(INr,true);
			// logtext(0,INr.Code & "   <>   " & INr.Size);
		end;
		NextImportLine(true);
	end;

return;
end;





global 
updating procedure ImportRebateGIIn()
begin
	record GlobalItemVc GIr,LogGIr;
	string 255 code, rebate;
	
	logtext(0,"ImportRebateGIIn");
	
	while (TestEOF()==false) begin
		code = "";
		rebate = "";
		code = ImportField;
		rebate = ImportField;
		GIr.Code = code;
		if (ReadFirstMain(GIr,1,true)) then begin
			recordcopy(LogGIr,GIr);
			GIr.Rebate = StringToVal(rebate,M4Val);
			GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 58");
			RecordStore (GIr,true);
		end;
		NextImportLine(true);
	end;

return;
end;





global
updating procedure TRIMDIMn()
begin
record DIVc DIr;
boolean TrHs;

DIr.Code = "";
while (loopmain(DIr,1,true))begin
	if(DIr.CType=="BRAND")then begin
		DIr.Name = TRIM(DIr.Name);
		// logtext(0,"TR");
		recordStore(DIr,true);
	end;
end;
return;
end;


global
updating procedure CLMLCLMn()
begin
record DIVc DIr;
string 50 code,brandold,size,class,group,color;
integer pos,i;
record INVc INr;
string 255 fullclass;
boolean TrHs,brandin, colorin,refin;	

	INr.Code = "";
	while (LoopMain(INr,1,true))begin
		if(left(INr.Group,1)!="C")then begin
			INr.Colour = "";
			INr.Reference = "";
			INr.DispGroups = left(INr.DispGroups,7);
			RecordStore(INr,true);
		end;
	end;
return;
end;

global
updating procedure ActProveMn()
begin
record ActVc Acr;
integer oldcomp,i;
record ActTypeVc ATr;

oldcomp = CurrentCompany;
for(i=0;i<29;i=i+1) begin	
SetCompany(i,false);
		ATr.Code = "CUSRE";
        if(ReadFirstMain(ATr,1,true)) then begin 
		end else begin 
			RecordNew(ATr);
			ATr.Code = "CUSRE";
			if(RecordStore(ATr,true)) then begin
				logtext(0,"true");
			end;	
		end;
end;	
SetCompany(oldcomp,false);
return;
end;








global
updating procedure GroupIDEAMn()
begin
record INVc INr;
record ITVc ITr;
integer pos,i;
string 50 class,group,name,brand;
record DIVc DIr;
boolean chisla;

INr.Code = "";
while(loopmain(INr,1,true)) begin
			pos = 0;
			class = "";
			ExtractObj(INr.DispGroups,pos,class);
			while(nonblank(class))begin
				DIr.Code = class;
				readfirstmain(DIr,1,true);
				if(DIr.CType=="BRAND")then begin
					chisla = true;
						for(i=0;i<len(class);i=i+1) begin
							if(ASC(mid(class,i,1)) < 48 or ASC(mid(class,i,1)) > 57) begin
								chisla = false;
							end;
						end;
					if(chisla) then begin
						group = Right(class,5);
						name = DIr.Name;
					end else begin	
						group = "C" & Right(class,4);
						name = DIr.Name;
						brand = DIr.Code;
					end;	
				end;
				ExtractObj(INr.DispGroups,pos,class);
			end;
			ITr.Code = group;
			if(readfirstmain(ITr,1,true)) then begin					
				INr.Group = ITr.Code;
				RecordStore(INr,true);
			end else begin
				RecordNew(ITr);
				ITr.Code = group;
				ITr.Comment = name;
				ITr.Objects = brand;
				INr.Group = ITr.Code;
				RecordStore(ITr,true);
				RecordStore(INr,true);
			end;	
end;
return;
end;

global
updating procedure FillObjMn()
begin
record ITVc ITr;
boolean TrHs;
integer i;
record ObjVc Objr;
record DIVc DIr;
boolean chisla;
	ITr.Code = "";
	while (loopmain(ITr,1,true))begin
		if(left(ITr.Code,1)=="C") then begin
			Objr.Code = ITr.Objects;
			if(!ReadFirstMain(Objr,1,true)) then begin
				RecordNew(Objr);
				Objr.Code = ITr.Objects;
				Objr.OTCode = "BRAND";
				DIr.Code = Objr.Code;
				DIr.CType = "BRAND";
				if(ReadfirstKey("CType",DIr,2,true)) then begin
					Objr.Comment = DIr.Name;
				end;	
				RecordStore(Objr,true);
			end;
		end;
	end;
	return;
end;


global procedure LogTextOnServer(string log)
begin
	
	logtext(0,currentcompany & " " & log);
	
return;
end;

global webpublic updating procedure WebChangeRateToEuro()
begin
integer i;
record CUVc CUr;

	SetCompany(1,false);
	CUr.Code = "";
	while (LoopMain(CUr,1,true)) begin
		if(CUr.VEType==1 and CUr.VECat=="IDEA") then begin 
			CUr.VECurncyCode = "EUR";
			RecordStore(CUr,true);
		end;
	end;		
return;
end;

global webpublic procedure WebFinfInvoiceNum()
begin
	record CompaniesBlock CBb;
	integer i,mtrw;
	longint invnr;
	record IVVc IVr;
	
	invnr = stringtolongint(WebGetArg("invnr"));
	//logtext(0,invnr);	
	blockload(CBb);
	mtrw = matrowcnt(CBb);
	for(i=0;i<mtrw;i=i+1)begin
		setcompany(i+1,false);
		resetloop(IVr);
		IVr.SerNr = invnr;
		if(readfirstmain(IVr,1,true))then begin
			weboutstring(i+1 & "   " & IVr.Addr0 & chr(13) & chr(10));
		end;
	end;
	
	
return;
end;

global 
webpublic procedure WebPingServe()
begin
WebOutStringFormatNL("ok");
end;

global
updating procedure RekalcPriceGlItemMn(record RcVc RepSpec)
begin
record PLVc PLr;
record GlobalItemVc GIr,LogGIr;
record RebVc Rebr;
record MyRebVc MRebr;
row MyRebVc MRebrw;
row RebVc Rebrw;
boolean TrHs,testf;
val disc1,disc2,disc3,disc1t,disc2t,disc3t,vipayval,td,fr,to1,to2,b1,b2,price;
integer cnt,i,oldcomp;
longint curtick;
string 20 crn;

curtick = getcurtick();
price = 0;

oldcomp = CurrentCompany;
for(i=0;i<29;i=i+1) begin
SetCompany(i+1,false);
GIr.Code = "";
 while(LoopMain(GIr,1,true)) begin
		PLr.ArtCode = GIr.HansaCode;
		PLr.PLCode="RRP";
		if(ReadFirstKey("ArtCode",PLr,2,true)) then begin
				GetFullCurncyRate(PLr.CurncyCode,CurrentDate,fr,to1,to2,b1,b2);
				price = MulRateToBase1(PLr.CurncyCode,PLr.ExVatPrice,fr,to1,to2,b1,b2,SetRoundModeD(0));
				logtext(0,"RekalcPriceGlItemMn Code:" & GIr.Code & " Global item price = " & price);
				recordcopy(LogGIr,GIr);
				GIr.Price = price;
				GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 59");
				RecordStore(GIr,true);	
		end;
	end;		
ResetLoop(GIr);
end;
SetCompany(oldcomp,false);
LogProcTime("RekalcPriceGlItemMn",getcurtick()-curtick); 
return;	
end;

global 
webpublic procedure WebPingServe()
begin
WebOutStringFormatNL("ok");
end;

global webpublic updating procedure WebFixCoinPrices()
begin
	record INVc INr;
	record PLVc PLr;
	boolean TrHs;
	
	setcompany(25,false);
	INr.Group = "COINC";
	TrHs = true;
	while(loopkey("Group",INr,1,TrHs))begin
		if(INr.Group!="COINC")then begin TrHs = false; end;
		
		if(TrHs)then begin
			PLr.ArtCode = INr.Code;
			PLr.PLCode = "RRP";
			if(readfirstmain(PLr,2,true))then begin
				if(blank(PLr.CurncyCode))then begin
					PLr.CurncyCode = "EUR";
					recordstore(PLr,true);
				end;
			end;
		end;
	end;

return;
end;

global 
webpublic updating procedure WebUpdateGIClass()
begin
record INVc INr;
integer i;
record GlobalItemVc GIr,LogGIr;


for(i=0;i<25;i=i+1) begin
	SetCompany(i+1,false);
		if(!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3)then begin 
			INr.Code = "";
			while(loopmain(INr,1,true)) begin
				if(nonblank(INr.GlobalArtCode))then begin
					GIr.Code = INr.GlobalArtCode;
					if(readfirstmain(GIr,1,true))then begin
						//GIr.Classification = INr.DispGroups;
						recordcopy(LogGIr,GIr);
						AddToSet(GIr.Classification,INr.BPIBrand);
						AddToSet(GIr.Classification,INr.BPICollection);
						AddToSet(GIr.Classification,INr.BPIGroup);
						AddToSet(GIr.Classification,INr.BPISubGroup);
						AddToSet(GIr.Classification,INr.BPICategory);
						AddToSet(GIr.Classification,INr.BPIMaterial);
						AddToSet(GIr.Classification,INr.BPIColor);
						AddToSet(GIr.Classification,INr.BPIShape);
						AddToSet(GIr.Classification,INr.BPISize);
						AddToSet(GIr.Classification,INr.BPIUse);
						AddToSet(GIr.Classification,INr.BPISex);
						AddToSet(GIr.Classification,INr.BPIPlating);
						AddToSet(GIr.Classification,INr.BPIClarity);
						AddToSet(GIr.Classification,INr.BPIWeight);
						AddToSet(GIr.Classification,INr.BPICut);
						AddToSet(GIr.Classification,INr.BPIStone);
						AddToSet(GIr.Classification,INr.BPIStrap);
						AddToSet(GIr.Classification,INr.BPIOdour);

						GIr.BPIBrand = INr.BPIBrand;
						GIr.BPICollection = INr.BPICollection;
						GIr.BPIGroup = INr.BPIGroup;
						GIr.BPISubGroup = INr.BPISubGroup;
						GIr.BPICategory = INr.BPICategory;
						GIr.BPIMaterial = INr.BPIMaterial;
						GIr.BPIColor = INr.BPIColor;
						GIr.BPIShape = INr.BPIShape;
						GIr.BPISize = INr.BPISize;
						GIr.BPIUse = INr.BPIUse;
						GIr.BPISex = INr.BPISex;
						GIr.BPIPlating = INr.BPIPlating;
						GIr.BPIClarity = INr.BPIClarity;
						GIr.BPIWeight = INr.BPIWeight;
						GIr.BPICut = INr.BPICut;
						GIr.BPIStone = INr.BPIStone;
						GIr.BPIStrap = INr.BPIStrap;
						GIr.BPIOdour = INr.BPIOdour;
						GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 60");
						recordstore(GIr,true);
					end;
				end;
			end;
		end;
end;
								
return;
end;

global 
webpublic updating procedure offWebFillDispGr()
begin
record INVc INr;
integer i;
boolean problem;
/*if(blank(INr.DispGroups)) then begin
				INr.DispGroups = INr.BPIBrand;
			end else begin
				INr.DispGroups = INr.DispGroups & "," & INr.BPIBrand;
			end;
*/
for(i=0;i<25;i=i+1) begin
	SetCompany(i+1,false);
 if(!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3)then begin 
	INr.Code = "";
	while(loopmain(INr,1,true)) begin
		problem = false;
		if(blank(INr.DispGroups) and (nonblank(INr.BPIBrand) or nonblank(INr.BPIGroup)))then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIBrand,INr.DispGroups) and nonblank(INr.BPIBrand)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPICollection,INr.DispGroups) and nonblank(INr.BPICollection)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIGroup,INr.DispGroups) and nonblank(INr.BPIGroup)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPISubGroup,INr.DispGroups) and nonblank(INr.BPISubGroup)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPICategory,INr.DispGroups) and nonblank(INr.BPICategory)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIMaterial,INr.DispGroups) and nonblank(INr.BPIMaterial)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIColor,INr.DispGroups) and nonblank(INr.BPIColor)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIShape,INr.DispGroups) and nonblank(INr.BPIShape)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPISize,INr.DispGroups) and nonblank(INr.BPISize)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIUse,INr.DispGroups) and nonblank(INr.BPIUse)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPISex,INr.DispGroups) and nonblank(INr.BPISex)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIPlating,INr.DispGroups) and nonblank(INr.BPIPlating)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIClarity,INr.DispGroups) and nonblank(INr.BPIClarity)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIWeight,INr.DispGroups) and nonblank(INr.BPIWeight)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPICut,INr.DispGroups) and nonblank(INr.BPICut)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIStone,INr.DispGroups) and nonblank(INr.BPIStone)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIStrap,INr.DispGroups) and nonblank(INr.BPIStrap)) then begin
			problem = true;
			goto problemfl;
		end;
		
		if(!SetInSet(INr.BPIOdour,INr.DispGroups) and nonblank(INr.BPIOdour)) then begin
			problem = true;
			goto problemfl;
		end;
		problemfl:;
		if(problem) then begin
			// logtext(0,INr.Code & " " & INr.DispGroups);
			/*INr.DispGroups = "";
					if (nonblank(INr.BPIBrand)) then begin AddToSet(INr.DispGroups,INr.BPIBrand); end;
					if (nonblank(INr.BPICollection)) then begin AddToSet(INr.DispGroups,INr.BPICollection); end;
					if (nonblank(INr.BPIGroup)) then begin AddToSet(INr.DispGroups,INr.BPIGroup); end;
					if (nonblank(INr.BPISubGroup)) then begin AddToSet(INr.DispGroups,INr.BPISubGroup); end;
					if (nonblank(INr.BPICategory)) then begin AddToSet(INr.DispGroups,INr.BPICategory); end;
					if (nonblank(INr.BPIMaterial)) then begin AddToSet(INr.DispGroups,INr.BPIMaterial); end;
					if (nonblank(INr.BPIColor)) then  begin AddToSet(INr.DispGroups,INr.BPIColor); end;
					if (nonblank(INr.BPIShape)) then begin AddToSet(INr.DispGroups,INr.BPIShape); end;
					if (nonblank(INr.BPISize)) then begin AddToSet(INr.DispGroups,INr.BPISize); end;
					if (nonblank(INr.BPISex)) then begin AddToSet(INr.DispGroups,INr.BPISex); end;
					if (nonblank(INr.BPIPlating)) then begin AddToSet(INr.DispGroups,INr.BPIPlating); end;
					if (nonblank(INr.BPIClarity)) then begin AddToSet(INr.DispGroups,INr.BPIClarity); end;
					if (nonblank(INr.BPIWeight)) then begin AddToSet(INr.DispGroups,INr.BPIWeight); end;
					if (nonblank(INr.BPICut)) then begin AddToSet(INr.DispGroups,INr.BPICut); end;
					if (nonblank(INr.BPIStone)) then begin AddToSet(INr.DispGroups,INr.BPIStone); end;
					if (nonblank(INr.BPIStrap)) then begin AddToSet(INr.DispGroups,INr.BPIStrap); end;
					if (nonblank(INr.BPIUse)) then begin AddToSet(INr.DispGroups,INr.BPIUse); end;
					if (nonblank(INr.BPIOdour)) then begin AddToSet(INr.DispGroups,INr.BPIOdour); end;
			logtext(0,INr.Code & " " & INr.DispGroups);	
			recordstore(INr,true);*/
		end;	
	end;
	ResetLoop(INr);
end;	
	
 end;
return;
end;

/*global??????????????????????????????????????????? 
updating procedure RecBlankItemMn()
begin
record RcVc RepSpec;
integer i,CompQty,j;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
record GlobalItemVc GIr;
vector string 100 hsCode;
array string 100 tags;
vector val ITRebate,price;
val pricet,rebt;

	GIr.Code = "";
	while(LoopMain(GIr,1,true)) begin
		if(GIr.Price==blankval or GIr.Price==0) then begin
			hsCode[GIr.Code] = Gir.HansaCode;
		end;	
	end;
	ResetLoop(GIr);
	getvectortags(hsCode,tags);
	BlockLoad(Compb);
	
	
	CompQty = matrowcnt(Compb);
	pricet = 0;
	rebt = 0;
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0)then begin
			SetCompany(i+1,false);			
			for(j=0;j<tags.length;j=j+1) begin
				pricet = blankval;
				rebt = blankval;
				GetPriceItem1(hsCode[tags[j]],pricet,rebt);
				if(!Blank(pricet)) then begin
					price[tags[j]] = pricet;
				end;
				if(!Blank(rebt)) then begin
					ITRebate[tags[j]] = rebt;
				end;	
			end;
		end;
	end;
	for(j=0;j<tags.length;j=j+1) begin
		GIr.HansaCode = hsCode[tags[j]];
		if (ReadFirstKey("HansaCode",GIr,1,true)) then begin
			GIr.Price = price[tags[j]];
			GIr.Rebate = ITRebate[tags[j]];
			logtext(0,GIr.Code & " " &  price[tags[j]]);
			RecordStore(GIr,true);
		end;	
	end;
return;
end;	*/

global procedure CheckPriceRn() // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger18:01 20.08.2018
begin
	integer i,CompQty;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	record INVc INr;
	record GlobalItemVc GIr;
	val price;
	record PLVc PLr;
	boolean TrHs,testf;
	val td,fr,to1,to2,b1,b2;
	roundmode rnd;

rnd.decimals = 0;// Edit ************************** Friday, 26 February 2016 10:04:07
rnd.step = kRoundingStepNone;
rnd.mode = kRoundingModeHalfUp;

	BlockLoad(Compb);
	
	startreportnoheaderjob("");
	CompQty = matrowcnt(Compb);
	
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10)then begin
			SetCompany(i+1,false);
			INr.Code = "";
			while(loopmain(INr,1,true))  begin
				GIr.Code = INr.GlobalArtCode;
				if(ReadFirstMain(GIr,1,true)) then begin
					price = 0;
					PLr.ArtCode = INr.Code;
					PLr.PLCode = "RRP";
					if(ReadFirstMain(PLr,2,true)) then begin
						if(nonblank(PLr.CurncyCode) and PLr.CurncyCode!="AZN") then begin
							GetFullCurncyRate(PLr.CurncyCode,CurrentDate,fr,to1,to2,b1,b2);
							price = MulRateToBase1(PLr.CurncyCode,PLr.ExVatPrice,fr,to1,to2,b1,b2,rnd);
						end else begin
							price = PLr.ExVatPrice;
						end;	
					end;
					if(GIr.Price!=price) then begin
						logtext(0,PLr.CurncyCode & " " & PLr.ExVatPrice);
						logtext(0, GIr.Code & " - Global price " & GIr.Price & " != " & " price " & price );
					end;
				end;
			end;	
			ResetLoop(INr);
		end;
	end;
	endjob;
return;
end;	

global 
updating procedure RecalcDiscBackMn(area text)
begin
  record GlobalItemVc GIr,mainGIr,LogGIr;
	boolean TrHs;
	val ITRebate,price;
	record INVc INr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	
	blockload(Compb);
	logtext(0,"RecalcDiscMn " & currentcompany);
	TrHs = true;
	ResetLoop(INr);
	INr.Code = "";
	matrowget(Compb,currentcompany-1,Comprw);
	while(loopmain(INr,1,TrHs)) begin		
		GIr.Code = INr.GlobalArtCode;
		if(CurrentCompany==29 and blank(INr.Group)) then begin
		end else begin
			if (ReadFirstMain(GIr,1,true)) then begin
				GetPriceItem(INr.Code,price,ITRebate);
				if(GIr.Price!=price or GIr.Rebate!=ITRebate) then begin
					AddTextToArea	(INr.Code & chr(9) & GIr.Price & chr(9) & price & chr(9) & price-GIr.Price & chr(9) & GIr.Rebate & chr(9) & ITRebate & chr(9) & ITRebate-GIr.Rebate & chr(9) & Comprw.CompName & chr(13),text);
				end;
				recordcopy(LogGIr,GIr);
				GIr.Price = price;
				GIr.Rebate = ITRebate;
				GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 61");
				RecordStore(GIr,true);
			end;
		end;	
	end;	
  return;
end;

global 
updating procedure RecalcDiscMn()
begin
  record GlobalItemVc GIr,mainGIr,LogGIr;
	boolean TrHs;
	val ITRebate,price;
	record INVc INr;

	Logtext(0,"RecalcDiscMn start");
	TrHs = true;
	ResetLoop(INr);
	INr.Code = "";
	while(loopmain(INr,1,TrHs)) begin		
		GIr.Code = INr.GlobalArtCode;
		if(CurrentCompany==29 and blank(INr.Group)) then begin
		end else begin
			if (ReadFirstMain(GIr,1,true)) then begin
				GetPriceItemForIN(INr,price,ITRebate);
				if(GIr.Price!=price or GIr.Rebate!=ITRebate)then begin
					recordcopy(LogGIr,GIr);
					GIr.Price = price;
					GIr.Rebate = ITRebate;
					GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 62");
					RecordStore(GIr,true);
				end;
			end;
		end;	
	end;	
	Logtext(0,"RecalcDiscMn end");
  return;
end;



global 
updating procedure RecTestMn()
begin
record RcVc RepSpec;
	integer i,CompQty;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
 	
 	BlockLoad(Compb);
	CompQty = matrowcnt(Compb);
	
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10)then begin
			SetCompany(i+1,false);
			RecalcDiscMn;
		end;
	end;
	return;
end;
	


global 
webpublic updating procedure WebConstantStockSabinaItMn()
begin
  record GlobalItemVc GIr,mainGIr,LogGIr;
	row GlobalItemVc GIrw;
	boolean TrHs;
	val ITRebate,price;
	record INVc INr;
	
	if(SetCompany(29,false))then begin
		TrHs = true;
		INr.Code = "SB00001";
		while(loopmain(INr,1,TrHs)) begin	
			if(left(INr.Code,2)!="SB")then begin TrHs = false; end;
			if(TrHs)then begin
				GIr.HansaCode = INr.Code;
				if (ReadFirstKey("HansaCode",GIr,1,true)) then begin
					recordcopy(LogGIr,GIr);
					GIrw.Location = "MAIN";
					GIrw.Instock = 2;
					matrowPUt(GIr,0,GIrw);
					GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 63");
					RecordStore(GIr,true);
				end;
			end;
		end;	
	end;
  return;
end;

global updating procedure RA_OutOfOrderItem(record  BPIBrandVc BBr)
begin
	record INVc INr;
	record CompaniesBlock CBb;
	row CompaniesBlock CBrw;
	integer CompQty,i,curcomp;
	
	curcomp = currentcompany;
	
	blockload(CBb);
	CompQty = matrowcnt(CBb);
	
	
	for (i=0;i<CompQty;i=i+1) begin
		matrowget(CBb,i+1,CBrw);
		if(CBrw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or (i+1)==3))then begin
			SetCompany(i+1,false);
			logtext(0,"RA_OutOfOrderItem in company " & i+1 & " unordered brand " & BBr.Name);
			resetloop(INr);
			INr.Code = "";
			while(LoopMain(INr,1,true)) begin 
				if(INr.BPIBrand==BBr.Code and nonblank(BBr.Code) and INr.OutOfOrder==0) then begin
					INr.OutOfOrder = 1;
					RecordStore(INr,true);
					logtext(0,INr.Code & " out of order");
				end;
			end;	
		end;
	end;
	
	setcompany(curcomp,false);
	
	

return;
end;


global function string 100 remotegetrecordseq(record GlobalItemVc GIr)
begin
	record GlobalItemVc origGIr;
	
	origGIr.Code = GIr.Code;
	if(readfirstmain(origGIr,1,true))then begin
		remotegetrecordseq = RECORDSEQUENCE(origGIr);
	end;
	
return;
end;


global 
webpublic updating procedure WebCheckFixJWPrices()
begin
  record GlobalItemVc GIr,mainGIr;
	row GlobalItemVc GIrw;
	boolean TrHs,TrHs1,changed,noneedtochange;
	val ITRebate,price;
	record INVc INr;
	record PLVc PLr,OldPLr;
	record RHistVc RHistr;
	string 200 rstr;
	
	if(SetCompany(3,false))then begin
		PLr.PLCode = "RRP";
		TrHs = true;
		weboutstring("<table>");
		while(loopkey("PLCode",PLr,1,TrHs))begin
			if(PLr.PLCode!="RRP")then begin TrHs = false; end;
			
			if(TrHs)then begin
				resetloop(RHistr);
				rstr = BuildRecordIdStr(PLr,CurrentCompany);
				RHistr.RecidStr = rstr;
				TrHs1 = true;
				changed = false;
				noneedtochange = false;
				while(loopkey("RecidStr",RHistr,1,TrHs1)) begin
					if(RHistr.RecidStr!=rstr)then begin TrHs1 = false; end;
					
					if(TrHs1)then begin
						if(RHistr.TransDate==stringtodate("19/02/2021"))then begin
							if(RHistr.User=="USER1" and RHistr.accode==1)then begin
								if(RHistr.TransTime<stringtotime("15:35:00") and RHistr.TransTime>stringtotime("15:32:00"))then begin
									if(changed==false)then begin
										ReadOriginalRecord(RHistr,OldPLr);
										if(OldPLr.ExVatPrice!=PLr.ExVatPrice)then begin
											//PLr.ExVatPrice = OldPLr.ExVatPrice;
											//PLr.CurncyCode = OldPLr.CurncyCode;
											//recordstore(PLr,true);
											changed = true;
											TrHs1 = false;
										end else begin
											TrHs1 = false;
											noneedtochange = true;
										end;
									end;
									
								end;
							end;
						end;
					end;
				end;
				
				if(changed)then begin
					resetloop(RHistr);
					RHistr.RecidStr = rstr;
					RHistr.SerNr = 99999999;
					TrHs1 = true;
					while(loopbackkey("RecidStr",RHistr,2,TrHs1)) begin
						if(RHistr.RecidStr!=rstr)then begin TrHs1 = false; end;
					
						if(RHistr.TransDate>stringtodate("19/02/2021") and RHistr.accode==1)then begin
							TrHs1 = false;
							noneedtochange = true;
						end;
						if(RHistr.TransDate==stringtodate("19/02/2021") and RHistr.TransTime>stringtotime("15:35:00") and RHistr.accode==1)then begin
							TrHs1 = false;
							noneedtochange = true;
						end;
						if(RHistr.TransDate<stringtodate("19/02/2021"))then begin
							TrHs1 = false;
						end;
					end;
				end;
				
				
				
				if(changed and noneedtochange==false)then begin
					weboutstring("<tr>");
						weboutstring("<td>" & PLr.ArtCode & "</td>");
						weboutstring("<td>" & PLr.Comment & "</td>");
						weboutstring("<td>" & PLr.PLCode & "</td>");
						weboutstring("<td>" & OldPLr.ExVatPrice & "</td>");
						weboutstring("<td>" & PLr.ExVatPrice & "</td>");
					weboutstring("</tr>");
					PLr.ExVatPrice = OldPLr.ExVatPrice;
					PLr.CurncyCode = OldPLr.CurncyCode;
					recordstore(PLr,true);
					//logtext(0,PLr.ArtCode);
				end;
			end;
		end;
		weboutstring("</table>");
	end;
		
  return;
end;

global 
webpublic updating procedure WebCheckFixCoinPrices()
begin
  record GlobalItemVc GIr,mainGIr;
	row GlobalItemVc GIrw;
	boolean TrHs,TrHs1,changed;
	val ITRebate,price;
	record INVc INr;
	record PLVc PLr,OldPLr;
	record RHistVc RHistr;
	string 200 rstr;
	
	/*if(SetCompany(25,false))then begin
		PLr.PLCode = "RRP";
		TrHs = true;
		while(loopkey("PLCode",PLr,1,TrHs))begin
			if(PLr.PLCode!="RRP")then begin TrHs = false; end;
			
			if(TrHs)then begin
				resetloop(RHistr);
				rstr = BuildRecordIdStr(PLr,CurrentCompany);
				RHistr.RecidStr = rstr;
				TrHs1 = true;
				changed = false;
				while(loopkey("RecidStr",RHistr,1,TrHs1)) begin
					if(RHistr.RecidStr!=rstr)then begin TrHs1 = false; end;
					
					if(TrHs1)then begin
						if(RHistr.TransDate==CurrentDate)then begin
							if(RHistr.User=="TOVAROVED" and RHistr.accode==1)then begin
								if(RHistr.TransTime<stringtotime("18:00:00"))then begin
									if(changed==false)then begin
										ReadOriginalRecord(RHistr,OldPLr);
										if(OldPLr.ExVatPrice!=PLr.ExVatPrice)then begin
											logtext(0,PLr.ArtCode & " " & OldPLr.ExVatPrice & " -> " & PLr.ExVatPrice);
											PLr.ExVatPrice = OldPLr.ExVatPrice;
											PLr.CurncyCode = OldPLr.CurncyCode;
											recordstore(PLr,true);
											changed = true;
											TrHs1 = false;
										end;
									end;
									
								end;
							end;
						end;
					end;
				end;
				if(changed)then begin
					//logtext(0,PLr.ArtCode);
				end;
			end;
		end;
		
	end;*/
  return;
end;

global 
webpublic updating procedure WebCheckZerroPricesGIr()
begin
	record GlobalItemVc GIr;
	
	setcompany(1,false);
	while(loopmain(GIr,1,true))begin
		if(GIr.Price==BlankVal)then begin
			logtext(0,"WebCheckZerroPricesGIr " & GIr.Code);
		end;
	end;


return;
end;


global procedure CheckConsItems()
begin
	record INVc INr;
	integer i,CompQty,oldComp;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	
	BlockLoad(Compb);
	
	oldComp = CurrentCompany;
	CompQty = matrowcnt(Compb);
	startreportnoheaderjob(" ");
	startformat(15);
		outstring(20,0,"CompNr",false);
		outstring(120,0,"Code",false);
		outstring(220,0,"PurchAcc",false);
	endformat;
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32)then begin
			SetCompany(i+1,false);
			INr.Code = "";
			while(loopmain(INr,1,true))begin
				if(nonblank(INr.PurchAcc) and INr.ConsgType==0)then begin
					startformat(15);
						outstring(20,0,i+1,false);
						outstring(120,"DblINVc",INr.Code,false);
						outstring(120,0,INr.PurchAcc,false);
					endformat;
				end;
			end;
			ResetLoop(INr);
		end;	
	end;
	endjob;
	SetCompany(oldComp,false);
return;
end;

global 
updating procedure DeleteRhistMn(record RcVc RepSpec)
begin
record RHistVc RHr;
longint cnt;
boolean testf,TrHs;
longint curtick;

curtick = getcurtick(); 
cnt = 0;

logtext(0,"DeleteRhistMn");

RHr.SerNr = "";
TrHs = true;
While(LoopMain(RHr,1,TrHs)) begin
	testf = true;
	if(RHr.accode!=7) then begin testf = false; end;
	if(testf) then begin 
		if(cnt>=1000) then begin TrHs = false; end;
		if(fileexists("stop"))then begin
			logtext(0,"stopfileexist");
			TrHs = false;
		end;
		RecordDelete(RHr);
		StepBack(RHr);
		cnt = cnt+1;
	end;
end;
logtext(0,"DeleteRhistMn end");
LogProcTime("DeleteRhistMn",getcurtick()-curtick); 
DeleteRhistMnEND:;
return;
end;


global 
updating procedure CleanSAndTCatMn(record RcVc RepSpec)
begin
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr, BSLLastCoder;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder;
	vector boolean NameTRpt, NameSRpt;
	boolean testf;
	longint curtick;
	
	curtick = getcurtick();
	BtrxThirdLevelCatr.Code = "";
	while (loopmain(BtrxThirdLevelCatr,1,true)) begin
		if(NameTRpt[BtrxThirdLevelCatr.Name])then begin 
			RecordDelete(BtrxThirdLevelCatr);
			StepBack(BtrxThirdLevelCatr);
		end;
		NameTRpt[BtrxThirdLevelCatr.Name] = true;
	end;	
	BtrxSecondLevelCatr.Code = "";
	while (loopmain(BtrxSecondLevelCatr,1,true)) begin
		if(NameSRpt[BtrxSecondLevelCatr.Name])then begin
			RecordDelete(BtrxSecondLevelCatr);
			StepBack(BtrxSecondLevelCatr);
		end;
		NameSRpt[BtrxSecondLevelCatr.Name] = true;
	end;	
		LogProcTime("CleanSAndTCatMn",getcurtick()-curtick); 
return;
end;




global 
updating procedure FillTreePathMn(record RcVc RepSpec)
begin
	record GlobalItemVc GIr,LogGIr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr, BSLLastCoder;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder;
	boolean testf, TrHs;
	string 255 catName, catNameRUS, catNameAZ, OldCode, sCatName, tCatName;
	longint curtick;
	
	curtick = getcurtick();
	
	GIr.Code = "";
	while (LoopMain(GIr,1,true)) begin
		if(nonblank(GIr.BTRxFirstLevCat) and nonblank(GIr.BTRxSecondLevCat) and nonblank(GIr.BTRxThirdLevCat))then begin
			
			
			testf = true;
			catName = "";
			catNameRUS = "";
			catNameAZ = "";
			BtrxSecondLevelCatr.Code = GIr.BTRxSecondLevCat;
			if(ReadFirstMain(BtrxSecondLevelCatr,1,true))then begin 
				catName = BtrxSecondLevelCatr.Name;
				catNameRUS = BtrxSecondLevelCatr.NameRUS;
				catNameAZ = BtrxSecondLevelCatr.NameAZ; 
			end;
			BtrxSecondLevelCatr.Name = catName;
			while (loopkey("Name",BtrxSecondLevelCatr,1,testf)) begin
				if (BtrxSecondLevelCatr.Name!=catName)then begin 
					if(nonblank(catName))then begin
						BSLLastCoder.Code = "SCLVL9999";
						TrHs = true;
						while (LoopBackKey("Code",BSLLastCoder,1,TrHs)) begin
							OldCode = BSLLastCoder.Code;
							TrHs = false;
						end;
						ResetLoop(BSLLastCoder);
						recordnew(BtrxSecondLevelCatr);
						if(blank(OldCode))then begin OldCode = "SCLVL0000"; end;
						NextM4SerialNumber(OldCode,BtrxSecondLevelCatr.Code);
						BtrxSecondLevelCatr.Name = catName;
						BtrxSecondLevelCatr.NameRUS = catNameRUS;
						BtrxSecondLevelCatr.NameAZ = catNameAZ;
						BtrxSecondLevelCatr.PathFrstCode = GIr.BTRxFirstLevCat;
						recordinsert(BtrxSecondLevelCatr,true);
						recordupdate(BtrxSecondLevelCatr,BtrxSecondLevelCatr,true);
						logtext(0,"Created 2 " & BtrxSecondLevelCatr.Code);
						OldCode = "";
						recordcopy(LogGIr,GIr);
						GIr.BTRxSecondLevCat = BtrxSecondLevelCatr.Code;
						GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 64");
						RecordStore(GIr,true);
						testf = false; 
					end else begin
						testf = false; 
					end;
				end;
				if(testf)then begin
					if(nonblank(BtrxSecondLevelCatr.PathFrstCode) and BtrxSecondLevelCatr.PathFrstCode==GIr.BTRxFirstLevCat)then begin 
						testf = false; 
						recordcopy(LogGIr,GIr);
						GIr.BTRxSecondLevCat = BtrxSecondLevelCatr.Code;
						logtext (0,"All right 2");
						GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 65");
						RecordStore(GIr,true);
					end;
					if(blank(BtrxSecondLevelCatr.PathFrstCode))then begin
						BtrxSecondLevelCatr.PathFrstCode = GIr.BTRxFirstLevCat;
						RecordStore(BtrxSecondLevelCatr,true);
						recordcopy(LogGIr,GIr);
						GIr.BTRxSecondLevCat = BtrxSecondLevelCatr.Code;
						GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 66");
						RecordStore(GIr,true);
						testf = false;
						logtext(0,"Updated 2 " & BtrxSecondLevelCatr.Code);
					end;
				end;
			end;		
			ResetLoop(BtrxSecondLevelCatr);
			
			
			testf = true;
			catName = "";
			catNameRUS = "";
			catNameAZ = "";
			BtrxThirdLevelCatr.Code = GIr.BTRxThirdLevCat;
			if(ReadFirstMain(BtrxThirdLevelCatr,1,true))then begin 
				catName = BtrxThirdLevelCatr.Name;
				catNameRUS = BtrxThirdLevelCatr.NameRUS;
				catNameAZ = BtrxThirdLevelCatr.NameAZ; 
			end;
			BtrxThirdLevelCatr.Name = catName;
			while (loopkey("Name",BtrxThirdLevelCatr,1,testf)) begin
				if (BtrxThirdLevelCatr.Name!=catName)then begin 
					if(nonblank(catName))then begin
						BTLLastCoder.Code = "THLVL9999";
						TrHs = true;
						while (LoopBackKey("Code",BTLLastCoder,1,TrHs)) begin
							OldCode = BTLLastCoder.Code;
							TrHs = false;
						end;
						ResetLoop(BTLLastCoder);
						recordnew(BtrxThirdLevelCatr);
						if(blank(OldCode))then begin OldCode = "THLVL0000"; end;
						NextM4SerialNumber(OldCode,BtrxThirdLevelCatr.Code);
						BtrxThirdLevelCatr.Name = catName;
						BtrxThirdLevelCatr.NameRUS = catNameRUS;
						BtrxThirdLevelCatr.NameAZ = catNameAZ;
						BtrxThirdLevelCatr.PathScndCode = GIr.BTRxSecondLevCat;
						recordinsert(BtrxThirdLevelCatr,true);
						recordupdate(BtrxThirdLevelCatr,BtrxThirdLevelCatr,true);
						OldCode = "";
						logtext(0,"Created 3 " & BtrxThirdLevelCatr.Code);
						testf = false; 
						recordcopy(LogGIr,GIr);
						GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
						GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 67");
						RecordStore(GIr,true);
					end else begin
						testf = false; 
					end;
				end;
				if(testf)then begin
					if(nonblank(BtrxThirdLevelCatr.PathScndCode) and BtrxThirdLevelCatr.PathScndCode==GIr.BTRxSecondLevCat)then begin 
						testf = false; 
						recordcopy(LogGIr,GIr);
						GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
						logtext (0,"All right 3");
						GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 68");
						RecordStore(GIr,true);
					end;
					if(blank(BtrxThirdLevelCatr.PathScndCode))then begin
						BtrxThirdLevelCatr.PathScndCode = GIr.BTRxSecondLevCat;
						RecordStore(BtrxThirdLevelCatr,true);
						recordcopy(LogGIr,GIr);
						GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
						GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 69");
						RecordStore(GIr,true);
						testf = false;
						logtext(0,"Updated 3 " & BtrxThirdLevelCatr.Code);
					end;
				end;
			end;	
			ResetLoop(BtrxThirdLevelCatr);
		end;
	end;
	LogProcTime("FillTreePathMn",getcurtick()-curtick); 
return;
end;









global 
webpublic updating procedure WebDellCUIHr()
begin
  record GlobalItemVc GIr,mainGIr;
	row GlobalItemVc GIrw;
	boolean TrHs,TrHs1,changed;
	val ITRebate,price;
	record INVc INr;
	record PLVc PLr,OldPLr;
	record RHistVc RHistr;
	string 200 rstr,custocode;
	record CUVc CUr;
	
	custocode = webgetarg("cucode");
	setcompany(1,false);
	CUr.Code = custocode;
	if(readfirstmain(CUr,1,true))then begin
		resetloop(RHistr);
		rstr = BuildRecordIdStr(CUr,CurrentCompany);
		
		RHistr.RecidStr = rstr;
		TrHs1 = true;
		changed = false;
		while(loopkey("RecidStr",RHistr,1,TrHs1)) begin
			if(RHistr.RecidStr!=rstr)then begin TrHs1 = false; end;
			if(fileexists("stop"))then begin 
				TrHs1 = false; 
				logtext(0,"stop file exists");
			end;
			
			if(TrHs1)then begin
				
				logtext(0,RHistr.TransDate & " " & RHistr.TransTime & " " & BlobSize(RHistr));
				if(BlobSize(RHistr)<=1040)then begin
					recorddelete(RHistr);
					stepback(RHistr);
				end;
			end;
		end;
		
	end;
	
	
	/*if(SetCompany(25,false))then begin
		PLr.PLCode = "RRP";
		TrHs = true;
		while(loopkey("PLCode",PLr,1,TrHs))begin
			if(PLr.PLCode!="RRP")then begin TrHs = false; end;
			
			if(TrHs)then begin
				resetloop(RHistr);
				rstr = BuildRecordIdStr(PLr,CurrentCompany);
				RHistr.RecidStr = rstr;
				TrHs1 = true;
				changed = false;
				while(loopkey("RecidStr",RHistr,1,TrHs1)) begin
					if(RHistr.RecidStr!=rstr)then begin TrHs1 = false; end;
					
					if(TrHs1)then begin
						if(RHistr.TransDate==CurrentDate)then begin
							if(RHistr.User=="TOVAROVED" and RHistr.accode==1)then begin
								if(RHistr.TransTime<stringtotime("18:00:00"))then begin
									if(changed==false)then begin
										ReadOriginalRecord(RHistr,OldPLr);
										if(OldPLr.ExVatPrice!=PLr.ExVatPrice)then begin
											logtext(0,PLr.ArtCode & " " & OldPLr.ExVatPrice & " -> " & PLr.ExVatPrice);
											PLr.ExVatPrice = OldPLr.ExVatPrice;
											PLr.CurncyCode = OldPLr.CurncyCode;
											recordstore(PLr,true);
											changed = true;
											TrHs1 = false;
										end;
									end;
									
								end;
							end;
						end;
					end;
				end;
				if(changed)then begin
					//logtext(0,PLr.ArtCode);
				end;
			end;
		end;
		
	end;*/
  return;
end;


global 
webpublic updating procedure offWebDellSmallHr()
begin
  record GlobalItemVc GIr,mainGIr;
	row GlobalItemVc GIrw;
	boolean TrHs,TrHs1,changed;
	val ITRebate,price;
	record INVc INr;
	record PLVc PLr,OldPLr;
	record RHistVc RHistr;
	string 200 rstr,custocode;
	record CUVc CUr;
	longint cnt,reset;
	
	custocode = webgetarg("cucode");
	setcompany(1,false);
	
	cnt = 0;
	RHistr.RecidStr = "";
	TrHs1 = true;
	changed = false;
	CUr.Code = "";
	//while(loopmain(CUr,1,true))begin
		//rstr = BuildRecordIdStr(CUr,CurrentCompany);
		RHistr.RecidStr = rstr;
		TrHs1 = true;
		while(loopkey("RecidStr",RHistr,1,TrHs1)) begin
			//if(RHistr.RecidStr!=rstr)then begin TrHs1 = false; end;
			if(fileexists("stop"))then begin 
				TrHs1 = false; 
				logtext(0,"stop file exists");
			end;
		
			if(TrHs1)then begin
			
				//logtext(0,RHistr.TransDate & " " & RHistr.TransTime & " " & BlobSize(RHistr));
				//if(BlobSize(RHistr)<=1040)then begin
				if(blank(RHistr.User) or RHistr.accode==7)then begin
					recorddelete(RHistr);
					stepback(RHistr);
					cnt = cnt + 1;
					reset = reset + 1;
					if(reset>=1000)then begin
						reset = 0;
						logtext(0,"deleted IHr " & cnt & " user " & RHistr.User & " recid " & RHistr.RecidStr);
					end;
				end;
			end;
		end;
		resetloop(RHistr);
	//end;
			

  return;
end;

global 
webpublic procedure WebChekcIVCRM()
begin
record IVVc IVr;
boolean testf
	IVr.SerNr = "";
	while(LoopMain(IVr,1,true))begin
		testf = false;
		if(IVr.TransDate>DateFromString("01.03.2019","DD.MM.YYYY")) then begin testf = true; end;
		if(testf) then begin
			if(blank(IVr.CRMid)) then begin
				logtext(0,"SerNr " & IVr.SerNr & " CRMid " & IVr.CRMid & " CustCode " & IVr.CustCode);
			end;
		end;	
	end;
return;
end;





global
webpublic updating procedure WebClearOldClassInGlobalItems()
begin
	record GlobalItemVc GIr,LogGIr;
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	boolean GIsavef;
	array string 255 prefixes;
	
	GIr.Code = "";
	while(loopmain(GIr,1,true))begin
		GIsavef = false;
		recordcopy(LogGIr,GIr);
		BTRxBrandr.Code = GIr.BPIBrand;
		if(!readfirstmain(BTRxBrandr,1,true) and nonblank(GIr.BPIBrand))then begin
			GIsavef = true;
			GIr.BPIBrand = "";
		end;
		BTRxMaterialr.Code = GIr.BPIMaterial;
		if(!readfirstmain(BTRxMaterialr,1,true) and nonblank(GIr.BPIMaterial))then begin
			GIsavef = true;
			GIr.BPIMaterial = "";
		end;
		BTRxPlatingr.Code = GIr.BPIPlating;
		if(!readfirstmain(BTRxPlatingr,1,true) and nonblank(GIr.BPIPlating))then begin
			GIsavef = true;
			GIr.BPIPlating = "";
		end;
		BTRxStrapr.Code = GIr.BPIStrap;
		if(!readfirstmain(BTRxStrapr,1,true) and nonblank(GIr.BPIStrap))then begin
			GIsavef = true;
			GIr.BPIStrap = "";
		end;
		BTRxColorr.Code = GIr.BPIColor;
		if(!readfirstmain(BTRxColorr,1,true) and nonblank(GIr.BPIColor))then begin
			GIsavef = true;
			GIr.BPIColor = "";
		end;
		BTRxOdourr.Code = GIr.BPIOdour;
		if(!readfirstmain(BTRxOdourr,1,true) and nonblank(GIr.BPIOdour))then begin
			GIsavef = true;
			GIr.BPIOdour = "";
		end;
		BTRxSexr.Code = GIr.BPISex;
		if(!readfirstmain(BTRxSexr,1,true) and nonblank(GIr.BPISex))then begin
			GIsavef = true;
			GIr.BPISex = "";
		end;
		BTRxSizer.Code = GIr.BPISize;
		if(!readfirstmain(BTRxSizer,1,true) and nonblank(GIr.BPIBrand))then begin
			GIsavef = true;
			GIr.BPISize = "";
		end;
		BTRxMaterialr.Code = GIr.BTRxChainMaterial;
		if(!readfirstmain(BTRxMaterialr,1,true) and nonblank(GIr.BTRxChainMaterial))then begin
			GIsavef = true;
			GIr.BTRxChainMaterial = "";
		end;
		BTRxColorr.Code = GIr.BTRxStrapColour;
		if(!readfirstmain(BTRxColorr,1,true) and nonblank(GIr.BTRxStrapColour))then begin
			GIsavef = true;
			GIr.BTRxStrapColour = "";
		end;
		BTRxColorr.Code = GIr.BTRxProdColour;
		if(!readfirstmain(BTRxColorr,1,true) and nonblank(GIr.BTRxProdColour))then begin
			GIsavef = true;
			GIr.BTRxProdColour = "";
		end;
		BTRxMaterialr.Code = GIr.BTRxChainMaterial;
		if(!readfirstmain(BTRxMaterialr,1,true) and nonblank(GIr.BTRxChainMaterial))then begin
			GIsavef = true;
			GIr.BTRxChainMaterial = "";
		end;
		BTRxStoner.Code = GIr.BTRxStoneA;
		if(!readfirstmain(BTRxStoner,1,true) and nonblank(GIr.BTRxStoneA))then begin
			GIsavef = true;
			GIr.BTRxStoneA = "";
		end;
		BTRxStoner.Code = GIr.BTRxStoneB;
		if(!readfirstmain(BTRxStoner,1,true) and nonblank(GIr.BTRxStoneB))then begin
			GIsavef = true;
			GIr.BTRxStoneB = "";
		end;
		BTRxStoner.Code = GIr.BTRxStoneC;
		if(!readfirstmain(BTRxStoner,1,true) and nonblank(GIr.BTRxStoneC))then begin
			GIsavef = true;
			GIr.BTRxStoneC = "";
		end;
		if(GIsavef)then begin
			GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 70");
			RecordStore(GIr,true);
			logtext(0,"saved " & GIr.Code);
		end else begin
			logtext(0,"ignored " & GIr.Code);
		end;
	end;
end;

global 
procedure HandleNewINDClassmVendor(var record NewINVc newINr, integer rownr)
begin
record DIVc DIr;
record INVc INr;
row NewINVc newINrw;
vector string 255 diTypes;
string 20 disp;
integer pos;
Boolean foundf,testf;
integer i,CompQty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
integer oldComp;

  
	BlockLoad(Compb);
	
	oldComp = currentcompany;
	CompQty = matrowcnt(Compb);
  if (rownr>-1) then begin
		testf = false;
    matrowget(newINr,rownr,newINrw);
		INr.Code = newINrw.VendorCode;	
		if (ReadFirstMain(INr,1,true) and INr.BPIBrand==newINr.Brand) then begin testf = true; goto FormInv; end else begin
			for (i=0;i<CompQty;i=i+1)begin
				matrowget(Compb,i,Comprw);
				if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32)then begin
					SetCompany(i+1,false);
					INr.Code = newINrw.VendorCode;	
					if (ReadFirstMain(INr,1,true) and INr.BPIBrand==newINr.Brand) then begin testf = true; goto FormInv; end;
				end;
			end;	
		end;
		FormInv:;
		if(currentcompany!=oldComp) then begin
			SetCompany(oldComp,false) 
		end;	
		if(testf) then begin
  		if(nonblank(INr.Name))then begin newINrw.Name=INr.Name;  end;
  		if(nonblank(INr.Unittext))then begin newINrw.Unittext=INr.Unittext;end;
  		if(nonblank(INr.Objects))then begin newINrw.Objects=INr.Objects;  end;
  		if(INr.UPrice1>0)then begin newINrw.UPrice1=INr.UPrice1;end;
  		if(INr.ItemType>-1)then begin newINrw.ItemType=INr.ItemType; end;
  		if(nonblank(INr.Group))then begin newINrw.Group=INr.Group;end;
  		if(INr.SerNrf>=0)then begin newINrw.SerNrf=INr.SerNrf;end;
  		if(nonblank(INr.BarCode))then begin newINrw.BarCode=INr.BarCode;end;
  		if(nonblank(INr.VATCode))then begin newINrw.VATCode=INr.VATCode;end;
  		//if(nonblank(INr.LastPurchCurncyCode))then begin newINrw.LastPurchCurncyCode=INr.LastPurchCurncyCode;end;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 09 06 2020 y. at 5:29:28 PM
  		//if(INr.LastPurchPrice2>0)then begin newINrw.LastPurchPrice2=INr.LastPurchPrice2; end;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 09 06 2020 y. at 5:29:33 PM
  		if(nonblank(INr.AlternativeCode))then begin newINrw.AlternativeCode=INr.AlternativeCode;end;
  		if(nonblank(INr.NotForSales))then begin newINrw.NotForSales=INr.NotForSales; end; 
  		if(nonblank(INr.MajStoneDet))then begin newINrw.MajStoneDet=INr.MajStoneDet;end; 
  		if(nonblank(INr.Colour))then begin newINrw.Colour=INr.Colour;end;
  		if(nonblank(INr.Metal))then begin newINrw.Metal=INr.Metal;end;
  		if(nonblank(INr.RowWeight))then begin newINrw.RowWeight=INr.RowWeight;end;
  		if(nonblank(INr.Size))then begin newINrw.Size=INr.Size;end; 
  		if(nonblank(INr.Reference))then begin newINrw.Reference=INr.Reference;end; 
  		if(nonblank(INr.CPSCode))then begin newINrw.CPSCode=INr.CPSCode;end; 
  		if (NonBlank(INr.MainDisp)) then begin
  		  newINrw.Type=INr.MainDisp;
  		  if (NonBlank(INr.DispGroups)) then begin
  		    pos = 0;
  		    foundf = false;
  		    ExtractObj(INr.DispGroups,pos,disp);
			    while(nonblank(disp)) begin
			      DIr.Code = disp;
			      if (ReadFirstMain(DIr,1,true) and NonBlank(DIr.CType)) then begin
			        if (blank(diTypes[DIr.CType])) then begin
			          diTypes[DIr.CType] = DIr.Code;
			        end else begin
			          diTypes[DIr.CType] = diTypes[DIr.CType] & "," & DIr.Code;
			        end;
			        foundf = true;
			      end;
    			  ExtractObj(INr.DispGroups,pos,disp);
    			end;
    			if (foundf) then begin
    			  if (NonBlank(diTypes[ReturnFieldDIType("BrandSC",false)])) then begin
              newINrw.BrandSC = diTypes[ReturnFieldDIType("BrandSC",false)];
            end;
            
			  if (NonBlank(diTypes[ReturnFieldDIType("Weight",false)])) then begin
              newINrw.Weight = stringtoval(diTypes[ReturnFieldDIType("Weight",false)],M4Val);
            end;
			
            if (NonBlank(diTypes[ReturnFieldDIType("Collection",false)])) then begin
              newINrw.Collection = diTypes[ReturnFieldDIType("Collection",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif30",false)])) then begin
              newINrw.classif30 = diTypes[ReturnFieldDIType("classif30",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif31",false)])) then begin
              newINrw.classif31 = diTypes[ReturnFieldDIType("classif31",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Style",false)])) then begin
              newINrw.Style = diTypes[ReturnFieldDIType("Style",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif32",false)])) then begin
              newINrw.classif32 = diTypes[ReturnFieldDIType("classif32",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("WatchType",false)])) then begin
              newINrw.WatchType = diTypes[ReturnFieldDIType("WatchType",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("GenderSC",false)])) then begin
              newINrw.GenderSC = diTypes[ReturnFieldDIType("GenderSC",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Dial",false)])) then begin
              newINrw.Dial = diTypes[ReturnFieldDIType("Dial",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Strap",false)])) then begin
              newINrw.Strap = diTypes[ReturnFieldDIType("Strap",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Material",false)])) then begin
              newINrw.Material = diTypes[ReturnFieldDIType("Material",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif33",false)])) then begin
              newINrw.classif33 = diTypes[ReturnFieldDIType("classif33",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("classif34",false)])) then begin
              newINrw.classif34 = diTypes[ReturnFieldDIType("classif34",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("PrecStones",false)])) then begin
              newINrw.PrecStones = diTypes[ReturnFieldDIType("PrecStones",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Mechanism",false)])) then begin
              newINrw.Mechanism = diTypes[ReturnFieldDIType("Mechanism",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Function",false)])) then begin
              newINrw.Function = diTypes[ReturnFieldDIType("Function",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("WaterResist",false)])) then begin
              newINrw.WaterResist = diTypes[ReturnFieldDIType("WaterResist",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Diameter",false)])) then begin
              newINrw.Diameter = diTypes[ReturnFieldDIType("Diameter",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Category",false)])) then begin
              newINrw.Category = diTypes[ReturnFieldDIType("Category",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Division",false)])) then begin
              newINrw.Division = diTypes[ReturnFieldDIType("Division",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("WeightOfMat",false)])) then begin
              newINrw.WeightOfMat = diTypes[ReturnFieldDIType("WeightOfMat",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Diamonds",false)])) then begin
              newINrw.Diamonds = diTypes[ReturnFieldDIType("Diamonds",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("DiamondsCarat",false)])) then begin
              newINrw.DiamondsCarat = diTypes[ReturnFieldDIType("DiamondsCarat",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("SolidStones05",false)])) then begin
              newINrw.SolidStones05 = diTypes[ReturnFieldDIType("SolidStones05",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("PrecAndSemiPrec",false)])) then begin
              newINrw.PrecAndSemiPrec = diTypes[ReturnFieldDIType("PrecAndSemiPrec",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("RingSizes",false)])) then begin
              newINrw.RingSizes = diTypes[ReturnFieldDIType("RingSizes",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Carat",false)])) then begin
              newINrw.Carat = diTypes[ReturnFieldDIType("Carat",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("ClaritySC",false)])) then begin
              newINrw.ClaritySC = diTypes[ReturnFieldDIType("ClaritySC",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Color",false)])) then begin
              newINrw.Color = diTypes[ReturnFieldDIType("Color",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("ColorOfMat",false)])) then begin
              newINrw.ColorOfMat = diTypes[ReturnFieldDIType("ColorOfMat",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("ShapeCut",false)])) then begin
              newINrw.ShapeCut = diTypes[ReturnFieldDIType("ShapeCut",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Description",false)])) then begin
              newINrw.Description = diTypes[ReturnFieldDIType("Description",false)];
            end;
            
            if (NonBlank(diTypes[ReturnFieldDIType("Art",false)])) then begin
              newINrw.Art = diTypes[ReturnFieldDIType("Art",false)];
            end;
    			end;
  		  end;
  		end else begin
  		  if(nonblank(INr.DispGroups))then begin newINrw.DispGroups=INr.DispGroups;end;
  		  pos = 0;
		    foundf = false;
		    ExtractObj(INr.DispGroups,pos,disp);
		    while(nonblank(disp)) begin
		      DIr.Code = disp;
		      if (ReadFirstMain(DIr,1,true) and NonBlank(DIr.CType)) then begin
		        if (blank(diTypes[DIr.CType])) then begin
		          diTypes[DIr.CType] = DIr.Code;
		        end else begin
		          diTypes[DIr.CType] = diTypes[DIr.CType] & "," & DIr.Code;
		        end;
		        foundf = true;
		      end;
  			  ExtractObj(INr.DispGroups,pos,disp);
  			end;
  			if (foundf) then begin
          newINrw.BrandSC = diTypes[ReturnFieldDITypeNotJW("BrandSC")];  
          newINrw.classif30 = diTypes[ReturnFieldDITypeNotJW("classif30")];
          newINrw.Category = diTypes[ReturnFieldDITypeNotJW("Category")];
          newINrw.classif31 = diTypes[ReturnFieldDITypeNotJW("classif31")];
          newINrw.Collection = diTypes[ReturnFieldDITypeNotJW("Collection")];
          newINrw.Metal = diTypes[ReturnFieldDITypeNotJW("Metal")];
          newINrw.WeightOfMat = diTypes[ReturnFieldDITypeNotJW("WeightOfMat")];
          if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Carat")])) then begin
            newINrw.Carat = diTypes[ReturnFieldDITypeNotJW("Carat")];
          end;
          if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Size")])) then begin
            newINrw.Size = diTypes[ReturnFieldDITypeNotJW("Size")];
          end;
          if (NonBlank(diTypes[ReturnFieldDITypeNotJW("Colour")])) then begin
            newINrw.Colour = diTypes[ReturnFieldDITypeNotJW("Colour")];
          end;
  			end;
  		end;
  		
		end;
	  matrowput(newINr,rownr,newINrw);
  end;

return;
end; 


global updating procedure CCColMn(record RcVc RepSpec)
begin
	record INVc INr;
	longint curtick;
	
	curtick = getcurtick();
	INr.Code = "";
	while(LoopMain(INr,1,true)) begin
		if(INr.MainDisp==RepSpec.f1) then begin
			INr.MainDisp = RepSpec.f2;
			RecordStore(INr,true);
		end;
	end;
	LogProcTime("CCColMn",getcurtick()-curtick); 
return;
end;

global 
updating procedure FillINMn(record RcVc RepSpec)
begin
record INVc INr,blINr,newINr,INTestr;
record ItemStatusVc ISr;
integer i,CompQty,oldComp;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
boolean TrHs, testf;
longint curtick;

	curtick = getcurtick();
	BlockLoad(Compb);
	
	oldComp = currentcompany;
	CompQty = matrowcnt(Compb);
	
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32 and i+1!=oldComp)then begin
			SetCompany(i+1,false);
			ISr.Location = ";;;";
			TrHs = true;
			while(LoopKey("Location",ISr,1,TrHs)) begin
				testf = true;
				if(ISr.Location!=";;;") then begin testf = false; TrHs = false; end;
				if(ISr.Instock>0) then begin testf = false; end;
				if(testf) then begin 
					INr.Code = ISr.Code;
					if(ReadFirstMain(INr,1,true)) then begin
						logtext(0,"needtocreate" & INr.Code);
						setCompany(oldComp,false);
						INtestr.Code = INr.Code;
						If(ReadFirstMain(INtestr,1,true)==false) then begin
							RecordNew(blINr);
							recordcopy(newINr,INr);
							newINr.UUID = blINr.UUID;
							logtext(0,"create" & INr.Code);
							RecordStore(newINr,true);
						end else begin
							logtext(0,"Can't create " & INr.Code & " This Item was in consygnation company!");
						end;
						SetCompany(i+1,false);
					end;
				end;
			end;
		end;
	end;
	LogProcTime("FillINMn",getcurtick()-curtick); 
return;
end;	

global 
updating procedure FillDIVcMn(record RcVc RepSpec)
begin
record DIVc DIr,blDIr,newDIr,DITestr;
integer i,CompQty,oldComp;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
longint curtick;

	curtick = getcurtick();
	BlockLoad(Compb);
	
	oldComp = currentcompany;
	CompQty = matrowcnt(Compb);
	
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32 and i+1!=oldComp)then begin
			SetCompany(i+1,false);
			DIr.Code = "";
			while(LoopMain(DIr,1,true)) begin
				logtext(0,"needtocreate " & DIr.Code);
				setCompany(oldComp,false);
				DITestr.Code = DIr.Code;
				If(ReadFirstMain(DITestr,1,true)==false) then begin
					RecordNew(blDIr);
					recordcopy(newDIr,DIr);
					newDIr.UUID = blDIr.UUID;
					logtext(0,"create" & newDIr.Code);
					RecordStore(newDIr,true);
				end else begin
					logtext(0,"Can't create " & DIr.Code & " This Classification was in consygnation company!");
				end;
				SetCompany(i+1,false);;
			end;
		end;
	end;
	LogProcTime("FillDIVcMn",getcurtick()-curtick); 
return;
end;	

global 
updating procedure FillITVcMn(record RcVc RepSpec)
begin
record ITVc ITr,blITr,newITr,ITTestr;
integer i,CompQty,oldComp;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
longint curtick;

	curtick = getcurtick();
	BlockLoad(Compb);
	
	oldComp = currentcompany;
	CompQty = matrowcnt(Compb);
	
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32 and i+1!=oldComp)then begin
			SetCompany(i+1,false);
			ITr.Code = "";
			while(LoopMain(ITr,1,true)) begin
				logtext(0,"needtocreate " & ITr.Code);
				setCompany(oldComp,false);
				ITTestr.Code = ITr.Code;
				If(ReadFirstMain(ITTestr,1,true)==false) then begin
					RecordNew(blITr);
					recordcopy(newITr,ITr);
					newITr.UUID = blITr.UUID;
					logtext(0,"create" & newITr.Code);
					RecordStore(newITr,true);
				end else begin
					logtext(0,"Can't create " & ITr.Code & " This item group was in consygnation company!");
				end;
				SetCompany(i+1,false);;
			end;
		end;
	end;
	LogProcTime("FillITVcMn",getcurtick()-curtick); 
return;
end;	


updating procedure DellRHistLastYearMn()
begin
record RHistVc RHr;
record IVVc IVr;
string 200 tstr;
boolean testf,TrHs,TrHs2,f;
record StockMovVc SMr;
record INTransferVc INTr;
record DIVc DIr;
record INVc INr;
record CUVc CUr;
record POVc POr;
record OPVc OPr;
record IPVc IPr;
record VIVc VIr;
record ERVc ERr;
record RetPUVc RetPUr;
record CLInVc CLInr;
record CLOutVc CLOutr;
record AccessVc Accessr;
record PLDefVc PLDefr;
record ObjVc Objr;
record ORVc ORr;
record StockTakeVc STr;
record PLVc PLr;
record PFormVc PFr;
record RebVc Rebr;
record RetVc Retr;
record SHVc SHr;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
integer compnr,CompQty,i;

blockload(Compb);
compnr = currentcompany;
CompQty = matrowcnt(Compb);
for (i=0;i<CompQty;i=i+1)begin
	matrowget(Compb,i,Comprw);
	if(Comprw.ActiveStatus==0)then begin
		SetCompany(i+1,true);
		Rebr.Code = "";
		while(LoopMain(Rebr,1,true)) begin
			tstr = BuildRecordIdStr(Rebr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						// logtext(0,"Rebr");
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(Rebr);
		SHr.SerNr = "";
		while(LoopMain(SHr,1,true)) begin
				tstr = BuildRecordIdStr(SHr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/07/2019"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						// logtext(0,"SHr");
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
			ResetLoop(SHr);
		Retr.SerNr = "";
		while(LoopMain(Retr,1,true)) begin	
				tstr = BuildRecordIdStr(Retr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		resetloop(Retr);
		ORr.SerNr = "";
		while(LoopMain(ORr,1,true)) begin
		tstr = BuildRecordIdStr(ORr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		resetLoop(ORr);
		PLDefr.Code = "";
		while(LoopMain(PLDefr,1,true)) begin
		tstr = BuildRecordIdStr(PLDefr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		resetloop(PLDefr);
		CLOutr.SerNr = "";
		while(LoopMain(CLOutr,1,true)) begin
		tstr = BuildRecordIdStr(CLOutr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(CLOutr);
		CLInr.SerNr = "";
		while(LoopMain(CLInr,1,true)) begin
		tstr = BuildRecordIdStr(CLInr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		resetLoop(CLInr);
		RetPUr.SerNr = "";
		while(LoopMain(RetPUr,1,true)) begin
		tstr = BuildRecordIdStr(RetPUr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(RetPUr);
		OPr.SerNr = "";
		while(LoopMain(OPr,1,true)) begin
		tstr = BuildRecordIdStr(OPr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(OPr);
		VIr.SerNr = "";
		while(LoopMain(VIr,1,true)) begin
				tstr = BuildRecordIdStr(VIr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				
				ResetLoop(RHr);
		end;
		ResetLoop(VIr);

			IPr.SerNr = "";
		while(LoopMain(IPr,1,true)) begin
				tstr = BuildRecordIdStr(IPr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(IPr);
		POr.SerNr = "";
		while(LoopMain(POr,1,true)) begin
		tstr = BuildRecordIdStr(POr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(POr);
		IVr.SerNr = "";
		while(LoopMain(IVr,1,true)) begin
		tstr = BuildRecordIdStr(IVr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(IVr);
		
		SMr.SerNr = "";
		while(LoopMain(SMr,1,true)) begin
				tstr = BuildRecordIdStr(SMr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(SMr);
		INTr.SerNr = "";
		while(LoopMain(INTr,1,true)) begin
				tstr = BuildRecordIdStr(INTr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
				ResetLoop(RHr);
		end;
		ResetLoop(INTr);
		STr.SerNr = "";
		while(LoopMain(STr,1,true)) begin
				tstr = BuildRecordIdStr(STr,i+1);
				RHr.RecidStr = tstr;
				TrHs = true;
				while (LoopKey("RecidStr",RHr,1,TrHs)) begin
					testf = true;
					if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
					if(testf) then begin
						recorddelete(RHr);
						stepback(RHr);
					end;
				end;	
		end;
		ResetLoop(STr);
				if(!CompanyIsJWLikeCompany(i+1) or i+1==3) then begin
					DIr.Code = "";
					while(LoopMain(DIr,1,true)) begin
					tstr = BuildRecordIdStr(DIr,i+1);
					RHr.RecidStr = tstr;
					TrHs = true;
					while (LoopKey("RecidStr",RHr,1,TrHs)) begin
						testf = true;
						if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
						if(testf) then begin
							recorddelete(RHr);
							stepback(RHr);
						end;
					end;	
					ResetLoop(RHr);
					end;
					INr.Code = "";
					while(LoopMain(INr,1,true)) begin
					tstr = BuildRecordIdStr(INr,i+1);
					RHr.RecidStr = tstr;
					TrHs = true;
					while (LoopKey("RecidStr",RHr,1,TrHs)) begin
						testf = true;
						if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
						if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
						if(testf) then begin
							recorddelete(RHr);
							stepback(RHr);
						end;
					end;	
					ResetLoop(RHr);
					end;
					ResetLoop(INr);
					PLr.PLCode = "";
				while(LoopMain(PLr,1,true)) begin
					tstr = BuildRecordIdStr(PLr,i+1);
					RHr.RecidStr = tstr;
					TrHs = true;
					while (LoopKey("RecidStr",RHr,1,TrHs)) begin
						testf = true;
						if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
						if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
						if(testf) then begin
							recorddelete(RHr);
							stepback(RHr);
						end;
					end;	
				end;
				ResetLoop(INr);
				PFr.Code = "";
				while(LoopMain(PFr,1,true)) begin
					tstr = BuildRecordIdStr(PFr,i+1);
					RHr.RecidStr = tstr;
					TrHs = true;
					while (LoopKey("RecidStr",RHr,1,TrHs)) begin
						testf = true;
						if(RHr.TransDate<stringtodate("31/12/2018"))then begin testf = false; end;
						if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
						if(testf) then begin
							recorddelete(RHr);
							stepback(RHr);
						end;
					end;	
					ResetLoop(RHr);
				end;
				ResetLoop(PFr);
				end;
				// 18,29,30,31
				if(i+1!=29 or i+1!=30 or i+1!=31) then begin
					ERr.CurncyCode = "";
				while(LoopMain(ERr,1,true)) begin
					tstr = BuildRecordIdStr(ERr,i+1);
					RHr.RecidStr = tstr;
					TrHs = true;
					while (LoopKey("RecidStr",RHr,1,TrHs)) begin
						testf = true;
						if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
						if(testf) then begin
							recorddelete(RHr);
							stepback(RHr);
						end;
					end;
					ResetLoop(RHr);
				end;
				ResetLoop(ERr);
				end;	
				//  ------------------------------------------------- 
				if(i+1==1) then begin
					Objr.Code = "";
					while(LoopMain(Objr,1,true)) begin
					tstr = BuildRecordIdStr(Objr,i+1);
					RHr.RecidStr = tstr;
					TrHs = true;
					while (LoopKey("RecidStr",RHr,1,TrHs)) begin
						testf = true;
						if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
						if(testf) then begin
							recorddelete(RHr);
							stepback(RHr);
						end;
					end;	
					ResetLoop(RHr);
					end;
					Accessr.Code = "";
					while(LoopMain(Accessr,1,true)) begin
					tstr = BuildRecordIdStr(Accessr,currentcompany);
					RHr.RecidStr = tstr;
					TrHs = true;
					while (LoopKey("RecidStr",RHr,1,TrHs)) begin
						testf = true;
						if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
						if(testf) then begin
							recorddelete(RHr);
							stepback(RHr);
						end;
					end;	
					ResetLoop(RHr);
					end;
					CUr.Code = "";
					while(LoopMain(CUr,1,true)) begin
					tstr = BuildRecordIdStr(CUr,i+1);
					RHr.RecidStr = tstr;
					TrHs = true;
					while (LoopKey("RecidStr",RHr,1,TrHs)) begin
						testf = true;
						if(RHr.TransDate>stringtodate("31/12/2018"))then begin testf = false; end;
						if(RHr.RecidStr!=tstr) then begin TrHs = false; testf = false; end;
						if(testf) then begin
							recorddelete(RHr);
							stepback(RHr);
						end;
					end;	
					ResetLoop(RHr);
					end;
				end;	
	end;	
end;	
return;
end;





global 
updating procedure FillHansacodeTPMn()
begin
	record GlobalItemVc GIr,LogGIr;
	boolean TrHs;

	TrHs = true;
	GIr.Code = "TP1";
	while (LoopMain(GIr,1,TrHs)) begin
		if(left(GIr.Code,2)!="TP")then begin TrHs = false; end;
		if(TrHs)then begin
			recordcopy(LogGIr,GIr);
			GIr.HansaCode = GIr.Code;
			GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 71");
			recordStore(GIr,true);
		end;
	end;
return;
end;



global 
updating procedure CountRHistLastYearMn()
begin
	record RHistVc RHr;
	integer cnt,i;
	LongInt cntNew;
	area test;
	boolean TrHs;
	string 100 bit,reg;
	boolean testf,testf1;
	vector LongInt countreg;
	LongInt all;
	array string 200 tag;
	cnt = 0;
	TrHs = true;
	cntNew = 0;
	all = 0;
	logtext(0,"start");
	while (LoopMain(RHr,1,TrHs)) begin
		reg = "";
		testf = true;
		bit = mid(RHr.RecidStr,0,1);
		i = 1;
		while(testf) begin
			if(ASC(mid(RHr.RecidStr,StringToInt(ASC(bit))+i,1))==0) then begin testf = false; end;
			if(testf) then begin
				reg = reg & mid(RHr.RecidStr,StringToInt(ASC(bit))+i,1);
				i=i+1;
				cnt = cnt+1;
			end;	
		end;	
		if(bit==" ") then begin recorddelete(RHr); stepback(RHr); end;
		if(bit=="") then begin recorddelete(RHr); stepback(RHr); end;
		if(ASC(reg)==32) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="") then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="") then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="INVc" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="IVVc" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="STOCKMOVVC") then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="CUVc" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="LOYALTYCARDVC") then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="RETVC" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="CLOUTVC" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="RETPUVC" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="DIVC") then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="TRVC" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="PUVc" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="POVc" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="IPVC" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="SHVc" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="VIVc" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="OPVC" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="ERVC" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
		if(reg=="SDVC" and RHr.TransDate<stringtodate("31/12/2018")) then begin recorddelete(RHr); stepback(RHr); end;
	end;	
	logtext(0,"end");
return;
end;


global 
updating procedure FillClassMn(record RcVc RepSpec)
begin
record ITVc ITr,blITr,newITr,ITTestr;
integer i,CompQty,oldComp;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
record DIVc DIr,blDIr,newDIr,DITestr;
record CTypeVc CTyper,blCTyper,newCTyper,CTypeTestr;
longint curtick;

	curtick = getcurtick();
	BlockLoad(Compb);
	
	oldComp = currentcompany;
	CompQty = matrowcnt(Compb);
	
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32 and i+1!=29 and i+1!=oldComp)then begin
			SetCompany(i+1,false);
			ITr.Code = "";
			while(LoopMain(ITr,1,true)) begin
				logtext(0,"needtocreate " & ITr.Code);
				setCompany(oldComp,false);
				ITTestr.Code = ITr.Code;
				If(ReadFirstMain(ITTestr,1,true)==false) then begin
					RecordNew(blITr);
					recordcopy(newITr,ITr);
					newITr.UUID = blITr.UUID;
					logtext(0,"create" & newITr.Code);
					RecordStore(newITr,true);
				end else begin
					logtext(0,"Can't create " & ITr.Code & " This item group was in consygnation company!");
				end;
				SetCompany(i+1,false);;
			end;
			ResetLoop(ITr);
			SetCompany(i+1,false);
			DIr.Code = "";
			while(LoopMain(DIr,1,true)) begin
				logtext(0,"needtocreate " & DIr.Code);
				setCompany(oldComp,false);
				DITestr.Code = DIr.Code;
				If(ReadFirstMain(DITestr,1,true)==false) then begin
					RecordNew(blDIr);
					recordcopy(newDIr,DIr);
					newDIr.UUID = blDIr.UUID;
					logtext(0,"create" & newDIr.Code);
					RecordStore(newDIr,true);
				end else begin
					logtext(0,"Can't create " & DIr.Code & " This Classification was in consygnation company!");
				end;
				SetCompany(i+1,false);;
			end;
			ResetLoop(DIr);
			SetCompany(i+1,false);
			CTyper.Code = "";
			while(LoopMain(CTyper,1,true)) begin
				logtext(0,"needtocreate " & CTyper.Code);
				setCompany(oldComp,false);
				CTypeTestr.Code = CTyper.Code;
				If(ReadFirstMain(CTypeTestr,1,true)==false) then begin
					recordcopy(newCTyper,CTyper);
					logtext(0,"create" & newCTyper.Code);
					RecordStore(newCTyper,true);
				end else begin
					logtext(0,"Can't create " & CTyper.Code & " This Classification was in consygnation company!");
				end;
				SetCompany(i+1,false);;
			end;
			ResetLoop(CTyper);
		end;
	end;
	LogProcTime("FillClassMn",getcurtick()-curtick); 
return;
end;	

global updating procedure ReplaceGiftsFromGiftFieldToCatThrdLvlMn(record RcVc RepSpec)
begin
integer i,curcomp,cnt,j,k;
record GlobalItemVc GIr,oldGIr,LogGIr;
string 100 item,oldBrand,newBrand,code,glCode;
longint curtick;

	curtick = getcurtick();
	GIr.Code = "";
	while (loopmain(GIr,1,true)) begin
		if(nonblank(GIr.BTRxGiftClass)) then begin
			if(nonblank(GIr.BTRxThirdLevCat))then begin GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ","; end;
			recordcopy(LogGIr,GIr);
			GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & GIr.BTRxGiftClass;
			GIWasUpdated(GIr,LogGIr," GIWasUpdatedlog 72");
			if(RecordStore(GIr,true)) then begin
				logtext (0,GIr.Code);
			end;
		end;
	end;
	LogProcTime("ReplaceGiftsFromGiftFieldToCatThrdLvlMn",getcurtick()-curtick); 
return;
end;






global updating procedure FillNames2CatLvlin3CatLvlrelationMn(record RcVc RepSpec)
begin
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	longint curtick;
	
	curtick = getcurtick();
	BtrxThirdLevelCatr.Code = "";
	while (loopmain(BtrxThirdLevelCatr,1,true)) begin
		if(nonblank(BtrxThirdLevelCatr.PathScndCode))then begin
			BtrxSecondLevelCatr.Code = BtrxThirdLevelCatr.PathScndCode;
			if(ReadFirstMain(BtrxSecondLevelCatr,1,true))then begin
				BtrxThirdLevelCatr.CatSecLvlName = BtrxSecondLevelCatr.Name;
				if(RecordStore(BtrxThirdLevelCatr,true))then begin
				end;
			end;
		end;
	end;
	
	LogProcTime("FillNames2CatLvlin3CatLvlrelationMn",getcurtick()-curtick); 
return;
end;




global updating procedure CleanConsItemsMn(record RcVc RepSpec)
begin
	record INVc INr;
	record ConsItemVc CIr;
	integer OldComp;
	longint curtick;
	
	curtick = getcurtick();
	OldComp = CurrentCompany;
	SetCompany(18,false);
	INr.Code = "";
	while (loopmain(INr,1,true)) begin
		if(blank(INr.BPIBrand))then begin
			CIr.Code = INr.Code;
			if(ReadFirstmain(CIr,1,true))then begin
				RecordDelete(CIr);
				RecordDelete(INr);
				StepBack(INr);
			end else begin
				RecordDelete(INr);
				StepBack(INr);
			end;
		end;
	end;
	ResetCompany(OldComp);
	
	LogProcTime("CleanConsItemsMn",getcurtick()-curtick); 
return;
end;

global updating procedure CollectConsItemsMn(record RcVc RepSpec)
begin
	record INVc INr, ConsINr, OldConsINr, UINr;
	record ItemHistVc IHr;
	boolean TrHs,testf,datef,anndemaatef,compf,INCodef,CustCodef;
	record IVVc IVr;
	row IVVc IVrw;
	vector val SaleMon;
	integer pos,mtrw,y,months,i,MonSep,AnnDem,IVqty,POPlacingTime,Year,Margin,currcomp,compmtrw,j,CompDem,oldDemComp,brcnt,br,Quart,posdem;
	string 255 cmd,sCategory,sBrand,sType,sBrandName,BrDemPl,DeadCode,NPCode,DemComp,sCompName,oldCode;
	date backdate,trdate,AnnDemDate,FrontDate;
	val basesum, middleitprice,basesumprice,LTd;
	vector integer Mon;
	record CUVc CUr;
	vector val brandleadtime;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	longint quant, INq, k;
	array string 255 INCode,arBR;
	vector string 255 INmatstrv, CalculatedLeadTime,MonName,vItemComp;
	vector integer arComp, YearMonSep;
	vector boolean vDemComp, SalesThrYf, SalesOneYf,vPOItems;
	record UserVc USr;
	boolean CompItemf, TrHs2, TrHs1;
	integer OldComp,stop;
	record ConsItemVc CIr;
	record POVc POr;
	row POVc POrw;
	integer company;
	record ITVc ITr,blITr,newITr,ITTestr;
	record DIVc DIr,blDIr,newDIr,DITestr;
	record CTypeVc CTyper,blCTyper,newCTyper,CTypeTestr;
	longint curtick;
	
	curtick = getcurtick();
	
	
	backdate = AddYear(CurrentDate,-3);
	backdate.month = 1;
	backdate.day = 1;
	if(nonblank(RepSpec.f1)) then begin
		company = stringtoint(RepSpec.f1);
	end else begin company = 0; end;
	BlockLoad(Compb);
	compmtrw = matrowcnt(Compb);
	for (j=0;j<compmtrw;j=j+1)begin
		matrowget(Compb,j,Comprw);
		if(Comprw.ActiveStatus==0 and ((j+1)!=32) and (((j+1)<29) and((company==0) or (company==j+1)) or (j+1)==31))then begin
			SetCompany(j+1,false);
			logtext(0,"SetCompany " & j+1);
			TrHs = true;
			POr.TransDate = CurrentDate;
			POr.SerNr = 99999999999999999;
			while (loopbackkey("TransDate",POr,2,TrHs) and blank(RepSpec.f4)) begin
				if(POr.TransDate < AddYear(CurrentDate,-1))then begin TrHs = false; end;
				if(TrHs)then begin
					mtrw = matrowcnt(POr);
					for (i=0;i<mtrw;i=i+1) begin
						matrowget(POr,i,POrw);
						if(nonblank(POrw.ArtCode))then begin
							vPOItems[POrw.ArtCode] = true;
							// logtext(0,"POItem " & POr.SerNr & " " & POrw.ArtCode);
						end;
					end;
				end;
			end;
			resetloop(POr);
			resetloop(INr);
			if(nonblank(RepSpec.f2)) then begin 
				INr.Code = RepSpec.f2;
			end else begin INr.Code  = ""; end;
			TrHs1 = true;
			while(loopmain(INr,1,TrHs1))begin
				if(fileexists("stop"))then begin 
					TrHs1 = false; 
					logtext(0,"stop file exists");
				end;
				if(nonblank(RepSpec.f2) and INr.Code!=RepSpec.f2) then begin TrHs1=false; end;
				testf = true;
				if(INr.Terminated==1)then begin testf = false; end;
				if(setinset("30",INr.DispGroups))then begin testf = false; end;
				if(setinset("31",INr.DispGroups))then begin testf = false; end;
				if(setinset("32",INr.DispGroups))then begin testf = false; end;
				if(setinset("33",INr.DispGroups))then begin testf = false; end;
				if(setinset("34",INr.DispGroups))then begin testf = false; end;
				if(setinset("35",INr.DispGroups))then begin testf = false; end;
				if(blank(INr.BPIBrand))then begin testf = false; end;
				if(INr.ItemCat=="O" or INr.ItemCat=="D")then begin testf = false; end;
				
				
				if(INr.ConsgType!=0)then begin
					testf = false;
				end;
				if(blank(INr.BPIBrand))then begin
					testf = false;
				end;
				if(testf)then begin
					OldComp = currentcompany;
					SetCompany(18,false);
					CIr.LocCode = INr.Code;
					CIr.BrandCode = INr.BPIBrand;
					if(ReadFirstKey("LocCodeBrand",CIr,2,true))then begin
						testf = false;
					end;
					ResetCompany(OldComp);
				end;
				
				if(testf)then begin
					FrontDate = currentdate;
					FrontDate.day = 31;
					FrontDate.month = 12;
					
					IHr.ArtCode = INr.Code;
					IHr.TransDate = FrontDate;
					MonSep = 1;
					basesumprice = 0;
					IVqty = 0;
					TrHs = true;
					quant = 0;
					CustCodef = false;
					while (loopbackkey("ArtCode",IHr,2,TrHs) and blank(RepSpec.f4)) begin
						if(IHr.ArtCode!=INr.Code)then begin TrHs = false; end;
						if(IHr.TransDate<backdate)then begin TrHs = false; end;
						/*INCodef = true;
						for (k=0;k<INCode.length;k=k+1)begin
							if(INCode[k]==INr.Code or blank(INr.Code))then begin INCodef = false; k = INq + 1; end;
						end;
						
						if(INCodef)then begin
							INCode[INq] = INr.Code;
							INq = INq + 1;
						end;*/
						if(IHr.FileName=="IVVc" and TrHs)then begin
							IVr.SerNr = IHr.TransNr;
							CustCodef = true;
							TrHs = false;
							/*if(readfirstmain(IVr,1,true))then begin
								if(!setinset("FOB",IVr.CustCode))then begin 
									CustCodef = true;
									
								end;
							end;*/
						end;
					end;
					resetloop(IHr);
					OldComp = currentcompany;
					if(CustCodef or vPOItems[INr.Code] and nonblank(INr.BPIBrand))then begin
						SetCompany(18,false);
						recordNew(UINr);
						recordNew(ConsINr);
						RecordCopy(ConsINr,INr);
						OldConsINr.Code = "IN_9999999";
						TrHs2 = true;
						while (LoopBackKey("Code",OldConsINr,1,TrHs2)) begin
							OldCode = OldConsINr.Code;
							TrHs2 = false;
						end;
						ResetLoop(OldConsINr);
						if(left(OldCode,2)!="IN") then begin oldCode = "IN_0000000"; end;
						NextM4SerialNumber(OldCode,ConsINr.Code);
						ConsINr.UUID = UINr.UUID;
						if(blank(ConsINr.BarCode)) then begin
							ConsINr.BarCode = ConsINr.AlternativeCode;
						end;
						ConsINr.AlternativeCode = INr.Code;
						CIr.LocCode = INr.Code;
						CIr.BrandCode = ConsINr.BPIBrand;
						if(!ReadFirstKey("LocCodeBrand",CIr,2,true))then begin
							if(RecordStore(ConsINr,true))then begin
								// logtext(0,ConsINr.Code & " Code");
								recordNew(CIr);
								CIr.Code = ConsINr.Code;
								CIr.LocCode = INr.Code;
								CIr.BrandCode = ConsINr.BPIBrand;
								RecordStore (CIr,true);
							end;
						end;
						ResetCompany(OldComp);
					end;
				end;
			end;
			ResetLoop(INr);
			SetCompany(j+1,false);
			ITr.Code = "";
			while(LoopMain(ITr,1,true)) begin
				logtext(0,"needtocreate " & ITr.Code);
				setCompany(18,false);
				ITTestr.Code = ITr.Code;
				If(ReadFirstMain(ITTestr,1,true)==false) then begin
					RecordNew(blITr);
					recordcopy(newITr,ITr);
					newITr.UUID = blITr.UUID;
					logtext(0,"create" & newITr.Code);
					RecordStore(newITr,true);
				end else begin
					logtext(0,"Can't create " & ITr.Code & " This item group was in consygnation company!");
				end;
				SetCompany(j+1,false);
			end;
			ResetLoop(ITr);
			SetCompany(j+1,false);
			DIr.Code = "";
			while(LoopMain(DIr,1,true)) begin
				logtext(0,"needtocreate " & DIr.Code);
				setCompany(18,false);
				DITestr.Code = DIr.Code;
				If(ReadFirstMain(DITestr,1,true)==false) then begin
					RecordNew(blDIr);
					recordcopy(newDIr,DIr);
					newDIr.UUID = blDIr.UUID;
					logtext(0,"create" & newDIr.Code);
					RecordStore(newDIr,true);
				end else begin
					logtext(0,"Can't create " & DIr.Code & " This Classification was in consygnation company!");
				end;
				SetCompany(j+1,false);;
			end;
			ResetLoop(DIr);
			SetCompany(j+1,false);
			CTyper.Code = "";
			while(LoopMain(CTyper,1,true)) begin
				logtext(0,"needtocreate " & CTyper.Code);
				setCompany(18,false);
				CTypeTestr.Code = CTyper.Code;
				If(ReadFirstMain(CTypeTestr,1,true)==false) then begin
					recordcopy(newCTyper,CTyper);
					logtext(0,"create" & newCTyper.Code);
					RecordStore(newCTyper,true);
				end else begin
					logtext(0,"Can't create " & CTyper.Code & " This Classification was in consygnation company!");
				end;
				SetCompany(j+1,false);;
			end;
			ResetLoop(CTyper);
		end;
	end;
	ReSetCompany(18);
	LogProcTime("CollectConsItemsMn",getcurtick()-curtick); 
return;
end;


global updating procedure CheckItemCC(var record newINVc newINr, integer rownr)
begin
	integer i,mtrw,oldComp,CompQty;
	record INVc OldINr,tmpINr,INr;
	row NewINVc newINrw,newIN2rw;
	boolean res,testf,TrHs;
	record BPIBrandVc BBr;
	string 200 new,old;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	record ConsItemVc CIr;
	record RcVc RepSpec;
	BlockLoad(Compb);
	
	oldComp = CurrentCompany;
	CompQty = matrowcnt(Compb);
		matrowget(newINr,rownr,newINrw);
		
		CIr.LocCode = newINrw.VendorCode;
		CIr.BrandCode = newINr.Brand;
		if(ReadfirstKey("LocCodeBrand",CIr,2,true)) then begin
				newINrw.Code = CIr.Code;
				matrowput(newINr,rownr,newINrw);
				HandleNewIN2DClassCode(newINr,rownr);
				matrowget(newINr,rownr,newINrw);
				if (newINrw.VendorCode=="8050844829314" or newINrw.VendorCode=="8050844436895") then begin 
					logtext(0,newINrw.Code & " CODE");
					logtext(0,CIr.Code & " CODE2");
				end;
		end else begin
			INr.Code = newINrw.VendorCode;
			if(ReadFirstMain(INr,1,true)) then begin
				if(INr.BPIBrand==newINr.Brand) then begin
					newINrw.Code = INr.Code;
					matrowput(newINr,rownr,newINrw)
					HandleNewIN2DClassCode(newINr,rownr);
					goto skipsearch;
				end;	
			end;	
			for (i=0;i<CompQty;i=i+1)begin
				matrowget(Compb,i,Comprw);
				if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32)then begin
					SetCompany(i+1,false);
					tmpINr.Code = newINrw.VendorCode;
					if(ReadFirstMain(tmpINr,1,true)) then begin
						if(tmpINr.BPIBrand==newINr.Brand/* and nonblank(tmpINr.BPISubGroup)*/) then begin
							if(rownr==0) then begin
									//newINrw.Code = tmpINr.Code;
									//matrowput(newINr,rownr,newINrw);
									HandleNewIN2DClassCode(newINr,rownr);
									matrowget(newINr,rownr,newINrw);
									//ResetLoop(OldINr);
									//NextM4SerialNumber(old,new);
									//newINrw.Code = new;
									matrowput(newINr,rownr,newINrw);
							end else begin	
								//newINrw.Code = tmpINr.Code;
								//matrowput(newINr,rownr,newINrw);
								HandleNewIN2DClassCode(newINr,rownr);	
								//matrowget(newINr,rownr-1,newIN2rw);
								//NextM4SerialNumber(newIN2rw.Code,newINrw.Code);
								//matrowput(newINr,rownr,newINrw);
							end;
							/* RepSpec.f1 = currentcompany;
							RepSpec.f2 = tmpINr.Code;
							RepSpec.f3 = 1;
							CollectConsItemsMn(RepSpec);*/ // Edit ___________________________________ABR 10.02.2020 12:26
						end;	
					end;	
				end;
			end;
			matrowget(newINr,rownr,newINrw);
			if (newINrw.VendorCode=="8050844829314" or newINrw.VendorCode=="8050844436895") then begin 
				logtext(0,newINrw.Code & " CODE3");
				logtext(0,tmpINr.Code  & " CODE4");
			end;
		end;	
	SetCompany(oldComp,false);
	skipsearch:;
return;
end;	






global procedure CheckItemIDEACC(var record IDEANewINVc IDEANewINr, integer rownr)
begin
	integer i,mtrw,oldComp,CompQty;
	record INVc OldINr,tmpINr,INr;
	row IDEANewINVc IDEANewINrw,IDEANewIN2rw;
	boolean res,testf,TrHs;
	record BPIBrandVc BBr;
	string 200 new,old;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	record ConsItemVc CIr;
	record RcVc RepSpec;
	BlockLoad(Compb);
	
	oldComp = CurrentCompany;
	CompQty = matrowcnt(Compb);
		matrowget(IDEANewINr,rownr,IDEANewINrw);
		
		CIr.LocCode = IDEANewINrw.VendorCode;
		// CIr.BrandCode = IDEANewINr.Brand;
		if(ReadfirstKey("LocCodeBrand",CIr,1,true)) then begin
				IDEANewINrw.Code = CIr.Code;
				matrowput(IDEANewINr,rownr,IDEANewINrw)
				HandleIDEANewIN2DClassCode(IDEANewINr,rownr);
				matrowget(IDEANewINr,rownr,IDEANewINrw);
				matrowput(IDEANewINr,rownr,IDEANewINrw);
		end else begin
			INr.Code = IDEANewINrw.Code;
			if(ReadFirstMain(INr,1,true)) then begin
				IDEANewINrw.Code = INr.Code;
				matrowput(IDEANewINr,rownr,IDEANewINrw)
				HandleIDEANewIN2DClassCode(IDEANewINr,rownr);
				matrowget(IDEANewINr,rownr,IDEANewINrw);
				matrowput(IDEANewINr,rownr,IDEANewINrw);
				goto IDEAskipsearch;
			end;	
			SetCompany(28,false);
			tmpINr.Code = IDEANewINrw.VendorCode;
			if(ReadFirstMain(tmpINr,1,true)) then begin
				HandleIDEANewIN2DClassCode(IDEANewINr,rownr);
				matrowget(IDEANewINr,rownr,IDEANewINrw);
				matrowput(IDEANewINr,rownr,IDEANewINrw);
			end;	
		end;	
	SetCompany(oldComp,false);
	IDEAskipsearch:;
return;
end;	






global procedure CheckItemCCBeforCreate(var record newINVc newINr, integer rownr)
begin
	integer i,mtrw,oldComp,cnt;
	record INVc OldINr,tmpINr,INr;
	row NewINVc newINrw,newIN2rw;
	boolean res,testf,TrHs;
	record BPIBrandVc BBr;
	string 200 new,old;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	record ConsItemVc CIr;
	string 255 code,oldCode;
	BlockLoad(Compb);
	matrowget(newINr,rownr,newINrw);
	if(blank(newINrw.Code) and newINrw.ConsgType!=4 and newINrw.ConsgType!=3) then begin
		OldINr.Code = "IN_9999999";
		TrHs = true;
		while (LoopBackKey("Code",OldINr,1,TrHs)) begin
			if(TrHs) then begin
				oldCode = OldINr.Code;
			end;	
			TrHs = false;
		end;
		resetLoop(OldINr);
		NextM4SerialNumber(oldCode,code);
		newINrw.Code = code;
	end;
	matrowput(newINr,rownr,newINrw);
return;
end;	

global updating procedure FillNameThirdClassMn(record RcVc RepSpec)
begin
	record BtrxThirdLevelCatVc BtrxThr;
	record BtrxSecondLevelCatVc BtrxSecr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer compQty,currcomp,i;
	longint curtick;
	
	curtick = getcurtick();
	blockload(Compb);
	CompQty = matrowcnt(Compb);
	currcomp = currentcompany;
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32)then begin
			SetCompany(i+1,false);
			BtrxThr.Code = "";
			While(loopMain(BtrxThr,1,true))begin
				BtrxSecr.Code = BtrxThr.PathScndCode;
				if(ReadFirstMain(BtrxSecr,1,true)) then begin
					BtrxThr.CatSecLvlName = BtrxSecr.Name;
					RecordStore(BtrxThr,true);
				end;	
			end;
		end;
	end;	
SetCompany(currcomp,false);
LogProcTime("FillNameThirdClassMn",getcurtick()-curtick); 
return;
end; 

global updating procedure RenDIVcFromBrandMn(record RcVc RepSpec)
begin
	record BPIBrandVc BBr;
	record DIVc DIr;
	integer oldComp,i;
	integer compnr,CompQty;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	longint curtick;
	
	curtick = getcurtick();
	oldComp = currentcompany;
	blockload(Compb);
	
	CompQty = matrowcnt(Compb);
	for (i=0;i<CompQty;i=i+1)begin
		matrowget(Compb,i,Comprw);
		if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3))then begin
			SetCompany(i+1,false);
			BBr.Code = "";
			while (loopmain(BBr,1,true)) begin
				DIr.Code = BBr.Code;
				if(ReadFirstMain(DIr,1,true)) then begin
					DIr.Name = BBr.Name;
					RecordStore(DIr,true);
				end;
			end;
			ResetLoop(BBr);
		end;
	end;				
	SetCompany(oldComp,false);
	LogProcTime("RenDIVcFromBrandMn",getcurtick()-curtick); 
return;
end; 



global webpublic updating procedure WebFindLongItemsCode()
begin
  record INVc INr;
	Integer i,oldcomp,j,CompQty,pos;
	boolean TrHs, DIf;
	string 100 class,weight,carat,tstr;
	record DIVc DIr;
	vector string 50 vweight,vcarat;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	longint curtick;
	record ItemHistVc IHr;

		curtick = getcurtick();
		BlockLoad(Compb);
		logtext(0,"WebFindLongItemsCode");
		oldcomp = CurrentCompany;
		CompQty = MatRowCnt(Compb);

		for (j=0;j<CompQty;j=j+1)begin
			matrowget(Compb,j,Comprw);
			if(Comprw.ActiveStatus==0)then begin
				setcompany(j+1,false);
				resetloop(INr);
				INr.Code = "";
				while(loopmain(INr,1,true))begin
					if(len(INr.Code)>20)then begin
						
						IHr.ArtCode = INr.Code;
						if(readfirstkey("ArtCode",IHr,1,true))then begin
							logtext(0,currentcompany & " error IN " & INr.Code & "  NOT DELETED");
							if(currentcompany==5)then begin
								recorddelete(INr);
								stepback(INr);
							end;
						end else begin
							if(currentcompany==5)then begin
								recorddelete(INr);
								stepback(INr);
							end;
							logtext(0,currentcompany & " error IN " & INr.Code & "  ================= DELETED");
						end;
					end;
				end;
			end;
		end;
		ResetCompany(oldComp);
  return;
end;

global webpublic  procedure WebFindBlankTr()
begin
record TRVc TRr;
row TRVc TRrw;
Integer i,oldcomp;
boolean found;

oldcomp = CurrentCompany;
Setcompany(28,false);
logtext(0,"start");
TRr.Number = -1;
while(LoopMain(TRr,1,true))begin
	found = true;
	for(i=0;i<matrowcnt(TRr);i=i+1) begin
		matrowget(TRr,i,TRrw);
		if(blank(TRrw.Objects)) then begin
			found = false;
		end;
	end;	
	if(!found) then begin
		logtext(0,"number- " & TRr.Number & " rec- " & TRr.IntYc);
	end;
end;
logtext(0,"end");
ResetCompany(oldComp);
return;
end;





global
procedure IDGAPRClassReportDefaults(Integer wn)
begin
  record RcVc RepSpec;
  
  DeselectWindow(wn,false);
  GetWindowRecord(wn,RepSpec);
  ReportDefaults(RepSpec,"APRClass");  
  RepSpec.ArtMode = 1;
  RepSpec.flags[1] = 1;
  RepSpec.flags[24] = 1;
	RepSpec.flags[2] = 1;
  PutWindowRecord(wn,RepSpec);
  SelectWindow(wn);
  return;
end;



global
procedure IDGPUJRClassReportDefaults(Integer wn)
BEGIN
  record RcVc RepSpec;
  
  DeselectWindow(wn,false);
  GetWindowRecord(wn,RepSpec);
  ReportDefaults(RepSpec,"PUJRClass");  
	RepSpec.ArtMode = 1;
  RepSpec.flags[1] = 1;
  RepSpec.flags[2] = 1;
  PutWindowRecord(wn,RepSpec);
  SelectWindow(wn);
  RETURN;
END;




global updating procedure ImpIdeaBrndIn()
begin
	record BPIBrandVc BPIBrandr, oldBrandr;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,color,size,OldCode;
	boolean TrHs;
	
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield0 = ImportField;
		if(nonblank(sfield0))then begin
			FormatUpperCaseCode(sfield0);
			sfield1 = ImportField;
			BPIBrandr.Name = sfield1;
			// if(ReadFirstKey("Name",BPIBrandr,1,true))then begin
				// logtext(0,BPIBrandr.Name);
			// end;
			if(!ReadFirstKey("Name",BPIBrandr,1,true))then begin
				RecordNew(BPIBrandr);
				BPIBrandr.Name = sfield1;
				BPIBrandr.IDEABrandRef = sfield0;
				if(blank(BPIBrandr.Code))then begin
					oldBrandr.Code = "BRND9999";
					TrHs = true;
					while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
						OldCode = oldBrandr.Code;
						TrHs = false;
					end;
					ResetLoop(oldBrandr);
					NextM4SerialNumber(OldCode,BPIBrandr.Code);
				end;
				RecordStore(BPIBrandr,true);
			end else begin
				FormatUpperCaseCode(sfield1);
				BPIBrandr.Name = sfield1;
				if(!ReadFirstKey("Name",BPIBrandr,1,true))then begin
					RecordNew(BPIBrandr);
					BPIBrandr.Name = sfield1;
					BPIBrandr.IDEABrandRef = sfield0;
					if(blank(BPIBrandr.Code))then begin
						oldBrandr.Code = "BRND9999";
						TrHs = true;
						while (LoopBackKey("Code",oldBrandr,1,TrHs)) begin
							OldCode = oldBrandr.Code;
							TrHs = false;
						end;
						ResetLoop(oldBrandr);
						NextM4SerialNumber(OldCode,BPIBrandr.Code);
					end;
					RecordStore(BPIBrandr,true);
				end else begin
					BPIBrandr.IDEABrandRef = sfield0;
					if(RecordStore(BPIBrandr,true)) then begin
					end;
				end;
			end;
		end;
		NextImportLine(true);
	end;
	return;
end;





