external procedure ExtractObj(string,var Integer,var string);
remote procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external function Boolean SetInSet2(string,string);
external function roundmode SetRoundMode(Integer,Integer,Integer,Integer);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
remote function boolean CompanyIsJWLikeCompany(Integer);
external function string 255 StrReplace(string,string,string);// Edit ************************** Tuesday, 3 October 2017 17:25:37
external function string 255 imgStrReplace(string);// Edit ************************** Tuesday, 10 October 2017 15:20:55
external procedure FindAndStoreINVcImgLink(record INVc,integer,var string,var string);
external  function string 100 BPICodeToName(string);
external function boolean CheckUserBrands(string,var vector boolean);
external procedure GetPriceItem(string,var val,var val);
remote function Boolean GetTempItemPrice(var val,string,var string, date,var string);
external function roundmode GetTotalRoundMode(record RoundBlock);
external function roundmode SetRoundModeD(Integer);

 
SetLangMode(LangRussian,"RUS",0); //Edit***************************Sasha2,18:20 11.12.2014


global function val ItemQtyPerDate(string artcode, date idate,string location,string serial,var val serialcost,var integer acnt,var vector val cqty,var vector val ccost,var array string acur,string brandcur)
begin
	record ItemHistVc IHr,CCIHr;
	val res;
	string 50 key;
	integer keys;
	boolean TrHs,testf;
	string 100 oldartcode,oldfilename;
	longint oldsernr;
  integer oldrow,oldinvalid,curcomp;
  record ItemStatusVc ISr;
  record SerBalVc SBr;
  vector boolean vcur;
  integer i;
  record ConsItemVc CIr;
  record INVc INr;
  //integer acnt;
  //vector val cqty,ccost;
  //array string 10 acur;
  
  For(i=0;i<acnt;i=i+1) begin
	  cqty[acur[i]] = blankval;
	  cqty[acur[i]] = blankval;
	end; 
  acnt = 0;
      
  res = 0;
  	serialcost = 0;
  	if(idate>=currentdate)then begin
  		if(nonblank(location))then begin
  			ISr.Code = artcode;
  			ISr.Location = location;
  			readfirstmain(ISr,2,true);
  			res = ISr.Instock;
  			IHr.ArtCode = artcode;
				if(nonblank(location))then begin
					IHr.Location = location;
					key = "ArtCodeLoc";
					keys = 2;
				end else begin
					key = "ArtCode";
					keys = 1;
				end;
		
				TrHs = true;
				res = 0;
				While(loopkey(key,IHr,keys,TrHs)) begin
					testf = true;
					if (IHr.ArtCode!=artcode or IHr.Location!=location or IHr.TransDate>idate) then begin testf = false; TrHs = false; end;
					if(IHr.StockAffectf<1)then begin testf = false; end;
					if(nonblank(serial) and IHr.SerialNr!=serial)then begin testf = false; end;
			
					if(testf)then begin
						if(blank(IHr.CurncyCode))then begin IHr.CurncyCode = "AZN"; end;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 11 11 2020 y. at 11:22:58 AM
						//if(left(currentuser,2)=="SA")then begin
						if(IHr.TransDate>stringtodate("1/12/2019"))then begin
							if(IHr.CurncyCode=="AZN")then begin
								curcomp = currentcompany;
								INr.Code = IHr.ArtCode;
								readfirstmain(INr,1,true);
								setcompany(18,false);
								CIr.LocCode = IHr.ArtCode;
								CIr.BrandCode = INr.BPIBrand;								
								readfirstkey("LocCodeBrand",CIr,2,true);
								CCIHr.TransDate = IHr.InDate;
								CCIHr.ArtCode = CIr.Code;
								if(readfirstkey("ArtCode",CCIHr,2,false))then begin
									if(CCIHr.TransDate==IHr.InDate and CCIHr.ArtCode==CIr.Code)then begin
										IHr.CurncyCode = CCIHr.CurncyCode;
										IHr.RemCostPriceCurncy = CCIHr.TotCostPriceCurncy / CCIHr.Qty * IHr.RemQty;
									end;
								end;
								setcompany(curcomp,false);
							end;
						end;
						//end;
					
						res = res + IHr.Qty;
						cqty[IHr.CurncyCode] = cqty[IHr.CurncyCode] + IHr.Qty;
						if(!vcur[IHr.CurncyCode])then begin
							vcur[IHr.CurncyCode] = true;
							acur[acnt] = IHr.CurncyCode;
							acnt = acnt + 1;
						end;
						if(IHr.Qty>=0)then begin
							serialcost = serialcost + IHr.TotCostPrice;
							ccost[IHr.CurncyCode] = ccost[IHr.CurncyCode] + IHr.TotCostPrice;
						end else begin
							serialcost = serialcost - IHr.TotCostPrice;
							ccost[IHr.CurncyCode] = ccost[IHr.CurncyCode] - IHr.TotCostPrice;
						end;  	
					end;
				end; 
  		end else begin
  			ISr.Code = artcode;
  			ISr.Location = ";;;";
  			readfirstmain(ISr,2,true);
  			res = ISr.Instock;
  		end;
  		if(nonblank(serial))then begin
  			SBr.Serial = serial;
  			SBr.Location = location;
  			SBr.Item = artcode;
  			readfirstmain(SBr,3,true);
  			res = SBr.Quant;
  			serialcost = SBr.CostPrice;
  		end;
  	end else begin
			IHr.ArtCode = artcode;
			if(nonblank(location))then begin
				IHr.Location = location;
				key = "ArtCodeLoc";
				keys = 2;
			end else begin
				key = "ArtCode";
				keys = 1;
			end;
		
			TrHs = true;
			While(loopkey(key,IHr,keys,TrHs)) begin
				testf = true;
				if (IHr.ArtCode!=artcode or IHr.Location!=location or IHr.TransDate>idate) then begin testf = false; TrHs = false; end;
				if(IHr.StockAffectf<1)then begin testf = false; end;
				if(nonblank(serial) and IHr.SerialNr!=serial)then begin testf = false; end;
			
				if(testf)then begin
					if(blank(IHr.CurncyCode))then begin IHr.CurncyCode = "AZN"; end;// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 11 11 2020 y. at 11:22:58 AM
					res = res + IHr.Qty;
					
					//if(left(currentuser,2)=="SA")then begin
					if(IHr.TransDate>stringtodate("1/12/2019"))then begin
						if(IHr.CurncyCode=="AZN")then begin
							curcomp = currentcompany;
							INr.Code = IHr.ArtCode;
							readfirstmain(INr,1,true);
							setcompany(18,false);
							CIr.LocCode = IHr.ArtCode;
								CIr.BrandCode = INr.BPIBrand;								
								readfirstkey("LocCodeBrand",CIr,2,true);
								CCIHr.TransDate = IHr.InDate;
								CCIHr.ArtCode = CIr.Code;
								if(readfirstkey("ArtCode",CCIHr,2,false))then begin
									if(CCIHr.TransDate==IHr.InDate and CCIHr.ArtCode==CIr.Code)then begin
										IHr.CurncyCode = CCIHr.CurncyCode;
										IHr.RemCostPriceCurncy = CCIHr.TotCostPriceCurncy / CCIHr.Qty * IHr.RemQty;
									end;
								end;
							setcompany(curcomp,false);
						end;
					end;
					//end;
					
					cqty[IHr.CurncyCode] = cqty[IHr.CurncyCode] + IHr.Qty;
					if(!vcur[IHr.CurncyCode])then begin
						vcur[IHr.CurncyCode] = true;
						acur[acnt] = IHr.CurncyCode;
						acnt = acnt + 1;
					end;
					if(IHr.Qty>=0)then begin
						serialcost = serialcost + IHr.TotCostPrice;
						ccost[IHr.CurncyCode] = ccost[IHr.CurncyCode] + IHr.TotCostPrice;
					end else begin
						serialcost = serialcost - IHr.TotCostPrice;
						ccost[IHr.CurncyCode] = ccost[IHr.CurncyCode] - IHr.TotCostPrice;
					end;  	
				end;
			end; 
			serialcost = serialcost/res;
		end;
		
		
		ItemQtyPerDate = res;
		
return;
end;









global function val IDItemQtyPerDate(string artcode, date idate,string location,string serial,var val serialcost,var integer acnt,var vector val cqty,var vector val ccost,var array string acur,string brandcur,string variety)
begin
	record ItemHistVc IHr,CCIHr;
	val res;
	string 50 key;
	integer keys;
	boolean TrHs,testf;
	string 100 oldartcode,oldfilename;
	longint oldsernr;
  integer oldrow,oldinvalid,curcomp;
  record ItemStatusVc ISr;
  record SerBalVc SBr;
  vector boolean vcur;
  integer i;
  record ConsItemVc CIr;
  record INVc INr;
  //integer acnt;
  //vector val cqty,ccost;
  //array string 10 acur;
  
  For(i=0;i<acnt;i=i+1) begin
	  cqty[acur[i]] = blankval;
	  cqty[acur[i]] = blankval;
	end; 
  acnt = 0;
      
  res = 0;
  	serialcost = 0;
  	if(idate>=currentdate)then begin
  		if(nonblank(location))then begin
  			ISr.Code = artcode;
  			ISr.Location = location;
				ISr.Variety = variety;
  			readfirstmain(ISr,3,true);
  			res = ISr.Instock;
  			IHr.ArtCode = artcode;
				IHr.Variety = ISr.Variety;
				if(nonblank(ISr.Variety))then begin
					if(nonblank(location))then begin
						IHr.Location = location;
						key = "ArtCodeLoc";
						keys = 2;
					end else begin
						key = "ArtCodeVariety";
						keys = 2;
					end;
				end else begin
					if(nonblank(location))then begin
						IHr.Location = location;
						key = "ArtCodeLoc";
						keys = 2;
					end else begin
						key = "ArtCode";
						keys = 1;
					end;
				end;
			
				TrHs = true;
				res = 0;
				While(loopkey(key,IHr,keys,TrHs)) begin
					testf = true;
					if (IHr.ArtCode!=artcode or IHr.Location!=location or IHr.TransDate>idate) then begin testf = false; TrHs = false; end;
					if(IHr.StockAffectf<1)then begin testf = false; end;
					if(nonblank(serial) and IHr.SerialNr!=serial)then begin testf = false; end;
					if(IHr.Variety!=ISr.Variety)then begin testf = false; end;
					if(testf)then begin
						//if(left(currentuser,2)=="SA")then begin
						if(IHr.TransDate>stringtodate("1/12/2019"))then begin
							if(IHr.CurncyCode=="AZN")then begin
								curcomp = currentcompany;
								INr.Code = IHr.ArtCode;
								readfirstmain(INr,1,true);
								setcompany(18,false);
								CIr.LocCode = IHr.ArtCode;
								CIr.BrandCode = INr.BPIBrand;								
								readfirstkey("LocCodeBrand",CIr,2,true);
								CCIHr.TransDate = IHr.InDate;
								CCIHr.ArtCode = CIr.Code;
								if(readfirstkey("ArtCode",CCIHr,2,false))then begin
									if(CCIHr.TransDate==IHr.InDate and CCIHr.ArtCode==CIr.Code)then begin
										IHr.CurncyCode = CCIHr.CurncyCode;
										IHr.RemCostPriceCurncy = CCIHr.TotCostPriceCurncy / CCIHr.Qty * IHr.RemQty;
									end;
								end;
								setcompany(curcomp,false);
							end;
						end;
						//end;
					
						res = res + IHr.Qty;
						cqty[IHr.CurncyCode] = cqty[IHr.CurncyCode] + IHr.Qty;
						if(!vcur[IHr.CurncyCode])then begin
							vcur[IHr.CurncyCode] = true;
							acur[acnt] = IHr.CurncyCode;
							acnt = acnt + 1;
						end;
						if(IHr.Qty>=0)then begin
							serialcost = serialcost + IHr.TotCostPrice;
							ccost[IHr.CurncyCode] = ccost[IHr.CurncyCode] + IHr.TotCostPrice;
						end else begin
							serialcost = serialcost - IHr.TotCostPrice;
							ccost[IHr.CurncyCode] = ccost[IHr.CurncyCode] - IHr.TotCostPrice;
						end;  	
					end;
				end; 
  		end else begin
  			ISr.Code = artcode;
  			ISr.Location = ";;;";
				ISr.Variety = variety;
  			readfirstmain(ISr,3,true);
  			res = ISr.Instock;
  		end;
  		if(nonblank(serial))then begin
  			SBr.Serial = serial;
  			SBr.Location = location;
  			SBr.Item = artcode;
  			readfirstmain(SBr,3,true);
  			res = SBr.Quant;
  			serialcost = SBr.CostPrice;
  		end;
  	end else begin
			IHr.ArtCode = artcode;
			if(nonblank(location))then begin
				IHr.Location = location;
				key = "ArtCodeLoc";
				keys = 2;
			end else begin
				key = "ArtCode";
				keys = 1;
			end;
		
			TrHs = true;
			While(loopkey(key,IHr,keys,TrHs)) begin
				testf = true;
				if (IHr.ArtCode!=artcode or IHr.Location!=location or IHr.TransDate>idate) then begin testf = false; TrHs = false; end;
				if(IHr.StockAffectf<1)then begin testf = false; end;
				if(nonblank(serial) and IHr.SerialNr!=serial)then begin testf = false; end;
				if(IHr.Variety!=ISr.Variety)then begin testf = false; end;
				if(testf)then begin
					res = res + IHr.Qty;
					
					//if(left(currentuser,2)=="SA")then begin
					if(IHr.TransDate>stringtodate("1/12/2019"))then begin
						if(IHr.CurncyCode=="AZN")then begin
							curcomp = currentcompany;
							INr.Code = IHr.ArtCode;
							readfirstmain(INr,1,true);
							setcompany(18,false);
							CIr.LocCode = IHr.ArtCode;
								CIr.BrandCode = INr.BPIBrand;								
								readfirstkey("LocCodeBrand",CIr,2,true);
								CCIHr.TransDate = IHr.InDate;
								CCIHr.ArtCode = CIr.Code;
								if(readfirstkey("ArtCode",CCIHr,2,false))then begin
									if(CCIHr.TransDate==IHr.InDate and CCIHr.ArtCode==CIr.Code)then begin
										IHr.CurncyCode = CCIHr.CurncyCode;
										IHr.RemCostPriceCurncy = CCIHr.TotCostPriceCurncy / CCIHr.Qty * IHr.RemQty;
									end;
								end;
							setcompany(curcomp,false);
						end;
					end;
					//end;
					
					cqty[IHr.CurncyCode] = cqty[IHr.CurncyCode] + IHr.Qty;
					if(!vcur[IHr.CurncyCode])then begin
						vcur[IHr.CurncyCode] = true;
						acur[acnt] = IHr.CurncyCode;
						acnt = acnt + 1;
					end;
					if(IHr.Qty>=0)then begin
						serialcost = serialcost + IHr.TotCostPrice;
						ccost[IHr.CurncyCode] = ccost[IHr.CurncyCode] + IHr.TotCostPrice;
					end else begin
						serialcost = serialcost - IHr.TotCostPrice;
						ccost[IHr.CurncyCode] = ccost[IHr.CurncyCode] - IHr.TotCostPrice;
					end;  	
				end;
			end; 
			serialcost = serialcost/res;
		end;
		
		
		IDItemQtyPerDate = res;
		
return;
end;















global function val ItemQtyPerDateGlob(string artcode, date idate,string location)
begin
	record ItemHistVc IHr;
	val res;
	string 50 key;
	integer keys;
	boolean TrHs,testf;
	string 100 oldartcode,oldfilename;
	longint oldsernr;
  integer oldrow,oldinvalid;
  record ItemStatusVc ISr;
  record SerBalVc SBr;
  vector boolean vcur;
  integer i;
    
  res = 0;

  	if(idate>=currentdate)then begin
  		IHr.ArtCode = artcode;
			if(nonblank(location))then begin
				IHr.Location = location;
				key = "ArtCodeLoc";
				keys = 2;
			end else begin
				key = "ArtCode";
				keys = 1;
			end;
			
  		if(nonblank(location))then begin		
				TrHs = true;
				res = 0;
				While(loopkey(key,IHr,keys,TrHs)) begin
					testf = true;
					if (IHr.ArtCode!=artcode or IHr.Location!=location or IHr.TransDate>idate) then begin testf = false; TrHs = false; end;
					if(IHr.StockAffectf<1)then begin testf = false; end;
			
					if(testf)then begin
						res = res + IHr.Qty;
					end;
				end; 
  		end else begin
  			ISr.Code = artcode;
  			ISr.Location = ";;;";
  			readfirstmain(ISr,2,true);
  			res = ISr.Instock;
  		end;
  	end else begin
			IHr.ArtCode = artcode;
			if(nonblank(location))then begin
				IHr.Location = location;
				key = "ArtCodeLoc";
				keys = 2;
			end else begin
				key = "ArtCode";
				keys = 1;
			end;
		
			TrHs = true;
			While(loopkey(key,IHr,keys,TrHs)) begin
				testf = true;
				if (IHr.ArtCode!=artcode or IHr.Location!=location or IHr.TransDate>=idate) then begin testf = false; TrHs = false; end;
				if(IHr.StockAffectf<1)then begin testf = false; end;
			
				if(testf)then begin
					res = res + IHr.Qty;
				end; 
			end;
		end;
		
		
		ItemQtyPerDateGlob = res;
		
return;
end;

function boolean CheckIfContainForbiddenBrand(string brand,string field)
begin
integer pos;
record DIVc DIr;
string 30 classfind;
boolean res;

	if (blank(brand)) then begin
		res = false;
		goto L0101;
	end;

	pos = 0;
	classfind = "";			
	ExtractObj(field,pos,classfind);
	while(nonblank(classfind)) begin
		DIr.Code = classfind;
		readfirstmain(DIr,1,true);
		if(DIr.CType=="BRAND" and SetInSet2(classfind,brand)==false)then begin
			res = true;
		end;
		ExtractObj(field,pos,classfind);
	end;
	
L0101:;	
CheckIfContainForbiddenBrand = res;	
return;
end;


global procedure CalcCostInCurncyCurDate(record ItemHistVc IHr,var val curcost2, string brandcur,integer neg)
begin
	val tempcost,fr,to1,to2,br1,br2;
	
	tempcost = 0;
	if(brandcur==IHr.CurncyCode or blank(brandcur))then begin
		curcost2 = curcost2 + IHr.RemCostPriceCurncy * neg;
	end else begin
		if(IHr.CurncyCode=="AZN")then begin
			GetFullCurncyRate(brandcur,IHr.TransDate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			tempcost = IHr.RemCostPriceCurncy / to1 * fr;
			curcost2 = curcost2 + tempcost*neg;
		end else begin
			GetFullCurncyRate(IHr.CurncyCode,IHr.TransDate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			tempcost = IHr.RemCostPriceCurncy * to1 / fr;
			GetFullCurncyRate(brandcur,IHr.TransDate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			tempcost = tempcost / to1 * fr;
			curcost2 = curcost2 + tempcost*neg;
		end;
	end;

return;
end;

global procedure CalcCostInCurncyOldDate(record ItemHistVc IHr,var val curcost2, string brandcur,integer neg)
begin
	val tempcost,fr,to1,to2,br1,br2;
	
	tempcost = 0;
	if(brandcur==IHr.CurncyCode or blank(brandcur))then begin
		curcost2 = curcost2 + IHr.TotCostPriceCurncy * neg;
	end else begin
		if(IHr.CurncyCode=="AZN")then begin
			if(nonblankdate(IHr.InDate))then begin
				GetFullCurncyRate(brandcur,IHr.InDate,fr,to1,to2,br1,br2);
			end else begin
				GetFullCurncyRate(brandcur,IHr.TransDate,fr,to1,to2,br1,br2);
			end;
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			tempcost = IHr.TotCostPriceCurncy / to1 * fr;
			curcost2 = curcost2 + tempcost*neg;
		end else begin
			if(nonblankdate(IHr.InDate))then begin
				GetFullCurncyRate(IHr.CurncyCode,IHr.InDate,fr,to1,to2,br1,br2);
			end else begin
				GetFullCurncyRate(IHr.CurncyCode,IHr.TransDate,fr,to1,to2,br1,br2);
			end;
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			tempcost = IHr.TotCostPriceCurncy * to1 / fr;
			if(nonblankdate(IHr.InDate))then begin
				GetFullCurncyRate(brandcur,IHr.InDate,fr,to1,to2,br1,br2);
			end else begin
				GetFullCurncyRate(brandcur,IHr.TransDate,fr,to1,to2,br1,br2);
			end;
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			tempcost = tempcost / to1 * fr;
			curcost2 = curcost2 + tempcost*neg;
		end;
	end;	
return;
end;



global  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 
procedure MyFindAwerageCost(string artcode, string location,string curcode,date todate,string realcur,string brandcur,var val cost,var val curcost,var val curcost2, var val curqty)
begin
	record ItemHistVc IHr,IH2r,CCIHr;
	record PUVc PUr;
	row PUVc PUrw;
	val curval;
	boolean TrHs,testf;
	longint lastsernr;
	val fr,to1,to2,br1,br2;
	string 100 oldartcode,oldfilename;
	longint oldsernr;
  integer oldrow,oldinvalid,curcomp;
  val tempcost;
  record ConsItemVc CIr;
  record INVc INr;
	
	
	if(todate>=currentdate)then begin
		cost = 0;
		curcost = 0;
		curcost2 = 0;
		curqty = 0;
		IHr.ArtCode = artcode;
		IHr.Location = location;
		TrHs = true;
		while(loopkey("ActiveLocQty",IHr,2,TrHs))begin
			testf = true;
			if(IHr.ArtCode!=artcode)then begin TrHs=false; testf = false; end;
			if(nonblank(location) and IHr.Location!=location)then begin testf = false; end;
			if(IHr.StockAffectf==0)then begin testf=false; end;
			if(curcode!=IHr.CurncyCode and nonblank(IHr.CurncyCode))then begin testf=false; end;
			if(blank(IHr.CurncyCode) and curcode!=realcur)then begin testf=false; end;
			
			if(testf)then begin	
				//if(left(currentuser,2)=="SA")then begin
				if(IHr.TransDate>stringtodate("1/12/2019"))then begin
					if(IHr.CurncyCode=="AZN")then begin
						curcomp = currentcompany;
						INr.Code = IHr.ArtCode;
						readfirstmain(INr,1,true);
						setcompany(18,false);
						CIr.LocCode = IHr.ArtCode;
						CIr.BrandCode = INr.BPIBrand;								
						readfirstkey("LocCodeBrand",CIr,2,true);
						CCIHr.TransDate = IHr.InDate;
						CCIHr.ArtCode = CIr.Code;
						if(readfirstkey("ArtCode",CCIHr,2,false))then begin
							if(CCIHr.TransDate==IHr.InDate and CCIHr.ArtCode==CIr.Code)then begin
								IHr.CurncyCode = CCIHr.CurncyCode;
								IHr.RemCostPriceCurncy = CCIHr.TotCostPriceCurncy / CCIHr.Qty * IHr.RemQty;
							end;
						end;
						setcompany(curcomp,false);
					end;
				end;
				//end;
				
				tempcost = 0;
				curcost = curcost + IHr.RemCostPriceCurncy;
				cost = cost + IHr.RemCostPrice;
				CalcCostInCurncyCurDate(IHr,curcost2,brandcur,1);
				curqty = curqty + IHr.RemQty;
			end;
		end;
		curcost = curcost/curqty;
		cost = cost/curqty;
		curcost2 = curcost2/curqty;
	end else begin
		cost = 0;
		curcost = 0;
		curcost2 = 0;
		curqty = 0;
		tempcost = 0;
		IHr.ArtCode = artcode;
		IHr.Location = location;
		TrHs = true;
		while(loopkey("ArtCodeLoc",IHr,2,TrHs))begin
			testf = true;
			if(IHr.ArtCode!=artcode or IHr.Location!=location)then begin TrHs=false; testf = false; end;
			if(IHr.TransDate>todate)then begin TrHs=false; testf = false; end;
			if(IHr.StockAffectf==0)then begin testf=false; end;
			if(curcode!=IHr.CurncyCode and nonblank(IHr.CurncyCode))then begin testf=false; end;
			if(blank(IHr.CurncyCode) and curcode!=realcur)then begin testf=false; end;
			
			if(testf)then begin
				//if(left(currentuser,2)=="SA")then begin
				if(IHr.TransDate>stringtodate("1/12/2019"))then begin
					if(IHr.CurncyCode=="AZN")then begin
						curcomp = currentcompany;
						INr.Code = IHr.ArtCode;
						readfirstmain(INr,1,true);
						setcompany(18,false);
						CIr.LocCode = IHr.ArtCode;
						CIr.BrandCode = INr.BPIBrand;								
						readfirstkey("LocCodeBrand",CIr,2,true);
						CCIHr.TransDate = IHr.InDate;
						CCIHr.ArtCode = CIr.Code;
						if(readfirstkey("ArtCode",CCIHr,2,false))then begin
							if(CCIHr.TransDate==IHr.InDate and CCIHr.ArtCode==CIr.Code)then begin
								IHr.CurncyCode = CCIHr.CurncyCode;
								IHr.RemCostPriceCurncy = CCIHr.TotCostPriceCurncy / CCIHr.Qty * IHr.RemQty;
							end;
						end;
						setcompany(curcomp,false);
					end;
				end;
				//end;
				
				tempcost = 0;
				if(IHr.Qty>=0)then begin
					cost = cost + IHr.TotCostPrice;
					curcost = curcost + IHr.TotCostPriceCurncy;
					CalcCostInCurncyOldDate(IHr,curcost2,brandcur,1);
				end else begin
					tempcost = 0;
					cost = cost - IHr.TotCostPrice;
					curcost = curcost - IHr.TotCostPriceCurncy;
					CalcCostInCurncyOldDate(IHr,curcost2,brandcur,-1);
				end;
				curqty = curqty + IHr.Qty;
				if(curqty==0)then begin
					curcost = 0;
					cost = 0;
				end;
			end;
		end;
		curcost = curcost/curqty;
		cost = cost/curqty;
		curcost2 = curcost2/curqty;
	end;
	
return;
end;







global
procedure FindAwerageCostCurProc(string artcode, string location,string curcode,date todate,string realcur,string brandcur,var val curcost,var val curcost2)
begin
	record ItemHistVc IHr,IH2r;
	record PUVc PUr;
	row PUVc PUrw;
	val curval;
	boolean TrHs,testf;
	longint lastsernr;
	val fr,to1,to2,br1,br2;
	string 100 oldartcode,oldfilename;
	longint oldsernr;
  integer oldrow,oldinvalid;
  val curqty,tempcost;
	
	
	if(todate>=currentdate)then begin
		curcost = 0;
		curcost2 = 0;
		curqty = 0;
		IHr.ArtCode = artcode;
		IHr.Location = location;
		TrHs = true;
		while(loopkey("ActiveLocQty",IHr,2,TrHs))begin
			testf = true;
			if(IHr.ArtCode!=artcode)then begin TrHs=false; testf = false; end;
			if(nonblank(location) and IHr.Location!=location)then begin testf = false; end;
			if(IHr.StockAffectf==0)then begin testf=false; end;
			if(curcode!=IHr.CurncyCode and nonblank(IHr.CurncyCode))then begin testf=false; end;
			if(blank(IHr.CurncyCode) and curcode!=realcur)then begin testf=false; end;
			
			if(testf)then begin
				tempcost = 0;
				curcost = curcost + IHr.RemCostPriceCurncy;
				CalcCostInCurncyCurDate(IHr,curcost2,brandcur,1);
				curqty = curqty + IHr.RemQty;
			end;
		end;
		curcost = curcost/curqty;
		curcost2 = curcost2/curqty;
	end else begin
		curcost = 0;
		curcost2 = 0;
		curqty = 0;
		tempcost = 0;
		IHr.ArtCode = artcode;
		IHr.Location = location;
		TrHs = true;
		while(loopkey("ArtCodeLoc",IHr,2,TrHs))begin
			testf = true;
			if(IHr.ArtCode!=artcode or IHr.Location!=location)then begin TrHs=false; testf = false; end;
			if(IHr.TransDate>todate)then begin TrHs=false; testf = false; end;
			if(IHr.StockAffectf==0)then begin testf=false; end;
			if(curcode!=IHr.CurncyCode and nonblank(IHr.CurncyCode))then begin testf=false; end;
			if(blank(IHr.CurncyCode) and curcode!=realcur)then begin testf=false; end;
			
			if(testf)then begin
				tempcost = 0;
				if(IHr.Qty>=0)then begin
					curcost = curcost + IHr.TotCostPriceCurncy;
					CalcCostInCurncyOldDate(IHr,curcost2,brandcur,1);
				end else begin
					tempcost = 0;
					curcost = curcost - IHr.TotCostPriceCurncy;
					CalcCostInCurncyOldDate(IHr,curcost2,brandcur,-1);
				end;
				curqty = curqty + IHr.Qty;
				if(curqty==0)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Friday, 18 May 2018 10:17:30
					curcost = 0;
				end;
			end;
		end;
		curcost = curcost/curqty;
		curcost2 = curcost2/curqty;
	end;
	
return;
end;

global function val FindAwerageCost(string artcode, string location,string curcode,date todate,string realcur)
begin
	record ItemHistVc IHr,IH2r;
	record PUVc PUr;
	row PUVc PUrw;
	val curcost,curval;
	boolean TrHs,testf;
	longint lastsernr;
	val fr,to1,to2,br1,br2;
	string 100 oldartcode,oldfilename;
	longint oldsernr;
  integer oldrow,oldinvalid;
  val curqty;
  
	if(todate>=currentdate)then begin
		curcost = 0;
		curqty = 0;
		IHr.ArtCode = artcode;
		IHr.Location = location;
		TrHs = true;
		while(loopkey("ActiveLocQty",IHr,2,TrHs))begin
			testf = true;
			if(IHr.ArtCode!=artcode)then begin TrHs=false; testf = false; end;
			if(nonblank(location) and IHr.Location!=location)then begin testf = false; end;
			if(IHr.StockAffectf==0)then begin testf=false; end;
			if(curcode!=IHr.CurncyCode and nonblank(IHr.CurncyCode))then begin testf=false; end;
			if(blank(IHr.CurncyCode) and curcode!=realcur)then begin testf=false; end;
			
			if(testf)then begin
				curcost = curcost + IHr.RemCostPrice;
				curqty = curqty + IHr.RemQty;
			end;
		end;
		curcost = curcost/curqty;
	end else begin
		curcost = 0;
		curqty = 0;
		IHr.ArtCode = artcode;
		IHr.Location = location;
		TrHs = true;
		while(loopkey("ArtCodeLoc",IHr,2,TrHs))begin
			testf = true;
			if(IHr.ArtCode!=artcode or IHr.Location!=location)then begin TrHs=false; testf = false; end;
			if(IHr.TransDate>todate)then begin TrHs=false; testf = false; end;
			if(IHr.StockAffectf==0)then begin testf=false; end;
			if(curcode!=IHr.CurncyCode and nonblank(IHr.CurncyCode))then begin testf=false; end;
			if(blank(IHr.CurncyCode) and curcode!=realcur)then begin testf=false; end;
			
			if(testf)then begin
				if(IHr.Qty>=0)then begin
					curcost = curcost + IHr.TotCostPrice;
				end else begin
					curcost = curcost - IHr.TotCostPrice;
				end;
				curqty = curqty + IHr.Qty;
				if(curqty==0)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Friday, 18 May 2018 10:17:22
					curcost = 0;
				end;
			end;
		end;
		curcost = curcost/curqty;
	end;
	FindAwerageCost = curcost;
return;
end;

procedure PrintInfo(record INVc INr, record ItemStatusVc ISr,string serial,val serstock,val costprice,date todate,var val total_qty,var val total_cost,var val total_price,var vector string typeval,array string typecode,Integer typescnt,boolean addclassf,string realcur,string brandcur)
begin 
	record DIVc DIr;
	record PLVc PLr;
	integer pos,cnt,i,pos1;
  string 50 uloc,pricecur,uloc1;
  val fr,to1,to2,br1,br2;
  val baseprice,cur,price,baseprice5,brandprice;
  record INConsVc INCr;
	val instock,awercost,awercostcur,awercostbrandcur,curcost2,curcost;
	record PLDefVc PLDefr;
	record ItemHistVc IHr;
	record PUVc PUr;
	row PUVc PUrw;
  record IVVc IVr;
  row IVVc IVrw;
  roundmode rmode5;
  string 255 brand,model,tstr;
  Boolean collf,metalf;
  string 20 collstr,metalstr;
  
  rmode5 = SetRoundMode(0,kRoundingDirectionToFromPosInf,kRoundingModeHalfUp,/*kRoundingStep5*/kRoundingStepNone);	//Edit----------------------Dima  17.04.2015
  
  
  if(serstock==0)then begin
  	instock = ISr.Instock;
  end else begin
  	instock = serstock;
  end;
  
	startformat(15);
		DIr.Code = INr.DispGroups;
		readfirstmain(DIr,1,true);
		PLr.ArtCode = ISr.Code;
		PLr.PLCode = "RRP";
		PLr.SerialNr = serial;
		if(readfirstmain(PLr,3,true))then begin
			if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP" and PLr.SerialNr==serial)then begin
				price = PLr.ExVatPrice;
			end;
		end;	
		outstring(0,0,INr.Code,false);
		outstring(0,0,INr.AlternativeCode,false);
		outstring(0,0,INr.BarCode,false);
		outstring(0,0,INr.SN,false);
		outstring(0,0,ISr.Location,false);
		if(currentcompany==18)then begin
			outstring(0,0,INr.Department,false);//stelaj
			outstring(0,0,INr.InvCode,false);//polka
		end;
		pos = 0;
		brand = "";
		model = "";
		if (CurrentCompany!=13) then begin
  		ExtractObj(INr.DispGroups,pos,uloc);
  		while (NonBlank(uloc)) begin
  		  DIr.Code = uloc;
  		  if (readfirstmain(DIr,1,true)) then begin
  		    if (DIr.CType=="BRAND") then begin
  		      brand = DIr.Name;
  		    end;
  		    if (DIr.CType=="MODEL") then begin
  		      model = DIr.Name;
  		    end;
  		    if (addclassf and NonBlank(DIr.CType)) then begin //Edit***************************Sasha2,14:30 08.02.2016 {
  				  if (DIr.CType=="GENDER") then begin
  				    switch (Left(UpperCase(INr.MainDisp),1)) begin
  				      case "A":
        				  DIr.CType = DIr.CType & "_A";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				      case "J":
  				        DIr.CType = DIr.CType & "_J";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				      case "W":
  				        DIr.CType = DIr.CType & "_W";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				    end;
  				  end else begin
  				    typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				    switch (Left(UpperCase(INr.MainDisp),1)) begin //if classifications in custom separate fields {
  				      case "A":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_A";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_A";
  				        end;
  				      case "J":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_J";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_J";
  				        end;
  				        if (NonBlank(INr.RowWeight)) then begin
  				          tstr = typeval["WEIGHT"];
      			        pos1 = 0;
      			        ExtractObj(tstr,pos1,uloc1);
      			        if (uloc1==INr.Code) then begin
      			          ExtractObj(tstr,pos1,uloc1);
      			          if (blank(uloc1)) then begin
      			            typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
      			          end;
      			        end else begin
      			          typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
      			        end;
  				        end;
  				        if (NonBlank(INr.MajStoneDet)) then begin
  				          tstr = typeval["D_CARAT"];
      			        pos1 = 0;
      			        ExtractObj(tstr,pos1,uloc1);
      			        if (uloc1==INr.Code) then begin
      			          ExtractObj(tstr,pos1,uloc1);
      			          if (blank(uloc1)) then begin
      			            typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
      			          end;
      			        end else begin
      			          typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
      			        end;
  				        end;
  				      case "W":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_W";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_W";
  				        end;
  				    end; 
  				    if (collf) then begin
  				      tstr = typeval[collstr];
  			        pos1 = 0;
  			        ExtractObj(tstr,pos1,uloc1);
  			        if (uloc1==INr.Code) then begin
  			          ExtractObj(tstr,pos1,uloc1);
  			          if (blank(uloc1)) then begin
  			            typeval[collstr] = INr.Code & ";" & INr.Reference;
  			          end;
  			        end else begin
  			          typeval[collstr] = INr.Code & ";" & INr.Reference;
  			        end;  
  				      collf = false;
  				    end;
  				    if (metalf) then begin
  		          tstr = typeval[metalstr];
  			        pos1 = 0;
  			        ExtractObj(tstr,pos1,uloc1);
  			        if (uloc1==INr.Code) then begin
  			          ExtractObj(tstr,pos1,uloc1);
  			          if (blank(uloc1)) then begin
  			            typeval[metalstr] = INr.Code & ";" & INr.Metal;
  			          end;
  			        end else begin
  			          typeval[metalstr] = INr.Code & ";" & INr.Metal;
  			        end;
  				      metalf = false;
  				    end;//if classifications in custom separate fields }
  				  end;
  				end; //Edit***************************Sasha2,14:30 08.02.2016 }
  		  end;
  		  ExtractObj(INr.DispGroups,pos,uloc);
  		end;
			if(nonblank(INr.BPIBrand)) then begin
			 	outstring(0,0,BPICodeToName(INr.BPIBrand),false);
			end else begin 
  			outstring(0,0,brand,false); //Edit***************************Sasha2,16:37 18.02.2016
			end;
  		
  			if(nonblank(INr.BPICollection)) then begin
			 		outstring(0,0,BPICodeToName(INr.BPICollection),false);
				end else begin
					outstring(0,0,model,false);
  		  end;
  	 //Edit***************************Sasha2,16:37 18.02.2016
		end else begin
		  ExtractObj(INr.DispGroups,pos,uloc);
		  DIr.Code = uloc;
		  readfirstmain(DIr,1,true)
		  outstring(0,0,DIr.Name,false);
		end;
		
		ExtractObj(INr.DispGroups,pos,uloc);
		if(currentcompany==9)then begin
			if(uloc=="GOODS")then begin
				ExtractObj(INr.DispGroups,pos,uloc);
			end;
		end;
		DIr.Code = uloc;
		readfirstmain(DIr,1,true);
		//outstring(0,0,DIr.Name,false);
		//pos = 1;
		ExtractObj(INr.DispGroups,pos,uloc);
		DIr.Code = uloc;
		readfirstmain(DIr,1,true);
		//outstring(0,0,DIr.Name,false);
		
		
		outstring(0,0,INr.Name,false);
		if (addclassf) then begin //Edit***************************Sasha2,16:36 18.02.2016
  		outstring(0,0,INr.RowWeight,false); //Ves
  		outstring(0,0,INr.MajStoneDet,false);  //Karatnoct
		end; //Edit***************************Sasha2,16:36 18.02.2016
	
		  outstring(0,0,BPICodeToName(INr.BPICollection),false);
			outstring(0,0,BPICodeToName(INr.BPIGroup),false); 
			outstring(0,0,BPICodeToName(INr.BPISubGroup),false); 
			outstring(0,0,BPICodeToName(INr.BPICategory),false); 
			outstring(0,0,BPICodeToName(INr.BPIMaterial),false); 
			outstring(0,0,BPICodeToName(INr.BPIColor),false); 
			outstring(0,0,BPICodeToName(INr.BPIShape),false); 
			outstring(0,0,BPICodeToName(INr.BPISize),false); 
			outstring(0,0,BPICodeToName(INr.BPIUse),false); 
			outstring(0,0,BPICodeToName(INr.BPISex),false); 
			outstring(0,0,BPICodeToName(INr.BPIPlating),false);
			outstring(0,0,BPICodeToName(INr.BPIClarity),false); 
			outstring(0,0,BPICodeToName(INr.BPIWeight),false); 
			outstring(0,0,BPICodeToName(INr.BPICut),false); 
			outstring(0,0,BPICodeToName(INr.BPIStone),false); 
			outstring(0,0,BPICodeToName(INr.BPIStrap),false); 
			outstring(0,0,BPICodeToName(INr.BPIOdour),false); 
			
			outstring(0,0,serial,false);// Edit ************************** Tuesday, 7 May 2013 10:13:07
		INCr.Code = INr.Code;
		if(readfirstmain(INCr,1,true))then begin
			outstring(0,0,USetStr(31180),false);
		end else begin
			outstring(0,0,"",false);
		end;
		
		outstring(0,0,instock,false);
		outstring(0,0,INr.Unittext,false);
		total_qty = total_qty + instock;
		GetFullCurncyRate(INr.LastPurchCurncyCode,todate,fr,to1,to2,br1,br2);
		if(fr==0 or to1==0)then begin
			fr=1; to1=0;
		end;
		
		awercost = 0;
		awercostcur = 0;
		awercostbrandcur = 0;
		awercost = FindAwerageCost(INr.Code,ISr.Location,INr.LastPurchCurncyCode,todate,realcur);
		FindAwerageCostCurProc(INr.Code,ISr.Location,INr.LastPurchCurncyCode,todate,realcur,brandcur,curcost,curcost2);
		awercostcur = curcost;
		awercostbrandcur = curcost2;
		if(costprice>0 and nonblank(serial) and INr.SerNrf>0)then begin
			awercost = costprice;
			IHr.ArtCode = INr.Code;
			IHr.SerialNr = serial;
			IHr.FileName = "PUVc";
			if(readlastkey("ArtCodeSerialNr",IHr,3,true))then begin
				PUr.SerNr = IHr.TransNr;
				readfirstmain(PUr,1,true);
				matrowget(PUr,IHr.Row,PUrw);
				awercostcur = PUrw.UPrice;
			end else begin
				IHr.ArtCode = INr.Code;
				IHr.SerialNr = serial;
				IHr.FileName = "IVVc";
				readfirstkey("ArtCodeSerialNr",IHr,3,true);
				IVr.SerNr = IHr.TransNr;
				readfirstmain(IVr,1,true);
				matrowget(IVr,IHr.Row,IVrw);
				awercostcur = IVrw.Sum;
			end;
		end;
		if(usercanaction("ViewCostPrice",true))then begin
			outstring(0,0,awercostcur,false);
			if(nonblank(brandcur))then begin
				outstring(0,0,awercostbrandcur,false);
			end;
			//logtext(0,"awercostbrandcur " & awercostbrandcur);
			//logtext(0,"instock " & instock);
			outstring(0,0,awercost,false);
			outstring(0,0,awercostcur*instock,false);
			if(nonblank(brandcur))then begin
				outstring(0,0,awercostbrandcur*instock,false);
			end;
			outstring(0,0,awercost*instock,false);
		end;

		total_cost = total_cost + awercost*instock;
		
		baseprice = 0;
		brandprice = 0;
		PLr.ArtCode = ISr.Code;
		PLr.PLCode = "RRP";
		PLr.CustCode = "";
		PLr.SerialNr = serial;
		
		if(readfirstmain(PLr,4,true))then begin
			if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP" and PLr.SerialNr==serial)then begin
				price = PLr.ExVatPrice;
				PLDefr.Code = "RRP";
				readfirstmain(PLDefr,1,true);
				pricecur = PLDefr.CurncyCode;
				if(nonblank(PLr.CurncyCode))then begin
					pricecur = PLr.CurncyCode;
				end;
			end;
		end;		
		if(price==0)then begin
			cnt = 0;
			PLr.ArtCode = ISr.Code;
			PLr.PLCode = "RRP";
			while(loopmain(PLr,2,(PLr.ArtCode==ISr.Code)))begin
				if(PLr.ArtCode==ISr.Code)then begin
					price = price + PLr.ExVatPrice;
					cnt = cnt + 1;
					PLDefr.Code = "RRP";
					readfirstmain(PLDefr,1,true);
					pricecur = PLDefr.CurncyCode;
					if(nonblank(PLr.CurncyCode))then begin
						pricecur = PLr.CurncyCode;
					end;
				end;
			end;
			resetloop(PLr);
			price = price/cnt;
		end;
		GetFullCurncyRate(pricecur,todate,fr,to1,to2,br1,br2);
		if(fr==0 or to1==0)then begin
			fr=1; to1=1;
		end;
		baseprice = price/fr*to1;
		if(pricecur!=INr.LastPurchCurncyCode)then begin
			GetFullCurncyRate(INr.LastPurchCurncyCode,todate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			price = baseprice*fr/to1;
		end;
		
		if(addclassf)then begin
			baseprice5 = round(baseprice,rmode5);	//Edit----------------------Dima  17.04.2015
		end else begin
			baseprice5 = baseprice;
		end;
		
		if(currentcompany==10)then begin
			PLr.ArtCode = ISr.Code;
			PLr.PLCode = "RRP";
			PLr.CustCode = "";
		
			if(readfirstmain(PLr,3,true))then begin
				if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP")then begin
					baseprice5 = PLr.ExVatPrice;
					baseprice = PLr.ExVatPrice;
				end;
			end;	
		end;
		
		if(nonblank(brandcur))then begin
			GetFullCurncyRate(brandcur,todate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				GetFullCurncyRate(brandcur,currentdate,fr,to1,to2,br1,br2);
				if(fr==0 or to1==0)then begin
					fr=1; to1=1;
				end;
			end;
			brandprice = baseprice / to1 * fr;
		end; 
		
		outval(0,0,price,m4val,false);
		if(nonblank(brandcur))then begin
			outval(0,0,brandprice,m4val,false);
		end;
		outval(0,0,baseprice5,m4val,false);
		//outstring(0,0,baseprice,false);
		outstring(0,0,price*instock,false);
		if(nonblank(brandcur))then begin
			outval(0,0,brandprice*instock,m4val,false);
		end;
		outstring(0,0,baseprice*instock,false);
		total_price = total_price + baseprice*instock;
		
		if(left(currentuser,2)=="SA")then begin
			//logtext(0,"INr.LastPurchCurncyCode 1 " & INr.LastPurchCurncyCode);
		end;
		outstring(0,0,INr.LastPurchCurncyCode,false);
		if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
		  for (i=30;i<typescnt;i=i+1) begin //if you change "30" do it in other places having "For" loop 
		    pos = 0;
		    ExtractObjWithSeparator(";",typeval[typecode[i]],true,pos,uloc);
		    if (uloc==INr.Code) then begin
		      ExtractObjWithSeparator(";",typeval[typecode[i]],true,pos,uloc);
          outstring(0,0,uloc,false);
        end else begin
          outstring(0,0,"",false);
		    end;
		  end;
		end; //Edit***************************Sasha2,14:37 08.02.2016 }
	
	endformat;

return;
end;




procedure PrintInfo2(record INVc INr, record ItemStatusVc ISr,string serial,val serstock,val costprice,date todate,var val total_qty,var val total_cost,var val total_price,var vector string typeval,array string typecode,Integer typescnt,boolean addclassf,string realcur,string brandcur,record RcVc RepSpec, vector string DubCodes)
begin 
	record DIVc DIr;
	record PLVc PLr;
	integer pos,cnt,i,pos1,mtrw,c;
  string 50 uloc,pricecur,uloc1;
  val fr,to1,to2,br1,br2;
  val baseprice,cur,price,baseprice5,brandprice;
  record INConsVc INCr;
	val instock,awercost,awercostcur,awercostbrandcur,curcost2,curcost,cost;
	record PLDefVc PLDefr;
	record ItemHistVc IHr;
	record PUVc PUr,PUIHr;
	row PUVc PUrw;
  record IVVc IVr;
  row IVVc IVrw;
  roundmode rmode5;
  string 255 brand,model,tstr,tstr2,filename,serverip,stock,reserve;
  Boolean collf,metalf;
  string 20 collstr,metalstr;
	record OldDIVc OldDIr;
  boolean TrHs, testf;
	record ORVc ORr;
	row ORVc ORrw;
	record BPIBrandVc Brndr;
	date dat,sd;
	val ITRebate,TempItemPrice, inprice;
	string 255 tpcurrency,crn,obj,Dubl;
	record CurncyRoundOffBlock CROb;
  row CurncyRoundOffBlock CRObrw;
	record ItemDuplicatesVc IDr;
	record INVc dupINr;
	record ItemStatusVc IS2r;
	boolean testf2, TrHs2;
	record LocationVc Locr;
	record SerBalVc SBr;
	integer qtyDup;
	record ConsItemVc CIr;
	record BPIBrandVc BBr;
	boolean compchange;
	val curqty;
	blockload(CROb);
	
	compchange = false;
  rmode5 = SetRoundMode(0,kRoundingDirectionToFromPosInf,kRoundingModeHalfUp,/*kRoundingStep5*/kRoundingStepNone);	//Edit----------------------Dima  17.04.2015
	IHr.ArtCode=INr.Code;
	IHr.FileName="PUVc";
	IHr.TransDate=todate;
	TrHS = true;
	while (LoopBackKey("FNArtCode",IHr,3,TrHS)) begin
		testf = true;
		if(IHr.ArtCode!=INr.Code)then begin TrHS = false; end;
		if(IHr.FileName!="PUVc")then begin TrHS = false; end;
		PUIHr.SerNr = IHr.TransNr;
		if(ReadFirstMain(PUIHr,1,true))then begin
			if(left(PUIHr.VECode,3)=="FOB")then begin testf = false; end;
		end else begin
			testf = false;
		end;
		if(TrHS and testf)then begin
			dat = IHr.TransDate;
			TrHS = false;
		end;
	end;
	ResetLoop(IHr);
  if(serstock==0)then begin
  	instock = ISr.Instock;
		reserve = ISr.RsrvQty;
  end else begin
  	instock = serstock;
  end;
  
	startformat(15);
		DIr.Code = INr.DispGroups;
		readfirstmain(DIr,1,true);
		PLr.ArtCode = ISr.Code;
		PLr.PLCode = "RRP";
		PLr.SerialNr = serial;
		if(readfirstmain(PLr,3,true))then begin
			if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP" and PLr.SerialNr==serial)then begin
				price = PLr.ExVatPrice;
			end;
		end;	
		if(currentcompany==18 and RepSpec.flags[8] != 0) then begin
			outstring(0,0,INr.AlternativeCode,false);
			outstring(0,0,INr.Code,false);	
		end else begin
			if(Left(INr.Code,3)=="IN_") then begin
				outstring(0,0,INr.AlternativeCode,false);
				outstring(0,0,INr.Code,false);
			end else begin
				outstring(0,0,INr.Code,false);
				outstring(0,0,INr.AlternativeCode,false);
			end;
		end;	
		outstring(0,0,INr.OrigCode,false);
		outstring(0,0,DubCodes[INr.Code],false);
		outstring(0,0,INr.BarCode,false);
		outstring(0,0,INr.SN,false);
		outstring(0,0,ISr.Location,false);
		if(currentcompany==18 or RepSpec.flags[5] != 0)then begin
			Brndr.Code = INr.BPIBrand;
			if(readfirstmain(Brndr,1,true))then begin
				outstring(0,0,Brndr.CWHCode,false);//mesto
			end else begin
				outstring(0,0,"",false);//nema mesta
			end;
			outstring(0,0,INr.Department,false);//stelaj
			outstring(0,0,INr.InvCode,false);//polka
		end;
		pos = 0;
		brand = "";
		model = "";
		if (CurrentCompany!=13) then begin
  		ExtractObj(INr.DispGroups,pos,uloc);
  		while (NonBlank(uloc)) begin
  		  DIr.Code = uloc;
  		  if (readfirstmain(DIr,1,true)) then begin
  		    if (DIr.CType=="BRAND") then begin
  		      brand = DIr.Name;
  		    end;
  		    if (DIr.CType=="MODEL") then begin
  		      model = DIr.Name;
  		    end;
  		    if (addclassf and NonBlank(DIr.CType)) then begin //Edit***************************Sasha2,14:30 08.02.2016 {
  				  if (DIr.CType=="GENDER") then begin
  				    switch (Left(UpperCase(INr.MainDisp),1)) begin
  				      case "A":
        				  DIr.CType = DIr.CType & "_A";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				      case "J":
  				        DIr.CType = DIr.CType & "_J";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				      case "W":
  				        DIr.CType = DIr.CType & "_W";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				    end;
  				  end else begin
  				    typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				    switch (Left(UpperCase(INr.MainDisp),1)) begin //if classifications in custom separate fields {
  				      case "A":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_A";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_A";
  				        end;
  				      case "J":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_J";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_J";
  				        end;
  				        if (NonBlank(INr.RowWeight)) then begin
  				          tstr = typeval["WEIGHT"];
      			        pos1 = 0;
      			        ExtractObj(tstr,pos1,uloc1);
      			        if (uloc1==INr.Code) then begin
      			          ExtractObj(tstr,pos1,uloc1);
      			          if (blank(uloc1)) then begin
      			            typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
      			          end;
      			        end else begin
      			          typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
      			        end;
  				        end;
  				        if (NonBlank(INr.MajStoneDet)) then begin
  				          tstr = typeval["D_CARAT"];
      			        pos1 = 0;
      			        ExtractObj(tstr,pos1,uloc1);
      			        if (uloc1==INr.Code) then begin
      			          ExtractObj(tstr,pos1,uloc1);
      			          if (blank(uloc1)) then begin
      			            typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
      			          end;
      			        end else begin
      			          typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
      			        end;
  				        end;
  				      case "W":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_W";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_W";
  				        end;
  				    end; 
  				    if (collf) then begin
  				      tstr = typeval[collstr];
  			        pos1 = 0;
  			        ExtractObj(tstr,pos1,uloc1);
  			        if (uloc1==INr.Code) then begin
  			          ExtractObj(tstr,pos1,uloc1);
  			          if (blank(uloc1)) then begin
  			            typeval[collstr] = INr.Code & ";" & INr.Reference;
  			          end;
  			        end else begin
  			          typeval[collstr] = INr.Code & ";" & INr.Reference;
  			        end;  
  				      collf = false;
  				    end;
  				    if (metalf) then begin
  		          tstr = typeval[metalstr];
  			        pos1 = 0;
  			        ExtractObj(tstr,pos1,uloc1);
  			        if (uloc1==INr.Code) then begin
  			          ExtractObj(tstr,pos1,uloc1);
  			          if (blank(uloc1)) then begin
  			            typeval[metalstr] = INr.Code & ";" & INr.Metal;
  			          end;
  			        end else begin
  			          typeval[metalstr] = INr.Code & ";" & INr.Metal;
  			        end;
  				      metalf = false;
  				    end;//if classifications in custom separate fields }
  				  end;
  				end; //Edit***************************Sasha2,14:30 08.02.2016 }
  		  end;
  		  ExtractObj(INr.DispGroups,pos,uloc);
  		end;
  	 //Edit***************************Sasha2,16:37 18.02.2016
		end else begin
		  ExtractObj(INr.DispGroups,pos,uloc);
		  DIr.Code = uloc;
		  readfirstmain(DIr,1,true)
		  outstring(0,0,DIr.Name,false);
		end;
		
		ExtractObj(INr.DispGroups,pos,uloc);
		if(currentcompany==9)then begin
			if(uloc=="GOODS")then begin
				ExtractObj(INr.DispGroups,pos,uloc);
			end;
		end;
		if(currentcompany==13)then begin
			outstring(0,0,model,false);
		end;
		outstring(0,0,INr.Name,false);

		if (addclassf) then begin //Edit***************************Sasha2,16:36 18.02.2016
  		outstring(0,0,INr.RowWeight,false); //Ves
  		outstring(0,0,INr.MajStoneDet,false);  //Karatnoct
		end; //Edit***************************Sasha2,16:36 18.02.2016
		
		if(currentcompany==29)then begin
			ORr.SerNr = mid(serial,3,len(serial)-12);
			stock = "";
			if(readfirstmain(ORr,1,true))then begin
				mtrw = matrowcnt(ORr);
				for (c=0;c<mtrw;c=c+1) begin
					matrowget(ORr,c,ORrw);
					if(ORrw.ArtCode==INr.Code)then begin
						if(blank(stock))then begin
							stock = ORrw.ECReservStock;
						end else begin
							stock = stock & "," & ORrw.ECReservStock;
						end;
					end;
				end;
			end;
			outstring(0,0,mid(serial,3,len(serial)-12),false); 
			outstring(0,0,stock,false);
		end;
			outstring(0,0,BPICodeToName(INr.BPIBrand),false);
			outstring(0,0,BPICodeToName(INr.BPICollection),false); 
			outstring(0,0,BPICodeToName(INr.BPIGroup),false); 
			outstring(0,0,BPICodeToName(INr.BPISubGroup),false); 
			outstring(0,0,BPICodeToName(INr.BPICategory),false); 
			outstring(0,0,BPICodeToName(INr.BPIMaterial),false); 
			outstring(0,0,BPICodeToName(INr.BPIColor),false);
			
			outstring(0,0,INr.High,false);								
			outstring(0,0,INr.Life2,false);	
			
			outstring(0,0,BPICodeToName(INr.BPISize),false); 
			outstring(0,0,BPICodeToName(INr.BPIUse),false);
			outstring(0,0,BPICodeToName(INr.BPISex),false);
			
			if(CurrentCompany==13) then begin
				outstring(0,0,INr.Colour,false); 
				outstring(0,0,BPICodeToName(INr.BPIColor),false); 
				outstring(0,0,BPICodeToName(INr.BPIShape),false); 
				outstring(0,0,INr.Size,false); 
				outstring(0,0,BPICodeToName(INr.BPISize),false); 
			end else begin	
				
				outstring(0,0,BPICodeToName(INr.BPIPlating),false);
				if(currentcompany==25 or currentcompany==18)then begin
					//outstring(0,0,INr.MainDisp,false); 
					outstring(0,0,INr.SNOne,false);
				end else begin
					//outstring(0,0,"",false); 
					outstring(0,0,"",false);
				end;
				
				outstring(0,0,BPICodeToName(INr.BPIClarity),false); 
				outstring(0,0,BPICodeToName(INr.BPIWeight),false); 
				outstring(0,0,BPICodeToName(INr.BPICut),false); 
				outstring(0,0,BPICodeToName(INr.BPIShape),false); 
				 
			end;
			
			outstring(0,0,BPICodeToName(INr.BPIStone),false); 
			outstring(0,0,BPICodeToName(INr.BPIStrap),false);
			outstring(0,0,BPICodeToName(INr.BPIOdour),false); 
		outstring(0,0,serial,false);// Edit ************************** Tuesday, 7 May 2013 10:13:07
		INCr.Code = INr.Code;
		if(readfirstmain(INCr,1,true))then begin
			outstring(0,0,USetStr(31180),false);
		end else begin
			outstring(0,0,"",false);
		end;
		
			outstring(0,0,dat,false);
		outstring(0,0,instock,false);
		outstring(0,0,reserve,false);
		outstring(0,0,INr.Unittext,false);
		total_qty = total_qty + instock;
		GetFullCurncyRate(INr.LastPurchCurncyCode,todate,fr,to1,to2,br1,br2);
		if(fr==0 or to1==0)then begin
			fr=1; to1=0;
		end;
		
		/* if(CurrentUser!="SA1")then begin
			awercost = 0;
			awercostcur = 0;
			awercostbrandcur = 0;
			awercost = FindAwerageCost(INr.Code,ISr.Location,INr.LastPurchCurncyCode,todate,realcur);
			FindAwerageCostCurProc(INr.Code,ISr.Location,INr.LastPurchCurncyCode,todate,realcur,brandcur,curcost,curcost2);
			awercostcur = curcost;
			awercostbrandcur = curcost2;
		end else begin */
			awercost = 0;
			awercostcur = 0;
			awercostbrandcur = 0;
			qtyDup = 0;
			MyFindAwerageCost(INr.Code,ISr.Location,INr.LastPurchCurncyCode,todate,realcur,brandcur,cost,curcost,curcost2, curqty);
			if (curqty>0) then begin
				qtyDup = 1;
			end;
			awercost = cost;
			awercostcur = curcost;
			awercostbrandcur = curcost2;
			IDr.OrigCode = INr.Code;
			pos = 0;
			ExtractObjWithSeparator(",",DubCodes[INr.Code],true,pos,Dubl);
			//ExtractObj(DubCodes[INr.Code],pos,Dubl);// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 03 11 2020 y. at 12:25:55 PM
			while(nonblank(Dubl)) begin
				dupINr.Code = Dubl;
				if(ReadFirstMain(dupINr,1,true)) then begin
					testf2 = true;
					if(RepSpec.flags[1]==1 and dupINr.ConsgType==0)then begin testf2 = false; end;	
					if(RepSpec.flags[2]==1 and dupINr.ConsgType==1)then begin testf2 = false; end;
					if(RepSpec.flags[3]==1 and dupINr.ConsgType==2)then begin testf2 = false; end;	
					if(testf2)then begin
						MyFindAwerageCost(dupINr.Code,ISr.Location,dupINr.LastPurchCurncyCode,todate,realcur,brandcur,cost,curcost,curcost2, curqty);
						if(curqty>0) then begin 
							awercost = awercost + cost;
							awercostcur = awercostcur + curcost;
							awercostbrandcur = awercostbrandcur + curcost2;
							qtyDup = qtyDup + 1;
						end;
					end;
				end;
				ExtractObjWithSeparator(",",DubCodes[INr.Code],true,pos,Dubl);
				//ExtractObj(DubCodes[INr.Code],pos,Dubl);// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 03 11 2020 y. at 12:25:54 PM
			end;
		// end;
		awercost = awercost / qtyDup;
		awercostcur = awercostcur / qtyDup;
		awercostbrandcur = awercostbrandcur / qtyDup;
		
		
		if(costprice>0 and nonblank(serial) and INr.SerNrf>0)then begin
			awercost = costprice;
			IHr.ArtCode = INr.Code;
			IHr.SerialNr = serial;
			IHr.FileName = "PUVc";
			if(readlastkey("ArtCodeSerialNr",IHr,3,true))then begin
				PUr.SerNr = IHr.TransNr;
				readfirstmain(PUr,1,true);
				matrowget(PUr,IHr.Row,PUrw);
				awercostcur = PUrw.UPrice;
			end else begin
				IHr.ArtCode = INr.Code;
				IHr.SerialNr = serial;
				IHr.FileName = "IVVc";
				readfirstkey("ArtCodeSerialNr",IHr,3,true);
				IVr.SerNr = IHr.TransNr;
				readfirstmain(IVr,1,true);
				matrowget(IVr,IHr.Row,IVrw);
				awercostcur = IVrw.Sum;
			end;
		end;
		
	
		
		
		if(usercanaction("ViewCostPrice",true))then begin
			outstring(0,0,awercostcur,false);
			if(nonblank(brandcur))then begin
				outstring(0,0,awercostbrandcur,false);
			end;
			outstring(0,0,awercost,false);
			outstring(0,0,awercostcur*instock,false);
			outstring(0,0,awercost*instock,false);
			if(left(currentuser,2)=="SA")then begin
				//logtext(0,"INr.LastPurchCurncyCode 3 " & INr.LastPurchCurncyCode);
			end;
			outval(0,0,INr.LastPurchPrice2,m4val,false);
			if(nonblank(brandcur))then begin
				outstring(0,0,awercostbrandcur*instock,false);
			end;
		end;
		

		total_cost = total_cost + awercost*instock;
		if(CurrentCompany==18) then begin
			CIr.Code = INr.Code;
			if(ReadFirstMain(CIr,1,true)) then begin
				BBr.Code = INr.BPIBrand;
				if(ReadFirstMain(BBr,1,true)) then begin
					if(nonblank(BBr.CompanyPrice)) then begin
						SetCompany(stringtoint(BBr.CompanyPrice),false);
						INr.Code = CIr.LocCode;
						ReadFirstMain(INr,1,true);
						ISr.Code = INr.Code;
						compchange = true;
					end;
				end;
			end;
		end;
		baseprice = 0;
		brandprice = 0;
		PLr.ArtCode = ISr.Code;
		PLr.PLCode = "RRP";
		PLr.CustCode = "";
		PLr.SerialNr = serial;
		
		if(readfirstmain(PLr,4,true))then begin
			if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP" and PLr.SerialNr==serial)then begin
				price = PLr.ExVatPrice;
				PLDefr.Code = "RRP";
				readfirstmain(PLDefr,1,true);
				pricecur = PLDefr.CurncyCode;
				if(nonblank(PLr.CurncyCode))then begin
					pricecur = PLr.CurncyCode;
				end;
			end;
		end;		
		if(price==0)then begin
			cnt = 0;
			PLr.ArtCode = ISr.Code;
			PLr.PLCode = "RRP";
			while(loopmain(PLr,2,(PLr.ArtCode==ISr.Code)))begin
				if(PLr.ArtCode==ISr.Code)then begin
					price = price + PLr.ExVatPrice;
					cnt = cnt + 1;
					PLDefr.Code = "RRP";
					readfirstmain(PLDefr,1,true);
					pricecur = PLDefr.CurncyCode;
					if(nonblank(PLr.CurncyCode))then begin
						pricecur = PLr.CurncyCode;
					end;
				end;
			end;
			resetloop(PLr);
			price = price/cnt;
		end;
		GetFullCurncyRate(pricecur,todate,fr,to1,to2,br1,br2);
		if(fr==0 or to1==0)then begin
			fr=1; to1=1;
		end;
		baseprice = price/fr*to1;
		if(pricecur!=INr.LastPurchCurncyCode)then begin
			GetFullCurncyRate(INr.LastPurchCurncyCode,todate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			price = baseprice*fr/to1;
		end;
		
		if(addclassf)then begin
			baseprice5 = round(baseprice,rmode5);	//Edit----------------------Dima  17.04.2015
		end else begin
			baseprice5 = baseprice;
		end;
		
		if(currentcompany==10)then begin
			PLr.ArtCode = ISr.Code;
			PLr.PLCode = "RRP";
			PLr.CustCode = "";
		
			if(readfirstmain(PLr,3,true))then begin
				if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP")then begin
					baseprice5 = PLr.ExVatPrice;
					baseprice = PLr.ExVatPrice;
				end;
			end;	
		end;
		
		if(nonblank(brandcur))then begin
			GetFullCurncyRate(brandcur,todate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				GetFullCurncyRate(brandcur,currentdate,fr,to1,to2,br1,br2);
				if(fr==0 or to1==0)then begin
					fr=1; to1=1;
				end;
			end;
			brandprice = baseprice / to1 * fr;
		end; 
		if(RepSpec.flags[6]) then begin
			GetPriceItem(INr.Code,inprice,ITRebate);
			if (GetTempItemPrice(TempItemPrice,INr.Code,tpcurrency,CurrentDate,obj)) then begin
				if(tpcurrency!="AZN")then begin
					crn = tpcurrency;
					sd = CurrentDate;
					fr = 0;
					to1 = 0;
					to2 = 0;
					br1 = 0;
					br2 = 0;
					GetFullCurncyRate(crn,sd,fr,to1,to2,br1,br2);
					TempItemPrice = TempItemPrice/fr*to1;
				end;
			end;
			for(i=0;i<matrowcnt(CROb); i=i+1) begin
				matrowget(CROb,i,CRObrw);
				if(CRObrw.CurncyCode=="AZN" and CRObrw.VcName== "IVVc") then begin
					i = matrowcnt(CROb);
				end;
			end;
				if(TempItemPrice!=0) begin
					outstring(0,0,round(TempItemPrice - TempItemPrice*ITRebate/100,SetRoundModeD(CRObrw.RndRowsumMode)),false);
				end else begin
					outstring(0,0,round(inprice - inprice*ITRebate/100,SetRoundModeD(CRObrw.RndRowsumMode)),false);
				end; 
		end;
			outval(0,0,price,m4val,false);
			if(nonblank(brandcur))then begin
				outval(0,0,brandprice,m4val,false);
			end;
			outval(0,0,baseprice5,m4val,false);
			//outstring(0,0,baseprice,false);
			outstring(0,0,price*instock,false);
			if(nonblank(brandcur))then begin
				outval(0,0,brandprice*instock,m4val,false);
			end;
			outstring(0,0,baseprice*instock,false);
		total_price = total_price + baseprice*instock;
		if(left(currentuser,2)=="SA")then begin
			//logtext(0,"INr.LastPurchCurncyCode 2 " & INr.LastPurchCurncyCode);
		end;
		if(left(currentuser,2)=="SA")then begin
				//logtext(0,"INr.LastPurchCurncyCode 4 " & INr.LastPurchCurncyCode);
			end;
			outstring(0,0,INr.LastPurchCurncyCode,false);
			if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
				for (i=30;i<typescnt;i=i+1) begin //if you change "30" do it in other places having "For" loop 
					pos = 0;
					ExtractObjWithSeparator(";",typeval[typecode[i]],true,pos,uloc);
					if (uloc==INr.Code) then begin
						ExtractObjWithSeparator(";",typeval[typecode[i]],true,pos,uloc);
						outstring(0,0,uloc,false);
					end else begin
						outstring(0,0,"",false);
					end;
				end;
			end; //Edit***************************Sasha2,14:37 08.02.2016 }
		FindAndStoreINVcImgLink(INr,currentcompany,tstr2,filename);
		if(left(tstr2,8)=="webcust/")then begin
			tstr2 = right(tstr2,len(tstr2)-8);
		end;
		if(nonblank(tstr2))then begin
			tstr2 = "http://" & RepSpec.f9 & "/" & tstr2;
		end else begin
			tstr2 = "";
		end;
		outstring(0,0,tstr2,false);
		outstring(0,0,INr.GlobalArtCode,false);
		endformat;
		if(compchange) then begin
			ResetCompany(18);
		end;
return;
end;


procedure PrintInfoID(record INVc INr, record ItemStatusVc ISr,string serial,val serstock,val costprice,date todate,var val total_qty,var val total_cost,var val total_price,var vector string typeval,array string typecode,Integer typescnt,boolean addclassf,string realcur,string brandcur,record RcVc RepSpec)
begin 
	record DIVc DIr;
	record PLVc PLr;
	integer pos,cnt,i,pos1,mtrw,c;
  string 50 uloc,pricecur,uloc1;
  val fr,to1,to2,br1,br2;
  val baseprice,cur,price,baseprice5,brandprice;
  record INConsVc INCr;
	val instock,awercost,awercostcur,awercostbrandcur,curcost2,curcost,cost;
	record PLDefVc PLDefr;
	record ItemHistVc IHr;
	record PUVc PUr,PUIHr;
	row PUVc PUrw;
  record IVVc IVr;
  row IVVc IVrw;
  roundmode rmode5;
  string 255 brand,model,tstr,tstr2,filename,serverip,stock,reserve;
  Boolean collf,metalf;
  string 20 collstr,metalstr;
	record OldDIVc OldDIr;
  boolean TrHs, testf;
	record ORVc ORr;
	row ORVc ORrw;
	record BPIBrandVc Brndr;
	val curqty;
	date dat;
	
  rmode5 = SetRoundMode(0,kRoundingDirectionToFromPosInf,kRoundingModeHalfUp,/*kRoundingStep5*/kRoundingStepNone);	//Edit----------------------Dima  17.04.2015
  
	IHr.ArtCode=INr.Code;
	IHr.FileName="PUVc";
	IHr.TransDate=todate;
	TrHS = true;
	while (LoopBackKey("FNArtCode",IHr,3,TrHS)) begin
		testf = true;
		if(IHr.ArtCode!=INr.Code)then begin TrHS = false; end;
		if(IHr.FileName!="PUVc")then begin TrHS = false; end;
		if(nonblank(ISr.Variety) and ISr.Variety!=IHr.Variety)then begin testf = false; end;
		PUIHr.SerNr = IHr.TransNr;
		if(ReadFirstMain(PUIHr,1,true))then begin
			if(left(PUIHr.VECode,3)=="FOB")then begin testf = false; end;
		end else begin
			testf = false;
		end;
		if(TrHS and testf)then begin
			dat = IHr.TransDate;
			TrHS = false;
		end;
	end;
	ResetLoop(IHr);
  if(serstock==0)then begin
  	instock = ISr.Instock;
		reserve = ISr.RsrvQty;
  end else begin
  	instock = serstock;
  end;
  
	// if(nonblank(ISr.Variety))then begin
		// INr.Code = INr.Code & ISr.Variety;
	// end;
	
	startformat(15);
		DIr.Code = INr.DispGroups;
		readfirstmain(DIr,1,true);
		if(nonblank(ISr.Variety)) then begin
			PLr.ArtCode = ISr.Code & ISr.Variety;
		end else begin
			PLr.ArtCode = ISr.Code;
		end;
		PLr.PLCode = "RRP";
		PLr.SerialNr = serial;
		if(readfirstmain(PLr,3,true))then begin
			if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP" and PLr.SerialNr==serial)then begin
				price = PLr.ExVatPrice;
			end;
		end;	
		if(nonblank(ISr.Variety))then begin
			outstring(0,0,INr.Code & ISr.Variety,false);
		end else begin
			outstring(0,0,INr.Code,false);
		end;
		outstring(0,0,INr.AlternativeCode,false);
		outstring(0,0,INr.OrigCode,false);
		outstring(0,0,INr.BarCode,false);
		outstring(0,0,INr.SN,false);
		outstring(0,0,ISr.Location,false);
		if(currentcompany==18)then begin
			Brndr.Code = INr.BPIBrand;
			if(readfirstmain(Brndr,1,true))then begin
				outstring(0,0,Brndr.CWHCode,false);//mesto
			end else begin
				outstring(0,0,"",false);//nema mesta
			end;
			outstring(0,0,INr.Department,false);//stelaj
			outstring(0,0,INr.InvCode,false);//polka
		end;
		pos = 0;
		brand = "";
		model = "";
		if (CurrentCompany!=13) then begin
  		ExtractObj(INr.DispGroups,pos,uloc);
  		while (NonBlank(uloc)) begin
  		  DIr.Code = uloc;
  		  if (readfirstmain(DIr,1,true)) then begin
  		    if (DIr.CType=="BRAND") then begin
  		      brand = DIr.Name;
  		    end;
  		    if (DIr.CType=="MODEL") then begin
  		      model = DIr.Name;
  		    end;
  		    if (addclassf and NonBlank(DIr.CType)) then begin //Edit***************************Sasha2,14:30 08.02.2016 {
  				  if (DIr.CType=="GENDER") then begin
  				    switch (Left(UpperCase(INr.MainDisp),1)) begin
  				      case "A":
        				  DIr.CType = DIr.CType & "_A";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				      case "J":
  				        DIr.CType = DIr.CType & "_J";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				      case "W":
  				        DIr.CType = DIr.CType & "_W";
        				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				    end;
  				  end else begin
  				    typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
  				    switch (Left(UpperCase(INr.MainDisp),1)) begin //if classifications in custom separate fields {
  				      case "A":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_A";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_A";
  				        end;
  				      case "J":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_J";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_J";
  				        end;
  				        if (NonBlank(INr.RowWeight)) then begin
  				          tstr = typeval["WEIGHT"];
      			        pos1 = 0;
      			        ExtractObj(tstr,pos1,uloc1);
      			        if (uloc1==INr.Code) then begin
      			          ExtractObj(tstr,pos1,uloc1);
      			          if (blank(uloc1)) then begin
      			            typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
      			          end;
      			        end else begin
      			          typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
      			        end;
  				        end;
  				        if (NonBlank(INr.MajStoneDet)) then begin
  				          tstr = typeval["D_CARAT"];
      			        pos1 = 0;
      			        ExtractObj(tstr,pos1,uloc1);
      			        if (uloc1==INr.Code) then begin
      			          ExtractObj(tstr,pos1,uloc1);
      			          if (blank(uloc1)) then begin
      			            typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
      			          end;
      			        end else begin
      			          typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
      			        end;
  				        end;
  				      case "W":
  				        if (NonBlank(INr.Reference)) then begin
  				          collf = true;
  				          collstr = "COLL_W";
  				        end;
  				        if (NonBlank(INr.Metal)) then begin
  				          metalf = true;
  				          metalstr = "MATERIAL_W";
  				        end;
  				    end; 
  				    if (collf) then begin
  				      tstr = typeval[collstr];
  			        pos1 = 0;
  			        ExtractObj(tstr,pos1,uloc1);
  			        if (uloc1==INr.Code) then begin
  			          ExtractObj(tstr,pos1,uloc1);
  			          if (blank(uloc1)) then begin
  			            typeval[collstr] = INr.Code & ";" & INr.Reference;
  			          end;
  			        end else begin
  			          typeval[collstr] = INr.Code & ";" & INr.Reference;
  			        end;  
  				      collf = false;
  				    end;
  				    if (metalf) then begin
  		          tstr = typeval[metalstr];
  			        pos1 = 0;
  			        ExtractObj(tstr,pos1,uloc1);
  			        if (uloc1==INr.Code) then begin
  			          ExtractObj(tstr,pos1,uloc1);
  			          if (blank(uloc1)) then begin
  			            typeval[metalstr] = INr.Code & ";" & INr.Metal;
  			          end;
  			        end else begin
  			          typeval[metalstr] = INr.Code & ";" & INr.Metal;
  			        end;
  				      metalf = false;
  				    end;//if classifications in custom separate fields }
  				  end;
  				end; //Edit***************************Sasha2,14:30 08.02.2016 }
  		  end;
  		  ExtractObj(INr.DispGroups,pos,uloc);
  		end;
  	 //Edit***************************Sasha2,16:37 18.02.2016
		end else begin
		  ExtractObj(INr.DispGroups,pos,uloc);
		  DIr.Code = uloc;
		  readfirstmain(DIr,1,true)
		  outstring(0,0,DIr.Name,false);
		end;
		
		ExtractObj(INr.DispGroups,pos,uloc);
		if(currentcompany==9)then begin
			if(uloc=="GOODS")then begin
				ExtractObj(INr.DispGroups,pos,uloc);
			end;
		end;
		if(currentcompany!=13)then begin
			if(CompanyIsJWLikeCompany(currentcompany)==false)then begin
				if(nonblank(INr.BPIBrand)) then begin
					outstring(0,0,BPICodeToName(INr.BPIBrand),false);
				end else begin 
					outstring(0,0,brand,false); //Edit***************************Sasha2,16:37 18.02.2016
				end;
			end else begin
				outstring(0,0,BPICodeToName(INr.BPIBrand),false);
			end;
		end;
		outstring(0,0,INr.Name,false);
		if(currentcompany!=13)then begin
			if(nonblank(INr.BPICollection)) then begin
				outstring(0,0,BPICodeToName(INr.BPICollection),false);
			end else begin
				outstring(0,0,model,false);
			end;
		end else begin
			outstring(0,0,"",false);
		end;	
		if (addclassf) then begin //Edit***************************Sasha2,16:36 18.02.2016
  		outstring(0,0,INr.RowWeight,false); //Ves
  		outstring(0,0,INr.MajStoneDet,false);  //Karatnoct
		end; //Edit***************************Sasha2,16:36 18.02.2016
		
		if(currentcompany==29)then begin
			ORr.SerNr = mid(serial,3,len(serial)-12);
			stock = "";
			if(readfirstmain(ORr,1,true))then begin
				mtrw = matrowcnt(ORr);
				for (c=0;c<mtrw;c=c+1) begin
					matrowget(ORr,c,ORrw);
					if(ORrw.ArtCode==INr.Code)then begin
						if(blank(stock))then begin
							stock = ORrw.ECReservStock;
						end else begin
							stock = stock & "," & ORrw.ECReservStock;
						end;
					end;
				end;
			end;
			outstring(0,0,mid(serial,3,len(serial)-12),false); 
			outstring(0,0,stock,false);
		end;
	
			outstring(0,0,BPICodeToName(INr.BPIGroup),false); 
			outstring(0,0,BPICodeToName(INr.BPISubGroup),false); 
			outstring(0,0,BPICodeToName(INr.BPICategory),false); 
			outstring(0,0,BPICodeToName(INr.BPIMaterial),false); 
			if(CurrentCompany==13) then begin
				outstring(0,0,INr.Colour,false); 
				outstring(0,0,BPICodeToName(INr.BPIColor),false); 
				outstring(0,0,BPICodeToName(INr.BPIShape),false); 
				outstring(0,0,INr.Size,false); 
				outstring(0,0,BPICodeToName(INr.BPISize),false); 
			end else begin	
				outstring(0,0,BPICodeToName(INr.BPIColor),false); 
				outstring(0,0,BPICodeToName(INr.BPIShape),false); 
				outstring(0,0,BPICodeToName(INr.BPISize),false); 
			end;
			outstring(0,0,BPICodeToName(INr.BPIUse),false); 
			outstring(0,0,BPICodeToName(INr.BPISex),false); 
			outstring(0,0,BPICodeToName(INr.BPIPlating),false);
			outstring(0,0,BPICodeToName(INr.BPIClarity),false); 
			outstring(0,0,BPICodeToName(INr.BPIWeight),false); 
			outstring(0,0,BPICodeToName(INr.BPICut),false); 
			outstring(0,0,BPICodeToName(INr.BPIStone),false); 
			outstring(0,0,BPICodeToName(INr.BPIStrap),false); 
			outstring(0,0,BPICodeToName(INr.BPIOdour),false); 
			if(currentcompany==25)then begin
				outstring(0,0,INr.MainDisp,false); 
				outstring(0,0,INr.SNOne,false);
			end;
			
		outstring(0,0,serial,false);// Edit ************************** Tuesday, 7 May 2013 10:13:07
		INCr.Code = INr.Code;
		if(readfirstmain(INCr,1,true))then begin
			outstring(0,0,USetStr(31180),false);
		end else begin
			outstring(0,0,"",false);
		end;
		
			outstring(0,0,dat,false);
		outstring(0,0,instock,false);
		outstring(0,0,reserve,false);
		outstring(0,0,INr.Unittext,false);
		total_qty = total_qty + instock;
		GetFullCurncyRate(INr.LastPurchCurncyCode,todate,fr,to1,to2,br1,br2);
		if(fr==0 or to1==0)then begin
			fr=1; to1=0;
		end;
		
		/* if(CurrentUser!="SA1")then begin
			awercost = 0;
			awercostcur = 0;
			awercostbrandcur = 0;
			awercost = FindAwerageCost(INr.Code,ISr.Location,INr.LastPurchCurncyCode,todate,realcur);
			FindAwerageCostCurProc(INr.Code,ISr.Location,INr.LastPurchCurncyCode,todate,realcur,brandcur,curcost,curcost2);
			awercostcur = curcost;
			awercostbrandcur = curcost2;
		end else begin */
			awercost = 0;
			awercostcur = 0;
			awercostbrandcur = 0;
			MyFindAwerageCost(INr.Code & ISr.Variety,ISr.Location,INr.LastPurchCurncyCode,todate,realcur,brandcur,cost,curcost,curcost2,curqty);
			awercost = cost;
			awercostcur = curcost;
			awercostbrandcur = curcost2;
		// end;
		
		
		if(costprice>0 and nonblank(serial) and INr.SerNrf>0)then begin
			awercost = costprice;
			IHr.ArtCode = INr.Code;
			IHr.SerialNr = serial;
			IHr.FileName = "PUVc";
			if(readlastkey("ArtCodeSerialNr",IHr,3,true))then begin
				PUr.SerNr = IHr.TransNr;
				readfirstmain(PUr,1,true);
				matrowget(PUr,IHr.Row,PUrw);
				awercostcur = PUrw.UPrice;
			end else begin
				IHr.ArtCode = INr.Code;
				IHr.SerialNr = serial;
				IHr.FileName = "IVVc";
				readfirstkey("ArtCodeSerialNr",IHr,3,true);
				IVr.SerNr = IHr.TransNr;
				readfirstmain(IVr,1,true);
				matrowget(IVr,IHr.Row,IVrw);
				awercostcur = IVrw.Sum;
			end;
		end;
		
	
		
		
		if(usercanaction("ViewCostPrice",true))then begin
			outstring(0,0,awercostcur,false);
			if(nonblank(brandcur))then begin
				outstring(0,0,awercostbrandcur,false);
			end;
			outstring(0,0,awercost,false);
			outstring(0,0,awercostcur*instock,false);
			outstring(0,0,awercost*instock,false);
			if(left(currentuser,2)=="SA")then begin
				//logtext(0,"INr.LastPurchCurncyCode 3 " & INr.LastPurchCurncyCode);
			end;
			outval(0,0,INr.LastPurchPrice2,m4val,false);
			if(nonblank(brandcur))then begin
				outstring(0,0,awercostbrandcur*instock,false);
			end;
		end;
		

		total_cost = total_cost + awercost*instock;
		
		baseprice = 0;
		brandprice = 0;
		if(nonblank(ISr.Variety)) then begin
			PLr.ArtCode = ISr.Code & ISr.Variety;
		end else begin
			PLr.ArtCode = ISr.Code;
		end;
		PLr.PLCode = "RRP";
		PLr.CustCode = "";
		PLr.SerialNr = serial;
		
		if(readfirstmain(PLr,4,true))then begin
			if(PLr.ArtCode==ISr.Code & ISr.Variety and PLr.PLCode=="RRP" and PLr.SerialNr==serial)then begin
				price = PLr.ExVatPrice;
				PLDefr.Code = "RRP";
				readfirstmain(PLDefr,1,true);
				pricecur = PLDefr.CurncyCode;
				if(nonblank(PLr.CurncyCode))then begin
					pricecur = PLr.CurncyCode;
				end;
			end;
		end;		
		if(price==0)then begin
			cnt = 0;
			PLr.ArtCode = ISr.Code & ISr.Variety;
			PLr.PLCode = "RRP";
			while(loopmain(PLr,2,(PLr.ArtCode==ISr.Code & ISr.Variety)))begin
				if(PLr.ArtCode==ISr.Code & ISr.Variety)then begin
					price = price + PLr.ExVatPrice;
					cnt = cnt + 1;
					PLDefr.Code = "RRP";
					readfirstmain(PLDefr,1,true);
					pricecur = PLDefr.CurncyCode;
					if(nonblank(PLr.CurncyCode))then begin
						pricecur = PLr.CurncyCode;
					end;
				end;
			end;
			resetloop(PLr);
			price = price/cnt;
		end;
		GetFullCurncyRate(pricecur,todate,fr,to1,to2,br1,br2);
		if(fr==0 or to1==0)then begin
			fr=1; to1=1;
		end;
		baseprice = price/fr*to1;
		if(pricecur!=INr.LastPurchCurncyCode)then begin
			GetFullCurncyRate(INr.LastPurchCurncyCode,todate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			price = baseprice*fr/to1;
		end;
		if(addclassf)then begin
			baseprice5 = round(baseprice,rmode5);	//Edit----------------------Dima  17.04.2015
		end else begin
			baseprice5 = baseprice;
		end;
		
		if(currentcompany==10)then begin
			PLr.ArtCode = ISr.Code & ISr.Variety;
			PLr.PLCode = "RRP";
			PLr.CustCode = "";
		
			if(readfirstmain(PLr,3,true))then begin
				if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP")then begin
					baseprice5 = PLr.ExVatPrice;
					baseprice = PLr.ExVatPrice;
				end;
			end;	
		end;
		
		
		
		if(nonblank(brandcur))then begin
			GetFullCurncyRate(brandcur,todate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				GetFullCurncyRate(brandcur,currentdate,fr,to1,to2,br1,br2);
				if(fr==0 or to1==0)then begin
					fr=1; to1=1;
				end;
			end;
			brandprice = baseprice / to1 * fr;
		end; 
		outval(0,0,price,m4val,false);
		if(nonblank(brandcur))then begin
			outval(0,0,brandprice,m4val,false);
		end;
		outval(0,0,baseprice5,m4val,false);
		//outstring(0,0,baseprice,false);
		outstring(0,0,price*instock,false);
		if(nonblank(brandcur))then begin
			outval(0,0,brandprice*instock,m4val,false);
		end;
		outstring(0,0,baseprice*instock,false);
		total_price = total_price + baseprice*instock;
		if(left(currentuser,2)=="SA")then begin
			//logtext(0,"INr.LastPurchCurncyCode 2 " & INr.LastPurchCurncyCode);
		end;
		if(left(currentuser,2)=="SA")then begin
				//logtext(0,"INr.LastPurchCurncyCode 4 " & INr.LastPurchCurncyCode);
			end;
		outstring(0,0,INr.LastPurchCurncyCode,false);
		if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
		  for (i=30;i<typescnt;i=i+1) begin //if you change "30" do it in other places having "For" loop 
		    pos = 0;
		    ExtractObjWithSeparator(";",typeval[typecode[i]],true,pos,uloc);
		    if (uloc==INr.Code) then begin
		      ExtractObjWithSeparator(";",typeval[typecode[i]],true,pos,uloc);
          outstring(0,0,uloc,false);
        end else begin
          outstring(0,0,"",false);
		    end;
		  end;
		end; //Edit***************************Sasha2,14:37 08.02.2016 }
	FindAndStoreINVcImgLink(INr,currentcompany,tstr2,filename);
	if(left(tstr2,8)=="webcust/")then begin
		tstr2 = right(tstr2,len(tstr2)-8);
	end;
	if(nonblank(tstr2))then begin
		tstr2 = "http://" & RepSpec.f9 & "/" & tstr2;
	end else begin
		tstr2 = "";
	end;
	outstring(0,0,tstr2,false);
	outstring(0,0,INr.GlobalArtCode,false);
	endformat;

return;
end;




procedure PrintInfoWeb(record INVc INr, record ItemStatusVc ISr,string serial,val serstock,val costprice,date todate,var area webpage1,string serverip,roundmode rnd,integer dispcur,string basecurr) //Edit***************************Sasha2,15:48 21.04.2015
begin 
	record DIVc DIr;
	record PLVc PLr;
	integer pos,cnt;
  string 50 uloc,pricecur;
  val fr,to1,to2,br1,br2;
  val baseprice,cur,price;
  record INConsVc INCr;
	val instock,awercost,awercostcur;
	record PLDefVc PLDefr;
	record ItemHistVc IHr;
	record PUVc PUr;
	row PUVc PUrw;
  record IVVc IVr;
  row IVVc IVrw;
  record Attach2Vc Attachr;
	record RLinkVc RLr;
	string 255 filename,uid,res,inrcode,tstr;
	string 50 comfolder,modelname,brandname;
	record CompaniesBlock Compb;//Edit-------------------Vitalii 14:14 25.12.2015
	row CompaniesBlock Comprw;//Edit-------------------Vitalii 14:14 25.12.2015
	Boolean founddi; //Edit***************************Sasha2,10:45 25.01.2016
	string 50 realcur,brandcur;
	val curcost,curcost2;
	record OldDIVc OldDIr;
	
  if(serstock==0)then begin
  	instock = ISr.Instock;
  end else begin
  	instock = serstock;
  end;
  
	ExportString("<tr>");
		/*DIr.Code = INr.DispGroups;
		readfirstmain(DIr,1,true);*/
		PLr.ArtCode = ISr.Code;
		PLr.PLCode = "RRP";
		PLr.SerialNr = serial;
		if(readfirstmain(PLr,3,true))then begin
			if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP" and PLr.SerialNr==serial)then begin
				price = PLr.ExVatPrice;
			end;
		end;
				
		ExportString("<td height=\"300\">" & INr.Code & "</td>");
		if(currentcompany!=25)then begin
			ExportString("<td>" & INr.AlternativeCode & "</td>");
		end;
		ExportString("<td>" & INr.BarCode & "</td>");
		ExportString("<td>" & ISr.Location & "</td>");
		if(currentcompany==25)then begin
			ExportString("<td>" & INr.MainDisp & "</td>");
			OldDIr.Code = INr.SNOne;
			ExportString("<td>" & INr.SNOne & "</td>");
		end;
		pos = 0;
		uloc = ""; 
		founddi = false; //Edit***************************Sasha2,10:13 25.01.2016 {
		modelname = BPICodeToName(INr.BPICollection);
		brandname = BPICodeToName(INr.BPIBrand);
		
	/*	ExtractObj(INr.DispGroups,pos,uloc);		
		while(nonblank(uloc)) begin
			DIr.Code = uloc;
			readfirstmain(DIr,1,true);
			if(DIr.CType=="BRAND")then begin
				brandname = DIr.Name;
			end;
			if(DIr.CType=="MODEL")then begin
				modelname = DIr.Name;
			end;
			ExtractObj(INr.DispGroups,pos,uloc);
		end; */
		if(currentcompany!=25)then begin
			ExportString("<td>" & brandname & "</td>");
			ExportString("<td>" & modelname & "</td>");
		end;
		
		/*ExtractObj(INr.DispGroups,pos,uloc);
		DIr.Code = uloc;
		readfirstmain(DIr,1,true);
		ExportString("<td>" & DIr.Name & "</td>");
		//pos = 1;
		ExtractObj(INr.DispGroups,pos,uloc);
		DIr.Code = uloc;
		readfirstmain(DIr,1,true);*/

		ExportString("<td>" & INr.Name & "</td>");
		ExportString("<td>" & serial & "</td>");// Edit ************************** Tuesday, 7 May 2013 10:13:07
		ExportString("<td>" & instock & "</td>");
		
		realcur = INr.LastPurchCurncyCode;
		curcost = blankval;
		FindAwerageCostCurProc(INr.Code,ISr.Location,INr.LastPurchCurncyCode,todate,realcur,brandcur,curcost,curcost2);
		ExportString("<td>" & curcost & INr.LastPurchCurncyCode & "</td>");
		
		GetFullCurncyRate(INr.LastPurchCurncyCode,todate,fr,to1,to2,br1,br2);
		if(fr==0 or to1==0)then begin
			fr=1; to1=0;
		end;
		awercost = 0;
		awercostcur = 0;		
		baseprice = 0;
		PLr.ArtCode = ISr.Code;
		PLr.PLCode = "RRP";
		PLr.CustCode = "";
		PLr.SerialNr = serial;
		
		if(readfirstmain(PLr,4,true))then begin
			if(PLr.ArtCode==ISr.Code and PLr.PLCode=="RRP" and PLr.SerialNr==serial)then begin
				price = PLr.ExVatPrice;
				PLDefr.Code = "RRP";
				readfirstmain(PLDefr,1,true);
				pricecur = PLDefr.CurncyCode;
				if(nonblank(PLr.CurncyCode))then begin
					pricecur = PLr.CurncyCode;
				end;
			end;
		end;
		if(price==0)then begin
			cnt = 0;
			PLr.ArtCode = ISr.Code;
			PLr.PLCode = "RRP";
			while(loopmain(PLr,2,(PLr.ArtCode==ISr.Code)))begin
				if(PLr.ArtCode==ISr.Code)then begin
					price = price + PLr.ExVatPrice;
					cnt = cnt + 1;
					PLDefr.Code = "RRP";
					readfirstmain(PLDefr,1,true);
					pricecur = PLDefr.CurncyCode;
					if(nonblank(PLr.CurncyCode))then begin
						pricecur = PLr.CurncyCode;
					end;
				end;
			end;
			resetloop(PLr);
			price = price/cnt;
		end;
		
		GetFullCurncyRate(pricecur,todate,fr,to1,to2,br1,br2);
		if(fr==0 or to1==0)then begin
			fr=1; to1=1;
		end;
		baseprice = price/fr*to1;
		if(pricecur!=INr.LastPurchCurncyCode)then begin
			GetFullCurncyRate(INr.LastPurchCurncyCode,todate,fr,to1,to2,br1,br2);
			if(fr==0 or to1==0)then begin
				fr=1; to1=1;
			end;
			price = baseprice*fr/to1;
		end;
		switch (dispcur) begin //Edit***************************Sasha2,15:50 21.04.2015 {
  		case 0: 
  		  ExportString("<td>" & price & "</td>");
  		  ExportString("<td>" & round(baseprice,rnd) & "</td>");
  		  
  		  
  		  ExportString("<td>" & INr.LastPurchCurncyCode & "</td>");
  		case 1:
  		  ExportString("<td>" & round(baseprice,rnd) & "</td>");
  		  ExportString("<td>" & basecurr & "</td>");
		end; //Edit***************************Sasha2,15:50 21.04.2015 }
		filename = "";
		res = "";
		uid = "";
		
		BlockLoad(Compb);
		/*MatRowGet(Compb,currentcompany-1,Comprw);
		if (currentcompany==9) then begin
			inrcode = INr.AlternativeCode;
		end else begin
			inrcode = INr.Code;
		end;
		inrcode = imgStrReplace(inrcode);// Edit ************************** Tuesday, 3 October 2017 17:27:01
		
		if (fileexists("webcust/" & Comprw.ShortName & "/" & inrcode & ".jpg")) then begin
			filename = "http://" & serverip & "/" & inrcode & ".jpg";
		end;
		if (fileexists("webcust/" & Comprw.ShortName & "/" & inrcode & ".png")) then begin
			filename = "http://" & serverip & "/" & inrcode & ".png";
		end;*/
    FindAndStoreINVcImgLink(INr,currentcompany,tstr,filename);
    if(left(tstr,8)=="webcust/")then begin
    	tstr = right(tstr,len(tstr)-8);
    end;
    filename = "http://" & serverip & "/" & tstr;
	
		if(nonblank(filename))then begin
			ExportString("<td width=\"300\" height=\"300\" align=\"center\"><div align=\"justify\"><img src=\"" & filename & "?rnd=" & random(1,1000) & "\" width=\"100%\" height=\"100%\"/></div></td>");
		end else begin
			ExportString("<td>Image not found</td>");
		end;
		
	ExportString("</tr>");

return;
end;

//Edit***************************Sasha2,10:05 19.02.2016 {
procedure SortAndClearClassifications(var array string typecode,var vector string typename,val typescnt)
begin
  vector val typelevel;
  val level,val1,val2;
  string 20 code;
  String 200 name;
  Integer i,j;
  
    if (typescnt>1) then begin
      level = 1;
      typelevel["TYPE"] = level; level = level + 1;
      typelevel["COLL_W"] = level; level = level + 1;
      typelevel["MATERIAL_W"] = level; level = level + 1;
      typelevel["GENDER_W"] = level; level = level + 1; ///////
      typelevel["DIAL"] = level; level = level + 1;
      typelevel["STRAP"] = level; level = level + 1;
      typelevel["MECHANISM"] = level; level = level + 1;
      typelevel["FUNCTIONS"] = level; level = level + 1;
      typelevel["DIAMETER"] = level; level = level + 1;
      typelevel["COLL_J"] = level; level = level + 1;
      typelevel["CATEGORY_J"] = level; level = level + 1;
      typelevel["MATERIAL_J"] = level; level = level + 1;
      typelevel["WEIGHT"] = level; level = level + 1;
      typelevel["D_CARAT"] = level; level = level + 1;
      typelevel["CENT_ST"] = level; level = level + 1;
      typelevel["PR_STONES"] = level; level = level + 1;
      typelevel["STYLE_J"] = level; level = level + 1;
      typelevel["R_SIZE"] = level; level = level + 1;
      typelevel["DIVISION"] = level; level = level + 1;
      typelevel["GENDER_J"] = level; level = level + 1; //////
      typelevel["CARAT"] = level; level = level + 1;
      typelevel["CLARITY"] = level; level = level + 1;
      typelevel["C_S"] = level; level = level + 1;
      typelevel["SHAPE_CUT"] = level; level = level + 1;
      typelevel["COLL_A"] = level; level = level + 1;
      typelevel["CATEGORY_A"] = level; level = level + 1;
      typelevel["MATERIAL_A"] = level; level = level + 1;
      typelevel["STYLE_A"] = level; level = level + 1;
      typelevel["C_M"] = level; level = level + 1;
      typelevel["GENDER_A"] = level; level = level + 1; //////
      typelevel["WARCARD"] = level; level = level + 1;
      typelevel["ART"] = level; level = level + 1;
      typelevel["SAP"] = level; level = level + 1;
      
      for (i=0;i<typescnt-1;i=i+1) begin
        for (j=0;j<typescnt-1;j=j+1) begin
          if (typelevel[typecode[j]]<1) then begin
            typename[typecode[j]] = "";
            typecode[j] = "";
          end;
          val1 = typelevel[typecode[j]];
          val2 = typelevel[typecode[j+1]];
          if ((val1>0 and val2>0 and val1>val2) or (val1<1 and val2>0)) then begin
            code = typecode[j];
            name = typename[typecode[j]];
            typecode[j] = typecode[j+1];
            typename[typecode[j]] = typename[typecode[j+1]];
            typecode[j+1] = code;
            typename[typecode[j+1]] = name;
          end;
        end;
      end;
    end;
  
  return;
end; //Edit***************************Sasha2,10:05 19.02.2016 }



//Edit----------------------Dima  23.02.2016
procedure IDCollectAndPrintData(record RcVc RepSpec,record INVc INr, var record TotalsRepVc Totals,var vector string typeval,array string typecode,Integer typescnt,boolean addclassf,string brandcur)
begin
 record ItemStatusVc ISr;
 record SerBalVc SBr;
 boolean TrHs2,testf2,TrHs,testf,testf3;
 date todate;
 record ItemHistVc IHr;
 integer acnt;
 vector val cqty,ccost;
 array string 10 acur;
 integer i;
 string 10 realcur;
 string 255 tstr2,filename,serverip,ITCode;
 record LocationVc Locr;
  
  todate = RepSpec.d1;
  if(blank(todate))then begin
  	todate = currentdate;
  end;

	ISr.Code = INr.Code;
	realcur = INr.LastPurchCurncyCode;
	TrHs2 = true;
	while(loopmain(ISr,1,TrHs2)) begin
		testf2 = true;
		if(ISr.Code!=INr.Code)then begin testf2 = false; TrHs2 = false; end;
		if(nonblank(RepSpec.f2) and ISr.Location!=RepSpec.f2)then begin testf2 = false; end;
		if(ISr.Location==";;;")then begin testf2 = false; end;
		if(nonblank(RepSpec.f8)) then begin
			Locr.Code = ISr.Location;
			if(ReadFirstMain(Locr,1,true)) then begin
				if(!SetInSet(Locr.Objects,RepSpec.f8))then begin testf2 = false; end; 
			end;
		end;	
		
		if(testf2)then begin
			SBr.CostPrice = 0;
			ISr.Instock = IDItemQtyPerDate(ISr.Code,todate,ISr.Location,"",SBr.CostPrice,acnt,cqty,ccost,acur,brandcur,ISr.Variety);
		end;
		if(ISr.Instock<=0)then begin testf2 = false; end;
		if(testf2)then begin
			if(INr.SerNrf==0)then begin
				For(i=0;i<acnt;i=i+1) begin
					if(INr.LastPurchCurncyCode==acur[i] and nonblank(INr.LastPurchCurncyCode))then begin
						cqty[INr.LastPurchCurncyCode] = cqty[INr.LastPurchCurncyCode] + cqty[""];
						ccost[INr.LastPurchCurncyCode] = ccost[INr.LastPurchCurncyCode] + ccost[""];
						cqty[""] = blankval;
						ccost[""] = blankval;
					end;
				end; 
				
				
				For(i=0;i<acnt;i=i+1) begin
					if(cqty[acur[i]]!=0)then begin
						INr.LastPurchCurncyCode = acur[i];
						ISr.Instock = cqty[acur[i]];
						PrintInfoID(INr,ISr,"",0,0,todate,Totals.TotQuant,Totals.TotCost,Totals.TotPrice,typeval,typecode,typescnt,addclassf,realcur,brandcur,RepSpec);
					end;
				end;
				
			end else begin
				if(nonblank(ISr.Variety))then begin
					ITCode = INr.Code & ISr.Variety;
				end else begin
					ITCode = INr.Code;
				end;
				SBr.Item = ITCode;
				SBr.Location = ISr.Location;
				while (loopmain(SBr,2,(SBr.Item==ITCode and SBr.Location==ISr.Location))) begin
					if(SBr.Item==ITCode and SBr.Location==ISr.Location)then begin
						ISr.Instock = IDItemQtyPerDate(SBr.Item,todate,ISr.Location,SBr.Serial,SBr.CostPrice,acnt,cqty,ccost,acur,brandcur,ISr.Variety);
						if(ISr.Instock>0)then begin
							PrintInfoID(INr,ISr,SBr.Serial,ISr.Instock,SBr.CostPrice,todate,Totals.TotQuant,Totals.TotCost,Totals.TotPrice,typeval,typecode,typescnt,addclassf,INr.LastPurchCurncyCode,brandcur,RepSpec);
						end;
					end;
				end;
				resetloop(SBr);
			end;
		end;
	end;
end;







//Edit----------------------Dima  23.02.2016
procedure CollectAndPrintData(record RcVc RepSpec,record INVc INr, var record TotalsRepVc Totals,var vector string typeval,array string typecode,Integer typescnt,boolean addclassf,string brandcur,boolean print)
begin
 record ItemStatusVc ISr;
 record SerBalVc SBr;
 boolean TrHs2,testf2,TrHs,testf,foundcur,testf3;
 date todate;
 record ItemHistVc IHr;
 integer acnt,acnt2;
 vector val cqty,ccost,cqty2,ccost2;
 array string 10 acur,acur2;
 integer i,j,k;
 string 10 realcur;
 string 255 tstr2,filename,serverip;
 record LocationVc Locr;
 record ItemDuplicatesVc IDr;
	record INVc dupINr;
	record ItemStatusVc IS2r;
	vector string 255 DubCodes;
	
  todate = RepSpec.d1;
  if(blank(todate))then begin
  	todate = currentdate;
  end;

	ISr.Code = INr.Code;
	realcur = INr.LastPurchCurncyCode;
	TrHs2 = true;
	Locr.Code = "";
	//while(loopmain(ISr,1,TrHs2)) begin
	while(loopmain(Locr,1,true)) begin
		TrHs2 = true;
		ISr.Code = INr.Code;
		ISr.Location = Locr.Code;
		if(readfirstmain(ISr,2,true))then begin
		
		end else begin
			IDr.OrigCode = INr.Code;
			if(readfirstmain(IDr,1,true))then begin
				ISr.Code = INr.Code;
				ISr.Location = Locr.Code;
				ISr.Instock = 0;
			end else begin
				TrHs2 = false;
			end;
		end;
		
		if(TrHs2)then begin
			testf2 = true;
			if(ISr.Code!=INr.Code)then begin testf2 = false; TrHs2 = false; end;
			if(currentcompany!=18) then begin
				if(nonblank(RepSpec.f2) and ISr.Location!=RepSpec.f2)then begin testf2 = false; end;
			end;	
			if(ISr.Location==";;;")then begin testf2 = false; end;
			if(nonblank(RepSpec.f8)) then begin
			//	Locr.Code = ISr.Location;
			//	if(ReadFirstMain(Locr,1,true)) then begin
					if(!SetInSet(Locr.Objects,RepSpec.f8))then begin testf2 = false; end; 
			//	end;
			end;	
		
		end else begin
			testf2 = false;
		end;
		
		if(testf2)then begin
			SBr.CostPrice = 0;
			ISr.Instock = ItemQtyPerDate(ISr.Code,todate,ISr.Location,"",SBr.CostPrice,acnt,cqty,ccost,acur,brandcur);
			IDr.OrigCode = INr.Code;
			TrHs = true;
			while(LoopKey("OrigCode",IDr,1,TrHs)) begin
				
				if(IDr.OrigCode!=INr.Code) then begin TrHs = false; end;
				if(TrHs) then begin
					dupINr.Code = IDr.DupCode;
					if(ReadFirstMain(dupINr,1,true)) then begin
						testf3 = true;
						if(RepSpec.flags[1]==1 and dupINr.ConsgType==0)then begin testf3 = false; end;	
						if(RepSpec.flags[2]==1 and dupINr.ConsgType==1)then begin testf3 = false; end;
						if(RepSpec.flags[3]==1 and dupINr.ConsgType==2)then begin testf3 = false; end;
						
						
						if(INr.BPIBrand==dupINr.BPIBrand and testf3) then begin
							IS2r.Code = dupINr.Code;
							IS2r.Location = Locr.Code;
							if(ReadFirstMain(IS2r,2,true)) then begin			
													
								if(IS2r.Instock>0 or (nonblank(todate) and todate<currentdate)) then begin
									IS2r.Instock = ItemQtyPerDate(IS2r.Code,todate,ISr.Location,"",SBr.CostPrice,acnt2,cqty2,ccost2,acur2,brandcur);
									ISr.Instock = ISr.Instock + IS2r.Instock;
									
									
									
									if(IS2r.Instock>0) then begin 
										if(blank(DubCodes[INr.Code])) then begin
											DubCodes[INr.Code] = dupINr.Code;
										end else begin
											DubCodes[INr.Code] = DubCodes[INr.Code] & "," & dupINr.Code;
										end;
									end;
									For(i=0;i<acnt2;i=i+1) begin
										if(currentuser=="SA1")then begin	
											logtext(0,"Item "  & dupINr.Code & " acur2[i] " & acur2[i] & " cqty2 " & cqty2[acur2[i]]);

										end;
										foundcur = false;
										for(k=0;k<acnt;k=k+1)begin
											if(acur[k]==acur2[i])then begin
												foundcur = true;
											end;
										end;
										if(foundcur==false)then begin
											acur[acnt] = acur2[i];
											acnt = acnt + 1;
										end;
										
										if(blank(dupINr.LastPurchCurncyCode))then begin
											dupINr.LastPurchCurncyCode = INr.LastPurchCurncyCode;
											realcur = INr.LastPurchCurncyCode;
										end;
										
										if(blank(acur2[i]) and nonblank(dupINr.LastPurchCurncyCode))then begin
											cqty[dupINr.LastPurchCurncyCode] = cqty[dupINr.LastPurchCurncyCode] + cqty2[""];
											ccost[dupINr.LastPurchCurncyCode] = ccost[dupINr.LastPurchCurncyCode] + ccost2[""];
											cqty2[""] = blankval;
											ccost2[""] = blankval;
										end else begin
											if(dupINr.LastPurchCurncyCode==acur2[i] and nonblank(dupINr.LastPurchCurncyCode))then begin
												cqty[dupINr.LastPurchCurncyCode] = cqty[dupINr.LastPurchCurncyCode] + cqty2[dupINr.LastPurchCurncyCode] + cqty2[""];
												ccost[dupINr.LastPurchCurncyCode] = ccost[dupINr.LastPurchCurncyCode] + ccost2[dupINr.LastPurchCurncyCode] + ccost2[""];
												cqty2[""] = blankval;
												ccost2[""] = blankval;
											end else begin
												cqty[acur2[i]] = cqty[acur2[i]] + cqty2[acur2[i]];
												ccost[acur2[i]] = ccost[acur2[i]] + ccost2[acur2[i]];
											end;
										end;
									end; 
								end;
								if(IS2r.RsrvQty>0) then begin
									ISr.RsrvQty = ISr.RsrvQty + IS2r.RsrvQty;
								end;
							end;
						end;
					end;
				end;
			end;
			ResetLoop(IDr);
		end;
		
		if(ISr.Instock<=0)then begin testf2 = false; end;
		if(testf2)then begin
			if(INr.SerNrf==0)then begin
				
				
				For(i=0;i<acnt;i=i+1) begin
					if(INr.LastPurchCurncyCode==acur[i] and nonblank(INr.LastPurchCurncyCode))then begin
						cqty[INr.LastPurchCurncyCode] = cqty[INr.LastPurchCurncyCode] + cqty[""];
						ccost[INr.LastPurchCurncyCode] = ccost[INr.LastPurchCurncyCode] + ccost[""];
						cqty[""] = blankval;
						ccost[""] = blankval;
					end;
				end; 			
				For(i=0;i<acnt;i=i+1) begin
					if(cqty[acur[i]]!=0)then begin
						INr.LastPurchCurncyCode = acur[i];
						ISr.Instock = cqty[acur[i]];
						if(print) then begin
							PrintInfo2(INr,ISr,"",0,0,todate,Totals.TotQuant,Totals.TotCost,Totals.TotPrice,typeval,typecode,typescnt,addclassf,realcur,brandcur,RepSpec,DubCodes);
						end;
					end;
				end;
			end else begin
				SBr.Item = INr.Code;
				SBr.Location = ISr.Location;
				while(loopmain(SBr,2,(SBr.Item==INr.Code and SBr.Location==ISr.Location))) begin
					if(SBr.Item==INr.Code and SBr.Location==ISr.Location)then begin
						ISr.Instock = ItemQtyPerDate(ISr.Code,todate,ISr.Location,SBr.Serial,SBr.CostPrice,acnt,cqty,ccost,acur,brandcur);
						if(ISr.Instock>0)then begin
							PrintInfo2(INr,ISr,SBr.Serial,ISr.Instock,SBr.CostPrice,todate,Totals.TotQuant,Totals.TotCost,Totals.TotPrice,typeval,typecode,typescnt,addclassf,INr.LastPurchCurncyCode,brandcur,RepSpec,DubCodes);
						end;
					end;
				end;
			end;
		end;
	end;
end;








global procedure ItemStockStatExtRn(record RcVc RepSpec)
begin
  record ItemStatusVc ISr;
  record PLVc PLr;
  string 100 item,location,findkey,class;
  record INVc INr;
  boolean TrHs,testf,TrHs1,testf1,TrHs2,testf2;
  record DIVc DIr;
  integer findint;
  record UserVc User;
  boolean userlocation;
  integer pos;
  string 50 uloc;
  record SerBalVc SBr;
  date todate;
  string 200 classfind,model,brand,basecur,group;
  record BaseCurBlock bascur;
  Boolean addclassf; //Edit***************************Sasha2,13:58 08.02.2016
  vector string 20 typeval; //Edit***************************Sasha2,14:11 08.02.2016
  array string 20 typecode; //Edit***************************Sasha2,14:11 08.02.2016
  vector string 200 typename; //Edit***************************Sasha2,14:11 08.02.2016
  record DiCheckBlock DiCb; //Edit***************************Sasha2,14:10 08.02.2016
  row DiCheckBlock DiCbw; //Edit***************************Sasha2,14:10 08.02.2016
  integer rwcnt,typescnt; //Edit***************************Sasha2,14:11 08.02.2016
  record CTypeVc CTyper; //Edit***************************Sasha2,14:13 08.02.2016
	array integer companies;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	integer oldcompany, i;
	record TotalsRepVc Totals;
	string 10 brandcur;
	record OldDIVc OldDir;
	vector boolean userbrand;
	boolean userbrandf, checkBrand;
	record BrandsReportCCBlock Brcb;
	row BrandsReportCCBlock Brcbw;
	record ItemDuplicatesVc IDr;
	record INVc dupINr;
	boolean dublikateItem;
	if(RepSpec.flags[8]!=0) then begin
		SetCompany(RepSpec.flags[8],false);
		blockload(Brcb);
		SetCompany(18,false);
	end;	
  userbrandf = CheckUserBrands(currentuser,userbrand);  
	brandcur = RepSpec.f6;// Edit ************************** Thursday, 14 September 2017 10:19:30
	
	if (RepSpec.UsedOnly == 0) then begin
		companies[0] = CurrentCompany;
	end;
	
	if(RepSpec.UsedOnly == 1) then begin //All J&W companies ---  Irkan Ahmadov 20.12.2019
		companies[0] = 1;
		companies[1] = 3;
		companies[2] = 16;
		companies[3] = 17;
		companies[4] = 19;
		companies[5] = 20;
		companies[6] = 21;
		companies[7] = 22;
		companies[8] = 23;
		companies[9] = 24;
	end;
	
	if(RepSpec.UsedOnly == 2) then begin //All NoN J&W companies ---  Irkan Ahmadov 20.12.2019 !!!If you want to get all NoN JW comp.s you can use the procedure "CompanyIsJWLikeCompany(CompNo)".!!! // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 11:31 20.01.2020
		companies[0] = 2;
		companies[1] = 4;
		companies[2] = 5;
		companies[3] = 6;
		companies[4] = 7;
		companies[5] = 8;
		companies[6] = 9;
		companies[7] = 13;
		companies[8] = 25;
		companies[9] = 28;
		companies[10] = 29;
		companies[11] = 30;
		companies[12] = 31;
		companies[13] = 32;
		companies[14] = 33;
	end;	

	if(RepSpec.UsedOnly == 3) then begin //All companies ---  Irkan Ahmadov 29.01.2020
		companies[0] = 1;
		companies[1] = 2;
		companies[2] = 3;
		companies[3] = 4;
		companies[4] = 5;
		companies[5] = 6;
		companies[6] = 7;
		companies[7] = 8;
		companies[8] = 9;
		companies[9] = 13;
		companies[10] = 16;
		companies[11] = 17;
		companies[12] = 19;
		companies[13] = 20;
		companies[14] = 21;
		companies[15] = 22;
		companies[16] = 23;
		companies[17] = 23;
		companies[18] = 25;
		companies[19] = 28;
		companies[20] = 29;
		companies[21] = 30;
		companies[22] = 31;
		companies[23] = 32;
	end;
		
	
	oldcompany = CurrentCompany;
	BlockLoad(Compb);	

  
  BlockLoad(bascur);
  basecur = bascur.BaseCur1;
  item = RepSpec.f1;
  location = RepSpec.f2;
  todate = RepSpec.d1;
	
	if(todate==currentdate)then begin
		todate = RepSpec.d2;
	end;
	
  if (CompanyIsJWLikeCompany(CurrentCompany)) then begin
	  addclassf = true;
	end else begin
	  addclassf = false;
	end;
  
  if (addclassf) then begin
    typescnt = 0;
	  BlockLoad(DiCb);
    rwcnt = MatRowCnt(DiCb);  
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(DiCb,i,DiCbw);
      if (NonBlank(DiCbw.DiType)) then begin
        DIr.Code = DiCbw.DiCode;
        ReadFirstMain(DIr,1,true);
        DiCbw.DiType = DIr.CType & "," & DiCbw.DiType;
        pos = 0;
  			ExtractObj(DiCbw.DiType,pos,uloc);
  			while (nonblank(uloc)) begin
  				if (blank(typeval[uloc])) then begin
    				CTyper.Code = uloc;
    				if (ReadFirstMain(CTyper,1,true)) then begin
    				  if (CTyper.Code=="GENDER") then begin
    				    switch (UpperCase(Left(DiCbw.DiCode,1))) begin
    				      case "A":
    				        if (blank(typeval[CTyper.Code & "_A"])) then begin
      				        typeval[CTyper.Code & "_A"] = ".";
            				  typecode[typescnt] = CTyper.Code & "_A";
            				  typename[typecode[typescnt]] = "ACCESSORIES " & CTyper.Comment;
            				  typescnt = typescnt + 1;  
    				        end;
    				      case "J":
    				        if (blank(typeval[CTyper.Code & "_J"])) then begin
      				        typeval[CTyper.Code & "_J"] = ".";
            				  typecode[typescnt] = CTyper.Code & "_J";
            				  typename[typecode[typescnt]] = "JEWELRY " & CTyper.Comment;
            				  typescnt = typescnt + 1;  
    				        end;
    				      case "W":
    				        if (blank(typeval[CTyper.Code & "_W"])) then begin
      				        typeval[CTyper.Code & "_W"] = ".";
            				  typecode[typescnt] = CTyper.Code & "_W";
            				  typename[typecode[typescnt]] = "WATCH " & CTyper.Comment;
            				  typescnt = typescnt + 1;
    				        end;
    				    end;
    				  end else begin
      				  typeval[CTyper.Code] = ".";
      				  typecode[typescnt] = CTyper.Code;
      				  typename[CTyper.Code] = CTyper.Comment;
      				  typescnt = typescnt + 1;  
    				  end;
    				end;
  				end;
  				ExtractObj(DiCbw.DiType,pos,uloc);
  			end;
      end;
    end;
    SortAndClearClassifications(typecode,typename,typescnt);
  end;
  
  if(RepSpec.flags[8]==0) then begin
		startreportnoheaderjob(USetStr(31179));
	end;	
  if(RepSpec.flags[6] and blank(RepSpec.f4)) then begin
		startformat(15);
			outstring(0,0,USetStr(36353),false);
		endformat;
		goto LItemStockStatExtRn;
	end;
  
  if(blank(todate))then begin
  	todate = currentdate;
  end;
  
  userlocation = false;
  User.Code = currentuser;
  if(readfirstmain(User,1,true))then begin
  	if(nonblank(User.UserLocations) and usercanaction("AllowReportWithUserLoc",false))then begin
  		userlocation = true;
  		pos = 0;
			ExtractObjWithSeparator(",",User.UserLocations,true,pos,uloc);
			while (nonblank(uloc)) begin
				if(uloc==location)then begin
					userlocation = false;
				end;
				ExtractObjWithSeparator(",",User.UserLocations,true,pos,uloc);
			end;
  	end;
  end;
  
  if(userlocation)then begin
  	startformat(15);
			outstring(50,0,USetStr(31014),false);
  	endformat;
  end else begin
		startformat(15);
		  if(RepSpec.flags[8]!=0) then begin
				outstring(0,0,USetStr(31043),false); //Kod postavshchika
				outstring(0,0,USetStr(31186),false); //Kod dlia id group
			end else begin	
				outstring(0,0,USetStr(31042),false); //Kod dlia sistemy Hansa
				outstring(0,0,USetStr(31043),false); //Kod postavshchika
			end;	
			outstring(0,0,USetStr(36287),false); //Original item code
			outstring(0,0," ",false);
			outstring(0,0,"EAN code",false);
			outstring(0,0,"SAP",false);
			outstring(0,0,USetStr(31103),false); //Sklad
			if(currentcompany==18 or RepSpec.flags[5]!=0)then begin
				outstring(0,0,USetStr(36311),false);//mesto
				outstring(0,0,USetStr(36309),false);//stelaj
				outstring(0,0,USetStr(36310),false);//polka
			end;
			if (CurrentCompany==13) then begin
			  outstring(0,0,USetStr(6679),false); //Klassifikatsia
			end;
			outstring(0,0,USetStr(31204),false); //name
			
			if (addclassf) then begin
				outstring(0,0,USetStr(31178),false); //Ves
				outstring(0,0,USetStr(31048),false); //Karatnoct
			end;
			if(currentcompany==29)then begin
				outstring(0,0,"Btrx No",false); 
				outstring(0,0,"Stock",false); 
			end;
			outstring(0,0,"Brand",false); 
			outstring(0,0,"Collection",false); 
			outstring(0,0,"Group",false); 
			outstring(0,0,"SubGroup",false); 
			outstring(0,0,"Category",false); 
			outstring(0,0,"Material",false); 
			outstring(0,0,"Colour",false); 
			outstring(0,0,"Year",false); 
			outstring(0,0,"Life",false);
			outstring(0,0,"Size",false); 
			outstring(0,0,"Use",false); 
			outstring(0,0,"Sex",false); 
			
			if(CurrentCompany==13) then begin
				outstring(0,0,"Col.",false); 
				outstring(0,0,"ClCol.",false); 
				outstring(0,0,"Shape",false); 
				outstring(0,0,"Size",false); 
				outstring(0,0,"ClSize",false); 
			end else begin
				outstring(0,0,"Plating",false);
				outstring(0,0,"CC Collection",false);  // every time show this field ************ Irkan 
				outstring(0,0,"Clarity",false); 
				outstring(0,0,"Weight",false); 
				outstring(0,0,"Cut",false); 
				outstring(0,0,"Shape",false); 
			end;
			
			outstring(0,0,"Stone",false); 
			outstring(0,0,"Strap",false); 
			outstring(0,0,"Odour",false);  

			/*if(currentcompany==25)then begin
				outstring(0,0,"CC Collection",false); 
				outstring(0,0,"Product Group",false); 
			end; */ // **************** edited by Irkan 07.02.2020
	  	outstring(0,0,USetStr(31051),false); //Seriinyi nomer
			outstring(0,0,USetStr(31176),false); //Tip prihoda
			outstring(0,0,"Date in",false); //data postupleniya
			outstring(0,0,USetStr(31121),false); //Kolichestvo
			outstring(0,0,USetStr(31185),false); // reserve
			outstring(0,0,USetStr(31175),false); //Ed.izm.
			if(currentcompany!=10)then begin
				if(usercanaction("ViewCostPrice",true))then begin
					outstring(0,0,USetStr(31053),false);
					if(nonblank(brandcur))then begin
						outstring(0,0,USetStr(31055) & brandcur,false);
					end;
					outstring(0,0,USetStr(31055) & basecur,false);
					outstring(0,0,USetStr(31056),false);
					if(nonblank(brandcur))then begin
						outstring(0,0,USetStr(31058) & brandcur,false);
					end;
					outstring(0,0,USetStr(31058) & basecur,false);			
				end;
				outstring(0,0,"     ",false);
				if(RepSpec.flags[6]) then begin
					outstring(0,0,USetStr(36360),false); // Cena so skidkoi
				end;
				outstring(0,0,USetStr(31059),false);
				if(nonblank(brandcur))then begin
					outstring(0,0,USetStr(31061) & brandcur,false);
				end;
				outstring(0,0,USetStr(31061) & basecur,false);
				outstring(0,0,USetStr(31062),false);
				if(nonblank(brandcur))then begin
					outstring(0,0,USetStr(31064) & brandcur,false);
				end;
				outstring(0,0,USetStr(31064) & basecur,false);
			end else begin
				outstring(0,0,USetStr(31053),false); // Sebestoimost za ed-cu v valute brenda
				outstring(0,0,USetStr(31171),false);// Sebestoimost za ed-cu v valute PLN
				outstring(0,0,USetStr(31056),false);// Summa po Sebestoimosti v valute brenda
				outstring(0,0,USetStr(31172),false);// Summa po Sebestoimosti v valute PLN
				if(RepSpec.flags[3]) then begin
					outstring(0,0,USetStr(36360),false);// Cena so skidkoi
				end;
				outstring(0,0,"     ",false);
				outstring(0,0,USetStr(31059),false);// Riteil za ed-cu v valute brenda
				outstring(0,0,USetStr(31173),false);// Riteil za ed-cu v valute PLN
				outstring(0,0,USetStr(31062),false);
				outstring(0,0,USetStr(31174),false);
			end;
			outstring(0,0,USetStr(31169),false); // Valuta
			if (addclassf) then begin //Edit***************************Sasha2,14:00 08.02.2016 {
			  for (i=30;i<typescnt;i=i+1) begin //if you change "30" do it in other places having "For" loop 
  		    outstring(0,0,typename[typecode[i]],false);
  		  end;
			end;
			outstring(0,0,USetStr(36203),false);// ssilka na kartinku
		endformat;

		if(nonblank(item))then begin
			ISr.Code = item;
			TrHs = true;
			INr.Code = item;
			if (ReadFirstMain(INr,1,true)) then begin		//Edit----------------------Dima  27.04.2015
			
    		if(RepSpec.flags[1]==1 and INr.ConsgType==0)then begin TrHs = false; end;
    		if(RepSpec.flags[2]==1 and INr.ConsgType==1)then begin TrHs = false; end;
    		if(RepSpec.flags[3]==1 and INr.ConsgType==2)then begin TrHs = false; end;
    		if(INr.ConsgType>2) then begin TrHs = false; end;
				if(RepSpec.flags[4]==1 and INr.OutOfOrder==1) then begin TrHs = false; end;

    		if (nonblank(User.Brand) and CheckIfContainForbiddenBrand(User.Brand,INr.DispGroups)) begin TrHs = false; end;	
    		    		
    		if (TrHs) then begin						
					if(companies.length>1)then begin			
						for (i=0;i<companies.length;i=i+1) begin
							if (SetCompany(companies[i],false)) then begin
								if(CurrentCompany!=28)then begin	
									checkBrand = true;
									if(CurrentCompany==18) then begin
										checkBrand = false;
										for(i=0;i<matrowcnt(Brcb);i=i+1) begin
											matrowget(Brcb,i,Brcbw);
											if(Brcbw.Brand==INr.BPIBrand) then begin checkBrand = true; end;
										end;
									end;
									if(checkBrand) then begin
										CollectAndPrintData(RepSpec,INr,Totals,typeval,typecode,typescnt,addclassf,brandcur, true);
									end;	
								end else begin
									IDCollectAndPrintData(RepSpec,INr,Totals,typeval,typecode,typescnt,addclassf,brandcur);
								end;
							end;
						end;
						ResetCompany(oldcompany);	
					end else begin
						if(CurrentCompany!=28)then begin
							CollectAndPrintData(RepSpec,INr,Totals,typeval,typecode,typescnt,addclassf,brandcur, true);
						end else begin
							IDCollectAndPrintData(RepSpec,INr,Totals,typeval,typecode,typescnt,addclassf,brandcur);
						end;
					end;
				end;   
				
    	end;			
		end else begin
			INr.DispGroups = "";//= RepSpec.f3;
			class = RepSpec.f3;
			TrHs1 = true;
			while(loopkey("MyDispGroups",INr,1,TrHs1)) begin
				dublikateItem = false;
				IDr.DupCode = INr.Code;
				if(ReadFirstKey("DupCode",IDr,1,true)) then begin
					dupINr.Code = IDr.OrigCode;
					TrHs = true;
					while(LoopMain(dupINr,1,TrHs)) begin
						if(dupINr.Code!=IDr.OrigCode) then begin TrHs = false; end;
						if(dupINr.BPIBrand==INr.BPIBrand and TrHs) then begin
							testf2 = true;
							if(RepSpec.flags[1]==1 and dupINr.ConsgType==0)then begin testf2 = false; end;	
							if(RepSpec.flags[2]==1 and dupINr.ConsgType==1)then begin testf2 = false; end;
							if(RepSpec.flags[3]==1 and dupINr.ConsgType==2)then begin testf2 = false; end;	
							if(testf2)then begin
//								if(currentuser=="SA")then begin
//									logtext(0,INr.Code & " is dublicate");
//								end;
								dublikateItem = true;
							end;
						end;
					end;
					ResetLoop(dupINr);
				end;
				testf1 = true;
				if(nonblank(RepSpec.f3))then begin
					testf1 = SetInSet2(class,INr.DispGroups);
				end;
				if(INr.Terminated!=0)then begin testf1 = false; end;
				
    		if(RepSpec.flags[1]==1 and INr.ConsgType==0)then begin testf1 = false; end;	//Edit----------------------Dima  27.04.2015
    		if(RepSpec.flags[2]==1 and INr.ConsgType==1)then begin testf1 = false; end;
    		if(RepSpec.flags[3]==1 and INr.ConsgType==2)then begin testf1 = false; end;		//Edit----------------------Dima  27.04.2015			
				if(INr.ConsgType>2)then begin testf1 = false; end;
				if(RepSpec.flags[4]==1 and INr.OutOfOrder==1) then begin testf1 = false; end;

				
				if(testf1)then begin
					if(nonblank(RepSpec.f4) or nonblank(RepSpec.f5) or nonblank(RepSpec.f7))then begin
						brand = "";
						model = "";
						group = "";
						pos = 0;
						classfind = "";
						ExtractObj(INr.DispGroups,pos,classfind);
						while(nonblank(classfind)) begin
							if(nonblank(classfind))then begin
								DIr.Code = classfind;
								readfirstmain(DIr,1,true);
								if(DIr.CType=="BRAND")then begin
									brand = DIr.Code;
								end;
								if(DIr.CType=="MODEL")then begin
									model = DIr.Code;
								end;
								if(DIr.CType=="GROUP")then begin
									group = DIr.Code;
								end;
							end;
							ExtractObj(INr.DispGroups,pos,classfind);
						end;
						if(nonblank(RepSpec.f4) and brand!=RepSpec.f4)then begin
							testf1 = false;
						end;
						if(nonblank(RepSpec.f5) and model!=RepSpec.f5)then begin
							testf1 = false;
						end;
						if(nonblank(RepSpec.f7) and INr.BPIGroup!=RepSpec.f7)then begin
							testf1 = false;
						end;
					end;
				end;
				
				
				if(userbrandf and testf1)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 19 06 2019 y. at 4:35:18 PM
					pos = 0;
					brand = "";
					testf1 = false;
					ExtractObj(INr.DispGroups,pos,brand);
					while(nonblank(brand)) begin
						if(userbrand[brand])then begin
							testf1 = true;
						end;
						ExtractObj(INr.DispGroups,pos,brand);
					end;
				end;

				if(testf1)then begin	
						if(companies.length>1)then begin			
							for (i=0;i<companies.length;i=i+1) begin
								if (SetCompany(companies[i],false)) then begin
									if(CurrentCompany!=28)then begin
										checkBrand = true;
										if(CurrentCompany==18) then begin
											checkBrand = false;
											for(i=0;i<matrowcnt(Brcb);i=i+1) begin
												matrowget(Brcb,i,Brcbw);
												if(Brcbw.Brand==INr.BPIBrand) then begin checkBrand = true; end;
											end;
										end;
										if(checkBrand) then begin
											CollectAndPrintData(RepSpec,INr,Totals,typeval,typecode,typescnt,addclassf,brandcur,!dublikateItem);
										end;	
									end else begin
										IDCollectAndPrintData(RepSpec,INr,Totals,typeval,typecode,typescnt,addclassf,brandcur);
									end;
								end;
							end;
							ResetCompany(oldcompany);	
						end else begin
							if(CurrentCompany!=28)then begin
								CollectAndPrintData(RepSpec,INr,Totals,typeval,typecode,typescnt,addclassf,brandcur,!dublikateItem);
							end else begin
								IDCollectAndPrintData(RepSpec,INr,Totals,typeval,typecode,typescnt,addclassf,brandcur);
							end;
						end;
						
				end;
			end;
			resetloop(INr);
		end;
	
		startformat(15);
			outstring(0,0,"",false);
			if(currentcompany==18 or RepSpec.flags[5]!=0)then begin
				outstring(0,0,"",false);//mesto
				outstring(0,0,"",false);//stelaj
				outstring(0,0,"",false);//polka
			end;
			outstring(0,0,"",false);
			outstring(0,0,"",false);
			outstring(0,0,"",false);
			outstring(0,0,"",false);
			outstring(0,0,"",false);
			if (addclassf==false) then begin //Edit***************************Sasha2,16:37 18.02.2016
			  outstring(0,0,"",false);
			end; //Edit***************************Sasha2,16:37 18.02.2016
			outstring(0,0,"",false);
			if (addclassf==false) then begin //Edit***************************Sasha2,16:37 18.02.2016
  			outstring(0,0,"",false);
			  outstring(0,0,"",false);
  			outstring(0,0,"",false);
  			outstring(0,0,"",false);
  			/*if(addclassf)then begin
  				outstring(0,0,"",false);
  				outstring(0,0,"",false);
  			end;*/
  			if(currentcompany==13)then begin	//Edit----------------------Dima  30.04.2015
  				outstring(0,0,"",false);
  				outstring(0,0,"",false);
  			end;			
  			outstring(0,0,"",false);
  		end else begin
  		  for (i=0;i<30;i=i+1) begin //if you change "30" do it in other places having "For" loop 
  		    outstring(0,0,"",false);
  		  end;
			end; //Edit***************************Sasha2,16:37 18.02.2016
			outstring(0,0,"",false);
			outstring(0,0,USetStr(31074),false);
			outstring(0,0,Totals.TotQuant,false);
			outstring(0,0,"",false);
			if(usercanaction("ViewCostPrice",true))then begin
				outstring(0,0,"",false);
				outstring(0,0,"",false);
				outstring(0,0,USetStr(31075),false);
				outstring(0,0,Totals.TotCost,false);
			end;
			outstring(0,0,"",false);
			outstring(0,0,"",false);
			outstring(0,0,USetStr(31064) & basecur,false);
			outstring(0,0,Totals.TotPrice,false);
		endformat;
		
  end;
  if(currentcompany!=18 and RepSpec.flags[5]!=0) then begin
		RepSpec.flags[8] = currentcompany;
		ItemStockStatExtRn(RepSpec);
		RepSpec.flags[8] = 0;
	end;
  LItemStockStatExtRn:;
	 if(RepSpec.flags[8]==0) then begin
		 endjob;
	end;	
  
  
return;
end;

global procedure ItemStockStatExtRClassReportDefaults(integer wn)
begin
	record RcVc RepSpec;
	record UserVc User;
	integer i;
	string 20 loc;
	string 60 res,serverip;
	record ProgramStatusBlock PSb;
	integer compnr;
	record CompaniesBlock Cb;
	row CompaniesBlock Cbrw;
	
	
	
	
	getwindowrecord(wn,RepSpec);
	blockload(PSb);
	blockload(Cb);
	compnr = currentcompany;
	matrowget(Cb,compnr-1,Cbrw);
	serverip = Cbrw.TCPIP & ":" & PSb.httpPort;// & "/" & Cbrw.ShortName;// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 05 03 2020 y. at 4:48:59 PM
	RepSpec.f9 = serverip;
	User.Code = currentuser;
	if(readfirstmain(User,1,true))then begin
		if(nonblank(User.UserLocations) and usercanaction("AllowReportWithUserLoc",false))then begin
			i = 0;
			ExtractObjWithSeparator(",",User.UserLocations,true,i,loc);
			RepSpec.f2 = loc;
			RepSpec.d1 = CurrentDate;
			
			
		end;
	end;
	putwindowrecord(wn,RepSpec);
return;
end;

global procedure ItemStockStatExtManRClassReportDefaults(integer wn)
begin
	record RcVc RepSpec;
	record UserVc User;
	integer i;
	string 20 loc;
	
	getwindowrecord(wn,RepSpec);
	User.Code = currentuser;
	if(readfirstmain(User,1,true))then begin
		if(nonblank(User.UserLocations) and usercanaction("AllowReportWithUserLoc",false))then begin
			i = 0;
			ExtractObjWithSeparator(",",User.UserLocations,true,i,loc);
			RepSpec.f2 = loc;
			RepSpec.d1 = CurrentDate;
			putwindowrecord(wn,RepSpec);
		end;
	end;
return;
end;


global procedure ItemStockStatExtWebRn(record RcVc RepSpec,var area webpage1,string serverip)
begin
  record ItemStatusVc ISr;
  record PLVc PLr;
  string 100 item,location,findkey,class;
  record INVc INr;
  boolean TrHs,testf,TrHs1,testf1,TrHs2,testf2;
  record DIVc DIr;
  integer findint;
  record UserVc User;
  boolean userlocation;
  integer pos,i;
  string 50 uloc;
  record SerBalVc SBr;
  date todate;
  string 200 classfind,model,brand;
  roundmode rnd; //Edit***************************Sasha2,15:45 21.04.2015
  record BaseCurBlock bcur; //Edit***************************Sasha2,14:02 27.04.2015
  integer oldcompany;
  array integer companies;
  integer acnt;
  vector val cqty,ccost;
  array string 10 acur;
  string 10 brandcur;
  vector boolean userbrand;
  boolean userbrandf;
  
  userbrandf = CheckUserBrands(currentuser,userbrand);
  
	if (RepSpec.UsedOnly == 1) then begin
		companies[0] = CurrentCompany;
	end else begin			//All J&W companies
		companies[0] = 3;
		companies[1] = 17;
		companies[2] = 19;
		companies[3] = 20;
		companies[4] = 21;
		companies[5] = 22;
	end;
	
	oldcompany = CurrentCompany;  
  
  item = RepSpec.f1;
  location = RepSpec.f2;
  todate = RepSpec.d1;
  
  if(blank(todate))then begin
  	todate = currentdate;
  end;
  
  BlockLoad(bcur); //Edit***************************Sasha2,14:03 27.04.2015
  rnd = DefaultValRoundoff; //Edit***************************Sasha2,15:47 21.04.2015
  rnd.decimals = 0; //Edit***************************Sasha2,15:47 21.04.2015
	//rnd.step = kRoundingStep5; //Edit***************************Sasha2,15:47 21.04.2015
	rnd.mode = kRoundingModeHalfUp; //Edit***************************Sasha2,15:47 21.04.2015
  
  userlocation = false;

  
	ExportString("<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">");
	ExportString("<html xmlns=\"http://www.w3.org/1999/xhtml\">");
	ExportString("<head>");
	ExportString("<meta http-equiv=\"content-type\" content=\"text/html\" charset=\"utf-8\"> ");
	ExportString("<title>" & USetStr(31168) & "</title>");
	ExportString("</head>");
	ExportString("<body>");
	ExportString("<div id=\"wrapper\">");
	ExportString("<table align=\"left\" border=\"1\">");
  
  if(userlocation)then begin
  	startformat(15);
			messagebox(0,USetStr(31014));
  	endformat;
  end else begin
		ExportString("<tr>");
		ExportString("<td>" & USetStr(31042) & "</td>");//Code
		if(currentcompany!=25)then begin
			ExportString("<td>" & USetStr(31042) & "</td>");//AltCode
		end;
		ExportString("<td>BAR/EAN Code</td>");//AltCode
		ExportString("<td>" & USetStr(31103) & "</td>");
		if(CurrentCompany==25)then begin
			ExportString("<td>CC Collection</td>");
			ExportString("<td>Product Group</td>");
		end else begin
			ExportString("<td>" & USetStr(31044) & "</td>");
			ExportString("<td>" & USetStr(31120) & "</td>");//MODEL
		end;
		ExportString("<td>" & USetStr(31204) & "</td>");
		ExportString("<td>" & USetStr(31051) & "</td>");
		ExportString("<td>" & USetStr(31121) & "</td>");
		ExportString("<td>" & USetStr(31160) & "</td>");//cost
		ExportString("<td>" & USetStr(31059) & "</td>");
		ExportString("<td>Price, AZN</td>");
		ExportString("<td>" & USetStr(31169) & "</td>");
		ExportString("<td>" & USetStr(31170) & "</td>");
		ExportString("</tr>");
		if(nonblank(item))then begin
		
			for (i=0;i<companies.length;i=i+1) begin	//Edit----------------------Dima  25.02.2016
		  	if (SetCompany(companies[i],false)) then begin			
				ISr.Code = item;
				TrHs = true;
				while(loopmain(ISr,1,TrHs)) begin
					testf = true;
					INr.Code = ISr.Code;								
					if (readfirstmain(INr,1,true)) then begin
						if (nonblank(User.Brand) and CheckIfContainForbiddenBrand(User.Brand,INr.DispGroups)) begin TrHs = false; end;
					end;
													
					if(ISr.Code!=item)then begin TrHs = false; testf = false; end;
					if(ISr.Location==";;;")then begin testf = false; end;
					if(nonblank(location) and location!=ISr.Location)then begin testf = false; end;
					if(nonblank(RepSpec.f7) and RepSpec.f7!=INr.Group)then begin testf = false; end;//Edit-------------------Vitalii 17:26 07.12.2017
					if(nonblank(RepSpec.f8) and RepSpec.f8!=INr.SN)then begin testf = false; end;//Edit-------------------Vitalii 17:26 07.12.2017

					if(testf)then begin
						ISr.Instock = ItemQtyPerDate(ISr.Code,todate,ISr.Location,"",SBr.CostPrice,acnt,cqty,ccost,acur,brandcur);
					end;
					if(ISr.Instock==0)then begin testf = false; end;
				
					if(testf)then begin
						INr.Code = ISr.Code;
						readfirstmain(INr,1,true);
						if(INr.SerNrf==0)then begin
							PrintInfoWeb(INr,ISr,"",0,0,todate,webpage1,serverip,rnd,RepSpec.ArtMode,bcur.BaseCur1); //Edit***************************Sasha2,15:48 21.04.2015
						end else begin
							SBr.Item = INr.Code;
							SBr.Location = ISr.Location;
							while(loopmain(SBr,2,(SBr.Item==INr.Code and SBr.Location==ISr.Location))) begin
								if(SBr.Item==INr.Code and SBr.Location==ISr.Location)then begin
									ISr.Instock = ItemQtyPerDate(ISr.Code,todate,ISr.Location,SBr.Serial,SBr.CostPrice,acnt,cqty,ccost,acur,brandcur);
									if(ISr.Instock>0)then begin
										PrintInfoWeb(INr,ISr,SBr.Serial,ISr.Instock,SBr.CostPrice,todate,webpage1,serverip,rnd,RepSpec.ArtMode,bcur.BaseCur1); //Edit*********************Sasha2,15:48 21.04.		**	20	****15
									end;
								end;
							end;
							resetloop(SBr);
						end;
					end;
				end;
				resetloop(ISr);
				end;			
			end;
		end else begin			
			INr.DispGroups = "";//= RepSpec.f3;
			class = RepSpec.f3;
			TrHs1 = true;
			while(loopkey("MyDispGroups",INr,1,TrHs1)) begin
				testf1 = true;
				if(INr.Terminated!=0)then begin testf1 = false; end;
			
				if(testf1)then begin
					if(nonblank(RepSpec.f4) or nonblank(RepSpec.f5))then begin
						if(nonblank(RepSpec.f4) and INr.BPIBrand!=RepSpec.f4)then begin
							testf1 = false;
						end;
						if(nonblank(RepSpec.f5) and INr.BPICollection!=RepSpec.f5)then begin
							testf1 = false;
						end;
					end;
				end;
				if(nonblank(RepSpec.f7) and RepSpec.f7!=INr.Group)then begin testf1 = false; end;//Edit-------------------Vitalii 17:26 07.12.2017
				if(nonblank(RepSpec.f8) and RepSpec.f8!=INr.SN)then begin testf1 = false; end;//Edit-------------------Vitalii 17:26 07.12.2017

				if(testf1)then begin
					for (i=0;i<companies.length;i=i+1) begin
						if (SetCompany(companies[i],false)) then begin
								ISr.Code = INr.Code;
								TrHs2 = true;
								while(loopmain(ISr,1,TrHs2)) begin
									testf2 = true;
									if(ISr.Code!=INr.Code)then begin testf2 = false; TrHs2 = false; end;
									if(nonblank(RepSpec.f2) and ISr.Location!=RepSpec.f2)then begin testf2 = false; end;
									if(ISr.Location==";;;")then begin testf2 = false; end;
									if(testf2)then begin
										SBr.CostPrice = 0;
										ISr.Instock = ItemQtyPerDate(ISr.Code,todate,ISr.Location,"",SBr.CostPrice,acnt,cqty,ccost,acur,brandcur);
									end;
									if(ISr.Instock<=0)then begin testf2 = false; end;
								
									if(testf2)then begin
										if(INr.SerNrf==0)then begin
											PrintInfoWeb(INr,ISr,"",0,0,todate,webpage1,serverip,rnd,RepSpec.ArtMode,bcur.BaseCur1); //Edit***************************Sasha2,15:49 21.04.2015
										end else begin
											SBr.Item = INr.Code;
											SBr.Location = ISr.Location;
											while(loopmain(SBr,2,(SBr.Item==INr.Code and SBr.Location==ISr.Location))) begin
												if(SBr.Item==INr.Code and SBr.Location==ISr.Location)then begin
													ISr.Instock = ItemQtyPerDate(ISr.Code,todate,ISr.Location,SBr.Serial,SBr.CostPrice,acnt,cqty,ccost,acur,brandcur);
													if(ISr.Instock>0)then begin
														PrintInfoWeb(INr,ISr,SBr.Serial,SBr.Quant,SBr.CostPrice,todate,webpage1,serverip,rnd,RepSpec.ArtMode,bcur.BaseCur1); //Edit****	**********	**********	***Sasha2,15:49 21.04.2015
													end;
												end;
											end;
											resetloop(SBr);
										end;
									end;
								end;
								resetloop(ISr);
						end;
					end;
					ResetCompany(oldcompany);	
				end;
			end;
			resetloop(INr);
		end;
		ExportString("</table>");
		ExportString("</div>");
		ExportString("</body>");
		ExportString("</html>");
  end;
  
  LItemStockStatExtWebRn:;
  
return;
end;