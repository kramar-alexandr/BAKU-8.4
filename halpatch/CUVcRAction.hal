//server-only
external procedure SugarCRM_DELETE_CUVc(record CUVc);
external procedure SugarCRM_PUT_CUVc(record CUVc);
external procedure SugarCRM_POST_CUVc(record CUVc);
external procedure GetVATproc(string,Integer,var val);
external procedure AutomatedSales(string,Integer);
external function Boolean HasCategories();
external function Boolean ValidateVATNr(string,string,Integer);
external function Boolean ValidateRegNr1(string,string,Integer);
external function string 60 AddStringToStringList(string,string);
external function Boolean IsMarketplaceServer();
external function Boolean InterNetAddrTest(string);
external function string 60 RemoveObjectFromObjectList(string,string);
external updating procedure CreateCUObject(var record CUVc,Boolean);
external function integer CheckAddressForLocalisation(string,string,string,string,string,string,string,string,string,string,string,var string);
external function Boolean HasJewelleryInterface();
external function boolean ValidateIBAN(string);
external function Boolean SerNrTestCUVc(LongInt,Date,var Boolean);
external procedure ExtractObj(string,var Integer,var string);
external function Integer CheckObjs(string,string,var string);
external function Boolean FindCustomerRelation(string,string,var record CUVc);
external function Boolean IsDigit(string);
external function Boolean CurencyCodeIsISO(string);
external function Boolean CountryCodeIsISO(string);
external function Boolean EInvoiceForCustomer(Integer,string,record CUVc);
external function Boolean IsControlAccount(string,Boolean,Boolean);
external function Boolean CurncyCodeRegistered(string);
external function Boolean GetPM(string,var string,var string);
external function Boolean GetPD(var record PDVc);
external function Integer CheckVATNrMask(string,string,Integer,var string);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external procedure B1ToB2Val(val,val,val,var val);
external procedure NextM4Number(string,var string);
external function Boolean CheckMultipleIndexField(string,Integer,Integer);
external function Integer CountObjects(string);
external procedure ExtractElemFromSet(string,integer,var string);
external function Boolean IsVATCodeDefined(string);
external function Boolean ValidateBrazilianVATNr(string,string,Integer);
external procedure AutoMails_StoreAct(string,string,string,var Longint);
external procedure UpdateCustomerOnCC(record CUVc,record CUVc,Boolean);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string); //Edit***************************Sasha2,15:42 19.04.2017
external procedure ParsePhones(string, var integer, var array string); //edited by BPI
external updating procedure SendContactToCRM(var record CUVc,boolean);
external updating procedure SendUpdateContactToCRM(var record CUVc);
external procedure StripSpace(var string,string);
external procedure StripEndingSpaces(var string);
external updating procedure PasteRebCodeLCVCbyCU(record CUVc);// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 10 January 2019 10:02:49
external function Integer CheckObjs(string,string,var string);
external procedure LogProcTime(string,longint);
external updating procedure SendUpdateLoyaltyCardToCRM(var record LoyaltyCardVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger13:07 12.09.2018


// function boolean CheckPhoneCorect(string phone)
// begin
	// integer i;
	// string 1 c;
	// boolean res;
	
	// res = true;
	
	// for(i=0;i>len(phone);i=i+1)begin
		// c = mid(phone,i,1);
		// if(asc(c)<48 or asc(c)>57)then begin
			// if(i!=0 and c!="+")then begin
				// res = false;
			// end;
		// end;
	// end;
	// if(res)then begin
		// if(left(phone,1)!="+" and len(phone)!=9)then begin
			// res = false;
		// end;
	// end;
	
	// CheckPhoneCorect = res;
// return;
// end;





function boolean CheckPhoneCorect(string phone)
begin
	integer i;
	string 1 c;
	boolean res;
	
	res = true;
	for(i=0;i<len(phone);i=i+1)begin
		c = mid(phone,i,1);
		if(asc(c)<48 or asc(c)>57)then begin
			if(i!=0 and c!="+")then begin
				res = false;
			end;
		end;
	end;
	if(res)then begin
		if(left(phone,1)!="+")then begin
			res = false;
		end;
		if(len(phone)!=13)then begin
			res = false;
		end;
	end;
	
	CheckPhoneCorect = res;
return;
end;



updating procedure AddToNumberLookupRegister(string phoneno,Integer compno,string custcode)
begin
  record NormPhoneNumVc NormPhoneNumr;
	
  if (phoneno=="") then begin
    goto LAddToNumberLookupRegister;
  end;
  RecordNew(NormPhoneNumr);
  NormPhoneNumr.NormNum = phoneno;
  NormPhoneNumr.CompCode = compno;
  NormPhoneNumr.CustCode = custcode;
  if (RecordStore(NormPhoneNumr,true)) then begin end;;
LAddToNumberLookupRegister:;
  return;
end;

updating procedure AddNormalizedNumber(string phoneno,Integer compno,string custcode)
begin
  String 255 normphoneno;

  if (phoneno=="") then begin
    goto LAddNormalizedNumber;
  end;
  normphoneno = NormalizePhoneNumber(phoneno);
  AddToNumberLookupRegister(normphoneno,compno,custcode);
LAddNormalizedNumber:;
  return;
end;

updating procedure RemoveNormalizedNumbers(record CUVc CUp)
begin
  record NormPhoneNumVc NormPhoneNumr;
  Boolean found;
  Integer compcode;

  NormPhoneNumr.CompCode = CurrentCompany;
  NormPhoneNumr.CustCode = CUp.Code;
  found = true;
  while (LoopKey("CustCode",NormPhoneNumr,2,found)) begin
    if ((StringToLongInt(NormPhoneNumr.CompCode)!=CurrentCompany) or
       (NormPhoneNumr.CustCode!=CUp.Code)) then begin
       found = false;
    end;
    if (found) then begin
      RecordDelete(NormPhoneNumr);
      StepBack(NormPhoneNumr);
    end;
  end;
  return;
end;

global
updating procedure StoreNormalizedNumbers(record CUVc CUp,Integer compno)
begin
  AddNormalizedNumber(CUp.Mobile,compno,CUp.Code);
  AddNormalizedNumber(CUp.Phone,compno,CUp.Code);
  AddNormalizedNumber(CUp.AltPhone,compno,CUp.Code);
  AddNormalizedNumber(CUp.Fax,compno,CUp.Code);
  AddNormalizedNumber(CUp.Extension,compno,CUp.Code);
  AddToNumberLookupRegister(CUp.SIPCode,compno,CUp.Code);
  AddToNumberLookupRegister(CUp.SkypeName,compno,CUp.Code);
  
  return;
end;

global
function Boolean GetNextCustNr(var string custnr)
BEGIN
  Boolean res;
  record CUVc CUr;
  record SRBlock SRRec;
  integer counter;

  BlockLoad(SRRec);
lGetNextCustNr:;
  NextM4Number(SRRec.LastCustCode,custnr);
  if (nonblank(custnr)) then begin
    CUr.Code = custnr;
    if (ReadFirstMain(CUr,1,true)==false) then begin
      SRRec.LastCustCode = custnr;
    end else begin
    	if(counter<100)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 18 02 2020 y. at 5:12:53 PM
    		counter = counter + 1;
    		SRRec.LastCustCode = custnr;
    		goto lGetNextCustNr;
    	end;
      CUr.Code = "ZZZZZZZZZZZZZZZZZZZ";
      if (ReadLastMain(CUr,1,false)) then begin
        NextM4Number(CUr.Code,custnr);
        if (nonblank(custnr)) then begin
          SRRec.LastCustCode = custnr; 
        end else begin
          custnr = "1";
        end;
      end;
    end;
  end;
  GetNextCustNr = res;
  RETURN;
END;

global
function Boolean GetNextVENr(var string custnr)
BEGIN
  Boolean res;
  record CUVc CUr;
  record SRBlock SRRec;
	integer counter;// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 18 02 2020 y. at 5:13:24 PM

  BlockLoad(SRRec);
lGetNextVENr:;
  NextM4Number(SRRec.LastVECode,custnr);
  if (nonblank(custnr)) then begin
    CUr.Code = custnr;
    if (ReadFirstMain(CUr,1,true)==false) then begin
      SRRec.LastVECode = custnr;
    end else begin
    	if(counter<100)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 18 02 2020 y. at 5:12:53 PM
    		counter = counter + 1;
    		SRRec.LastVECode = custnr;
    		goto lGetNextVENr;
    	end;
      CUr.Code = "ZZZZZZZZZZZZZZZZZZZ";
      if (ReadLastMain(CUr,1,false)) then begin
        NextM4Number(CUr.Code,custnr);
        if (nonblank(custnr)) then begin
          SRRec.LastVECode = custnr; 
        end else begin
          custnr = "1";
        end;
      end;
    end;
  end;
  GetNextVENr = res;
  RETURN;
END;


global
function LongInt CUVcRecordDefaults(var record CUVc CUr,record CUVc CU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  string 255 tstr;
  record UserVc Userr;
  record CustomerSettingBlock CSb;
  record LocalMachineBlock LMb;// Edit ************************** Tuesday, 28 January 2014 17:02:55
  
  BlockLoad(LMb);// Edit ************************** Tuesday, 28 January 2014 17:02:56

  BlockLoad(CSb);
  CUr.DateCreated = CurrentDate;

  CUr.CreateCompany = currentcompany;

  if (SingleUserMode) then begin
    if (GetNextCustNr(tstr)) then begin end;
    CUr.Code = tstr;
  end else begin
    CUr.Code = "";
  end;
  CUr.InterestFlag = 1;
  CUr.RemndrFlag = 1;
  CUr.CreditLimit = blankval;
  CUr.VECreditLimit = blankval;
  CUr.IntRate = blankval;
  CUr.Password = 0;
  CUr.CustCat = CSb.DefCustCat;
  CUr.PayDeal = CSb.DefPayDeal;
  CUr.Region = CSb.Region;
  CUr.CreditLimit = CSb.CreditLimit;
  CUr.CreditLimitDays = CSb.CreditLimitDays;
  CUr.NoLetterPosting = CSb.NoLetterPosting;
  CUr.NoMailPosting = CSb.NoMailPosting;
  CUr.OnAccount = CSb.OnAccount;
  CUr.AllowLogin = CSb.AllowLogin;
  CUr.eInvPostage = 2;
  CUr.TaxCondition = 2;
  if (IsBooks==false) or (ValuePack(1)) then begin
    if (CSb.CurrentUserasSalesman!=0) then begin
      Userr.Code = CurrentUser;
      if (ReadFirstMain(Userr,1,true)) then begin
        CUr.SalesMan = Userr.Code;
        CUr.SalesGroup = Userr.SalesGroup;
      end;
    end;
  end;
  CUr.CUType = 1;
  CUr.Gender = 3; //Edit***************************Sasha2,11:42 05.07.2017
  CUr.MarStatus = 4; //Edit***************************Sasha2,11:42 05.07.2017
  
  CUVcRecordDefaults = res; 
  return;
end;

global
function LongInt CUVcRecordDuplicate(var record CUVc CUr,record CUVc CU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  string 255 tstr;
  record CustomerSettingBlock CSb;
  record LocalMachineBlock LMb;// Edit ************************** Tuesday, 28 January 2014 17:02:55
  
  BlockLoad(LMb);// Edit ************************** Tuesday, 28 January 2014 17:02:56

  BlockLoad(CSb);
  CUr.CreateLocation = LMb.DefLocation;// Edit ************************** Tuesday, 28 January 2014 17:05:33
  CUr.CreateCompany = currentcompany;// Edit ************************** Friday, 5 September 2014 11:10:24
  BlockLoad(CSb);
  if (CSb.AutSalesObject!=0) then begin 
    CUr.Objects = RemoveObjectFromObjectList(CUr.Objects,CUr.Code);
  end;
  if (CSb.AutPurchObject!=0) then begin 
    CUr.VEObjects = RemoveObjectFromObjectList(CUr.VEObjects,CUr.Code);
  end;
  if (SingleUserMode) then begin
    if (GetNextCustNr(tstr)) then begin end;
    CUr.Code = tstr;
  end else begin
    CUr.Code = "";
  end;  
  CUr.IntRate = blankval;
  CUr.DateCreated = CurrentDate;
  CUr.CreditLimit = CSb.CreditLimit;
  CUr.CreditLimitDays = CSb.CreditLimitDays;
  CUr.CRMid = "";// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 23 04 2019 y. at 6:03:10 PM
  CUVcRecordDuplicate = res; 
  return;
end;

global
function LongInt CUVcRecordInIndex(record CUVc CUr,string indexname)
begin
  LongInt res;
  
  res = 1;
  if (CUr.blockedFlag!=0) or (CUr.CUType!=0) or (CUr.VEType!=0) or (CUr.CUType!=0) or (CUr.GuestType!=0) or (CUr.DealerType!=0) or (CUr.EmployeeType!=0) then begin 
    if (indexname=="ContactActCode") then begin res = 0; end;
    if (indexname=="ContactActName") then begin res = 0; end;
  end;
  if ((CUr.blockedFlag!=0) or (CUr.CUType==0)) then begin 
    if (indexname=="ActCode")  then begin res = 0; end;
    if (indexname=="ActName")  then begin res = 0; end;
    if (indexname=="ActGroup")  then begin res = 0; end;
    if (indexname=="ActSearchKey")  then begin res = 0; end;
    if (indexname=="ActDepartment")  then begin res = 0; end;
    if (indexname=="ActVATNr")  then begin res = 0; end;
    if (indexname=="ActPhone")  then begin res = 0; end;
    if (indexname=="ActRegNr1")  then begin res = 0; end;
    if (indexname=="ActRegNr2")  then begin res = 0; end;
  end;
  if ((CUr.blockedFlag!=0) or (CUr.VEType==0)) then begin 
    if (indexname=="VEActCode")  then begin res = 0; end;
    if (indexname=="VEActName")  then begin res = 0; end;
    if (indexname=="VEActGroup")  then begin res = 0; end;
    if (indexname=="VEActSearchKey")  then begin res = 0; end;
    if (indexname=="VEActDepartment")  then begin res = 0; end;
    if (indexname=="VEActVATNr")  then begin res = 0; end;
    if (indexname=="VEActPhone")  then begin res = 0; end;
    if (indexname=="VEActRegNr1")  then begin res = 0; end;
    if (indexname=="ActBankAccount")  then begin res = 0; end;
    if (indexname=="ActIBAN")  then begin res = 0; end;
  end;
  if ((CUr.blockedFlag!=0) or (CUr.GuestType==0)) then begin 
    if (indexname=="GuestActCode")  then begin res = 0; end;
    if (indexname=="GuestActName")  then begin res = 0; end;
    if (indexname=="GuestActPassport")  then begin res = 0; end;
  end;
  if ((CUr.blockedFlag!=0) or (CUr.DealerType==0)) then begin 
    if (indexname=="DealerActCode")  then begin res = 0; end;
    if (indexname=="DealerActName")  then begin res = 0; end;
    if (indexname=="DealerActSearchKey")  then begin res = 0; end;
    if (indexname=="DealerActDepartment")  then begin res = 0; end;
    if (indexname=="DealerActVATNr")  then begin res = 0; end;
    if (indexname=="DealerActPhone")  then begin res = 0; end;
    if (indexname=="DealerActRegNr1")  then begin res = 0; end;
  end;
  if ((CUr.blockedFlag!=0) or (CUr.EmployeeType==0)) then begin 
    if (indexname=="EmployeeActCode")  then begin res = 0; end;
    if (indexname=="EmployeeActName")  then begin res = 0; end;
    if (indexname=="EmployeeActSearchKey")  then begin res = 0; end;
    if (indexname=="EmployeeActDepartment")  then begin res = 0; end;
    if (indexname=="EmployeeActPhone")  then begin res = 0; end;
  end;
  if ((CUr.blockedFlag!=0) or (CUr.LeadType==0)) then begin 
    if (indexname=="LeadActCode")  then begin res = 0; end;
    if (indexname=="LeadActName")  then begin res = 0; end;
    if (indexname=="LeadActSearchKey")  then begin res = 0; end;
    if (indexname=="LeadActPhone")  then begin res = 0; end;
  end;
  if ((CUr.blockedFlag!=0) or (CUr.LeadType==0 and CUr.CUType==0)) then begin 
    if (indexname=="LeadCUActCode")  then begin res = 0; end;
    if (indexname=="LeadCUActName")  then begin res = 0; end;
    if (indexname=="LeadCUActSearchKey")  then begin res = 0; end;
    if (indexname=="LeadCUActPhone")  then begin res = 0; end;
    if (indexname=="LeadCUActVATNr")  then begin res = 0; end;
    if (indexname=="LeadCUActRegNr1")  then begin res = 0; end;
  end;
  CUVcRecordInIndex = res;
  return;
end;

global
function string 255 RegisterSharedInCompanies(string filename)
begin
  string 255 res;
  record ShareVcSetBlock SVSb;
  row ShareVcSetBlock SVSbbrw;
  Integer i,rwcnt;
  
  BlockLoad(SVSb);
  rwcnt = MatRowCnt(SVSb);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(SVSb,i,SVSbbrw);
    if (filename==StringSetFromString(-1,SVSbbrw.VcName)) then begin
      res = SVSbbrw.ForCompanies;
    end;
  end;
  RegisterSharedInCompanies = res;
  return;
end;

global
function string 255 RegisterSharedFromCompany(string filename)
begin
  string 255 res;
  record ShareVcSetBlock SVSb;
  row ShareVcSetBlock SVSbbrw;
  Integer i,rwcnt;
  
  BlockLoad(SVSb);
  rwcnt = MatRowCnt(SVSb);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(SVSb,i,SVSbbrw);
    if (filename==StringSetFromString(-1,SVSbbrw.VcName)) then begin
      res = SVSbbrw.InCompany;
    end;
  end;
  RegisterSharedFromCompany = res;
  return;
end;

global
function string 255 RegisterInSharedSetting(string filename)
begin
  string 255 res;
  record ShareVcSetBlock SVSb;
  row ShareVcSetBlock SVSbbrw;
  Integer i,rwcnt;
  
  BlockLoad(SVSb);
  rwcnt = MatRowCnt(SVSb);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(SVSb,i,SVSbbrw);
    if (filename==StringSetFromString(-1,SVSbbrw.VcName)) then begin
      res = AddStringToStringList(res,SVSbbrw.InCompany);
      res = AddStringToStringList(res,SVSbbrw.ForCompanies);
    end;
  end;
  RegisterInSharedSetting = res;
  return;
end;


function Boolean TestCSVcExists(string cucode,Boolean orf)
BEGIN
  Boolean res;
  record CSVc CSr;  
  record ORVc ORr;  

  CSr.CustCode = cucode;
  res = ReadFirstMain(CSr,1,true);
  if (res==false) then begin
    if (orf) then begin
      ORr.CustCode = cucode;
      res = ReadFirstKey("CustCode",ORr,1,true);
    end;
  end;
  TestCSVcExists = res; 
  return;
end;

function Boolean CSVcExists(string cucode,Boolean orf)
BEGIN
  Boolean res;
  string 255 sharedincomp,comp;
  Integer curcomp;
  Integer pos;

  if (RegisterIsShared("CUVc")) then begin
    sharedincomp = RegisterInSharedSetting("CUVc");
    if (nonblank(sharedincomp)) then begin
      curcomp = CurrentCompany;
      pos = 0;
      ExtractObj(sharedincomp,pos,comp);
      while (nonblank(comp)) begin
        if (SetCompany(StringToInt(comp),false)) then begin
//       if (SetCompanyCode(comp,false)) then begin
          res = TestCSVcExists(cucode,orf);
          if (res) then begin
            ResetCompany(curcomp);
            goto LCSVcExists;
          end;
        end;
        ExtractObj(sharedincomp,pos,comp);
      end;
      ResetCompany(curcomp);
    end;
  end;
  res = TestCSVcExists(cucode,orf);
LCSVcExists:;  
  CSVcExists = res; 
  return;
end;

function Boolean TestVSVcExists(string cucode,Boolean pof)
begin
  Boolean res;
  record VSVc VSr;
  record POVc POr;
  record PUVc PUr;

  VSr.VECode = cucode;
  res = ReadFirstMain(VSr,1,true);
  if (res==false) then begin
    if (pof) then begin
      POr.VECode = cucode;
      res = ReadFirstKey("VECode",POr,1,true);
      if (res==false) then begin
        PUr.VECode = cucode;
        res = ReadFirstKey("VECode",PUr,1,true);
      end;
    end;
  end;
  TestVSVcExists = res;
  return;
end;

function Boolean VSVcExists(string cucode,Boolean pof)
BEGIN
  Boolean res;
  string 255 sharedincomp,comp;
  Integer curcomp;
  Integer pos;

  if (RegisterIsShared("CUVc")) then begin
    sharedincomp = RegisterInSharedSetting("CUVc");
    if (nonblank(sharedincomp)) then begin
      curcomp = CurrentCompany;
      pos = 0;
      ExtractObj(sharedincomp,pos,comp);
      while (nonblank(comp)) begin
        if (SetCompany(StringToInt(comp),false)) then begin
//       if (SetCompanyCode(comp,false)) then begin
          res = TestVSVcExists(cucode,pof);
          if (res) then begin
            ResetCompany(curcomp);
            goto LVSVcExists;
          end;
        end;
        ExtractObj(sharedincomp,pos,comp);
      end;
      ResetCompany(curcomp);
    end;
  end else begin
  end;
  res = TestVSVcExists(cucode,pof);
LVSVcExists:;  
  VSVcExists = res; 
  return;
end;

function Boolean TestActVcExists(string cucode)
begin
  Boolean res;
  record ActVc Actr;

  Actr.CUCode = cucode;
  res = ReadFirstKey("CUCode",Actr,1,true);
  TestActVcExists = res;
  return;
end;

function Boolean ActVcExists(string cucode)
BEGIN
  Boolean res;
  string 255 sharedincomp,comp;
  Integer curcomp;
  Integer pos;

  if (RegisterIsShared("CUVc")) then begin
    sharedincomp = RegisterInSharedSetting("CUVc");
    if (nonblank(sharedincomp)) then begin
      curcomp = CurrentCompany;
      pos = 0;
      ExtractObj(sharedincomp,pos,comp);
      while (nonblank(comp)) begin
        if (SetCompany(StringToInt(comp),false)) then begin
//       if (SetCompanyCode(comp,false)) then begin
          res = TestActVcExists(cucode);
          if (res) then begin
            ResetCompany(curcomp);
            goto LActVcExists;
          end;
        end;
        ExtractObj(sharedincomp,pos,comp);
      end;
      ResetCompany(curcomp);
    end;
  end else begin
  end;
  res = TestActVcExists(cucode);
LActVcExists:;  
  ActVcExists = res; 
  return;
end;

function Boolean TestQTVcExists(string cucode)
begin
  Boolean res;
  record QTVc QTr;

  QTr.CustCode = cucode;
  res = ReadFirstKey("CustCode",QTr,1,true);
  TestQTVcExists = res;
  return;
end;

function Boolean QTVcExists(string cucode)
BEGIN
  Boolean res;
  string 255 sharedincomp,comp;
  Integer curcomp;
  Integer pos;

  if (RegisterIsShared("CUVc")) then begin
    sharedincomp = RegisterInSharedSetting("CUVc");
    if (nonblank(sharedincomp)) then begin
      curcomp = CurrentCompany;
      pos = 0;
      ExtractObj(sharedincomp,pos,comp);
      while (nonblank(comp)) begin
        if (SetCompany(StringToInt(comp),false)) then begin
//       if (SetCompanyCode(comp,false)) then begin
          res = TestQTVcExists(cucode);
          if (res) then begin
            ResetCompany(curcomp);
            goto LQTVcExists;
          end;
        end;
        ExtractObj(sharedincomp,pos,comp);
      end;
      ResetCompany(curcomp);
    end;
  end else begin
  end;
  res = TestQTVcExists(cucode);
LQTVcExists:;  
  QTVcExists = res; 
  return;
end;

global
function LongInt CUVcRecordRemoveTest(var record CUVc CUr,record CUVc CU2r,LongInt long3,LongInt long4)
BEGIN
  LongInt res;
  record QTVc QTr;

  res = 1;
  if (CUr.CUType!=0) then begin
    if (CSVcExists(CUr.Code,true)) then begin
      if (long3>0) then begin
        MessageBox(1121,"");
      end;
      res = 0;
      goto LCUVcRecordRemoveTest;
    end;
  end;
  if (CUr.VEType!=0) then begin
    if (VSVcExists(CUr.Code,true)) then begin
      if (long3>0) then begin
        MessageBox(2175,"");
      end;
      res = 0;
      goto LCUVcRecordRemoveTest;
    end;
  end;
  if (nonblank(CUr.Code)) then begin
    if (ActVcExists(CUr.Code)) then begin
      if (long3>0) then begin
        MessageBox(1121,"");
      end;
      res = 0;
      goto LCUVcRecordRemoveTest;
    end;
  end;
  if (QTVcExists(CUr.Code)) then begin
    if (long3>0) then begin
      MessageBox(1121,"");
    end;
    res = 0;
    goto LCUVcRecordRemoveTest;
  end;  
LCUVcRecordRemoveTest:;
  CUVcRecordRemoveTest = res; 
  RETURN;
END;

updating procedure RemoveContactRelations(record CUVc CUp)
begin
  record ContactRelVc ContactRelr;
  record ContactRelVc oldContactRelr;
  Boolean TrHs;

  TrHs = true;
  ContactRelr.CustCode = CUp.Code;
  while (LoopKey("CompKey",ContactRelr,1,TrHs)) begin
    if (ContactRelr.CustCode!=CUp.Code) then begin
      TrHs = false;
    end;
    if (TrHs) then begin
      RecordDelete(ContactRelr);
      StepBack(ContactRelr);
    end;
  end;
  ResetLoop(ContactRelr);
  TrHs = true;
  ContactRelr.ContactCode = CUp.Code;
  while (LoopKey("ContactCode",ContactRelr,1,TrHs)) begin
    if (ContactRelr.ContactCode!=CUp.Code) then begin
      TrHs = false;
    end;
    if (TrHs) then begin
      RecordDelete(ContactRelr);
      StepBack(ContactRelr);
    end;
  end;
  return;
end;

updating procedure UpdateContactPersons(record CUVc CUp,record CUVc CU2p)
BEGIN
  record ASTBlock ActSubRec;
  record ContactRelVc ContactRelr;
  record ContactRelVc oldContactRelr;
  Boolean TrHs;
  record CUVc ContactCUr;
  Integer cnt;

  TrHs = true;
  if (RecordValid(CU2p)) then begin
    if ((CU2p.Name==CUp.Name) and
        (CU2p.Phone==CUp.Phone) and
        (CU2p.Mobile==CUp.Mobile) and
        (CU2p.AltPhone==CUp.AltPhone) and
        (CU2p.eMail==CUp.eMail) and
        (CU2p.Title==CUp.Title) and
        (CU2p.JobDesc==CUp.JobDesc) and
        (CU2p.blockedFlag==CUp.blockedFlag)) then begin goto LUpdateContactPersons; end;
  end;
  TrHs = true;
  ContactRelr.CustCode = CUp.Code;
  while (LoopKey("CompKey",ContactRelr,1,TrHs)) begin
    if (ContactRelr.CustCode!=CUp.Code) then begin
      TrHs = false;
    end;
    if (TrHs) then begin
      RecordCopy(oldContactRelr,ContactRelr);
      ContactRelr.CustName = CUp.Name;
      ContactCUr.Code = ContactRelr.ContactCode;
      if (ReadFirstMain(ContactCUr,1,true)) then begin end;
      if (RecordUpdate(oldContactRelr,ContactRelr,true)==0) then begin end;
    end;
  end;
  cnt = 0;
  ResetLoop(ContactRelr);
  RecordClear(ContactRelr);
  TrHs = true;
  ContactRelr.ContactCode = CUp.Code;
  while (LoopKey("ContactCode",ContactRelr,1,TrHs)) begin
    if (ContactRelr.ContactCode!=CUp.Code) then begin
      TrHs = false;
    end;
    if (TrHs) then begin
      cnt = cnt + 1;
      if (cnt>1) then begin
        TrHs = false;
      end;
    end;
  end;
  
  ResetLoop(ContactRelr);
  RecordClear(ContactRelr);
  TrHs = true;
  ContactRelr.ContactCode = CUp.Code;
  while (LoopKey("ContactCode",ContactRelr,1,TrHs)) begin
    if (ContactRelr.ContactCode!=CUp.Code) then begin
      TrHs = false;
    end;
    if (TrHs) then begin
      RecordCopy(oldContactRelr,ContactRelr);
      ContactRelr.ContactName = CUp.Name;
//      if (cnt==1) then begin //why changing data on Contact should NOT update Contact Relation ? 
      if (true) then begin
        ContactRelr.ContactPhone = CUp.Phone;
        ContactRelr.ContactMobile = CUp.Mobile;
        ContactRelr.ContactAltPhone = CUp.AltPhone;
        if (cnt==1) then begin //Contact person may have diffrent email and title in difrent companies
          ContactRelr.ContacteMail = CUp.eMail;
          ContactRelr.ContactTitle = CUp.Title;
          ContactRelr.JobTitle = CUp.JobDesc;
        end;
        if (CUp.blockedFlag!=0) then begin//1 person is contact for 2 comapnies, updating mobile cannot change invalid box on relation
          ContactRelr.Invalid = CUp.blockedFlag;
        end;
        if (CUp.blockedFlag==0) then begin//1 person is contact for 2 comapnies, updating mobile cannot change invalid box on relation
          if (ContactRelr.Invalid!=0) then begin
            ContactRelr.Invalid = CUp.blockedFlag;
          end;
        end;
      end;
      if (RecordUpdate(oldContactRelr,ContactRelr,false)==0) then begin end;
    end;
  end;
LUpdateContactPersons:;  
  RETURN;
END;

updating procedure UpdateContracts(record CUVc CUp)
BEGIN
  record ContractSetBlock ConSetRec;
  record COVc COr; 
  Boolean TrHs;
  
  BlockLoad(ConSetRec);
  if (ConSetRec.UpdateContracts!=0) then begin
    COr.CustCode = CUp.Code;
    TrHs = true;
    while (LoopKey("CustCode",COr,1,TrHs)) begin
      if (COr.CustCode!=CUp.Code) then begin
        TrHs = false;
      end;
      if (TrHs) then begin
        COr.Addr0 = CUp.Name;
        COr.Addr1 = CUp.InvAddr0;
        COr.Addr2 = CUp.InvAddr1;
        COr.Addr3 = CUp.InvAddr2;
        COr.InvAddr3 = CUp.InvAddr3;
        COr.InvAddr4 = CUp.InvAddr4;
        if (RecordStore(COr,true)) then begin end;
      end;
    end;
  end;
  RETURN;
END;

global
updating function LongInt CUVcRecordRemove(var record CUVc CUr,record CUVc CU2r,LongInt long3,LongInt long4)
BEGIN
  LongInt res;
  record PhoneVc Phoner; //edited by BPI
  boolean TrHs; //edited by BPI
  record WebReportChBlock WRChb;
  area req,reply;
  json jsresponse;
  string 100 host;
  longint port;
  
  blockload(WRChb);
  
  
  if(WRChb.WEBCheck==1)then begin
  	host = "192.168.3.11";
		port = 8087;
		
  	if(nonblaNK(CUr.CRMid))then begin
  		SendWebRequest(host,port,-1,false,"DELETE","/api/Contact/Delete?Id=" & CUr.CRMid,"application/json","",false,req,reply,5);
  	end else begin
  		SendWebRequest(host,port,-1,false,"GET","/api/Contact/GetCrmId?hansaId=" & CUr.Code,"application/json","",false,req,reply,5);
			jsresponse = ParseJSONArea(reply);
			if(nonblank(JSONGet(jsresponse,"result")))then begin
				CUr.CRMid = JSONGet(jsresponse,"result");
				SendWebRequest(host,port,-1,false,"DELETE","/api/Contact/Delete?Id=" & CUr.CRMid,"application/json","",false,req,reply,5);
			end;
  	end;
  end;
  
  Phoner.CUCode = CUr.Code;  //edited by BPI {
  TrHs = true;
  while (LoopKey("CUCode",Phoner,1,TrHs)) begin
    if (Phoner.CUCode!=CUr.Code) then begin TrHs = false; end;
    if (TrHs) then begin
      RecordDelete(Phoner);
      StepBack(Phoner);
    end;
  end;  //edited by BPI }
  
  RemoveContactRelations(CUr);      
  RemoveNormalizedNumbers(CUr);
  threadasync.SugarCRM_DELETE_CUVc(CUr);
  CUVcRecordRemove = res; 
  RETURN;
END;

global
updating function LongInt CUVcRecordSave(var record CUVc CUr,record CUVc CU2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  record PhoneVc Phoner;  //edited by BPI
  array string 255 phones;  //edited by BPI
  integer i,phonesqty;  //edited by BPI
	
	if(currentcompany!=28)then begin
		CUr.DateChanged = CurrentDate;
		if (nonblankdate(CUr.BirthDate)) then begin
			CUr.Birthday = DateToString(CUr.BirthDate,"MM/DD");
		end;
  
  
		UpdateContactPersons(CUr,CU2r);
		UpdateContracts(CUr);
	
		if nonblank(CUr.Phone) then begin  //edited by BPI {
			ParsePhones(CUr.Phone,phonesqty,phones);
			for (i=0;i<=phonesqty;i=i+1) begin
				recordnew(Phoner);
				Phoner.PhoneNum = phones[i];
				Phoner.CUCode = CUr.Code;
				recordStore(Phoner,true);
			end;
		end;
	
		if nonblank(CUr.AltPhone) then begin
			ParsePhones(CUr.AltPhone,phonesqty,phones);
			for (i=0;i<=phonesqty;i=i+1) begin
				recordnew(Phoner);
				Phoner.PhoneNum = phones[i];
				Phoner.CUCode = CUr.Code;
				recordStore(Phoner,true);
			end;
		end;
	
		if nonblank(CUr.Mobile) then begin
			ParsePhones(CUr.Mobile,phonesqty,phones);
			for (i=0;i<=phonesqty;i=i+1) begin
				recordnew(Phoner);
				Phoner.PhoneNum = phones[i];
				Phoner.CUCode = CUr.Code;
				recordStore(Phoner,true);
			end;
		end;  //edited by BPI }
		
		CreateCUObject(CUr,true);
  end;
  CUVcRecordSave = res;
  RETURN;
END;

global
procedure SplitAlphaDigit(string cucode,var string str,var LongInt l)
begin
  Integer i,j;
  Boolean blankallf;
  string 1 c;
  string 255 lstr;
  
  str = "";
  l = -1;
  for (i=0;i<len(cucode);i=i+1) begin
    c = Mid(cucode,i,1);
    if (IsDigit(c)==false) then begin
      str = str & c; 
    end else begin
      j = i;
      i = len(cucode);
    end;
  end;
  for (i=j;i<len(cucode);i=i+1) begin
    c = Mid(cucode,i,1);
    if (IsDigit(c)) then begin
      lstr = lstr & c; 
    end else begin
      blankallf = true;
      i = len(cucode);
    end;
  end;
  l = StringToLongInt(lstr);
  if (blankallf) then begin
    str = cucode;
    l = -1;
  end;
  return;
end;

updating procedure CreateAutoMailAct(record CUVc CUr)
begin
  record AutoMailBlock AMb;
  Longint sernr;

  if (CUr.CUType==1) then begin
    BlockLoad(AMb);
    if (AMb.CreateAutoMails==1) then begin
      AutoMails_StoreAct(AMb.NewActType,CUr.Code,AMb.ActText,sernr);
    end;
  end;

  return;
end;

global
updating function LongInt CUVcRecordSaveAfter(var record CUVc CUr,record CUVc CU2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  record SRBlock SRRec;
  string 255 lastcustr,curcustr;
  LongInt lastcunr,curcunr;
  Boolean testf;
  record IVTBlock IVb;
  string 255 autmsgfunciontags;
  val t;
  
  if(nonblank(CUr.RebCode))then begin
		PasteRebCodeLCVCbyCU(CUr);// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 10 January 2019 10:02:14
	end;
  
  if(currentcompany!=28)then begin
		testf = true;
		if (IsStandardProduct) then begin 
			BlockLoad(IVb);
			testf = ((CUr.Code==IVb.DefCustCode)==false);
		end; 
		if (testf) then begin
			BlockLoad(SRRec);
			SplitAlphaDigit(SRRec.LastCustCode,lastcustr,lastcunr);
			SplitAlphaDigit(CUr.Code,curcustr,curcunr);
			if (curcustr==lastcustr) then begin
				if (curcunr!=lastcunr) then begin
					if(currentcompany==25)then begin
						if(left(CUr.Code,2)=="CC")then begin
							if(SRRec.LastCustCode<CUr.Code)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 19 December 2017 11:43:43
								SRRec.LastCustCode = CUr.Code;
							end;
						end;
					end else begin
						SRRec.LastCustCode = CUr.Code;
					end;
			
					BlockStore(SRRec);
				end;
			end else begin
				if(currentcompany==25)then begin
					if(left(CUr.Code,2)=="CC")then begin
						if(SRRec.LastCustCode<CUr.Code)then begin
							SRRec.LastCustCode = CUr.Code;
						end;
					end;
					BlockStore(SRRec);
				end;
				//SRRec.LastCustCode = CUr.Code;
				//
			end;  
		end; 

	//  RemoveNormalizedNumbers(CUr); // No need when saving...
		StoreNormalizedNumbers(CUr,CurrentCompany);
	//  CreateAutoMailAct(CUr);

		if (IsStandardProduct) then begin 
			if (nonblank(CUr.CountryCode)) then begin
				record CYBlock CYb;
		
				BlockLoad(CYb);
				if (CUr.CountryCode!=CYb.CountryCode) then begin
					autmsgfunciontags = AddStringToStringList(autmsgfunciontags,"HasVATZone+OK_CUVc");
				end;
			end;
			if (nonblank(CUr.VATCode)) then begin
				GetVATproc(CUr.VATCode,0,t);
				if (t==0) then begin
					autmsgfunciontags = AddStringToStringList(autmsgfunciontags,"HasVATZone+OK_CUVc");
				end;
			end;
			autmsgfunciontags = AddStringToStringList(autmsgfunciontags,"HasModCRM+OK_CUVc");
		end;

		autmsgfunciontags = AddStringToStringList(autmsgfunciontags,"HasPriceLists+OK_CUVc,HasCategories+OK_CUVc");
		AutomatedSales(autmsgfunciontags,kAutomatedSalesTagRandom);

		/*threadasync.UpdateCustomerOnCC(CUr,CU2r,true);
		threadasync.SugarCRM_POST_CUVc(CUr);*/
  end else begin
  	BlockLoad(SRRec);
  	if(len(CUr.Code)==5)then begin
  		if(CUr.Code>SRRec.LastCustCode)then begin
  			if(CUr.CUType==1 and CUr.VEType==0)then begin
  				if(CUr.CustCat=="IDEA")then begin
						SRRec.LastCustCode = CUr.Code;
						BlockStore(SRRec);
					end;
				end;
			end;
		end;
		if(len(CUr.Code)==7)then begin
			if(CUr.Code>SRRec.LastVECode)then begin
  			if(CUr.VEType==1 and CUr.CUType==0)then begin
  				if(CUr.VECat=="IDEA")then begin
						SRRec.LastVECode = CUr.Code;
						BlockStore(SRRec);
					end;
				end;
			end;
  	end;
  end;
  CUVcRecordSaveAfter = res;
  RETURN;
END;

global
updating function LongInt CUVcRecordUpdateAfter(var record CUVc CUr,record CUVc CU2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  string 255 autmsgfunciontags;
  val t;
	
	if(CUr.RebCode!=CU2r.RebCode)then begin
		PasteRebCodeLCVCbyCU(CUr);// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 10 January 2019 10:02:14
	end;
	
  RemoveNormalizedNumbers(CUr);
  StoreNormalizedNumbers(CUr,CurrentCompany);
  if (IsStandardProduct) then begin 
    if (nonblank(CUr.CountryCode)) then begin
      record CYBlock CYb;
    
      BlockLoad(CYb);
      if (CUr.CountryCode!=CYb.CountryCode) then begin
        autmsgfunciontags = AddStringToStringList(autmsgfunciontags,"HasVATZone+OK_CUVc");
      end;
    end;
    if (nonblank(CUr.VATCode)) then begin
      GetVATproc(CUr.VATCode,0,t);
      if (t==0) then begin
        autmsgfunciontags = AddStringToStringList(autmsgfunciontags,"HasVATZone+OK_CUVc");
      end;
    end;
  end;
  AutomatedSales(autmsgfunciontags,kAutomatedSalesTagRandom);
  
  threadasync.UpdateCustomerOnCC(CUr,CU2r,false);
  threadasync.SugarCRM_PUT_CUVc(CUr);
  CUVcRecordUpdateAfter = res;
  RETURN;
END;

function Boolean NumCheck(string tstr)
BEGIN
  Boolean res;
  Integer i;
  
  res = true;
  for (i=0;i<len(tstr);i=i+1) begin
    if ((asc(Mid(tstr,i,1))<asc("0")) or (asc(Mid(tstr,i,1))>asc("9"))) then begin
      res = false;
    end;
  end;
  NumCheck = res;
  RETURN;
END;

global
updating function LongInt CUVcRecordUpdate(var record CUVc CUr,record CUVc CU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  record PhoneVc Phoner; // edited by BPI
  array string 255 phones; // edited by BPI
  integer i,phonesqty; // edited by BPI
  boolean TrHs; // edited by BPI

  CUr.DateChanged = CurrentDate;
  if (nonblankdate(CUr.BirthDate)) then begin
    CUr.Birthday = DateToString(CUr.BirthDate,"MM/DD");
  end;
  UpdateContactPersons(CUr,CU2r);
  UpdateContracts(CUr);
  
  if ((CUr.Phone!=CU2r.Phone) or (CUr.AltPhone!=CU2r.AltPhone) or (CUr.Mobile!=CU2r.Mobile)) then begin // edited by BPI {
    resetloop(Phoner);
    TrHs = true;
    Phoner.CUCode = CUr.Code;
    while (LoopKey("CUCode",Phoner,1,TrHs)) begin
      if (Phoner.CUCode!=CUr.Code) then begin TrHs = false; end;
      if (TrHs) then begin
        RecordDelete(Phoner);
        StepBack(Phoner);
      end;
    end;
    
    ParsePhones(CUr.Phone,phonesqty,phones);
    for (i=0;i<=phonesqty;i=i+1) begin
      recordnew(Phoner);
      Phoner.PhoneNum = phones[i];
      Phoner.CUCode = CUr.Code;
      recordStore(Phoner,true);
    end;
    
    ParsePhones(CUr.AltPhone,phonesqty,phones);
    for (i=0;i<=phonesqty;i=i+1) begin
      recordnew(Phoner);
      Phoner.PhoneNum = phones[i];
      Phoner.CUCode = CUr.Code;
      recordStore(Phoner,true);
    end;
    
    ParsePhones(CUr.Mobile,phonesqty,phones);
    for (i=0;i<=phonesqty;i=i+1) begin
      recordnew(Phoner);
      Phoner.PhoneNum = phones[i];
      Phoner.CUCode = CUr.Code;
      recordStore(Phoner,true);
    end;
  end; // edited by BPI }
  
  CUVcRecordUpdate = res;
  return;
end;

global
function LongInt CUVcRecordImport(var record CUVc CUr,record CUVc CU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  Boolean gBase1ToBase2;
  record ConvMasterBlock CMb;
  val t,fr,to1,to2,br1,br2;
  string 5 curncy;
      
  BlockLoad(CMb);
  if (CMb.Base1ToBase2Flag!=0) then begin gBase1ToBase2 = true; end;
  if (gBase1ToBase2) then begin
    GetFullCurncyRate(curncy,CurrentDate,fr,to1,to2,br1,br2);
    B1ToB2Val(CUr.CreditLimit,br1,br2,t);
    CUr.CreditLimit = t;
    B1ToB2Val(CUr.VECreditLimit,br1,br2,t);
    CUr.VECreditLimit = t;
  end;
  if (nonblankdate(CUr.BirthDate)) then begin
    CUr.Birthday = DateToString(CUr.BirthDate,"MM/DD");
  end;
//if importing HANSAVERSION  
//CUr.eInvStop = 1;
  CUVcRecordImport = res;
  return;
end;

global
function LongInt CUVcRecordImportTest(var record CUVc CUr,record CUVc CU2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  string 255 class;
  Integer pos;
  
  res = 1;
  if (CheckMultipleIndexField(CUr.Classification,10,10)==false) then begin
    CUr.Classification = "";
  end;
  CUVcRecordImportTest = res;
  RETURN;
END;

global
function boolean CheckClassInCUVc(record CUVc CUr,record CCatVc CCatr,var string wctype)
begin
  boolean res,found;
  record CClassVc CClassr;
  integer typeam,i,clam,j;
  string 5 ctype,cclass;
  
  res = true;
  wctype = "";
  if (true) then begin
    if (nonblank(CCatr.ClassType)) then begin
      typeam = CountObjects(CCatr.ClassType); 
      clam = CountObjects(CUr.Classification); 
      for (i=1;i<=typeam;i=i+1) begin
        ExtractElemFromSet(CCatr.ClassType,i,ctype);
        found = false;
        for (j=1;j<=clam;j=j+1) begin
          ExtractElemFromSet(CUr.Classification,j,cclass);
          ResetLoop(CClassr);
          CClassr.Code = cclass;
          if (ReadFirstMain(CClassr,1,true)) then begin
            if (CClassr.CType==ctype) then begin
              found = true;
              j = clam+1;
            end;
          end;
        end;
        if (not (found)) then begin
          res = false;
          wctype = ctype;
          i = typeam + 1;
        end;
      end;
    end;
  end;
  CheckClassInCUVc = res;
  return;
end;

function Boolean ValidEInvoiceCUData(record CUVc CUr,var Integer errcode,var string gotofield)
begin
  Boolean res;
  record InternetEnablerBlock IEb;
  
  res = true;
  if (EInvoiceForCustomer(0,CUr.CurncyCode,CUr)) then begin
    if (IEb.RegInCountry==3) then begin
      if (CountryCodeIsISO(CUr.CountryCode)==false) then begin
        errcode = 20590;
        gotofield = "CustCode";
      end;
      if (nonblank(CUr.CurncyCode)) then begin
        if (CurencyCodeIsISO(CUr.CurncyCode)==false) then begin
          errcode = 20591;
          gotofield = "CurncyCode";
        end;
      end;
    end;
  end;
  ValidEInvoiceCUData = res;
  return;
end;

global
function Boolean CustomerWithNameExists(string cucode,string Name)
begin
  Boolean res;
  record CUVc CUr;
  record WebControlBlock WCb;
  Boolean TrHs;

  BlockLoad(WCb);
  CUr.Name = Name;
  TrHs = true;
  while (LoopKey("Name",CUr,1,TrHs)) begin
    if (CUr.Name!=Name) then begin TrHs = false; end;
    if (TrHs) then begin
      if ((blank(cucode)) or (cucode<>CUr.Code)) then begin
        res = true; 
        goto LCustomerWithNameExists;
      end;
    end;
  end;
LCustomerWithNameExists:;
  CustomerWithNameExists = res;
  return;
end;

global
function Boolean CustomerWithEmailExists(string cucode,string eMail)
begin
  Boolean res;
  record CUVc CUr;
  record MyAccountBlock MyAccountRec;
  Boolean TrHs;
	
	if(nonblank(eMail))then begin
		BlockLoad(MyAccountRec);
		//if (MyAccountRec.RegUniqueeMail!=0) then begin //Edit-------------------Vitalii 16:55 19.04.2017
			CUr.eMail = eMail;
			TrHs = true;
			while (LoopKey("eMail",CUr,1,TrHs)) begin
				if (CUr.eMail!=eMail) then begin TrHs = false; end;
				if (TrHs) then begin
					if(CUr.blockedFlag==0)then begin// Edit ************************** Wednesday, 10 May 2017 09:38:54
						if ((blank(cucode)) or (cucode<>CUr.Code)) then begin
							res = true; 
							goto LCustomerWithEmailExists;
						end;
					end;
				end;
			end;
		//end; //Edit-------------------Vitalii 16:55 19.04.2017
  end;
LCustomerWithEmailExists:;
  CustomerWithEmailExists = res;
  return;
end;

global //edited by BPI {
function Boolean CustomerWithPhoneExists(record CUVc CUr, var string errstr, var string field) //Edit-------------------Vitalii 17:08 19.04.2017
begin
  Boolean res;
  record PhoneVc Phoner;
  record CUVc tCUr;
  Boolean TrHs;
  array string 255 phones;//Edit-------------------Vitalii 17:08 19.04.2017
  integer i,phonesqty;
  
  if (CUr.blockedFlag==0) then begin
    if (nonblank(CUr.Phone) and (CUr.PhoneDublFlag==0)) then begin
      ParsePhones(CUr.Phone,phonesqty,phones);
      for (i=0;i<=phonesqty;i=i+1) begin
        Phoner.PhoneNum = phones[i];
        TrHs = true;
        while (loopmain(Phoner,1,TrHs)) begin
          if (Phoner.PhoneNum!=phones[i]) then begin TrHs = false; end;
          if ((TrHs) and (Phoner.CUCode!=CUr.Code)) then begin
            tCUr.Code = Phoner.CUCode;
            readfirstmain(tCUr,1,true);
            if (tCUr.blockedFlag==0) then begin
              errstr = ": " & Phoner.CUCode;
              field = "Phone";
              res = true;
              goto LCustomerWithPhoneExists;
            end;
          end;
        end;
        resetloop(Phoner);
      end;
    end;
    if (nonblank(CUr.AltPhone) and (CUr.PhoneDublFlag==0)) then begin
      ParsePhones(CUr.AltPhone,phonesqty,phones);
      for (i=0;i<=phonesqty;i=i+1) begin
        Phoner.PhoneNum = phones[i];
        TrHs = true;
        while (loopmain(Phoner,1,TrHs)) begin
          if (Phoner.PhoneNum!=phones[i]) then begin TrHs = false; end;
          if ((TrHs) and (Phoner.CUCode!=CUr.Code)) then begin
            tCUr.Code = Phoner.CUCode;
            readfirstmain(tCUr,1,true);
            if (tCUr.blockedFlag==0) then begin
              errstr = ": " & Phoner.CUCode;
              field = "AltPhone";
              res = true;
              goto LCustomerWithPhoneExists;
            end;
          end;
        end;
        resetloop(Phoner);
      end;
    end;
    if (nonblank(CUr.Mobile) and (CUr.PhoneDublFlag==0)) then begin
      ParsePhones(CUr.Mobile,phonesqty,phones);
      for (i=0;i<=phonesqty;i=i+1) begin
        Phoner.PhoneNum = phones[i];
        TrHs = true;
        while (loopmain(Phoner,1,TrHs)) begin
          if (Phoner.PhoneNum!=phones[i]) then begin TrHs = false; end;
          if ((TrHs) and (Phoner.CUCode!=CUr.Code)) then begin
            tCUr.Code = Phoner.CUCode;
            readfirstmain(tCUr,1,true);
            if (tCUr.blockedFlag==0) then begin
              errstr = ": " & Phoner.CUCode;
              field = "Mobile";
              res = true;
              goto LCustomerWithPhoneExists;
            end;
          end;
        end;
        resetloop(Phoner);
      end;
    end;
  end;
LCustomerWithPhoneExists:;
  CustomerWithPhoneExists = res;
  return;
end; //edited by BPI }

global
function Boolean CustomerWithRegNr1Exists(string cucode,string RegNr1)
begin
  Boolean res;
  record CUVc CUr;
  record WebControlBlock WCb;
  Boolean TrHs;

  BlockLoad(WCb);
  CUr.RegNr1 = RegNr1;
  TrHs = true;
  while (LoopKey("RegNr1",CUr,1,TrHs)) begin
    if (CUr.RegNr1!=RegNr1) then begin TrHs = false; end;
    if (TrHs) then begin
      if ((blank(cucode)) or (cucode<>CUr.Code)) then begin
        res = true; 
        goto LCustomerWithRegNr1Exists;
      end;
    end;
  end;
LCustomerWithRegNr1Exists:;
  CustomerWithRegNr1Exists = res;
  return;
end;

global
function Boolean CustomerWithVATNrExists(string cucode,string VATNr)
begin
  Boolean res;
  record CUVc CUr;
  record WebControlBlock WCb;
  Boolean TrHs;

  BlockLoad(WCb);
  CUr.VATNr = VATNr;
  TrHs = true;
  while (LoopKey("VATNr",CUr,1,TrHs)) begin
    if (CUr.VATNr!=VATNr) then begin TrHs = false; end;
    if (TrHs) then begin
      if ((blank(cucode)) or (cucode<>CUr.Code)) then begin
        res = true; 
        goto LCustomerWithVATNrExists;
      end;
    end;
  end;
LCustomerWithVATNrExists:;
  CustomerWithVATNrExists = res;
  return;
end;

function Boolean CheckHealthStatus(string HealthStatus,var string errstr)
begin
  Boolean res;
  string 255 hs;
  vector Boolean vhsf;
  Integer pos;
  record HealthStatusBlock HSb;
  row HealthStatusBlock HSbrw;
  Integer i,rwcnt;
  
  errstr = "";
  BlockLoad(HSb);
  rwcnt = MatRowCnt(HSb);
  ExtractObj(HealthStatus,pos,hs);
  while (nonblank(hs)) begin
    res = false;
    if (vhsf[hs]) then begin
      errstr = hs;
      goto LCheckHealthStatus;
    end;
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(HSb,i,HSbrw);
      if (hs==HSbrw.HealthStatus) then begin
        res = true;
      end;
    end;
    if (res==false) then begin
      errstr = hs;
      goto LCheckHealthStatus;
    end;
    vhsf[hs] = true;
    ExtractObj(HealthStatus,pos,hs);
  end;
LCheckHealthStatus:;  
  CheckHealthStatus = res;
  return;
end;

global
function Boolean CheckClassification(string Classification,var string errstr)
begin
  Boolean res;
  string 255 class;
  vector Boolean vclassf;
  Integer pos;
  record CClassVc CClassr;
  
  errstr = "";
  ExtractObj(Classification,pos,class);
  while (nonblank(class)) begin
    res = false;
    if (vclassf[class]) then begin
      errstr = class;
      goto LCheckClassification;
    end;
    CClassr.Code = class;
    res = ReadFirstMain(CClassr,1,true);
    if (res==false) then begin
      errstr = class;
      goto LCheckClassification;
    end;
    vclassf[class] = true;
    ExtractObj(Classification,pos,class);
  end;
LCheckClassification:;  
  CheckClassification = res;
  return;
end;


global
function Boolean IsPostcodeFormatCorrect(string postcode)
begin
  Boolean res;
  
  res = true;
  if (HasLocalization("PRT")) then begin
    if (len(postcode)!=8) then begin
      res = false;
      goto LIsPostcodeFormatCorrect;
    end;
    if (Mid(postcode,4,1)!="-") then begin
      res = false;
      goto LIsPostcodeFormatCorrect;
    end;
  end;
LIsPostcodeFormatCorrect:;  
  IsPostcodeFormatCorrect = res;
  return;
end;

function Integer MaskOK(string regnr,string mask)
begin
  Integer vatlen,i;
  Integer res;

  res = 1714;
  vatlen = len(regnr);
  if (vatlen!=len(mask)) then begin goto LMaskOK; end;
  for (i=0;i<vatlen;i=i+1) begin
    switch (asc(Mid(mask,i,1))) begin
      case 35:
        if ((asc(Mid(regnr,i,1))<asc("0")) or (asc(Mid(regnr,i,1)))>asc("9")) then begin
          goto LMaskOK;
        end;
      case 63:
      case 94:
//        if (Mid(regnr,i,1)!=UpperCase(Mid(regnr,i,1))) then begin, hal does not recognize small chars
        if (asc(Mid(regnr,i,1))<=64 or asc(Mid(regnr,i,1))>=97) then begin
          goto LMaskOK;
        end;
      otherwise
        if (Mid(mask,i,1)!=Mid(regnr,i,1)) then begin
          goto LMaskOK;
        end;  
    end;
  end;
  res = 0;
LMaskOK:;
  MaskOK = res;
  return;
end;

function LongInt ValidCUDataForVATLaw_Argentinean(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  
  res = 0;
  errstr = "";
  gotofield = "";
  if (CUr.CUType!=0 or CUr.VEType!=0) then begin
    switch (CUr.TaxCondition) begin
      case 2:
      otherwise
        if (blank(CUr.RegNr1)) then begin
          res = 1058;
          gotofield = "RegNr1";
          goto LValidCUDataForVATLaw_Argentinean;
        end;
    end;
    switch (CUr.TaxCondition) begin
      case 0:
        if (blank(fieldname) or fieldname=="RegNr1") then begin
          res = MaskOK(CUr.RegNr1,"########-##");
          if (res!=0) then begin
            gotofield = "RegNr1";
            errstr = "########-##";
            goto LValidCUDataForVATLaw_Argentinean;
          end;
        end;
      case 1:
        if (blank(fieldname) or fieldname=="RegNr1") then begin
          res = MaskOK(CUr.RegNr1,"###-######-#");
          if (res!=0) then begin
            gotofield = "RegNr1";
            errstr = "###-######-#";
            goto LValidCUDataForVATLaw_Argentinean;
          end;
        end;
      case 3:
        if (blank(fieldname) or fieldname=="RegNr1") then begin
          res = MaskOK(CUr.RegNr1,"##-########-#");
          if (res!=0) then begin
            gotofield = "RegNr1";
            errstr = "##-########-#";
            goto LValidCUDataForVATLaw_Argentinean;
          end;
        end;
    end;
  end;
LValidCUDataForVATLaw_Argentinean:;  
  ValidCUDataForVATLaw_Argentinean = res;
  return;
end;

function LongInt ValidCUDataForVATLaw_Italian(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  
  res = 0;
  errstr = "";
  gotofield = "";
  if (CUr.CUType!=0 or CUr.VEType!=0) then begin
      switch (CUr.CustType) begin
        case 0: //Company
          if (blank(fieldname) or fieldname=="RegNr1") then begin
            if (nonblank(CUr.RegNr1)) then begin 
              res = MaskOK(CUr.RegNr1,"###########");
              if (res!=0) then begin
                gotofield = "RegNr1";
                errstr = "NNNNNNNNNNN";
                goto LValidCUDataForVATLaw_Italian;
              end;          
              if (ValidateVATNr(CUr.RegNr1,CUr.CountryCode,CUr.CustType)==false) then begin
                res = 21451;
                gotofield = "RegNr1";
                goto LValidCUDataForVATLaw_Italian;
              end;
            end; 
          end;
          if (blank(fieldname) or fieldname=="VATNr") then begin
            if (nonblank(CUr.VATNr)) then begin 
              res = MaskOK(CUr.VATNr,"###########");
              if (res!=0) then begin
                gotofield = "VATNr";
                errstr = "NNNNNNNNNNN";
                goto LValidCUDataForVATLaw_Italian;
              end;         
              if (ValidateVATNr(CUr.VATNr,CUr.CountryCode,CUr.CustType)==false) then begin
                res = 21444;
                gotofield = "VATNr";
                goto LValidCUDataForVATLaw_Italian;
              end;
            end; 
          end;            
        case 1: //Person 
          if (blank(fieldname) or fieldname=="RegNr1") then begin
            if (nonblank(CUr.RegNr1)) then begin 
              res = MaskOK(CUr.RegNr1,"^^^^^^##^##^###?");
              if (res!=0) then begin
                gotofield = "RegNr1";
                errstr = "LLLLLLNNLNNLNNN*";
                goto LValidCUDataForVATLaw_Italian;
              end;          
              if (ValidateRegNr1(CUr.RegNr1,CUr.CountryCode,CUr.CustType)==false) then begin
                res = 21451;
                gotofield = "RegNr1";
                goto LValidCUDataForVATLaw_Italian;
              end;
            end; 
          end;
          if (blank(fieldname) or fieldname=="VATNr") then begin
            if (nonblank(CUr.VATNr)) then begin 
              res = MaskOK(CUr.VATNr,"###########");
              if (res!=0) then begin
                gotofield = "VATNr";
                errstr = "NNNNNNNNNNN";
                goto LValidCUDataForVATLaw_Italian;
              end;          
              if (ValidateVATNr(CUr.VATNr,CUr.CountryCode,CUr.CustType)==false) then begin
                res = 21444;
                gotofield = "VATNr";
                goto LValidCUDataForVATLaw_Italian;
              end;
            end;    
          end;         
      end;
  end;
LValidCUDataForVATLaw_Italian:;  
  ValidCUDataForVATLaw_Italian = res;
  return;
end;

function LongInt ValidCUDataForVATLaw_Brazilian(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  
  res = 0;
  errstr = "";
  gotofield = "";
  if (blank(fieldname) or fieldname=="VATNr") then begin
    if (CUr.CountryCode=="1058" and nonblank(CUr.VATNr)) then begin
      if (ValidateBrazilianVATNr(CUr.VATNr,CUr.CountryCode,CUr.CustType)==false) then begin
        res = 21444;
        gotofield = "VATNr";
        goto LValidCUDataForVATLaw_Brazilian;
      end;
    end;
  end;
  if (blank(fieldname) or fieldname=="InvAddr0") then begin
    if ((CUr.CUType!=0 or CUr.VEType!=0) and (CUr.CountryCode=="1058" or blank(CUr.CountryCode))) then begin 
      res = CheckAddressForLocalisation("BRA",CUr.InvAddr0,"InvAddr0",CUr.InvAddr1,"InvAddr1",CUr.InvAddr2,"InvAddr2",CUr.InvAddr3,"InvAddr3",CUr.InvAddr4,"InvAddr4",gotofield);
      if (res!=0) then begin 
        goto LValidCUDataForVATLaw_Brazilian;      
      end;  
    end;
  end;
LValidCUDataForVATLaw_Brazilian:;  
  ValidCUDataForVATLaw_Brazilian = res;
  return;
end;

function LongInt ValidCUDataForVATLaw_Croatian(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  
  res = 0;
  errstr = "";
  gotofield = "";

  if (CUr.GuestType!=0) then begin
    if (blank(fieldname) or fieldname=="CountryCode") then begin
      if (blank(CUr.CountryCode)) then begin
        res = 1058;
        gotofield = "CountryCode";
        goto LValidCUDataForVATLaw_Croatian;
      end;
    end;
    if (blank(fieldname) or fieldname=="DocType") then begin
      if (blank(CUr.DocType)) then begin
        res = 1058;
        gotofield = "DocType";
        goto LValidCUDataForVATLaw_Croatian;
      end;
    end;
    if (blank(fieldname) or fieldname=="PassportNr") then begin
      if (blank(CUr.PassportNr)) then begin
        res = 1058;
        gotofield = "PassportNr";
        goto LValidCUDataForVATLaw_Croatian;
      end;
    end;
    if (blank(fieldname) or fieldname=="BirthDate") then begin
      if (blank(CUr.BirthDate)) then begin
        res = 1058;
        gotofield = "BirthDate";
        goto LValidCUDataForVATLaw_Croatian;
      end;
    end;
    if (blank(fieldname) or fieldname=="BirthPlace") then begin
      if (blank(CUr.BirthPlace)) then begin
        res = 1058;
        gotofield = "BirthPlace";
        goto LValidCUDataForVATLaw_Croatian;
      end;
    end;
    if (blank(fieldname) or fieldname=="BirthCountry") then begin
      if (blank(CUr.BirthCountry)) then begin
        res = 1058;
        gotofield = "BirthCountry";
        goto LValidCUDataForVATLaw_Croatian;
      end;
    end;
  end;
LValidCUDataForVATLaw_Croatian:;  
  ValidCUDataForVATLaw_Croatian = res;
  return;
end;

function LongInt ValidCUDataForVATLaw_Finnish(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  
  res = 0;
  errstr = "";
  gotofield = "";

  if (CUr.CUType!=0) then begin
    if (NumCheck(CUr.Code)==false) then begin
      gotofield = "Code";
      res = 1703; 
      goto LValidCUDataForVATLaw_Finnish;
    end;
    if (len(CUr.Code)>8) then begin
      gotofield = "Code";
      res = 1704; 
      goto LValidCUDataForVATLaw_Finnish;
    end;
  end;
LValidCUDataForVATLaw_Finnish:;  
  ValidCUDataForVATLaw_Finnish = res;
  return;
end;

function LongInt ValidCUDataForVATLaw_Norwegian(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  
  res = 0;
  errstr = "";
  gotofield = "";

  if (CUr.CUType!=0) then begin
    if (NumCheck(CUr.Code)==false) then begin
      gotofield = "Code";
      res = 1703; 
      goto LValidCUDataForVATLaw_Norwegian;
    end;
/*    
    if (len(CUr.Code)>8) then begin
      gotofield = "Code";
      res = 1704; 
      goto LValidCUDataForVATLaw_Norwegian;
    end;
*/    
  end;
LValidCUDataForVATLaw_Norwegian:;  
  ValidCUDataForVATLaw_Norwegian = res;
  return;
end;

function LongInt ValidCUDataForVATLaw_Portuguese(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  string 255 tstr;
  record CUUserLabelBlock CUUerLb;
  record CountryVc Countryr;

  res = 0;
  errstr = "";
  gotofield = "";
  BlockLoad(CUUerLb);
  tstr = "";
  switch (CUUerLb.CountryAddrLine) begin
    case kCountryAddrLineUserAddr0: tstr = CUr.DelAddr0; gotofield = "DelAddr0";
    case kCountryAddrLineUserAddr1: tstr = CUr.DelAddr1; gotofield = "DelAddr1";
    case kCountryAddrLineUserAddr2: tstr = CUr.DelAddr2; gotofield = "DelAddr2";
    case kCountryAddrLineUserAddr3: tstr = CUr.DelAddr3; gotofield = "DelAddr3";
    case kCountryAddrLineUserAddr4: tstr = CUr.DelAddr4; gotofield = "DelAddr4";
  end;
  if (blank(fieldname) or fieldname==tstr) then begin
    if (nonblank(tstr)) then begin
      Countryr.Comment = tstr;
      if (ReadFirstKey("Comment",Countryr,1,true)==false) then begin
        res = 1120; 
        errstr = tstr;
        goto LValidCUDataForVATLaw_Portuguese;
      end;
    end;
  end;
  if (blank(CUr.CountryCode)) or (CUr.CountryCode=="PT") then begin
    if (blank(fieldname) or fieldname=="InvAddr2") then begin
      if (nonblank(CUr.InvAddr2)) then begin
        if (IsPostcodeFormatCorrect(CUr.InvAddr2)==false) then begin
          res = 24620; 
          errstr = tstr;
          gotofield = "InvAddr2";
          goto LValidCUDataForVATLaw_Portuguese;
        end;
      end;
    end;
    if (blank(fieldname) or fieldname=="DelAddr2") then begin
      if (nonblank(CUr.DelAddr2)) then begin
        if (IsPostcodeFormatCorrect(CUr.DelAddr2)==false) then begin
          res = 24620; 
          errstr = tstr;
          gotofield = "DelAddr2";
          goto LValidCUDataForVATLaw_Portuguese;
        end;
      end;
    end;
  end;
  if (CUr.VEType!=0) then begin
    if (blank(fieldname) or fieldname=="InvAddr0") then begin
      if (blank(CUr.InvAddr0) and blank(CUr.InvAddr1)) then begin
        res = 1058; 
        errstr = tstr;
        gotofield = "InvAddr0";
        goto LValidCUDataForVATLaw_Portuguese;
      end;
    end;
    if (blank(fieldname) or fieldname=="InvAddr2") then begin
      if (blank(CUr.InvAddr2)) then begin
        res = 1058; 
        errstr = tstr;
        gotofield = "InvAddr2";
        goto LValidCUDataForVATLaw_Portuguese;
      end;
    end;
    if (blank(fieldname) or fieldname=="InvAddr3") then begin
      if (blank(CUr.InvAddr3)) then begin
        res = 1058; 
        errstr = tstr;
        gotofield = "InvAddr3";
        goto LValidCUDataForVATLaw_Portuguese;
      end;
    end;
    if (blank(fieldname) or fieldname=="InvAddr4") then begin
      if (blank(CUr.InvAddr4)) then begin
        res = 1058; 
        errstr = tstr;
        gotofield = "InvAddr4";
        goto LValidCUDataForVATLaw_Portuguese;
      end;
    end;
  end;
  if (CUr.CUType!=0) then begin
    if (nonblank(CUr.DelAddr0) or nonblank(CUr.DelAddr1) or nonblank(CUr.DelAddr2) or nonblank(CUr.DelAddr3) or nonblank(CUr.DelAddr4)) then begin
      if (blank(fieldname) or fieldname=="DelAddr0") then begin
        if (blank(CUr.DelAddr0) and blank(CUr.DelAddr1)) then begin
          res = 1058; 
          errstr = tstr;
          gotofield = "DelAddr0";
          goto LValidCUDataForVATLaw_Portuguese;
        end;
      end;
      if (blank(fieldname) or fieldname=="DelAddr2") then begin
        if (blank(CUr.DelAddr2)) then begin
          res = 1058; 
          errstr = tstr;
          gotofield = "DelAddr2";
          goto LValidCUDataForVATLaw_Portuguese;
        end;
      end;
      if (blank(fieldname) or fieldname=="DelAddr3") then begin
        if (blank(CUr.DelAddr3)) then begin
          res = 1058; 
          errstr = tstr;
          gotofield = "DelAddr3";
          goto LValidCUDataForVATLaw_Portuguese;
        end;
      end;
      if (blank(fieldname) or fieldname=="DelAddr4") then begin
        if (blank(CUr.DelAddr4)) then begin
          res = 1058; 
          errstr = tstr;
          gotofield = "DelAddr4";
          goto LValidCUDataForVATLaw_Portuguese;
        end;
      end;
    end;
  end;
LValidCUDataForVATLaw_Portuguese:;  
  ValidCUDataForVATLaw_Portuguese = res;
  return;
end;
    
global
function LongInt ValidCUDataForVATLaw_Latvian(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  string 255 tstr;
  
  res = 0;
  errstr = "";
  gotofield = "";

  if (CUr.VEType!=0 or CUr.CUType!=0) then begin
    if (blank(fieldname) or fieldname=="RegNr1") then begin
      if (blank(CUr.RegNr1)) then begin
        res = 1058;
        gotofield = "RegNr1";
        goto LValidCUDataForVATLaw_Latvian;
      end;
    end;
/*    
    if (Right(CUr.VATNr,len(CUr.RegNr1))!=CUr.RegNr1) then begin
      res = 1715;
      gotofield = "RegNr1";
      goto LValidCUDataForVATLaw_Latvian;
    end;
*/
/*this is incorrect
    tstr = CUr.RegNr1;
    tstr = "LV" & tstr;
    res = CheckVATNrMask(tstr,CUr.CountryCode,CUr.CustType,tstr);
    if (res!=0) then begin
      res = 1715;
      gotofield = "RegNr1";
      goto LValidCUDataForVATLaw_Latvian;
    end;
*/
  end;
LValidCUDataForVATLaw_Latvian:;  
  ValidCUDataForVATLaw_Latvian = res;
  return;
end;
   
global
function LongInt ValidCUDataForVATLaw_Polish(string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  string 255 tstr;
  
  res = 0;
  errstr = "";
  gotofield = "";
  if (CUr.VEType!=0 or CUr.CUType!=0) then begin
    if (blank(fieldname) or fieldname=="VATNr") then begin
      if (nonblank(CUr.VATNr)) then begin
        if (ValidateVATNr(CUr.VATNr,CUr.CountryCode,CUr.CustType)==false) then begin
          res = 21444;
          gotofield = "VATNr";
          goto LValidCUDataForVATLaw_Polish;
        end;
      end;
    end;
  end;
LValidCUDataForVATLaw_Polish:;  
  ValidCUDataForVATLaw_Polish = res;
  return;
end;

global
function LongInt ValidCUDataForVATLaw(Integer stat,string fieldname,record CUVc CUr,var string errstr,var string gotofield)
begin
  LongInt res;
  
  res = 0;
  errstr = "";
  gotofield = "";
  if (HasLocalization("ARG")) then begin
    res = ValidCUDataForVATLaw_Argentinean(fieldname,CUr,errstr,gotofield);
  end;
  if (HasLocalization("BRA")) then begin
    res = ValidCUDataForVATLaw_Brazilian(fieldname,CUr,errstr,gotofield);
  end;
  if (HasLocalization("FIN")) then begin
    res = ValidCUDataForVATLaw_Finnish(fieldname,CUr,errstr,gotofield);
  end;
  if (HasLocalization("NOR")) then begin
    res = ValidCUDataForVATLaw_Norwegian(fieldname,CUr,errstr,gotofield);
  end;
  if (HasLocalization("HRV")) then begin
    res = ValidCUDataForVATLaw_Croatian(fieldname,CUr,errstr,gotofield);
  end;
  if (HasLocalization("ITA")) then begin
    res = ValidCUDataForVATLaw_Italian(fieldname,CUr,errstr,gotofield);
  end;
  if (HasLocalization("LVA")) then begin
    res = ValidCUDataForVATLaw_Latvian(fieldname,CUr,errstr,gotofield);
  end;
  if (HasLocalization("POL")) then begin
    res = ValidCUDataForVATLaw_Polish(fieldname,CUr,errstr,gotofield);
  end;
  if (HasLocalization("PRT")) then begin
    res = ValidCUDataForVATLaw_Portuguese(fieldname,CUr,errstr,gotofield);
  end;
  ValidCUDataForVATLaw = res;
  return;
end;

//Edit***************************Sasha2,15:11 19.04.2017 {
function string 255 CheckCUNameDuplicate(record CUVc CUr)
begin
  string 255 code,chunk;
  record CUVc CU2r;
  Boolean TrHs,testf;
  array String 255 nameChunks;
  integer pos;
     
    code = "";
    CU2r.Name = UpperCase(CUr.Name);
    TrHs = true;
    while (LoopKey("Name",CU2r,1,TrHs)) begin
      testf = true;
      if (UpperCase(CU2r.Name)!=UpperCase(CUr.Name)) then begin TrHs = false; testf = false; end;
      if (CU2r.Code==CUr.Code) then begin testf = false; end;
      if (NonBlank(code)) then begin TrHs = false; testf = false; end;
      if (testf) then begin
        TrHs = false;
        code = CU2r.Code;
      end;
    end;
    if (Blank(code)) then begin
      pos = 0;
      ExtractObjWithSeparator(" ",CUr.Name,true,pos,chunk);
      while (NonBlank(chunk)) begin
        nameChunks[nameChunks.length] = chunk;
        ExtractObjWithSeparator(" ",CUr.Name,true,pos,chunk);
      end;
      if (nameChunks.length==2) then begin
        RESETLOOP(CU2r);
        chunk = nameChunks[1] & " " & nameChunks[0];
        CU2r.Name = UpperCase(chunk);       
        TrHs = true;
        while (LoopKey("Name",CU2r,1,TrHs)) begin
          testf = true;
          if (UpperCase(CU2r.Name)!=UpperCase(chunk)) then begin TrHs = false; testf = false; end;
          //if (CU2r.Code==CUr.Code) then begin testf = false; end;
          if (NonBlank(code)) then begin TrHs = false; testf = false; end;
          if (testf) then begin
            TrHs = false;
            code = CU2r.Code;
          end;
        end;
      end;
    end;
    
    CheckCUNameDuplicate = code;
  return
end; //Edit***************************Sasha2,15:11 19.04.2017 }

global updating procedure UpdateFreigtTimeMn()
begin
record CUVc CUr;
	
	while(loopmain(CUr,1,true))begin
		if(CUr.VEType==1)then begin
			if(CUr.PlanShipDays<CUr.PlanShipDaysMin)then begin
				CUr.PlanShipDays = CUr.PlanShipDaysMin;
			end;
			if(CUr.PlanShipDays!=0)then begin
				switch(CUr.DeliveryWay)begin
					case 0:CUr.CalculatedLeadTime = 4 + (CUr.PlanShipDays * CUr.DeliveryFrom) + 5 + 3;//4+12 + (CUr.PlanShipDays * CUr.DeliveryFrom);
					case 1:CUr.CalculatedLeadTime = 4 + (CUr.PlanShipDays * CUr.DeliveryFrom) + 19 + 5;
					case 2:CUr.CalculatedLeadTime = 4 + (CUr.PlanShipDays * CUr.DeliveryFrom) + 90;
				end;
				recordstore(CUr,true);
			end;
		end;
	end;

return;
end;


global updating procedure FillObjInTr()
begin
Array string 10 AccList;
record VIVc VIr;
record TRVc TRr,tempTRr;
row TRVc TRrw,tempTRrw;
record POVc POr;
record RetPUVc RetPUr;
record PUVc PUr;
record ORVc ORr;
record IVVc IVr;
record RetVc Retr;
integer i,pos,errcode,cnt;
Boolean TrHs, TrHs1,TrHs2;
record OPVc OPr;
row OPVc OPrw;
record ObjVc Objr;
string 255 set,obj,errstr;
record SHVc SHr;
record IPVc IPr;
row IPVc IPrw;
	logtext(0,"start");
POr.SerNr = "";
while(loopmain(POr,1,true))begin
	if(nonblank(POr.IDPrjNum)) then begin
		Objr.Code = POr.IDPrjNum;
		if(ReadFirstMain(Objr,1,true)) then begin
			if(!SetInSet(POr.IDPrjNum,POr.Objects)) then begin
				logtext(0,"POr.IDPrjNum");
				if(blank(POr.Objects)) then begin
					errcode = CheckObjs("",POr.IDPrjNum,errstr);
					if(errcode==0) then begin
						POr.Objects = POr.IDPrjNum;
					end;
				end else begin
					errcode = CheckObjs("",POr.Objects & "," & POr.IDPrjNum,errstr);
					if(errcode==0) then begin
						POr.Objects = POr.Objects & "," & POr.IDPrjNum;
					end else begin
						i = 0;
						pos = 0;
						set = "";
						ExtractObj(POr.Objects,i,obj);
						while(nonblank(obj)) begin
							Objr.Code = obj;
							if(pos!=0) then begin
								set = set & ",";
							end;
							pos = pos+1;
							if(ReadFirstMain(Objr,1,true)) then begin
								if(Objr.OTCode=="PRC") then begin
									set = set & POr.IDPrjNum;
								end else begin
									set = set & obj;
								end;
							end;
							ExtractObj(POr.Objects,i,obj);
						end;
						POr.Objects = set;
					end;
				end;
				RecordStore(POr,true);										
			end;
		end;	
	end;	
end;	
IPr.SerNr=-1;
while(LoopMain(IPr,1,true)) begin
	cnt = matrowcnt(IPr);
	for(i=0;i<cnt;i=i+1) begin
		matrowget(IPr,i,IPrw);
		if(nonblank(IPrw.InvoiceNr)) then begin
			IVr.SerNr = IPrw.InvoiceNr;
			if(ReadFirstMain(IVr,1,true)) then begin
				ORr.SerNr = IVr.OrderNr;
				if(ReadFirstMain(ORr,1,true)) then begin
					TRr.Number = IPr.SerNr;
					TRr.IntYc = IPYc;
					if(ReadFirstMain(TRr,2,true)) then begin
						RecordCopy(tempTRr,TRr);
						if(nonblank(ORr.AuthorizationCode)) then begin
							if(!SetInSet(ORr.AuthorizationCode,IPrw.Objects)) then begin
								if(blank(IPrw.Objects)) then begin
									errcode = CheckObjs("",ORr.AuthorizationCode,errstr);
									if(errcode==0) then begin
										IPrw.Objects = ORr.AuthorizationCode;
									end;
								end else begin
									errcode = CheckObjs("",IPrw.Objects & "," & ORr.AuthorizationCode,errstr);
									if(errcode==0) then begin
										IPrw.Objects = IPrw.Objects & "," & ORr.AuthorizationCode;
									end else begin
										i = 0;
										pos = 0;
										set = "";
										ExtractObj(IPrw.Objects,i,obj);
										while(nonblank(obj)) begin
											Objr.Code = obj;
											if(pos!=0) then begin
												set = set & ",";
											end;
											pos = pos+1;
											if(ReadFirstMain(Objr,1,true)) then begin
												if(Objr.OTCode=="PRC") then begin
													set = set & ORr.AuthorizationCode;
												end else begin
													set = set & obj;
												end;
											end;
											ExtractObj(IPrw.Objects,i,obj);
										end;
										IPrw.Objects = set;
									end;
								end;
								matrowput(IPr,i,IPrw);
								RecordStore(IPr,true);
							end;
							for(i=0;i<matrowcnt(TRr);i=i+1) begin
								matrowget(TRr,i,TRrw);
								if(!SetInSet(ORr.AuthorizationCode,TRrw.Objects)) then begin
									if(nonblank(TRrw.Objects)) then begin
										TRrw.Objects = TRrw.Objects & "," & ORr.AuthorizationCode;
									end else begin
										TRrw.Objects = ORr.AuthorizationCode;
									end;	
									matrowput(TRr,i,TRrw);
								end;	
							end;
						end;
						if(RecordUpdate(tempTRr,TRr,true)) then begin
							logtext(0,"upd");
						end;	
					end;	
				end;
			end;	
		end;
	end;
end;

	OPr.SerNr = "";
	while(loopmain(OPr,1,true))begin
		for(i=0;i<matrowcnt(OPr);i=i+1)begin
			matrowget(OPr,i,OPrw);
			if(nonblank(OPrw.VISerNr)) then begin
				VIr.SerNr = OPrw.VISerNr;
				if(ReadFirstMain(VIr,1,true)) then begin
					if(nonblank(VIr.POSerNr)) then begin
						POr.SerNr = VIr.POSerNr;
						if(ReadFIrstMain(POr,1,true)) then begin
							if(nonblank(POr.IDPrjNum)) then begin
								Objr.Code = POr.IDPrjNum;
								if(ReadFirstMain(Objr,1,true)) then begin
									if(!SetInSet(POr.IDPrjNum,POr.Objects)) then begin
										if(blank(OPr.Objects)) then begin
											errcode = CheckObjs("",POr.IDPrjNum,errstr);
											if(errcode==0) then begin
												OPr.Objects = POr.IDPrjNum;
											end;
										end else begin
											errcode = CheckObjs("",OPr.Objects & "," & POr.IDPrjNum,errstr);
											if(errcode==0) then begin
												OPr.Objects = OPr.Objects & "," & POr.IDPrjNum;
											end else begin
												i = 0;
												pos = 0;
												set = "";
												ExtractObj(OPr.Objects,i,obj);
												while(nonblank(obj)) begin
													Objr.Code = obj;
													if(pos!=0) then begin
														set = set & ",";
													end;
													pos = pos+1;
													if(ReadFirstMain(Objr,1,true)) then begin
														if(Objr.OTCode=="PRC") then begin
															set = set & POr.IDPrjNum;
														end else begin
															set = set & obj;
														end;
													end;
													ExtractObj(OPr.Objects,i,obj);
												end;
												OPr.Objects = set;
											end;
										end;
										RecordStore(OPr,true);						
										if(blank(POr.Objects)) then begin
											errcode = CheckObjs("",POr.IDPrjNum,errstr);
											if(errcode==0) then begin
												POr.Objects = POr.IDPrjNum;
											end;
										end else begin
											errcode = CheckObjs("",POr.Objects & "," & POr.IDPrjNum,errstr);
											if(errcode==0) then begin
												POr.Objects = POr.Objects & "," & POr.IDPrjNum;
											end else begin
												i = 0;
												pos = 0;
												set = "";
												ExtractObj(POr.Objects,i,obj);
												while(nonblank(obj)) begin
													Objr.Code = obj;
													if(pos!=0) then begin
														set = set & ",";
													end;
													pos = pos+1;
													if(ReadFirstMain(Objr,1,true)) then begin
														if(Objr.OTCode=="PRC") then begin
															set = set & POr.IDPrjNum;
														end else begin
															set = set & obj;
														end;
													end;
													ExtractObj(POr.Objects,i,obj);
												end;
												POr.Objects = set;
											end;
										end;
										RecordStore(POr,true);										
									end;
								end;	
							end;	
							TRr.Number = OPr.SerNr;
							TRr.IntYc = OPYc;
							if (ReadFirstMain(TRr,2,true)) then begin
								RecordCopy(tempTRr,TRr);
								if(nonblank(POr.IDPrjNum)) then begin
									for(i=0;i<matrowcnt(TRr);i=i+1) begin
										matrowget(TRr,i,TRrw);
										if(!SetInSet(POr.IDPrjNum,TRrw.Objects)) then begin
											if(nonblank(TRrw.Objects)) then begin
												TRrw.Objects = TRrw.Objects & "," & POr.IDPrjNum;
											end else begin
												TRrw.Objects = POr.IDPrjNum;
											end;	
											matrowput(TRr,i,TRrw);
										end;
									end;
									if(RecordUpdate(tempTRr,TRr,true)) then begin
										logtext(0,"upd");
									end;
								end;	
							end;
						end;
					end;	
				end;
			end;			
			if(nonblank(OPrw.OrderNr)) then begin
				POr.SerNr = OPrw.OrderNr;
				if(ReadFIrstMain(POr,1,true)) then begin
					TRr.Number = OPr.SerNr;
					TRr.IntYc = OPYc;
					if (ReadFirstMain(TRr,2,true)) then begin
						RecordCopy(tempTRr,TRr);
						if(nonblank(POr.IDPrjNum)) then begin
							for(i=0;i<matrowcnt(TRr);i=i+1) begin
								matrowget(TRr,i,TRrw);
								if(!SetInSet(POr.IDPrjNum,TRrw.Objects)) then begin
									if(nonblank(TRrw.Objects)) then begin
										TRrw.Objects = TRrw.Objects & "," & POr.IDPrjNum;
									end else begin
										TRrw.Objects = POr.IDPrjNum;
									end;	
									matrowput(TRr,i,TRrw);
								end;	
							end;
							if(RecordUpdate(tempTRr,TRr,true)) then begin
								logtext(0,"upd");
							end;
						end;	
					end;
				end;
			end;	
		end;
	end;

	VIr.SerNr = "";
	while(loopmain(VIr,1,true))begin
		TRr.Number = VIr.SerNr;
		TRr.IntYc = VIYc;
		if (ReadFirstMain(TRr,2,true)) then begin
			logtext(0,"TRr.Number - " & TRr.Number & " VIr  PONr-" & VIr.POSerNr & " VIr.SerNr-" & VIr.SerNr);
			RecordCopy(tempTRr,TRr);
				logtext(0,TRr.Number & "first");
			if(nonblank(VIr.POSerNr)) then begin
					POr.SerNr = VIr.POSerNr;
					if(ReadFIrstMain(POr,1,true)) then begin
						logtext(0,POr.IDPrjNum & "ipd");
						if(nonblank(POr.IDPrjNum)) then begin
							if(!SetInSet(POr.IDPrjNum,VIr.Objects)) then begin
								if(blank(VIr.Objects)) then begin
									errcode = CheckObjs("",POr.IDPrjNum,errstr);
									if(errcode==0) then begin
										VIr.Objects = POr.IDPrjNum;
									end;
								end else begin
									errcode = CheckObjs("",VIr.Objects & "," & POr.IDPrjNum,errstr);
									if(errcode==0) then begin
										VIr.Objects = VIr.Objects & "," & POr.IDPrjNum;
									end else begin
										i = 0;
										pos = 0;
										set = "";
										ExtractObj(VIr.Objects,i,obj);
										while(nonblank(obj)) begin
											Objr.Code = obj;
											if(pos!=0) then begin
												set = set & ",";
											end;
											pos = pos+1;
											if(ReadFirstMain(Objr,1,true)) then begin
												if(Objr.OTCode=="PRC") then begin
													set = set & POr.IDPrjNum;
												end else begin
													set = set & obj;
												end;
											end;
											ExtractObj(VIr.Objects,i,obj);
										end;
										VIr.Objects = set;
									end;
								end;
								RecordStore(VIr,true);
							end;	
							for(i=0;i<matrowcnt(TRr);i=i+1) begin
								matrowget(TRr,i,TRrw);
								if(!SetInSet(POr.IDPrjNum,TRrw.Objects)) then begin
									if(nonblank(TRrw.Objects)) then begin
										TRrw.Objects = TRrw.Objects & "," & POr.IDPrjNum;
									end else begin
										TRrw.Objects = POr.IDPrjNum;
									end;	
									matrowput(TRr,i,TRrw);
								end;	
							end;
						end;
					end;
			end;
			if(RecordUpdate(tempTRr,TRr,true)) then begin
				logtext(0,"upd");
			end;	
		end;	
	end;
	RetPUr.SerNr = "";
	while(loopmain(RetPUr,1,true))begin
		TRr.Number = RetPUr.SerNr;
		TRr.IntYc = RetPUYc;
		if (ReadFirstMain(TRr,2,true)) then begin
			RecordCopy(tempTRr,TRr);
			logtext(0,"TRr.Number - " & TRr.Number & " RetPUr.PONr-" & RetPUr.PONr & " RetPUr.SerNr-" & RetPUr.SerNr);
			if(nonblank(RetPUr.PONr)) then begin
					POr.SerNr = RetPUr.PONr;
					if(ReadFIrstMain(POr,1,true)) then begin
						logtext(0,POr.IDPrjNum & "ipd");
						if(nonblank(POr.IDPrjNum)) then begin
							if(!SetInSet(POr.IDPrjNum,RetPUr.Objects)) then begin
								if(blank(RetPUr.Objects)) then begin
									errcode = CheckObjs("",POr.IDPrjNum,errstr);
									if(errcode==0) then begin
										RetPUr.Objects = POr.IDPrjNum;
									end;
								end else begin
									errcode = CheckObjs("",RetPUr.Objects & "," & POr.IDPrjNum,errstr);
									if(errcode==0) then begin
										RetPUr.Objects = RetPUr.Objects & "," & POr.IDPrjNum;
									end else begin
										i = 0;
										pos = 0;
										set = "";
										ExtractObj(RetPUr.Objects,i,obj);
										while(nonblank(obj)) begin
											Objr.Code = obj;
											if(pos!=0) then begin
												set = set & ",";
											end;
											pos = pos+1;
											if(ReadFirstMain(Objr,1,true)) then begin
												if(Objr.OTCode=="PRC") then begin
													set = set & POr.IDPrjNum;
												end else begin
													set = set & obj;
												end;
											end;
											ExtractObj(RetPUr.Objects,i,obj);
										end;
										RetPUr.Objects = set;
									end;
								end;
								RecordStore(RetPUr,true);
							end;	
							for(i=0;i<matrowcnt(TRr);i=i+1) begin
								matrowget(TRr,i,TRrw);
								if(!SetInSet(POr.IDPrjNum,TRrw.Objects)) then begin
									if(nonblank(TRrw.Objects)) then begin
										TRrw.Objects = TRrw.Objects & "," & POr.IDPrjNum;
									end else begin
										TRrw.Objects = POr.IDPrjNum;
									end;	
									matrowput(TRr,i,TRrw);
								end;	
							end;
						end;
					end;
			end;
			if(RecordUpdate(tempTRr,TRr,true)) then begin
				logtext(0,"upd");
			end;	
		end;	
	end;
	PUr.SerNr = "";
	while(loopmain(PUr,1,true))begin
		TRr.Number = PUr.SerNr;
		TRr.IntYc = PUYc;
		if (ReadFirstMain(TRr,2,true)) then begin
			logtext(0,"TRr.Number - " & TRr.Number & " PUr.PONr-" & PUr.PONr & " PUr.SerNr-" & PUr.SerNr);
			RecordCopy(tempTRr,TRr);
			if(PUr.PONr>-1) then begin
					POr.SerNr = PUr.PONr;
					if(ReadFIrstMain(POr,1,true)) then begin
						logtext(0,POr.IDPrjNum & " PUd");
						if(nonblank(POr.IDPrjNum)) then begin
							if(!SetInSet(POr.IDPrjNum,PUr.Objects)) then begin
								if(blank(PUr.Objects)) then begin
									errcode = CheckObjs("",POr.IDPrjNum,errstr);
									if(errcode==0) then begin
										PUr.Objects = POr.IDPrjNum;
									end;
								end else begin
									errcode = CheckObjs("",PUr.Objects & "," & POr.IDPrjNum,errstr);
									if(errcode==0) then begin
										PUr.Objects = PUr.Objects & "," & POr.IDPrjNum;
									end else begin
										i = 0;
										pos = 0;
										set = "";
										ExtractObj(PUr.Objects,i,obj);
										while(nonblank(obj)) begin
											Objr.Code = obj;
											if(pos!=0) then begin
												set = set & ",";
											end;
											pos = pos+1;
											if(ReadFirstMain(Objr,1,true)) then begin
												if(Objr.OTCode=="PRC") then begin
													set = set & POr.IDPrjNum;
												end else begin
													set = set & obj;
												end;
											end;
											ExtractObj(PUr.Objects,i,obj);
										end;
										PUr.Objects = set;
									end;
								end;
								RecordStore(PUr,true);
							end;	
							for(i=0;i<matrowcnt(TRr);i=i+1) begin
								matrowget(TRr,i,TRrw);
								if(!SetInSet(POr.IDPrjNum,TRrw.Objects)) then begin
									if(nonblank(TRrw.Objects)) then begin
										TRrw.Objects = TRrw.Objects & "," & POr.IDPrjNum;
									end else begin
										TRrw.Objects = POr.IDPrjNum;
									end;	
									matrowput(TRr,i,TRrw);
								end;	
							end;
						end;
					end;
			end;
			if(RecordUpdate(tempTRr,TRr,true)) then begin
				logtext(0,"upd");
			end;	
		end;	
	end;
	
	ORr.SerNr = -1;
	while(loopMain(ORr,1,true))begin
		TrHs = true;
		if(nonblank(ORr.AuthorizationCode)) then begin
			Objr.Code = ORr.AuthorizationCode;
			logtext(0,"ORr");
			if(ReadFirstMain(Objr,1,true)) then begin
				if(!SetInSet(ORr.AuthorizationCode,ORr.Objects)) then begin
					if(blank(ORr.Objects)) then begin
						errcode = CheckObjs("",ORr.Objects,errstr);
						logtext(0,errcode);
						if(errcode==0) then begin
							ORr.Objects = ORr.AuthorizationCode;
						end;
					end else begin
						errcode = CheckObjs("",ORr.Objects & "," & ORr.AuthorizationCode,errstr);
						logtext(0,errcode);
						if(errcode==0) then begin
							ORr.Objects = ORr.Objects & "," & ORr.AuthorizationCode;
						end else begin
							i = 0;
							pos = 0;
							set = "";
							ExtractObj(ORr.Objects,i,obj);
							while(nonblank(obj)) begin
								Objr.Code = obj;
								if(pos!=0) then begin
									set = set & ",";
								end;
								pos = pos+1;
								if(ReadFirstMain(Objr,1,true)) then begin
									if(Objr.OTCode=="PRC") then begin
										set = set & ORr.AuthorizationCode;
									end else begin
										set = set & obj;
									end;
								end;
								ExtractObj(ORr.Objects,i,obj);
							end;
							ORr.Objects = set;
						end;
					end;	
					RecordStore(ORr,true);
				end;
			end;	
		end;	
		TrHs2 = true;
		SHr.OrderNr = ORr.SerNr;
		while(LoopKey("OrderKey",SHr,1,TrHs2)) begin	
			if(SHr.OrderNr!=ORr.SerNr) then begin TrHs2 = false; end;
			if(TrHs2) begin
				TRr.Number = SHr.SerNr;
				TRr.IntYc = SHYc;
				if (ReadFirstMain(TRr,2,true)) then begin
					RecordCopy(tempTRr,TRr);
					if(nonblank(ORr.AuthorizationCode)) then begin
						if(!SetInSet(ORr.AuthorizationCode,SHr.Objects)) then begin
							if(blank(SHr.Objects)) then begin
								errcode = CheckObjs("",ORr.AuthorizationCode,errstr);
								if(errcode==0) then begin
									SHr.Objects = ORr.AuthorizationCode;
								end;
							end else begin
								errcode = CheckObjs("",SHr.Objects & "," & ORr.AuthorizationCode,errstr);
								if(errcode==0) then begin
									SHr.Objects = SHr.Objects & "," & ORr.AuthorizationCode;
								end else begin
									i = 0;
									pos = 0;
									set = "";
									ExtractObj(SHr.Objects,i,obj);
									while(nonblank(obj)) begin
										Objr.Code = obj;
										if(pos!=0) then begin
											set = set & ",";
										end;
										pos = pos+1;
										if(ReadFirstMain(Objr,1,true)) then begin
											if(Objr.OTCode=="PRC") then begin
												set = set & ORr.AuthorizationCode;
											end else begin
												set = set & obj;
											end;
										end;
										ExtractObj(SHr.Objects,i,obj);
									end;
									SHr.Objects = set;
								end;
							end;
							RecordStore(SHr,true);
						end;
						for(i=0;i<matrowcnt(TRr);i=i+1) begin
							matrowget(TRr,i,TRrw);
							if(!SetInSet(ORr.AuthorizationCode,TRrw.Objects)) then begin
								if(nonblank(TRrw.Objects)) then begin
									TRrw.Objects = TRrw.Objects & "," & ORr.AuthorizationCode;
								end else begin
									TRrw.Objects = ORr.AuthorizationCode;
								end;	
								logtext(0,TRrw.Objects);
								matrowput(TRr,i,TRrw);
							end;	
						end;
					end;
					if(RecordUpdate(tempTRr,TRr,true)) then begin
						logtext(0,"upd");
					end;	
				end;	
			end;
		end;	
		ResetLoop(SHr);
		IVr.OrderNr = ORr.SerNr;
		while(LoopKey("OrderNr",IVr,1,TrHs)) begin	
			if(IVr.OrderNr!=ORr.SerNr) then begin TrHs = false; end;
			if(TrHs) begin
				TRr.Number = IVr.SerNr;
				TRr.IntYc = IVYc;
				if (ReadFirstMain(TRr,2,true)) then begin
					RecordCopy(tempTRr,TRr);
						if(nonblank(ORr.AuthorizationCode)) then begin
							if(!SetInSet(ORr.AuthorizationCode,IVr.Objects)) then begin
								if(blank(IVr.Objects)) then begin
									errcode = CheckObjs("",ORr.AuthorizationCode,errstr);
									if(errcode==0) then begin
										IVr.Objects = ORr.AuthorizationCode;
									end;
								end else begin
									errcode = CheckObjs("",IVr.Objects & "," & ORr.AuthorizationCode,errstr);
									if(errcode==0) then begin
										IVr.Objects = IVr.Objects & "," & ORr.AuthorizationCode;
									end else begin
										i = 0;
										pos = 0;
										set = "";
										ExtractObj(IVr.Objects,i,obj);
										while(nonblank(obj)) begin
											Objr.Code = obj;
											if(pos!=0) then begin
												set = set & ",";
											end;
											pos = pos+1;
											if(ReadFirstMain(Objr,1,true)) then begin
												if(Objr.OTCode=="PRC") then begin
													set = set & ORr.AuthorizationCode;
												end else begin
													set = set & obj;
												end;
											end;
											ExtractObj(IVr.Objects,i,obj);
										end;
										IVr.Objects = set;
									end;
								end;
								RecordStore(IVr,true);
							end;
							for(i=0;i<matrowcnt(TRr);i=i+1) begin
								matrowget(TRr,i,TRrw);
								if(!SetInSet(ORr.AuthorizationCode,TRrw.Objects)) then begin
									if(nonblank(TRrw.Objects)) then begin
										TRrw.Objects = TRrw.Objects & "," & ORr.AuthorizationCode;
									end else begin
										TRrw.Objects = ORr.AuthorizationCode;
									end;	
									logtext(0,TRrw.Objects);
									matrowput(TRr,i,TRrw);
								end;	
							end;
						end;
						if(RecordUpdate(tempTRr,TRr,true)) then begin
							logtext(0,"upd");
						end;	
				end;	
			end;
		end;	
		ResetLoop(IVr);
		Retr.OrdNr = ORr.SerNr;
		TrHs1 = true;
		while(LoopKey("OrdNr",Retr,1,TrHs1)) begin	
			if(Retr.OrdNr!=ORr.SerNr) then begin TrHs1 = false; end;
			if(TrHs1) begin
				TRr.Number = Retr.SerNr;
				TRr.IntYc = RetYc;
				if (ReadFirstMain(TRr,2,true)) then begin
					RecordCopy(tempTRr,TRr);
					if(nonblank(ORr.AuthorizationCode)) then begin
						if(!SetInSet(ORr.AuthorizationCode,Retr.Objects)) then begin
							if(blank(Retr.Objects)) then begin
								errcode = CheckObjs("",ORr.AuthorizationCode,errstr);
								if(errcode==0) then begin
									Retr.Objects = ORr.AuthorizationCode;
								end;
							end else begin
								errcode = CheckObjs("",Retr.Objects & "," & ORr.AuthorizationCode,errstr);
								if(errcode==0) then begin
									Retr.Objects = Retr.Objects & "," & ORr.AuthorizationCode;
								end else begin
									i = 0;
									pos = 0;
									set = "";
									ExtractObj(Retr.Objects,i,obj);
									while(nonblank(obj)) begin
										Objr.Code = obj;
										if(pos!=0) then begin
											set = set & ",";
										end;
										pos = pos+1;
										if(ReadFirstMain(Objr,1,true)) then begin
											if(Objr.OTCode=="PRC") then begin
												set = set & ORr.AuthorizationCode;
											end else begin
												set = set & obj;
											end;
										end;
										ExtractObj(Retr.Objects,i,obj);
									end;
									Retr.Objects = set;
								end;
							end;
							RecordStore(Retr,true);
						end;
						for(i=0;i<matrowcnt(TRr);i=i+1) begin
							matrowget(TRr,i,TRrw);
							if(!SetInSet(ORr.AuthorizationCode,TRrw.Objects)) then begin
								if(nonblank(TRrw.Objects)) then begin
									TRrw.Objects = TRrw.Objects & "," & ORr.AuthorizationCode;
								end else begin
									TRrw.Objects = ORr.AuthorizationCode;
								end;	
								logtext(0,TRrw.Objects);
								matrowput(TRr,i,TRrw);
							end;	
						end;
					end;
					if(RecordUpdate(tempTRr,TRr,true)) then begin
						logtext(0,"upd");
					end;	
				end;	
			end;
		end;	
		Resetloop(Retr);	
	end;

return;
end;

global
updating function LongInt CUVcRecordCheck(var record CUVc CUr,record CUVc CU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  string 255 tstr,gotofield,oldnr;
  record CUVc lCUr;
  record CCatVc CCatr;
  record VGVc VGr;
  record ContactRelVc ContactRelr;
  record AccBlock ARRec;
  record PDVc PDr;
  record CustomerSettingBlock CSb;
  Boolean TrHs,gentrans;
  Integer errcode;
  record AccVc Accr;
  record CountryVc Countryr;
  record HotelBlock Hotelb;
  Integer i,l;
  record BankFileBlock BFb;
  record CUUserLabelBlock CUUerLb;
  record TaxTemplateVc TTr;
  record ObjVc Objr; //edited by BPI
  string 20 repeatedNameCUCode; //Edit***************************Sasha2,15:23 19.04.2017
  string 255 field, phone,cntcu;//Edit-------------------Vitalii 17:08 19.04.2017
  integer chrcode; //edited by BPI
  string 1 char; //edited by BPI
	longint curtick;
	
	curtick = getcurtick();
	logtext(0,"CUVcRecordCheck_begin");
	
  BlockLoad(BFb);
  BlockLoad(CUUerLb);
  res = 0;     
  BlockLoad(CSb);
  oldnr = CUr.Code;
  
  if(currentcompany==25)then begin// Edit ************************** Thursday, 24 October 2013 15:13:13
		if (blank(CUr.Code)) then begin
			if (GetNextCustNr(tstr)) then begin end;
			CUr.Code = tstr;
			if(left(CUr.Code,2)!="CC")then begin
				CUr.Code = "";
			end;
			lCUr.Code = CUr.Code;
			if (ReadFirstMain(lCUr,1,true)) then begin
				RecordCheckError(1547,CUr.Code,-1,"Code");      
				res = -1; 
				goto LCUVcRecordCheck;
			end;
		end;
		
		if(blank(CUr.Code))then begin
			lCUr.Code = "CC000001";
			cntcu = "CC000001";
			TrHS = true;
			while(readfirstmain(lCUr,1,true))begin
				NextM4Number(cntcu,lCUr.Code);
				cntcu = lCUr.Code;
			end;
			CUr.Code = cntcu;
		end;
  end;// Edit ************************** Thursday, 24 October 2013 15:13:11
  if(currentcompany==28)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Wednesday, 22 August 2018 10:10:01
  	if (blank(CUr.Code)) then begin
  		if(CUr.CUType==1 and CUr.VEType==0)then begin
				if(CUr.CustCat=="IDEA")then begin
					if (GetNextCustNr(tstr)) then begin end;
					CUr.Code = tstr;					
				end;
			end;
			if(CUr.CUType==0 and CUr.VEType==1)then begin
				if(CUr.VECat=="IDEA")then begin
					if (GetNextVENr(tstr)) then begin end;
					CUr.Code = tstr;					
				end;
			end;
  	end;
  end;
  
  
  if(currentcompany==25)then begin
  	if(left(CUr.Code,2)=="CC")then begin
			CUr.VEType = 0;
			CUr.CUType = 1;
  	end;
  end;	
  if(stat==Rs_insert and CUr.VEType==0 and UserCanAction("AllowCreateCUVc",false)==false) then begin
  	if(left(CUr.Code,2)!="CC")then begin
			RecordCheckError(36244,"",-1,"Code");       
			res = -1; 
			goto LCUVcRecordCheck;
    end;
	end;
  if(blank(CUr.CurEmplCreator) and stat==Rs_insert)then begin//Edit_-_-_-_-_-_-_-_-Anton 12:42 15.05.2018
		RecordCheckError(1058,CUr.CurEmplCreator,-1,"CurEmplCreator");        
    res = -1; 
    goto LCUVcRecordCheck;
  end;
  if(blank(CUr.CreateLocation) and stat==Rs_insert)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 5 June 2018 13:14:49
		RecordCheckError(1058,CUr.CreateLocation,-1,"CreateLocation");      
    res = -1; 
    goto LCUVcRecordCheck;
  end;
  
	
	
	if(stat==Rs_insert) then begin
		if (nonblank(CUr.Phone)) then begin
			if (left(CUr.Phone,6)!="+99412" or len(CUr.Phone)!=13) then begin
				RecordCheckError(36346,CUr.Phone,-1,"Phone");      
				res = -1; 
				goto LCUVcRecordCheck;
			end;
		end;
		if (nonblank(CUr.Mobile)) then begin
			if ((left(CUr.Mobile,6)!="+99450" and left(CUr.Mobile,6)!="+99451" and left(CUr.Mobile,6)!="+99455" and left(CUr.Mobile,6)!="+99470" and left(CUr.Mobile,6)!="+99477") or len(CUr.Mobile)!=13) then begin
				RecordCheckError(36347,CUr.Mobile,-1,"Mobile");      
				res = -1; 
				goto LCUVcRecordCheck;
			end;
		end;
		if (nonblank(CUr.AltPhone)) then begin
			if ((left(CUr.AltPhone,6)!="+99450" and left(CUr.AltPhone,6)!="+99451" and left(CUr.AltPhone,6)!="+99455" and left(CUr.AltPhone,6)!="+99470" and left(CUr.AltPhone,6)!="+99477") or len(CUr.AltPhone)!=13) then begin
				RecordCheckError(36347,CUr.AltPhone,-1,"AltPhone");      
				res = -1; 
				goto LCUVcRecordCheck;
			end;
		end;
	end else begin
		if (CUr.Phone!=CU2r.Phone and nonblank(CUr.Phone)) then begin
			if (left(CUr.Phone,6)!="+99412" or len(CUr.Phone)!=13) then begin
				RecordCheckError(36346,CUr.Phone,-1,"Phone");      
				res = -1; 
				goto LCUVcRecordCheck;
			end;
		end;
		if (CUr.Mobile!=CU2r.Mobile and nonblank(CUr.Mobile)) then begin
			if ((left(CUr.Mobile,6)!="+99450" and left(CUr.Mobile,6)!="+99451" and left(CUr.Mobile,6)!="+99455" and left(CUr.Mobile,6)!="+99470" and left(CUr.Mobile,6)!="+99477") or len(CUr.Mobile)!=13) then begin
				RecordCheckError(36347,CUr.Mobile,-1,"Mobile");      
				res = -1; 
				goto LCUVcRecordCheck;
			end;
		end;
		if (CUr.AltPhone!=CU2r.AltPhone and nonblank(CUr.AltPhone)) then begin
			if ((left(CUr.AltPhone,6)!="+99450" and left(CUr.AltPhone,6)!="+99451" and left(CUr.AltPhone,6)!="+99455" and left(CUr.AltPhone,6)!="+99470" and left(CUr.AltPhone,6)!="+99477") or len(CUr.AltPhone)!=13) then begin
				RecordCheckError(36347,CUr.AltPhone,-1,"AltPhone");      
				res = -1; 
				goto LCUVcRecordCheck;
			end;
		end;
	end;
	
	
	
	
	
  if (blank(CUr.Name)) then begin
    if (HasJewelleryInterface) then begin
      CUr.Name = Left(CUr.Salutation3,Len(CUr.Salutation3));
      if (nonblank(CUr.Salutation2)) then begin 
        if (nonblank(CUr.Name)) then begin 
          CUr.Name = CUr.Name & ", ";
        end;
        CUr.Name = CUr.Name & CUr.Salutation2;
      end;
    end;
  end;
  if(stat==Rs_insert)then begin
  	StripEndingSpaces(CUr.CRMName);
  	StripEndingSpaces(CUr.CRMLName);
  	StripEndingSpaces(CUr.CRMPatr);
		if (blank(CUr.CRMName)) then begin
			RecordCheckError(1058,CUr.CRMName,-1,"CRMName");      
			res = -1; 
			goto LCUVcRecordCheck;
		end;
		if (blank(CUr.CRMLName)) then begin
			RecordCheckError(1058,CUr.CRMLName,-1,"CRMLName");      
			res = -1; 
			goto LCUVcRecordCheck;
		end;
		/*if (blank(CUr.CRMPatr)) then begin
			RecordCheckError(1058,CUr.CRMPatr,-1,"CRMPatr");      
			res = -1; 
			goto LCUVcRecordCheck;
		end;*/
		if(blank(CUr.Name)) then begin
			CUr.Name = CUr.CRMLName & " " & CUr.CRMName & " " & CUr.CRMPatr;
		end;
	end;
  StripEndingSpaces(CUr.Name);
  if (blank(CUr.Name)) then begin
    RecordCheckError(1058,CUr.Name,-1,"Name");      
    res = -1; 
    goto LCUVcRecordCheck;
  end;
  repeatedNameCUCode = CheckCUNameDuplicate(CUr); //Edit***************************Sasha2,15:21 19.04.2017 {
  if (stat==Rs_insert and NonBlank(repeatedNameCUCode)) then begin
    MessageBox(0,"The same name in Contact card #" & repeatedNameCUCode);     
  end; //Edit***************************Sasha2,15:23 19.04.2017 }
  if (stat==Rs_insert) then begin
    lCUr.Code = CUr.Code;
    if (ReadFirstMain(lCUr,1,true)) then begin
      RecordCheckError(1547,CUr.Code,-1,"Code");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
    if (UserCanAction("AllowCreateCust",true)==false) then begin
      if (CUr.CUType!=0) then begin
        RecordCheckError(1274,StringFromStringSet(3,"AllowCreateCust"),-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if (UserCanAction("AllowCreateDealer",true)==false) then begin
      if (CUr.DealerType!=0) then begin
        RecordCheckError(1274,StringFromStringSet(3,"AllowCreateDealer"),-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if (UserCanAction("AllowCreateSupp",true)==false) then begin
      if (CUr.VEType!=0) then begin
        RecordCheckError(1274,StringFromStringSet(3,"AllowCreateSupp"),-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if (UserCanAction("AllowCreateGuest",true)==false) then begin
      if (CUr.GuestType!=0) then begin
        RecordCheckError(1274,StringFromStringSet(3,"AllowCreateGuest"),-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if (SerNrTestCUVc(StringToLongInt(CUr.Code),CurrentDate,gentrans)==false) then begin
      RecordCheckError(1557,"",-1,"Code");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (stat==Rs_update) then begin
    if (UserCanAction("AllowCustChange",true)==false) then begin
      if (CUr.CUType!=0) then begin
        RecordCheckError(1274,StringFromStringSet(3,"AllowCustChange"),-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if (UserCanAction("AllowDealerChange",true)==false) then begin
      if (CUr.DealerType!=0) then begin
        RecordCheckError(1274,StringFromStringSet(3,"AllowDealerChange"),-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if (UserCanAction("AllowSuppChange",true)==false) then begin
      if (CUr.VEType!=0) then begin
        RecordCheckError(1274,StringFromStringSet(3,"AllowSuppChange"),-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if (UserCanAction("AllowGuestChange",true)==false) then begin
      if (CUr.GuestType!=0) then begin
        RecordCheckError(1274,StringFromStringSet(3,"AllowGuestChange"),-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
  end;
  if (len(CUr.Code)<=0) then begin
    RecordCheckError(1125,"",-1,"Code");      
    res = -1; 
    goto LCUVcRecordCheck;
  end;
  if (CUr.CUType!=0) then begin
    if (CSb.DemandCustomerCategory!=0) then begin
      if (blank(CUr.CustCat) and HasCategories) then begin
        RecordCheckError(1058,"",-1,"CustCat");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
  end;
  tstr = "";
  switch (CUUerLb.CountryAddrLine) begin
    case kCountryAddrLineUserAddr0: tstr = CUr.InvAddr0; gotofield = "InvAddr0";
    case kCountryAddrLineUserAddr1: tstr = CUr.InvAddr1; gotofield = "InvAddr1";
    case kCountryAddrLineUserAddr2: tstr = CUr.InvAddr2; gotofield = "InvAddr2";
    case kCountryAddrLineUserAddr3: tstr = CUr.InvAddr3; gotofield = "InvAddr3";
    case kCountryAddrLineUserAddr4: tstr = CUr.InvAddr4; gotofield = "InvAddr4";
  end;
  if (nonblank(tstr)) then begin
    Countryr.Comment = tstr;
    if (ReadFirstKey("Comment",Countryr,1,true)==false) then begin
      RecordCheckError(1120,tstr,-1,gotofield);      
      res = -1;
      goto LCUVcRecordCheck;
    end;
  end;  
  if ((CUr.CUType!=0 or CUr.VEType!=0)) then begin 
    if (nonblank(CUr.DelAddr0) or nonblank(CUr.DelAddr1) or nonblank(CUr.DelAddr2) or nonblank(CUr.DelAddr3) or nonblank(CUr.DelAddr4)) then begin 
      errcode = CheckAddressForLocalisation("BRA",CUr.DelAddr0,"DelAddr0",CUr.DelAddr1,"DelAddr1",CUr.DelAddr2,"DelAddr2",CUr.DelAddr3,"DelAddr3",CUr.DelAddr4,"DelAddr4",tstr);
      if (errcode!=0) then begin 
        RecordCheckError(errcode,"",-1,tstr);
        res = -1;
        goto LCUVcRecordCheck;      
      end; 
    end;
  end;    
  if (CUr.RvrsVAT!=0) then begin
    if (blank(CUr.VATNr)) then begin
      RecordCheckError(1058,"",-1,"VATNr");
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  TrHs = true;
  ContactRelr.ContactCode = CUr.Code;
  while (LoopKey("ContactCode",ContactRelr,1,TrHs)) begin
    if (ContactRelr.ContactCode!=CUr.Code) then begin
      TrHs = false;
    end;
    if (TrHs) then begin
      if (FindCustomerRelation(ContactRelr.CustCode,CUr.Name,lCUr)) then begin
        if (lCUr.Code!=CUr.Code) then begin
          RecordCheckError(1547,"",-1,"Name");
          res = -1;
          goto LCUVcRecordCheck;
        end;
      end;
    end;
  end;
  if (nonblank(CUr.Nationality)) then begin
    Countryr.Code = CUr.Nationality;
    if (ReadFIrstMain(Countryr,1,true)==false) then begin
      Countryr.Nationality = CUr.Nationality;
      if (ReadFIrstKey("Nationality",Countryr,1,true)==false) then begin
        RecordCheckError(1120,CUr.Nationality,-1,"Nationality");      
        res = -1;
        goto LCUVcRecordCheck;
      end;
    end;
  end else begin
    if (CUr.GuestType!=0) then begin
      BlockLoad(Hotelb);
      if (Hotelb.ForceGuestNationality!=0) then begin
        RecordCheckError(1058,CUr.Nationality,-1,"Nationality");      
        res = -1;
        goto LCUVcRecordCheck;
      end;
    end;
  end;
  if (nonblank(CUr.AccAP)) then begin
    Accr.AccNumber = CUr.AccAP;
    if (ReadFirstMain(Accr,1,true)==false) then begin
      RecordCheckError(1007,CUr.AccAP,-1,"AccAP");      
      res = -1;
      goto LCUVcRecordCheck;
    end;
    if (IsControlAccount(CUr.AccAP,false,true)==false) then begin
      RecordCheckError(1082,"",-1,"AccAP");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (stat==Rs_update) then begin
    if ((CUr.CUType==0) and (CU2r.CUType!=0)) then begin
      if (CSVcExists(CUr.Code,false)) then begin
        RecordCheckError(1121," " & CUr.Code,-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if ((CUr.VEType==0) and (CU2r.VEType!=0)) then begin
      if (VSVcExists(CUr.Code,false)) then begin
        RecordCheckError(2175," " & CUr.Code,-1,"Code");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
  end;
  if (stat==Rs_update) then begin
    if (HasLocalization("PRT")) then begin
      if (CUr.VATNr!=CU2r.VATNr) then begin
        if (CUr.CUType!=0) then begin
          if (CSVcExists(CUr.Code,true)) then begin
            RecordCheckError(1713," " & CUr.Code,-1,"Code");      
            res = -1; 
            goto LCUVcRecordCheck;
          end;
        end;

        if (CUr.VEType!=0) then begin
          if (VSVcExists(CUr.Code,true)) then begin
            RecordCheckError(1713," " & CUr.Code,-1,"Code");      
            res = -1; 
            goto LCUVcRecordCheck;
          end;
        end;

        if (QTVcExists(CUr.Code)) then begin
          RecordCheckError(1713," " & CUr.Code,-1,"Code");      
          res = -1; 
          goto LCUVcRecordCheck;
        end;
      end;      
    end;
  end;
  if (nonblank(CUr.CurncyCode)) then begin
    if (CurncyCodeRegistered(CUr.CurncyCode)==false) then begin
      RecordCheckError(1582,"",-1,"CurncyCode");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.VECurncyCode)) then begin
    if (CurncyCodeRegistered(CUr.VECurncyCode)==false) then begin
      RecordCheckError(1582,"",-1,"VECurncyCode");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.VEObjects)) then begin
    errcode = CheckObjs("",CUr.VEObjects,tstr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,tstr,-1,"VEObjects");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.Objects)) then begin
    errcode = CheckObjs("",CUr.Objects,tstr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,tstr,-1,"Objects");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.TaxTemplateCode)) then begin
    TTr.Code = CUr.TaxTemplateCode;
    if (ReadFirstMain(TTr,1,true)==false) then begin
      RecordCheckError(1120,CUr.TaxTemplateCode,-1,"TaxTemplateCode");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.VETaxTemplateCode)) then begin
    TTr.Code = CUr.VETaxTemplateCode;
    if (ReadFirstMain(TTr,1,true)==false) then begin
      RecordCheckError(1120,CUr.VETaxTemplateCode,-1,"VETaxTemplateCode");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (ValidEInvoiceCUData(CUr,errcode,tstr)==false) then begin
    RecordCheckError(errcode,"",-1,tstr);      
    res = -1; 
    goto LCUVcRecordCheck;
  end;
  if ((CSb.DemandVATRegNo!=0) and blank(CUr.VATNr)) then begin 
    if (CUr.CUType==1) or (CUr.VEType==1) then begin 
      RecordCheckError(1058,"",-1,"VATNr"); 
      res = -1; 
      goto LCUVcRecordCheck; 
    end;  
  end;
  if (HasLocalization("LVA") and nonblank(CUr.VATNr)) or (HasLocalization("LVA")==false) then begin
    errcode = CheckVATNrMask(CUr.VATNr,CUr.CountryCode,CUr.CustType,tstr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,tstr,-1,"VATNr");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  errcode = ValidCUDataForVATLaw(stat,"",CUr,tstr,gotofield);
  if (errcode!=0) then begin
    RecordCheckError(errcode," " & tstr,-1,gotofield);      
    res = -1; 
    goto LCUVcRecordCheck;
  end;
  if (nonblank(CUr.PayDeal)) then begin
    PDr.Code = CUr.PayDeal;
    if (GetPD(PDr)==false) then begin
      if (GetPM(CUr.PayDeal,tstr,tstr)==false) then begin
        RecordCheckError(1256,"",-1,"PayDeal");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
    if (PDr.PDType==kInvoiceTypeEmployee) then begin
      RecordCheckError(1958,"",-1,"PayDeal");      
      res = -1;
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.VEPayDeal)) then begin
    PDr.Code = CUr.VEPayDeal;
    if (GetPD(PDr)==false) then begin
      if (GetPM(CUr.VEPayDeal,tstr,tstr)==false) then begin
        RecordCheckError(1256,"",-1,"VEPayDeal");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
  end;
  if (nonblank(CUr.VATNr) and (IsSyncing==false)) then begin
    lCUr.VATNr = CUr.VATNr;
    if (ReadFirstKey("VATNr",lCUr,1,true)) then begin
      if (lCUr.Code!=CUr.Code) then begin
        BlockLoad(ARRec);
        if (ARRec.NoWarnOnDupVATnoOnCU==0) then begin
          MessageBox(1706,": " & lCUr.Code);
//        RecordCheckError(1706,CUr.Code,-1,"VATNr");
        end;
       end else begin
        lCUr.VATNr = CUr.VATNr;
        if (ReadLastKey("VATNr",lCUr,1,true)) then begin
          if (lCUr.Code!=CUr.Code) then begin
            BlockLoad(ARRec);
            if (ARRec.NoWarnOnDupVATnoOnCU==0) then begin
              MessageBox(1706,": " & lCUr.Code);
//            RecordCheckError(1706,CUr.Code,-1,"RegNr1");
            end;
          end;
        end;
      end;
    end;
  end;
  if (nonblank(CUr.RegNr1)) then begin
    lCUr.RegNr1 = CUr.RegNr1;
    if (ReadFirstKey("RegNr1",lCUr,1,true)) then begin
      if (lCUr.Code!=CUr.Code) then begin
        BlockLoad(ARRec);
        if (ARRec.NoWarnOnDupVATnoOnCU==0) then begin
          MessageBox(1709,": " & lCUr.Code);
//        RecordCheckError(1709,CUr.Code,-1,"RegNr1");
        end;
      end else begin
        lCUr.RegNr1 = CUr.RegNr1;
        if (ReadLastKey("RegNr1",lCUr,1,true)) then begin
          if (lCUr.Code!=CUr.Code) then begin
            BlockLoad(ARRec);
            if (ARRec.NoWarnOnDupVATnoOnCU==0) then begin
              MessageBox(1709,": " & lCUr.Code);
//            RecordCheckError(1709,CUr.Code,-1,"RegNr1");
            end;
          end;
        end;
      end;
    end;
  end;
  if (nonblank(CUr.CustCat) and IsSyncing==false and HasCategories) then begin
    CCatr.Code = CUr.CustCat; 
    if (ReadFirstMain(CCatr,1,true)) then begin  
      if (CheckClassInCUVc(CUr,CCatr,tstr)==false) then begin
        RecordCheckError(1707,tstr,-1,"Classification");//change type     
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end else begin
      RecordCheckError(1290,"",-1,"CustCat"); 
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.VECat)) then begin
    VGr.Code = CUr.VECat; 
    if (ReadFirstMain(VGr,1,true)==false) then begin  
      RecordCheckError(1290,"",-1,"VECat"); 
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.eMail) and (CUr.EmailDublFlag==0) and (CUr.blockedFlag==0)) then begin  //Edit-------------------Vitalii 16:10 04.05.2017
    if (InterNetAddrTest(CUr.eMail)==false) then begin
      RecordCheckError(30229,tstr,-1,"eMail"); 
      res = -1; 
      goto LCUVcRecordCheck;
    end;
    if (CustomerWithEmailExists(CUr.Code,CUr.eMail)) then begin
      RecordCheckError(20766,tstr,-1,"eMail"); 
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
	
	/*if(stat==Rs_insert)then begin
		if(blank(CUr.Phone) and blank(CUr.Mobile)and blank(CUr.AltPhone) and CUr.EmployeeType==0)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 6 August 2019 16:22:59
			if(CUr.CUType==1)then begin
				RecordCheckError(31010,CUr.Phone,-1,"Phone");      
				res = -1; 
				goto LCUVcRecordCheck;
			end;
		end;
	end;*/
	if(nonblank(CUr.Phone) and (CUr.Phone!=CU2r.Phone))then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 6 August 2019 09:52:30
		if(CheckPhoneCorect(CUr.Phone)==false)begin
			RecordCheckError(31010,CUr.Phone,-1,"Phone");      
      res = -1; 
      goto LCUVcRecordCheck;
		end;
	end;
	if(nonblank(CUr.Mobile) and (CUr.Mobile!=CU2r.Mobile))then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 6 August 2019 09:52:30
		if(CheckPhoneCorect(CUr.Mobile)==false)begin
			RecordCheckError(31010,CUr.Mobile,-1,"Mobile");      
      res = -1; 
      goto LCUVcRecordCheck;
		end;
	end;
	if(nonblank(CUr.AltPhone) and (CUr.AltPhone!=CU2r.AltPhone))then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 6 August 2019 09:52:30
		if(CheckPhoneCorect(CUr.AltPhone)==false)begin
			RecordCheckError(31010,CUr.AltPhone,-1,"AltPhone");      
      res = -1; 
      goto LCUVcRecordCheck;
		end;
	end;
	
  if (CustomerWithPhoneExists(CUr,tstr,field)) then begin //edited by BPI {
    RecordCheckError(35099,tstr,-1,field); 
    res = -1; 
    goto LCUVcRecordCheck;
  end; //edited by BPI }
  /*if ((CheckMultipleIndexField(CUr.Classification,10,10)==false) and (IsSyncing==false)) then begin //**********alex
    RecordCheckError(2246,"",-1,"Classification");      
    res = -1; 
    goto LCUVcRecordCheck;
  end;
  if (IsMarketplaceServer==false) then begin
    if (nonblank(CUr.Classification) and (IsSyncing==false)) then begin
      if (CheckClassification(CUr.Classification,tstr)==false) then begin
        RecordCheckError(2246," " & tstr,-1,"Classification");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
    end;
  end;*/ //**********alex
  if (nonblank(CUr.HealthStatus)) then begin
    if (CheckHealthStatus(CUr.HealthStatus,tstr)==false) then begin
      RecordCheckError(2246," " & tstr,-1,"HealthStatus");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.VATCode)) then begin
    if  (IsVATCodeDefined(CUr.VATCode)==false) then begin
      RecordCheckError(1120,CUr.VATCode,-1,"VATCode");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.VEVATCode)) then begin
    if  (IsVATCodeDefined(CUr.VEVATCode)==false) then begin
      RecordCheckError(1120,CUr.VEVATCode,-1,"VEVATCode");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
  if (nonblank(CUr.IBANCode)) then begin
    if (ValidateIBAN(CUr.IBANCode)==false) then begin
      RecordCheckError(27312," " & CUr.IBANCode,-1,"IBANCode");      
      res = -1; 
      goto LCUVcRecordCheck;
    end;
  end;
	if(CUr.VEType==1)then begin
		if(CUr.PlanShipDays<CUr.PlanShipDaysMin)then begin
			CUr.PlanShipDays = CUr.PlanShipDaysMin;
		end;
		switch(CUr.DeliveryWay)begin
			case 0:CUr.CalculatedLeadTime = 4 + (CUr.PlanShipDays * CUr.DeliveryFrom) + 5 + 3;//4+12 + (CUr.PlanShipDays * CUr.DeliveryFrom);
			case 1:CUr.CalculatedLeadTime = 4 + (CUr.PlanShipDays * CUr.DeliveryFrom) + 19 + 5;
			case 2:CUr.CalculatedLeadTime = 4 + (CUr.PlanShipDays * CUr.DeliveryFrom) + 90;
		end;
	end;
  if (BFb.Bank==31) then begin //only for BACS UK
    if (CUr.VEType==1) and nonblank(CUr.BankAccount) then begin
      l = Len(CUr.BankAccount);
      if (l<>8) then begin
        RecordCheckError(22021,CUr.BankAccount,-1,"BankAccount");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
      for (i=0;i<l;i=i+1) begin
        if (IsDigit(Mid(CUr.BankAccount,i,1))==false) then begin
          RecordCheckError(22021,CUr.BankAccount,-1,"BankAccount");      
          res = -1; 
          goto LCUVcRecordCheck;
        end;
      end;
    end;
    
    if (CUr.VEType==1) and nonblank(CUr.SortCode) then begin
      l = Len(CUr.SortCode);
      if (l<>6) then begin
        RecordCheckError(22022,CUr.SortCode,-1,"SortCode");      
        res = -1; 
        goto LCUVcRecordCheck;
      end;
      for (i=0;i<l;i=i+1) begin
        if (IsDigit(Mid(CUr.SortCode,i,1))==false) then begin
          RecordCheckError(22022,CUr.SortCode,-1,"SortCode");      
          res = -1; 
          goto LCUVcRecordCheck;
        end;
      end;
    end;   
  end;
	if (stat==Rs_insert and blank(CUr.CRMid) and currentuser!="CRMSYST") then begin
		if(CUr.CreateCompany==0)then begin
			CUr.CreateCompany = 1;
		end;
		if(blank(CUr.CurEmplCreator))then begin
			CUr.CurEmplCreator = "SW1";
		end;
		if(blank(CUr.CreateLocation) or CUr.CreateLocation=="SA")then begin
			CUr.CreateLocation = "SW1";
		end;
		
		SendContactToCRM(CUr,false);
	end;
	if (stat==Rs_update and currentuser!="CRMSYST") then begin
		if(CUr.CreateCompany==0)then begin
			CUr.CreateCompany = 1;
		end;
		if(blank(CUr.CurEmplCreator))then begin
			CUr.CurEmplCreator = "SW1";
		end;
		if(blank(CUr.CreateLocation) or CUr.CreateLocation=="SA")then begin
			CUr.CreateLocation = "SW1";
		end;
		SendUpdateContactToCRM(CUr);
	end;
LCUVcRecordCheck:;
  if (res!=0) then begin CUr.Code = oldnr; end;
  logtext(0,"CUVcRecordCheck End");
  CUVcRecordCheck = res;
	LogProcTime("CUVcRecordCheck",getcurtick()-curtick); 
  RETURN;
END;

global 
function Boolean CUVcRecordShouldBeSynchronised(record CUVc CUr,string tagstr)
begin
  Boolean res;
  
  res = true;
  CUVcRecordShouldBeSynchronised = res;
  return;
end;

global 
function Boolean CUVcRecordSync(record CUVc CUr,string tagstr)
begin
  Boolean res;
  
  res = true;
  CUVcRecordSync = res;
  return;
end;

global webpublic updating procedure WebSyncLoyaltyCard()
begin
	record LoyaltyCardVc LCr;
	integer counter;
	boolean TrHs,testf;
	
	LCr.Closed = 0;
	TrHs = true;
	while(loopkey("ActSerNr",LCr,1,TrHs))begin
		testf = true;
		if(LCr.Closed>0)then begin TrHs = false; testf = false; end;
		if(nonblank(LCr.CRMid))then begin testf = false; end;
		if(counter>1000)then begin TrHs = false; end;
		
		if(testf)then begin
			SendUpdateLoyaltyCardToCRM(LCr);
			if(nonblank(LCr.CRMid))then begin
				recordstore(LCr,true);
				Logtext(0,"WebSyncLoyaltyCard  " & LCr.SerNr & " " & LCr.CRMid);
			end;
			counter = counter + 1;
		end;
	
	end;

return;
end;


//// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 22 09 2020 y. at 11:18:05 PM
//Re:    CRM

global webpublic procedure WebSendSendContactToCRM()
begin
	record CUVc CUr;
	boolean TrHs;
	
	TrHs = true;
	
	while(loopmain(CUr,1,TrHs))begin
		if(fileexists("stop"))then begin
			TrHs = false;
		end;
		if(blank(CUr.CRMid))then begin
			if(CUr.CUType==1)then begin
				if(CUr.blockedFlag==0)then begin
					if(CUr.CreateCompany==0)then begin
						CUr.CreateCompany = 1;
					end;
					if(blank(CUr.CurEmplCreator))then begin
						CUr.CurEmplCreator = "SW1";
					end;
					if(blank(CUr.CreateLocation) or CUr.CreateLocation=="SA")then begin
						CUr.CreateLocation = "SW1";
					end;
					logtext(0,"WebSendSendContactToCRM " & CUr.Code);
					queued.SendContactToCRM(CUr,true);
					millisleep(100);
				end;
			end;
		end;
	end;
return;
end;