external procedure B1ToB2StrValRM(string,val,val,var string,roundmode);
external procedure B1ToB2ValRM(val,val,val,var val,roundmode);
external function roundmode GetCostRoundModeRB();
external updating function LongInt POVcRecordUpdate(var record POVc,record POVc,LongInt,LongInt);
external updating function LongInt POVcRecordUpdateAfter(var record POVc,record POVc,LongInt,LongInt);
external procedure FindTempStockRow(LongInt,string,Boolean,record TempStockVc,var row TempStockVc);
external function Boolean StockRecordForLocationAllowed(string,string,string,date,integer,var Integer,var string);
external function Boolean HasIntegratedNL();
external procedure VerifyRowObjects(String,String,String,String,var Integer,var String,var Boolean,Array string,Array string,var Integer);
external updating function Integer CreateVIFromPO(LongInt,record RcVc,var record VIVc);
external updating procedure FindAcptRulesAndCreateAcceptanceAlert(Integer,Integer,string,string,string,val,string,string,string,string);
external updating procedure CancelApprovalRequestActivities(Integer,string,string,string);
external function Boolean IsDigit(string);
external function string 255 NextSerialNumber(string,string,record SerNrTrackBlock);
external function Boolean SerialNrEverinStock(string,string);
external function Boolean AcceptanceRulesExists(Integer,string);
external updating procedure PUVc_UpdateTR(record PUVc,record PUVc);
external function Boolean DisallowFutureDateCheck(Boolean,Date,string,Integer);
external updating procedure UpdateTrans_Stock(record TRVc);
external function Integer IsUnOKAllowed_PUVc(record PUVc);
external updating procedure DeleteTransaction(LongInt,Integer);
external function Boolean ItemHistExists(string,LongInt);
external updating procedure StoreUnOKHistory(string,LongInt,Date,Time,string);
external updating procedure UpdateRecalcStockNeeded(Integer);
external updating function Boolean BA_GRNCostVarianceWarning(record PUVc,var Integer);
external procedure FindBatchBestBeforeDate(string,string,var Date);
external procedure B1ToB2StrVal(string,val,val,var string);
external procedure B1ToB2Val(val,val,val,var val);
external procedure SwapM4Val(var val,var val);
external function Integer ArtCodePrimaryCostModel(string);
external function Integer FIFOPerSerialNr(record INVc,record CostAccBlock);
external function Boolean CanOKStockRecord(var Integer);
external function Boolean IsStockSettingsOK();
external updating procedure AddTTrans_PUVc(record TRVc,record PUVc);
external updating procedure UpdateStockResFromPU(record PUVc,record PUVc);
external function Integer CheckRates(string,val,val,val,val,val,var string);
external procedure FillAmForVariancePU(record PUVc);
external updating procedure UpdateVarianceStatusPU(record PUVc);
external function Integer CheckObjs(string,string,var string);
external procedure StockMovSumUp(var record StockMovVc);
external function Integer IsPositionFree(string);
external updating procedure RemovePU_PORows(var record PUVc);
external updating procedure SetPositionStatus(string,Integer);
external function string 20 FindFreePositionInLocArea(record INVc,string,record LocationVc,string,string);
external function Integer GetPO(LongInt,var record POVc,string,Boolean);
external updating procedure UpdatePOFromPURows(record PUVc,Boolean,record PUVc,Boolean,Boolean);
external function Boolean ReadFirstItem(string,var record INVc,Boolean,Boolean);
external function Boolean DateWarned(Date,string);
external function Boolean IsSerialNrCorrect(string);
external updating procedure UpdateSerStock(string,string,string,val,val);
external updating procedure InvalidatePU(record PUVc);
external updating procedure InvalidateTR(Integer,LongInt);
external updating procedure PurUpdateOvst(record PUVc,record PUVc);
external function string 255 CheckTrans(var record TRVc,Integer,Boolean);
external updating procedure SaveTrans(record TRVc);
external function Integer MakeTransFromPU(record TRVc,record PUVc,record LocationVc,Boolean);
external updating procedure PurUpdateCostPrice(record PUVc,Boolean);
external updating function Boolean UpdatePOFromPU(record PUVc,record PUVc,Boolean);
external updating procedure PurUpdateSerialNr(record PUVc,Boolean,Boolean);
external updating procedure PurUpdateItemHist(record PUVc);
external updating procedure UpdateInstock(string,string,string,string,date,val,val,val,val,val,val,val,val,val);
external function Boolean ShouldItemUpdateStock(string);
external procedure ConvertToDualBase(var string,date,var val,var val,var val,var val,var val,var val,Boolean);
external updating function val NextLocOKNr(string);
external function Boolean ExistStockTrans(string,Date,var Integer,var string,string,LongInt,record MainStockBlock);
external function Integer SerialNrOnThisPU(record PUVc,string,string);
external function Boolean SerialNrAvail2(string,string,val);
external function Boolean CheckAllowedSize(record INVc,val,val,val);
external function Integer CheckPosition(string,string,Integer,val,val,val);
external function Boolean IsOffice(Boolean);
external function Boolean Date2Test(string,Date,string,Integer);
external function Boolean SerNrTestPUVc(LongInt,Date,var Boolean);
external function LongInt GetCurUserLastNr(string);
external procedure PUSumUp(var record PUVc);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external procedure GetCurUser(var record UserVc);
external function val GetAcceptanceSum_PUVc(record PUVc);
external updating procedure UnOk_PUVc(var record PUVc);		//Edit----------------------Dima  20.01.2016
remote function string 20 ReturnFieldDIType(string,boolean);  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger16:20 06.07.2018
//remote function boolean DIsWithTypeExistsOrCreateSpecific(string,var string,string,var string);
remote updating function LongInt NewINVcRecordCheck(var record NewINVc,record NewINVc,LongInt,LongInt);
remote procedure HandleNewINDClassmCode(var record NewINVc,integer);
remote updating procedure CreateNewGlobalItem(var record INVc);
external function string 60 AddLocationObject(string,string,boolean); //EBS
external procedure LogProcTime(string,longint);
remote function LongInt PUFromBigPUDsm(record BigPUVc,var array LongInt);
external procedure ExtractObj(string,var Integer,var string);
external function roundmode DefaultRoundMode();
external procedure CustExtractObjectsByType(string,string,var array string,var integer,array string);
external updating procedure RecalculatePricesfromConsComp(record INVc);// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 25 06 2020 y. at 8:48:21 AM
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
remote procedure BigPUSumUp(var record BigPUVc);
external function roundmode SetRoundModeD(Integer);
remote procedure PUDClassWeightRow(var record BigPUVc,integer);
remote procedure PUDClassCaratRow(var record BigPUVc,integer);

SetLangMode(LangRussian,"RUS",0);
 

global
function string 20 GetNextOfficialSerNr(string RegisterName, date TransDate)		//Edit----------------------Dima  01.04.2015
begin
// This function returns OfficialSerNr in the format:   yyyy/mm/nnnnn   (2015/04/00102)

	string 20 OfficialSerNr,lastOffSerNr,lastDate;
	string 10 month, SerNumber;
	integer year;
	longint lastNumber;
	record StockMovVc SMr;
	record PUVc PUr;
	boolean TrHs;
	
	OfficialSerNr = "";
	lastOffSerNr = "00000";
	year = GetYear(TransDate);
	lastDate = "31/12/" & year;
	TrHs = true;		
	
	switch(RegisterName) begin
	
		case "PUVc":	
						PUr.TransDate = StringToDate(lastDate);						
						While(LoopBackKey("TransDate",PUr,2,TrHs)) begin
							if (GetYear(PUr.TransDate)!=year) then begin TrHs = false; end;
							if (TrHs and nonblank(PUr.OfficialSerNr)) then begin
								lastOffSerNr = PUr.OfficialSerNr;
								TrHs = false;
							end;
						end;	
						
		case "StockMovVc":	
						SMr.TransDate = StringToDate(lastDate);
						While(LoopBackKey("TransDate",SMr,2,TrHs)) begin
							if (GetYear(SMr.TransDate)!=year) then begin TrHs = false; end;
							if (TrHs and nonblank(SMr.OfficialSerNr)) then begin
								lastOffSerNr = SMr.OfficialSerNr;
								TrHs = false;
							end;
						end;							
	end;
		

	lastNumber = StringToInt(Right(lastOffSerNr,5)) + 1;
	SerNumber = Right("00000" & lastNumber,5);
	month = Right("0" & GetMonth(TransDate),2);
	
	OfficialSerNr = year & "/" & month & "/" & SerNumber;
	

GetNextOfficialSerNr = OfficialSerNr;
return;
end;

global
function LongInt PUVcRecordDefaults(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  record UserVc Userr;
  string 10 curcode;
  val fr,to1,to2,br1,br2;
  record AccBlock ARAccb;
  record MainStockBlock MSb;
  
  BlockLoad(ARAccb);
  BlockLoad(MSb);
  PUr.SerNr = -1;  
  PUr.RegDate = CurrentDate;
  PUr.TransDate = CurrentDate;
  PUr.Invalid = 0;
  if (SingleUserMode) then begin
    PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,-1,false,"");
  end;
  PUr.PONr = -1;
  PUr.POCOSerNr = -1;
  curcode = PUr.CurncyCode;
  GetFullCurncyRate(curcode,PUr.TransDate,fr,to1,to2,br1,br2);
  PUr.CurncyCode = curcode;
  PUr.FrRate = fr;
  PUr.ToRateB1 = to1; 
  PUr.ToRateB2 = to2;
  PUr.BaseRate1 = br1;
  PUr.BaseRate2 = br2;
  PUr.Cost1 = blankval;
  PUr.Cost2 = blankval;
  PUr.Cost3 = blankval;
  PUr.Cost4 = blankval;
  PUr.Cost5 = blankval;
  PUr.SumQuant = blankval;
  PUr.ShipCost = blankval;
  PUr.CustomsCost = blankval;
  PUr.SumCostPrice = blankval;
  PUr.SubTotal = blankval;
  PUr.VATVal = blankval;
  PUr.PayVal = blankval;
  GetCurUser(Userr);
  PUr.Location = Userr.Location;
  PUr.NoTAXonVAT = ARAccb.NoTAXonVAT;
  PUr.BranchID = CurBranchID;
  PUr.ExtraCostsCalculation = MSb.ExtraCostsCalculation;
  PUr.Objects = AddLocationObject(PUr.Objects,PUr.Location,true); // Edit ************************** BPI Ukraine - KramarAlexandr - 02, 23 04 2019 y. at 9:35:29 AM
  PUVcRecordDefaults = res; 
  return;
end;

global
function LongInt BigPUVcRecordDefaults(var record BigPUVc BPUr,record bigPUVc BPU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  BPUr.ConsManualCost = 1;
	BPUr.TransDate = CurrentDate;
	BPUr.CurrencyF = "AZN";
	BPUr.CurrencyT = "AZN";
  BigPUVcRecordDefaults = res; 
  return;
end;

global
function LongInt PUVcRecordDuplicate(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  row PUVc PUrw;   
  Integer rwcnt,i;
  string 10 curcode;
  val fr,to1,to2,br1,br2;
      
  PUr.SerNr = -1;
  PUr.PONr = -1;
  PUr.OKFlag = 0;
  PUr.Invalid = 0;
  rwcnt = MatRowCnt(PUr);
  for (i=0; i<rwcnt; i=i+1) begin
    MatRowGet(PUr,i,PUrw);
    if ((PUrw.ovst!=0) or (PUrw.stp==3)) then begin
      MatRowDelete(PUr,i);
      rwcnt = MatRowCnt(PUr);
      i = i - 1;
    end else begin
      PUrw.OrdRow = -1;
      PUrw.ChargeNumber = -1;
      PUrw.SerialNr = "";
      MatRowPut(PUr,i,PUrw);
    end;
  end;
  if (SingleUserMode) then begin
    PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,-1,false,"");
  end;
  curcode = PUr.CurncyCode;
  GetFullCurncyRate(curcode,PUr.TransDate,fr,to1,to2,br1,br2);
  PUr.CurncyCode = curcode;
  PUr.FrRate = fr;
  PUr.ToRateB1 = to1; 
  PUr.ToRateB2 = to2;
  PUr.BaseRate1 = br1;
  PUr.BaseRate2 = br2;
  PUr.LocOKNr = blankval;
  PUr.BranchID = CurBranchID;
  PUr.AcceptanceBy = "";
  PUr.AcceptanceFYI = "";
  PUSumUp(PUr); 
  PUVcRecordDuplicate = res; 
  return;
end;

global
function LongInt PUVcRecordRemoveTest(var record PUVc PUr,record PUVc PU2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  record DBLockBlock DBLockRec;
  record IVCashVc IVCashr;
  Integer actnr;
  record ActVc Actr;
  record RLinkVc RLr;

  res = 1;
  BlockLoad(DBLockRec);
  if (PUr.TransDate<=DBLockRec.DeleteBeforeDate) then begin
    res = 1;
    goto LPUVcRecordRemoveTest;
  end;
  if (PUr.OKFlag!=0) then begin
    if (long3>0) then begin
      MessageBox(1544,"");
    end;
    res = 0;
  end;    
  if (res!=0) then begin
    IVCashr.PUNr = PUr.SerNr;
    if (ReadFirstKey("PUNr",IVCashr,1,true)) then begin
      if (long3>0) then begin MessageBox(1560,"") end;
      res = 0;
    end;
  end;
  actnr = 1;
  while (ReadRecordLink(PUr,actnr,Actr,RLr)) begin
    if (Actr.TodoFlag==kTodoFlagApproval) then begin
      if (long3>0) then begin MessageBox(22408,""); end;
      res = 0;
      goto LPUVcRecordRemoveTest;
    end;
    actnr = actnr + 1;
  end;
LPUVcRecordRemoveTest:;
  PUVcRecordRemoveTest = res; 
  return;
end;

global
function LongInt BigPUVcRecordRemoveTest(var record BigPUVc BPUr,record BigPUVc BPU2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  record DBLockBlock DBLockRec;
  record IVCashVc IVCashr;
  Integer actnr;
  record ActVc Actr;
  record RLinkVc RLr;
	record VIVc VIr;

  res = 1;

  if (BPUr.OKFlag!=0) then begin
    if (long3>0) then begin
      MessageBox(1544,"");
    end;
    res = 0;
  end;    
	
	if(ReadRecordLink(BPUr,1,VIr,RLr)) then begin
		if (long3>0) then begin
      MessageBox(36333,"");
    end;
    res = 0;
	end;
	
LBPUVcRecordRemoveTest:;
  BigPUVcRecordRemoveTest = res; 
  return;
end;

global
function LongInt PUVcRecordReset(var record PUVc PUr,record PUVc PU2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  
  PUr.OKFlag = 0;
  PUVcRecordReset = res; 
  return;
end;

procedure AddToStockMovRow(row StockMovVc StockMovrw,row PUVc PUrw)
begin  
  StockMovrw.ArtCode = PUrw.ArtCode;
  StockMovrw.Quant = PUrw.Quant;
  StockMovrw.Spec = PUrw.Spec;
  StockMovrw.SerialNr = PUrw.SerialNr;
  StockMovrw.OldPrice = PUrw.CostPrice;
  StockMovrw.ExtraSCost = blankval;
  StockMovrw.NewPrice = PUrw.CostPrice;
  StockMovrw.BasePrice = PUrw.UPrice;
  StockMovrw.Coefficient = PUrw.Coefficient;
  StockMovrw.UnitXval = PUrw.UnitXval;
  StockMovrw.UnitYval = PUrw.UnitYval;
  StockMovrw.UnitZval = PUrw.UnitZval;
  StockMovrw.FrPosCode = PUrw.PosCode;
  return;
end;

updating procedure PUMakeStockMovement(record PUVc PUr,Boolean negf)
begin
  record StockMovVc StockMovr;
  row StockMovVc StockMovrw;
  row PUVc PUrw;
  Integer i,rwcnt,smrwcnt;
  record MainStockBlock MainRec;
  string 20 toposcode,lastpalletitem;
  record INVc INr;
  record LocationVc LocRec;
  Boolean storesmf;  
  
  BlockLoad(MainRec);  
  LocRec.Code = PUr.Location;
  if (blank(LocRec.Code)) then begin 
    LocRec.Code = MainRec.MainStock;
  end;
  if (ReadFirstMain(LocRec,1,true)) then begin end;
  if (LocRec.RequirePos==0) then begin goto LPUMakeStockMovement; end;
  if (PUr.OKFlag==0) then begin goto LPUMakeStockMovement; end;
  if (LocRec.RequirePos==0) then begin goto LPUMakeStockMovement; end;
  RecordNew(StockMovr);  
  StockMovr.FrLocation = PUr.Location;
  StockMovr.ToLocation = PUr.Location;
  if (blank(PUr.Location)) then begin
    StockMovr.FrLocation = MainRec.MainStock;
    StockMovr.ToLocation = MainRec.MainStock;
  end;
  StockMovr.ToForkLiftQue = 0;
  StockMovr.TransNr = PUr.SerNr;
  StockMovr.FileName = "PUVc";
  StockMovr.TransDate = CurrentDate;
  StockMovr.SerNr = NextSerNr("StockMovVc",StockMovr.TransDate,-1,false,"");

  rwcnt = MatRowCnt(PUr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(PUr,i,PUrw);
    if (blank(PUrw.PosCode)) then begin goto LSKIPROW; end;
//    if ((nonblank(PUrw.PosCode)) and (blank(PUrw.ToPosCode))) then begin
    if (nonblank(PUrw.PosCode)) then begin
      SetPositionStatus(PUrw.PosCode,1);
    end;
//    if (blank(PUrw.ToPosCode)) then begin goto LSKIPROW; end; //to pos code is assigned below if missing
    storesmf = false;
    ClearRow(StockMovr,StockMovrw,1);
    AddToStockMovRow(StockMovrw,PUrw);
    if (ReadFirstItem(StockMovrw.ArtCode,INr,true,true)) then begin end;
    if (blank(INr.DefPalletItem)) and (INr.Code!=lastpalletitem) then begin
      storesmf = true;
      StockMovr.ToForkLiftQue = 100;//items without pallet don't goto automatic delivery que
    end;
    if (blank(toposcode)) then begin
      toposcode = PUrw.ToPosCode;
      if (blank(toposcode)) then begin
        toposcode = FindFreePositionInLocArea(INr,INr.LocArea,LocRec,StockMovrw.FrPosCode,"");
      end;
    end;
    StockMovrw.ToPosCode = toposcode;
    if (blank(StockMovrw.ToPosCode)) then begin goto LSKIPROW; end;
    MatRowPut(StockMovr,smrwcnt,StockMovrw);
    SetPositionStatus(toposcode,2);    
    PUrw.BarCode = StockMovr.SerNr;    
    //BS, if next PUrw doesnЂt contain pallet item and the item has a pallet item
    // we should create a new StockMovVc.
    // or else labels will not be printed for 2nd/4th/6th item.
    MatRowGet(PUr,i+1,PUrw);
    if (PUrw.ArtCode!=INr.DefPalletItem) then begin
      storesmf = true;
    end;
    MatRowGet(PUr,i,PUrw);
    lastpalletitem = INr.DefPalletItem;
    smrwcnt = smrwcnt + 1;
    if ((Mod(smrwcnt,2)==0) or (storesmf)) then begin
      if (MatRowCnt(StockMovr)>0) then begin
        StockMovSumUp(StockMovr);    
        if (RecordStore(StockMovr,false)) then begin
          CreateRecordLink(StockMovr,CurrentCompany,PUr,CurrentCompany);  
          CreateRecordLink(PUr,CurrentCompany,StockMovr,CurrentCompany);  
        end;
      end;
      RecordNew(StockMovr);
      StockMovr.FrLocation = PUr.Location;
      StockMovr.ToLocation = PUr.Location;
      if (blank(PUr.Location)) then begin
        StockMovr.FrLocation = MainRec.MainStock;
        StockMovr.ToLocation = MainRec.MainStock;
      end;
      StockMovr.ToForkLiftQue = 0;
      StockMovr.TransNr = PUr.SerNr;
      StockMovr.FileName = "PUVc";
      StockMovr.TransDate = CurrentDate;
      StockMovr.SerNr = NextSerNr("StockMovVc",StockMovr.TransDate,-1,false,"");

      if (StockMovr.SerNr<=0) then begin goto LPUMakeStockMovement; end;

      smrwcnt = 0;
      toposcode = "";
      lastpalletitem = "";
    end;
    MatRowPut(PUr,i,PUrw);
LSKIPROW:;    
  end;
  if (MatRowCnt(StockMovr)>0) then begin
    StockMovSumUp(StockMovr);    
    if (RecordStore(StockMovr,false)) then begin
      CreateRecordLink(StockMovr,CurrentCompany,PUr,CurrentCompany);  
      CreateRecordLink(PUr,CurrentCompany,StockMovr,CurrentCompany);  
    end;
  end;
LPUMakeStockMovement:;  
  return;
end;

global
updating function LongInt PUVcRecordSave(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  if (PUr.OKFlag!=0) then begin
    PUr.LocOKNr = NextLocOKNr(PUr.Location);
  end;
  
  if (CurrentCompany==10) then begin //Dupont
		PUr.OfficialSerNr = GetNextOfficialSerNr("PUVc",PUr.TransDate);		//Edit----------------------Dima  01.04.2015
	end;
  
  PUVcRecordSave = res;
  return;
end;

global
updating procedure PurUpdateStock2(record PUVc PUp,Boolean negf,record TempStockVc TSr,Boolean usetmpstkf)
begin
  record MainStockBlock MainStockRec;
  row PUVc PUrw;
  Integer i,rwcnt;
  val t,t2,q2;
  string 255 location;
  string 255 thelocation;
  Boolean testf;
  row TempStockVc TSrw;
	record INVc INr;
  record GlobalItemVc GIr; 
	record POVc POr;
	longint curtick;
	
	curtick = getcurtick();
  if (PUp.Invalid!=0) then begin // not finnished
    goto LPurUpdateStock;
  end;
  location = PUp.Location;
  BlockLoad(MainStockRec);
  if (blank(location)) then begin
    location = MainStockRec.MainStock;
  end;
  rwcnt = MatRowCnt(PUp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(PUp,i,PUrw);
    testf = true;
    if (usetmpstkf) then begin
      FindTempStockRow(i,PUrw.ArtCode,true,TSr,TSrw);
      if (TSrw.StockAffectf==0) then begin testf = false; end;
      if (TSrw.ItemType!=kItemTypeStocked) then begin testf = false; end;
    end;
    if (testf) then begin
      if (blank(PUrw.Location)) then begin
        thelocation = location;
      end else begin
        thelocation = PUrw.Location;
      end;
      switch (PUrw.ovst) begin
        case 0:
          t2 = PUrw.Quant;
        case 1:
          t2 = 0;        
      end;
      if (ShouldItemUpdateStock(PUrw.ArtCode)==false) then begin t2 = blankval; end;
      if (MainStockRec.UnitConvCalc==0) then begin
        q2 = t2*PUrw.Coefficient;
      end else begin
        q2 = t2/PUrw.Coefficient;
      end;
      if (negf) then begin 
        t2 = -t2; 
        q2 = -q2; 
      end;
			INr.Code = PUrw.ArtCode;
			if(ReadFirstMain(INr,1,true))then begin
				GIr.Code = INr.BPIBrand & "_" & INr.Code;
				if(!ReadFirstMain(GIr,1,true) and CurrentCompany!=10 and CurrentCompany!=32 and CurrentCompany!=18)then begin 
					CreateNewGlobalItem(INr);
				end;
			end; 
			if (negf) then begin 
				POr.SerNr = PUp.PONr;
				if(ReadFIrstMain(POr,1,true))then begin
					if(POr.OKFlag==1)then begin
						UpdateInstock("PUVc",PUp.SerNr,PUrw.ArtCode,thelocation,PUp.TransDate,t2,t,t,-t2,-t2,q2,t,t,t);
					end else begin
						UpdateInstock("PUVc",PUp.SerNr,PUrw.ArtCode,thelocation,PUp.TransDate,t2,t,t,t,-t2,q2,t,t,t);
					end;
				end else begin
					UpdateInstock("PUVc",PUp.SerNr,PUrw.ArtCode,thelocation,PUp.TransDate,t2,t,t,t,t,q2,t,t,t);
				end;
			end else begin
				UpdateInstock("PUVc",PUp.SerNr,PUrw.ArtCode,thelocation,PUp.TransDate,t2,t,t,t,t,q2,t,t,t);
			end; 
    end;
  end;
LPurUpdateStock:;
  return;
end;

global
updating procedure PurUpdateStock(record PUVc PUp,Boolean negf)
begin
  record TempStockVc TSr;
  
  PurUpdateStock2(PUp,negf,TSr,false);
  return;
end;

updating procedure SavePurchase(var record PUVc PUp,Boolean saverec)
begin
  record PUVc PU2r;
  longint curtick;
	
	curtick = getcurtick();
	
  if (PUp.OKFlag!=0) then begin
    PurUpdateStock(PUp,false);
    PurUpdateCostPrice(PUp,false);  // this should never be called during import!!! 
    PurUpdateSerialNr(PUp,false,false);//before ItemHist to get consigment stock right
    PurUpdateItemHist(PUp);
  end;
  if (PUp.PONr!=-1) then begin
    PU2r.SerNr = -1;
    if (UpdatePOFromPU(PUp,PU2r,saverec)) then begin end;
  end else begin
    UpdatePOFromPURows(PUp,true,PU2r,false,true);
//Check PU rows PONr 
  end;
  return;
end;

updating procedure UpdatePurchase(var record PUVc PUp,record PUVc PU2p,Boolean negf)
begin  
  if (PUp.PONr!=-1) then begin
    if (UpdatePOFromPU(PUp,PU2p,negf)) then begin end;
  end else begin    
    if (negf) then begin
      UpdatePOFromPURows(PUp,false,PU2p,true,false);
    end else begin
      UpdatePOFromPURows(PUp,true,PU2p,true,true);
    end;
//Check PU rows PONr 
  end;
  return;
end;

global
updating function LongInt PUVcRecordSaveAfter(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  record UserVc Userr;
	longint curtick;
	
	curtick = getcurtick();

  Userr.Code = PUr.Sign;
  ReadFirstMain(Userr,1,true);
  PUr.SalesGroup = Userr.SalesGroup;  
  SavePurchase(PUr,false);
	logtext(0,"PUVcRecordSaveAfter SavePurchase " & getcurtick()-curtick); 
  if (PUr.OKFlag!=0) then begin
    PUMakeStockMovement(PUr,false);
		logtext(0,"PUVcRecordSaveAfter PUMakeStockMovement " & getcurtick()-curtick); 
    UpdateVarianceStatusPU(PUr);
		logtext(0,"PUVcRecordSaveAfter UpdateVarianceStatusPU " & getcurtick()-curtick); 
  end;
  PUVcRecordSaveAfter = res;
  return;
end;

global
updating function LongInt PUVcRecordUpdate(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  if ((PUr.OKFlag!=0) and (PU2r.OKFlag==0)) then begin
    if (ItemHistExists("PUVc",PUr.SerNr)==false) then begin
      PUr.LocOKNr = NextLocOKNr(PUr.Location);
    end;
  end;
  
  if ((PUr.OKFlag==0) and (PU2r.OKFlag!=0)) then begin		//Edit----------------------Dima  20.01.2016
    	UnOk_PUVc(PUr);
  end;   
  
LPUVcRecordUpdate:;  
  PUVcRecordUpdate = res;
  return;
end;

global
updating procedure UnOKGoodsReceipt(record PUVc PUr,record PUVc PU2r,Boolean deltrf)
begin
  LongInt oldpunr;
  
  PurUpdateStock(PUr,true);
  PurUpdateSerialNr(PUr,false,true);
  oldpunr = PUr.SerNr;
  PUr.SerNr = -1;
  UpdatePurchase(PUr,PU2r,true);
  PUr.SerNr = oldpunr;
  
//  PUMakeStockMovement(PUr,true);//JJRECALCSTOCK
//    UpdateVarianceStatusPU(PUr);//JJRECALCSTOCK
//    UpdateStockResFromPU(PUr,PU2r);//JJRECALCSTOCK
  
  UpdateRecalcStockNeeded(1);
  StoreUnOKHistory("PUVc",PUr.SerNr,CurrentDate,CurrentTime,CurrentUser);    
  if (deltrf) then begin
    DeleteTransaction(PUr.SerNr,PUYc);
  end;
  return;
end;

global
updating function LongInt PUVcRecordUpdateAfter(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res, i;
	row PUVc PUrw;
  Boolean ihf, shipdf, shipd0f;
  record VIVc VIr;
  record VIVc oldVIr;
  record POSettingBlock POSb;
  record RcVc RepSpec;
	record POVc POr;
	row POVc POrw;
  val bc1v, PartTotal;
	vector val PPUItemQty;
	record INVc INr;
	
	LOGTEXT(0,currentcompany & "PUVcRecordUpdateAfter");	
  ihf = ItemHistExists("PUVc",PUr.SerNr);
  if ((PUr.OKFlag!=0) and (PU2r.OKFlag!=0)) then begin
    // Comment-field has been changed 
    PurUpdateOvst(PUr,PU2r);
  end else begin
    if ((PU2r.OKFlag==0) and (PUr.OKFlag!=0)) then begin
      PurUpdateStock(PUr,false);
      PurUpdateSerialNr(PUr,false,false);//before ItemHist to get consigment stock right
      if (ihf==false) then begin
        PurUpdateCostPrice(PUr,false);
					LOGTEXT(0,currentcompany & "PUVcRecordUpdateAfter");	

        PurUpdateItemHist(PUr);
      end;
    end;
  end;
  if ((PUr.Invalid==0) and (PU2r.Invalid==0)) then begin
    if ((PUr.OKFlag==0) and (PU2r.OKFlag!=0)) then begin//unok
      //done below
    end else begin
      UpdatePurchase(PUr,PU2r,false);
    end;
  end;
  if ((PUr.OKFlag!=0) and (PU2r.OKFlag==0)) then begin
    if (ihf==false) then begin
      BlockLoad(POSb);
      PUMakeStockMovement(PUr,false);
      UpdateVarianceStatusPU(PUr);
      UpdateStockResFromPU(PUr,PU2r);
      if (POSb.CreateVIonPUOK!=0) and (POSb.OpenCreateVIFromPO==0) and (PUr.PONr>0) then begin
        RepSpec.FirstVer = PUr.PONr;
        RepSpec.flags[0] = 1;
        RepSpec.flags[1] = 1;
        RepSpec.flags[2] = 1;
        RepSpec.flags[3] = 1;
        RepSpec.flags[4] = 1;
        RepSpec.flags[5] = 1;
        RepSpec.flags[6] = 1;
        RepSpec.flags[7] = 1;
        if (CreateVIFromPO(RepSpec.FirstVer,RepSpec,VIr)==0) then begin
          RecordCopy(oldVIr,VIr);
          VIr.OKFlag = 1;
          RecordUpdate(oldVIr,VIr,true);
        end;
      end;
    end;
  end;
  if ((PU2r.Invalid==0) and (PUr.Invalid!=0)) then begin
    if (PU2r.OKFlag!=0) then begin
      UpdatePurchase(PUr,PU2r,false);//not stocked items suport only atm
//      InvalidateTR(PUYc,PUr.SerNr);
//      InvalidatePU(PUr);
    end;
  end;  
  if ((PUr.Invalid==0) and (PU2r.Invalid==0)) then begin
    if ((PUr.OKFlag==0) and (PU2r.OKFlag!=0)) then begin//unok
      UnOKGoodsReceipt(PUr,PU2r,true);
    end;
  end;
  if ((PUr.OKFlag!=0) and (PU2r.OKFlag!=0)) then begin//overstrike
    PUVc_UpdateTR(PUr,PU2r);
  end;
	if ((PUr.OKFlag==1) and (PU2r.OKFlag==0) and (CurrentCompany==18 or currentcompany==28)) then begin
		POr.SerNr = PUr.PONr;
		if(ReadFirstMain(POr,1,true))then begin
			shipdf = true;
			shipd0f = true;
			for (i=0;i<matrowcnt(POr);i=i+1) begin
				matrowget(POr,i,POrw);
				if(POrw.Shipd2 < POrw.Quant) then begin shipdf = false; end;
				if(POrw.Shipd2 > 0) then begin shipd0f = false; end; 
			end;		
			if (shipdf and !shipd0f) then begin
				POr.IDStatus = "PO Completed";
				RecordStore (POr,true);
			end;
			if (!shipdf and !shipd0f) then begin
				POr.IDStatus = "PO Goods Delivered Partial";
				
				for (i=0;i<matrowcnt(PUr);i=i+1) begin
					matrowget(PUr,i,PUrw);
					PPUItemQty[PUrw.ArtCode] = PUrw.Quant;
				end;
				
				for (i=0;i<matrowcnt(POr);i=i+1) begin
					matrowget(POr,i,POrw);
					if(PPUItemQty[POrw.ArtCode]>0) then begin
						PartTotal = PartTotal + (POrw.Sum / POrw.Quant * PPUItemQty[POrw.ArtCode]);
					end;
				end;		
				
				POr.PartDelSum4 = POr.PartDelSum4 + PartTotal;
				
				RecordStore (POr,true);
			end;
		end;
  end;  
  
  //Пересчет закупочных цен товаров в бутиках только после прихода товара от реального поставщика
	if(currentcompany==18)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 25 06 2020 y. at 8:45:04 AM
		if(left(PUr.VECode,3)!="FOB" and nonblank(PUr.VECode))then begin 
			if((PUr.OKFlag==1) and (PU2r.OKFlag==0))then begin 
				for (i=0;i<matrowcnt(PUr);i=i+1) begin
					matrowget(PUr,i,PUrw);
					INr.Code = PUrw.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						RecalculatePricesfromConsComp(INr);
					end;
				end;
			end;
		end;
	end;
  
  PUVcRecordUpdateAfter = res;
  return;
end;

global
updating function LongInt BigPUVcRecordUpdateAfter(var record BigPUVc BPUr,record BigPUVc BPU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  Boolean ihf;
	integer i;
  record VIVc VIr;
  record VIVc oldVIr;
  record POSettingBlock POSb;
  record RcVc RepSpec;
	array LongInt PUNr;
	boolean checkOK;
	string 255 warning;
	record PUVc PUr;
  val bc1v;
	if(BPUr.OKFlag!=0) then begin
		PUFromBigPUDsm(BPUr,PUNr);
		checkOK = true;
		for(i=0;i<PUNr.length;i=i+1) begin
			PUr.SerNr = PUNr[i];
			if(ReadFirstMain(PUr,1,true)) then begin
				if(PUr.OKFlag==0) then begin
					checkOK = false;
					if(Blank(warning)) then begin warning = PUNr[i]; end else begin
						warning = warning & PUNr[i]; 
					end;	
				end;
			end;
		end;
		if(!checkOK) then begin
			MessageBox(0,"Purchase number " & warning & " is incorrect please check it");
		end;	
	end;	
  BigPUVcRecordUpdateAfter = res;
  return;
end;

updating procedure RemovePU(record PUVc PUr)
begin
  Integer rwcnt,i;
  row PUVc PUrw;
  record POVc oldPOr;
  record POVc POr;
  row POVc POrw;
  Integer porwcnt;
  
  if (PUr.PONr!=-1) then begin
    POr.SerNr = PUr.PONr;
    if (ReadFirstMain(POr,1,true)) then begin
      RecordCopy(oldPOr,POr);
      porwcnt = MatRowCnt(POr);
      rwcnt = MatRowCnt(PUr);
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(PUr,i,PUrw);
        if ((PUrw.OrdRow>=0) and (PUrw.OrdRow<porwcnt) and (PUrw.ovst==0)) then begin
          MatRowGet(POr,PUrw.OrdRow,POrw);
          POrw.Shipd1 = POrw.Shipd1 - PUrw.Quant;
          if (POrw.Shipd1==0) then begin
            POrw.Shipd1 = blankval;
          end;
          MatRowPut(POr,PUrw.OrdRow,POrw);
        end;
      end;
      if (RecordUpdate(oldPOr,POr,false)==0) then begin //true calls recordcheck which is not needed
        POVcRecordUpdate(POr,oldPOr,Rs_update,0);
        POVcRecordUpdateAfter(POr,oldPOr,Rs_update,0);
      end;
    end;    
  end else begin
    RemovePU_PORows(PUr);
  end;
  return;
end;

global
updating function LongInt PUVcRecordRemoveAfter(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  RemovePU(PUr);
  PUVcRecordRemoveAfter = res;
  return;
end;

function Integer ValidateBulkSerialNoRow(record SerNrTrackBlock SNrb,record PUVc PUr,row PUVc PUrw,Integer currow,var string gotofield,var Integer gotorow)
begin
  Integer res;
  Integer j,rwcnt;
  row PUVc PU2rw;
  Boolean testf;
  string 255 serialnr;
  string 255 serialnr2;
  val qty,qty2;

  gotorow = -1;
  gotofield = "";  
  if (PUrw.Quant>1) then begin
    rwcnt = len(PUrw.SerialNr);
    for (j=0;j<rwcnt;j=j+1) begin
      if ((IsDigit(Mid(PUrw.SerialNr,j,1))==false) and (Mid(PUrw.SerialNr,j,1)!=":")) then begin
        res = 20434;
        gotorow = currow;
        gotofield = "SerialNr";
        goto LValidateBulkSerialNoRow;
      end;
    end;
  end;
  rwcnt = MatRowCnt(PUr);
  serialnr = FirstInRange(PUrw.SerialNr,60);
  while (nonblank(serialnr)) begin
    if (SerialNrAvail2(PUrw.ArtCode,serialnr,1.00)==true) then begin
      res = 1241;
      gotorow = currow;
      gotofield = "SerialNr";
      goto LValidateBulkSerialNoRow;
    end;

    for (j=0;j<currow;j=j+1) begin  
      MatRowGet(PUr,j,PU2rw);
      if (PU2rw.Quant!=0) then begin
        if (PUrw.ArtCode==PU2rw.ArtCode) then begin
          qty2 = blankval;
          serialnr2 = FirstInRange(PU2rw.SerialNr,60);
          while (nonblank(serialnr2)) begin
            if (serialnr==serialnr2) then begin
              res = 1241;
              gotorow = currow;
              gotofield = "SerialNr";
              goto LValidateBulkSerialNoRow;
            end;
            qty2 = qty2 + 1;
            serialnr2 = NextSerialNumber(PU2rw.ArtCode,serialnr2,SNrb);
            if (qty2>=PU2rw.Quant) then begin serialnr2 = ""; end;
          end;
        end;
      end;
    end;
    qty = qty + 1;
    serialnr = NextSerialNumber(PUrw.ArtCode,serialnr,SNrb);
    if (qty>=PUrw.Quant) then begin serialnr = ""; end;
  end;
LValidateBulkSerialNoRow:;  
  ValidateBulkSerialNoRow = res;
  return;
end;

global
 function boolean CheckValidateVI(record BigPUVc BPUr)
 begin
 record VIVc VIr;
 row VIVc VIrw;
 vector boolean vecVI;
 vector boolean vecVItest;
 array string 255 tags;
 integer i;
 boolean res; 
	res = true;
	if(nonblank(BPUr.CustomsCost) and BPUr.CustomsCost!=0) then begin vecVI["CustomsCost"] = true; vecVItest["CustomsCost"] = false; end;
	if(nonblank(BPUr.ShipCost) and BPUr.ShipCost!=0) then begin vecVI["ShipCost"] = true; vecVItest["ShipCost"] = false;  end;
	if(nonblank(BPUr.Cost1) and BPUr.Cost1!=0) then begin vecVI["Cost1"] = true; vecVItest["Cost1"] = false;  end;
	if(nonblank(BPUr.Cost2) and BPUr.Cost2!=0) then begin vecVI["Cost2"] = true; vecVItest["Cost2"] = false;  end;
	if(nonblank(BPUr.Cost3) and BPUr.Cost3!=0) then begin vecVI["Cost3"] = true; vecVItest["Cost3"] = false;  end;
	if(nonblank(BPUr.Cost4) and BPUr.Cost4!=0) then begin vecVI["Cost4"] = true; vecVItest["Cost4"] = false;  end;
	if(nonblank(BPUr.Cost5) and BPUr.Cost5!=0) then begin vecVI["Cost5"] = true; vecVItest["Cost5"] = false;  end;
	VIr.SerNr=-1;
	getvectortags(vecVItest,tags);
	while(LoopMain(VIr,1,true)) begin
		if(VIr.BigPUNr==BPUr.SerNr) then begin  
			for(i=0;i<matrowcnt(VIr);i=i+1) begin
				matrowget(VIr,i,VIrw);
				if(vecVI["CustomsCost"]) then begin 
					if(SetInSet("customs",VIr.ExtraCostObj)or VIr.ExtraCostObj=="customs") then begin
						vecVItest["CustomsCost"] = true;
					end;
				end;
				if(vecVI["ShipCost"]) then begin 
					if(SetInSet("freight",VIr.ExtraCostObj)or VIr.ExtraCostObj=="freight") then begin
						vecVItest["ShipCost"] = true;
					end;
				end;
				if(vecVI["Cost1"]) then begin 
					if(SetInSet("cost1",VIr.ExtraCostObj) or VIr.ExtraCostObj=="cost1") then begin
						vecVItest["Cost1"] = true;
					end;
				end;
				if(vecVI["Cost2"]) then begin 
					if(SetInSet("cost2",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost2") then begin
						vecVItest["Cost2"] = true; 
					end;
				end;
				if(vecVI["Cost3"]) then begin 
					if(SetInSet("cost3",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost3") then begin
						vecVItest["Cost3"] = true;
					end;
				end;
				if(vecVI["Cost4"]) then begin 
					if(SetInSet("cost4",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost4") then begin
						vecVItest["Cost4"] = true; 
					end;
				end;
				if(vecVI["Cost5"]) then begin 
					if(SetInSet("cost5",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost5") then begin
						vecVItest["Cost5"] = true;
					end;
				end;
			end;	
		end;
	end;	
	ResetLoop(VIr);
	for(i=0;i<tags.length;i=i+1) begin
		if(vecVItest[tags[i]]==false) then begin
			res = false;
		end;
	end;
	CheckValidateVI = res;
 return;
end;

global
updating function LongInt BigPUVcRecordCheck(var record BigPUVc BPUr,record BigPUVc BPU2r,LongInt stat,LongInt check)
begin
  LongInt res, resNIN;
  record POVc POr;
  row POVc POrw;
  record BigPUVc localBPUr;
  record INVc INr;
  record LocationVc LocRec;
  record CostAccBlock CAb;
  record MainStockBlock MSb;
  record SRBlock SRRec;
  row BigPUVc BPUrw;
  row BigPUVc BPU2rw;
  Integer rwcnt, rwcnt2, k, mtrw;
  Integer i,j;
  LongInt oldnr, long4, stat1;
  LongInt newnr;
  Boolean transf,gentrans,transvariancef;
  val t, total, FInBase;
  Integer errcode;
  LongInt sernr;
  record TRVc gTRp,oTRr;
  string 20 location,loc;
  val w,h,d,m;
  record INVc IN2r,IN3r;
  string 255 errstr,objstr,sBrand;
  record StockMovVc StockMovr;
  string 20 lastpalletitem;
  record PosVc Posr;
  val prev;
  Date bbd;
  record CUVc VEr;
  Boolean unokf;
  record AccVc Accr;
  string 255 gotofield, locationchk;
  Integer gotorow,cnt;
  transaction string 255 gRuniningMaint;
  record SerNrTrackBlock SNrb;
  Array string 255 otcheckaccs;
  Array string 255 otcheckobjtyps;
  Integer otcheckcnt;
  Boolean initotcheckf,testf, testf2, TrHs;  
	record NewINVc NINr, NINEmptr;
	row NewINVc	NINrw; 
	record DiCheckBlock DiCb;
	row DiCheckBlock DiCbw;
	vector string 255 diCheckTypes;
	string 255 type, outdisps, mes;	
	record BackOrderBlock BOb;
	vector integer vItQty;
	record ORVc ORr, OldORr;
	row ORVc ORrw;
	string 255 PUlocation;
	record GlobalItemVc GIr;
	boolean ecORcomlf;
	record ConsCompBlock CCB;
	record BPIBrandVc BBr;
	record PUVc PUr;
	longint curtick;
	string 255 order;
	integer pos, conscnt;
	boolean findOrd, constAllItemsf;
	vector boolean consigItemf;
	val ChCustCost;
	
	curtick = getcurtick();
	BlockLoad(CCB);
	
	if(CurrentUser=="SA3")then begin goto L99BPUVcRecordCheck; end;
	
	if(nonblank(BPUr.CustomsCost))then begin
		ChCustCost = 0;
		for (i=0;i<matrowcnt(BPUr);i=i+1) begin
			matrowget(BPUr,i,BPUrw);
			ChCustCost = ChCustCost + StringToVal(BPUrw.CustomsCost,M4Val) * BPUrw.Quant;
		end;
		ChCustCost = ChCustCost + 10;
		if(POr.CustomsCost>ChCustCost) then begin
			RecordCheckError(36326,"",-1,"CustomsCost");      
			res = -1;
			goto L99BPUVcRecordCheck;
		end;
	end;
	
	
	
	logtext(0,"BigPUVcRecordCheck"); 
	if(CurrentCompany!=18) then begin
		res = -1; 
		RecordCheckError(36290,"",-1,"SerNr");
		goto L99BPUVcRecordCheck;
	end;
	if(BPUr.OKFlag==0 and BPU2r.OKFlag!=0) then begin
		res = -1; 
		RecordCheckError(20884,"",-1,"SerNr");
		goto L99BPUVcRecordCheck;
	end;
	
	
	
	
	if (stat==Rs_insert) then begin 
		if(BPUr.OKFlag!=0 and BPUr.ExportFlag!=0) then begin
			res = -1; 
			BPUr.OKFlag = 0;
			RecordCheckError(36297,"",-1,"SerNr");
			goto L99BPUVcRecordCheck;
		end;
		if(BPUr.OKFlag!=0 and BPUr.ExportedFlag!=0) then begin
			res = -1; 
			BPUr.OKFlag = 0;
			RecordCheckError(36297,"",-1,"SerNr");
			goto L99BPUVcRecordCheck;
		end;
	end;
	

	
  res = 0;
  oldnr = BPUr.SerNr;
  transf = false;
  if (BPUr.OKFlag==1) then begin
    if (stat==Rs_insert) then begin transf = true; end;
    if (stat==Rs_update) then begin
      if (BPU2r.OKFlag==0) then begin 
				transf = true;
			end;
    end;
  end;
	if(BPUr.OKFlag!=0) then begin
		cnt = matrowcnt(BPUr);
		for(i=0;i<cnt;i=i+1) begin
			matrowget(BPUr,i,BPUrw);
			POr.SerNr = BPUrw.FromOrdNr;
			if(ReadfirstMain(POr,1,true)) then begin
				if(POr.PUFlag) then begin
					res = -1; 
					RecordCheckError(36280,BPUrw.FromOrdNr,i,"FromOrdNr");
					goto L99BPUVcRecordCheck;
				end;	
			end;
		end;
		if(!CheckValidateVI(BPUr)) then begin
			RecordCheckError(36289,"",-1,"SerNr");      
      res = -1;
      goto L99BPUVcRecordCheck;
		end;
	end;	
	
	BPUr.Cost2 = 0;
	for (i=0;i<matrowcnt(BPUr);i=i+1) begin
		matrowget(BPUr,i,BPUrw);
		INr.Code = BPUrw.ArtCode;
		if(ReadFirstMain(INr,1,true))then begin
			if(INr.ConsgType==1 and BPUrw.RowCost2>0)then begin
				BPUr.Cost2 = round(BPUr.Cost2 + (BPUrw.RowCost2 * BPUrw.Quant),DefaultRoundMode);
			end;
		end;
	end;
	
	order = "";
	pos = 0;
	ExtractObj(BPUr.FromOrds,pos,order);
	while(nonblank(order))begin
		findOrd = false;
		cnt = matrowcnt(BPUr);
		for(i=0;i<cnt;i=i+1) begin
			matrowget(BPUr,i,BPUrw);
			if(order==BPUrw.FromOrdNr) then begin
				i=cnt;
				findOrd = true;
			end;	
		end;
		if(!findOrd) then begin
			RecordCheckError(36296,order,-1,"FromOrds");      
      res = -1;
      goto L99BPUVcRecordCheck;
		end;
		ExtractObj(BPUr.FromOrds,pos,order);
	end;
	
	
	
   if (stat==Rs_update) then begin
    if (BPUr.SerNr<=0) and (BPU2r.OKFlag==0) then begin
      BPUr.SerNr = BPU2r.SerNr;
    end;
  end;    
	if(blank(BPUr.SerNr<=0)) then begin 
		BPUr.SerNr = NextSerNr("BigPUVc",CurrentDate,-1,false,""); 
	end;
  /*if (PUr.OKFlag==0) then begin
    if (stat==Rs_update) then begin
      if (PU2r.OKFlag==1) then begin unokf = true; end;
    end;
  end;
  if (unokf) then begin
    errcode = IsUnOKAllowed_PUVc(PUr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,"",-1,"TransDate");      
      res = -1; 
    end;
    goto L99PUVcRecordCheck;
  end; */ 
  if (stat==Rs_update) then begin
    if (BPU2r.OKFlag!=0) then begin
			res = -1;
      goto L99BPUVcRecordCheck;
    end;
  end;
	if(BPUr.OKFlag!=0) then begin
		If((Blank(BPUr.ShipCost) or BPUr.ShipCost==0) and BPUr.ExportFlag==0) then begin
			RecordCheckError(36294,"",-1,"ShipCost");      
      res = -1;
      goto L99BPUVcRecordCheck;
		end;
	end;
	
  BlockLoad(SRRec);
  BlockLoad(CAb);
  BlockLoad(MSb);
  BlockLoad(SNrb);

  if (BPUr.SerNr<=0) then begin
    newnr = GetCurUserLastNr("BigPUVc");
    if (newnr==-1) then begin
      newnr = SRRec.LastPurNr;
    end;
    BPUr.SerNr = NextSerNr("BigPUVc",BPUr.TransDate,newnr,false,"");
  end;
  
  /*if ((stat==Rs_insert) or (PUr.SerNr!=PU2r.SerNr)) then begin
    localPUr.SerNr = PUr.SerNr;
    if (ReadFirstMAin(localPUr,1,true)) then begin
      RecordCheckError(1547,"",-1,"SerNr");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
  end;
  if (SerNrTestPUVc(PUr.SerNr,PUr.TransDate,gentrans)==false) then begin
    if (check>0) then begin
    RecordCheckError(1557,"",-1,"SerNr");      
    res = -1;
    goto L99PUVcRecordCheck;
  end;
  end;
  if (check==0) then begin
    goto LPUVcRecordCheck_GenTrans;
  end;
  if (Date2Test("PUVc",PUr.TransDate,"TransDate",-1)==false) then begin
    res = -1;
    goto L99PUVcRecordCheck;
  end; 
  if (DisallowFutureDateCheck(true,PUr.TransDate,"TransDate",-1)) then begin
    res = -1;
    goto L99PUVcRecordCheck;
  end;
  if (transf) then begin
    if (UserCanAction("PUOK",true)==false) then begin
      RecordCheckError(1274,StringFromStringSet(3,"PUOK"),-1,"SerNr");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
  end;  
  rwcnt = MatRowCnt(BPUr);
  if (blank(BPUr.Location)) then begin
    if (MSb.requireLocation!=0) then begin
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(PUr,i,PUrw);
        if (blank(PUrw.Location)) then begin
          RecordCheckError(1058,PUr.Location,-1,"Location");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
  end;*/
  loc = BPUr.Location;
  if (blank(loc)) then begin
    loc = MSb.MainStock;
  end;  
  if (nonblank(loc)) then begin
    LocRec.Code = loc;
    if (ReadFirstMain(LocRec,1,true)==false) then begin
      RecordCheckError(1120,BPUr.Location,-1,"Location");      
      res = -1;
      goto L99BPUVcRecordCheck;
    end;
  end;
 /*if (nonblank(PUr.VECode)) then begin     
    VEr.Code = PUr.VECode;
    if (ReadFirstMain(VEr,1,true)==false) then begin
      RecordCheckError(1120,PUr.VECode,-1,"VECode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    /*if (VEr.blockedFlag!=0 or VEr.OnHoldFlag!=0) then begin
      RecordCheckError(1265,PUr.VECode,-1,"VECode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;*/
  //end;
  /*if (nonblank(PUr.Objects)) then begin     
    errcode = CheckObjs("",PUr.Objects,errstr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,errstr,-1,"Objects");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
  end;  
  errcode = CheckRates(PUr.CurncyCode,PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,errstr);
  if (errcode!=0) then begin
    RecordCheckError(errcode,"",-1,errstr);      
    res = -1; 
    goto L99PUVcRecordCheck;
  end;          
  if (transf) then begin
    if (PUr.OKFlag==1) then begin
      if (BA_GRNCostVarianceWarning(PUr,i)) then begin
        if (UserCanAction("DisallowCostVariance",false)) then begin
          RecordCheckError(1274,StringFromStringSet(3,"DisallowCostVariance"),i,"CostPrice");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
  end;*/
  /*if (HasLocalization("PRT")) then begin
    VEr.Code = PUr.VECode;
    if (ReadFirstMain(VEr,1,true)) then begin
      if (blank(VEr.VATNr)) then begin
        RecordCheckError(20275,"",-1,"VECode");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
  end;*/
	
	rwcnt = MatRowCnt(BPUr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(BPUr,i,BPUrw);
    testf = true;
    if (IsStandardProduct) then begin
      testf = HasIntegratedNL and transf;
    end;
		if(nonblank(locationchk) and locationchk!=BPUrw.Location and nonblank(BPUrw.ArtCode))then begin
			RecordCheckError(36292,BPUr.Location,i,"Location");      
			res = -1;
			goto L99BPUVcRecordCheck;
		end;
		POr.SerNr = BPUrw.FromOrdNr;
		if(ReadFirstMain(POr,1,true)) then begin
			for(j=0;j<matrowcnt(POr);j=j+1) begin
				if(j+1==BPUrw.FromOrdrowNr) then begin
					matrowget(POr,j,POrw);
					if(BPUrw.Quant>(POrw.Quant-POrw.Shipd1)) then begin
						RecordCheckError(36293,"",j,"Quant");      
						res = -1;
						goto L99BPUVcRecordCheck;
					end;
				end;	
			end;
		end;	
		locationchk = BPUrw.Location;
    /*if (testf) then begin
      if (nonblank(PUrw.CostAcc)) then begin
        Accr.AccNumber = PUrw.CostAcc;
        if (ReadFirstMain(Accr,1,true)==false) then begin
          RecordCheckError(1007,PUrw.CostAcc,i,"CostAcc");      
          res = -1; 
          goto L99PUVcRecordCheck;
        end else begin
          if ((Accr.blockedFlag!=0) or (Accr.GroupAcc!=0)) then begin
            RecordCheckError(1007,PUrw.CostAcc,i,"CostAcc");      
            res = -1; 
            goto L99PUVcRecordCheck;
          end;
        end;          
      end;
      if (nonblank(PUrw.CredAcc)) then begin
        Accr.AccNumber = PUrw.CredAcc;
        if (ReadFirstMain(Accr,1,true)==false) then begin
          RecordCheckError(1007,PUrw.CredAcc,i,"CredAcc");      
          res = -1; 
          goto L99PUVcRecordCheck;
        end else begin
          if ((Accr.blockedFlag!=0) or (Accr.GroupAcc!=0)) then begin
            RecordCheckError(1007,PUrw.CredAcc,i,"CredAcc");      
            res = -1; 
            goto L99PUVcRecordCheck;
          end;          
        end;
      end;        
    end;
    location = PUrw.Location;
    if (blank(PUrw.Location)) then begin
      location = loc;
    end;
    if (nonblank(location)) then begin
      LocRec.Code = location;
      if (ReadFirstMain(LocRec,1,true)==false) then begin
        RecordCheckError(1120,PUrw.Location,i,"Location");
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;*/
    /*if (StockRecordForLocationAllowed("PUVc",location,PUrw.ArtCode,PUr.TransDate,PUr.OKFlag,errcode,errstr)==false) then begin
      RecordCheckError(errcode,errstr,i,"ArtCode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;*/
    
    /*if (nonblank(PUrw.Location)) then begin
      location = PUrw.Location;
      if (MSb.Chronology==1) then begin//Chronology per Location
        if (PUrw.Location!=loc) then begin
          RecordCheckError(20857,"",i,"Location");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;*/
		if (BPUrw.stp==1) then begin
			if (IsOffice(false)) then begin
				if (BPUrw.Quant<0) then begin
					RecordCheckError(1574,"",i,"Quant");      
					res = -1;
					goto L99BPUVcRecordCheck;
				end;
			end;
    /*if (PUrw.PONr>0) then begin
      errcode = GetPO(PUrw.PONr,POr,PUr.VECode,false);
      switch (errcode) begin
        case 1: 
          RecordCheckError(1281,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 2: 
          RecordCheckError(1215,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 3: 
          RecordCheckError(1138,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 4: 
          RecordCheckError(1026,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 5: 
          RecordCheckError(1459,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 6:
          RecordCheckError(22062,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;        
      end;
      if (PUr.PONr>0) then begin
        if (PUrw.PONr!=PUr.PONr) then begin
          RecordCheckError(2010,"",-1,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
      if (PUrw.OrdRow<0) then begin
        RecordCheckError(1058,"",i,"OrdRow");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;            
    end;
    if (PUrw.PONr>0) then begin
      errcode = GetPO(PUrw.PONr,POr,PUr.VECode,false);
      if (POr.TransDate>PUr.TransDate) then begin
        RecordCheckError(20855,"",i,"PONr");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end else begin
      errcode = GetPO(PUr.PONr,POr,PUr.VECode,false);
      if (POr.TransDate>PUr.TransDate) then begin
        RecordCheckError(20855,"",-1,"PONr");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (PUr.PONr>0 or PUrw.PONr>0) then begin
      if (check!=0) then begin
        if (PUrw.OrdRow<MatRowCnt(POr)) and (PUrw.OrdRow>=0) then begin
          if (PUr.OKFlag!=0 and PU2r.OKFlag!=0) then begin
            MatRowGet(PU2r,i,PU2rw);
            if (PUrw.ArtCode==PU2rw.ArtCode and PUrw.Quant==PU2rw.Quant and PUrw.OrdRow==PU2rw.OrdRow) then begin
              goto Lskiprecvcheck;
            end;
          end;
          if (PUrw.ovst==0) and (PUr.Invalid==0) then begin
            MatRowGet(POr,PUrw.OrdRow,POrw);
            if (MSb.dontAllowOverreceive==1) then begin
              prev = blankval;
              for (j=0;j<rwcnt;j=j+1) begin
                if (j!=i) then begin
                  MatRowGet(PUr,j,PU2rw);
                  if (PU2rw.OrdRow==PUrw.OrdRow and PU2rw.PONr==PUrw.PONr) then begin
                    if (PU2rw.ovst==0) then begin
                      prev = prev + PU2rw.Quant;
                    end;
                  end;
                end;
              end;
              prev = prev + PUrw.Quant;
              if (((POrw.Quant - POrw.Shipd2)<prev) and (prev>0)) then begin
                RecordCheckError(20055,"",i,"Quant");      
                res = -1; 
                goto L99PUVcRecordCheck;
              end;
            end;
          end;
          Lskiprecvcheck:;
        end;
      end;  
    end;  */
    if (blank(BPUrw.ArtCode)) then begin
      RecordCheckError(1130,"",i,"ArtCode");      
      res = -1;
      goto L99BPUVcRecordCheck;
    end;
    if (ReadFirstItem(BPUrw.ArtCode,INr,true,true)==false) then begin
      RecordCheckError(1120," " & BPUrw.ArtCode,i,"ArtCode");      
      res = -1;
      goto L99BPUVcRecordCheck;
    end;
    /*if ((HasLocalization("EST")) or (HasLocalization("POL"))) then begin//vatEstonian,vatPolish
      if (INr.ItemType!=1) then begin
        RecordCheckError(1301,"",i,"ArtCode");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (CheckAllowedSize(INr,PUrw.UnitXval,PUrw.UnitYval,PUrw.UnitZval)==false) then begin
      RecordCheckError(1480,"",i,"UnitXval");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    if (check!=0) then begin
      VerifyRowObjects("PL",PUr.Objects,PUrw.Objects,PUrw.CredAcc,errcode,errstr,initotcheckf,otcheckaccs,otcheckobjtyps,otcheckcnt);                              
      if (errcode!=0) then begin
        RecordCheckError(errcode,errstr,i,"Objects");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (nonblank(PUrw.Objects)) then begin 
      errcode = CheckObjs("",PUrw.Objects,errstr);
      if (errcode!=0) then begin
        RecordCheckError(errcode,errstr,i,"Objects");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;*/
    if (blank(BPUrw.Quant)) then begin
      RecordCheckError(1058,"",i,"Quant");      
      res = -1;
      goto L99BPUVcRecordCheck;
    end;
    if (INr.ItemType==2) then begin
      RecordCheckError(1826,"",i,"ArtCode");      
      res = -1;
      goto L99BPUVcRecordCheck;
    end;
	if (CCB.OKFlag!=0 and BPUr.OKFlag!=0) then begin
		if (blank(BPUrw.Position)) then begin
			RecordCheckError(35156,BPUrw.Position,i,"Position");      
			res = -1;
			goto L99BPUVcRecordCheck;
		end else begin 
			IN3r.Code = BPUrw.ArtCode;
			if(ReadFirstMain(IN3r,1,true))then begin
				BBr.Code = IN3r.BPIBrand;
				if(ReadFirstMain(BBr,1,true)) then begin
					if(BBr.CWHCode!=BPUrw.Position) then begin
						RecordCheckError(36252,"",i,"Position");      
						res = -1;
						goto L99BPUVcRecordCheck;
					end;
				end else begin
					RecordCheckError(36253,"",i,"ArtCode");      
					res = -1;
					goto L99BPUVcRecordCheck;
				end;
			end;
		end;	
	end;
    if (LocRec.RequirePos!=0) then begin
/*occupied is not important, height is important    
      if (nonblank(PUrw.ToPosCode)) then begin
        res = IsPositionFree(PUrw.ToPosCode);
        if (res>0) then begin
          RecordCheckError(res," " & PUrw.ToPosCode,i,"ToPosCode");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end else begin
      	RecordCheckError(res," " & PUrw.ToPosCode,i,"ToPosCode");      
				res = -1;
				goto L99PUVcRecordCheck;
      end;
*/// Edit Start ---------------------------------------------- Edit Start
	//Friday, 17 August 2018 14:54:21
		if (blank(BPUrw.Position)) then begin
			RecordCheckError(35156,BPUrw.Position,i,"Position");      
			res = -1;
			goto L99BPUVcRecordCheck;
		end;

	// Edit End ---------------------------------------------- Edit End
	
      w = 0;
      h = 0;
      d = 0;
      m = BPUrw.Quant/INr.QtyonPallet;
      if (INr.PalletWidth!=0) then begin w = w + INr.PalletWidth*m; end;
      if (INr.PalletHeight!=0) then begin h = h + INr.PalletHeight*m; end;
      if (INr.PalletDepth!=0) then begin d = d + INr.PalletDepth*m; end;
      for (j=0;j<i;j=j+1) begin
        MatRowGet(BPUr,j,BPU2rw);
        if (BPUrw.Position==BPU2rw.Position) then begin
          if (ReadFirstItem(BPU2rw.ArtCode,IN2r,true,true)) then begin
            m = 0;
            if (IN2r.QtyonPallet>0) then begin
              m = BPU2rw.Quant/IN2r.QtyonPallet;
            end;                
            if (IN2r.PalletWidth!=0) then begin
              w = w + IN2r.PalletWidth*m;
            end;
            if (IN2r.PalletHeight!=0) then begin
              h = h + IN2r.PalletHeight*m;
            end;
            if (IN2r.PalletDepth!=0) then begin
              d = d + IN2r.PalletDepth*m;
            end;
          end;
        end;
/*only height matters
        if (PUrw.ArtCode!=lastpalletitem) then begin
          if (nonblank(PUrw.ToPosCode)) then begin
            if (PUrw.ToPosCode==PU2rw.ToPosCode) then begin
              RecordCheckError(1729,PUrw.ToPosCode,i,"ToPosCode");      
              res = -1;
              goto L99PUVcRecordCheck;
            end;
          end;
        end;
*/        
      end;    
      lastpalletitem = INr.DefPalletItem;
      
      
      
      /*if (nonblank(BPUrw.Position)) then begin
        errcode = CheckPosition(BPUrw.Position,location,LocRec.RequirePos,w,h,d);
        if (errcode!=0) then begin
          RecordCheckError(errcode,BPUrw.Position,i,"Position");      
          res = -1;
          goto L99BPUVcRecordCheck;
        end;
      end;*/
      if (nonblank(BPUrw.Position)) then begin
        w = 0;
        h = 0;
        d = 0;
        m = BPUrw.Quant/INr.QtyonPallet;
        if (INr.PalletWidth!=0) then begin w = w + INr.PalletWidth*m; end;
        if (INr.PalletHeight!=0) then begin h = h + INr.PalletHeight*m; end;
        if (INr.PalletDepth!=0) then begin d = d + INr.PalletDepth*m; end;
        /*for (j=0;j<i;j=j+1) begin
          MatRowGet(BPUr,j,BPU2rw);
          if (PUrw.ToPosCode==PU2rw.ToPosCode) then begin
            if (ReadFirstItem(PU2rw.ArtCode,IN2r,true,true)) then begin
              m = 0;
              if (IN2r.QtyonPallet>0) then begin
                m = PU2rw.Quant/IN2r.QtyonPallet;
              end;                
              if (IN2r.PalletWidth!=0) then begin
                w = w + IN2r.PalletWidth*m;
              end;
              if (IN2r.PalletHeight!=0) then begin
                h = h + IN2r.PalletHeight*m;
              end;
              if (IN2r.PalletDepth!=0) then begin
                d = d + IN2r.PalletDepth*m;
              end;
            end;
          end;
        end;    
        errcode = CheckPosition(BPUrw.Position,location,LocRec.RequirePos,w,h,d);
        if (errcode!=0) then begin
          RecordCheckError(errcode,BPUrw.Position,i,"Position");      
          res = -1;
          goto L99BPUVcRecordCheck;
        end;*/
      end;
    end else begin
      if (nonblank(BPUrw.Position)) then begin
        Posr.Code = BPUrw.Position;
        Posr.Location = BPUrw.Location;
        if (ReadFirstKey("Location",Posr,2,true)==false) then begin
          RecordCheckError(1120,BPUrw.Position,i,"Position");      
          res = -1;
          goto L99BPUVcRecordCheck;
        end;
      end;
    end;
    /*if (LocRec.RequirePos!=0) then begin
      if (blank(PUrw.ToPosCode)) then begin
        RecordCheckError(1854,"",i,"ToPosCode");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
      if (StockMovr.SerNr<=0) then begin
        StockMovr.SerNr = NextSerNr("StockMovVc",CurrentDate,-1,false,"");
        if (StockMovr.SerNr<=0) then begin 
          RecordCheckError(2291,"",-1,"SerNr");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;*/
/*    
    if (nonblank(LocRec.Code)) then begin
      if (nonblank(MainWHM.Location)) then begin
        if (LocRec.RequirePos!=0) then begin
          if (blank(PUrw.ToPosCode)) then begin
            RecordCheckError(1854,"",i,"PosCode");      
            res = -1;
            goto L99PUVcRecordCheck;
          end;

//*          if (PUrw.ToPosCode!=MainWHM.DefPUPosCode) then begin
//*            res = IsPositionFree(PUrw.ToPosCode);
//*            if (res>0) then begin
//*              RecordCheckError(res," " & PUrw.ToPosCode,i,"ToPosCode");      
//*              res = -1;
//*              goto L99PUVcRecordCheck;
//*            end;
//*          end;
        end;
      end else begin
        if (LocRec.RequirePos!=0) then begin
          if (blank(PUrw.ToPosCode)) then begin
            RecordCheckError(1854,"",i,"ToPosCode");      
            res = -1;
            goto L99PUVcRecordCheck;
          end;
        end;
      end;
    end;
*/    
    if (transf) then begin
		
		
		/*
			BlockLoad(DiCb);
			mtrw = MatRowCnt(DiCb);
			if (mtrw>0) then begin
				for (k=0;k<mtrw;k=k+1) begin
					MatRowGet(DiCb,k,DiCbw);
					if (NonBlank(DiCbw.DiCode) and NonBlank(DiCbw.DiType)) then begin
						diCheckTypes[DiCbw.DiCode] = DiCbw.DiType;
					end;
				end;
			end; 
			NINr.SerNr = -1;
			testf2 = true;
			TrHs = true;
			while (LoopMain(NINr,1,TrHs))begin
				rwcnt2 = MatRowCnt(NINr);
				for (k=0;k<rwcnt2;k=k+1) begin
					MatRowGet(NINr,k,NINrw);
					if(PUrw.ArtCode==NINrw.Code)then begin
						testf2 = true;
						if (!DIsWithTypeExistsOrCreateSpecific(NINrw.Type,outdisps,ReturnFieldDIType("Type",false),mes)) then begin
							RecordCheckError(35150,"",i,"ArtCode");      
							res = -1;
							goto L99PUVcRecordCheck;
						end else begin
							NINrw.Type = outdisps;
						end;
						type = NINrw.Type;
						if(blank(NINrw.Brand) and SetInSet(ReturnFieldDIType("Brand",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Collection) and SetInSet(ReturnFieldDIType("Collection",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.WatchType) and SetInSet(ReturnFieldDIType("WatchType",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.GenderSC) and SetInSet(ReturnFieldDIType("GenderSC",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Dial) and SetInSet(ReturnFieldDIType("Dial",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Strap) and SetInSet(ReturnFieldDIType("Strap",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Material) and SetInSet(ReturnFieldDIType("Material",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.PrecStones) and SetInSet(ReturnFieldDIType("PrecStones",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.SerNrf) and SetInSet(ReturnFieldDIType("SerNrf",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Mechanism) and SetInSet(ReturnFieldDIType("Mechanism",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Function) and SetInSet(ReturnFieldDIType("Function",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.WaterResist) and SetInSet(ReturnFieldDIType("WaterResist",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Diameter) and SetInSet(ReturnFieldDIType("Diameter",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Category) and SetInSet(ReturnFieldDIType("Category",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Division) and SetInSet(ReturnFieldDIType("Division",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.WeightOfMat) and SetInSet(ReturnFieldDIType("WeightOfMat",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Diamonds) and SetInSet(ReturnFieldDIType("Diamonds",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.DiamondsCarat) and SetInSet(ReturnFieldDIType("DiamondsCarat",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.SolidStones05) and SetInSet(ReturnFieldDIType("SolidStones05",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.PrecAndSemiPrec) and SetInSet(ReturnFieldDIType("PrecAndSemiPrec",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.RingSizes) and SetInSet(ReturnFieldDIType("RingSizes",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Carat) and SetInSet(ReturnFieldDIType("Carat",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.ClaritySC) and SetInSet(ReturnFieldDIType("ClaritySC",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.ColorOfMat) and SetInSet(ReturnFieldDIType("ColorOfMat",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.ShapeCut) and SetInSet(ReturnFieldDIType("ShapeCut",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Description) and SetInSet(ReturnFieldDIType("Description",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Art) and SetInSet(ReturnFieldDIType("Art",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif30) and SetInSet(ReturnFieldDIType("classif30",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif31) and SetInSet(ReturnFieldDIType("classif31",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif32) and SetInSet(ReturnFieldDIType("classif32",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif33) and SetInSet(ReturnFieldDIType("classif33",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif34) and SetInSet(ReturnFieldDIType("classif34",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.BrandSC) and SetInSet(ReturnFieldDIType("BrandSC",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(testf2==true)then begin k = rwcnt2; TrHs = false; end else begin logtext(0,NINr.SerNr & " <> " & PUrw.ArtCode); end;
					end;								
				end;
			end;
			ResetLoop(NINr);
			if(testf2==false)then begin
				RecordCheckError(35150,"",i,"ArtCode");      
				res = -1;
				logtext(0," 1");
				goto L99PUVcRecordCheck;
			end;*/
      /*if (((INr.SerNrf>0) and (INr.SerNrf<3)) and (MSb.NoSerOnPU==0)) then begin
        if (PUrw.Quant!=0) then begin
          if (blank(PUrw.SerialNr)) then begin
            RecordCheckError(1239,"",i,"SerialNr");      
            res = -1;
            goto L99PUVcRecordCheck;
          end;
        end;
				
        if (Mid(PUrw.SerialNr,len(PUrw.SerialNr),1)==" ") then begin
          RecordCheckError(1239,"",i,"SerialNr");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
        if (SNrb.BulkSerialNos==0) then begin
          if (IsSerialNrCorrect(PUrw.SerialNr)==false) then begin
            RecordCheckError(24154,PUrw.SerialNr,i,"SerialNr");      
            res = -1; 
            goto L99PUVcRecordCheck;
          end;        
        end;        
        switch (INr.SerNrf) begin
          case 1:  // serial nr. 
            // is the serial number available at any location 
            if (SNrb.BulkSerialNos!=0) then begin
              errcode = ValidateBulkSerialNoRow(SNrb,PUr,PUrw,i,gotofield,gotorow);
              if (errcode) then begin
                RecordCheckError(errcode,"",gotorow,gotofield);      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
            end else begin
              for (j=0;j<i;j=j+1) begin              
                MatRowGet(PUr,j,PU2rw);
                if (PUrw.Quant!=0) then begin
                  if ((PUrw.ArtCode==PU2rw.ArtCode) and
                      (PUrw.SerialNr==PU2rw.SerialNr)) then begin
                    RecordCheckError(1241,"",i,"SerialNr");      
                    res = -1;
                    goto L99PUVcRecordCheck;
                  end;
                end;
              end;
              if (PUrw.Quant!=0) then begin
                if (SerialNrAvail2(PUrw.ArtCode,PUrw.SerialNr,PUrw.Quant) and currentcompany!=29) then begin
                  RecordCheckError(1243,"",i,"SerialNr");      
                  res = -1;
                  goto L99PUVcRecordCheck;
                end;
              end;
              if (PUrw.Quant!=1 and PUrw.Quant!=0) then begin
                RecordCheckError(1242,"",i,"Quant");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
              if (SerialNrOnThisPU(PUr,PUrw.ArtCode,PUrw.SerialNr)>1) then begin
                RecordCheckError(1242,"",i,"Quant");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
/*              
              if (SerialNrEverinStock(PUrw.ArtCode,PUrw.SerialNr)) then begin
                RecordCheckError(1243,"",i,"SerialNr");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
              
            end;
          case 2:  ;// batch nr. 
            for (j=0;j<i;j=j+1) begin              
              MatRowGet(PUr,j,PU2rw);
              if ((PUrw.ArtCode==PU2rw.ArtCode) and
                  (PUrw.SerialNr==PU2rw.SerialNr)) then begin
                  if (PUrw.CostPrice!=PU2rw.CostPrice) then begin
                    RecordCheckError(20568,"",i,"SerialNr");      
                    res = -1;
                    goto L99PUVcRecordCheck;
                  end;
                  if (nonblank(PUrw.BestBefore)) or (nonblank(PU2rw.BestBefore)) then begin
                    if (PUrw.BestBefore!=PU2rw.BestBefore) then begin
                      RecordCheckError(20765,"",i,"SerialNr");      
                      res = -1;
                      goto L99PUVcRecordCheck;
                    end;
                  end;
              end;
            end;
            if (FIFOPerSerialNr(INr,CAb)!=0 and currentcompany!=29) then begin//otherwise cost price on deliveries is completely wrong
              if (SerialNrAvail2(PUrw.ArtCode,PUrw.SerialNr,1)) then begin
                RecordCheckError(1243,"",i,"SerialNr");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;              
            end;
            FindBatchBestBeforeDate(PUrw.ArtCode,PUrw.SerialNr,bbd);
            if (nonblankdate(bbd)) then begin
              if (PUrw.BestBefore!=bbd)then begin
                RecordCheckError(20765,"",i,"SerialNr");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
            end;
        end;
      end;*/
    end;
  end;
end;
  /*if (DateWarned(PUr.TransDate,"PUVc")) then begin
    MessageBox(1045,"");
  end; */ 

	TrHs = true;
	while (LoopMain(NINr,1,TrHs)) begin
		if(nonblank(NINr.Brand))then begin sBrand = NINr.Brand; TrHs = false; end;
	end;
	/*if(PUr.ItemClassifCheck==0)then begin
		recordnew(NINEmptr);
		NINEmptr.SerNr = -1;
		
		ResetLoop(NINr);
		recordnew(NINr);
		NINr.SerNr = -1;
		NINr.Brand = sBrand;
		NINr.OKFlag = 1;
		for (i=0;i<rwcnt;i=i+1)begin
			matrowget(PUr,i,PUrw);
			NINrw.Code = PUrw.ArtCode;
			MatRowPut(NINr,i,NINrw);
			HandleNewINDClassmCode(NINr,i);
			MatRowPut(NINr,i,NINrw);
		end;
	end;*/

  
  if (transf) then begin
		BlockLoad(BOb);
		/*if(PUr.ItemClassifCheck==0 and BOb.BackOrderMark==1)then begin
			stat1 = 1;
			long4 = -1;
			resNIN = NewINVcRecordCheck(NINr,NINEmptr,stat1,long4);
			if(resNIN==-1)then begin
				MessageBox(0,"Неполная классификация товаров!");
				res = -1;
				goto L99PUVcRecordCheck;
			end;
		end;
    if (stat==Rs_update) then begin
      sernr = BPU2r.SerNr;
    end;
    if (check>0) then begin
      if (MSb.Chronology!=0) then begin
        if (ExistStockTrans(location,BPUr.TransDate,errcode,errstr,"PUVc",sernr,MSb)==true) then begin
          RecordCheckError(errcode,errstr,-1,"TransDate");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
    if (CanOKStockRecord(errcode)==false) then begin
      RecordCheckError(errcode,"",-1,"SerNr");      
      res = -1; 
      goto L99BPUVcRecordCheck;
    end;
		done in other place    
    if (IsStockSettingsOK==false) then begin
      RecordCheckError(1767,"",-1,"SerNr");      
      res = -1; 
      goto L99PUVcRecordCheck;
    end;
*/    
  end;
 // if (transf) then begin
  /*  FillAmForVariancePU(PUr);
  end;
LPUVcRecordCheck_GenTrans:;
  if (gentrans==false) then begin transf = false; end;
  if (IsStandardProduct) then begin
    transf = HasIntegratedNL and transf;
  end;
  if (transf) then begin
    errcode = MakeTransFromPU(gTRp,PUr,LocRec,false);
    if (errcode>0) then begin
      RecordCheckError(errcode,"",-1,"SerNr");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    if ((gTRp.Number>0) and (gTRp.IntYc==PUYc)) then begin
      errstr = CheckTrans(gTRp,2,true);
      if (nonblank(errstr)) then begin
        RecordCheckError(1085,errstr,-1,"SerNr");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
      switch (gRuniningMaint) begin    
        case "RecalcStockMn":
          UpdateTrans_Stock(gTRp);          
        otherwise
          SaveTrans(gTRp);
          AddTTrans_PUVc(gTRp,PUr);
      end;
    end;    
  end;  
	if(CurrentCompany==29)then begin
		if(PUr.OKFlag==1 and PU2r.OKFlag==0)then begin
			mtrw = matrowcnt(PUr);
			ORr.SerNr = "";
			for(i=0;i<mtrw;i=i+1)begin
				matrowget(PUr,i,PUrw);
				vItQty[PUrw.ArtCode] = PUrw.Quant;
				if(left(PUrw.SerialNr,5)=="EXTPR")then begin
					ORr.SerNr = right(PUrw.SerialNr,len(PUrw.SerialNr)-5);
					PUlocation = PUr.Location;
				end;
			end;
			ecORcomlf = true;
			ORr.SerNr = mid(PUrw.SerialNr,3,len(PUrw.SerialNr)-12);
			PUlocation = PUr.Comment;
			mtrw = matrowcnt(PUr);
			for(i=0;i<mtrw;i=i+1)begin
				matrowget(PUr,i,PUrw);
				vItQty[PUrw.ArtCode] = PUrw.Quant;
				if(left(PUrw.SerialNr,5)=="EXTPR")then begin
					ORr.SerNr = right(PUrw.SerialNr,len(PUrw.SerialNr)-5);
					PUlocation = PUr.Location;
				end;
			end;
			if(ReadFirstMain(ORr,1,true))then begin
				RecordCopy(OldORr,ORr);
				mtrw = matrowcnt(ORr);
				for(i=0;i<mtrw;i=i+1)begin
					matrowget(ORr,i,ORrw);
					if(SetInSet(ORrw.ECReservStock,PUlocation))then begin
						if(vItQty[ORrw.ArtCode]<ORrw.Quant)then begin
							Logtext(0,PUlocation & "<>" & vItQty[ORrw.ArtCode]);
							ORrw.ECReceived = ORrw.ECReceived + vItQty[ORrw.ArtCode];
							MatRowPut(ORr,i,ORrw);
						end else begin
							Logtext(0,PUlocation & "<>" & vItQty[ORrw.ArtCode]);
							ORrw.ECReceived = ORrw.Quant;
							vItQty[ORrw.ArtCode] = vItQty[ORrw.ArtCode] - ORrw.Quant;
							MatRowPut(ORr,i,ORrw);
						end;
					end;
					if(ORrw.ECReceived!=ORrw.Quant)then begin
						ecORcomlf = false;
					end;
				end;
				if(ORr.ECORCompl!=1)then begin
					if(ecORcomlf)then begin
						ORr.ECORCompl = 1;
					end else begin
						ORr.ECORCompl = 0;
					end;
				end;
				if(RecordUpdate(OldORr,ORr,true)==0)then begin end;
			end;
		end;
	end;*/
	/*if(BPUr.OKFlag!=0) then begin
		rwcnt = MatRowCnt(BPUr);
		BPUr.CustomsCost = 0;
		for (i=0;i<rwcnt;i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			if(BPUr.ConsManualCost==1) then begin
				MatRowGet(BPUr,i,BPUrw);
				INr.Code = BPUrw.ArtCode;
				if(ReadFirstMain(INr,1,true)) then begin
					if(INr.ConsgType==1) then begin
						BPUrw.CustomsCost = BPUrw.CustomsCost + BPUrw.CostPrice * 0.15;						
					end;	
				end;
				MatRowPut(BPUr,i,BPUrw);
			end;
			BPUr.CustomsCost = BPUr.CustomsCost + BPUrw.CustomsCost;
		end;
	end;	*/
	constAllItemsf = true;
	for (i=0;i<matrowcnt(BPUr);i=i+1) begin
		matrowget(BPUr,i,BPUrw)
		INr.Code = BPUrw.ArtCode;
		if(ReadFirstMain(INr,1,true)) then begin
			if(INr.ConsgType!=1)then begin
				constAllItemsf = false;
			end;
		end;
	end;
	if((Blank(BPUr.CustomsCost) or BPUr.CustomsCost==0) and BPUr.ExportedFlag==0 and BPUr.OKFlag!=0 and !constAllItemsf) then begin
			RecordCheckError(36295,"",-1,"CustomsCost");      
      res = -1;
      goto L99BPUVcRecordCheck;
	end;
L99BPUVcRecordCheck:;
  if (res!=0) then begin  end;
	LogProcTime("BigPUVcRecordCheck",getcurtick()-curtick); 
  BigPUVcRecordCheck = res;
  return;
end;

global
updating function LongInt PUVcRecordCheck(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt check)
begin
  LongInt res, resNIN;
  record POVc POr;
  row POVc POrw;
  record PUVc localPUr, correctedPUr;
  record INVc INr;
  record LocationVc LocRec;
  record CostAccBlock CAb;
  record MainStockBlock MSb;
  record SRBlock SRRec;
  row PUVc PUrw, correctedPUrw;
  row PUVc PU2rw;
  Integer rwcnt, rwcnt2, k, mtrw;
  Integer i,j;
  LongInt oldnr, long4, stat1;
  LongInt newnr;
  Boolean transf,gentrans,transvariancef;
  val t;
  Integer errcode;
  LongInt sernr;
  record TRVc gTRp,oTRr;
  string 20 location,loc;
  val w,h,d,m;
  record INVc IN2r;
  string 255 errstr,objstr,sBrand;
  record StockMovVc StockMovr;
  string 20 lastpalletitem;
  record PosVc Posr;
  val prev;
  Date bbd;
  record CUVc VEr;
  Boolean unokf;
  record AccVc Accr;
  string 255 gotofield, sToPosCode, LocCode;
  Integer gotorow;
  transaction string 255 gRuniningMaint;
  record SerNrTrackBlock SNrb;
  Array string 255 otcheckaccs;
  Array string 255 otcheckobjtyps;
  Integer otcheckcnt, notenr;
  Boolean initotcheckf,testf, testf2, TrHs, consPOf;  
	record NewINVc NINr, NINEmptr;
	row NewINVc	NINrw; 
	record DiCheckBlock DiCb;
	row DiCheckBlock DiCbw;
	vector string 255 diCheckTypes;
	string 255 type, outdisps, mes;	
	record BackOrderBlock BOb;
	vector integer vItQty;
	record ORVc ORr, OldORr;
	row ORVc ORrw;
	string 255 PUlocation;
	record GlobalItemVc GIr;
	boolean ecORcomlf;
	record ConsCompBlock CCB;
	record CUVc CUr;
	longint curtick;
	record AccBlock AccB;
	vector boolean vecVI;
	vector boolean vecVItest, correctedItms;
	array string 255 tags;
	record VIVc VIr;
	row VIVc VIrw;
	Integer wn,nwn,err,cntIV,cntORIV;
  Boolean TsTr,testf1,testVI,custcostchf,correctPUf;
	val ChCustCost;
	record RLinkVc RLr;
	vector boolean CorrPrice, CorrSum;
	array string 20 objstores,objstoressubdi;// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 07 05 2020 y. at 1:55:19 PM
	integer oscnt,oscntsubdi;// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 07 05 2020 y. at 1:55:31 PM
	array string 20 addobj;// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 07 05 2020 y. at 1:56:14 PM
	array string 20 addobjsubdi;// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 07 05 2020 y. at 1:56:16 PM
	record ItemDuplicatesVc IDr;  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:42 17.08.2020
	
	BlockLoad(AccB);
	BlockLoad(CCB);
	
	curtick = getcurtick();
	
	logtext(0,"PUVcRecordCheck"); 
	
  res = 0;
	if(CurrentUser=="SA3")then begin goto L99PUVcRecordCheck; end;
	
	
	if(PUr.SHandCUSTCostOKCondf==1)then begin
		PUr.CustomsCostOKFlag = 1;
		PUr.ShipCostOKFlag = 1;
	end;
	
	if(nonblank(PUr.CustomsCost))then begin
		ChCustCost = 0;
		custcostchf = true;
		for (i=0;i<matrowcnt(PUr);i=i+1) begin
			matrowget(PUr,i,PUrw);
			ChCustCost = ChCustCost + StringToVal(PUrw.CustomsCost,M4Val) * PUrw.Quant;
			if(POrw.Price==0)then begin custcostchf = false; end;
		end;
		ChCustCost = ChCustCost + 10;
		if(POr.CustomsCost>ChCustCost and custcostchf) then begin
			RecordCheckError(36326,"",-1,"CustomsCost");      
			res = -1;
			goto L99PUVcRecordCheck;
		end;
	end;
	
	for (i=0;i<matrowcnt(PUr);i=i+1) begin
		matrowget(PUr,i,PUrw);
		if (nonblank(PUrw.ArtCode)) then begin
			INr.Code = PUrw.ArtCode;
			if (ReadFIrstMain(INr,1,true)) then begin
				IDr.DupCode = PUrw.ArtCode;
				TrHs = true;
				while (loopkey("DupCode",IDr,1,TrHs)) begin
					testf = true;
					if (IDr.DupCode!=PUrw.ArtCode) then begin TrHs = false; testf = false; end;
					if (IDr.DupBrandCode!=INr.BPIBrand) then begin  testf = false; end;
					if (testf) then begin
						RecordCheckError(36369,"",i,"ArtCode");      
						res = -1;
						goto L99PUVcRecordCheck;
					end;
				end;
				ResetLoop(IDr);
			end;
		end;
	end;

  oldnr = PUr.SerNr;
  transf = false;
  if (PUr.OKFlag==1) then begin
    if (stat==Rs_insert) then begin transf = true; end;
    if (stat==Rs_update) then begin
      if (PU2r.OKFlag==0) then begin transf = true; end;
    end;
  end;
   if (stat==Rs_update) then begin
    if (PUr.SerNr<=0) and (PU2r.OKFlag==0) then begin
      PUr.SerNr = PU2r.SerNr;
    end;
  end;    
	
	if(currentcompany==28)then begin
		for (i=0;i<matrowcnt(PUr);i=i+1)begin
			matrowget(PUr,i,PUrw);
			
			sToPosCode = "";
			LocCode = "";
			TrHs = false;
			if(nonblank(PUrw.Location))then begin
				TrHs = true;
				LocCode = PUrw.Location;
			end else begin
				if(nonblank(PUr.Location))then begin
					TrHs = true;
					LocCode = PUr.Location;
				end;
			end;
			j = 0;
			Posr.Location = LocCode;
			while (LoopKey("Location",Posr,1,TrHs)) begin
				if(Posr.Location != LocCode)then begin TrHs = false; end;
				if(TrHs)then begin
					sToPosCode = Posr.Code;
					j = j + 1;
				end;
			end;
			ResetLoop(Posr);
			if(j==1)then begin
				PUrw.ToPosCode = sToPosCode;
				matrowput(PUr,i,PUrw);
			end;
		end;
	end;
	
	
	

  if (PUr.OKFlag==0) then begin
    if (stat==Rs_update) then begin
      if (PU2r.OKFlag==1) then begin unokf = true; end;
    end;
  end;
	if (PUr.OKFlag==1 and PU2r.OKFlag==0) then begin
		testf1 = true;
		
		POr.SerNr = PUr.PONr;
		if(ReadFirstMAin(POr,1,true))then begin end;
		
		for (i=0;i<matrowcnt(POr);i=i+1) begin
			matrowget(POr,i,POrw);
			correctedItms[POrw.ArtCode] = true;
		end;
		
		
		notenr = 1;
		while (ReadRecordLink(POr,notenr,correctedPUr,RLr)) begin
			if(correctedPUr.SerNr!=PUr.SerNr)then begin
				for (i=0;i<matrowcnt(correctedPUr);i=i+1) begin
					matrowget(correctedPUr,i,correctedPUrw);
					if(!correctedItms[correctedPUrw.ArtCode])then begin
						CorrPrice[correctedPUrw.UPrice] = true;
						CorrSum[correctedPUrw.Sum] = true;
						correctPUf = true;
					end;
				end;
			end;
			notenr = notenr + 1;
		end;
				
		for (i=0;i<matrowcnt(PUr);i=i+1) begin
			matrowget(PUr,i,PUrw);
			if(correctedItms[PUrw.ArtCode] and !CorrPrice[PUrw.UPrice] and !CorrSum[PUrw.Sum]) then begin
				correctPUf = false;
			end;
		end;
			
		
		
		if(CCB.OKFlagPOr!=0) then begin
			testVI = true;
			i = 0;
			if(nonblank(PUr.CustomsCost) and PUr.CustomsCost!=0) then begin vecVI["CustomsCost"] = true; vecVItest["CustomsCost"] = false; end;
			if(nonblank(PUr.ShipCost) and PUr.ShipCost!=0) then begin vecVI["ShipCost"] = true; vecVItest["ShipCost"] = false;  end;
			if(nonblank(PUr.Cost1) and PUr.Cost1!=0) then begin vecVI["Cost1"] = true; vecVItest["Cost1"] = false;  end;
			if(nonblank(PUr.Cost2) and PUr.Cost2!=0) then begin vecVI["Cost2"] = true; vecVItest["Cost2"] = false;  end;
			if(nonblank(PUr.Cost3) and PUr.Cost3!=0) then begin vecVI["Cost3"] = true; vecVItest["Cost3"] = false;  end;
			if(nonblank(PUr.Cost4) and PUr.Cost4!=0) then begin vecVI["Cost4"] = true; vecVItest["Cost4"] = false;  end;
			if(nonblank(PUr.Cost5) and PUr.Cost5!=0) then begin vecVI["Cost5"] = true; vecVItest["Cost5"] = false;  end;
			VIr.POSerNr = PUr.PONr;
			TsTr = true;
			getvectortags(vecVItest,tags);
			while(LoopKey("POSerNr",VIr,1,TsTr)) begin
				if(VIr.POSerNr!=PUr.PONr) then begin TsTr = false; end;
				if(TsTr and VIr.PartPUSerNr==PUr.SerNr) then begin
					if(vecVI["CustomsCost"]) then begin 
						if(SetInSet("customs",VIr.ExtraCostObj)or VIr.ExtraCostObj=="customs") then begin
							vecVItest["CustomsCost"] = true;
						end;
					end;
					if(vecVI["ShipCost"]) then begin 
						if(SetInSet("freight",VIr.ExtraCostObj)or VIr.ExtraCostObj=="freight") then begin
							vecVItest["ShipCost"] = true;
						end;
					end;
					if(vecVI["Cost1"]) then begin 
						if(SetInSet("cost1",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost1") then begin
							vecVItest["Cost1"] = true;
						end;
					end;
					if(vecVI["Cost2"]) then begin 
						if(SetInSet("cost2",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost2") then begin
							vecVItest["Cost2"] = true; 
						end;
					end;
					if(vecVI["Cost3"]) then begin 
						if(SetInSet("cost3",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost3") then begin
							vecVItest["Cost3"] = true;
						end;
					end;
					if(vecVI["Cost4"]) then begin 
						if(SetInSet("cost4",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost4") then begin
							vecVItest["Cost4"] = true; 
						end;
					end;
					if(vecVI["Cost5"]) then begin 
						if(SetInSet("cost5",VIr.ExtraCostObj)or VIr.ExtraCostObj=="cost5") then begin
							vecVItest["Cost5"] = true;
						end;
					end;
				end;
			end;
			ResetLoop(VIr);
			POr.SerNr = PUr.PONr;
			if(ReadFirstMAin(POr,1,true))then begin end;
			if(POr.ExtraCostInPU==1)then begin
				if(PUr.ShipCostOKFlag!=0) then begin
					if(blank(PUr.ShipCost) and !correctPUf) then begin testf1 = false;  MessageBox(36234,""); end;
				end else begin	
					if(blank(PUr.ShipCost) or PUr.ShipCost==0 and !correctPUf) then begin testf1 = false;  MessageBox(36234,""); end;
				end;
				
				
				
				consPOf = false; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 18:22 16.12.2019
				if(matrowcnt(POr)>0)then begin
					matrowget(POr,0,POrw);
					if(POrw.ConsgType==1)then begin
						consPOf = true;
					end;
				end;
				
				
				if(!consPOf and !correctPUf)then begin
					if(PUr.CustomsCostOKFlag!=0) then begin
						if(blank(PUr.CustomsCost)) then begin testf1 = false;  MessageBox(36235,""); end;
					end else begin
						if(blank(PUr.CustomsCost) or PUr.CustomsCost==0) then begin testf1 = false;  MessageBox(36235,""); end;
					end;
				end;
				if(blank(PUr.Location)) then begin testf1 = false;  MessageBox(36208,""); end;
				for(i=0;i<tags.length;i=i+1) begin
					if(vecVItest[tags[i]]==false) then begin
						testVI = false;
					end;
				end;
			end;
			
			if(!testVI and (PUr.ShipCostOKFlag==0 or PUr.CustomsCostOKFlag==0) and !correctPUf) then begin 
				testf1 = false; 
				RecordCheckError(36236,"",-1,"SerNr");      
				res = -1; 
				goto L99PUVcRecordCheck;
			end;
		end;
	end;
  if (unokf) then begin
    errcode = IsUnOKAllowed_PUVc(PUr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,"",-1,"TransDate");      
      res = -1; 
    end;
    goto L99PUVcRecordCheck;
  end;  
  if (stat==Rs_update) then begin
    if (PU2r.OKFlag!=0) then begin
      goto L99PUVcRecordCheck;
    end;
  end;

  BlockLoad(SRRec);
  BlockLoad(CAb);
  BlockLoad(MSb);
  BlockLoad(SNrb);

  if (PUr.SerNr<=0) then begin
    newnr = GetCurUserLastNr("PUVc");
    if (newnr==-1) then begin
      newnr = SRRec.LastPurNr;
    end;
    PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,newnr,false,"");
  end;
  
  if ((stat==Rs_insert) or (PUr.SerNr!=PU2r.SerNr)) then begin
    localPUr.SerNr = PUr.SerNr;
    if (ReadFirstMAin(localPUr,1,true)) then begin
      RecordCheckError(1547,"",-1,"SerNr");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
  end;
  if (SerNrTestPUVc(PUr.SerNr,PUr.TransDate,gentrans)==false) then begin
    if (check>0) then begin
    RecordCheckError(1557,"",-1,"SerNr");      
    res = -1;
    goto L99PUVcRecordCheck;
  end;
  end;
  if (check==0) then begin
    goto LPUVcRecordCheck_GenTrans;
  end;
  if (Date2Test("PUVc",PUr.TransDate,"TransDate",-1)==false) then begin
    res = -1;
    goto L99PUVcRecordCheck;
  end; 
  if (DisallowFutureDateCheck(true,PUr.TransDate,"TransDate",-1)) then begin
    res = -1;
    goto L99PUVcRecordCheck;
  end;
  if (transf) then begin
    if (UserCanAction("PUOK",true)==false) then begin
      RecordCheckError(1274,StringFromStringSet(3,"PUOK"),-1,"SerNr");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
  end;  
  rwcnt = MatRowCnt(PUr);
  if (blank(PUr.Location)) then begin
    if (MSb.requireLocation!=0) then begin
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(PUr,i,PUrw);
        if (blank(PUrw.Location)) then begin
          RecordCheckError(1058,PUr.Location,-1,"Location");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
  end;
  loc = PUr.Location;
  if (blank(loc)) then begin
    loc = MSb.MainStock;
  end;  
  if (nonblank(loc)) then begin
    LocRec.Code = loc;
    if (ReadFirstMain(LocRec,1,true)==false) then begin
      RecordCheckError(1120,PUr.Location,-1,"Location");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
  end;
  if (nonblank(PUr.VECode)) then begin     
    VEr.Code = PUr.VECode;
    if (ReadFirstMain(VEr,1,true)==false) then begin
      RecordCheckError(1120,PUr.VECode,-1,"VECode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    /*if (VEr.blockedFlag!=0 or VEr.OnHoldFlag!=0) then begin
      RecordCheckError(1265,PUr.VECode,-1,"VECode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;*/
  end;
  if (nonblank(PUr.Objects)) then begin     
    errcode = CheckObjs("",PUr.Objects,errstr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,errstr,-1,"Objects");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
  end;  
	
	
	CUr.Code = PUr.VECode;
	if(ReadFirstMain(CUr,1,true))then begin end;
	
	if(currentcompany!=28)then begin
		if(CCB.OKFlagPOr!=0 and left(PUr.VECode,3)!="FOB" and CUr.VECat!="STORE" and PUr.OKFlag!=0 and !correctPUf) then begin
			if ((blank(PUr.ShipCost) or PUr.ShipCost==0) and PUr.ShipCostOKFlag==0) then begin     
				RecordCheckError(36294,"",-1,"ShipCost");      
				res = -1;
				goto L99PUVcRecordCheck;
			end; 
			
			POr.SerNr = PUr.PONr;
			if(ReadFIrstMain(POr,1,true))then begin
				consPOf = false; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 18:22 16.12.2019
				if(matrowcnt(POr)>0)then begin
					matrowget(POr,0,POrw);
					if(POrw.ConsgType==1)then begin
						consPOf = true;
					end;
				end;
			end;

			
			if ((blank(PUr.CustomsCost) or PUr.CustomsCost==0) and PUr.CustomsCostOKFlag==0 and !consPOf) then begin     
				RecordCheckError(36295,"",-1,"CustomsCost");      
				res = -1;
				goto L99PUVcRecordCheck;
			end;  
		end;
	end else begin
		if(CCB.OKFlagPOr!=0 and PUr.OKFlag!=0 and !correctPUf) then begin
			if ((blank(PUr.ShipCost) or PUr.ShipCost==0) and PUr.ShipCostOKFlag==0) then begin     
				RecordCheckError(36294,"",-1,"ShipCost");      
				res = -1;
				goto L99PUVcRecordCheck;
			end;  
			if ((blank(PUr.CustomsCost) or PUr.CustomsCost==0) and PUr.CustomsCostOKFlag==0) then begin     
				RecordCheckError(36295,"",-1,"CustomsCost");      
				res = -1;
				goto L99PUVcRecordCheck;
			end;  
		end;
	end;
	
  errcode = CheckRates(PUr.CurncyCode,PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,errstr);
  if (errcode!=0) then begin
    RecordCheckError(errcode,"",-1,errstr);      
    res = -1; 
    goto L99PUVcRecordCheck;
  end;          
  if (transf) then begin
    if (PUr.OKFlag==1) then begin
      if (BA_GRNCostVarianceWarning(PUr,i)) then begin
        if (UserCanAction("DisallowCostVariance",false)) then begin
          RecordCheckError(1274,StringFromStringSet(3,"DisallowCostVariance"),i,"CostPrice");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
  end;
  if (HasLocalization("PRT")) then begin
    VEr.Code = PUr.VECode;
    if (ReadFirstMain(VEr,1,true)) then begin
      if (blank(VEr.VATNr)) then begin
        RecordCheckError(20275,"",-1,"VECode");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
  end;
	

  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(PUr,i,PUrw);
    testf = true;
    if (IsStandardProduct) then begin
      testf = HasIntegratedNL and transf;
    end;
    if (testf) then begin
      if (nonblank(PUrw.CostAcc)) then begin
        Accr.AccNumber = PUrw.CostAcc;
        if (ReadFirstMain(Accr,1,true)==false) then begin
          RecordCheckError(1007,PUrw.CostAcc,i,"CostAcc");      
          res = -1; 
          goto L99PUVcRecordCheck;
        end else begin
          if ((Accr.blockedFlag!=0) or (Accr.GroupAcc!=0)) then begin
            RecordCheckError(1007,PUrw.CostAcc,i,"CostAcc");      
            res = -1; 
            goto L99PUVcRecordCheck;
          end;
        end;          
      end;
      if (nonblank(PUrw.CredAcc)) then begin
        Accr.AccNumber = PUrw.CredAcc;
        if (ReadFirstMain(Accr,1,true)==false) then begin
          RecordCheckError(1007,PUrw.CredAcc,i,"CredAcc");      
          res = -1; 
          goto L99PUVcRecordCheck;
        end else begin
          if ((Accr.blockedFlag!=0) or (Accr.GroupAcc!=0)) then begin
            RecordCheckError(1007,PUrw.CredAcc,i,"CredAcc");      
            res = -1; 
            goto L99PUVcRecordCheck;
          end;          
        end;
      end;        
    end;
    location = PUrw.Location;
    if (blank(PUrw.Location)) then begin
      location = loc;
    end;
    if (nonblank(location)) then begin
      LocRec.Code = location;
      if (ReadFirstMain(LocRec,1,true)==false) then begin
        RecordCheckError(1120,PUrw.Location,i,"Location");
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (StockRecordForLocationAllowed("PUVc",location,PUrw.ArtCode,PUr.TransDate,PUr.OKFlag,errcode,errstr)==false) then begin
      RecordCheckError(errcode,errstr,i,"ArtCode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    
    if (nonblank(PUrw.Location)) then begin
      location = PUrw.Location;
      if (MSb.Chronology==1) then begin//Chronology per Location
        if (PUrw.Location!=loc) then begin
          RecordCheckError(20857,"",i,"Location");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
  if (PUrw.stp==1) then begin
    if (IsOffice(false)) then begin
      if (PUrw.Quant<0) then begin
        RecordCheckError(1574,"",i,"Quant");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (PUrw.PONr>0) then begin
      errcode = GetPO(PUrw.PONr,POr,PUr.VECode,false);
      switch (errcode) begin
        case 1: 
          RecordCheckError(1281,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 2: 
          RecordCheckError(1215,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 3: 
          RecordCheckError(1138,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 4: 
          RecordCheckError(1026,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 5: 
          RecordCheckError(1459,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        case 6:
          RecordCheckError(22062,"",i,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;        
      end;
      if (PUr.PONr>0) then begin
        if (PUrw.PONr!=PUr.PONr) then begin
          RecordCheckError(2010,"",-1,"PONr");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
      if (PUrw.OrdRow<0) then begin
        RecordCheckError(1058,"",i,"OrdRow");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;            
    end;
    if (PUrw.PONr>0) then begin
      errcode = GetPO(PUrw.PONr,POr,PUr.VECode,false);
      if (POr.TransDate>PUr.TransDate) then begin
        RecordCheckError(20855,"",i,"PONr");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end else begin
      errcode = GetPO(PUr.PONr,POr,PUr.VECode,false);
      if (POr.TransDate>PUr.TransDate) then begin
        RecordCheckError(20855,"",-1,"PONr");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (PUr.PONr>0 or PUrw.PONr>0) then begin
      if (check!=0) then begin
        if (PUrw.OrdRow<MatRowCnt(POr)) and (PUrw.OrdRow>=0) then begin
          if (PUr.OKFlag!=0 and PU2r.OKFlag!=0) then begin
            MatRowGet(PU2r,i,PU2rw);
            if (PUrw.ArtCode==PU2rw.ArtCode and PUrw.Quant==PU2rw.Quant and PUrw.OrdRow==PU2rw.OrdRow) then begin
              goto Lskiprecvcheck;
            end;
          end;
          if (PUrw.ovst==0) and (PUr.Invalid==0) then begin
            MatRowGet(POr,PUrw.OrdRow,POrw);
            if (MSb.dontAllowOverreceive==1) then begin
              prev = blankval;
              for (j=0;j<rwcnt;j=j+1) begin
                if (j!=i) then begin
                  MatRowGet(PUr,j,PU2rw);
                  if (PU2rw.OrdRow==PUrw.OrdRow and PU2rw.PONr==PUrw.PONr) then begin
                    if (PU2rw.ovst==0) then begin
                      prev = prev + PU2rw.Quant;
                    end;
                  end;
                end;
              end;
              prev = prev + PUrw.Quant;
              if (((POrw.Quant - POrw.Shipd2)<prev) and (prev>0)) then begin
                RecordCheckError(20055,"",i,"Quant");      
                res = -1; 
                goto L99PUVcRecordCheck;
              end;
            end;
          end;
          Lskiprecvcheck:;
        end;
      end;  
    end;  
    if (blank(PUrw.ArtCode)) then begin
      RecordCheckError(1130,"",i,"ArtCode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    if (ReadFirstItem(PUrw.ArtCode,INr,true,true)==false) then begin
      RecordCheckError(1120," " & PUrw.ArtCode,i,"ArtCode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    if (PUrw.StockType==kStockTypeConsigment) then begin
      if (INr.SerNrf<1) then begin
        RecordCheckError(1953,"",i,"StockType");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (PUrw.TREO==kTREO) then begin
      if (INr.SerNrf<1) then begin
        RecordCheckError(1953,"",i,"TREO");
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if ((HasLocalization("EST")) or (HasLocalization("POL"))) then begin//vatEstonian,vatPolish
      if (INr.ItemType!=1) then begin
        RecordCheckError(1301,"",i,"ArtCode");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (CheckAllowedSize(INr,PUrw.UnitXval,PUrw.UnitYval,PUrw.UnitZval)==false) then begin
      RecordCheckError(1480,"",i,"UnitXval");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    if (check!=0) then begin
      VerifyRowObjects("PL",PUr.Objects,PUrw.Objects,PUrw.CredAcc,errcode,errstr,initotcheckf,otcheckaccs,otcheckobjtyps,otcheckcnt);                              
      if (errcode!=0) then begin
        RecordCheckError(errcode,errstr,i,"Objects");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (nonblank(PUrw.Objects)) then begin 
    	if(currentcompany==18)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 07 05 2020 y. at 1:58:16 PM
				ClearArray(objstores);
				ClearArray(objstoressubdi);
				CustExtractObjectsByType(PUrw.Objects,"STORE",objstores,oscnt,addobj);
				CustExtractObjectsByType(PUrw.Objects,"SUBDI",objstoressubdi,oscntsubdi,addobjsubdi);
				if(nonblank(objstores[0]))then begin
					if(blank(objstoressubdi[0]))then begin
						CustExtractObjectsByType(PUr.Objects,"SUBDI",objstoressubdi,oscntsubdi,addobjsubdi);
						if(nonblank(objstoressubdi[0]))then begin
							PUrw.Objects = PUrw.Objects & "," & objstoressubdi[0];
						end;
					end;
				end;
			end;
      errcode = CheckObjs("",PUrw.Objects,errstr);
      if (errcode!=0) then begin
        RecordCheckError(errcode,errstr,i,"Objects");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
    end;
    if (blank(PUrw.Quant)) then begin
      RecordCheckError(1058,"",i,"Quant");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    if (INr.ItemType==2) then begin
      RecordCheckError(1826,"",i,"ArtCode");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    if (LocRec.RequirePos!=0) then begin
/*occupied is not important, height is important    
      if (nonblank(PUrw.ToPosCode)) then begin
        res = IsPositionFree(PUrw.ToPosCode);
        if (res>0) then begin
          RecordCheckError(res," " & PUrw.ToPosCode,i,"ToPosCode");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end else begin
      	RecordCheckError(res," " & PUrw.ToPosCode,i,"ToPosCode");      
				res = -1;
				goto L99PUVcRecordCheck;
      end;
*/// Edit Start ---------------------------------------------- Edit Start
	//Friday, 17 August 2018 14:54:21
	if (LocRec.RequirePos!=0) then begin
		if (blank(PUrw.ToPosCode)) then begin
			RecordCheckError(35156,PUrw.ToPosCode,i,"ToPosCode");      
			res = -1;
			goto L99PUVcRecordCheck;
		end;
	end;

	// Edit End ---------------------------------------------- Edit End
	
      w = 0;
      h = 0;
      d = 0;
      m = PUrw.Quant/INr.QtyonPallet;
      if (INr.PalletWidth!=0) then begin w = w + INr.PalletWidth*m; end;
      if (INr.PalletHeight!=0) then begin h = h + INr.PalletHeight*m; end;
      if (INr.PalletDepth!=0) then begin d = d + INr.PalletDepth*m; end;
      for (j=0;j<i;j=j+1) begin
        MatRowGet(PUr,j,PU2rw);
        if (PUrw.PosCode==PU2rw.PosCode) then begin
          if (ReadFirstItem(PU2rw.ArtCode,IN2r,true,true)) then begin
            m = 0;
            if (IN2r.QtyonPallet>0) then begin
              m = PU2rw.Quant/IN2r.QtyonPallet;
            end;                
            if (IN2r.PalletWidth!=0) then begin
              w = w + IN2r.PalletWidth*m;
            end;
            if (IN2r.PalletHeight!=0) then begin
              h = h + IN2r.PalletHeight*m;
            end;
            if (IN2r.PalletDepth!=0) then begin
              d = d + IN2r.PalletDepth*m;
            end;
          end;
        end;
/*only height matters
        if (PUrw.ArtCode!=lastpalletitem) then begin
          if (nonblank(PUrw.ToPosCode)) then begin
            if (PUrw.ToPosCode==PU2rw.ToPosCode) then begin
              RecordCheckError(1729,PUrw.ToPosCode,i,"ToPosCode");      
              res = -1;
              goto L99PUVcRecordCheck;
            end;
          end;
        end;
*/        
      end;    
      lastpalletitem = INr.DefPalletItem;
      
      
      
      if (nonblank(PUrw.PosCode)) then begin
        errcode = CheckPosition(PUrw.PosCode,location,LocRec.RequirePos,w,h,d);
        if (errcode!=0) then begin
          RecordCheckError(errcode,PUrw.PosCode,i,"PosCode");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
      if (nonblank(PUrw.ToPosCode)) then begin
        w = 0;
        h = 0;
        d = 0;
        m = PUrw.Quant/INr.QtyonPallet;
        if (INr.PalletWidth!=0) then begin w = w + INr.PalletWidth*m; end;
        if (INr.PalletHeight!=0) then begin h = h + INr.PalletHeight*m; end;
        if (INr.PalletDepth!=0) then begin d = d + INr.PalletDepth*m; end;
        for (j=0;j<i;j=j+1) begin
          MatRowGet(PUr,j,PU2rw);
          if (PUrw.ToPosCode==PU2rw.ToPosCode) then begin
            if (ReadFirstItem(PU2rw.ArtCode,IN2r,true,true)) then begin
              m = 0;
              if (IN2r.QtyonPallet>0) then begin
                m = PU2rw.Quant/IN2r.QtyonPallet;
              end;                
              if (IN2r.PalletWidth!=0) then begin
                w = w + IN2r.PalletWidth*m;
              end;
              if (IN2r.PalletHeight!=0) then begin
                h = h + IN2r.PalletHeight*m;
              end;
              if (IN2r.PalletDepth!=0) then begin
                d = d + IN2r.PalletDepth*m;
              end;
            end;
          end;
        end;    
        errcode = CheckPosition(PUrw.ToPosCode,location,LocRec.RequirePos,w,h,d);
        if (errcode!=0) then begin
          RecordCheckError(errcode,PUrw.ToPosCode,i,"ToPosCode");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end else begin
      if (nonblank(PUrw.PosCode)) then begin
        Posr.Code = PUrw.PosCode;
        Posr.Location = location;
        if (ReadFirstKey("Location",Posr,2,true)==false) then begin
          RecordCheckError(1120,PUrw.PosCode,i,"PosCode");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
      if (nonblank(PUrw.ToPosCode)) then begin
        Posr.Code = PUrw.ToPosCode;
        Posr.Location = location;
        if (ReadFirstKey("Location",Posr,2,true)==false) then begin
          RecordCheckError(1120,PUrw.ToPosCode,i,"ToPosCode");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
    if (LocRec.RequirePos!=0) then begin
      if (blank(PUrw.ToPosCode)) then begin
        RecordCheckError(1854,"",i,"ToPosCode");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
      if (StockMovr.SerNr<=0) then begin
        StockMovr.SerNr = NextSerNr("StockMovVc",CurrentDate,-1,false,"");
        if (StockMovr.SerNr<=0) then begin 
          RecordCheckError(2291,"",-1,"SerNr");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
/*    
    if (nonblank(LocRec.Code)) then begin
      if (nonblank(MainWHM.Location)) then begin
        if (LocRec.RequirePos!=0) then begin
          if (blank(PUrw.ToPosCode)) then begin
            RecordCheckError(1854,"",i,"PosCode");      
            res = -1;
            goto L99PUVcRecordCheck;
          end;

//*          if (PUrw.ToPosCode!=MainWHM.DefPUPosCode) then begin
//*            res = IsPositionFree(PUrw.ToPosCode);
//*            if (res>0) then begin
//*              RecordCheckError(res," " & PUrw.ToPosCode,i,"ToPosCode");      
//*              res = -1;
//*              goto L99PUVcRecordCheck;
//*            end;
//*          end;
        end;
      end else begin
        if (LocRec.RequirePos!=0) then begin
          if (blank(PUrw.ToPosCode)) then begin
            RecordCheckError(1854,"",i,"ToPosCode");      
            res = -1;
            goto L99PUVcRecordCheck;
          end;
        end;
      end;
    end;
*/    
    if (transf) then begin
		
		
		/*
			BlockLoad(DiCb);
			mtrw = MatRowCnt(DiCb);
			if (mtrw>0) then begin
				for (k=0;k<mtrw;k=k+1) begin
					MatRowGet(DiCb,k,DiCbw);
					if (NonBlank(DiCbw.DiCode) and NonBlank(DiCbw.DiType)) then begin
						diCheckTypes[DiCbw.DiCode] = DiCbw.DiType;
					end;
				end;
			end; 
			NINr.SerNr = -1;
			testf2 = true;
			TrHs = true;
			while (LoopMain(NINr,1,TrHs))begin
				rwcnt2 = MatRowCnt(NINr);
				for (k=0;k<rwcnt2;k=k+1) begin
					MatRowGet(NINr,k,NINrw);
					if(PUrw.ArtCode==NINrw.Code)then begin
						testf2 = true;
						if (!DIsWithTypeExistsOrCreateSpecific(NINrw.Type,outdisps,ReturnFieldDIType("Type",false),mes)) then begin
							RecordCheckError(35150,"",i,"ArtCode");      
							res = -1;
							goto L99PUVcRecordCheck;
						end else begin
							NINrw.Type = outdisps;
						end;
						type = NINrw.Type;
						if(blank(NINrw.Brand) and SetInSet(ReturnFieldDIType("Brand",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Collection) and SetInSet(ReturnFieldDIType("Collection",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.WatchType) and SetInSet(ReturnFieldDIType("WatchType",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.GenderSC) and SetInSet(ReturnFieldDIType("GenderSC",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Dial) and SetInSet(ReturnFieldDIType("Dial",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Strap) and SetInSet(ReturnFieldDIType("Strap",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Material) and SetInSet(ReturnFieldDIType("Material",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.PrecStones) and SetInSet(ReturnFieldDIType("PrecStones",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.SerNrf) and SetInSet(ReturnFieldDIType("SerNrf",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Mechanism) and SetInSet(ReturnFieldDIType("Mechanism",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Function) and SetInSet(ReturnFieldDIType("Function",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.WaterResist) and SetInSet(ReturnFieldDIType("WaterResist",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Diameter) and SetInSet(ReturnFieldDIType("Diameter",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Category) and SetInSet(ReturnFieldDIType("Category",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Division) and SetInSet(ReturnFieldDIType("Division",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.WeightOfMat) and SetInSet(ReturnFieldDIType("WeightOfMat",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Diamonds) and SetInSet(ReturnFieldDIType("Diamonds",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.DiamondsCarat) and SetInSet(ReturnFieldDIType("DiamondsCarat",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.SolidStones05) and SetInSet(ReturnFieldDIType("SolidStones05",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.PrecAndSemiPrec) and SetInSet(ReturnFieldDIType("PrecAndSemiPrec",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.RingSizes) and SetInSet(ReturnFieldDIType("RingSizes",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Carat) and SetInSet(ReturnFieldDIType("Carat",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.ClaritySC) and SetInSet(ReturnFieldDIType("ClaritySC",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.ColorOfMat) and SetInSet(ReturnFieldDIType("ColorOfMat",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.ShapeCut) and SetInSet(ReturnFieldDIType("ShapeCut",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Description) and SetInSet(ReturnFieldDIType("Description",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.Art) and SetInSet(ReturnFieldDIType("Art",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif30) and SetInSet(ReturnFieldDIType("classif30",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif31) and SetInSet(ReturnFieldDIType("classif31",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif32) and SetInSet(ReturnFieldDIType("classif32",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif33) and SetInSet(ReturnFieldDIType("classif33",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.classif34) and SetInSet(ReturnFieldDIType("classif34",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(blank(NINrw.BrandSC) and SetInSet(ReturnFieldDIType("BrandSC",false),diCheckTypes[type]))then begin testf2 = false; end;
						if(testf2==true)then begin k = rwcnt2; TrHs = false; end else begin logtext(0,NINr.SerNr & " <> " & PUrw.ArtCode); end;
					end;								
				end;
			end;
			ResetLoop(NINr);
			if(testf2==false)then begin
				RecordCheckError(35150,"",i,"ArtCode");      
				res = -1;
				logtext(0," 1");
				goto L99PUVcRecordCheck;
			end;*/
      if (((INr.SerNrf>0) and (INr.SerNrf<3)) and (MSb.NoSerOnPU==0)) then begin
        if (PUrw.Quant!=0) then begin
          if (blank(PUrw.SerialNr)) then begin
            RecordCheckError(1239,"",i,"SerialNr");      
            res = -1;
            goto L99PUVcRecordCheck;
          end;
        end;
				
        if (Mid(PUrw.SerialNr,len(PUrw.SerialNr),1)==" ") then begin
          RecordCheckError(1239,"",i,"SerialNr");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
        if (SNrb.BulkSerialNos==0) then begin
          if (IsSerialNrCorrect(PUrw.SerialNr)==false) then begin
            RecordCheckError(24154,PUrw.SerialNr,i,"SerialNr");      
            res = -1; 
            goto L99PUVcRecordCheck;
          end;        
        end;        
        switch (INr.SerNrf) begin
          case 1:  // serial nr. 
            // is the serial number available at any location 
            if (SNrb.BulkSerialNos!=0) then begin
              errcode = ValidateBulkSerialNoRow(SNrb,PUr,PUrw,i,gotofield,gotorow);
              if (errcode) then begin
                RecordCheckError(errcode,"",gotorow,gotofield);      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
            end else begin
              for (j=0;j<i;j=j+1) begin              
                MatRowGet(PUr,j,PU2rw);
                if (PUrw.Quant!=0) then begin
                  if ((PUrw.ArtCode==PU2rw.ArtCode) and
                      (PUrw.SerialNr==PU2rw.SerialNr)) then begin
                    RecordCheckError(1241,"",i,"SerialNr");      
                    res = -1;
                    goto L99PUVcRecordCheck;
                  end;
                end;
              end;
              if (PUrw.Quant!=0) then begin
                if (SerialNrAvail2(PUrw.ArtCode,PUrw.SerialNr,PUrw.Quant) and currentcompany!=29) then begin
                  RecordCheckError(1243,"",i,"SerialNr");      
                  res = -1;
                  goto L99PUVcRecordCheck;
                end;
              end;
              if (PUrw.Quant!=1 and PUrw.Quant!=0) then begin
                RecordCheckError(1242,"",i,"Quant");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
              if (SerialNrOnThisPU(PUr,PUrw.ArtCode,PUrw.SerialNr)>1) then begin
                RecordCheckError(1242,"",i,"Quant");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
/*              
              if (SerialNrEverinStock(PUrw.ArtCode,PUrw.SerialNr)) then begin
                RecordCheckError(1243,"",i,"SerialNr");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
*/              
            end;
          case 2:  ;// batch nr. 
            for (j=0;j<i;j=j+1) begin              
              MatRowGet(PUr,j,PU2rw);
              if ((PUrw.ArtCode==PU2rw.ArtCode) and
                  (PUrw.SerialNr==PU2rw.SerialNr)) then begin
                  if (PUrw.CostPrice!=PU2rw.CostPrice) then begin
                    RecordCheckError(20568,"",i,"SerialNr");      
                    res = -1;
                    goto L99PUVcRecordCheck;
                  end;
                  if (nonblank(PUrw.BestBefore)) or (nonblank(PU2rw.BestBefore)) then begin
                    if (PUrw.BestBefore!=PU2rw.BestBefore) then begin
                      RecordCheckError(20765,"",i,"SerialNr");      
                      res = -1;
                      goto L99PUVcRecordCheck;
                    end;
                  end;
              end;
            end;
            if (FIFOPerSerialNr(INr,CAb)!=0 and currentcompany!=29) then begin//otherwise cost price on deliveries is completely wrong
              if (SerialNrAvail2(PUrw.ArtCode,PUrw.SerialNr,1)) then begin
                RecordCheckError(1243,"",i,"SerialNr");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;              
            end;
            FindBatchBestBeforeDate(PUrw.ArtCode,PUrw.SerialNr,bbd);
            if (nonblankdate(bbd)) then begin
              if (PUrw.BestBefore!=bbd)then begin
                RecordCheckError(20765,"",i,"SerialNr");      
                res = -1;
                goto L99PUVcRecordCheck;
              end;
            end;
        end;
      end;
    end;
  end;
  end;
	
	// POr.SerNr = PUr.PONr;
	// if(ReadFirstMain(POr,1,true))then begin end;
	// if (PUr.OKFlag==1 and PU2r.OKFlag==0) then begin
		// if(/*currentcompany==28 and */POr.ExtraCostInPU==1)then begin
			// if(PUr.ShipCostOKFlag==0 or PUr.CustomsCostOKFlag==0/* or PUr.ItemsCostOKFlag==0*/)then begin  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 12:18 25.07.2019
				// RecordCheckError(36282,"",-1,"SerNr");      
				// res = -1;
				// goto L99PUVcRecordCheck;
			// end;
		// end;
  // end;
	
  if (DateWarned(PUr.TransDate,"PUVc")) then begin
    MessageBox(1045,"");
  end;  

	TrHs = true;
	while (LoopMain(NINr,1,TrHs)) begin
		if(nonblank(NINr.Brand))then begin sBrand = NINr.Brand; TrHs = false; end;
	end;
	if(PUr.ItemClassifCheck==0)then begin
		recordnew(NINEmptr);
		NINEmptr.SerNr = -1;
		
		ResetLoop(NINr);
		recordnew(NINr);
		NINr.SerNr = -1;
		NINr.Brand = sBrand;
		NINr.OKFlag = 1;
		for (i=0;i<rwcnt;i=i+1)begin
			matrowget(PUr,i,PUrw);
			NINrw.Code = PUrw.ArtCode;
			MatRowPut(NINr,i,NINrw);
			HandleNewINDClassmCode(NINr,i);
			MatRowPut(NINr,i,NINrw);
		end;
	end;

  
  if (transf) then begin
		BlockLoad(BOb);
		if(PUr.ItemClassifCheck==0 and BOb.BackOrderMark==1)then begin
			stat1 = 1;
			long4 = -1;
			resNIN = NewINVcRecordCheck(NINr,NINEmptr,stat1,long4);
			if(resNIN==-1)then begin
				MessageBox(0,"Неполная классификация товаров!");
				res = -1;
				goto L99PUVcRecordCheck;
			end;
		end;
    if (stat==Rs_update) then begin
      sernr = PU2r.SerNr;
    end;
    if (check>0) then begin
      if (MSb.Chronology!=0) then begin
        if (ExistStockTrans(location,PUr.TransDate,errcode,errstr,"PUVc",sernr,MSb)==true) then begin
          RecordCheckError(errcode,errstr,-1,"TransDate");      
          res = -1;
          goto L99PUVcRecordCheck;
        end;
      end;
    end;
    if (CanOKStockRecord(errcode)==false) then begin
      RecordCheckError(errcode,"",-1,"SerNr");      
      res = -1; 
      goto L99PUVcRecordCheck;
    end;
/*done in other place    
    if (IsStockSettingsOK==false) then begin
      RecordCheckError(1767,"",-1,"SerNr");      
      res = -1; 
      goto L99PUVcRecordCheck;
    end;
*/    
  end;
  if (transf) then begin
    FillAmForVariancePU(PUr);
  end;
LPUVcRecordCheck_GenTrans:;
  if (gentrans==false) then begin transf = false; end;
  if (IsStandardProduct) then begin
    transf = HasIntegratedNL and transf;
  end;
  if (transf) then begin
    errcode = MakeTransFromPU(gTRp,PUr,LocRec,false);
    if (errcode>0) then begin
      RecordCheckError(errcode,"",-1,"SerNr");      
      res = -1;
      goto L99PUVcRecordCheck;
    end;
    if ((gTRp.Number>0) and (gTRp.IntYc==PUYc)) then begin
      errstr = CheckTrans(gTRp,2,true);
      if (nonblank(errstr)) then begin
        RecordCheckError(1085,errstr,-1,"SerNr");      
        res = -1;
        goto L99PUVcRecordCheck;
      end;
      switch (gRuniningMaint) begin    
        case "RecalcStockMn":
          UpdateTrans_Stock(gTRp);          
        otherwise
          SaveTrans(gTRp);
          AddTTrans_PUVc(gTRp,PUr);
      end;
    end;    
  end;  
	if(CurrentCompany==29)then begin
		if(PUr.OKFlag==1 and PU2r.OKFlag==0)then begin
			mtrw = matrowcnt(PUr);
			ORr.SerNr = "";
			for(i=0;i<mtrw;i=i+1)begin
				matrowget(PUr,i,PUrw);
				vItQty[PUrw.ArtCode] = PUrw.Quant;
				if(left(PUrw.SerialNr,5)=="EXTPR")then begin
					ORr.SerNr = right(PUrw.SerialNr,len(PUrw.SerialNr)-5);
					PUlocation = PUr.Location;
				end;
			end;
			ecORcomlf = true;
			ORr.SerNr = mid(PUrw.SerialNr,3,len(PUrw.SerialNr)-12);
			PUlocation = PUr.Comment;
			mtrw = matrowcnt(PUr);
			for(i=0;i<mtrw;i=i+1)begin
				matrowget(PUr,i,PUrw);
				vItQty[PUrw.ArtCode] = PUrw.Quant;
				if(left(PUrw.SerialNr,5)=="EXTPR")then begin
					ORr.SerNr = right(PUrw.SerialNr,len(PUrw.SerialNr)-5);
					PUlocation = PUr.Location;
				end;
			end;
			if(ReadFirstMain(ORr,1,true))then begin
				RecordCopy(OldORr,ORr);
				mtrw = matrowcnt(ORr);
				for(i=0;i<mtrw;i=i+1)begin
					matrowget(ORr,i,ORrw);
					if(SetInSet(ORrw.ECReservStock,PUlocation))then begin
						if(vItQty[ORrw.ArtCode]<ORrw.Quant)then begin
							Logtext(0,PUlocation & "<>" & vItQty[ORrw.ArtCode]);
							ORrw.ECReceived = ORrw.ECReceived + vItQty[ORrw.ArtCode];
							MatRowPut(ORr,i,ORrw);
						end else begin
							Logtext(0,PUlocation & "<>" & vItQty[ORrw.ArtCode]);
							ORrw.ECReceived = ORrw.Quant;
							vItQty[ORrw.ArtCode] = vItQty[ORrw.ArtCode] - ORrw.Quant;
							MatRowPut(ORr,i,ORrw);
						end;
					end;
					if(ORrw.ECReceived!=ORrw.Quant)then begin
						ecORcomlf = false;
					end;
				end;
				if(ORr.ECORCompl!=1)then begin
					if(ecORcomlf)then begin
						ORr.ECORCompl = 1;
					end else begin
						ORr.ECORCompl = 0;
					end;
				end;
				if(RecordUpdate(OldORr,ORr,true)==0)then begin end;
			end;
		end;
	end;
	
	
L99PUVcRecordCheck:;
  if (res!=0) then begin PUr.SerNr = oldnr; end;
	LogProcTime("PUVcRecordCheck",getcurtick()-curtick); 
	logtext(0,"PUVcRecordCheck " & getcurtick()-curtick); 
  PUVcRecordCheck = res;
  return;
end;
  
global
updating function LongInt PUCheckIfSaveAllowed(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  SetRecordCheckVc("PUVc");
  res = PUVcRecordCheck(PUr,PU2r,stat,long4);  
  PUCheckIfSaveAllowed = res;
  return;
end;
  
procedure PUVcConvertB1ToB2(var record PUVc PUp,string curp,val frp,var val to1p,var val to2p,var val br1p,var val br2p)
begin
  row PUVc PUrw;
  Integer rwcnt,i;
  val fr,to1,to2,br1,br2;
  string 20 curncy;
  Boolean base2inv;
  Boolean treated;
  Date curdate;
  val t;
  string 255 tstr;

  curdate = CurrentDate;
  curncy = curp;
  GetFullCurncyRate(curncy,PUp.TransDate,fr,to1,to2,br1,br2);
  if (curncy==curp) then begin base2inv = true; end;
  SwapM4Val(br1p,br2p);
  SwapM4Val(to1p,to2p);
  rwcnt = MatRowCnt(PUp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(PUp,i,PUrw);
    B1ToB2StrValRM(PUrw.Extra,br1p,br2p,tstr,GetCostRoundModeRB);
    PUrw.Extra = tstr;
    B1ToB2ValRM(PUrw.CostPrice,br1p,br2p,t,GetCostRoundModeRB);
    PUrw.CostPrice = t;
    B1ToB2ValRM(PUrw.Sum,br1p,br2p,t,GetCostRoundModeRB); //Sum always in base 1, isnt it
    PUrw.Sum = t;
    B1ToB2ValRM(PUrw.ShipCost,br1p,br2p,t,GetCostRoundModeRB);
    PUrw.ShipCost = t;
    B1ToB2ValRM(PUrw.RowCost1,br1p,br2p,t,GetCostRoundModeRB);
    PUrw.RowCost1 = t;
    B1ToB2ValRM(PUrw.RowCost2,br1p,br2p,t,GetCostRoundModeRB);
    PUrw.RowCost2 = t;
    B1ToB2ValRM(PUrw.RowCost3,br1p,br2p,t,GetCostRoundModeRB);
    PUrw.RowCost3 = t;
    B1ToB2ValRM(PUrw.RowCost4,br1p,br2p,t,GetCostRoundModeRB);
    PUrw.RowCost4 = t;
    B1ToB2ValRM(PUrw.RowCost5,br1p,br2p,t,GetCostRoundModeRB);
    PUrw.RowCost5 = t;
    B1ToB2StrValRM(PUrw.CustomsCost,br1p,br2p,tstr,GetCostRoundModeRB);
    PUrw.CustomsCost = tstr;
    MatRowPut(PUp,i,PUrw);
  end;
  return;
end;

global
function LongInt PUVcRecordImport(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  record ConvMasterBlock cvm;
  Boolean gToDualBase,gBase1ToBase2;
  val fr,to1,to2,br1,br2,t;
  string 10 curncy;

  BlockLoad(cvm);
  if (cvm.DualBaseCurrencyFlag!=0) then begin gToDualBase = true; end;
  if (cvm.Base1ToBase2Flag!=0) then begin gBase1ToBase2 = true; end;
  if (gToDualBase) then begin
    curncy = PUr.CurncyCode;
    fr = PUr.FrRate;
    to1 = PUr.ToRateB1;
    to2 = PUr.ToRateB2;
    br1 = PUr.BaseRate1;
    br2 = PUr.BaseRate2;
    ConvertToDualBase(curncy,PUr.TransDate,fr,to1,to2,br1,br2,t,false);
    PUr.CurncyCode = curncy;
    PUr.FrRate = fr;
    PUr.ToRateB1 = to1;
    PUr.ToRateB2 = to2;
    PUr.BaseRate1 = br1;
    PUr.BaseRate2 = br2;
  end;
  if (gBase1ToBase2) then begin
    to1 = PUr.ToRateB1;
    to2 = PUr.ToRateB2;
    br1 = PUr.BaseRate1;
    br2 = PUr.BaseRate2;
    PUVcConvertB1ToB2(PUr,PUr.CurncyCode,PUr.FrRate,to1,to2,br1,br2);
    PUr.ToRateB1 = to1;
    PUr.ToRateB2 = to2;
    PUr.BaseRate1 = br1;
    PUr.BaseRate2 = br2;
    PUSumUp(PUr);
  end;
  if (PUr.NoTAXonVAT==-1) then begin
    PUr.NoTAXonVAT = 0;
  end;
  PUVcRecordImport = res;
  return;
end;

global
updating function LongInt PUVcRecordImportAfter(var record PUVc PUr,record PUVc PU2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  Integer err;
    
  if (PUr.OKFlag!=0) then begin
    PurUpdateSerialNr(PUr,true,false);
    if (ImportingTextBackup==false and CanOKStockRecord(err)==true) then begin
      PurUpdateStock(PUr,false);
      PurUpdateCostPrice(PUr,false);  // this should be called during import since records are from other systems
      PurUpdateItemHist(PUr);
    end;
  end;
  PUVcRecordImportAfter = res; 
  return;
end;

function
Boolean InvalidPUOK(record PUVc PUp)
begin
  Boolean res;
  Boolean noinvalidf;
  record ItemHistVc IHr;
  row PUVc PUrw;
  Integer i,rwcnt;
  Integer primary;
  record INVc INr;

  noinvalidf = false;
  res = true;
  rwcnt = MatRowCnt(PUp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(PUp,i,PUrw);
    if (ReadFirstItem(PUrw.ArtCode,INr,false,false)) then begin
      if (INr.ItemType==1) then begin
        noinvalidf = true;
      end;
    end;
/*    
    primary = ArtCodePrimaryCostModel(PUrw.ArtCode);  
    switch (primary) begin
      case 0:
      case 9:
      case 3:
        IHr.FileName = "PUVc";
        IHr.ArtCode = PUrw.ArtCode;
        if (ReadFirstKey("FNArtCode",IHr,2,true)) begin
          noinvalidf = true;
        end;
      otherwise
        IHr.FileName = "PUVc";
        IHr.TransNr = PUp.SerNr;
        IHr.Row = i;
        if (ReadFirstKey("FNTransNr",IHr,3,true)) begin
          if (IHr.RemQty!=PUrw.Quant) then begin
            noinvalidf = true;
          end;
        end else begin
          noinvalidf = true;
        end;
    end;
*/    
    if (noinvalidf) then begin
      res = false;
      MessageBox(34500,"");
      goto LInvalidPUOK;
    end;
  end;
LInvalidPUOK:;  
  InvalidPUOK = res;
  return;
end;

global
function LongInt PUVcRecordInvalidateTest(var record PUVc PUr,record PUVc PU2r,LongInt long3,LongInt long4)
begin
  LongInt res; 

  res = 0;
  if (UserCanAction("PUInvalid",true)) then begin
    if ((PUr.Invalid==0) and (PUr.OKFlag!=0)) then begin
      if (InvalidPUOK(PUr)) then begin
        PUr.Invalid = 1;     
        res = 1;
      end;
    end else begin
      if (PUr.Invalid==0) then begin
        MessageBox(34500,"");
      end;
    end;
  end;  
//  res = 0;// more code needed
  PUVcRecordInvalidateTest = res; 
  return;
end;

/* not possible
global
function LongInt PUVcRecordTransDateOff(var record PUVc PUr,record PUVc PU2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  
  PUVcRecordTransDateOff = res; 
  return;
end;
*/
global
procedure BPUDClassCustomsCostDo(var record BigPUVc BPUr)
begin
 row BigPUVc BPUrw;
 integer i;
 val total;
 val FInBase,startcustcost,calccost,sumcost;
 record ConsCompBlock CCBb;
 record INVc INr;
 
 
 startcustcost = BPUr.CustomsCost;
 sumcost = blankval;
 for(i=0;i<matrowcnt(BPUr);i=i+1) begin
		MatRowGet(BPUr,i,BPUrw);
		INr.Code = BPUrw.ArtCode;
		if(ReadFirstMain(INr,1,true)) then begin end;
		if(INr.ConsgType!=1) then begin
			total = total + BPUrw.Quant * BPUrw.UPrice;
		end;	
	end;
	if(nonblank(BPUr.CurrencyT) and BPUr.CurrencyT!="AZN") then begin
		FInBase = MulRateToBase1(BPUr.CurrencyT,BPUr.CustomsCost,BPUr.FrRateT,BPUr.ToRateT,BPUr.ToRateT,BPUr.FrRateT,BPUr.ToRateT,SetROundModeD(5));
	end else begin 	
		FInBase = BPUr.CustomsCost; 
	end;
	if(BPUr.ConsManualCost==1)then begin
		BPUr.ConsManualCost = 0;
	end;
	BPUr.CustomsCost = 0;
	for(i=0;i<matrowcnt(BPUr);i=i+1) begin
		MatRowGet(BPUr,i,BPUrw);
		INr.Code = BPUrw.ArtCode;
		if(ReadFirstMain(INr,1,true)) then begin end;
		if(INr.ConsgType!=1) then begin
			calccost = blankval;
			calccost = round(FInBase * round(BPUrw.UPrice/total,SetRoundModeD(5)),SetRoundModeD(5));
			logtext(0,"calccost " & calccost * 1000);
			sumcost = sumcost + calccost;
			BPUrw.CustomsCost = calccost;
			//BPUr.CustomsCost = BPUr.CustomsCost + BPUrw.Quant * BPUrw.CustomsCost;
		end;	
		MatRowPut(BPUr,i,BPUrw);
	end;
	BPUr.CustomsCost = sumcost;
	
	
	BigPUSumUp(BPUr);
 return;
end;


global
procedure BPUDClassCost1Do(var record BigPUVc BPUr)
begin
  row BigPUVc BPUrw;
  integer i;
	val total;
	val FInBase;
	record INVc INr;
	vector boolean Consf;
	
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			INr.Code = BPUrw.ArtCode;
			if(ReadFirstMain(INr,1,true))then begin
				if(INr.ConsgType==1)then begin
					Consf[INr.Code] = true;
					total = total + BPUrw.Quant * BPUrw.UPrice;
				end;
			end;
		end;
		FInBase = BPUr.Cost1;
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			if(Consf[BPUrw.ArtCode])then begin
				BPUrw.RowCost1 = FInBase * (BPUrw.UPrice/total);
				MatRowPut(BPUr,i,BPUrw);
			end;
		end;
	return;
end;
global
procedure IDGPUDClassCost1Do(var record PUVc PUr)
begin
  row PUVc PUrw;
  integer i;
	val total;
	val FInBase;
	record INVc INr;
	vector boolean Consf;
	
		for(i=0;i<matrowcnt(PUr);i=i+1) begin
			MatRowGet(PUr,i,PUrw);
			INr.Code = PUrw.ArtCode;
			if(ReadFirstMain(INr,1,true))then begin
				if(INr.ConsgType==1)then begin
					Consf[INr.Code] = true;
					total = total + PUrw.Quant * PUrw.UPrice;
				end;
			end;
		end;
		FInBase = PUr.Cost1;
		for(i=0;i<matrowcnt(PUr);i=i+1) begin
			MatRowGet(PUr,i,PUrw);
			if(Consf[PUrw.ArtCode])then begin
				PUrw.RowCost1 = FInBase * (PUrw.UPrice/total);
				MatRowPut(PUr,i,PUrw);
			end;
		end;
	return;
end;

global
procedure BPUDClassCost3Do(var record BigPUVc BPUr)
begin
  row BigPUVc BPUrw;
  integer i;
	val total;
	val FInBase;
	
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			total = total + BPUrw.Quant * BPUrw.UPrice;
		end;
		FInBase = BPUr.Cost3;
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			BPUrw.RowCost3 = FInBase * (BPUrw.UPrice/total);
			MatRowPut(BPUr,i,BPUrw);
		end;
		BigPUSumUp(BPUr);
	return;
end;

global
procedure BPUDClassCost4Do(var record BigPUVc BPUr)
begin
  row BigPUVc BPUrw;
  integer i;
	val total;
	val FInBase;
	
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			total = total + BPUrw.Quant * BPUrw.UPrice;
		end;
		FInBase = BPUr.Cost4;
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			BPUrw.RowCost4 = FInBase * (BPUrw.UPrice/total);
			MatRowPut(BPUr,i,BPUrw);
		end;
		BigPUSumUp(BPUr);
	return;
end;

global
procedure BPUDClassCost5Do(var record BigPUVc BPUr)
begin
  row BigPUVc BPUrw;
  integer i;
	val total;
	val FInBase;
	
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			total = total + BPUrw.Quant * BPUrw.UPrice;
		end;
		FInBase = BPUr.Cost5;
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			BPUrw.RowCost5 = FInBase * (BPUrw.UPrice/total);
			MatRowPut(BPUr,i,BPUrw);
		end;
		BigPUSumUp(BPUr);
	return;
end;

global
procedure	BPUDClassShipCostDo(var record BigPUVc BPUr)
begin
  row BigPUVc BPUrw;
  integer i;
	val total;
	val FInBase;
	
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			total = total + BPUrw.Quant * BPUrw.UPrice;
		end;
		if(nonblank(BPUr.CurrencyF)) then begin
			FInBase = MulRateToBase1(BPUr.CurrencyF,BPUr.ShipCost,BPUr.FrRateF,BPUr.ToRateF,BPUr.ToRateF,BPUr.FrRateF,BPUr.ToRateF,SetROundModeD(5));
		end else begin 	FInBase = BPUr.ShipCost; end;
		for(i=0;i<matrowcnt(BPUr);i=i+1) begin
			MatRowGet(BPUr,i,BPUrw);
			BPUrw.ShipCost = FInBase * (BPUrw.UPrice/total);
			MatRowPut(BPUr,i,BPUrw);
		end;
		BigPUSumUp(BPUr);	
	return;
end;

global
procedure	CollectItemsFromDo(var record BigPUVc BPUr)
begin
row BigPUVc BPUrw;
integer wn,i,j,BProw,cnt;
string 255 ordNr;
record POVc POr;
row POVc POrw;
record BPIBrandVc BBr;
record ConsCompBlock CCB;
record INVc INr;
record PosVc Posr;	
val shipcostSum,CustomCostSum,RowCostSum1,RowCostSum2,RowCostSum3,RowCostSum4,RowCostSum5;
roundmode rnd 

rnd = DefaultCurRoundoff;   // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 11:28 02.01.2020
	BlockLoad(CCB);

	BProw = 0;
	
cnt = matrowcnt(BPUr);
	for(j=cnt;j>=0;j=j-1) begin
		MatRowDelete(BPUr,j);
	end;	
	i=0;
	ExtractObj(BPUr.FromOrds,i,ordNr);
	while (nonblank(ordNr)) begin
		POr.SerNr = ordNr;
		if(ReadFirstMain(POr,1,true)) then begin
			for(j=0;j<matrowcnt(POr);j=j+1) begin
			
				matrowget(POr,j,POrw);
				if(POrw.Quant-POrw.Shipd1>0) then begin
					BPUrw.Position = "";
					BPUrw.Location = "";
					if(CCB.OKFlag>0) then begin
						INr.Code = POrw.ArtCode;
						if(readfirstmain(INr,1,true)) then begin
							BBr.Code = INr.BPIBrand;
							if(ReadFirstMain(BBr,1,true)) then begin
								BPUrw.Position = BBr.CWHCode;
								Posr.Code = BBr.CWHCode;
								if(ReadFirstMain(Posr,1,true)) then begin
									BPUrw.Location = Posr.Location;
									if(BProw==0) then begin
										BPUr.Location = Posr.Location;
									end;
								end;
							end;
						end;
					end;
					BPUrw.ShipCost = POrw.ShipCost;
					shipcostSum = shipcostSum + POrw.ShipCost;
					BPUrw.CustomsCost = StringToVal(POrw.CustomsCost,M4Val);
					CustomCostSum = CustomCostSum + StringToVal(POrw.CustomsCost,M4Val);
					BPUrw.RowCost1 = POrw.RowCost1;
					RowCostSum1 = RowCostSum1 + POrw.RowCost1;
					BPUrw.RowCost2 = POrw.RowCost2;
					RowCostSum2 = RowCostSum2 + POrw.RowCost2;
					BPUrw.RowCost3 = POrw.RowCost3;
					RowCostSum3 = RowCostSum3 + POrw.RowCost3;
					BPUrw.RowCost4 = POrw.RowCost4;
					RowCostSum4 = RowCostSum4 + POrw.RowCost4;
					BPUrw.RowCost5 = POrw.RowCost5;
					RowCostSum5 = RowCostSum5 + POrw.RowCost5;
					BPUrw.ArtCode = POrw.ArtCode;
					BPUrw.FromOrdNr = POr.SerNr;
					BPUrw.FromOrdrowNr = j+1;
					BPUrw.VEItemCode = POrw.VEArtCode;
					BPUrw.Quant = POrw.Quant - POrw.Shipd1;
					BPUrw.UPrice = POrw.Price;
					BPUrw.Sum = POrw.Sum;
					BPUrw.ItemConsgType = POrw.ItemConsgType;
					BPUrw.CurrencyItem = POr.CurncyCode;
					BPUrw.Spec = POrw.Spec;
					BPUrw.WeightRow = POrw.WeightRow;
					BPUrw.CaratRow = POrw.CaratRow;
					BPUrw.CaratplacerRow = POrw.CaratplacerRow;
					BPUrw.CostPrice = MulRateToBase1(POr.CurncyCode,POrw.Price,POr.FrRate,POr.ToRateB1,POr.ToRateB2,POr.BaseRate1,POr.BaseRate2,SetROundModeD(3));
					matrowput(BPUr,BProw,BPUrw);
					PUDClassWeightRow(BPUr,BProw);
					PUDClassCaratRow(BPUr,BProw);
					matrowGet(BPUr,BProw,BPUrw);
					matrowput(BPUr,BProw,BPUrw);
					BProw	= BProw + 1;	
				end;	
			end;
		end;
		ExtractObj(BPUr.FromOrds,i,ordNr);
	end;
	BPUr.ShipCost = shipcostSum;
	BPUr.CustomsCost = CustomCostSum;
	BPUr.Cost1 = RowCostSum1;
	BPUr.Cost2 = RowCostSum2;
	BPUr.Cost3 = RowCostSum3;
	BPUr.Cost4 = RowCostSum4;
	BPUr.Cost5 = RowCostSum5;	
	BigPUSumUp(BPUr);
	if(BPUr.Cost2>0)then begin  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 11:38 02.01.2020
		BPUr.Cost2 = Round(BPUr.Cost2,rnd);
		BPUr.ApprovedCost2 = 1;
	end;
return;
end;