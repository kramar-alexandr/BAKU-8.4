external updating function LongInt IVGetExternalTaxRates(var record IVVc,var string);
external function Boolean HasSalesman();
external updating procedure CheckCreateSetDefaultCustomCode(var record IVVc);
external function Boolean IsEnterprise();
external updating function LongInt IVVcSVNFiscalization(Boolean,var record IVVc,var string);
external function Boolean AssignOfficialSerNr();
external function Boolean LegalRecordNumberInRange(string,string,string);
external function string 255 GetLegalInvoiceNrString(row LegalInvNrBlock,string);
external procedure NextM4Number(string,var string);
external function string 255 UpdateOfficialSerNrSerie(Integer,Integer,Integer,string,boolean);
external function Boolean CheckCreditInvTotOnOrigIV(record IVVc,var string,var LongInt);
external function Boolean OfficialSerialNrCanBeBlank(string,string,Integer,string,string,string,Date,Integer,Integer);
external function integer CheckAddressForLocalisation(string,string,string,string,string,string,string,string,string,string,string,var string);
external function string 255 FindTaxAuthIDDosageKey(string,record IVVc);
external function string 255 StripCharacter(string,string);
external function Boolean ReadFirstItem(string,var record INVc,Boolean,Boolean);
external function Boolean IsDigit(string);
external function Boolean IsCapitalLetter(string); 
external function Boolean FindTheUser(var record UserVc);
external function Integer ERecordStatus(string,string,LongInt,string,var string);
external procedure SubCashRows_IVVc(record IVVc,Boolean,var val,var val);
external function Boolean ValidateOfficialSerialNrChronology(string,string,LongInt,Date,var Date);
external function Boolean TestNextOfficialSerialNr_IVVc(row LegalInvNrBlock,string,record IVVc,Boolean);
external procedure GetLegalInvNrRow(string,var row LegalInvNrBlock);
external procedure FindNextIVVcOfficialSerialNr(var record IVVc);
external function Boolean ValidInvoiceDataForVATLaw2(record IVVc,record CUVc,var Integer,var string,var string);
external procedure ExtractObj(string,var Integer,var string);
external function Boolean DisallowFutureDateCheck(Boolean,Date,string,Integer);
external function string 255 CurDrawerCode(string);
external updating procedure UpdateTrans_Stock(record TRVc);
external function Boolean VIVc_PasteVECode(var record VIVc,Integer,Boolean,Boolean,var string);
external function Integer TestCreditNoteTerms(record IVVc,var string);
external function Boolean IVTestCredMan(record IVVc,var Integer);
external updating function Boolean BA_IVMinMarkupWarning(record IVVc,var Integer);
external function string 50 NextLegalSerNr(string,LongInt,Date,string,string,string);
external procedure GetARAcc(string,var string);
external function Integer IVVcRecordCheckRows(record IVVc,record IVVc,record CUVc,record ORVc,record ModuleBlock,record MainStockBlock,record AccBlock,Boolean,Boolean,LongInt,var val);
external function Boolean CanOKStockRecord(var Integer);
external function Boolean DisallowPriceLowerCost_IVVc(record IVVc);
external function Boolean ValidEInvoiceData3(record IVVc,record CUVc,var LongInt,var string,var string);
external function Integer CheckCLInAmount(LongInt,val,val,string);
external updating procedure AddTTrans_IVVc(record TRVc,record IVVc);
external function Integer InString2(string,string);
external function Integer CheckRates(string,val,val,val,val,val,var string);
external procedure GetSerRange(string,LongInt,var LongInt,var LongInt);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external function Boolean RequireOpenSession(string);
external Procedure GetPayType(String,Var Integer);
external procedure IVSumup(var record IVVc,Boolean);
external updating function LongInt PUFromCreditNote(var record IVVc,Boolean);
external function Integer IsUnOKAllowed_IVVc(record IVVc);
external function Boolean CheckPDExists(string);
external function Boolean GetPMgentrans(string);
external function Integer PMCheckType(string,var string,var string);
external function LongInt GetCurUserLastNr(string);
external function Boolean CLInforIVRecordExists(LongInt,string,var LongInt);
external updating function Boolean SaveSim(record SMVc);
external function string 255 CheckTrans(var record TRVc,Integer,Boolean);
external updating procedure SaveTrans(record TRVc);
external function Integer MakeTransFromIV(var record TRVc,var record SMVc,record IVVc,Boolean,Boolean,record IVVc); //Edit***************************Sasha2,15:46 18.03.2015
external function Boolean GetCustAndBal(var record CUVc,var val,var val,Integer,Integer,Integer,Integer,Integer,Integer,var Boolean);
external function Boolean SerNrTestIVVc(LongInt,Date,var Boolean);
external function Integer CheckObjs(string,string,var string);
external function Boolean RecordSupportExists(string,string,LongInt);
external function Boolean Date2Test(string,Date,string,Integer);
external function Integer GetPayDealType(string,var LongInt);
external function Integer CheckVATNrMask(string,string,Integer,var string);
external function Boolean CurncyCodeRegistered(string);
external function Boolean IsControlAccount(string,Boolean,Boolean);
external function Integer CashSerNumberTest(string,val,string,LongInt,var Boolean);
external function Boolean ExistStockTrans(string,Date,var Integer,var string,string,LongInt,record MainStockBlock);
external procedure IVUpdateFIFO(record IVVc,Boolean,var record IVVc,integer); //Edit***************************Sasha2,11:53 18.03.2015
external function Integer GetCreditedInvoiceType(record IVVc);
external function Boolean IsSessionOpen(string,string,Date,Time);
external function boolean ShouldSendArgEinvoice(record IVVc);
external function boolean ArgEInvoiceBeingSentRemote(longint,string,Boolean);
external function boolean RoyaltyRecordExistsForCN(record IVVc);
external function Boolean HasSLIntegratedWithNL();
external function Boolean HasIntegratedNL();
external updating function Boolean DoXMLExport_IVVc(var record IVVc);
external function boolean CompanyIsJWLikeCompany(Integer);
external function string 255 SaboPromotion(var record IVVc,string); //Edit***************************Sasha2,13:19 01.06.2016
external function string 255 Acia50ForSecondBrandItem(var record IVVc,string); // Edit ************************** BPI Ukraine - KramarAlexandr - 02, 20 08 2019 y. at 11:06:34 AM
external function val AbsoluteVal(val); // Edit ************************** Monday, 13 June 2016 13:36:12
external function string 255 GetCashBackSpecialItemCode(); //Edit***************************Sasha2,11:37 14.08.2017
external function string 20 GetCashBackLoyProgramByCardPrefix(string); //Edit***************************Sasha2,11:37 14.08.2017
external procedure IVSumup(var record IVVc,Boolean); //Edit***************************Sasha2,11:49 14.08.2017
external procedure CalculateIVVcCashbackPoints(var record IVVc,Boolean); //Edit***************************Sasha2,13:23 14.08.2017
external function Boolean DenyOperationsWithBlockedCustomer(record CUVc,string); //Edit***************************Sasha2,11:15 08.09.2017
external updating procedure SendIVVisitToCRM(var record IVVc);// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 18 September 2018 17:29:30
external updating procedure SendUpdateIVVisitToCRM(var record IVVc);// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 25 08 2020 y. at 4:52:37 PM
external function Boolean IVDchrsum(var record IVVc,Integer);// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 25 April 2019 14:27:54
external procedure IVDchsum(var record IVVc,Integer);// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 25 April 2019 14:27:54
external function Boolean GetFlayerObjects(record IVVc);// Edit ************************** BPI Ukraine - KramarAlexandr - Friday, 3 May 2019 10:14:28
external function string 255 DelDublicates(string);// Edit ************************** Tuesday, 31 October 2017 17:47:41
remote function Boolean ECSHOKFlag(record IVVc, record IVVc);
external procedure LogProcTime(string,longint);
external updating procedure SendLoyaltyCardToCRM(var record LoyaltyCardVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger13:07 12.09.2018



SetLangMode(LangRussian,"RUS",0);

function Boolean CheckIfNextLegalSerNr(LongInt curivnr,string OfficialSerNr,Date invdate,record CUVc CUr)
begin
  Boolean res;
  Boolean testf;
  record LegalInvNrBlock LINrb;
  row LegalInvNrBlock LINrbrw;
  Integer i,rwcnt;
  string 255 tstr;
  record OffSerNrIVVc OffSNIVr;
  LongInt offnr;

  OffSNIVr.IVNr = curivnr;
  if (ReadFirstKey("MainKey",OffSNIVr,1,true)) then begin
    if (OffSNIVr.OfficialSerNr==OfficialSerNr) then begin
      res = true;
      goto LCheckIfNextLegalSerNr;
    end;
  end;
  res = false;
  BlockLoad(LINrb);
  rwcnt = MatRowCnt(LINrb);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(LINrb,i,LINrbrw);
    testf = true;
    if (invdate<LINrbrw.PurchDate) then begin testf = false; end;
    if (nonblank(LINrbrw.CClass)) then begin
      if (nonblank(CUr.Classification)) then begin
        if (SetInSet(LINrbrw.CClass,CUr.Classification)==false) then begin testf = false; end;
      end;
    end;
    if (testf) then begin
/*    
      tstr = NextLegalSerNr(curivnr,invdate,LINrbrw.Serie,LINrbrw.TSerStart,LINrbrw.TSerEnd);
      if (Left(OfficialSerNr,len(LINrbrw.Serie))==LINrbrw.Serie) then begin
        if (tstr==OfficialSerNr) then begin
          res = true;
          goto LCheckIfNextLegalSerNr;
        end;
      end;
*/      
      if (Left(OfficialSerNr,len(LINrbrw.Serie))==LINrbrw.Serie) then begin
        offnr = StringToLongInt(Right(OfficialSerNr,len(OfficialSerNr)-len(LINrbrw.Serie)));
        if (offnr>=StringToLongInt(LINrbrw.TSerStart)) and (offnr<=StringToLongInt(LINrbrw.TSerEnd)) then begin
          OffSNIVr.IVNr = OfficialSerNr;
          if (ReadFirstKey("MainKey",OffSNIVr,1,true)==false) then begin
            res = true;
            goto LCheckIfNextLegalSerNr;
          end;
        end;
      end;
    end;
  end;
LCheckIfNextLegalSerNr:;  
  CheckIfNextLegalSerNr = res;
  return;
end;

updating function Integer ConnectCreditNotetoVI(var record IVVc IVr)
begin
  Integer res;
  record VIVc VIr;
  record AccBlock ARb;
  string 255 vewarn;

  if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) and (IVr.CredInv>0) then begin
    BlockLoad(ARb);
    if (ARb.ConnectCreditNotetoVI!=0) then begin
      res = 1086;
      RecordNew(VIr);
      VIr.VECode = IVr.CustCode;
      VIVc_PasteVECode(VIr,0,false,true,vewarn);
      VIr.VEName = IVr.Addr0;
      VIr.CurncyCode = IVr.CurncyCode;
      VIr.FrRate = IVr.FrRate;
      VIr.BaseRate1 = IVr.BaseRate1;
      VIr.BaseRate2 = IVr.BaseRate2;
      VIr.ToRateB1 = IVr.ToRateB1;
      VIr.ToRateB2 = IVr.ToRateB2;
      VIr.SerNr = NextSerNr("VIVc",VIr.TransDate,-1,false,"");            
      VIr.OKFlag = 1;
      if (RecordStore(VIr,false)) then begin
        IVr.VINr = VIr.SerNr;
        res = 0;
      end;
    end;
  end;
  ConnectCreditNotetoVI = res;
  return; 
end;

global
function Integer VerifySalesmen(string salesmen,var string salesman)
begin
  Integer res;
  Integer pos;
  record UserVc Userr;
  
  res = 0;
  if (HasSalesman==false) then begin
    goto LVerifySalesmen;
  end;
  ExtractObj(salesmen,pos,salesman);
  while (nonblank(salesman)) begin
    Userr.Code = salesman;
    if (FindTheUser(Userr)==false) then begin
      res = 20170;
      goto LVerifySalesmen;
    end;
    if (Userr.TerminatedFlag!=0) then begin
      res = 22070;
      goto LVerifySalesmen;
    end;
    if (Userr.Closed!=0) then begin
      res = 22070;
      goto LVerifySalesmen;
    end;
    ExtractObj(salesmen,pos,salesman);
  end;
LVerifySalesmen:;  
  VerifySalesmen = res;  
  return; 
end;

function Boolean CheckGlobalTransportNr(string GlobalTransportNr)
begin
  Boolean res;
  Array string 255 aGlobalTransportNr;
  Integer lencnt,i,arrcnt,slashcnt,spacecnt,charsafterslash;
  logtext(0,"CheckGlobalTransportNr stert");
  res = true;
  lencnt = len(GlobalTransportNr);
  arrcnt = 0;
  slashcnt = 0;
  spacecnt = 0;
  charsafterslash = 0;
  for (i=0;i<lencnt;i=i+1) begin
    aGlobalTransportNr[arrcnt] = Mid(GlobalTransportNr,i,1);
    if (slashcnt==1) then begin
      charsafterslash = 1;
    end;
    if (IsDigit(aGlobalTransportNr[arrcnt])==false and (IsCapitalLetter(aGlobalTransportNr[arrcnt])==false)) then begin
      if (aGlobalTransportNr[arrcnt]=="/") then begin
        slashcnt = slashcnt + 1;
        if (slashcnt>1) then begin
          res = false;
          goto LEnd;
        end;
      end;
      if (aGlobalTransportNr[arrcnt]==" ") then begin
        if (i==0) then begin 
          res = false;
          goto LEnd;
        end;
        if (slashcnt==1) then begin 
          res = false;
          goto LEnd;
        end;
        spacecnt = spacecnt + 1;
        if (spacecnt>1) then begin
          res = false;
          goto LEnd;
        end;
      end;
    end;
    arrcnt = arrcnt + 1;
  end;
  if (slashcnt==0 or charsafterslash==0) then begin
    res = false;
  end;
LEnd:;
  
  CheckGlobalTransportNr = res;
	 logtext(0,"CheckGlobalTransportNr end");
  return;
end;

global
updating function LongInt IVVcRecordCheck(record IVVc IVp,record IVVc IV2p,LongInt stat,LongInt long4)
begin
  LongInt res;
  row IVVc IVrw, IVMyrw,tIVrw;
  row IVVc IV2rw;
  record IVVc locIVr,tIVr,offIVr;
  record CUVc CUr;
  record CUVc BranchCUr;
  record AccVc Accr;
  record TRVc TRr;
  record CreditLimitBlock CLb;
  record SRBlock SRRec;
  record AccBlock ARAccb;
  record MainStockBlock MSb;
  record IVOfficialSerBlock IOSTr;
  record MainCLBlock MCLb;
  record ORVc ORr;
  Boolean testf,test2f,FiscalPrf,nousersernr;
  Boolean transf,gentrans,check,unokf,controlaccf;
  Boolean lightFlag;
  Integer errcode,j,cnt;
  Integer i,rwcnt,cashres,creditedinvtype;
  LongInt oldnr,newnr,sernr;
  val bal,limit,prev,quant,prevsn;
  val prepaysum,t;
  string 255 tstr,tstr2,location,errstr,oldOfficialSerNr,c,OffserNr,curobj,mainobj,compstr,comp;
  LongInt dummyl,errcode2;  
  record TRVc gTRp;
  record SMVc gSMp;
  LongInt clin,l;
  Integer curcomp,cntvch,rwcnt2;
  val cash;
  record CreditCardVc CreditCardr;
  LongInt serstart,serend,mtrwcnt;
  record LegalInvNrBlock LINrb;
  row LegalInvNrBlock LINrbrw;
  row LegalInvNrBlock LINrb2rw;
  record PDVc PDr;
  record ModuleBlock Ob;
  record ARVc ARr;
  Boolean norminv,credinv,cashinv,giftf;
  transaction string 255 gRuniningMaint;
  record LoyaltyCardVc LoyaltyCardr;
  Date td;
  val sum4,basesum4;
  Boolean limitdaysf;
  record InternetEnablerBlock IEb;
  record EInvoiceBlock EIb;
  record CashierDefBlock CDb;
  record INVc INr;
  transaction Boolean gDoNotTestIfRecordExists;
  record BrazilEInvTypeVc BEInvTyper;
  record CYBlock CYb;
	record MaxNumGiftBlock MNGb;
  Boolean TouchScreenFinishButtonf,stckItmflg;
  record Uservc USr;// Edit ************************** Friday, 12 October 2012 11:47:58
  roundmode rnd;// Edit ************************** Friday, 15 March 2013 11:35:23
  record LocationVc Locationr; // edited by BPI
  record IVVc fifocurIVr; //Edit***************************Sasha2,11:34 18.03.2015
  record POSCurrenciesBlock POSCurblock; // edited by BPI
  string 5 posCurcncy; // edited by BPI
  val delta;// Edit ************************** Monday, 13 June 2016 13:41:00
  string 20 newCashBackCardNr; //Edit***************************Sasha2,11:35 14.08.2017
 	record GlobalGiftVaucherVc GGVr;// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 30 January 2018 14:56:44
 	row GlobalGiftVaucherVc GGVrw;// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 30 January 2018 14:56:44
	record GCSVc GCSr; //Edit_________________ABR 16:15 24.10.18
	boolean gfound,TrHs;
	integer IVOFFCnt, pos;
	record ObjVc OBjr;
  record UsedRebateCardsVc URCr;// Edit ************************** BPI Ukraine - KramarAlexandr - Wednesday, 8 May 2019 16:44:30
  record SHVc SHr;
	record RLinkVc RLr;
	boolean TrHs3, testf2;
	record VaucherVc Vr;
	record VaucherProgVc VPr;
	longint curtick;
	boolean checkVaucher, noFobExItemBrandf;
	string 255 warningText;
	record BrandsBanDateBlock BBBr;
	row BrandsBanDateBlock BBBrw;
	
	curtick = getcurtick();
	
  logtext(0,"IVVcRecordCheck" & IVp.SerNr);
  
  if(matrowcnt(IVp)==0 and IVp.SerNr<0)then begin
  	logtext(0,"Start Check IV V&B Receipt   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  " & IVp.SerNr);
  end;
  
	
	if(nonblank(IVp.Objects) and IVp.ECOMMERCEOrdf!=1 and currentcompany!=28)then begin
		pos = 0;
		ExtractObj(IVp.Objects,pos,curobj);
		while (NonBlank(curobj)) begin
			OBjr.Code = curobj;
			if (ReadFirstMain(OBjr,1,true) and OBjr.OTCode!="STORE") then begin
				logtext(0,"OBj OTCode - " & OBjr.OTCode);
				if(blank(mainobj))then begin
					mainobj = curobj;
				end else begin
					mainobj = mainobj & "," & curobj;
				end;
			end;
			ExtractObj(IVp.Objects,pos,curobj);
		end;	
		Locationr.Code = IVp.Location;
		if(ReadFirstMain(Locationr,1,true))then begin
			if(blank(mainobj))then begin
				mainobj = Locationr.Objects;
			end else begin
				mainobj = mainobj & "," & Locationr.Objects;
			end;
		end;
		IVp.Objects = mainobj;
	end;
	
	
	
  Locationr.Code = IVp.Location;
	if(readfirstmain(Locationr,1,true))then begin// Edit ************************** Wednesday, 24 September 2014 15:41:19
		if(blank(IVp.Objects))then begin
			IVp.Objects = Locationr.Objects;// Edit ************************** Wednesday, 17 September 2014 14:48:31
		end else begin
			if(!setinset(Locationr.Objects,IVp.Objects))then begin
				IVp.Objects = IVp.Objects & "," & Locationr.Objects;// Edit ************************** Wednesday, 17 September 2014 14:48:30
			end;
		end;
	end;
	IVp.Objects = DelDublicates(IVp.Objects);
	if(currentcompany==29 and nonblank(IVp.OfficialSerNr))then begin
		OffserNr = IVp.OfficialSerNr;
		offIVr.OfficialSerNr = IVp.OfficialSerNr;
		if(ReadFirstKey("OfficialSerNr",offIVr,1,true) and offIVr.SerNr!=IVp.SerNr)then begin
			testf = true;
			IVOFFCnt = 1;
			while (testf) begin
				offIVr.OfficialSerNr = IVp.CustOrdNr & "-" & IVOFFCnt;
				if(ReadFirstKey("OfficialSerNr",offIVr,1,true) and offIVr.SerNr!=IVp.SerNr)then begin
					IVOFFCnt = IVOFFCnt + 1;
				end else begin
					testf = false;
					IVp.OfficialSerNr = IVp.CustOrdNr & "-" & IVOFFCnt;
				end;
			end;
		end;
	end;
	curcomp = currentcompany;
	
	
	
	
	
	if(CurrentCompany!=18)then begin
		for (i=0;i<matrowcnt(IVp);i=i+1) begin
			matrowget(IVp,i,IVrw); 
			matrowget(IVp,0,tIVrw);
			if (IVrw.Quant>0 and tIVrw.Quant<0 or IVrw.Quant<0 and tIVrw.Quant>0) then begin
				RecordCheckError(36409,"",i,"Quant");      
				res = -1; 
				goto L999;
			end;
		end;
		if(IVp.ECOMMERCEOrdf!=1 and IVp.CustCode!="FOBE_COMMERCE" and left(IVp.CustCode,3)=="FOB")then begin
			for (i=0;i<matrowcnt(IVp);i=i+1) begin
				matrowget(IVp,i,IVrw); 
				if(nonblank(IVrw.ArtCode) and IVrw.Quant>0)then begin
					INr.Code = IVrw.ArtCode;
					if(ReadFirstMain(INr,1,true))then begin
						if(SetCompany(18,false))then begin 
							blockload(BBBr);
						end;
						resetcompany(curcomp);
						for (j=0;j<matrowcnt(BBBr);j=j+1)begin
							matrowget(BBBr,j,BBBrw);
							if(INr.BPIBrand==BBBrw.Brand and BBBrw.StartBanDate<=IVp.TransDate and nonblank(INr.BPIBrand)) then begin noFobExItemBrandf = true; end;
						end;
					
						// switch (INr.BPIBrand) begin
						// // not exchangeable brands (Start)_____________________________________________________________________________________________
						
						
							// case "BRND0074": noFobExItemBrandf = true;
							// case "BRND0039": noFobExItemBrandf = true;
							// case "BRND0152": noFobExItemBrandf = true;
							// case "BRND0117": noFobExItemBrandf = true;
							// case "BRND0025": noFobExItemBrandf = true;
							// case "BRND0073": noFobExItemBrandf = true;
							// case "BRND0079": noFobExItemBrandf = true;
							// case "BRND0093": noFobExItemBrandf = true;
							// case "BRND0138": noFobExItemBrandf = true;
							
							
						// // not exchangeable brands (Finish)____________________________________________________________________________________________
						// end;
					end;
					
					if(IVp.CustCode=="FOB_PD")then begin
						noFobExItemBrandf = false;
					end;
					
					if(noFobExItemBrandf)then begin
						RecordCheckError(36324,"",i,"ArtCode");      
						res = -1; 
						goto L999;
					end;
				end;
			end;
		end;
	end;
	
	
  if (long4==3) then begin TouchScreenFinishButtonf = true; end;
  res = 0;
  RECORDNEW(fifocurIVr); //Edit***************************Sasha2,11:49 18.03.2015
  curcomp = CurrentCompany;    
  oldnr = IVp.SerNr;
  oldOfficialSerNr = IVp.OfficialSerNr;
  if (IVp.OKFlag==0) then begin
    if (stat==Rs_update) then begin
      if (IV2p.OKFlag==1) then begin unokf = true; end;
    end;
  end;
  // Edit Start ---------------------------------------------- Edit Start
	//Wednesday, 31 January 2018 09:52:30
	
	if(IVp.OKFlag==1 and IV2p.OKFlag==1 and IVp.TaxFree==1 and IV2p.TaxFree==0)then begin
		IVp.TaxFree = 0;
		RecordCheckError(36221," Галочку TaxFree снято!",-1,"TaxFree");      
		res = -1; 
		goto L999;
	end;
	if(IVp.OKFlag==1 and IV2p.OKFlag==1 and IVp.TaxFree==0 and IV2p.TaxFree==1)then begin
		IVp.TaxFree = 1;
		RecordCheckError(36221," Галочку TaxFree не снято!",-1,"TaxFree");      
		res = -1; 
		goto L999;
	end;
	
	if(nonblank(IVp.VaucherCode)) then begin // Edit_________________ABR 02.10.2019
		checkVaucher = true;
		warningText = "";
		Vr.BarCode = IVp.VaucherCode;
		if(ReadFIrstMain(Vr,1,true)) then begin
			if(Vr.Closed!=0) then begin
				checkVaucher = false;
				warningText = " закрыт";
			end;
			if(checkVaucher) then begin
				if(nonblank(Vr.Locations)) then begin
					if(!SetInSet(IVp.Location,Vr.Locations)) then begin
						checkVaucher = false;
						warningText = " не разрешен для данного склада";
					end;
				end else begin
					VPr.Code = Vr.VaucherProgCode;
					if(ReadFirstMain(VPr,1,true)) then begin
						if(nonblank(VPr.Locations)) then begin
							if(!SetInSet(IVp.Location,VPr.Locations)) then begin
								checkVaucher = false;
								warningText = " не разрешен для данного склада";
							end;
						end;
						if(nonblank(VPr.ExLocations)) then begin
							if(SetInSet(IVp.Location,VPr.ExLocations)) then begin
								checkVaucher = false;
								warningText = " не разрешен для данного склада";
							end;
						end;
					end;
				end;
			end;	
			if(checkVaucher) then begin
				if(nonblank(Vr.StartDate) and nonblank(Vr.EndDate)) then begin
					if(IVp.InvDate<Vr.StartDate or IVp.InvDate>Vr.EndDate) then begin
						checkVaucher = false;
						warningText = " не соответствует времени счет/фактуры";
					end;
				end else begin
					VPr.Code = Vr.VaucherProgCode;
					if(ReadFirstMain(VPr,1,true)) then begin
						if(nonblank(VPr.StartDate) and nonblank(VPr.EndDate)) then begin
							if(IVp.InvDate<VPr.StartDate or IVp.InvDate>VPr.EndDate) then begin
								checkVaucher = false;
								warningText = " не соответствует времени счет/фактуры";
							end;
						end;	
					end;
				end;
			end;
		end else begin
			checkVaucher = false;
			warningText = " не существует";
		end;
		if(!checkVaucher) then begin
			RecordCheckError(36300,warningText,-1,"VaucherCode");      
			res = -1; 
			goto L999;
		end;
	end;
	
	
  rwcnt = matrowcnt(IVp);
	For(i=0;i<rwcnt;i=i+1) begin
		matrowget(IVp,i,IVrw);
		if(IVrw.ArtCode=="GLOBALGIFTCARD")then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 30 January 2018 14:44:12
			
			if(IVp.CurncyCode!="AZN")then begin
				RecordCheckError(35123,"",i,"SerialNr");      
				res = -1; 
				goto L99;
			end;
			if(blank(IVrw.SerialNr))then begin
				RecordCheckError(35117,"",i,"SerialNr");      
				res = -1; 
				goto L99;
			end;
			GGVr.BarCode = IVrw.SerialNr;
			GGVr.Program = "FIRST";
			if(readfirstkey("BarCode",GGVr,2,true))then begin
				if(GGVr.OnceUsed==1)then begin
					testf2 = false;
					pos = 0;
					compstr = GGVr.Locations;
					ExtractObj(compstr,pos,comp);
					while (nonblank(comp)) begin
						if(comp==IVp.Location)then begin
							testf2 = true;
						end;
						ExtractObj(compstr,pos,comp);
					end;
					if(!testf2)then begin
						RecordCheckError(36298,"",i,"SerialNr");      
						res = -1; 
						goto L99;
					end;
				end;
				if(GGVr.Closed==1 and !(GGVr.OnceUsed==1 and IVp.OKFlag==0 and IV2p.OKFlag==1) and (IVp.OKFlag==1 and IV2p.OKFlag==0))then begin
					RecordCheckError(35118,"",i,"SerialNr");      
					res = -1; 
					goto L99;
				end;
				if(nonblankdate(GGVr.StartDate) and nonblankdate(GGVr.EndDate))then begin
					if(GGVr.StartDate>IVp.InvDate or GGVr.EndDate<IVp.InvDate)then begin
						RecordCheckError(35119,"",i,"SerialNr");      
						res = -1; 
						goto L99;
					end;
				end;
				if(stat==Rs_update)then begin
					if(IVp.OKFlag==0 and IV2p.OKFlag>0)then begin
						For(j=0;j<matrowcnt(GGVr);j=j+1) begin
							matrowget(GGVr,j,GGVrw);
							if(GGVrw.Sum<0)then begin
								RecordCheckError(35124,"",i,"SerialNr");      
								res = -1; 
								goto L99;
							end;
						end; 
					end;
				end;
			end else begin
				RecordCheckError(35120,"",i,"SerialNr");      
				res = -1; 
				goto L99;
			end;			
		end;
		if(IVrw.IVForRetNr>-1) then begin
			locIVr.SerNr=IVrw.IVForRetNr;
			if(ReadFIrstMain(locIVr,1,true)) then begin 
				if(IVp.CurncyCode != locIVr.CurncyCode) then begin
					RecordCheckError(36207,"",i,"IVForRetNr");      
					res = -1; 
					goto L99;
				end;
			end;
		end;	
		
		if(IVrw.stp==kInvoiceRowTypeLoyaltyPointsPayment)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Friday, 3 May 2019 10:12:27
			if(GetFlayerObjects(IVp))then begin
				RecordCheckError(36230,"",-1,"Objects");     
				 
				res = -1; 
				goto L99;
			end;
		end;
		
		if(IVrw.stp==kInvoiceRowTypeCreditCardPayment)then begin
			if(IVrw.PayMode=="G1")then begin
				gfound = false;
				For(j=0;j<rwcnt;j=j+1) begin
					matrowget(IVp,j,IV2rw);
					if(IV2rw.ArtCode=="GLOBALGIFTCARD")then begin
						gfound = true;	  			
					end;
				end; 
				if(gfound==false)then begin
					RecordCheckError(35140,"",i,"SerialNr");      
					res = -1; 
					goto L99;
				end;
			end;
			if(IVrw.Comment=="FIRST")then begin
				if(IVrw.Comment=="FIRST" and blank(IVrw.SerialNr))then begin 
					RecordCheckError(35117,"",i,"SerialNr");      
					res = -1; 
					goto L99;
				end;
				
				/*if(IVp.CurncyCode!="AZN")then begin
					RecordCheckError(35123,"",i,"SerialNr");      
					res = -1; 
					goto L99;
				end;*/
				
				GGVr.BarCode = IVrw.SerialNr;
				GGVr.Program = "FIRST";
				if(readfirstkey("BarCode",GGVr,2,true))then begin
					if(GGVr.Closed==1 and !(GGVr.OnceUsed==1 and IVp.OKFlag==0 and IV2p.OKFlag==1) and (IVp.OKFlag==1 and IV2p.OKFlag==0))then begin
						RecordCheckError(35118," " & GGVr.BarCode,i,"SerialNr");      
						res = -1; 
						goto L99;
					end;
					if(nonblankdate(GGVr.StartDate) and nonblankdate(GGVr.EndDate))then begin
						if(GGVr.StartDate>IVp.InvDate or GGVr.EndDate<IVp.InvDate)then begin
							RecordCheckError(35119,"",i,"SerialNr");      
							res = -1; 
							goto L99;
						end;
					end;
					if(stat==Rs_insert)then begin
						if(IVrw.Sum>GGVr.Bal)then begin
							RecordCheckError(35122,"",i,"SerialNr");      
							res = -1; 
							goto L99;
						end;
					end;
					if(stat==Rs_update)then begin
						if(IVp.OKFlag>0 and IV2p.OKFlag==0)then begin
							if(IVrw.Sum>GGVr.Bal)then begin
								RecordCheckError(35122,"",i,"SerialNr");      
								res = -1; 
								goto L99;
							end;
						end;
					end;
				end else begin
					RecordCheckError(35120,"",i,"SerialNr");      
					res = -1; 
					goto L99;
				end;
				
				/*For(j=0;j<mtrwcntrw;j=j+1) begin
	  			matrowget(IVr,j,IV2rw);
	  			if(IVrw.ArtCode=="GLOBALGIFTCARD")then begin
	  				RecordCheckError(35122,"",i,"SerialNr");      
						res = -1; 
						goto L99;
	  			
	  			end;
				end; */
				
			end;
			
		end;
	end;
	
	
	
	// Edit End ---------------------------------------------- Edit End
	
  if (unokf) then begin
    errcode = IsUnOKAllowed_IVVc(IVp);
    if (errcode!=0) then begin
      RecordCheckError(errcode,"",-1,"TransDate");      
      res = -1; 
    end;
    goto L99;
  end;
  if ((ProgramType==typFirstOffice) or 
      (ProgramType==typFirstOfficeSmall) 
/* we want all checks to be done for books
      (ProgramType==typBooks) or 
      (ProgramType==typBooksPro) or 
      (ProgramType==typBooksProAdv) or 
      (ProgramType==typBooksJobCost) or 
      (ProgramType==typBooksAcc) or 
      (ProgramType==typBooksPOS)*/) then begin //?? CHECKBOOKSFUNC
    lightFlag = true;
  end;  
  if (long4>0) then begin
    check = true;
  end else begin
    check = false;
  end;
  if (stat==Rs_update) then begin
    if (IVp.SerNr<=0) and (IV2p.OKFlag==0) then begin
      IVp.SerNr = IV2p.SerNr;
    end;
  end;    
  gentrans = true;
  if ((IV2p.OKFlag==1) and (stat==Rs_update)) then begin goto L999; end;//?  
  transf = false;
  if ((IVp.OKFlag==1) or (IVp.OKFlag==6)) then begin
    if (stat==Rs_insert) then begin transf = true; end;
    if (stat==Rs_update) then begin
      if (IV2p.OKFlag==0) then begin transf = true; end;
    end;  
  end;
  Acia50ForSecondBrandItem(IVp,"check");// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 20 08 2019 y. at 11:07:25 AM
  /*tstr = SaboPromotion(IVp,"check"); // edited by BPI {
  if (NonBlank(tstr)) then begin
    RecordCheckError(15093,". " & tstr,-1,"Sum4");      
    res = -1; 
    goto L99;
  end; // edited by BPI }*/
	
	if(currentcompany==28)then begin
		if (IVp.OKFlag==1) then begin
			if (IV2p.OKFlag==0) then begin  end;
		end;
	end;
	
	

  BlockLoad(ARAccb);
  BlockLoad(MSb);
  BlockLoad(SRRec);
  BlockLoad(CLb);
  BlockLoad(MCLb);
  BlockLoad(Ob);
  BlockLoad(CDb);
  BlockLoad(CYb);
  BlockLoad(POSCurblock);//Edit----------------------Dima  04.06.2015
	BlockLoad(MNGb); //Edit_________________ABR 22.10.18 10:57
  if (check) then begin  
    switch (stat) begin
      case Rs_update:
        if (IVp.OKFlag!=0) and (IV2p.OKFlag==0) then begin
			IVp.RegDate = CurrentDate;
			IVp.RegTime = CurrentTime;
        end;
      otherwise
        if (IVp.OKFlag!=0) then begin
          IVp.RegDate = CurrentDate;
          IVp.RegTime = CurrentTime;
        end;
    end;
  end;
  if (IsStandardProduct) then begin 
    if (blank(IVp.CustCode)) then begin
      CheckCreateSetDefaultCustomCode(IVp);  
    end; 
  end; 
  testf = true;
  if (blank(IVp.CustCode)) then begin
    if (IsStandardProduct) then begin
      if (IVp.OKFlag!=0) then begin
        if (HasLocalization("PRT")==false) then begin
          testf = false;
        end;
      end else begin
        testf = false;
      end;
    end;
  end else begin
    testf = false;
  end;
  if (testf) then begin
    RecordCheckError(1125,"",-1,"CustCode");      
    res = -1; 
    goto L99;
  end;
  if (check) then begin  
  if (CheckPDExists(IVp.PayDeal)==false) then begin
    RecordCheckError(1256,"",-1,"PayDeal");      
    res = -1;
    goto L99;        
  end; 
    
  // Edit Start ---------------------------------------------- Edit Start
	//Wednesday, 3 December 2014 17:29:08
	
 if(stat==Rs_update)then begin
  	if(IV2p.OKFlag==0 or (IVp.OKFlag==0 and IV2p.OKFlag==1))then begin
			rwcnt = matrowcnt(IVp);
			For(i=0;i<rwcnt;i=i+1) begin
				matrowget(IVp,i,IVrw);
				if(IVrw.stp==kInvoiceRowTypeNormal)then begin
					if(IVrw.Quant<0)then begin
						IVrw.SalesAcc = ARAccb.CredDomSalesAcc;
						matrowput(IVp,i,IVrw);
					end;
					if(blank(IVp.Location))then begin 
						Locationr.Code = IVrw.Location;
						if(ReadFIrstMain(Locationr,1,true))then begin end;
					end;
					if(IVp.UpdStockFlag==1)then begin
						if(blank(IVrw.Location) and blank(IVp.Location))then begin
							RecordCheckError(31006,"Не не может быть пустым!",-1,"Location");      
							res = -1; 
							goto L99;	
						end;
					end;
					if(currentcompany==28 and IVp.UpdStockFlag==1 and Locationr.RequirePos==1 and blank(IVrw.PosCode))then begin
						RecordCheckError(31006,"Не не может быть пустым!",i,"PosCode");      
						res = -1; 
						goto L99;	
					end;
				end;
			end; 
		end;
	end;
		
	if(stat==Rs_insert)then begin
		rwcnt = matrowcnt(IVp);
		For(i=0;i<rwcnt;i=i+1) begin
			matrowget(IVp,i,IVrw);
			if(IVrw.stp==kInvoiceRowTypeNormal)then begin
				if(IVrw.Quant<0)then begin
					IVrw.SalesAcc = ARAccb.CredDomSalesAcc;
					matrowput(IVp,i,IVrw);
				end;
				if(blank(IVp.Location))then begin 
					Locationr.Code = IVrw.Location;
					if(ReadFIrstMain(Locationr,1,true))then begin end;
				end;
				if(currentcompany==28 and IVp.UpdStockFlag==1 and Locationr.RequirePos==1 and blank(IVrw.PosCode))then begin
					RecordCheckError(31006,"Не может быть пустым!",i,"PosCode");      
					res = -1; 
					goto L99;	
				end;
			end;
		end; 
	end;
  
	// Edit End ---------------------------------------------- Edit End
  
  if (IVp.PayDate<IVp.InvDate) then begin
    RecordCheckError(22118,": " & USetStr(7801),-1,"PayDate");      
    res = -1; 
    goto L99;
  end;  
  if (CDb.RequireReturnReason!=0) then begin
    if (IVp.OKFlag!=0) and (IVp.Sum4<0) then begin
      if (blank(IVp.InvComment)) then begin
        RecordCheckError(21350,"",-1,"InvComment");      
        res = -1;
        goto L99;
      end;
    end;
  end;
  if (IVp.InvType==kInvoiceTypeEmployee) then begin
    RecordCheckError(1958,"",-1,"PayDeal");      
    res = -1;
    goto L99;        
  end;
  if (MCLb.CashCollection!=0) then begin
    if (CLInforIVRecordExists(IVp.SerNr,"IVVc",clin)) then begin
      errcode = CheckCLInAmount(clin,IVp.Sum4,IVp.BaseSum4,IVp.CurncyCode);
      if (errcode!=0) then begin
        RecordCheckError(errcode,clin,-1,"Sum4");      
        res = -1;
        goto L99;        
      end;
    end;  
    if (IVp.InvType==kInvoiceTypeCash or IVp.InvType==kInvoiceTypeCashInvoiceReceiptPRT) then begin
      if (MCLb.PMControl!=0) then begin
        if (CheckPDExists(IVp.PayDeal)) then begin
          RecordCheckError(1277,"",-1,"PayDeal");      
          res = -1;
          goto L99;        
        end; 
        if (PMCheckType(IVp.PayDeal,tstr,tstr)==5) then begin
          if (GetPMgentrans(IVp.PayDeal)) then begin
            RecordCheckError(1277,"",-1,"PayDeal");      
            res = -1;
            goto L99;        
          end;
        end;
      end;
    end;
/*        
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      if (GetCreditedInvoiceType(IVp)==2) then begin
        MessageBox(2076,"");
      end;
    end;    
*/    
  end;  
  end;  
  if (check) then begin  
  if (IVp.OrderNr>0) then begin
    ORr.SerNr = IVp.OrderNr;
    ReadFIrstMain(ORr,1,true);
  end;
  if (IVp.InvType==kInvoiceTypeDownpayment) then begin
    PDr.Code = IVp.PayDeal;
    if (ReadFirstMain(PDr,1,true)) then begin
      if (PDr.PDType==kInvoiceTypeCash or PDr.PDType==kInvoiceTypeCashInvoiceReceiptPRT) then begin
        RecordCheckError(1958,"",-1,"PayDeal");      
        res = -1;
        goto L99;        
      end;  
    end;
    if (IVp.OrderNr>0) then begin
//        if (((ORr.DownPaySent-ORr.DownPayRedcd) + IVp.Sum4 - IV2p.Sum4)>ORr.Sum4) then begin
      if (ORr.Sum4-((ORr.DownPaySent-ORr.DownPayRedcd) - IV2p.Sum4)<0 and (currentcompany!=28 and ORr.Sum4-ORr.DownPaySent>=0)) then begin
        RecordCheckError(20406,ORr.Sum4-((ORr.DownPaySent-ORr.DownPayRedcd) - IV2p.Sum4),-1,"Sum4");  
        res = -1;
        goto L99;
      end;
    end;
  end;
  end;
  oldnr = IVp.SerNr;
  if (check) then begin  
    /*GetPayType(IVp.PayDeal,i);  // Edit ************************** Thursday, 4 December 2014 09:27:02  
    if (i==3) then begin      
      if blank(IVp.CreditCard) then begin
        RecordCheckError(1058,IVp.CreditCard,-1,"CreditCard");  
        res = -1;
        goto L99;
      end else begin
        CreditCardr.CreditCardNr= IVp.CreditCard;
        if not ReadFirstMain(CreditCardr,1,true) then begin
          RecordCheckError(1058,IVp.CreditCard,-1,"CreditCard");  
          res = -1;
          goto L99;
        end;
      end;
    end;*/ // Edit ************************** Thursday, 4 December 2014 09:27:02  
  end;
  rwcnt = MatRowCnt(IVp);
  if ((IVp.OKFlag!=0 or TouchScreenFinishButtonf) and ((rwcnt==0) or (blank(IVp.Sum4)))) then begin
    RecordCheckError(1030,"",0,"ArtCode");      
    res = -1;
    goto L99;
  end;
  if (nonblank(IVp.CustCode)) then begin
    CUr.Code = IVp.CustCode;
    if (ReadFirstMain(CUr,1,true)==false) then begin
      if (IVp.CustCode<>"") then begin
        RecordCheckError(25601,IVp.CustCode,-1,"CustCode");
      end else begin
        RecordCheckError(25600,IVp.CustCode,-1,"CustCode");
      end;
      res = -1; 
      goto L99;
    end;
  end;
  // Edit Start ---------------------------------------------- Edit Start
	//Tuesday, 5 December 2017 14:28:36
	
  if(IVp.CustCode=="NONAME")then begin
  	if(IVp.Addr0==CUr.Name)then begin
  		if(nonblank(IVp.InvComment))then begin
  			IVp.Addr0 = IVp.InvComment;
  		end;
  	end;
  end;
  
  
	// Edit End ---------------------------------------------- Edit End
	
  if (check) then begin  
  if ((stat==Rs_insert) or ((stat==Rs_update) and (IV2p.OKFlag==0))) then begin
    if (IVp.OKFlag==1 and blank(IVp.CAE)) then begin
      if (BA_IVMinMarkupWarning(IVp,i)) then begin
        if (UserCanAction("DisallowSaleBelowGP",false)) then begin
          RecordCheckError(22050,"",i,"Sum");      
          res = -1;
          goto L99;
        end;
      end;
    end;
  end;
  end;
  if (IVp.SerNr<=0) then begin
    nousersernr = false;
    
    if ((IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) and (SRRec.LastCredInvNr!=-1))  then begin
      newnr = SRRec.LastCredInvNr;
      nousersernr = true;
      if (newnr==-1) then begin
        newnr = GetCurUserLastNr("IVVc");
        nousersernr = false;
      end;
    end else begin
      if ((IVp.InvType==kInvoiceTypeCash or IVp.InvType==kInvoiceTypeCashInvoiceReceiptPRT) and (SRRec.LastCashInvNr!=-1))  then begin
        newnr = SRRec.LastCashInvNr;
        nousersernr = true;
        if (newnr==-1) then begin
          newnr = GetCurUserLastNr("IVVc");
          nousersernr = false;
        end;
      end else begin
        newnr = GetCurUserLastNr("IVVc");
        if (newnr==-1) then begin
          newnr = SRRec.LastInvNr;
        end;
      end;
    end;
    IVp.SerNr = NextSerNr("IVVc",IVp.TransDate,newnr,nousersernr,IVp.LangCode);
  end;
  
  if (IVp.SerNr<0) then begin
    RecordCheckError(1033,"",-1,"SerNr");
    res = -1;
    goto L99;
  end;
  if (check) then begin  
  if (HasLocalization("BOL")) and  (ARAccb.CheckDosageKey==1) then begin
    if blank(FindTaxAuthIDDosageKey(IVp.TaxAuthID,IVp)) then begin 
      RecordCheckError(26214,"",-1,"SerNr");  
      res = -1;
      goto L99;
    end;
  end;
  if ((ARAccb.ChronologyforInvNo!=0) and (stat==Rs_insert)) then begin
    GetSerRange("IVVc",IVp.SerNr,serstart,serend);
    if (serend!=-1) then begin    
      locIVr.SerNr = serend;
    end else begin
      locIVr.SerNr = IVp.SerNr;
    end;
    if (CountRecords("IVVc")>0) then begin
      ReadLastKey("SerNr",locIVr,1,false);
      if (true) then begin
        if ((locIVr.SerNr>0) and ((locIVr.SerNr>=serstart) or (serstart==-1))) then begin
          if ((locIVr.SerNr+1)!=IVp.SerNr) then begin
            oldnr = locIVr.SerNr+1;
            RecordCheckError(1034,"",-1,"SerNr");  
            res = -1;
            goto L99;
          end;
        end;
      end;    
    end;
  end;  
  if (blank(IVp.BranchID))  then begin
    IVp.BranchID = CurBranchID;
  end;
  if (nonblank(IVp.BranchID))  then begin
    BranchCUr.Code = IVp.BranchID;
    if (ReadFirstMain(BranchCUr,1,true)==false) then begin
      RecordCheckError(36132,IVp.BranchID,-1,"BranchID");
      res = -1; 
      goto L99;
    end;
  end;
  
  BlockLoad(LINrb);  
  if (nonblank(IVp.OfficialSerNr)) and ((MatRowCnt(LINrb)>0) or (HasLocalization("ARG,HRV,PRT,SVN"))) then begin
    GetLegalInvNrRow(IVp.OfficialSerNr,LINrbrw);
    switch (LINrbrw.SelectionType) begin
      case kLegalInvNrSelectionTypeManual:
        if (blank(LINrbrw.Serie)) then begin
          IVp.OfficialSerNr = "";
        end;
      case kLegalInvNrSelectionTypeAtOK:
        IVp.OfficialSerNr = "";
      case kLegalInvNrSelectionTypeAtInsert:
        if (blank(LINrbrw.Serie)) or (stat==Rs_insert) then begin
          if (HasLocalization("POL")==false) then begin
            IVp.OfficialSerNr = "";
          end;
        end;
      case kLegalInvNrSelectionTypeAtSendingERecord:
        if (HasLocalization("ARG")) then begin
          if (LINrbrw.OutArgEInvoices==kOutArgEInvoicesSend) then begin
            if (blank(IVp.CAEExpiry)) then begin
              IVp.OfficialSerNr = "";
            end;
          end;
        end;
    end;
  end;
  if (blank(IVp.OfficialSerNr)) then begin
    if (HasLocalization("BRA")) then begin
      RecordCheckError(2210,"",-1,"OfficialSerNr");
      res = -1;
      goto L99;
    end;
    if (HasLocalization("POL")) then begin
      if (IsStandardProduct) then begin
        FindNextIVVcOfficialSerialNr(IVp);
        if (blank(IVp.OfficialSerNr)) then begin
          locIVr.OfficialSerNr = "ZZZZZZZZZZZZZZZZZZZ";
          if (ReadLastKey("OfficialSerNr",locIVr,1,false)) then begin
            if (blank(IVp.OfficialSerNr)) then begin
              NextM4Number(locIVr.OfficialSerNr,IVp.OfficialSerNr);
            end;
          end;
        end;
        if (blank(IVp.OfficialSerNr)) then begin
          IVp.OfficialSerNr = "1";
        end;
      end;
    end;
    if (HasLocalization("PRT")) then begin
      if (IVp.Status==kRecordStatusInvalidated or IVp.Status==kRecordStatusLost or IVp.Status==kRecordStatusNotUsed) then begin
        RecordCheckError(34430,"",-1,"Status");
        res = -1;
        goto L99;
      end;
      if (IVp.Status==kRecordStatusManual or IVp.Status==kRecordStatusRecovered) then begin
        if (transf) then begin
          if (blank(IVp.OfficialSerNr)) then begin
            RecordCheckError(2210,"",-1,"OfficialSerNr");
            res = -1;
            goto L99;
          end;
        end;
      end else begin
        FindNextIVVcOfficialSerialNr(IVp);
        if (blank(IVp.OfficialSerNr)) then begin
          if (transf) then begin
            RecordCheckError(2210,"",-1,"OfficialSerNr");
            res = -1;
            goto L99;
          end else begin
            if (OfficialSerialNrCanBeBlank("IVVc",CUr.Classification,IVp.OKFlag,IVp.OfficialSerNr,IVp.BranchID,IVp.MachineName,IVp.InvDate,IVp.InvType,IVp.Status)==false) then begin
              RecordCheckError(2210,"",-1,"OfficialSerNr");
              res = -1;
              goto L99;
            end;
          end;
        end;
      end;
    end;
    
		if(transf)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Wednesday, 8 May 2019 16:43:40
			if(nonblank(IVp.RebateVaucher))then begin
				if(firstinrange(IVp.RebateVaucher,10)=="BAKUCARD")then begin
					URCr.Code = IVp.RebateVaucher;
					if(readfirstmain(URCr,1,true))then begin
						if(URCr.Compnr!=currentcompany or URCr.InvoiceNr!=IVp.SerNr)then begin
							RecordCheckError(36232," " & URCr.Compnr & "_" & URCr.InvoiceNr,-1,"RebateVaucher");
							res = -1;
							goto L99;
						end;
					end;
				end;
			end;
		end;
    
    if (HasLocalization("HRV,SVN")) then begin
//      if (IVp.FiscalFlag!=0) then begin // Have to have Official Serial numbers assigned for non-fiscal invoices as well.
        FindNextIVVcOfficialSerialNr(IVp);
//      end;
    end;
    if (HasLocalization("AGO")) then begin
      FindNextIVVcOfficialSerialNr(IVp);
      if (blank(IVp.OfficialSerNr)) then begin
        if (transf) then begin
          RecordCheckError(2210,"",-1,"OfficialSerNr");
          res = -1;
          goto L99;
        end else begin
          if (OfficialSerialNrCanBeBlank("IVVc",CUr.Classification,IVp.OKFlag,IVp.OfficialSerNr,IVp.BranchID,IVp.MachineName,IVp.InvDate,IVp.InvType,IVp.Status)==false) then begin
            RecordCheckError(2210,"",-1,"OfficialSerNr");
            res = -1;
            goto L99;
          end;
        end;
      end;
    end;
    if (HasLocalization("ARG")) then begin
      if (AssignOfficialSerNr==false) then begin
        FindNextIVVcOfficialSerialNr(IVp);
      end;
    end;
  end;
  if (ValidateOfficialSerialNrChronology("IVVc",IVp.OfficialSerNr,IVp.SerNr,IVp.InvDate,td)==false) then begin
    RecordCheckError(26201," " & td,-1,"InvDate");  
    res = -1;
    goto L99;
  end;  
  if (nonblank(IVp.OfficialSerNr)) then begin    
    BlockLoad(IOSTr);
    if (nonblank(IOSTr.From)) then begin
      if (IVp.OfficialSerNr<IOSTr.From) then begin
        RecordCheckError(1557,"",-1,"OfficialSerNr");      
        res = -1;
        goto L99;
      end;
    end;
    if (nonblank(IOSTr.To)) then begin
      if (IVp.OfficialSerNr>IOSTr.To) then begin
        RecordCheckError(1557,"",-1,"OfficialSerNr");      
        res = -1;
        goto L99;
      end;
    end;
    if (HasLocalization("ARG")) then begin
      if (AssignOfficialSerNr==false) then begin
        RecordCopy(locIVr,IVp);
        locIVr.SerNr = -1;
        locIVr.OfficialSerNr = "";
        FindNextIVVcOfficialSerialNr(locIVr);
        GetLegalInvNrRow(locIVr.OfficialSerNr,LINrb2rw);
        GetLegalInvNrRow(IVp.OfficialSerNr,LINrbrw);
        if (LINrbrw.SelectionType!=kLegalInvNrSelectionTypeManual) then begin
          if (LINrb2rw.Serie!=LINrbrw.Serie) then begin
            RecordCheckError(1557,"",-1,"OfficialSerNr");      
            res = -1;
            goto L99;
          end;
          tstr = GetLegalInvoiceNrString(LINrbrw,IVp.OfficialSerNr);
          if (LegalRecordNumberInRange(tstr,LINrb2rw.TSerStart,LINrb2rw.TSerEnd)==false) then begin
            RecordCheckError(1557,"",-1,"OfficialSerNr");
            res = -1;
            goto L99;
          end;
        end;
        if (CheckIfNextLegalSerNr(IVp.SerNr,IVp.OfficialSerNr,IVp.TransDate,CUr)==false) then begin
          RecordCheckError(1557,"",-1,"OfficialSerNr");      
          res = -1;
          goto L99;
        end;
      end;
      switch (LINrbrw.OutArgEInvoices) begin
        case kOutArgEInvoicesSendWithCAEA:
          BlockLoad(EIb);
          if (EIb.ArgSelfBilling!=0) then begin
            if (nonblankdate(EIb.ScdLastFortnightCAEAStartDate)) and (nonblankdate(EIb.ScdLastFortnightCAEAExpiryDate)) then begin
              if (DateInRange(IVp.InvDate,EIb.ScdLastFortnightCAEAStartDate,EIb.ScdLastFortnightCAEAExpiryDate)) then begin
                IVp.CAEAStartDate = EIb.ScdLastFortnightCAEAStartDate;
                IVp.CAEAExpiryDate = EIb.ScdLastFortnightCAEAExpiryDate;
                IVp.CAE = EIb.ScdLastFortnightCAEA;
                IVp.CAEAFlag = 1;
              end;
            end;
            if (nonblankdate(EIb.LastFortnightCAEAStartDate)) and (nonblankdate(EIb.LastFortnightCAEAExpiryDate)) then begin
              if (DateInRange(IVp.InvDate,EIb.LastFortnightCAEAStartDate,EIb.LastFortnightCAEAExpiryDate)) then begin
                IVp.CAEAStartDate = EIb.LastFortnightCAEAStartDate;
                IVp.CAEAExpiryDate = EIb.LastFortnightCAEAExpiryDate;
                IVp.CAE = EIb.LastFortnightCAEA;
                IVp.CAEAFlag = 1;
              end;
            end;
            if (nonblankdate(EIb.CAEAStartDate)) and (nonblankdate(EIb.CAEAExpiryDate)) then begin
              if (DateInRange(IVp.InvDate,EIb.CAEAStartDate,EIb.CAEAExpiryDate)) then begin
                IVp.CAEAStartDate = EIb.CAEAStartDate;
                IVp.CAEAExpiryDate = EIb.CAEAExpiryDate;
                IVp.CAE = EIb.CAEA;
                IVp.CAEAFlag = 1;
              end;
            end;
          end;
      end;
    end;
    if (HasLocalization("PRT")) then begin
      GetLegalInvNrRow(IVp.OfficialSerNr,LINrbrw);
      if (LINrbrw.SelectionType==kLegalInvNrSelectionTypeManual) then begin
        if (IVp.Status!=kRecordStatusManual and IVp.Status!=kRecordStatusRecovered) then begin
          RecordCheckError(2246,"",-1,"Status");   
          res = -1; 
          goto L99;
        end;
      end;
      if (LINrbrw.RegType==kOfficialNumTypeAllIVVc) then begin
        RecordCheckError(2246,"",-1,"OfficialSerNr");   
        res = -1; 
        goto L99;
      end;
      if (LINrbrw.RegType==kOfficialNumTypeManualIVVc) then begin
        if (IVp.Status!=kRecordStatusManual) then begin
          RecordCheckError(2246,"",-1,"OfficialSerNr");   
          res = -1; 
          goto L99;
        end;
      end;
      if (LINrbrw.RegType==kOfficialNumTypeRecoverdIVVc) then begin
        if (IVp.Status!=kRecordStatusRecovered) then begin
          RecordCheckError(2246,"",-1,"OfficialSerNr");   
          res = -1; 
          goto L99;
        end;
      end;
    end;
    if (HasLocalization("AGO")) then begin
      GetLegalInvNrRow(IVp.OfficialSerNr,LINrbrw);
      if (LINrbrw.RegType==kOfficialNumTypeAllIVVc) then begin
        RecordCheckError(2246,"",-1,"OfficialSerNr");   
        res = -1; 
        goto L99;
      end;
    end;
  end;
  if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales or IVp.InvType==kInvoiceTypeDebit) then begin
    if (ARAccb.RequireCreditNoteReason!=0) then begin
      if (blank(IVp.Reason)) then begin
        RecordCheckError(1058,"",-1,"Reason");   
        res = -1; 
        goto L99;
      end;
    end;
    creditedinvtype = GetCreditedInvoiceType(IVp);
    if (creditedinvtype==kInvoiceTypeCash or creditedinvtype==kInvoiceTypeCashInvoiceReceiptPRT) then begin
      controlaccf = false;
    end;
    if (ARAccb.CreditIVTotNotExceedInvCheck!=0 and IVp.OKFlag!=0) then begin
      if (CheckCreditInvTotOnOrigIV(IVp,tstr,errcode2)) then begin
        RecordCheckError(errcode2,tstr,-1,"SerNr");      
        res = -1; 
        goto L99;
      end;
    end;      
  end;
  if (HasLocalization("PRT")) then begin
/*
    if (CUr.VATNr=="999999990") then begin
      if (IVp.InvType!=kInvoiceTypeCash) then begin
        if (IVp.InvType!=kInvoiceTypeCredit and IVp.InvType!=kInvoiceTypeCreditSpecialSales) then begin
          RecordCheckError(2246,"",-1,"PayDeal");   
          res = -1; 
          goto L99;
        end;
      end;
    end;
*/  
    if (nonblank(IVp.GlobalTransportDate)) then begin
      if (blank(IVp.GlobalTransportNr)) then begin
        RecordCheckError(34380,"",-1,"GlobalTransportNr");   
        res = -1; 
        goto L99;
      end;
    end;
    if (nonblank(IVp.GlobalTransportNr)) then begin
      if (blank(IVp.GlobalTransportDate)) then begin
        RecordCheckError(22001,"",-1,"GlobalTransportDate");   
        res = -1; 
        goto L99;
      end;
      if (CheckGlobalTransportNr(IVp.GlobalTransportNr)==false) then begin
        RecordCheckError(34381,"",-1,"GlobalTransportNr");   
        res = -1; 
        goto L99;
      end;
    end;  
    if (IVp.InvType==kInvoiceTypeCash) then begin
      if (IVp.InclVAT>0) then begin
        bal = IVp.Sum4 - IVp.Sum3;
      end else begin
        bal = IVp.Sum1;
      end;
      switch (CYb.BusinessType) begin
        case kCYBusinessTypeRetail:
          testf = false;
          rwcnt = MatRowCnt(IVp);
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(IVp,i,IVrw);
            if (nonblank(IVrw.ArtCode)) then begin
              if (ReadFirstItem(IVrw.ArtCode,INr,false,true)) then begin
                if (INr.ItemType!=kItemTypeStocked) then begin
                  testf = true;
                  i = rwcnt;
                end;
              end;
            end;
          end;
          if (testf) then begin
            if (bal>100) then begin
              RecordCheckError(2246,"",-1,"PayDeal");   
              res = -1; 
              goto L99;
            end;
          end else begin
            if (bal>1000) then begin
              RecordCheckError(2246,"",-1,"PayDeal");   
              res = -1; 
              goto L99;
            end;
          end;
        otherwise
          if (bal>100) then begin
            RecordCheckError(2246,"",-1,"PayDeal");   
            res = -1; 
            goto L99;
          end;
      end;
    end;
    if (IVp.Status==4 or IVp.Status==5) then begin
      if (blank(IVp.OfficialSerNr2)) then begin   
        RecordCheckError(2210,"",-1,"OfficialSerNr2");   
        res = -1; 
        goto L99;
      end;
      if (nonblank(IVp.OfficialSerNr2)) then begin   
        if (InString2(IVp.OfficialSerNr2,"/")<=0) then begin
          RecordCheckError(1059," " & IVp.OfficialSerNr2,-1,"OfficialSerNr2");   
          res = -1; 
          goto L99;
        end;
        locIVr.OfficialSerNr2 = IVp.OfficialSerNr2;
        if (ReadFirstKey("OpenOfficialSerNr2",locIVr,1,true)) then begin
          if (locIVr.SerNr!=IVp.SerNr) then begin
            RecordCheckError(1391,IVp.OfficialSerNr2,-1,"OfficialSerNr2");   
            res = -1; 
            goto L99;
          end;
        end;
        locIVr.OfficialSerNr = StripCharacter(IVp.OfficialSerNr2,"/");
        if (ReadFirstKey("OfficialSerNr",locIVr,1,true)) then begin
          if (locIVr.SerNr!=IVp.SerNr) then begin
            RecordCheckError(1391,IVp.OfficialSerNr2,-1,"OfficialSerNr2");   
            res = -1; 
            goto L99;
          end;
        end;
        dummyl = 0;
        GetNextSubstring(IVp.OfficialSerNr2,dummyl,"/",tstr);
        GetNextSubstring(IVp.OfficialSerNr2,dummyl,"/",tstr2);
        for (i=0;i<len(tstr);i=i+1) begin
          c = Mid(tstr,i,1);
          if (IsDigit(c)==false and (IsCapitalLetter(c)==false)) then begin
            RecordCheckError(1059," " & IVp.OfficialSerNr2,-1,"OfficialSerNr2");   
            res = -1; 
            goto L99;
          end;
        end;
        for (i=0;i<len(tstr2);i=i+1) begin
          c = Mid(tstr2,i,1);
          if (IsDigit(c)==false) then begin
            RecordCheckError(1059," " & IVp.OfficialSerNr2,-1,"OfficialSerNr2");   
            res = -1; 
            goto L99;
          end;
        end;
        GetLegalInvNrRow(IVp.OfficialSerNr2,LINrbrw);
        if (LINrbrw.SelectionType!=kLegalInvNrSelectionTypeManual) then begin
          RecordCheckError(2246,"",-1,"Status");   
          res = -1; 
          goto L99;
        end;
      end;
    end;
  end;
LSkipOfficialSerNrCheck:;
  if (HasLocalization("BRA")) then begin
    if ((CUr.CUType!=0 or CUr.VEType!=0) and (IVp.InvCountry=="1058" or blank(IVp.InvCountry))) then begin 
      errcode = CheckAddressForLocalisation("BRA",IVp.Addr1,"Addr1",IVp.Addr2,"Addr2",IVp.Addr3,"Addr3",IVp.InvAddr3,"InvAddr3",IVp.InvAddr4,"InvAddr4",tstr);
      if (errcode!=0) then begin 
        RecordCheckError(errcode,"",-1,tstr);
        res = -1;
        goto L99;      
      end;
    end;  
    if ((CUr.CUType!=0 or CUr.VEType!=0) and (IVp.DelCountry=="1058" or blank(IVp.DelCountry))) then begin 
      if (nonblank(IVp.ShipAddr1) or nonblank(IVp.ShipAddr2) or nonblank(IVp.ShipAddr3) or nonblank(IVp.DelAddr3) or nonblank(IVp.DelAddr4)) then begin 
        errcode = CheckAddressForLocalisation("BRA",IVp.ShipAddr1,"ShipAddr1",IVp.ShipAddr2,"ShipAddr2",IVp.ShipAddr3,"ShipAddr3",IVp.DelAddr3,"DelAddr3",IVp.DelAddr4,"DelAddr4",tstr);
        if (errcode!=0) then begin 
          RecordCheckError(errcode,"",-1,tstr);
          res = -1;
          goto L99;      
        end;
      end;
    end;    
  end;    
  /*if (IVp.ExportFlag==0 and blank(IVp.CAE)) then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 06 03 2019 y. at 4:34:19 PM
    if (UserCanAction("DisallowDomSales",false)) then begin
      RecordCheckError(20056,"",-1,"CustCode");   
      res = -1; 
      goto L99;
    end; 
  end;*/
  if (IVp.ExportFlag!=0 and blank(IVp.CAE)) then begin
    if (UserCanAction("DisallowExpSales",false)) then begin
      RecordCheckError(20049,"",-1,"CustCode");   
      res = -1; 
      goto L99;
    end; 
  end;
  if (nonblank(IVp.SalesMan)) then begin    
    //errcode = VerifySalesmen(IVp.SalesMan,tstr); // edited by BPI
    //if (errcode!=0) then begin // edited by BPI
    USr.Code = IVp.SalesMan; // edited by BPI
    if(readfirstmain(USr,1,true)==false)then begin // edited by BPI
      RecordCheckError(20170,": " & tstr,-1,"SalesMan");   
      res = -1; 
      goto L99;
    end;
    if (transf and USr.IsSalesMan==0 and currentcompany!=10) then begin //Edit***************************Sasha2,9:59 28.08.2017 {
      RecordCheckError(35111,"",-1,"SalesMan");   
      res = -1; 
      goto L99;
    end; //Edit***************************Sasha2,9:59 28.08.2017 }
  end;
  BlockLoad(LINrb);  
  if ((nonblank(IVp.OfficialSerNr)) and (MatRowCnt(LINrb)>0)) or ((HasLocalization("POL")) and (IsStandardProduct)) then begin    
    locIVr.OfficialSerNr = IVp.OfficialSerNr;
    if (ReadFirstKey("OfficialSerNr",locIVr,1,true)) then begin
      testf = false;
//      if (IVp.InvType!=kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin//why ok to have Invoice and Credit note with same offical nr ? 
        if (locIVr.SerNr!=IVp.SerNr) then begin testf = true; end;
//      end;
      if (testf) then begin
        RecordCheckError(1115," " & IVp.OfficialSerNr,-1,"OfficialSerNr");      
        res = -1;
        goto L99;
      end;
    end;
  end;
  if (nonblank(IVp.OfficialSerNr)) and (MatRowCnt(LINrb)>0)  then begin    
    errcode = 0;
    if (HasLocalization("ARG")==false) then begin
      rwcnt = MatRowCnt(LINrb);
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(LINrb,i,LINrbrw);
        test2f = true;
        if (Left(IVp.OfficialSerNr,len(LINrbrw.Serie))!=LINrbrw.Serie) then begin test2f = false; end;
        if (test2f) then begin
          testf = true;
          test2f = TestNextOfficialSerialNr_IVVc(LINrbrw,CUr.Classification,IVp,false);
          if (test2f==false) then begin
            errcode = 1557;
            testf = false;
          end else begin
            i = rwcnt;
          end;
        end;
      end;
      if (testf==false) then begin
        RecordCheckError(errcode," " & IVp.OfficialSerNr,-1,"OfficialSerNr");      
        res = -1;
        goto L99;
      end;
    end;
  end;
  if (nonblank(IVp.OfficialSerNr)) then begin
    if (InString2(IVp.OfficialSerNr,",")>0) then begin
      if (InString2(IVp.OfficialSerNr,":")>0) then begin
        RecordCheckError(1059," " & IVp.OfficialSerNr,-1,"OfficialSerNr");      
        res = -1;
        goto L99;
      end;
    end;
    locIVr.OfficialSerNr = IVp.OfficialSerNr;
    if (ReadFirstKey("OfficialSerNr",locIVr,1,true)) then begin
      if (locIVr.SerNr!=IVp.SerNr) then begin
        MessageBox(1547," " & locIVr.SerNr);
      end;
    end;
  end;  
  end;
  if ((stat==Rs_insert) or (IVp.SerNr!=IV2p.SerNr)) then begin
    if (gDoNotTestIfRecordExists==false) then begin
      locIVr.SerNr = IVp.SerNr;
      if (ReadFirstMain(locIVr,1,true)) then begin
        RecordCheckError(1115,"",-1,"SerNr");      
        res = -1;
        goto L99;
      end;
      if (RecordSupportExists("ARVc","IVVc",IVp.SerNr)) then begin
        RecordCheckError(1115,"",-1,"SerNr");      
        res = -1;
        goto L99;
      end;
    end;
  end;
  cashres = CashSerNumberTest(IVp.PayDeal,IVp.Sum4,"IVVc",IVp.SerNr,gentrans);
  if (cashres==99) then begin 
    res = -1; 
    goto L99; 
  end;
  if (cashres==12) then begin
    goto L12;
  end;  
  if (SerNrTestIVVc(IVp.SerNr,IVp.TransDate,gentrans)==false) then begin
    RecordCheckError(1034,"",-1,"SerNr");      
    res = -1; 
    goto L99;
  end;
L12:;
  if (check==false) then begin
    goto LIVVcRecordCheck_GenTrans;
  end;  
  if (Date2Test("IVVc",IVp.InvDate,"InvDate",-1)==false) then begin
    res = -1;
    goto L99;
  end;
  if (DisallowFutureDateCheck(true,IVp.InvDate,"InvDate",-1)) then begin
    res = -1;
    goto L99;
  end;
  if (Date2Test("IVVc",IVp.TransDate,"TransDate",-1)==false) then begin
    res = -1;
    goto L99;
  end;
  if (DisallowFutureDateCheck(true,IVp.TransDate,"TransDate",-1)) then begin
    res = -1;
    goto L99;
  end;
  if (nonblank(IVp.CustCode)) then begin
    if (CUr.CUType==0) then begin
      RecordCheckError(1120,IVp.CustCode,-1,"CustCode");      
      res = -1; 
      goto L99;
    end;
  end;
  errcode = CheckRates(IVp.CurncyCode,IVp.FrRate,IVp.ToRateB1,IVp.ToRateB2,IVp.BaseRate1,IVp.BaseRate2,tstr);
  if (errcode!=0) then begin
    RecordCheckError(errcode,"",-1,tstr);      
    res = -1; 
    goto L99;
  end;    
  if ((IVp.InvType!=kInvoiceTypePrepayment) and (IVp.InvType!=kInvoiceTypeDownpayment)) then begin
    if (blank(IVp.PayDeal)) then begin
      RecordCheckError(1256,"",-1,"PayDeal");      
      res = -1; 
      goto L99;
    end else begin
      i = GetPayDealType(IVp.PayDeal,dummyl);
      if ((i!=kInvoiceTypeInterest) and (i!=kInvoiceTypeNormal) and (i!=kInvoiceTypeDebit) and (i!=kInvoiceTypeDownpayment)) then begin
        if (IVp.InvType!=i) then begin
          RecordCheckError(1214,"",-1,"PayDeal");      
          res = -1; 
          goto L99;
        end;
      end;  
    end;
  end else begin
  end;  
  if (nonblank(CUr.CurncyCode)) then begin
    if (CUr.CurncyCode!=IVp.CurncyCode) then begin
      RecordCheckError(1217,"",-1,"CurncyCode");      
      res = -1; 
      goto L99;
    end;
  end;      
  if (CUr.OnHoldFlag!=0) then begin
    if (transf) then begin    
      RecordCheckError(1300,IVp.CustCode,-1,"CustCode");      
      res = -1; 
      goto L99;
    end;  
  end;
  if (TouchScreenFinishButtonf) then begin
    transf = false;
  end;
  if (CUr.blockedFlag==1/* and DenyOperationsWithBlockedCustomer(CUr,"IVVc") and IVp.OrderNr>-1*/) then begin //Edit***************************Sasha2,11:16 08.09.2017
    RecordCheckError(1265,IVp.CustCode,-1,"CustCode");      
    res = -1; 
    goto L99;
  end;
  if (nonblank(IVp.LoyaltyCardNr)) then begin
    LoyaltyCardr.SerNr = IVp.LoyaltyCardNr;
    if (ReadFirstMain(LoyaltyCardr,1,true)==false) then begin
      RecordCheckError(26435,"",-1,"LoyaltyCardNr");      
      res = -1; 
      goto L99;
    end;
    if (LoyaltyCardr.Closed!=0) then begin
      RecordCheckError(26435,"",-1,"LoyaltyCardNr");      
      res = -1; 
      goto L99;
    end;
  end;
  if (HasLocalization("ARG")==false) then begin
    errcode = CheckVATNrMask(IVp.VATNr,CUr.CountryCode,CUr.CustType,tstr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,tstr,-1,"VATNr");      
      res = -1; 
      goto L99;
    end;
  end;
  if (blank(IVp.CurncyCode)) then begin
    if ((IVp.FrRate!=blankval) or
        (IVp.ToRateB1!=blankval) or
        (IVp.ToRateB2!=blankval) 
/*JJCUR        
        or
        (IVp.BaseRate1!=blankval) or
        (IVp.BaseRate2!=blankval)
*/        
        ) then begin
      RecordCheckError(1582,"",-1,"BaseRate1");      
      res = -1; 
      goto L99;
    end;
  end;
  if (CurncyCodeRegistered(IVp.CurncyCode)==false) then begin
    RecordCheckError(1582,"",-1,"CurncyCode");      
    res = -1; 
    goto L99;
  end;
  if (HasLocalization("BRA")) then begin
    if (blank(IVp.BrazilEInvType)) then begin
      RecordCheckError(1058,"",-1,"BrazilEInvType");      
      res = -1; 
      goto L99;
    end else begin
      BEInvTyper.Code = IVp.BrazilEInvType;
      if (ReadFirstMain(BEInvTyper,1,true)==false) then begin
        RecordCheckError(1008,"",-1,"BrazilEInvType");      
        res = -1; 
        goto L99;
      end;
    end;
  end;
  if (HasIntegratedNL) then begin
    if (nonblank(IVp.ARAcc)) then begin
      Accr.AccNumber = IVp.ARAcc;
      if (ReadFirstMain(Accr,1,true)==false) then begin
        RecordCheckError(1007,IVp.ARAcc,-1,"ARAcc");      
        res = -1; 
        goto L99;
      end;    
    end;
  end;
  controlaccf = true;
  if (IVp.InvType==kInvoiceTypeCash or IVp.InvType==kInvoiceTypeCashInvoiceReceiptPRT) or (creditedinvtype==kInvoiceTypeCash or creditedinvtype==kInvoiceTypeCashInvoiceReceiptPRT) then begin
    controlaccf = false;
  end;
  if (controlaccf) then begin
    if (IsControlAccount(IVp.ARAcc,true,true)==false) then begin
      RecordCheckError(22082,IVp.ARAcc,-1,"ARAcc");      
      res = -1; 
      goto L99;
    end;
  end;
  if (IVp.OKFlag!=0 or TouchScreenFinishButtonf) and (IV2p.OKFlag==0) then begin
    if (HasIntegratedNL) then begin
      if (IVp.InvType==kInvoiceTypeCash or IVp.InvType==kInvoiceTypeCashInvoiceReceiptPRT) and (TouchScreenInterface==false) then begin
        PDr.Code = IVp.PayDeal;
        if (ReadFirstMain(PDr,1,true)) then begin
          /*if (blank(PDr.pdCashAcc) and blank(ARAccb.CashAcc)) then begin// Edit ************************** Friday, 27 October 2017 10:50:07
            RecordCheckError(2191,"",-1,"SerNr");  
            res = -1; 
            goto L99;
          end;*/
        end;
      end;  
    end;
  end;
    tstr = IVp.ARAcc;
    if (blank(tstr)) then begin
      GetARAcc(IVp.CustCode,tstr);
    end;
    location = IVp.Objects;
    if (ARAccb.ARUseObj==0) then begin
//      location = "";//what the ? 
    end;
		if(IVp.ECOMMERCEOrdf!=1 and unokf==false)then begin
			errcode = CheckObjs(tstr,location,errstr);
		end;
		if(!ECSHOKFlag(IVp,IV2p)) then begin
			RecordCheckError(36284,"",-1,"SerNr");      
			res = -1; 
			goto L99;
		end;
    if (errcode!=0) then begin
      if ((errcode==1083) and (ARAccb.ARUseObj==0)) then begin
        errcode = 2275;
      end;
			if(IVp.ECOMMERCEOrdf!=1)then begin
				RecordCheckError(errcode,errstr,-1,"Objects");      
				res = -1; 
				goto L99;
			end;
    end;
  if (blank(IVp.MachineName))  then begin
    IVp.MachineName = CurMachineName;
    IVp.DrawerCode = CurDrawerCode(IVp.MachineName);
  end;
  if (blank(IVp.DrawerCode))  then begin
    IVp.DrawerCode = CurDrawerCode(IVp.MachineName);
  end;
  if (blank(IVp.TerminalID))  then begin
    IVp.TerminalID = CurTerminalID;
  end;
  
  if (check) then begin
    if (stat==Rs_update) then begin
      if (IV2p.OKFlag==0) then begin
        if (IsDoingManagerOverride) then begin
//          IVp.SalesMan = OriginalLogin; //why would u want to store Manger overriding as salesman ? 
        end else begin
          if (blank(IVp.SalesMan)) then begin
            IVp.SalesMan = CurrentUser;
          end;
          IVp.MachineName = CurMachineName;
          IVp.DrawerCode = CurDrawerCode(IVp.MachineName);
          if (blank(IVp.BranchID))  then begin
            IVp.BranchID = CurBranchID;
          end;
          IVp.TerminalID = CurTerminalID;
        end;
      end;
    end;
    IVp.TransTime = CurrentTime;//cannot be on save nor on update
    if (IVp.InvType==kInvoiceTypeCash or IVp.InvType==kInvoiceTypeCashInvoiceReceiptPRT) or (creditedinvtype==kInvoiceTypeCash or creditedinvtype==kInvoiceTypeCashInvoiceReceiptPRT) or (TouchScreenFinishButtonf and IVp.InvType==kInvoiceTypeDownpayment) then begin
      if (RequireOpenSession(IVp.MachineName) and IVp.SalesMan != "AUTO") then begin
        IVp.TransDate = CurrentDate;//cannot be on save nor on update
//        if (TouchScreenInterface) then begin
          if (IsSessionOpen(IVp.MachineName,IVp.DrawerCode,IVp.TransDate,IVp.TransTime)==false) then begin
            RecordCheckError(2195,"",-1,"SerNr");      
            res = -1;
            goto L99;
          end;
//      end;
      end;
    end;
  end;
  
  switch (stat) begin
    case Rs_insert:
      if (IVp.InvType!=kInvoiceTypeCredit and IVp.InvType!=kInvoiceTypeCreditSpecialSales) or (IVp.CredInv<=0) then begin
        rwcnt = MatRowCnt(IVp);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(IVp,i,IVrw);
          if (IVp.InvType!=kInvoiceTypeCredit and IVp.InvType!=kInvoiceTypeCreditSpecialSales) then begin
            if (IVp.OrderNr<=0) and (IVrw.OrdNr<=0) and (IVrw.stp!=kInvoiceRowTypeDebit) then begin
              IVrw.OrdRow = -1;
            end;
            IVrw.CreditedRow = -1;
          end else begin
            if (IVp.CredInv<=0) then begin
              IVrw.CreditedRow = -1;
            end;
          end;
          if (IVp.OrderNr<0) and (IVp.SVONr<0) and (IVrw.OrdNr<0) and (IVrw.OrdRow==-1) then begin
            IVrw.NotUpdStockFlag = 0;
          end;
          MatRowPut(IVp,i,IVrw);
        end; 
      end;
    case Rs_update:
      if ((IVp.OKFlag!=0 or TouchScreenFinishButtonf) and (IV2p.OKFlag==0)) then begin
        if (IVp.InvType!=kInvoiceTypeCredit and IVp.InvType!=kInvoiceTypeCreditSpecialSales) or (IVp.CredInv<=0) then begin
          rwcnt = MatRowCnt(IVp);
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(IVp,i,IVrw);
            IVrw.CreditedRow = -1;
            if (IVp.OrderNr<0) and (IVp.SVONr<0) and (IVrw.OrdNr<0) and (IVrw.OrdRow==-1) then begin
              IVrw.NotUpdStockFlag = 0;
            end;
            MatRowPut(IVp,i,IVrw);
          end;
        end;
      end;
  end;  
  
  if (IVTestCredMan(IVp,errcode)==false) then begin
    MessageBox(errcode,"");
  end;
  if (HasLocalization("MEX") and IsEnterprise) then begin
    if (blank(IVp.PMCode)) then begin
      RecordCheckError(2210,"",-1,"PMCode");      
      res = -1; 
      goto L99;
    end;
  end;
  if (HasLocalization("PRT")) then begin
    if (blank(IVp.SalesMan)) then begin
      RecordCheckError(21455,"",-1,"SalesMan");   
      res = -1; 
      goto L99;
    end;
    if (nonblankdate(IVp.PlanSendDate) or nonblanktime(IVp.PlanSendTime)) then begin
      if (IVp.PlanSendDate<IVp.InvDate) then begin
        RecordCheckError(1142,"",-1,"PlanSendDate");      
        res = -1; 
        goto L99;
      end;
      if (blanktime(IVp.PlanSendTime)) then begin
        RecordCheckError(20866,"",-1,"PlanSendTime");      
        res = -1; 
        goto L99;
      end;
      if (IVp.PlanSendDate==IVp.InvDate) then begin
        if (IVp.PlanSendTime<CurrentTime) then begin
          RecordCheckError(20866,"",-1,"PlanSendTime");      
          res = -1; 
          goto L99;
        end;
      end;
    end;
  end;
  if (transf) then begin
    if (ValidInvoiceDataForVATLaw2(IVp,CUr,errcode,errstr,tstr)==false) then begin
      RecordCheckError(errcode,errstr,-1,tstr);      
      res = -1; 
      goto L99;
    end;   
    if (ARAccb.DisallowNegativeTotalsonSales!=0) then begin
      if (IVp.Sum4<0) then begin
        RecordCheckError(22047,"",0,"Sum");      
        res = -1; 
        goto L99;
      end;
    end;
  end;
  /*if (ValidEInvoiceData3(IVp,CUr,errcode2,errstr,tstr)==false) then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 11 October 2018 09:36:16
    RecordCheckError(errcode2,errstr,-1,tstr);      
    res = -1; 
    goto L99;
  end;*/
  if (HasLocalization("ARG")) then begin
    if (IVp.OKFlag!=0 and IV2p.OKFlag==0) then begin
      if (ShouldSendArgEinvoice(IVp)) then begin
        if (blank(IVp.CAE)) and (IVp.CAEAFlag==0) then begin
          RecordCheckError(2913,"",-1,"SerNr");
          res = -1;
          goto L99;
        end;
      end;
    end else begin
      if (Rs_insert==1 and (IV2p.OKFlag!=0)) then begin
        if (ShouldSendArgEinvoice(IVp)) then begin
          if (blank(IVp.CAE)) and (IVp.CAEAFlag==0) then begin
            RecordCheckError(2913,"",-1,"SerNr");
            res = -1;
            goto L99;
          end;
        end;
      end;
      testf = false;
      if (IVp.OKFlag==0 and nonblank(IVp.CAE) and UserCanAction("UnOKAll",false)==false) then begin
        testf = true;
        if (UserCanAction("EditingCAEandCAEExpiry",false)) then begin
          BlockLoad(IEb);
          if (ERecordStatus(IEb.CustomerCode,IVp.CustCode,IVp.SerNr,"IVVc",tstr)==6) then begin        
            testf = false;
          end;
        end;
      end;
      if (testf) then begin
        RecordCheckError(2910,"",-1,"CAE");
        res = -1;
        goto L99;
      end;
    end;
  end;
//  if (IVp.InvType!=kInvoiceTypeDebit) then begin
//    IVp.CredInv = -1;
//  end;
  if (rwcnt>0) then begin
  switch (IVp.InvType) begin
    case kInvoiceTypeDebit:
      goto LkInvoiceTypeCredit;
    case kInvoiceTypeCreditSpecialSales: 
      goto LkInvoiceTypeCredit;
    case kInvoiceTypeCredit:
LkInvoiceTypeCredit:;
      MatRowGet(IVp,0,IVrw);
      if (IVrw.OrdRow!=-1) then begin
        if (nonblank(IVp.CredOfficialSerNr)) then begin
          locIVr.OfficialSerNr = IVp.CredOfficialSerNr;
          if (ReadFirstKey("OfficialSerNr",locIVr,1,true)==false) then begin
            RecordCheckError(1119,"",0,"CredOfficialSerNr");      
            res = -1; 
            goto L99;
          end;
        end;
        IVp.CredInv = IVrw.OrdRow;
        locIVr.SerNr = IVp.CredInv;
        if (ReadFirstMain(locIVr,1,true)==false) then begin
          RecordCheckError(1119,"",0,"OrdRow");      
          res = -1; 
          goto L99;
        end;
        if ((locIVr.InvType==kInvoiceTypeCredit or locIVr.InvType==kInvoiceTypeCreditSpecialSales)) then begin//(locIVr.InvType==kInvoiceTypeCash) or
          RecordCheckError(1222,"",0,"OrdRow");      
          res = -1; 
          goto L99;
        end;
        if (IVp.CustCode!=locIVr.CustCode) then begin
          RecordCheckError(1218,"",0,"OrdRow");      
          res = -1; 
          goto L99;
        end;
        if (locIVr.Invalid!=0) then begin
          RecordCheckError(1282,"",0,"OrdRow");      
          res = -1; 
          goto L99;
        end;
        if (locIVr.OKFlag==0) then begin
          RecordCheckError(2072,"",0,"OrdRow");      
          res = -1; 
          goto L99;
        end;
        if (IVp.CurncyCode!=locIVr.CurncyCode) then begin
          RecordCheckError(1217,"",0,"OrdRow");      
          res = -1;
          goto L99;
        end;
        if (IVp.TransDate<locIVr.TransDate) then begin
          RecordCheckError(20852,"",0,"OrdRow");
          res = -1;
          goto L99;
        end;
        if (blank(locIVr.RvrsVAT)==false) then begin
          if (locIVr.Sum4!=IVp.Sum4) then begin
            RecordCheckError(24191,"",0,"OrdRow");
            res = -1;
            goto L99;
          end;
        end;
        if (ARAccb.NoOverPayIV!=0 or blank(IVp.RvrsVAT)==false) then begin
        if (locIVr.InvType!=kInvoiceTypeCash and locIVr.InvType!=kInvoiceTypeCashInvoiceReceiptPRT) then begin
          ARr.InvoiceNr = IVp.CredInv;
          if (ReadFirstMain(ARr,1,true)==true) then begin
            if ((ARr.RVal)<(IVp.Sum4)) then begin
              tstr = " " & IVp.Sum4 & USetStr(20061);
              tstr = tstr & " " & ARr.RVal;
              RecordCheckError(20060,tstr,-1,"Sum4");
              res = -1;
              goto L99;
            end;
          end else begin
            if (IVp.CredInv>0 and IVp.ECOMMERCEOrdf!=1) then begin
              if (IVp.Sum4>0) then begin
                tstr = " " & IVp.Sum4 & USetStr(20061);
                tstr = tstr & " 0";
                RecordCheckError(20060,tstr,-1,"Sum4");
                res = -1;
                goto L99;
              end;
            end;
          end;
        end;
        end;
      end else begin
        if (ARAccb.CredInvWithNo!=0) then begin
          if (IVp.OKFlag!=0) then begin
            RecordCheckError(1119,"",0,"OrdRow");      
            res = -1; 
            goto L99;
          end;
        end;
      end;
  end;
  end;
  res = IVVcRecordCheckRows(IVp,IV2p,CUr,ORr,Ob,MSb,ARAccb,check,lightFlag,stat,cash);
  if (res!=0) then begin
    res = -1; 
    goto L99;
  end;
  if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
    res = TestCreditNoteTerms(IVp,tstr);
    if (res!=0) then begin
       RecordCheckError(res,tstr,-1,"Sum4");
       res = -1; 
      goto L99;
    end;
  end;
//  if (check and transf) then begin
//checkbox is Save , not OK invoice
  if (check) then begin
    if (CLb.IVSave==1) then begin//or CLb.IVPaste==1
      if ((IVp.OrderNr==-1) and (IVp.InvType!=kInvoiceTypeCash and IVp.InvType!=kInvoiceTypeCashInvoiceReceiptPRT) and (IVp.InvType!=kInvoiceTypeCredit) and (IVp.InvType!=kInvoiceTypeCreditSpecialSales) and (IVp.InvType!=kInvoiceTypeInterest)) then begin
      if (cash!=IVp.Sum4) then begin
        CUr.Code = IVp.CustCode;
        if (GetCustAndBal(CUr,limit,bal,CLb.Base,CLb.OwnCheques,CLb.ThirdCheques,CLb.IOUCheques,CLb.ThirdIOUCheques,CLb.ORSaveWarn,limitdaysf)) then begin
          if (limitdaysf) then begin
            if (CLb.IVSave==1) then begin    
              RecordCheckError(22260,"",-1,"CustCode");      
              res = -1;
              goto L99;
            end;
          end;
          if (blank(limit)==false) then begin 
            basesum4 = IVp.BaseSum4;  
            SubCashRows_IVVc(IVp,false,sum4,basesum4);
            switch (CLb.Base) begin
              case kCreditLimitBasedOnAllOpenInv: bal = bal + basesum4;
              case kCreditLimitBasedOnOverDueInv: 
                if (IVp.InvType==kInvoiceTypeCash or IVp.InvType==kInvoiceTypeCashInvoiceReceiptPRT) then begin//cash only
                  bal = bal + basesum4;
                end;
              case kCreditLimitBasedOnOpenInvSuspendOnOverdue: 
                bal = bal + basesum4;
            end;
            if (bal>limit) then begin
              if (CLb.IVSave==1) then begin    
                if (limit==0.001 and CLb.Base==kCreditLimitBasedOnOpenInvSuspendOnOverdue) then begin
                  RecordCheckError(39600,"",-1,"CustCode");
                  res = -1;
                  goto L99;
                end else begin
                  RecordCheckError(1164,"",-1,"CustCode");      
                  res = -1;
                  goto L99;
                end;
              end;
  //            if (CLb.IVPaste==1) then begin    
  //               Error0(1164);
  //            end;
            end;
          end;
        end;
      end;
      end;
    end;
  end;

  
  i=0;	//Edit----------------------Dima  04.06.2015
  ExtractObj(POSCurblock.Currencies,i,posCurcncy);
  for(i=0;i<rwcnt;i=i+1) begin
		MatRowGet(IVp,i,IVrw);    
		if ((IVrw.stp==kInvoiceRowTypeCashPayment or IVrw.stp==kInvoiceRowTypeCreditCardPayment) and IVp.CurncyCode!=posCurcncy) then begin
        RecordCheckError(31313,"",-1,"CurncyCode");  
        res = -1;
        goto L99;
		end;
	end;//Edit---end-------------------Dima  04.06.2015
	
	
	cntvch=0;
	for (i=0; i<MatRowCnt(IVp);i=i+1) begin 
		MatRowGet(IVp,i,IVrw);
				if(IVrw.ArtCode=="CASHBACKCARD" and currentcompany==25) then begin
					TrHs = true;
					LoyaltyCardr.CustCode = IVp.CustCode;
					while(LoopKey("CustCode",LoyaltyCardr,1,TrHs)) begin 
						if(LoyaltyCardr.CustCode!=IVp.CustCode) then begin TrHs = false; end;
						if(TrHs) then begin
							if(LoyaltyCardr.Closed==0 and LoyaltyCardr.SerNr!=IVrw.SerialNr and LoyaltyCardr.LCMLevel=="CASACOIN") then begin
								RecordCheckError(36225,"",i,"SerialNr");      
								res = -1; 
								goto L99;
							end;
						end;
					end;	
					ResetLoop(LoyaltyCardr);
				end;
		if(IVrw.stp==kInvoiceRowTypeGiftVoucherPayment) then begin 
			GCSr.SerNr=IVrw.GCNr;
			ReadFirstMain(GCSr,1,true);
			if(GCSr.RealSum!=GCSr.Amount and left(IVp.PriceList,3)=="FOB") then begin
				res=-1;
				RecordCheckError(36223,"",-1,"SerNr");
				goto L999;
			end;	
      tIVr.SerNr = GCSr.InvSerNr;
      if(readfirstmain(tIVr,1,true)) then begin
				rwcnt2 = matrowcnt(tIVr);
				giftf = false;
				for (j=0;j<rwcnt2;j=j+1) begin
					matrowget(tIVr,j,tIVrw);
					if (((tIVrw.PayMode=="G") or (tIVrw.PayMode=="GS")) and (tIVrw.stp==kInvoiceRowTypeCreditCardPayment)) then begin
						giftf = true;
					end;
				end;
				
				if(giftf) then begin
					cntvch=cntvch+1;
				end;	
			end;	
		end;
	end;	
	
	if(MNGb.Count!=0 AND cntvch>MNGb.Count ) then begin          //Edit_________________ABR 12:24 22.10.18
		res=-1;
		RecordCheckError(36200,"",MatRowCnt(IVp),"Sum");
		goto L999;
	end;	
	if(transf) then begin
		if(UserCanAction("DisableSetOkIVPrevDate",true)==false and CurrentDate>IVp.InvDate) then begin
			res=-1;
			RecordCheckError(36228,"",-1,"SerNr");
			goto L999;
		end;
	end;
	
	 
  RecordNew(TRr);
	logtext(0,"----------transf---- " & transf);
  if (transf) then begin
    if (IsStandardProduct) then begin
      if (HasLocalization("AGO,ARG,HRV,POL,PRT")) then begin
        if (blank(IVp.OfficialSerNr)) then begin
          RecordCheckError(1058,"",-1,"OfficialSerNr");  
          res = -1;
          goto L99;
        end;
      end;
    end;
    if (HasLocalization("AGO,ARG,HRV,PRT")) then begin
      if (blank(IVp.OfficialSerNr)) then begin
        RecordCheckError(1058,"",-1,"OfficialSerNr");  
        res = -1;
        goto L99;
      end;
    end;
    if (HasLocalization("HRV")) then begin
      if (IVp.FiscalFlag!=0) then begin
        testf = false;
        if (IVp.Sum4>=0) then begin
          if (cash<IVp.Sum4) then begin
            testf = true;
          end;
        end else begin
          if (cash>IVp.Sum4) then begin
            testf = true;
          end;
        end;
        if (testf and currentcompany!=9 and currentcompany!=28) then begin
          RecordCheckError(24177,"",MatRowCnt(IVp),"Sum");      
          res = -1; 
          goto L99;
        end;    
      end;
    end;
//// Edit ************************** BPI Ukraine - KramarAlexandr - Wednesday, 21 March 2018 18:24:04
    //if (/*((IVp.InvType==kInvoiceTypeCash or IVp.InvType==kInvoiceTypeCashInvoiceReceiptPRT) or (ARAccb.NoOverPayIV!=0)) and */(TouchScreenInterface)) then begin//is POS client
      testf = false;
      rnd.decimals = 0;// Edit ************************** Friday, 26 February 2016 10:04:07
			rnd.step = kRoundingStepNone;
			rnd.mode = kRoundingModeHalfUp;
			
      if(currentcompany==25)then begin
      	rnd.decimals = 2;
      end;
      cash = round(cash,rnd);
      if(CompanyIsJWLikeCompany(currentcompany))then begin// Edit ************************** Friday, 22 March 2013 17:45:30
				rnd.decimals = 0;
				//rnd.step = kRoundingStep5;// Edit ************************** Friday, 20 October 2017 11:29:39
				rnd.mode = kRoundingModeHalfUp;
      end;
      cash = round(cash,rnd);// Edit ************************** Friday, 20 October 2017 11:29:40
      if(currentcompany==11 or currentcompany==12)then begin// Edit ************************** Friday, 22 March 2013 17:45:30
				rnd.decimals = -4;
				rnd.step = kRoundingStepNone;
				rnd.mode = kRoundingModeHalfUp;
				cash = round(cash,rnd);
      end;
      if (IVp.Sum4>=0) then begin
        if (cash<IVp.Sum4) then begin
          testf = true;
        end;
        //if (TouchScreenInterface==false) then begin
          if (ARAccb.NoOverPayIV!=0) then begin
            if (cash>IVp.Sum4) then begin
              testf = true;
            end;
          end;
        //end;
      end else begin
        if (cash>IVp.Sum4) then begin
          testf = true;
        end;
        if (ARAccb.NoOverPayIV!=0) then begin
          if (cash<IVp.Sum4) then begin
            testf = true;
          end;
        end;
      end;
			PDr.Code = IVp.PayDeal;// Edit ************************** Wednesday, 18 February 2015 16:29:21
			if (ReadFirstMain(PDr,1,true)) then begin
				if (PDr.PDType==kInvoiceTypeNormal or PDr.PDType==kInvoiceTypeCredit) then begin
					testf = false;
				end;  
			end;
			delta = 3;
			if(currentcompany==13)then begin
				delta = 10;
			end;
			if(currentcompany==25)then begin
				delta = 0.1;
			end;
			/*mtrwcnt = MatRowCnt(IVp);
			for(i=0;i<mtrwcnt;i=i+1)begin
				MatRowGet(IVp,i,IVMyrw);
				if(IVMyrw.Quant<0 and IVp.RetValue>0)then begin testf = false; end;
			end;*/
      if (testf and AbsoluteVal(cash-IVp.Sum4)>delta and currentcompany!=9 and currentcompany!=28) then begin // edited by BPI
      	logtext(0,"Full payment ned cash: " & cash & " IVSum " & IVp.Sum4 & " delta " & delta);
        RecordCheckError(24177,"",MatRowCnt(IVp),"Sum");      
        res = -1; 
        goto L99;
      end;
      if (testf and PDr.PDType==kInvoiceTypeCash and IVp.PriceList=="FOBR") then begin // edited by BPI
      	logtext(0,"Full payment ned cash: " & cash & " IVSum " & IVp.Sum4 & " delta " & delta);
        RecordCheckError(24177,"",MatRowCnt(IVp),"Sum");      
        res = -1; 
        goto L99;
      end;
    //end;
  end;
  if (HasLocalization("PRT")) then begin 
    IVp.OfficialSerNrSerie = UpdateOfficialSerNrSerie(stat,IVp.OKFlag,IV2p.OKFlag,IVp.OfficialSerNr,true);
  end;  
  if (IVp.InvType==kInvoiceTypePrepayment) then begin
    transf = false;
    check = false;
  end;
  if (transf) then begin
    cashinv = UserCanAction("CashInvOK",true);  
    norminv = UserCanAction("InvOK",true);
    credinv = UserCanAction("CredInvOK",true);
    switch (IVp.InvType) begin
      case kInvoiceTypeCashInvoiceReceiptPRT:
        goto LkInvoiceTypeCash;
      case kInvoiceTypeCash:
LkInvoiceTypeCash:;      
        if (cashinv==false)  then begin
          RecordCheckError(1274,StringFromStringSet(3,"CashInvOK"),-1,"SerNr");      
          res = -1;
          goto L99;
        end;
        if (cashinv==true) and (norminv==false) then begin
          RecordCheckError(1274,StringFromStringSet(3,"InvOK"),-1,"SerNr");      
          res = -1;
          goto L99;
        end; 
      case kInvoiceTypeCreditSpecialSales: goto LkInvoiceTypeCredit;
      case kInvoiceTypeCredit:
        LkInvoiceTypeCredit:;
        if (credinv==false)  then begin
          RecordCheckError(1274,StringFromStringSet(3,"CredInvOK"),-1,"SerNr");      
          res = -1;
          goto L99;
        end;
        if (credinv==true) and (norminv==false) then begin
          RecordCheckError(1274,StringFromStringSet(3,"InvOK"),-1,"SerNr");      
          res = -1;
          goto L99;
        end; 
      otherwise
        if (norminv==false) then begin
          RecordCheckError(1274,StringFromStringSet(3,"InvOK"),-1,"SerNr");      
          res = -1;
          goto L99;
        end;   
    end;
  end;
  
  if ((IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) and transf and (IVp.UpdStockFlag==0)) then begin
    res = PUFromCreditNote(IVp,false);
    SetRecordCheckVc("IVVc");
    if (res!=0) then begin
      RecordCheckError(1274,"",-1,"SerNr");      
      res = -1;
      goto L99;
    end;
  end;
  if ((transf) and (IVp.UpdStockFlag!=0)) then begin
    sernr = -1;
    if (stat==Rs_update) then begin
      sernr = IV2p.SerNr;
    end;  
    if (long4>0) then begin
      if (MSb.Chronology!=0) then begin
//locationperrow
        if (ExistStockTrans(IVp.Location,IVp.TransDate,errcode,errstr,"IVVc",sernr,MSb)) then begin
          RecordCheckError(errcode,errstr,-1,"TransDate");      
          res = -1;
          goto L99;
        end;
      end;
    end;
    if (CanOKStockRecord(errcode)==false) then begin
      RecordCheckError(errcode,"",-1,"SerNr");      
      res = -1; 
      goto L99;
    end;
  end;
//here validation is passed  
  if (IVp.OrderNr<=0) then begin
    rwcnt = MatRowCnt(IVp);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(IVp,i,IVrw);
      if (IVrw.stp==kInvoiceRowTypeNormal) or (IVrw.stp==kInvoiceRowTypeStructuredItemComponent) then begin
        if (IVp.OrderNr<=0) and (IVrw.OrdNr<=0) then begin
          IVrw.OrdRow = -1;
        end;
        MatRowPut(IVp,i,IVrw);
      end;
    end;
  end;  
  if (check==true) then begin
    if (IVp.UpdStockFlag!=0) then begin
      //IVUpdateFIFO(IVp,true,fifocurIVr,1); //Edit***************************Sasha2,11:53 18.03.2015   1 - IVVc, 2 - StockMovVc// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 20 December 2018 18:37:30
      if (blank(IVp.CAE)) then begin
        if (DisallowPriceLowerCost_IVVc(IVp)) then begin
          RecordCheckError(20767,"",i,"Price");      
          res = -1;
          goto L99;
        end;
      end;
    end;
  end;  
  
     // Edit Start ---------------------------------------------- Edit Start
	//Friday, 12 October 2012 11:48:11
	
	
	if(usercanaction("ViewNextIV",true)==false)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 23 01 2020 y. at 10:14:11 AM
    if(stat==Rs_update)then begin
    	if(nonblank(IV2p.SalesGroup))then begin
    		if(IV2p.SalesGroup!=IVp.SalesGroup)then begin
    			RecordCheckError(36337,"",-1,"SalesGroup");      
          res = -1;
          goto L99;
    		end;
    	end;
    end;
  end;
	
  if(blank(IVp.SalesGroup))then begin
    USr.Code = currentuser;
    readfirstmain(USr,1,true);
    if(nonblank(USr.SalesGroup))then begin
      IVp.SalesGroup=USr.SalesGroup;
    end;
  end;
  
	// Edit End ---------------------------------------------- Edit End
  
  
LIVVcRecordCheck_GenTrans:;
//  if (HasSLIntegratedWithNL==false) then begin gentrans = false; end;
  if (gentrans==false) then begin transf = false; end;
  if (IsStandardProduct) then begin
    transf = HasIntegratedNL and transf;
  end;

  if (transf) then begin
  	if (IVp.UpdStockFlag!=0) then begin
      IVUpdateFIFO(IVp,true,fifocurIVr,1); //Edit***************************Sasha2,11:53 18.03.2015   1 - IVVc, 2 - StockMovVc// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 20 December 2018 18:37:28
    end;
    
    if(transf)then begin
    	if(IVp.InvType==kInvoiceTypeCredit)then begin
    		if(IVp.PriceList=="FOBR")then begin
					rwcnt = MatRowCnt(IVp);
					for (i=0;i<rwcnt;i=i+1) begin
						MatRowGet(IVp,i,IVrw);
						if(IVp.CurncyCode=="AZN")then begin
							IVrw.FIFO = IVrw.Price;
							IVrw.FIFORowVal = IVrw.Sum;
						end else begin
							IVrw.FIFO = IVrw.Price * IVp.ToRateB1 / IVp.FrRate;
							IVrw.FIFORowVal = IVrw.Sum * IVp.ToRateB1 / IVp.FrRate;
						end;
						IVrw.FIFO = round(IVrw.FIFO,defaultcurroundoff);
						IVrw.FIFORowVal = round(IVrw.FIFORowVal,defaultcurroundoff);
						INr.Code = IVrw.ArtCode;
						if(ReadFIrstMain(INr,1,true))then begin
							logtext(0,INr.ItemType & "Anton AP");
							if(INr.ItemType==0)then begin
								stckItmflg = true;
							end;
						end;
						if(!stckItmflg)then begin
							MatRowPut(IVp,i,IVrw);
						end;
					end;
				end;
    	end else begin
				if(IVp.PriceList=="FOBR")then begin
					rwcnt = MatRowCnt(IVp);
					for (i=0;i<rwcnt;i=i+1) begin
						MatRowGet(IVp,i,IVrw);
						if(IVp.CurncyCode=="AZN")then begin
							if(IVrw.Quant>=0)then begin
								IVrw.Price = IVrw.FIFO;
								IVrw.Sum = IVrw.FIFORowVal;
							end else begin
								IVrw.Price = IVrw.FIFO;
								IVrw.Sum = -IVrw.FIFORowVal;
							end;
						end else begin
							if(IVrw.Quant>=0)then begin
								IVrw.Price = IVrw.FIFO / IVp.ToRateB1 * IVp.FrRate;
								IVrw.Sum = IVrw.FIFORowVal / IVp.ToRateB1 * IVp.FrRate;
							end else begin
								IVrw.Price = IVrw.FIFO / IVp.ToRateB1 * IVp.FrRate;
								IVrw.Sum = -(IVrw.FIFORowVal / IVp.ToRateB1 * IVp.FrRate);
							end;
						end;
						IVrw.FIFO = round(IVrw.FIFO,defaultcurroundoff);
						IVrw.FIFORowVal = round(IVrw.FIFORowVal,defaultcurroundoff);
						if (IVDchrsum(IVp,i)) then begin
							IVDchsum(IVp,i);
						end; 
						INr.Code = IVrw.ArtCode;
						if(ReadFIrstMain(INr,1,true))then begin
							logtext(0,INr.ItemType & "Anton AP");
							if(INr.ItemType==0)then begin
								stckItmflg = true;
							end;
						end;
						if(!stckItmflg)then begin
							MatRowPut(IVp,i,IVrw);
							IVSumup(IVp,true);
						end;
					end;
				end;
    	end;
    end;
    
    rwcnt = MatRowCnt(IVp); //Edit***************************Sasha2,11:35 14.08.2017 {
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(IVp,i,IVrw);
      if (IVrw.stp==kInvoiceRowTypeNormal and IVrw.ArtCode==GetCashBackSpecialItemCode) then begin
        if (IVrw.Quant>1) then begin
          RecordCheckError(35042,". " & USetStr(5279) ,i,"ArtCode");      
          res = -1;
          goto L99;
        end;
        for (j=i+1;j<rwcnt;j=j+1) begin
          MatRowGet(IVp,j,IV2rw);
          if (IV2rw.stp==kInvoiceRowTypeNormal and IV2rw.ArtCode==GetCashBackSpecialItemCode) then begin
            RecordCheckError(35042,". " & USetStr(1547) ,j,"ArtCode");      
            res = -1;
            goto L99;
          end;
        end;
        newCashBackCardNr = IVrw.SerialNr;
        RecordCopy(locIVr,IVp);
        MatRowDelete(locIVr,i);
        IVSumup(locIVr,true);
        locIVr.Points = BlankVal;
        locIVr.LCMLevel = GetCashBackLoyProgramByCardPrefix(newCashBackCardNr);
        CalculateIVVcCashbackPoints(locIVr,true);
        IVp.Points = locIVr.Points + IVrw.Sum;
        i = rwcnt;
      end;
    end;
    if (NonBlank(newCashBackCardNr)) then begin
      LoyaltyCardr.SerNr = newCashBackCardNr;
      if (ReadFirstMain(LoyaltyCardr,1,true)) then begin
        RecordCheckError(1709,". " & USetStr(35042) ,-1,"CustCode");      
        res = -1;
        goto L99;
      end;
      if (blank(IVp.CustCode) or IVp.CustCode=="NONAME") then begin
        RecordCheckError(25600,"",-1,"CustCode");      
        res = -1;
        goto L99;
      end;
    end; //Edit***************************Sasha2,11:39 14.08.2017 }
    
    errcode = MakeTransFromIV(gTRp,gSMp,IVp,false,false,fifocurIVr); //Edit***************************Sasha2,15:47 18.03.2015
    if (errcode==0) then begin
      if (MatRowCnt(gSMp)>0) then begin
        if (gSMp.SerNr<=0) then begin
          errcode = 2168;
        end;
      end;
    end;
    if (check) then begin
      if (errcode>0) then begin
        RecordCheckError(errcode,"",-1,"SerNr");      
        res = -1;
        goto L99;
      end;
      errcode = ConnectCreditNotetoVI(IVp);
      if (errcode!=0) then begin
        RecordCheckError(errcode,"",-1,"SerNr");      
        res = -1;
        goto L99;
      end;
    end;

    if ((gTRp.Number>0) and (gTRp.IntYc==IVYc)) then begin
      tstr = CheckTrans(gTRp,2,true);
      if (nonblank(tstr)) then begin
        RecordCheckError(1085,tstr,-1,"SerNr");      
        res = -1;
        goto L99;
      end;
      if (HasLocalization("USA")) then begin
        res = IVGetExternalTaxRates(IVp,tstr);
        if (res>1) then begin
          RecordCheckError(res,tstr,-1,"SerNr");   
          res = -1; 
          goto L99;
        end;
      end;
      switch (gRuniningMaint) begin    
        case "RecalcStockMn":
          UpdateTrans_Stock(gTRp);
        otherwise
//must be after all other tests  
          if (HasLocalization("HRV")) then begin
            if (IVp.OKFlag!=0 and IVp.Invalid==0 and blank(IVp.TaxAdminServSeal) and blank(IVp.RefStr)) then begin
              if (DoXMLExport_IVVc(IVp)==false) then begin
                RecordCheckError(31412,"",-1,"RefStr");
                res = -1;
                goto L99;
              end;
            end;
          end;
          SaveTrans(gTRp);
          AddTTrans_IVVc(gTRp,IVp);
      end;
    end;
    if (check) then begin
      if (MatRowCnt(gSMp)>0) then begin
        gSMp.FileName = "IVVc";
        gSMp.TransNr = IVp.SerNr;
        if (SaveSim(gSMp)) then begin end;
        CreateRecordLink(IVp,curcomp,gSMp,curcomp);  
      end;    
    end;  
  end else begin
    if (HasLocalization("USA")) then begin
      res = IVGetExternalTaxRates(IVp,tstr);
      if (res>1) then begin
        MessageBox(res," " & tstr);
        res = -1;
      end;
    end;
  end;
 
  if (HasLocalization("SVN")) then begin
    if (IVp.InvType==kInvoiceTypeCash) then begin
      if (IVp.OKFlag!=0 and IVp.Invalid==0 and blank(IVp.TaxAdminServSeal)) then begin
        if (nonblank(IVp.RefStr)) then begin
          IVp.OfficialSerNr = "";
        end else begin        
/*        
          res = IVVcSVNFiscalization(false,IVp,errstr);
          if (res!=0) then begin
            IVp.OfficialSerNr = "";
            IVp.TaxAdminServSeal = "";
            if (blank(IVp.RefStr)) then begin
              RecordCheckError(res,errstr,-1,"RefStr");
              res = -1;
              goto L99;
            end;
          end;
*/          
        end;
      end;
    end;
  end;
  
  if (transf and NonBlank(newCashBackCardNr)) then begin //Edit***************************Sasha2,12:15 14.08.2017 {
    RecordNew(LoyaltyCardr);
    LoyaltyCardr.SerNr = newCashBackCardNr;
    LoyaltyCardr.CustCode = IVp.CustCode;
    LoyaltyCardr.CustName = IVp.Addr0;
    LoyaltyCardr.StartDate = IVp.InvDate;
    LoyaltyCardr.LCMLevel = GetCashBackLoyProgramByCardPrefix(newCashBackCardNr);
    SendLoyaltyCardToCRM(LoyaltyCardr);// Edit ************************** BPI Ukraine - KramarAlexandr - 05, 14 02 2020 y. at 9:53:50 AM
    RECORDSTORE(LoyaltyCardr,false);
    IVp.LoyaltyCardNr = LoyaltyCardr.SerNr;
  end; //Edit***************************Sasha2,12:15 14.08.2017 }
  
  if(transf)then begin
  	if(left(IVp.CustCode,3)!="FOB")then begin
  		if(blank(IVp.CRMid))then begin
  			SendIVVisitToCRM(IVp);// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 18 September 2018 17:29:10
  		end else begin
  			SendUpdateIVVisitToCRM(IVp);
  		end;
 		end;
  end;
	
L99:;
  if (res!=0) then begin 
    IVp.SerNr = oldnr; 
    IVp.OfficialSerNr = oldOfficialSerNr;
    IVp.OfficialSerNrSerie = "";
  end;
	ORr.SerNr = IVp.OrderNr;
	/*if(CurrentCompany==29 and ReadFirstMain(ORr,1,true))then begin
		if(IV2p.OKFlag==0 and IVp.OKFlag==1)then begin
			ORr.ECORSuccOK = 1;
			if(RecordStore(ORr,true))then begin end;
		end;
	end;*/
L999:;
	if(matrowcnt(IVp)==0)then begin
  	logtext(0,"End Check IV V&B Receipt   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  " & IVp.SerNr);
  end;
	logtext(0,"Finish");
	LogProcTime("IVVcRecordCheck",getcurtick()-curtick); 
  IVVcRecordCheck = res;
  RETURN;
END;

global
function Boolean CLInforIVExists(LongInt ivnr,string filename,var LongInt clinser)
BEGIN
  Boolean res;
  record CLInIVVc CLInIVr;
  
  CLInIVr.SerNr = ivnr;
  CLInIVr.FileName = filename;
  res = ReadFirstKey("FileName",CLInIVr,2,true);
  clinser = CLInIVr.CLInNr;
  CLInforIVExists = res;
  RETURN;
END;

procedure IVLastTransDate(LongInt ivnr,var date tdp)
BEGIN
  record IPrsVc mainr;
  Date blankd;
  
  tdp = blankd;
  mainr.IVNr = ivnr;
  if (ReadLastKey("IVKey",mainr,1,true)) then begin
    tdp = mainr.TransDate;
  end;  
  RETURN;
END;

global
function LongInt IVVcRecordRemoveTest(var record IVVc IVr,record IVVc IV2r,LongInt long3,LongInt long4)
BEGIN
  LongInt res;
  record IVVc lIVr;
  record ARVc ARr;
  record DBLockBlock DBLb;
  record MainCLBlock MCLb;
  Date lasttrdate;
  Boolean found;
  LongInt clin;
  Integer actnr;
  record ActVc Actr;
  record RLinkVc RLr;
  
  res = 1;
  BlockLoad(DBLb);
  BlockLoad(MCLb);
  if (IVr.OKFlag==0) then begin
    if (IVr.OrderNr!=-1) then begin      
      if (IVr.Sum4>0) then begin // Has to be allowed to delete Invoice connected to Downpayment, which is negative....
        if (long3>0) then begin
          MessageBox(1560,"");
        end;  
        res = 0;
        goto LIVVcRecordRemoveTest;
      end;  
    end;
  end;
  if (IVr.OKFlag!=0) then begin
    if (IVr.TransDate>DBLb.DeleteBeforeDate) then begin
      if (long3>0) then begin
        MessageBox(1560,"");
      end;
      res = 0;
      goto LIVVcRecordRemoveTest;
    end;
    if ((IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) and (IVr.CredInv!=-1)) then begin
      lIVr.SerNr = IVr.CredInv;
      found = ReadFirstMain(lIVr,1,true);
      if (found) then begin
        if (long3>0) then begin
          MessageBox(1560,"");
        end;
        res = 0;
        goto LIVVcRecordRemoveTest;
      end;
    end else begin
      ARr.InvoiceNr = IVr.SerNr;
      if (ReadFirstMain(ARr,1,true)) then begin
        if (long3>0) then begin
          MessageBox(1560,"");
        end;
        res = 0;
        goto LIVVcRecordRemoveTest;
      end;
    end;
    IVLastTransDate(IVr.SerNr,lasttrdate);
    if (lasttrdate>DBLb.DeleteBeforeDate) then begin
      if (long3>0) then begin
        MessageBox(1560,"");
      end;
      res = 0;
      goto LIVVcRecordRemoveTest;
    end;
  end;
  if (MCLb.CashCollection!=0) then begin
    if (CLInforIVExists(IVr.SerNr,"IVVc",clin)) then begin
      if (long3>0) then begin
        MessageBox(2070,clin);
      end;
      res = 0;
      goto LIVVcRecordRemoveTest;      
    end;
  end;
  if (UserCanAction("DeleteNotOKedInvoiceWithCAE",false)==false) then begin
    if (nonblank(IVr.CAE)) then begin
      MessageBox(2912,"");
      res = 0;
      goto LIVVcRecordRemoveTest;
    end;
  end;
  if (HasLocalization("ARG")) then begin
    if (ArgEInvoiceBeingSentRemote(IVr.SerNr,IVr.OfficialSerNr,false)) then begin
      MessageBox(2914,"");
      res = 0;
      goto LIVVcRecordRemoveTest;
    end;
  end;
  if (IVr.RoyaltyIVFlag!=0) then begin
    if (RoyaltyRecordExistsForCN(IVr)) then begin
      MessageBox(1560,"");
      res = 0;
      goto LIVVcRecordRemoveTest;
    end;
  end;
  actnr = 1;
  while (ReadRecordLink(IVr,actnr,Actr,RLr)) begin
    if (Actr.TodoFlag==kTodoFlagApproval) then begin
      if (long3>0) then begin MessageBox(22408,""); end;
      res = 0;
      goto LIVVcRecordRemoveTest;
    end;
    actnr = actnr + 1;
  end;
  logtext(0,"IVVcRecordRemoveTest");
  
LIVVcRecordRemoveTest:;
  IVVcRecordRemoveTest = res;  
  RETURN;
end;

