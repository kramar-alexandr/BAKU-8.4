//server-only
external procedure ExtractObj(string,var Integer,var string);
external function Boolean POVc_PasteArtCode(var record POVc,Integer,Boolean);// Edit ************************** Friday, 31 August 2012 16:50:21
external procedure POVc_PasteQuant(var record POVc,Integer);// Edit ************************** Friday, 31 August 2012 16:50:20
external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);
remote function boolean CompanyIsJWLikeCompany(Integer);
external updating procedure ECPUFromPODsm(var record POVc,var record PUVc);
external updating procedure CCPUFromPODsm(var record POVc,var record PUVc, vector val, vector boolean,  vector boolean);
external updating function Integer CreateVIFromPO(LongInt,record RcVc,var record VIVc);
remote procedure CreatePufromIVforPLHandle(record RcVc,integer,var string);
remote updating function LongInt RecordAction_raPastePUInVI(record PUVc,var record VIVc,var string);
remote function Boolean VIVc_PasteAccNumber(var record VIVc,string,Boolean,Integer);
external procedure VISumup(record VIVc,var val);
remote procedure VICalcVals(var record VIVc);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external procedure PUSumUp(var record PUVc);
remote procedure PUVc_PasteCostPrice(var record PUVc,Integer);
remote function Boolean VIDClassSumEFAfter(Integer,Integer,Integer);
external function val CalculateVINettVal(record VIVc,Boolean);
remote function Boolean POVc_PasteVECode(var record POVc,Boolean);
external function roundmode SetRoundModeD(Integer);
remote procedure IVVc_PastePrice(var record IVVc,record IVVc,Integer,var string);
remote function Boolean IVVc_PasteQuantity2(var record IVVc,Integer,var Boolean,var record LSerialPortDeviceVc);
remote procedure PUDClassSumEFAfterRemote(var record PUVc,Integer);
external procedure LogProcTime(string,longint);
remote procedure ORSumup(var record ORVc);
remote procedure ORVc_PastePrice(var record ORVc,Integer,var Boolean);
remote procedure ORDchsum(var record ORVc,Integer);
external function Boolean VIVc_PasteVECode(var record VIVc,Integer,Boolean,Boolean,var string);
external function Boolean GetAccName(string,var string,Integer);
external procedure ExtractObj(string,var Integer,var string);
external procedure ExtractObjectsByType(string, string, var array string, var integer);
remote procedure VICalcVals(var record VIVc);
external procedure VISumup(record VIVc,var val);
external procedure VIVc_PastePayVal(var record VIVc);
//external procedure MyExtractObj(string,var Integer,var string);
 external function val AbsoluteVal(val);
remote updating procedure CreateNewGlobalItem(var record INVc);
external function roundmode SetRoundModeD(Integer);
external updating procedure DeleteTransaction(LongInt,Integer);
external procedure TRSumup(var record TRVc,var val);
external function string 60 RemoveObjectFromObjectList(string,string);
remote procedure VIVc_PastePayDeal(var record VIVc);
external procedure IVSumup(var record IVVc,Boolean);
external procedure NextM4SerialNumber(string,var string);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
external procedure POSumup(var record POVc);
remote function Boolean POVc_PasteVECode(var record POVc,Boolean);
external function Boolean PasteCustInOrder(var record ORVc,string,string,var string,var string);
remote procedure ORVc_PasteLocation(var record ORVc,Integer);
remote function Boolean ORVc_PasteArtCode(var record ORVc,Integer,var string,var string,Boolean);
remote procedure ORVc_PasteQuant(var record ORVc,Integer,Boolean,var Boolean);



SetLangMode(LangRussian,"RUS",0);


// edited by BPI { //functions transferred here from 6.4 file halcust/halpatch/WindowTagTools.hal bacause there is no such origin file in 8.4
global
function Boolean HasJewelleryInterface()
begin
  //record ModuleBlock Modb;
  
  if(CompanyIsJWLikeCompany(currentcompany))then begin
  	HasJewelleryInterface = 1;
  end;
 /*if (IsEnterprise) then begin
    BlockLoad(Modb);
    HasJewelleryInterface = Modb.JewelleryInterface;
  end else begin
    HasJewelleryInterface = HasBooleanWTag("HasJewelleryInterface");
  end;*/
  return;
end;


function string 200 ParseClassification(string class)
begin
	string 200 res,cl;
	record DIVc DIr;
	integer pos;
	
	pos = 0;
	ExtractObj(class,pos,cl);
	DIr.Code = cl;
	if(readfirstmain(DIr,1,true))then begin
	res = DIr.Name;
	end;
  while (nonblank(cl)) begin
    ExtractObj(class,pos,cl);
    DIr.Code = cl;
  	if(readfirstmain(DIr,1,true))then begin
  		res = res & "	" & DIr.Name;
  	end;	
  end;
	
	ParseClassification = res;
return;
end;

global function string 255 GetClassString(string artcode)
begin
record INVc INr;
string 255 res;
	
	res = "";
	INr.Code = artcode;
	if(readfirstmain(INr,1,true))begin
		res = ParseClassification(INr.DispGroups);
	end;
	
	GetClassString = res;
return;
end;

global function string 255 GetPriceString(string picelist,string artcode,string curcode,string serial)
begin
record INVc INr;
Record PLDefVc PLDefr;
string 255 res,plcur,pltstr;
val plprice;
record PLVc PLr;

	res = "";
	
	if(nonblank(picelist))then begin
		PLDefr.Code = picelist;
		if(readfirstmain(PLDefr,1,true))then begin
			plcur = PLDefr.CurncyCode;
		end;
		PLr.ArtCode = artcode;
		PLr.PLCode = picelist;
		PLr.SerialNr = serial;
		if(readfirstkey("SerialNr",PLr,3,true))then begin
			if(nonblank(PLr.CurncyCode) and PLr.CurncyCode!=plcur)then begin
				plcur = PLr.CurncyCode;
			end;
			plprice = PLr.ExVatPrice;
		end else begin
			PLr.ArtCode = artcode;
			PLr.PLCode = picelist;
			if(readfirstmain(PLr,2,true))then begin
				if(nonblank(PLr.CurncyCode) and PLr.CurncyCode!=plcur)then begin
					plcur = PLr.CurncyCode;
				end;
				plprice = PLr.ExVatPrice;
			end;			
		end;
	end;
	pltstr = "";// Edit ************************** Thursday, 4 April 2013 10:43:51
	if(curcode!=plcur and nonblank(plcur))then begin
		pltstr = "(" & plprice & plcur &")";// Edit ************************** Thursday, 4 April 2013 10:43:52
	end;
	res = pltstr;
	GetPriceString = res;
	
return;
end;

global procedure GetTwoStrings(string picelist,string artcode,string curcode,var string pricestr,var string classstr,string serial)
begin
	record INVc INr;
	record OldDIVc OldDIr;
	pricestr = "";
	classstr = "";
	
	pricestr = GetPriceString(picelist,artcode,curcode,serial);
	if(currentcompany==25)then begin
		INr.Code = artcode;
		if(ReadFirstMain(INr,1,true))then begin
				classstr = INr.MainDisp & "                  " &  INr.SNOne;
		end;
	end else begin
		classstr = GetClassString(artcode);
	end;
	
return;
end; // edited by BPI } //functions transferred here from 6.4 file halcust/halpatch/WindowTagTools.hal bacause there is no such origin file in 8.4





global updating function integer CreateORFromIDEAPOConsDsm(var record POVc POr, var record ORVc ORr, var string warn) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 13:23 31.03.2021
begin
	row POVc POrw;
	integer wn,i,mtrw,curcomp, keys, oscnt, k;
	row ORVc ORrw;
	record LocationVc Locr;
	string 100 backfob,msg,warning,errstr,inwarning, OldCode, key;
	integer res,rowor;
	record MainStockBlock MSb;
	record ConsItemVc CIr;
	record INVc INr, UINr, ConsIN, OldConsINr, ConsINr;
	vector string 255 Brands;
	boolean chsum, TrHs2, testf, testfrowf;
	integer comp;
	record BPIBrandVc BBr;
	record ConsCompBlock CCB;
	record PosVc Posr;	
	string 255 obj;
	record ItemStatusVc ISr;
	array string 255 tags, asubdi, aacc;
	
	
	BlockLoad(CCB);
	curcomp = currentcompany;
	mtrw = matrowcnt(POr);
	for(i=0;i<mtrw;i=i+1)begin
		matrowget(POr,i,POrw);
		INr.Code = POrw.ArtCode;
		if(readFirstMain(INr,1,true)) then begin
			Brands[POrw.ArtCode] = INr.BPIBrand;
		end;
	end;	
			
	Locr.Code = "CWH_I";
	if(readfirstmain(Locr,1,true))then begin
		backfob = Locr.FOBSuplier;
	end;
	comp = currentcompany;
	// SetCompany(18,false);//++++++++++++++++++++++++ CC in
	blockload(MSb);
	recordnew(ORr);
	ORr.CustCode = backfob;
	if (PasteCustInOrder(ORr,ORr.CustCode,"",warning,errstr)) then begin
	end;
	ORr.Location = "CWH_I";
	ORVc_PasteLocation(ORr,-1);
	// ORr.OrderClass = "STOCK";
	// ORr.CurncyCode = POr.CurncyCode;
	ORr.CurncyCode = "AZN";
	mtrw = matrowcnt(POr);
	rowor = 0;
	for(i=0;i<mtrw;i=i+1)begin
		matrowget(POr,i,POrw);
		if (left(INr.Code,3)=="IN_") then begin
			CIr.Code = POrw.ArtCode;
			key = "Code";
			keys = 1;
		end else begin
			CIr.LocCode = POrw.ArtCode;
			CIr.BrandCode = Brands[POrw.ArtCode];
			key = "LocCodeBrand";
			keys = 2;
		end;
		CIr.LocCode = POrw.ArtCode;
		CIr.BrandCode = Brands[POrw.ArtCode];
		BBr.Code = Brands[POrw.ArtCode];
		if(ReadFirstMain(BBr,1,true)) then begin
		end;
		Posr.Code = "CWH14";
		Locr.Code = ORr.Location;
		if(ReadFirstMain(Locr,1,true)) then begin
			obj = Locr.Objects;
		end;
		if(nonblank(obj)) then begin
			if(!SetInSet(obj,ORr.Objects)) then begin
				if(blank(ORr.Objects)) then begin
					ORr.Objects = obj;
				end else begin
					ORr.Objects = ORr.Objects & "," & obj;
				end;
			end;	
		end;
		if (CurrentCompany==18) then begin
			if (!SetInSet("CC",ORr.Objects)) then begin
				if (nonblank(ORr.Objects)) then begin ORr.Objects = ORr.Objects & ","; end;
				ORr.Objects = ORr.Objects & "CC";
			end;
			if (!SetInSet("IDE",ORr.Objects)) then begin
				ExtractObjectsByType(ORr.Objects,"SUBDI",asubdi,oscnt);
				for(k=0;k<asubdi.length;k=k+1)begin
					if(nonblank(asubdi[k]))then begin
						ORr.Objects = RemoveObjectFromObjectList(ORr.Objects,asubdi[k]);
					end;
				end;
				if (nonblank(ORr.Objects)) then begin ORr.Objects = ORr.Objects & ","; end;
				ORr.Objects = ORr.Objects & "IDE";
			end;
			if (!SetInSet("SNT",ORr.Objects)) then begin
				cleararray(aacc);
				ExtractObjectsByType(ORr.Objects,"ACC",aacc,oscnt);
				for(k=0;k<aacc.length;k=k+1)begin
					if(nonblank(aacc[k]))then begin
						ORr.Objects = RemoveObjectFromObjectList(ORr.Objects,aacc[k]);
					end;
				end;
				if (nonblank(ORr.Objects)) then begin ORr.Objects = ORr.Objects & ","; end;
				ORr.Objects = ORr.Objects & "SNT";
			end;
		end;
		if(ReadFirstKey(key,CIr,keys,true)) then begin
			testfrowf = true;
			if(POrw.ItemConsgType==0) then begin
				ISr.Code = CIr.Code;
				ISr.Location = ";;;";
				if(ReadFirstMain(ISr,2,true)) then begin end;
				if(ISr.Instock<1) then begin testfrowf = false; end;
			end;
			if(testfrowf)then begin
				//clearrow(ORr,ORrw,rowor);
				ORrw.ArtCode = CIr.Code;
				ORrw.ECReceived = POr.IDGDEAPORef;
				ORrw.ECReservComp = 28;
				ORrw.Quant = POrw.Quant;	
				//ORrw.Price = POrw.Price;
				ORrw.GlobalItemArtCode = CIr.LocCode;
				ORrw.IDAltCode = CIr.BrandCode;
				ORrw.Price = BlankVal;
				ORrw.BasePrice = BlankVal;
				matrowput(ORr,rowor,ORrw);	
				ORr.OrderClass = "CLIEN";
				ORVc_PasteArtCode(ORr,rowor,inwarning,warning,false);
				matrowget(ORr,rowor,ORrw);
				//ORrw.Price = POrw.Price;
				matrowput(ORr,rowor,ORrw);
				ORVc_PasteQuant(ORr,rowor,true,chsum);
				matrowget(ORr,rowor,ORrw);
				ORrw.Price = BlankVal;
				ORrw.BasePrice = BlankVal;
				ORrw.rowGP = BlankVal;
				ORrw.LCPOrow = i + 1;
				matrowput(ORr,rowor,ORrw);
				rowor = rowor + 1;
			end;
		end;
	end;
	
	if(matrowcnt(ORr)<1)then begin
		warn = "Товаров по заказу на склад нет на косолидированном складе !";
		res = -1;
		goto LRemote_ORFromPOConsDsm;
	end;
	
	
	
	ORSumup(ORr);
	ORr.SerNr = NextSerNr("ORVc",ORr.OrdDate,-1,false,"");
	ORr.OfficialSerNr = POr.SerNr & ":" & 28;
	recordinsert(ORr,true);
	
	LRemote_ORFromPOConsDsm:;  
		
	resetcompany(curcomp);//++++++++++++++++++++++++ CC out
	
	CreateORFromIDEAPOConsDsm = res;
return;
end;




global updating procedure SyncPOInIDG(record POVc POr)  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:05 26.03.2021
begin
	integer mtrw,pos,rownum, oscnt;
	longint i,j,k;
	record POVc IDEAPOr, IDGPOr, OldIDGPOr;
	row POVc POrw, IDGPOrw;
	string 50 ostr;
	array string 100 IDEABrandCodes,artcode;
	boolean foundf,TrHs,testf;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor, oldCode, IDEAObjcts, tstr, VendorBrandObj, warn;
	record POVc oldPOr;
	vector integer OrderedQuant;
	record ConsItemVc CIr;
	record BPIBrandVc BPIBrandr;
	vector string 255 vIdeaBrandIDBrand, vItemBPIBrand, BrandAccObj, BrandObj, VendorBrand;
	record INVc INr,IN2r,INConsr,IN3r,UINr,OldConsINr;
	record OTypeAddControlBlock OTACb;
	row OTypeAddControlBlock OTACrw;
	record ObjVc Objr;
	vector val IDEACodeExist, IDEACodeSum, IDEACodePrice, IDEACodeRebate;
	vector boolean IDEACodeEx;
	array string 255 tags, asubdi, aacc;
	record ORVc ORr;
	
	if (POr.IDReguester=="Client") then begin
		if (CurrentCompany==28) then begin
			BPIBrandr.Code = "";
			i = 0;
			while (loopmain(BPIBrandr,1,true)) begin
				if (nonblank(BPIBrandr.IDEABrandRef)) then begin
					IDEABrandCodes[i] = BPIBrandr.IDEABrandRef;
					vIdeaBrandIDBrand[BPIBrandr.IDEABrandRef] = BPIBrandr.Code;
					pos = 0;
					vendor = "";
					ExtractObjWithSeparator(",",BPIBrandr.Vendor,true,pos,vendor);
					while(nonblank(vendor)) begin
						VendorBrand[BPIBrandr.Vendor] = BPIBrandr.Code;
						ExtractObjWithSeparator(",",BPIBrandr.Vendor,true,pos,vendor);
					end;
					BrandAccObj[BPIBrandr.Code] = BPIBrandr.StockGroup;
					i = i + 1;
				end;
			end;
			ResetLoop(BPIBrandr);
			for (i=0;i<matrowcnt(POr);i=i+1) begin
				matrowget(POr,i,POrw);
				INr.Code = POrw.ArtCode;
				if (ReadFirstMain(INr,1,true)) then begin
					if (blank(INr.BPIBrand)) then begin
						for (j=0;j<IDEABrandCodes.length;j=j+1)begin
							if (SetInSet(IDEABrandCodes[j],INr.DispGroups)) then begin
								vItemBPIBrand[POrw.ArtCode] = vIdeaBrandIDBrand[IDEABrandCodes[j]];
							end;
						end;
					end else begin
						vItemBPIBrand[POrw.ArtCode] = INr.BPIBrand;
					end;
				end;
			end;
			if (POr.IDGDEAPORef<1) then begin
				SetCompany(18,false);		
				BlockLoad(OTACb);
				for (i=0;i<matrowcnt(OTACb);i=i+1) begin
					matrowget(OTACb,i,OTACrw);
					if (OTACrw.STORE=="IDEA") then begin
						IDEAObjcts = OTACrw.SUBDI;
					end;
				end;
				RecordNew(IDGPOr);
				recordCopy(IDGPOr,POr);
				IDGPOr.TransDate = CurrentDate;
				IDGPOr.SerNr = NextSerNr("POVc",IDGPOr.TransDate,-1,false,""); 
				POVc_PasteVECode(POr,true);
				IDGPOr.POClass = "CLIEN";
				IDGPOr.InvAddr4 = "";
				IDGPOr.VEContact = "";
				switch (POr.PayDeal) begin
					case  "A": IDGPOr.PayDeal = "PA";
					case "50": IDGPOr.PayDeal = "PB";
					case "PC": IDGPOr.PayDeal = "PC";
					case "PD": IDGPOr.PayDeal = "PD";
					case "PE": IDGPOr.PayDeal = "PE";
					case "PF": IDGPOr.PayDeal = "PF";
					case "40": IDGPOr.PayDeal = "PG";
					case "30": IDGPOr.PayDeal = "PI";
					case "PJ": IDGPOr.PayDeal = "PJ";
					case "70": IDGPOr.PayDeal = "PK";
					case "PL": IDGPOr.PayDeal = "PL";
					case "PM": IDGPOr.PayDeal = "PM";
					case "PN": IDGPOr.PayDeal = "PN";
					case "BS": IDGPOr.PayDeal = "PO";
					case "60": IDGPOr.PayDeal = "PQ";
					case "PR": IDGPOr.PayDeal = "PR";
					case "20": IDGPOr.PayDeal = "PS";
					case "PT": IDGPOr.PayDeal = "PT";
					case "PU": IDGPOr.PayDeal = "PU";
					case "PV": IDGPOr.PayDeal = "PV";
				end;
				CUr.Code = IDGPOr.VECode;
				if (ReadFirstMain(CUr,1,true)) then begin
					if (nonblank(CUr.VEObjects)) then begin
						pos = 0;
						vendor = "";
						VendorBrandObj = "";
						ExtractObjWithSeparator(",",CUr.VEObjects,true,pos,tstr);
						Objr.Code = tstr;
						if (ReadFirstMain(Objr,1,true)) then begin
							if (Objr.OTCode=="BRAND") then begin
								VendorBrandObj = Objr.Code;
							end;
						end;
					end;
				end;
				IDGPOr.Location = "CWH_I";
				if (!SetInSet("CC",IDGPOr.Objects)) then begin
					if (nonblank(IDGPOr.Objects)) then begin IDGPOr.Objects = IDGPOr.Objects & ","; end;
					IDGPOr.Objects = IDGPOr.Objects & "CC";
				end;
				if (!SetInSet("IDE",IDGPOr.Objects)) then begin
					ExtractObjectsByType(IDGPOr.Objects,"SUBDI",asubdi,oscnt);
					for(k=0;k<asubdi.length;k=k+1)begin
						if(nonblank(asubdi[k]))then begin
							IDGPOr.Objects = RemoveObjectFromObjectList(IDGPOr.Objects,asubdi[k]);
						end;
					end;
					if (nonblank(IDGPOr.Objects)) then begin IDGPOr.Objects = IDGPOr.Objects & ","; end;
					IDGPOr.Objects = IDGPOr.Objects & "IDE";
				end;
				if (!SetInSet("SNT",IDGPOr.Objects)) then begin
					ExtractObjectsByType(IDGPOr.Objects,"ACC",aacc,oscnt);
					for(k=0;k<aacc.length;k=k+1)begin
						if(nonblank(aacc[k]))then begin
							IDGPOr.Objects = RemoveObjectFromObjectList(IDGPOr.Objects,aacc[k]);
						end;
					end;
					if (nonblank(IDGPOr.Objects)) then begin IDGPOr.Objects = IDGPOr.Objects & ","; end;
					IDGPOr.Objects = IDGPOr.Objects & "SNT";
				end;
				if (nonblank(BrandAccObj[VendorBrand[IDGPOr.VECode]])) then begin 
					if (nonblank(IDGPOr.Objects)) then begin IDGPOr.Objects = IDGPOr.Objects & ","; end;
					IDGPOr.Objects = IDGPOr.Objects & BrandAccObj[VendorBrand[IDGPOr.VECode]]; 
				end;
				if (nonblank(VendorBrandObj)) then begin 
					if (!SetInSet(VendorBrandObj,IDGPOr.Objects)) then begin
						if (nonblank(IDGPOr.Objects)) then begin IDGPOr.Objects = IDGPOr.Objects & ","; end;
						IDGPOr.Objects = IDGPOr.Objects & VendorBrandObj; 
					end;
				end;
				IDGPOr.IDGDEAPORef = POr.SerNr;
				for (i=0;i<matrowcnt(IDGPOr);i=i+1) begin
					matrowget(IDGPOr,i,IDGPOrw);
					CIr.LocCode = IDGPOrw.ArtCode;
					CIr.BrandCode = vItemBPIBrand[IDGPOrw.ArtCode];
					if (ReadFirstKey("LocCodeBrand",CIr,2,true)) then begin
						IDGPOrw.VEArtCode = IDGPOrw.ArtCode;
						IDGPOrw.ArtCode = CIr.Code;
						matrowput(IDGPOr,i,IDGPOrw);
					end else begin
						SetCompany(28,false);
						INr.Code = IDGPOrw.ArtCode;
						if (ReadFirstMain(INr,1,true)) then begin
							ResetCompany(18);
							RecordNew(UINr);
							RecordNew(INConsr);
							RecordCopy(INConsr,INr);
							INConsr.Code = "";
							INConsr.UUID = UINr.UUID;
							INConsr.BPIBrand = vItemBPIBrand[IDGPOrw.ArtCode];
							INConsr.AlternativeCode = INr.Code;
							INConsr.EUCodex = INr.AlternativeCode;
							INConsr.SNOne = INr.SNOne;
							INConsr.SN = INr.SN;
							INConsr.Category = INr.Category;
							INConsr.CompletCode = INr.CompletCode;
							INConsr.Name = INr.Name;
							INConsr.Group = INr.Group;
							if(blank(INConsr.Code)) then begin
								OldConsINr.Code = "IN_9999999";
								TrHs = true;
								while (LoopBackKey("Code",OldConsINr,1,TrHs)) begin
									oldCode = OldConsINr.Code;
									TrHs = false;
								end;
								ResetLoop(OldConsINr);
								if(blank(oldCode)) then begin oldCode = "IN_0000000"; end;
								NextM4SerialNumber(OldConsINr.Code,INConsr.Code);
							end;
							if (RecordInsert(INConsr,true)) then begin 
								CIr.Code = INConsr.Code;
								if (!ReadFirstMain(CIr,1,true)) then begin
									CIr.Code = INConsr.Code;
									CIr.LocCode = INr.Code;
									CIr.BrandCode = INConsr.BPIBrand;
									RecordStore(CIr,true);
								end;
								IDGPOrw.VEArtCode = IDGPOrw.ArtCode;
								IDGPOrw.ArtCode = CIr.Code;
								matrowput(IDGPOr,i,IDGPOrw);
							end;
						end else begin
							ResetCompany(18);
						end;
					end;
				end;
				POSumup(IDGPOr);
				RecordStore(IDGPOr,true);
				if (POr.OKFlag==1) then begin
					//recordCopy(OldIDGPOr,IDGPOr);
					IDGPOr.OKFlag = 1;
					//RecordUpdate(OldIDGPOr,IDGPOr,true);
					RecordStore(IDGPOr,true);
					CreateORFromIDEAPOConsDsm(IDGPOr,ORr,warn);
					createrecordlink(ORr,18,IDGPOr,18);
					createrecordlink(IDGPOr,18,ORr,18);
				end;
				SetCompany(28,false);
				POr.IDGDEAPORef = IDGPOr.SerNr;
				POr.VECode = "FOB_SKLAD";
				logtext(0,POr.IDGDEAPORef);
				RecordStore(POr,true);
				createrecordlink(POr,CurrentCompany,IDGPOr,18);
				createrecordlink(IDGPOr,18,POr,CurrentCompany);
			end else begin
				logtext(0,"CurrentCompany  " & CurrentCompany);
				for (i=0;i<matrowcnt(POr);i=i+1) begin
					matrowget(POr,i,POrw);
					IDEACOdeExist[POrw.ArtCode] = IDEACOdeExist[POrw.ArtCode] + POrw.Quant;
					IDEACodeSum[POrw.ArtCode] = IDEACodeSum[POrw.ArtCode] + POrw.Sum;
					IDEACodePrice[POrw.ArtCode] = POrw.Price;
					IDEACodeRebate[POrw.ArtCode] = POrw.vRebate;
					IDEACodeEx[POrw.ArtCode] = true;
				end;
				SetCompany(18,false);	
				IDGPOr.SerNr = POr.IDGDEAPORef;	
				if (ReadFirstMain(IDGPOr,1,true)) then begin
					switch (POr.PayDeal) begin
						case  "A": IDGPOr.PayDeal = "PA";
						case "50": IDGPOr.PayDeal = "PB";
						case "PC": IDGPOr.PayDeal = "PC";
						case "PD": IDGPOr.PayDeal = "PD";
						case "PE": IDGPOr.PayDeal = "PE";
						case "PF": IDGPOr.PayDeal = "PF";
						case "40": IDGPOr.PayDeal = "PG";
						case "30": IDGPOr.PayDeal = "PI";
						case "PJ": IDGPOr.PayDeal = "PJ";
						case "70": IDGPOr.PayDeal = "PK";
						case "PL": IDGPOr.PayDeal = "PL";
						case "PM": IDGPOr.PayDeal = "PM";
						case "PN": IDGPOr.PayDeal = "PN";
						case "BS": IDGPOr.PayDeal = "PO";
						case "60": IDGPOr.PayDeal = "PQ";
						case "PR": IDGPOr.PayDeal = "PR";
						case "20": IDGPOr.PayDeal = "PS";
						case "PT": IDGPOr.PayDeal = "PT";
						case "PU": IDGPOr.PayDeal = "PU";
						case "PV": IDGPOr.PayDeal = "PV";
					end;
					IDGPOr.CurncyCode = POr.CurncyCode;
					IDGPOr.CheckCurncyCode = POr.CheckCurncyCode;
					IDGPOr.IDMfrFinDate = POr.IDMfrFinDate;
					IDGPOr.IDOldMfrFinConfirmDate = POr.IDOldMfrFinConfirmDate;
					IDGPOr.IDMfrFinConfirmDate = POr.IDMfrFinConfirmDate;
					IDGPOr.IDStatus = POr.IDStatus;
					IDGPOr.Reference = POr.Reference;
					for (i=matrowcnt(IDGPOr)-1;i>=0;i=i-1) begin
						matrowget(IDGPOr,i,IDGPOrw);
						if (IDEACodeEx[IDGPOrw.VEArtCode]) then begin
							IDEACodeEx[IDGPOrw.VEArtCode] = false;
							IDGPOrw.Quant = IDEACOdeExist[IDGPOrw.VEArtCode];
							IDGPOrw.Sum = IDEACodeSum[IDGPOrw.VEArtCode];
							IDGPOrw.Price = IDEACodePrice[IDGPOrw.VEArtCode];
							IDGPOrw.vRebate = IDEACodeRebate[IDGPOrw.VEArtCode];
							matrowput(IDGPOr,i,IDGPOrw);
						end else begin
							matrowdelete(IDGPOr,i);
						end;
					end;
					getvectortags(IDEACodeEx,tags);
					for (i=0;i<tags.length;i=i+1) begin
						if (IDEACodeEx[tags[i]]) then begin
							CIr.LocCode = tags[i];
							CIr.BrandCode = vItemBPIBrand[tags[i]];
							mtrw = matrowcnt(IDGPOr);
							if (ReadFirstKey("LocCodeBrand",CIr,2,true)) then begin
								IDGPOrw.VEArtCode = CIr.LocCode;
								IDGPOrw.ArtCode = CIr.Code;
								matrowput(IDGPOr,mtrw,IDGPOrw);
								POVc_PasteArtCode(IDGPOr,mtrw,false);
								matrowget(IDGPOr,mtrw,IDGPOrw);
								IDGPOrw.Quant = IDEACOdeExist[tags[i]];
								IDGPOrw.Sum = IDEACodeSum[tags[i]];
								IDGPOrw.Price = IDEACodePrice[tags[i]];
								IDGPOrw.vRebate = IDEACodeRebate[tags[i]];
								matrowput(IDGPOr,mtrw,IDGPOrw);
								POVc_PasteQuant(IDGPOr,mtrw);
							end else begin
								SetCompany(28,false);
								INr.Code = tags[i];
								if (ReadFirstMain(INr,1,true)) then begin
									logtext(0,"+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_");
									ResetCompany(18);
									RecordNew(UINr);
									RecordNew(INConsr);
									RecordCopy(INConsr,INr);
									INConsr.Code = "";
									INConsr.UUID = UINr.UUID;
									INConsr.BPIBrand = vItemBPIBrand[tags[i]];
									INConsr.AlternativeCode = INr.Code;
									INConsr.EUCodex = INr.AlternativeCode;
									INConsr.SNOne = INr.SNOne;
									INConsr.SN = INr.SN;
									INConsr.Category = INr.Category;
									INConsr.CompletCode = INr.CompletCode;
									INConsr.Name = INr.Name;
									INConsr.Group = INr.Group;
									if(blank(INConsr.Code)) then begin
										OldConsINr.Code = "IN_9999999";
										TrHs = true;
										while (LoopBackKey("Code",OldConsINr,1,TrHs)) begin
											oldCode = OldConsINr.Code;
											TrHs = false;
										end;
										ResetLoop(OldConsINr);
										if(blank(oldCode)) then begin oldCode = "IN_0000000"; end;
										NextM4SerialNumber(OldConsINr.Code,INConsr.Code);
									end;
									if (RecordInsert(INConsr,true)) then begin 
										CIr.Code = INConsr.Code;
										if (!ReadFirstMain(CIr,1,true)) then begin
											CIr.Code = INConsr.Code;
											CIr.LocCode = INr.Code;
											CIr.BrandCode = INConsr.BPIBrand;
											RecordStore(CIr,true);
										end;
										IDGPOrw.VEArtCode = CIr.LocCode;
										IDGPOrw.ArtCode = CIr.Code;
										matrowput(IDGPOr,mtrw,IDGPOrw);
										POVc_PasteArtCode(IDGPOr,mtrw,false);
										matrowget(IDGPOr,mtrw,IDGPOrw);
										IDGPOrw.Quant = IDEACOdeExist[tags[i]];
										IDGPOrw.Sum = IDEACodeSum[tags[i]];
										IDGPOrw.Price = IDEACodePrice[tags[i]];
										IDGPOrw.vRebate = IDEACodeRebate[tags[i]];
										matrowput(IDGPOr,mtrw,IDGPOrw);
										POVc_PasteQuant(IDGPOr,mtrw);
									end;
								end;
							end;
						end;
					end;
				end;
				POSumup(IDGPOr);
				RecordStore(IDGPOr,true);
				if (POr.OKFlag==1) then begin
					//recordCopy(OldIDGPOr,IDGPOr);
					IDGPOr.OKFlag = 1;
					//RecordUpdate(OldIDGPOr,IDGPOr,true);
					RecordStore(IDGPOr,true);
					CreateORFromIDEAPOConsDsm(IDGPOr,ORr,warn);
					createrecordlink(ORr,18,IDGPOr,18);
					createrecordlink(IDGPOr,18,ORr,18);
				end;
				SetCompany(28,false);
			end;
		end else begin
			if (CurrentCompany==18 and POr.IDGDEAPORef>1) then begin
				for (i=0;i<matrowcnt(POr);i=i+1) begin
					matrowget(POr,i,POrw);
					IDEACOdeExist[POrw.VEArtCode] = IDEACOdeExist[POrw.VEArtCode] + POrw.Quant;
					IDEACodeSum[POrw.VEArtCode] = IDEACodeSum[POrw.VEArtCode] + POrw.Sum;
					IDEACodePrice[POrw.VEArtCode] = POrw.Price;
					IDEACodeRebate[POrw.VEArtCode] = POrw.vRebate;
					IDEACodeEx[POrw.VEArtCode] = true;
				end;
				SetCompany(28,false);	
				IDGPOr.SerNr = POr.IDGDEAPORef;			
				if (ReadFirstMain(IDGPOr,1,true)) then begin
					for (i=matrowcnt(IDGPOr)-1;i>=0;i=i-1) begin
						matrowget(IDGPOr,i,IDGPOrw);
						if (IDEACodeEx[IDGPOrw.ArtCode]) then begin
							IDEACodeEx[IDGPOrw.ArtCode] = false;
							IDGPOrw.Quant = IDEACOdeExist[IDGPOrw.ArtCode];
							IDGPOrw.Sum = IDEACodeSum[IDGPOrw.ArtCode];
							IDGPOrw.Price = IDEACodePrice[IDGPOrw.ArtCode];
							IDGPOrw.vRebate = IDEACodeRebate[IDGPOrw.ArtCode];
							matrowput(IDGPOr,i,IDGPOrw);
						end else begin
							matrowdelete(IDGPOr,i);
						end;
					end;
					getvectortags(IDEACodeEx,tags);
					for (i=0;i<tags.length;i=i+1) begin
						logtext(0,tags[i]);
						if (IDEACodeEx[tags[i]]) then begin
							INr.Code = tags[i];
							mtrw = matrowcnt(IDGPOr);
							if (ReadFirstKey("Code",INr,1,true)) then begin
								IDGPOrw.ArtCode = INr.Code;
								matrowput(IDGPOr,mtrw,IDGPOrw);
								POVc_PasteArtCode(IDGPOr,mtrw,false);
								matrowget(IDGPOr,mtrw,IDGPOrw);
								IDGPOrw.Quant = IDEACOdeExist[tags[i]];
								IDGPOrw.Sum = IDEACodeSum[tags[i]];
								IDGPOrw.Price = IDEACodePrice[tags[i]];
								IDGPOrw.vRebate = IDEACodeRebate[tags[i]];
								matrowput(IDGPOr,mtrw,IDGPOrw);
								POVc_PasteQuant(IDGPOr,mtrw);
							end;
						end;
					end;
				end;
				switch (POr.PayDeal) begin
					case "PA": IDGPOr.PayDeal = "A";
					case "PB": IDGPOr.PayDeal = "50";
					case "PC": IDGPOr.PayDeal = "PC";
					case "PD": IDGPOr.PayDeal = "PD";
					case "PE": IDGPOr.PayDeal = "PE";
					case "PF": IDGPOr.PayDeal = "PF";
					case "PG": IDGPOr.PayDeal = "40";
					case "PI": IDGPOr.PayDeal = "30";
					case "PJ": IDGPOr.PayDeal = "PJ";
					case "PK": IDGPOr.PayDeal = "70";
					case "PL": IDGPOr.PayDeal = "PL";
					case "PM": IDGPOr.PayDeal = "PM";
					case "PN": IDGPOr.PayDeal = "BS";
					case "PO": IDGPOr.PayDeal = "PO";
					case "PQ": IDGPOr.PayDeal = "60";
					case "PR": IDGPOr.PayDeal = "PR";
					case "PS": IDGPOr.PayDeal = "20";
					case "PT": IDGPOr.PayDeal = "PT";
					case "PU": IDGPOr.PayDeal = "PU";
					case "PV": IDGPOr.PayDeal = "PV";
				end;
				IDGPOr.CurncyCode = POr.CurncyCode;
				IDGPOr.CheckCurncyCode = POr.CheckCurncyCode;
				IDGPOr.IDMfrFinDate = POr.IDMfrFinDate;
				IDGPOr.IDOldMfrFinConfirmDate = POr.IDOldMfrFinConfirmDate;
				IDGPOr.IDMfrFinConfirmDate = POr.IDMfrFinConfirmDate;
				IDGPOr.IDStatus = POr.IDStatus;
				POSumup(IDGPOr);
				RecordStore(IDGPOr,true);
				if (POr.OKFlag==1) then begin
					//recordCopy(OldIDGPOr,IDGPOr);
					IDGPOr.OKFlag = 1;
					//RecordUpdate(OldIDGPOr,IDGPOr,true);
					RecordStore(IDGPOr,true);
				end;
				SetCompany(18,false);
				if (POr.OKFlag==1) then begin
					CreateORFromIDEAPOConsDsm(POr,ORr,warn);
					createrecordlink(ORr,18,IDGPOr,18);
					createrecordlink(IDGPOr,18,ORr,18);
				end;
			end;
		end;
	end;
	

return;
end; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:05 26.03.2021
	



global updating procedure CreatePOfromOR(record ORVc ORr)
begin
	integer mtrw,i,j,k,pos,rownum;
	row ORVc ORrw;
	Record POVc POr;
	row POVc POrw;
	string 50 ostr;
	array string 100 class,artcode;
	record INVc INr;
	boolean foundf,TrHs,testf;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor, nobrandItems;
	record POVc oldPOr;
	vector integer OrderedQuant;
	nobrandItems = "";
	mtrw = matrowcnt(ORr);
	For(i=0;i<mtrw;i=i+1) begin
		matrowget(ORr,i,ORrw); 
		if(nonblank(ORrw.ArtCode) and ORrw.stp!=98)then begin
			if(currentcompany!=28)then begin
				INr.Code = ORrw.ArtCode;
				if(readfirstmain(INr,1,true))then begin
					if(INr.ItemType==1)then begin
						pos = 0;
						ostr = "";
						vendor = "";
						if(ORr.OrderClass=="CUSTO") then begin
							vendor = "FOB_SKLAD";
						end else begin	
							ExtractObj(INr.DispGroups,pos,ostr);
							while(nonblank(ostr))begin
								if(nonblank(ostr))then begin
									DIr.Code = ostr;
									if(readfirstmain(DIr,1,true))then begin
										if(DIr.CType=="BRAND")then begin
											vendor = DIr.Name;
										end;
									end;
									ExtractObj(INr.DispGroups,pos,ostr);
								end;
							end;
						end;	
						foundf = false;
						For(j=0;j<k;j=j+1) begin
							if(class[j]==vendor)then begin
								foundf = true;
							end;
						end; 
						if(!foundf)then begin
							class[k]=vendor;
							k=k+1;
						end;
					end;
				end;
			end else begin
				INr.Code = ORrw.ArtCode;
				if(readfirstmain(INr,1,true))then begin
					if(INr.ItemType==1)then begin
						if (blank(INr.BPIBrand)) then begin
							if (nonblank(nobrandItems)) then begin nobrandItems = nobrandItems & ","; end;
							nobrandItems = nobrandItems & INr.Code;
						end;
					end;
				end;
				vendor = ORrw.IDManufacturer;
				foundf = false;
				For(j=0;j<k;j=j+1) begin
					if(class[j]==vendor)then begin
						foundf = true;
					end;
				end; 
				if(!foundf)then begin
					class[k]=vendor;
					k=k+1;
				end;
			end;
		end;
	end;
	if(k<1)then begin
		messagebox(0,"Нет товаров для заказа поставщику !");
	end;
	testf = true;
	if(currentcompany==28)then begin
		if (nonblank(nobrandItems)) then begin
			//messagebox(0,"Нужно заполнить BPIBrand в карточках товаров: " & nobrandItems);// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 02 03 2021 y. at 10:48:36 AM
			//testf = false;
		end;
		if (testf) then begin
			For(j=0;j<k;j=j+1) begin
				POr.Reference = ORr.CustOrdNr & "-" &j+1;
				if(ReadFirstKey("Reference",POr,1,true))then begin testf = false; end;
			end;
			POr.Reference = ORr.CustOrdNr;
			if(ReadFirstKey("Reference",POr,1,true))then begin testf = false; end;
			if(!testf)then begin
				messagebox(0,"По этому счету клиенту уже создавались заказы поставщикам !");
			end;
		end;
	end;
	if(testf)then begin
		For(j=0;j<k;j=j+1) begin
			recordnew(POr);
			rownum = 0;
			POr.OrdNr = ORr.SerNr;
			recordcopy(oldPOr,POr);
			if(currentcompany!=28)then begin
				POr.VECode = "";
				CUr.Name = class[j];
				TrHs = true;
				while(loopkey("Name",CUr,1,TrHs))begin
					testf = true;
					if(CUr.Name!=class[j])then begin TrHs = false; testf = false; end;
					//if(CUr.Code<"0009999" and CUr.Code>"0000001")then begin testf = false; end;
					if ((CUr.VECat=="IDEA") and (currentcompany!=28))then begin testf = false; end;
					if ((CUr.VECat!="IDEA") and (currentcompany==28))then begin testf = false; end;
					
					if(testf)then begin
						if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9 and ORr.OrderClass=="CUSTO") then begin
							POr.VECode = "FOB_SKLAD";
							POVc_PasteVECode(POr,true);
							TrHs = false;
						end else begin
							POr.VECode = CUr.Code;
							POVc_PasteVECode(POr,true);
							TrHs = false;
						end;	
					end;
				end;
				resetloop(CUr);
			end else begin
				CUr.Code = class[j];
				if(!readfirstmain(CUr,1,true))then begin
					DIr.Code = class[j];
					if(ReadFirstMain(DIr,1,true))then begin
						CUr.Name = DIr.Name;
						if(readfirstkey("Name",CUr,1,true))then begin
							POr.VECode = CUr.Code;
						end;
					end;
				end else begin
					POr.VECode = class[j];
				end;
				POVc_PasteVECode(POr,true);
				POr.IDRefPRNum = ORr.CustOrdNr;
				if(k>1)then begin
					POr.Reference = ORr.CustOrdNr & "-" &j+1;
				end else begin
					POr.Reference = ORr.CustOrdNr;
				end;
				POr.IDPrjNum = ORr.AuthorizationCode;
				POr.PlanShipDate = ORr.PlanShipDate;
				POr.IDReguester = ORr.IDReguester;
				POr.SalesMan = ORr.SalesMan;
				POr.IDStatus = "PO On Enquiry";
				POr.PayDeal = ORr.PayDeal;
				POr.IDPayDealText = ORr.IDPayDealText;
				POr.Location = ORr.Location;
				POr.IDCustCode = ORr.CustCode;
				if(nonblank(POr.Objects) and nonblank(POr.IDPrjNum))then begin POr.Objects = POr.Objects & ","; end;
				POr.Objects = POr.Objects & POr.IDPrjNum;
			end;
			
			
			/*if(readfirstkey("Name",CUr,1,true))then begin
				POr.VECode = CUr.Code;
				POVc_PasteVECode(POr,true);
			end else begin
				POr.VECode = "";
			end;*/
			if(nonblank(ORr.AuthorizationCode) and currentcompany==28) then begin
				POr.IDPrjNum = ORr.AuthorizationCode;
			end;
			POr.InvAddr4 = ORr.OrderClass & ORr.SerNr;
			POr.PlanShip = addday(POr.TransDate,CUr.PlanShipDays);
			if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9) then begin
				POr.AllowOtherVEItem = 1;
				POr.CheckCurncyCode = POr.CurncyCode;
			end;	
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(ORr,i,ORrw); 
				if(nonblank(ORrw.ArtCode) and ORrw.stp!=98)then begin
					if(currentcompany!=28)then begin
						INr.Code = ORrw.ArtCode;
						if(readfirstmain(INr,1,true))then begin
							if(INr.ItemType==1)then begin
								pos = 0;
								ostr = "";
								vendor = "";
								ExtractObj(INr.DispGroups,pos,ostr);
								while(nonblank(ostr))begin
									if(nonblank(ostr))then begin
										DIr.Code = ostr;
										if(readfirstmain(DIr,1,true))then begin
											if(DIr.CType=="BRAND")then begin
												vendor = DIr.Name;
											end;
										end;
										ExtractObj(INr.DispGroups,pos,ostr);
									end;
								end;
								ostr = vendor;
								
								if(ostr==class[j] or POr.VECode=="FOB_SKLAD")then begin
									if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9) then begin
										POrw.ItemConsgType = 1;
										matrowput(POr,rownum,POrw);	
									end;	
									POrw.ArtCode = ORrw.ArtCode;
									matrowput(POr,rownum,POrw);							
									POVc_PasteArtCode(POr,rownum,false);
									matrowget(POr,rownum,POrw);
									POrw.Quant = ORrw.Quant;
									POrw.Spec = ORrw.Spec;
									POrw.OrdRow = i;
									matrowput(POr,rownum,POrw);
									POVc_PasteQuant(POr,rownum);
									if(POr.VECode=="FOB_SKLAD") then begin
										matrowget(POr,rownum,POrw);
										POrw.Price = blankval;
										POrw.Sum = blankval;
										matrowput(POr,rownum,POrw);
									end;
									rownum = rownum + 1;
								end;
							end;
						end;
					end else begin
						if(ORrw.IDManufacturer==class[j])then begin
							POrw.ArtCode = ORrw.ArtCode;
							matrowput(POr,rownum,POrw);							
							POVc_PasteArtCode(POr,rownum,false);

							matrowget(POr,rownum,POrw);
							POrw.Quant = ORrw.Quant;
							POrw.Spec = ORrw.Spec;
							POrw.OrdRow = i;
							matrowput(POr,rownum,POrw);
							POVc_PasteQuant(POr,rownum);
							matrowget(POr,rownum,POrw);
							POrw.IDPrmsdDt = POr.PlanShipDate;
							POr.Location = ORrw.Location;
							matrowput(POr,rownum,POrw);
							rownum = rownum + 1;
						end;
					end;
				end;
			end;
				
			POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");  
			if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9) then begin
				POr.OKFlag = 1;
				POr.Location = ORr.Location;
				if(Blank(ORr.Location)) then begin
					messagebox(0,"Поле склад должно быть заполненно");
				end else begin
					recordStore(POr,true);
				end;
			end else begin
				recordStore(POr,true);
				if (FileExists("demoserver")) then begin
					SyncPOInIDG(POr);
				end;
			end;	
			createrecordlink(POr,CurrentCompany,ORr,CurrentCompany);
			createrecordlink(ORr,CurrentCompany,POr,CurrentCompany);
		end; 
	end;


return;
end;






global updating procedure CreatePOOnCurrfromOR(record ORVc ORr)
begin
	integer mtrw,i,j,k,pos,rownum;
	row ORVc ORrw;
	Record POVc POr;
	row POVc POrw;
	string 50 ostr, brCur;
	array string 100 class,artcode;
	record INVc INr;
	boolean foundf,TrHs,testf;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor;
	record POVc oldPOr;
	vector integer OrderedQuant;
	record BPIBrandVc Brandr;
	
	mtrw = matrowcnt(ORr);
	For(i=0;i<mtrw;i=i+1) begin
		matrowget(ORr,i,ORrw); 
		if(nonblank(ORrw.ArtCode) and ORrw.stp!=98)then begin
			if(currentcompany!=28)then begin
				INr.Code = ORrw.ArtCode;
				if(readfirstmain(INr,1,true))then begin
					if(INr.ItemType==1)then begin
						pos = 0;
						ostr = "";
						vendor = "";
						brCur = "";
						if(ORr.OrderClass=="CUSTO") then begin
							if(nonblank(INr.BPIBrand))then begin
								Brandr.Code = INr.BPIBrand;
								if(ReadFirstMain(Brandr,1,true))then begin
									CUr.Code = Brandr.Name;
									CUr.VEType = 1;
									if(ReadFirstKey("VEActCode",CUr,2,true))then begin brCur = CUr.VECurncyCode; end;
								end;
							end;
							if(blank(brCur))then begin
								brCur = INr.LastPurchCurncyCode;
							end;
							vendor = "FOB_SKLAD";
							foundf = false;
							For(j=0;j<k;j=j+1) begin
								if(class[j]==brCur)then begin
									foundf = true;
								end;
							end; 
							if(!foundf)then begin
								class[k] = brCur;
								k = k + 1;
							end;
						end else begin	
							ExtractObj(INr.DispGroups,pos,ostr);
							while(nonblank(ostr))begin
								if(nonblank(ostr))then begin
									DIr.Code = ostr;
									if(readfirstmain(DIr,1,true))then begin
										if(DIr.CType=="BRAND")then begin
											vendor = DIr.Name;
										end;
									end;
									ExtractObj(INr.DispGroups,pos,ostr);
								end;
							end;
							foundf = false;
							For(j=0;j<k;j=j+1) begin
								if(class[j]==vendor)then begin
									foundf = true;
								end;
							end; 
							if(!foundf)then begin
								class[k]=vendor;
								k=k+1;
							end;
						end;	
					end;
				end;
			end;
		end;
	end;
	if(k<1)then begin
		messagebox(0,"Нет товаров для заказа поставщику !");
	end;
	testf = true;
	if(testf)then begin
		For(j=0;j<k;j=j+1) begin
			recordnew(POr);
			rownum = 0;
			POr.OrdNr = ORr.SerNr;
			recordcopy(oldPOr,POr);
			if(currentcompany!=28)then begin
				POr.VECode = "";
				if (ORr.OrderClass!="CUSTO") then begin
					CUr.Name = class[j];
					TrHs = true;
					while(loopkey("Name",CUr,1,TrHs))begin
						testf = true;
						if(CUr.Name!=class[j])then begin TrHs = false; testf = false; end;
						//if(CUr.Code<"0009999" and CUr.Code>"0000001")then begin testf = false; end;
						if ((CUr.VECat=="IDEA") and (currentcompany!=28))then begin testf = false; end;
						if ((CUr.VECat!="IDEA") and (currentcompany==28))then begin testf = false; end;
						
						if(testf)then begin
							if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9 and ORr.OrderClass=="CUSTO") then begin
								POr.VECode = "FOB_SKLAD";
								POVc_PasteVECode(POr,true);
								TrHs = false;
							end else begin
								POr.VECode = CUr.Code;
								POVc_PasteVECode(POr,true);
								TrHs = false;
							end;	
						end;
					end;
					resetloop(CUr);
				end else begin
					POr.VECode = "FOB_SKLAD";
					POVc_PasteVECode(POr,true);
					TrHs = false;
				end;
			end;
			
			POr.InvAddr4 = ORr.OrderClass & ORr.SerNr;
			POr.PlanShip = addday(POr.TransDate,CUr.PlanShipDays);
			if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9) then begin
				POr.AllowOtherVEItem = 1;
				if(ORr.OrderClass=="CUSTO")then begin
					POr.CurncyCode = class[j];
				end;
				POr.CheckCurncyCode = POr.CurncyCode;
			end;	
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(ORr,i,ORrw); 
				if(nonblank(ORrw.ArtCode) and ORrw.stp!=98)then begin
					INr.Code = ORrw.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						if(INr.ItemType==1)then begin
							if(ORr.OrderClass!="CUSTO")then begin
								pos = 0;
								ostr = "";
								vendor = "";
								ExtractObj(INr.DispGroups,pos,ostr);
								while(nonblank(ostr))begin
									if(nonblank(ostr))then begin
										DIr.Code = ostr;
										if(readfirstmain(DIr,1,true))then begin
											if(DIr.CType=="BRAND")then begin
												vendor = DIr.Name;
											end;
										end;
										ExtractObj(INr.DispGroups,pos,ostr);
									end;
								end;
								ostr = vendor;
							end else begin
								brCur = "";
								ostr = "";
								if(nonblank(INr.BPIBrand))then begin
									Brandr.Code = INr.BPIBrand;
									if(ReadFirstMain(Brandr,1,true))then begin
										CUr.Code = Brandr.Name;
										CUr.VEType = 1;
										if(ReadFirstKey("VEActCode",CUr,2,true))then begin brCur = CUr.VECurncyCode; end;
									end;
								end;
								if(blank(brCur))then begin
									brCur = INr.LastPurchCurncyCode;
								end;
								ostr = brCur;
							end;
							
							if(ostr==class[j])then begin
								if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9) then begin
									POrw.ItemConsgType = 1;
									matrowput(POr,rownum,POrw);	
								end;	
								POrw.ArtCode = ORrw.ArtCode;
								matrowput(POr,rownum,POrw);							
								POVc_PasteArtCode(POr,rownum,false);
								matrowget(POr,rownum,POrw);
								POrw.Quant = ORrw.Quant;
								POrw.Spec = ORrw.Spec;
								POrw.OrdRow = i;
								matrowput(POr,rownum,POrw);
								POVc_PasteQuant(POr,rownum);
								if(POr.VECode=="FOB_SKLAD") then begin
									matrowget(POr,rownum,POrw);
									POrw.Price = blankval;
									POrw.Sum = blankval;
									matrowput(POr,rownum,POrw);
								end;
								rownum = rownum + 1;
							end;
						end;
					end;
				end;
			end;
				
			POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");  
			if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9) then begin
				POr.OKFlag = 1;
				POr.Location = ORr.Location;
				if(Blank(ORr.Location)) then begin
					messagebox(0,"Поле склад должно быть заполненно");
				end else begin
					recordStore(POr,true);
				end;
			end else begin
				recordStore(POr,true);
			end;	
			createrecordlink(POr,CurrentCompany,ORr,CurrentCompany);
			createrecordlink(ORr,CurrentCompany,POr,CurrentCompany);
		end; 
	end;


return;
end;
















global updating procedure CCCreatePOfromOR(record ORVc ORr, var record POVc POr)
begin
	integer mtrw,i,j,k,pos,rownum;
	row ORVc ORrw;
	row POVc POrw;
	string 50 ostr;
	array string 100 class,artcode;
	record INVc INr;
	boolean foundf,TrHs,testf;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor;
	record ActVc Actr;
	record BPIBrandVc BBr;
	record LocationVc Locr;
	
	mtrw = matrowcnt(ORr);
	For(i=0;i<mtrw;i=i+1) begin
		matrowget(ORr,i,ORrw); 
		if(nonblank(ORrw.ArtCode))then begin
			INr.Code = ORrw.ArtCode;
			if(readfirstmain(INr,1,true))then begin
				if(INr.ItemType==1 and nonblank(INr.BPIBrand))then begin
					
					BBr.Code = INr.BPIBrand;
					readfirstmain(BBr,1,true);

					foundf = false;
					For(j=0;j<k;j=j+1) begin
	  				if(class[j]==BBr.Vendor)then begin
	  					foundf = true;
	  				end;
					end; 
					
					if(!foundf and nonblank(BBr.Vendor))then begin
						class[k] = BBr.Vendor;
						k=k+1;
					end;
					
					/*pos = 0;
					ostr = "";
					vendor = "";
					ExtractObj(INr.DispGroups,pos,ostr);
					while(nonblank(ostr))begin
						if(nonblank(ostr))then begin
							DIr.Code = ostr;
							if(readfirstmain(DIr,1,true))then begin
								if(DIr.CType=="BRAND")then begin
									vendor = DIr.Name;
								end;
							end;
							ExtractObj(INr.DispGroups,pos,ostr);
						end;
					end;
					foundf = false;
					For(j=0;j<k;j=j+1) begin
	  				if(class[j]==vendor)then begin
	  					foundf = true;
	  				end;
					end; 
					if(!foundf)then begin
						class[k]=vendor;
						k=k+1;
					end;*/
					
				end;	
			end;
		end;
	end;
	
	For(j=0;j<k;j=j+1) begin
		recordnew(POr);
			rownum = 0;
			POr.OrdNr = ORr.SerNr;
			
			POr.VECode = "";
			CUr.Code = class[j];
			TrHs = true;
			/*while(loopkey("Name",CUr,1,TrHs))begin
				testf = true;
				if(CUr.Name!=class[j])then begin TrHs = false; testf = false; end;
				if(CUr.VEType!=1)then begin testf = false; end;
				//if(CUr.Code<"0009999" and CUr.Code>"0000001")then begin testf = false; end;
        if ((CUr.VECat=="IDEA") and (currentcompany!=28))then begin testf = false; end;
        if ((CUr.VECat!="IDEA") and (currentcompany==28))then begin testf = false; end;
				*/
				if(readfirstmain(CUr,1,true))then begin
					testf = true;
					if(testf)then begin
						POr.VECode = CUr.Code;
						POVc_PasteVECode(POr,true);
						TrHs = false;
					end;
				end;
			//end;
			//resetloop(CUr);
			
			
			/*if(readfirstkey("Name",CUr,1,true))then begin
				POr.VECode = CUr.Code;
				POVc_PasteVECode(POr,true);
			end else begin
				POr.VECode = "";
			end;*/

			// POr.InvAddr4 = ORr.OrderClass & ORr.SerNr;
			POr.PlanShip = addday(POr.TransDate,CUr.PlanShipDays);
			
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(ORr,i,ORrw); 
				if(nonblank(ORrw.ArtCode))then begin
					INr.Code = ORrw.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						if(INr.ItemType==1)then begin
							/*pos = 0;
							ostr = "";
							vendor = "";
							ExtractObj(INr.DispGroups,pos,ostr);
							while(nonblank(ostr))begin
								if(nonblank(ostr))then begin
									DIr.Code = ostr;
									if(readfirstmain(DIr,1,true))then begin
										if(DIr.CType=="BRAND")then begin
											vendor = DIr.Name;
										end;
									end;
									ExtractObj(INr.DispGroups,pos,ostr);
								end;
							end;
							ostr = vendor;*/
							
							
							BBr.Code = INr.BPIBrand;
							readfirstmain(BBr,1,true);
							ostr = BBr.Vendor;
							
							if(ostr==class[j])then begin
								if((ORrw.Quant-ORrw.Shipd1)>0)then begin
									POrw.ArtCode = ORrw.ArtCode;
									matrowput(POr,rownum,POrw);
									POVc_PasteArtCode(POr,rownum,false);
									matrowget(POr,rownum,POrw);
									//POrw.Price = ORrw.Price;
									POrw.Quant = ORrw.Quant - ORrw.Shipd1;
									POrw.Spec = ORrw.Spec;
									POrw.OrdRow = i;
									if(ORr.OrderClass == "CLIEN")then begin
										POrw.ItemConsgType = 1;
										POr.POClass = "CLIEN";
									end else begin
										POrw.ItemConsgType = 0;
										POr.POClass = "STOCK";
									end;
									matrowput(POr,rownum,POrw);
									POVc_PasteQuant(POr,rownum);
									rownum = rownum + 1;
								end;
							end;
						end;
					end;
				end;
			end;
		if(matrowcnt(POr)>0)then begin
			POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");  
			POr.Location = ORr.Location;	
			//if(ORr.OrderClass=="CLIEN")then begin
				POr.IDStatus = "PO On Enquiry";
			// end else begin
				// POr.IDStatus = "PO Confirmed";
			// end;
			Locr.Code = ORr.Location;
			if(ReadFirstMain(Locr,1,true)) then begin
				if (!SetInSet(Locr.Objects,POr.Objects)) then begin
					if(blank(POr.Objects)) then begin 
						POr.Objects = Locr.Objects;
					end else begin
						POr.Objects = POr.Objects & "," & Locr.Objects;
					end;
				end;
			end;
			recordStore(POr,false);
			createrecordlink(POr,CurrentCompany,ORr,CurrentCompany);
			createrecordlink(ORr,CurrentCompany,POr,CurrentCompany);
		end;
	end; 


return;
end;





global updating procedure ECCreatestockItPOfromOR(record ORVc ORr, var record POVc POr)
begin
	integer mtrw,i,j,k,pos,rownum;
	row ORVc ORrw;
	row POVc POrw;
	string 50 ostr;
	array string 100 class,artcode;
	record INVc INr;
	boolean foundf,TrHs,testf;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor;
	record ActVc Actr;
	
	
	
	
		recordnew(POr);
		rownum = 0;
		POr.OrdNr = ORr.SerNr;
		
		POr.VECode = "";
		POr.InvAddr4 = ORr.OrderClass & ORr.SerNr;
		mtrw = matrowcnt(ORr);
		For(i=0;i<mtrw;i=i+1) begin
			matrowget(ORr,i,ORrw); 
			if(nonblank(ORrw.ArtCode))then begin
				INr.Code = ORrw.ArtCode;
				if(readfirstmain(INr,1,true))then begin
					if(INr.ItemType==1)then begin				
						POrw.ArtCode = ORrw.ArtCode;
						matrowput(POr,i,POrw);
						POVc_PasteArtCode(POr,i,false);
						matrowget(POr,i,POrw);
						POrw.Quant = ORrw.Quant;
						POrw.Spec = ORrw.Spec;
						POrw.OrdRow = i;
						POrw.Price = INr.LastPurchPrice2;
						matrowput(POr,i,POrw);
						POVc_PasteQuant(POr,i);
					end;
				end;
			end;
		end;
	
		POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");    
		recordStore(POr,false);
		createrecordlink(POr,CurrentCompany,ORr,CurrentCompany);
		createrecordlink(ORr,CurrentCompany,POr,CurrentCompany);


return;
end;



global updating procedure ORLClassGreenColour(longint ORSerNr) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger14:52 21.02.2019
begin
	record IVVc IVr;
	record VIVc VIr;
	record ARVc ARr;
	record APVc APr;
	boolean testf, TrHs, invokf, testf2, testf3, testf4, testf5;
	array longint IVrSerNr, VIrSerNr;
	integer IVcnt, VIcnt, i;
	record ORVc ORr;
	
	ORr.SerNr = ORSerNr;
	if(ReadFirstMain(ORr,1,true))then begin
		if(ORr.Closed==0)then begin
			testf2 = false;
		end else begin
			testf2 = true;
		end;
	end;
	
	testf5 = false;
	testf = false;
	TrHs = true;
	IVr.OrderNr = ORSerNr;
	testf4 = false;
	IVcnt = 0;
	while (loopkey("OrderNr",IVr,1,TrHs)) begin
		invokf = true;
		if(IVr.OrderNr!=ORSerNr)then begin TrHs = false; end;
		if(IVr.OKFlag!=1)then begin invokf = false; end;
		if(TrHs and invokf)then begin
			testf = true;
			testf4 = true;
			IVrSerNr[IVcnt] = IVr.SerNr;
			testf5 = true;
			IVcnt = IVcnt + 1;
		end;
	end;
	resetloop(IVr);
	TrHs = true;
	VIr.POSerNr = ORSerNr;
	VIcnt = 0;
	if(ORr.Closed==0)then begin
		TrHs = testf;
	end else begin
		TrHs = true;
	end;
	testf3 = false;
	while (loopkey("POSerNr",VIr,1,TrHs)) begin
		invokf = true;
		if(VIr.POSerNr!=ORSerNr)then begin TrHs = false; end;
		if(VIr.OKFlag!=1)then begin invokf = false; end;
		if(TrHs and invokf)then begin
			VIrSerNr[VIcnt] = VIr.SerNr;
			testf2 = true;
			testf3 = true;
			testf5 = true;
			VIcnt = VIcnt + 1;
		end;
	end;
	resetloop(VIr);
	
	
	if(IVcnt>0 and testf)then begin
		for (i=0;i<IVcnt;i=i+1) begin
			ARr.InvoiceNr = IVrSerNr[i];
			if(ReadFirstMain(ARr,1,true))then begin
				testf = false;
				i = IVcnt;
			end;
		end;
	end;

	if(VIcnt>0 and testf)then begin
		for (i=0;i<VIcnt;i=i+1) begin
			APr.SerNr = VIrSerNr[i];
			if(ReadFirstMain(APr,1,true))then begin
				testf = false;
				i = VIcnt;
			end;
		end;
	end;
	
	
	if(ORr.Closed==1 and !testf4 and testf3)then begin
		testf = true;
		if(VIcnt>0)then begin
			for (i=0;i<VIcnt;i=i+1) begin
				APr.SerNr = VIrSerNr[i];
				if(ReadFirstMain(APr,1,true))then begin
					testf = false;
					i = VIcnt;
				end;
			end;
		end;
	end;
	
	
	
	
	if(testf and testf2)then begin
		ORr.SerNr = ORSerNr;
		if(ReadFirstMain(ORr,1,true))then begin
			ORr.ECORSuccOK = 1;
			if(RecordStore(ORr,true))then begin end;
		end;
	end else begin
		ORr.SerNr = ORSerNr;
		if(ReadFirstMain(ORr,1,true))then begin
			if(ORr.OrderClass!="EXTPR")then begin
				ORr.ECORSuccOK = 0;
			end; 
			if(ORr.Closed==1 and !testf5)then begin
				ORr.ECORSuccOK = 1;
			end;
			if(RecordStore(ORr,true))then begin end;
		end;
	end;

return;
end; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger14:52 21.02.2019






global updating procedure ORLClassYellowColour(longint ORSerNr) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger14:52 21.02.2019
begin
	record ORVc ORr, LocORr, OldORr, oldLocORr;
	row ORVc ORrw;
	record SHvc SHr;
	record RLinkVc RLr;
	Integer OldComp, LocComp, mtrw, i, c, pos;
	array integer compNr;
	vector boolean Compf;
	boolean ComplSHTestf, OKflagSHTestf, LocAllSHOkf;
	
	logtext(0,ORSerNr & "EC UPD Statuses");
	
	ComplSHTestf = true;
	OKflagSHTestf = true;
	OldComp = CurrentCompany;
	if(SetCompany(29,false))then begin
		ORr.SerNr = ORSerNr;
		if(ReadFirstMain(ORr,1,true))then begin
			mtrw = matrowcnt(ORr);
			c = 0;
			for (i=0;i<mtrw;i=i+1) begin
				matrowget(ORr,i,ORrw);
				if(!Compf[ORrw.ECReservComp])then begin
					Compf[ORrw.ECReservComp] = true;
					compNr[c] = ORrw.ECReservComp;
					c = c + 1;
				end;
			end;
			for (i=0;i<c;i=i+1) begin
				if(SetCompany( compNr[i],false))then begin
					LocAllSHOkf = true;
					LocORr.CustOrdNr = ORSerNr;
					if(ReadFirstKey("CustOrdNr",LocORr,1,true))then begin
						pos = 1;
						while (ReadRecordLink(LocORr,pos,SHr,RLr)) begin
							if(SHr.Sorting!="COMPLETED")then begin ComplSHTestf = false; i = c; end;
							if(SHr.OKFlag!=1)then begin OKflagSHTestf = false; LocAllSHOkf = false; end;
							pos = pos + 1;
						end;
						if (LocAllSHOkf) then begin
							recordCopy(oldLocORr,LocORr);
							LocORr.Reserved = 0;
							if(RecordUpdate(oldLocORr,LocORr,true)==0)then begin
							end;
						end;
					end;
				end;
			end;
			if(SetCompany(29,false))then begin
				ORr.SerNr = ORSerNr;
				if(ReadFirstMain(ORr,1,true))then begin
					RecordCopy(OldORr,ORr);
					if(ComplSHTestf)then begin ORr.ECORLocCompl = 1; end;
					if(OKflagSHTestf)then begin ORr.ECLocSHOK = 1; end;
					if(RecordUpdate(OldORr,ORr,true)==0)then begin
						
					end;
				end;
			end;
		end;
	ResetCompany(OldComp);
	end;

return;
end; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger14:52 21.02.2019






global updating procedure CreateECPOfromLocalOR(record SHVc SHr) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger
begin
	integer mtrw,i,j,k,pos,rownum,OldComp,shmtrw,orn,cucnt,c,vimtrw,vii,ecvcnt,v,cmpnmb,VIOFFCnt,lcnt,ivrcnt;
	record ORVc ORr, ECORr, OldORr;
	row ORVc ORrw, ECORrw;
	record SHVc SH2r;
	row SHVc SHrw, SH2rw;
	record POVc POr;
	row POVc POrw;
	string 50 ostr;
	array string 100 class,artcode,itemcurrency;
	record INVc INr;
	boolean foundf,TrHs,testf,cuf,chsum,locIvOKf,serportf;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor,loccode,errmsg,OffserNr,warning;
	vector string 255 ECCodes, vItemCurrency, OldNewArt,vBarCode,vLocCashier;
	record CompaniesBlock CBb;
	row CompaniesBlock CBrw;
	vector boolean vArtCodeRepeat, IVArtCodef, ORRowf;
	vector integer vArtCodeQTY, ECArt,priceinorcnt;
	vector val ItemPrice, ItemRebate, vItemPrice, vItemFifo, vItemRowCostCurrPrice, vItemRowQuant,vItemRowQuantNew, vItemHTotCostPr, ItemORPriseWRebate, ORRowPrice, IVRowPrice;
	record VIVc VIr, OldVIr, offVIr;
	row VIVc VIrw, OldVIrw;
	record RcVc RepSpec;
	longint r, shLnkNr;
	record IVVc IVr,IV2r;
	row IVVc IVrw;
	record RLinkVc RLinkr;
	record PUVc PUr;
	row PUVc PUrw;
	val ct, SumFO, itemtotcost;
	val fr,to1,to2,br1,br2,totivsum;
	record ItemHistVc IHr;
	record ActVc Actr;
	record ECVendFobSetBlaock ECVFSBb;
	row ECVendFobSetBlaock ECVFSBrw;
	integer ItQty, it, smtrw;
	record RLinkVc RLr;
	record ORVc LORr, GORr;
	record ECCasierDocSetBlock ECCDSb;
	row ECCasierDocSetBlock ECCDSrw;
	record LSerialPortDeviceVc LSPDr;
	record UserVc Userr;


	
	BlockLoad(CBb);
	BlockLoad(ECVFSBb);
	BlockLoad(ECCDSb);
	
	lcnt = matrowcnt(ECCDSb);
	for(i=0;i<lcnt;i=i+1)begin
		matrowget(ECCDSb,i,ECCDSrw);
		vLocCashier[ECCDSrw.LocCode] = ECCDSrw.CashierName;
	end;
	
	
	ORr.SerNr = SHr.OrderNr;
	if(ReadFirstMain(ORr,1,true))then begin
		cucnt = 0;
		mtrw = matrowcnt(ORr);
		shmtrw = matrowcnt(SHr);
		loccode = SHr.Location;
		cmpnmb = currentcompany;
		for(j=0;j<shmtrw;j=j+1) begin
			matrowget(SHr,j,SH2rw);
			IHr.FileName = "SHVc";
			IHr.TransNr = SHr.SerNr;
			IHr.Row = j;
			if (ReadFirstKey("FNTransNr",IHr,3,true))then begin
				vItemRowCostCurrPrice[SH2rw.ArtCode] = vItemRowCostCurrPrice[SH2rw.ArtCode] + IHr.TotCostPriceCurncy;
				vItemHTotCostPr[SH2rw.ArtCode] = vItemHTotCostPr[SH2rw.ArtCode] + SH2rw.FIFORowVal;
				vItemRowQuant[SH2rw.ArtCode] = vItemRowQuant[SH2rw.ArtCode] - IHr.Qty;
				ORRowPrice[SH2rw.OrdRow] = SH2rw.FIFORowVal;
				ORRowf[SH2rw.OrdRow] = true;
				IVRowPrice[SH2rw.ArtCode] = SH2rw.FIFORowVal;
			end;
		end;
		for(i=0;i<shmtrw;i=i+1) begin
			cuf = true;
			matrowget(SHr,i,SHrw);
			ECArt[SHrw.ArtCode] = SHrw.Ordered;
			INr.Code = SHrw.ArtCode;
			if(ReadFirstMain(INr,1,true))then begin
				vBarCode[INr.Code] = INr.BarCode;
				SH2r.SerNr = SHr.SerNr;
				if(ReadfirstMain(SH2r,1,true))then begin end;
				for(j=0;j<cucnt;j=j+1)begin
					if(INr.LastPurchCurncyCode==itemcurrency[j])then begin
						cuf = false;
					end;
				end;
				vItemCurrency[SHrw.ArtCode] = INr.LastPurchCurncyCode;
				IVArtCodef[SHrw.ArtCode] = true;
				vItemPrice[SHrw.ArtCode] = vItemRowCostCurrPrice[SHrw.ArtCode] / vItemRowQuant[SHrw.ArtCode];
				vItemFifo[SHrw.ArtCode] = vItemHTotCostPr[SHrw.ArtCode] / vItemRowQuant[SHrw.ArtCode];
				if(cuf)then begin
					itemcurrency[cucnt] = INr.LastPurchCurncyCode;
					cucnt = cucnt + 1;
				end;
			end;
		end;
		For(i=0;i<mtrw;i=i+1) begin
			matrowget(ORr,i,ORrw); 
			ItemORPriseWRebate[ORrw.ArtCode & "_" & ORrw.Price] = ORrw.Price - ((ORrw.Price / 100) * ORrw.vRebate);
			if(ECArt[ORrw.ArtCode]>0)then begin
				ECCodes[ORrw.GlobalItemArtCode] = "Y";
				vArtCodeQTY[ORrw.GlobalItemArtCode] = ECArt[ORrw.ArtCode];
			end;
			if(ORRowf[i])then begin
			 // logtext(0,ORrw.Quant);
				// logtext(0,"Price-" & ORrw.Price & " Price finded-" & vItemFifo[ORrw.ArtCode]);
				// ORrw.Price = vItemFifo[ORrw.ArtCode];
				// ORrw.Sum = vItemFifo[ORrw.ArtCode] * ORrw.Quant;
				// logtext(0,"Price-" & ORrw.Price & " Price finded-" & vItemFifo[ORrw.ArtCode]);
				// ORrw.vRebate = 0;
				// matrowput(ORr,i,ORrw); 
			end;
		end;
		//ORSumup (ORr);
		if(recordstore(ORr,true))then begin end;
		i=0;
		while (ReadRecordLink(ORr,i,Actr,RLinkr))begin
			if(Actr.MainPersons==vLocCashier[loccode])then begin
				recorddelete(Actr);
			end;
			i = i + 1;
		end;
		i=0;
		while (ReadRecordLink(ORr,i,SH2r,RLinkr))begin
			if(SH2r.SerNr==SHr.SerNr)then begin
				shLnkNr = i;
			end;
			i = i + 1;
		end;
		if (ReadRecordLink(ORr,shLnkNr,IVr,RLinkr))then begin
			ivrcnt = matrowcnt(IVr);
			recordCopy(IV2r,IVr);
			for (i=0;i<ivrcnt;i=i+1) begin
				matrowget(IVr,i,IVrw);
				if(IVArtCodef[IVrw.ArtCode])then begin
					IVrw.Price = IVRowPrice[IVrw.ArtCode] / IVrw.Quant; 
					IVrw.Sum = IVRowPrice[IVrw.ArtCode];
					matrowput(IVr,i,IVrw);
				end;
			end;
			IVSumup(IVr,true);
			IVr.SalesMan = CurrentUser;
			if (left(IVr.SalesMan,2)=="SA")then begin
				IVr.SalesMan = "";
				Userr.Code = "";
				while (LoopMain(Userr,1,blank(IVr.SalesMan))) begin
					if ((Userr.IsSalesMan!=0) and (Userr.Closed==0)) then begin
						IVr.SalesMan = Userr.Code;
					end;
				end;
			end;
			RecordUpdate(IV2r,IVr,true);
			if(IVr.OKFlag==1)then begin
				locIvOKf = true;
			end;
		end;
	end;
	
	OldComp = CurrentCompany;
	
	
	
	if(SetCompany(29,false))then begin
		BlockLoad(ECVFSBb);
		for(c=0;c<cucnt;c=c+1)begin
			TrHs = true;
			i = 0;
			INr.Code = "";
			while (loopmain(INr,1,TrHs))begin
				if(ECCodes[INr.GlobalArtCode]=="Y")then begin
					ECCodes[INr.GlobalArtCode] = INr.Code;
					vArtCodeRepeat[INr.Code] = true;
					i=i+1;
				end;
				if(i==mtrw)then begin TrHs = false; end;
			end;
			resetloop(INr);
			
			matrowget(CBb,OldComp-1,CBrw);
			RecordNew(POr);
			POr.InvAddr4 = right(ORr.OfficialSerNr,(len(ORr.OfficialSerNr)-3));
			ECORr.SerNr = right(ORr.OfficialSerNr,(len(ORr.OfficialSerNr)-3));
			if(ReadFirstMain(ECORr,1,true))then begin 
				mtrw = matrowcnt(ECORr);
				For(i=0;i<mtrw;i=i+1) begin
					matrowget(ECORr,i,ECORrw);
					if(ItemPrice[ECORrw.ArtCode]==0)then begin
						ItemPrice[ECORrw.ArtCode] = ECORrw.Price;
						ItemRebate[ECORrw.ArtCode] = ECORrw.vRebate;
					end;
				end;
			end;
			ecvcnt = matrowcnt(ECVFSBb);
			//logtext(0,ecvcnt);
			for(v=0;v<ecvcnt;v=v+1)begin
				matrowget (ECVFSBb,v,ECVFSBrw);
				//logtext(0,ECVFSBrw.LocCode & " <> " & loccode);
				if(ECVFSBrw.LocCode==loccode and cmpnmb==ECVFSBrw.CompanyNr)then begin
					POr.VECode = ECVFSBrw.VendName;
					v = ecvcnt;
				end;
			end;
			POVc_PasteVECode(POr,true);
			//POr.VECode = "FOB_" & ORr.Location;
			//POr.Addr0 = "FOB_" & CBrw.CompName;
			POr.TransDate = CurrentDate;
			POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");   
			POr.OKFlag = 1;
			
			rownum = 0;
			mtrw = matrowcnt(ORr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(ORr,i,ORrw); 
				if(nonblank(ORrw.GlobalItemArtCode))then begin
					INr.Code = ECCodes[ORrw.GlobalItemArtCode];
					if(readfirstmain(INr,1,true))then begin
						vendor = INr.BPIBrand;
						if(vArtCodeRepeat[ECCodes[ORrw.GlobalItemArtCode]] and vItemCurrency[right(ORrw.GlobalItemArtCode,len(ORrw.GlobalItemArtCode)-9)]==itemcurrency[c])then begin
							OldNewArt[ECCodes[ORrw.GlobalItemArtCode]] = right(ORrw.GlobalItemArtCode,len(ORrw.GlobalItemArtCode)-9);
							vArtCodeRepeat[ECCodes[ORrw.GlobalItemArtCode]] = false;
							POrw.ArtCode = ECCodes[ORrw.GlobalItemArtCode];
							itemtotcost = itemtotcost + ItemORPriseWRebate[ORrw.ArtCode & "_" & ORrw.Price];
							matrowput(POr,rownum,POrw);
							POVc_PasteArtCode(POr,rownum,false);
							matrowget(POr,rownum,POrw);
							POrw.Quant = vArtCodeQTY[ORrw.GlobalItemArtCode];
							POrw.Spec = ORrw.Spec;
							POrw.OrdRow = i;
							POrw.Price = ItemPrice[POrw.ArtCode];
							POrw.vRebate = ItemRebate[POrw.ArtCode];
							POrw.Sum = ItemPrice[POrw.ArtCode] * POrw.Quant * ((100 - ItemRebate[POrw.ArtCode])*0.01);
							matrowput(POr,rownum,POrw);
							POVc_PasteQuant(POr,rownum);
							rownum = rownum + 1;
						end;
					end;
				end;
			end;
			matrowget(CBb,OldComp-1,CBrw);
			POr.InvAddr4 = right(ORr.OfficialSerNr,(len(ORr.OfficialSerNr)-3));
			ecvcnt = matrowcnt(ECVFSBb);
			for(v=0;v<ecvcnt;v=v+1)begin
				matrowget (ECVFSBb,v,ECVFSBrw);
				//logtext(0,ECVFSBrw.LocCode & " <> " & loccode);
				if(ECVFSBrw.LocCode==loccode and cmpnmb==ECVFSBrw.CompanyNr)then begin
					POr.VECode = ECVFSBrw.VendName;
					v = ecvcnt;
				end;
			end;
			POVc_PasteVECode(POr,true);
			//POr.VECode = "FOB_" & loccode;
			POr.Comment = loccode;
			POr.CurncyCode = itemcurrency[c];
			POr.CheckCurncyCode = itemcurrency[c];
			POr.TransDate = CurrentDate;
			POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");   
			POr.OKFlag = 1;
			
			if(RecordStore(POr,false))then begin end;
			ECPUFromPODsm(POr,PUr);
			GetFullCurncyRate(itemcurrency[c],POr.TransDate,fr,to1,to2,br1,br2);
			PUr.FrRate = fr;
			PUr.ToRateB1 = to1;
			//PUr.PONr = ECORr.CustOrdNr;// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 7 February 2019 14:31:33
			PUr.FreightCompanyRegNr = ECORr.CustOrdNr;
			mtrw = matrowcnt(PUr);
			for (i=0;i<mtrw;i=i+1)begin
				matrowget(PUr,i,PURw); 
				PURw.UPrice = vItemPrice[OldNewArt[PURw.ArtCode]];
				PURw.CostPrice = vItemFifo[OldNewArt[PURw.ArtCode]];
				PURw.Sum = IVRowPrice[OldNewArt[PURw.ArtCode]];
				PUrw.ECCSTItCode = OldNewArt[PURw.ArtCode];
				PUrw.ECCSTItBarCode = vBarCode[OldNewArt[PURw.ArtCode]];
				matrowput(PUr,i,PURw); 
				PUDClassSumEFAfterRemote(PUr,i);
				// PUVc_PasteCostPrice(PUr,i);
				matrowget(PUr,i,PURw); 
				matrowput(PUr,i,PURw); 
				PUSumUp(PUr);
			end;
			if(RecordStore(PUr,true))then begin 
				CreateRecordLink(ECORr,CurrentCompany,PUr,CurrentCompany);  
				CreateRecordLink(PUr,CurrentCompany,ECORr,CurrentCompany);  
				r = RecordAction_raPastePUInVI(PUr,VIr,errmsg);
				//logtext(0,r);
				if(r==0)then begin
					if(ReadFirstMain(VIr,1,true))then begin
						RecordCopy(OldVIr,VIr);
						if(locIvOKf)then begin
							VIr.OKFlag = 1;
						end else begin
							VIr.OKFlag = 0;
						end;
						vimtrw = matrowcnt(VIr);
						for (vii=vimtrw;vii>=0;vii=vii-1)begin
							matrowdelete(VIr,vii);
						end;
						vimtrw = matrowcnt(PUr);
						for (vii=0;vii<mtrw;vii=vii+1)begin
							VIrw.AccNumber = "41/01";
							matrowput(VIr,vii,VIrw);
							VIVc_PasteAccNumber(VIr,"41/01",true,vii);
							matrowget(VIr,vii,VIrw);
							matrowget(PUr,vii,PUrw);
							//VIrw.Sum = Round(PUrw.CostPrice*PUrw.Quant,SetRoundModeD(2));
							VIrw.Sum = PUrw.CostPrice * PUrw.Quant;
							VIrw.Sum = Round(VIrw.Sum,SetRoundModeD(2));
							logtext(0,VIrw.Sum);
							VIrw.Item = PUrw.ArtCode;
							VIrw.qty = PUrw.Quant;
							VIrw.SerialNr = PUrw.SerialNr;
							matrowput(VIr,vii,VIrw);
						end;
						VIr.PayVal = CalculateVINettVal(VIr,true);
						VIr.FrRate = blankval;
						VIr.ToRateB1 = blankval;
						// VIrw.AccNumber = "76";
						// matrowput(VIr,mtrw,VIrw);
						// VIVc_PasteAccNumber(VIr,"41/01",true,mtrw);
						// Smatrowget(VIr,mtrw,VIrw);
						// VIrw.Sum = Round(VIr.PayVal*0.36,SetRoundModeD(2));
						// VIrw.Sum = VIr.PayVal * 0.36;
						// VIrw.Sum = Round(VIrw.Sum,SetRoundModeD(2));
						// VIrw.Item = "";
						// VIrw.qty = blankval;
						// VIrw.Objects = "128";
						// VIrw.SerialNr = "";
						// matrowput(VIr,mtrw,VIrw);
						VIr.PayVal = CalculateVINettVal(VIr,true);
						VIr.CurncyCode = "AZN";
						VIr.POSerNr = PUr.FreightCompanyRegNr;
						if(VIr.POSerNr>0)then begin
							offVIr.InvoiceNr = VIr.POSerNr;
							if(ReadFirstKey("InvoiceNr",offVIr,1,true) and offVIr.SerNr!=VIr.SerNr)then begin
								testf = true;
								VIOFFCnt = 1;
								while (testf) begin
									offVIr.InvoiceNr = VIr.POSerNr & "-" & VIOFFCnt;
									if(ReadFirstKey("InvoiceNr",offVIr,1,true) and offVIr.SerNr!=VIr.SerNr)then begin
										logtext(0,"Enter");
										VIOFFCnt = VIOFFCnt + 1;
									end else begin
										testf = false;
										VIr.InvoiceNr = VIr.POSerNr & "-" & VIOFFCnt;
									end;
								end;
							end else begin
								VIr.InvoiceNr = VIr.POSerNr;
							end;
						end;
						VIr.PayVal = Round(VIr.PayVal,SetRoundModeD(2));
						// logtext(0,VIr.PayVal);
						// if(RecordStore(VIr,true))then begin 
						// matrowget(PUr,mtrw,PUrw);
						if(RecordUpdate(OldVIr,VIr,true)==0)then begin 
							CreateRecordLink(PUr,CurrentCompany,VIr,CurrentCompany);  
							CreateRecordLink(VIr,CurrentCompany,PUr,CurrentCompany);  
							CreateRecordLink(ECORr,CurrentCompany,VIr,CurrentCompany);  
							CreateRecordLink(VIr,CurrentCompany,ECORr,CurrentCompany);  
						end else begin
							logtext(0,"Error!!!");
						end;
					end;
				end;
			end;
			createrecordlink(PUr,CurrentCompany,SHr,OldComp);
			createrecordlink(SHr,OldComp,PUr,CurrentCompany);
			RecordDelete(POr);
		end;
	end;
	ResetCompany(OldComp);
	
return;
end; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger




global updating procedure CreateECPOfromLocalORForCOVID19Period(record SHVc SHr) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger
begin
	integer mtrw,i,j,k,pos,rownum,OldComp,shmtrw,orn,cucnt,c,vimtrw,vii,ecvcnt,v,cmpnmb,VIOFFCnt,lcnt,ivrcnt;
	record ORVc ORr, ECORr;
	row ORVc ORrw, ECORrw;
	record SHVc SH2r;
	row SHVc SHrw, SH2rw;
	record POVc POr;
	row POVc POrw;
	string 50 ostr;
	array string 100 class,artcode,itemcurrency;
	record INVc INr, IN2r;
	boolean foundf,TrHs,testf,cuf,chsum,locIvOKf,serportf,custECOMf;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor,loccode,errmsg,OffserNr,warning;
	vector string 255 ECCodes, vItemCurrency, OldNewArt,vBarCode,vLocCashier;
	record CompaniesBlock CBb;
	row CompaniesBlock CBrw;
	vector boolean vArtCodeRepeat, IVArtCodef, ORRowf;
	vector integer vArtCodeQTY, ECArt,priceinorcnt;
	vector val ItemPrice, ItemRebate, vItemPrice, vItemFifo, vItemRowCostCurrPrice, vItemRowQuant,vItemRowQuantNew, vItemHTotCostPr, ItemORPriseWRebate, ORRowPrice, IVRowPrice, vGIPrice, curCustItemSum;
	record VIVc VIr, OldVIr, offVIr;
	row VIVc VIrw, OldVIrw;
	record RcVc RepSpec;
	longint r, shLnkNr;
	record IVVc IVr,IV2r;
	row IVVc IVrw;
	record RLinkVc RLinkr;
	record PUVc PUr;
	row PUVc PUrw;
	val ct, SumFO, itemtotcost;
	val fr,to1,to2,br1,br2,totivsum,VICostPriceSum,VIRRPPriceSum,VICostPricewithRRPDif;
	record ItemHistVc IHr;
	record ActVc Actr;
	record ECVendFobSetBlaock ECVFSBb;
	row ECVendFobSetBlaock ECVFSBrw;
	integer ItQty, it, smtrw;
	record RLinkVc RLr;
	record ORVc LORr, GORr;
	record ECCasierDocSetBlock ECCDSb;
	row ECCasierDocSetBlock ECCDSrw;
	record LSerialPortDeviceVc LSPDr;
	record GlobalItemVc GIr;

	
	BlockLoad(CBb);
	BlockLoad(ECVFSBb);
	BlockLoad(ECCDSb);
	
	lcnt = matrowcnt(ECCDSb);
	for(i=0;i<lcnt;i=i+1)begin
		matrowget(ECCDSb,i,ECCDSrw);
		vLocCashier[ECCDSrw.LocCode] = ECCDSrw.CashierName;
	end;
	
	
	ORr.SerNr = SHr.OrderNr;
	if(ReadFirstMain(ORr,1,true))then begin
		cucnt = 0;
		mtrw = matrowcnt(ORr);
		shmtrw = matrowcnt(SHr);
		loccode = SHr.Location;
		if (ORr.CustCode=="FOBE_COMMERCE") then begin
			custECOMf = true;
		end;
		cmpnmb = currentcompany;
		for(j=0;j<shmtrw;j=j+1) begin
			matrowget(SHr,j,SH2rw);
			IHr.FileName = "SHVc";
			IHr.TransNr = SHr.SerNr;
			IHr.Row = j;
			if (ReadFirstKey("FNTransNr",IHr,3,true))then begin
				vItemRowCostCurrPrice[SH2rw.ArtCode] = vItemRowCostCurrPrice[SH2rw.ArtCode] + IHr.TotCostPriceCurncy;
				vItemHTotCostPr[SH2rw.ArtCode] = vItemHTotCostPr[SH2rw.ArtCode] + SH2rw.FIFORowVal;
				vItemRowQuant[SH2rw.ArtCode] = vItemRowQuant[SH2rw.ArtCode] - IHr.Qty;
				ORRowPrice[SH2rw.OrdRow] = SH2rw.FIFORowVal;
				ORRowf[SH2rw.OrdRow] = true;
				IVRowPrice[SH2rw.ArtCode] = SH2rw.FIFORowVal;
			end;
		end;
		for(i=0;i<shmtrw;i=i+1) begin
			cuf = true;
			matrowget(SHr,i,SHrw);
			ECArt[SHrw.ArtCode] = SHrw.Ordered;
			INr.Code = SHrw.ArtCode;
			if(ReadFirstMain(INr,1,true))then begin
				vBarCode[INr.Code] = INr.BarCode;
				SH2r.SerNr = SHr.SerNr;
				if(ReadfirstMain(SH2r,1,true))then begin end;
				for(j=0;j<cucnt;j=j+1)begin
					if(INr.LastPurchCurncyCode==itemcurrency[j])then begin
						cuf = false;
					end;
				end;
				vItemCurrency[SHrw.ArtCode] = INr.LastPurchCurncyCode;
				IVArtCodef[SHrw.ArtCode] = true;
				vItemPrice[SHrw.ArtCode] = vItemRowCostCurrPrice[SHrw.ArtCode] / vItemRowQuant[SHrw.ArtCode];
				vItemFifo[SHrw.ArtCode] = vItemHTotCostPr[SHrw.ArtCode] / vItemRowQuant[SHrw.ArtCode];
				if(cuf)then begin
					itemcurrency[cucnt] = INr.LastPurchCurncyCode;
					cucnt = cucnt + 1;
				end;
			end;
		end;
		For(i=0;i<mtrw;i=i+1) begin
			matrowget(ORr,i,ORrw); 
			ItemORPriseWRebate[ORrw.ArtCode & "_" & ORrw.Price] = ORrw.Price - ((ORrw.Price / 100) * ORrw.vRebate);
			if(ECArt[ORrw.ArtCode]>0)then begin
				ECCodes[ORrw.GlobalItemArtCode] = "Y";
				vArtCodeQTY[ORrw.GlobalItemArtCode] = ECArt[ORrw.ArtCode];
			end;
			if(ORRowf[i] and ORr.CustCode=="FOBE_COMMERCE")then begin
			 // logtext(0,ORrw.Quant);
				GIr.Code = ORrw.GlobalItemArtCode;
				ReadFirstMain (GIr,1,true);
				vGIPrice[ORrw.GlobalItemArtCode] = GIr.Price - (GIr.Price / 100 * GIr.Rebate);
				ORrw.Price = GIr.Price - (GIr.Price / 100 * GIr.Rebate);
				ORrw.Sum = ORrw.Price * ORrw.Quant;
				ORrw.vRebate = 0;
				matrowput(ORr,i,ORrw); 
			end else begin
				if (ORrw.Location==SHr.Location) then begin
					curCustItemSum[ORrw.GlobalItemArtCode] = ORrw.Sum;
				end;
			end;
		end;
		ORSumup (ORr);
		if(recordstore(ORr,true))then begin end;
		i=0;
		while (ReadRecordLink(ORr,i,Actr,RLinkr))begin
			if(Actr.MainPersons==vLocCashier[loccode])then begin
				recorddelete(Actr);
			end;
			i = i + 1;
		end;
		i=0;
		while (ReadRecordLink(ORr,i,SH2r,RLinkr))begin
			if(SH2r.SerNr==SHr.SerNr)then begin
				shLnkNr = i;
			end;
			i = i + 1;
		end;
		if (ReadRecordLink(ORr,shLnkNr,IVr,RLinkr))then begin
			ivrcnt = matrowcnt(IVr);
			recordCopy(IV2r,IVr);
			for (i=0;i<ivrcnt;i=i+1) begin
				matrowget(IVr,i,IVrw);
				if(IVArtCodef[IVrw.ArtCode])then begin
					IN2r.Code = IVrw.ArtCode;
					if(readfirstmain(IN2r,1,true) and IVr.CustCode=="FOBE_COMMERCE") then begin 
						IVrw.Price = vGIPrice[IN2r.GlobalArtCode]; 
						IVrw.Sum = vGIPrice[IN2r.GlobalArtCode] * IVrw.Quant;
						matrowput(IVr,i,IVrw);
					end else begin
						
					end;
				end;
			end;
			IVr.SalesMan = CurrentUser;
			IVr.InvDate = CurrentDate;
			IVSumup (IVr,true);
			IVr.ARAcc = "62";
			RecordUpdate(IV2r,IVr,true);
			if(IVr.OKFlag==1)then begin
				locIvOKf = true;
			end;
		end;
	end;
	
	OldComp = CurrentCompany;
	
	
	
	if(SetCompany(29,false))then begin
		BlockLoad(ECVFSBb);
		for(c=0;c<cucnt;c=c+1)begin
			TrHs = true;
			i = 0;
			INr.Code = "";
			while (loopmain(INr,1,TrHs))begin
				if(ECCodes[INr.GlobalArtCode]=="Y")then begin
					ECCodes[INr.GlobalArtCode] = INr.Code;
					vArtCodeRepeat[INr.Code] = true;
					i=i+1;
				end;
				if(i==mtrw)then begin TrHs = false; end;
			end;
			resetloop(INr);
			
			matrowget(CBb,OldComp-1,CBrw);
			recordnew(POr);
			POr.InvAddr4 = right(ORr.OfficialSerNr,(len(ORr.OfficialSerNr)-3));
			ECORr.SerNr = right(ORr.OfficialSerNr,(len(ORr.OfficialSerNr)-3));
			if(ReadFirstMain(ECORr,1,true))then begin 
				mtrw = matrowcnt(ECORr);
				For(i=0;i<mtrw;i=i+1) begin
					matrowget(ECORr,i,ECORrw);
					if(ItemPrice[ECORrw.ArtCode]==0)then begin
						ItemPrice[ECORrw.ArtCode] = ECORrw.Price;
						ItemRebate[ECORrw.ArtCode] = ECORrw.vRebate;
					end;
				end;
			end;
			ecvcnt = matrowcnt(ECVFSBb);
			//logtext(0,ecvcnt);
			for(v=0;v<ecvcnt;v=v+1)begin
				matrowget (ECVFSBb,v,ECVFSBrw);
				//logtext(0,ECVFSBrw.LocCode & " <> " & loccode);
				if(ECVFSBrw.LocCode==loccode and cmpnmb==ECVFSBrw.CompanyNr)then begin
					POr.VECode = ECVFSBrw.VendName;
					v = ecvcnt;
				end;
			end;
			POVc_PasteVECode(POr,true);
			//POr.VECode = "FOB_" & ORr.Location;
			//POr.Addr0 = "FOB_" & CBrw.CompName;
			POr.TransDate = CurrentDate;
			POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");   
			POr.OKFlag = 1;
			
			rownum = 0;
			mtrw = matrowcnt(ORr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(ORr,i,ORrw); 
				if(nonblank(ORrw.GlobalItemArtCode))then begin
					INr.Code = ECCodes[ORrw.GlobalItemArtCode];
					if(readfirstmain(INr,1,true))then begin
						vendor = INr.BPIBrand;
						if(vArtCodeRepeat[ECCodes[ORrw.GlobalItemArtCode]] and vItemCurrency[right(ORrw.GlobalItemArtCode,len(ORrw.GlobalItemArtCode)-9)]==itemcurrency[c])then begin
							OldNewArt[ECCodes[ORrw.GlobalItemArtCode]] = right(ORrw.GlobalItemArtCode,len(ORrw.GlobalItemArtCode)-9);
							vArtCodeRepeat[ECCodes[ORrw.GlobalItemArtCode]] = false;
							POrw.ArtCode = ECCodes[ORrw.GlobalItemArtCode];
							itemtotcost = itemtotcost + ItemORPriseWRebate[ORrw.ArtCode & "_" & ORrw.Price];
							matrowput(POr,rownum,POrw);
							POVc_PasteArtCode(POr,rownum,false);
							matrowget(POr,rownum,POrw);
							POrw.Quant = vArtCodeQTY[ORrw.GlobalItemArtCode];
							POrw.Spec = ORrw.Spec;
							POrw.OrdRow = i;
							POrw.Price = ItemPrice[POrw.ArtCode];
							POrw.vRebate = ItemRebate[POrw.ArtCode];
							POrw.Sum = ItemPrice[POrw.ArtCode] * POrw.Quant * ((100 - ItemRebate[POrw.ArtCode])*0.01);
							matrowput(POr,rownum,POrw);
							POVc_PasteQuant(POr,rownum);
							rownum = rownum + 1;
						end;
					end;
				end;
			end;
			matrowget(CBb,OldComp-1,CBrw);
			POr.InvAddr4 = right(ORr.OfficialSerNr,(len(ORr.OfficialSerNr)-3));
			ecvcnt = matrowcnt(ECVFSBb);
			for(v=0;v<ecvcnt;v=v+1)begin
				matrowget (ECVFSBb,v,ECVFSBrw);
				//logtext(0,ECVFSBrw.LocCode & " <> " & loccode);
				if(ECVFSBrw.LocCode==loccode and cmpnmb==ECVFSBrw.CompanyNr)then begin
					POr.VECode = ECVFSBrw.VendName;
					v = ecvcnt;
				end;
			end;
			POVc_PasteVECode(POr,true);
			//POr.VECode = "FOB_" & loccode;
			POr.Comment = loccode;
			POr.CurncyCode = itemcurrency[c];
			POr.CheckCurncyCode = itemcurrency[c];
			POr.TransDate = CurrentDate;
			POr.SerNr = NextSerNr("POVc",POr.TransDate,-1,false,"");   
			POr.OKFlag = 1;
			
			if(RecordStore(POr,false))then begin end;
			ECPUFromPODsm(POr,PUr);
			GetFullCurncyRate(itemcurrency[c],POr.TransDate,fr,to1,to2,br1,br2);
			PUr.FrRate = fr;
			PUr.ToRateB1 = to1;
			//PUr.PONr = ECORr.CustOrdNr;// Edit ************************** BPI Ukraine - KramarAlexandr - Thursday, 7 February 2019 14:31:33
			PUr.FreightCompanyRegNr = ECORr.CustOrdNr;
			mtrw = matrowcnt(PUr);
			for (i=0;i<mtrw;i=i+1)begin
				matrowget(PUr,i,PURw); 
				PURw.UPrice = vItemPrice[OldNewArt[PURw.ArtCode]];
				PURw.CostPrice = vItemFifo[OldNewArt[PURw.ArtCode]];
				PURw.Sum = IVRowPrice[OldNewArt[PURw.ArtCode]];
				PUrw.ECCSTItCode = OldNewArt[PURw.ArtCode];
				PUrw.ECCSTItBarCode = vBarCode[OldNewArt[PURw.ArtCode]];
				matrowput(PUr,i,PURw); 
				PUDClassSumEFAfterRemote(PUr,i);
				// PUVc_PasteCostPrice(PUr,i);
				matrowget(PUr,i,PURw); 
				matrowput(PUr,i,PURw); 
				PUSumUp(PUr);
			end;
			if(RecordStore(PUr,true))then begin 
				CreateRecordLink(ECORr,CurrentCompany,PUr,CurrentCompany);  
				CreateRecordLink(PUr,CurrentCompany,ECORr,CurrentCompany);  
				r = RecordAction_raPastePUInVI(PUr,VIr,errmsg);
				//logtext(0,r);
				if(r==0)then begin
					if(ReadFirstMain(VIr,1,true))then begin
						RecordCopy(OldVIr,VIr);
						if(locIvOKf)then begin
							VIr.OKFlag = 1;
						end else begin
							VIr.OKFlag = 0;
						end;
						vimtrw = matrowcnt(VIr);
						for (vii=vimtrw;vii>=0;vii=vii-1)begin
							matrowdelete(VIr,vii);
						end;
						VICostPricewithRRPDif = 0;
						VICostPriceSum = 0;
						VIRRPPriceSum = 0;
						vimtrw = matrowcnt(PUr);
						for (vii=0;vii<mtrw;vii=vii+1)begin
							VIrw.AccNumber = "41/01";
							matrowput(VIr,vii,VIrw);
							VIVc_PasteAccNumber(VIr,"41/01",true,vii);
							matrowget(VIr,vii,VIrw);
							matrowget(PUr,vii,PUrw);
							//VIrw.Sum = Round(PUrw.CostPrice*PUrw.Quant,SetRoundModeD(2));
							VIrw.Sum = PUrw.CostPrice * PUrw.Quant;
							VIrw.Sum = Round(VIrw.Sum,SetRoundModeD(2));
							VIrw.Item = PUrw.ArtCode;
							VIrw.qty = PUrw.Quant;
							VIrw.SerialNr = PUrw.SerialNr;
							matrowput(VIr,vii,VIrw);
							VICostPriceSum = VICostPriceSum + VIrw.Sum;
							IN2r.Code = PUrw.ArtCode;
							if(readfirstmain(IN2r,1,true)) then begin end;
							if (custECOMf) then begin
								VIRRPPriceSum = VIRRPPriceSum + Round((vGIPrice[IN2r.GlobalArtCode] * PUrw.Quant),SetRoundModeD(2));
							end else begin
								VIRRPPriceSum = VIRRPPriceSum + curCustItemSum[IN2r.GlobalArtCode];
							end;
						end;
						VICostPricewithRRPDif = VIRRPPriceSum - VICostPriceSum;
						if (VICostPricewithRRPDif > 0) then begin
							VIrw.AccNumber = "76";
							matrowput(VIr,mtrw,VIrw);
							VIVc_PasteAccNumber(VIr,"41/01",true,mtrw);
							matrowget(VIr,mtrw,VIrw);
							matrowget(PUr,mtrw,PUrw);
							//VIrw.Sum = Round(PUrw.CostPrice*PUrw.Quant,SetRoundModeD(2));
							VIrw.Sum = VICostPricewithRRPDif;
							if (nonblank(VIrw.Objects)) then begin VIrw.Objects = VIrw.Objects & ","; end;
							VIrw.Objects = VIrw.Objects & "128";
							matrowput(VIr,mtrw,VIrw);
						end;
						VIr.PayVal = CalculateVINettVal(VIr,true);
						VIr.FrRate = blankval;
						VIr.ToRateB1 = blankval;
						// VIrw.AccNumber = "76";
						// matrowput(VIr,mtrw,VIrw);
						// VIVc_PasteAccNumber(VIr,"41/01",true,mtrw);
						matrowget(VIr,mtrw,VIrw);
						//VIrw.Sum = Round(VIr.PayVal*0.36,SetRoundModeD(2));
						// VIrw.Sum = VIr.PayVal * 0.36;
						// VIrw.Sum = Round(VIrw.Sum,SetRoundModeD(2));
						// VIrw.Item = "";
						// VIrw.qty = blankval;
						// VIrw.Objects = "128";
						// VIrw.SerialNr = "";
						// matrowput(VIr,mtrw,VIrw);
						VIr.PayVal = CalculateVINettVal(VIr,true);
						VIr.CurncyCode = "AZN";
						VIr.POSerNr = PUr.FreightCompanyRegNr;
						if(VIr.POSerNr>0)then begin
							offVIr.InvoiceNr = VIr.POSerNr;
							if(ReadFirstKey("InvoiceNr",offVIr,1,true) and offVIr.SerNr!=VIr.SerNr)then begin
								testf = true;
								VIOFFCnt = 1;
								while (testf) begin
									offVIr.InvoiceNr = VIr.POSerNr & "-" & VIOFFCnt;
									if(ReadFirstKey("InvoiceNr",offVIr,1,true) and offVIr.SerNr!=VIr.SerNr)then begin
										logtext(0,"Enter");
										VIOFFCnt = VIOFFCnt + 1;
									end else begin
										testf = false;
										VIr.InvoiceNr = VIr.POSerNr & "-" & VIOFFCnt;
									end;
								end;
							end else begin
								VIr.InvoiceNr = VIr.POSerNr;
							end;
						end;
						VIr.PayVal = Round(VIr.PayVal,SetRoundModeD(2));
						matrowget(PUr,mtrw,PUrw);
						if(RecordUpdate(OldVIr,VIr,true)==0)then begin 
							CreateRecordLink(PUr,CurrentCompany,VIr,CurrentCompany);  
							CreateRecordLink(VIr,CurrentCompany,PUr,CurrentCompany);  
							CreateRecordLink(ECORr,CurrentCompany,VIr,CurrentCompany);  
							CreateRecordLink(VIr,CurrentCompany,ECORr,CurrentCompany);  
						end else begin
							logtext(0,"Error!!!");
						end;
					end;
				end;
			end;
			createrecordlink(PUr,CurrentCompany,SHr,OldComp);
			createrecordlink(SHr,OldComp,PUr,CurrentCompany);
			RecordDelete(POr);
		end;
	end;
	ResetCompany(OldComp);
	
return;
end; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger



global updating procedure CreatePOfromCCSH(record SHVc SHr) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 11:43 02.07.2019
begin
	integer mtrw,i,j,k,pos,rownum,OldComp,shmtrw,orn,cucnt,c,vimtrw,vii,ecvcnt,v,cmpnmb,VIOFFCnt,lcnt,ccnt,FIFOcnt,keys;
	record ORVc ORr, ECORr;
	row ORVc ORrw, ECORrw;
	record SHVc SH2r;
	row SHVc SHrw, SH2rw;
	record POVc POr;
	row POVc POrw;
	string 50 ostr,POCurCode;
	array string 100 class,artcode,itemcurrency,aLCPOrowNr;
	record INVc INr, LINr, UUINr;
	boolean foundf,TrHs,testf,cuf,chsum,locIvOKf,ccItemf,clientTypef,TrHs1;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor,loccode,errmsg,OffserNr, PUstock, key, ProjCode;
	vector string 255 ECCodes, vItemCurrency, OldNewArt,vBarCode,vLocCashier,vCurrRowCode, INCOde;
	record CompaniesBlock CBb;
	row CompaniesBlock CBrw;
	vector boolean vArtCodeRepeat, shOutItems, ShippdI, INCOdef, consItems;
	vector integer vArtCodeQTY, ECArt,priceinorcnt,vOutItems;
	vector val ItemPrice, ItemRebate, vItemPrice, vItemFifo, vItemRowCostCurrPrice, vItemRowQuant, vItemHTotCostPr, ItemORPriseWRebate, vItemHTotCostPrSH, vPOQty;
	record VIVc VIr, OldVIr, offVIr;
	row VIVc VIrw, OldVIrw;
	record RcVc RepSpec;
	longint r, shLnkN, POComp, PONr;
	record IVVc IVr;
	record RLinkVc RLinkr;
	record PUVc PUr, OldPUr;
	row PUVc PUrw;
	val ct, SumFO, itemtotcost, SumIHQty;
	val fr,to1,to2,br1,br2,totivsum;
	record ItemHistVc IHr;
	record ActVc Actr;
	record ECVendFobSetBlaock ECVFSBb;
	row ECVendFobSetBlaock ECVFSBrw;
	integer ItQty, it, smtrw;
	record RLinkVc RLr;
	record ORVc LORr, GORr;
	record ECCasierDocSetBlock ECCDSb;
	row ECCasierDocSetBlock ECCDSrw;
	record ConsItemVc CIr;
	record LocationVc Locr;
	vector boolean consgStock;
	
	BlockLoad(CBb);
	BlockLoad(ECCDSb);
	
	lcnt = matrowcnt(ECCDSb);
	

	for(i=0;i<lcnt;i=i+1)begin
		matrowget(ECCDSb,i,ECCDSrw);
		vLocCashier[ECCDSrw.LocCode] = ECCDSrw.CashierName;
	end;
	OldComp = CurrentCompany;
	logtext(0,"SHr.OrderNr 1 " & SHr.OrderNr);
	SetCompany(18,false);
	Locr.Code = "";
	TrHs1 = true;
	while(LoopMain(Locr,1,TrHs1)) begin
		if(nonblank(Locr.ConsigStockCode)) then begin
			consgStock[Locr.ConsigStockCode] = true;
		end;
	end;
	ResetLoop(Locr);
	ResetCompany(OldComp);
	ORr.SerNr = SHr.OrderNr;
	if(ReadFirstMain(ORr,1,true))then begin
		if (ORr.OrderClass == "CLIEN") then begin
			clientTypef = true;
		end;
		if (ORr.CustCode=="FOB_IDEA") then begin
			ProjCode = ORr.AuthorizationCode;
		end;
		logtext(0,"ORr.OrderNr 1 " & ORr.SerNr);
		cucnt = 0;
		mtrw = matrowcnt(ORr);
		shmtrw = matrowcnt(SHr);
		loccode = SHr.Location;
		cmpnmb = currentcompany;
		j = 0;
		for(i=0;i<shmtrw;i=i+1) begin
			cuf = true;
			matrowget(SHr,i,SHrw);
			artcode[i] = SHrw.ArtCode;
			aLCPOrowNr[i] = SHrw.LCPOrowNr;
			logtext(0,aLCPOrowNr[i] & " ORrowNr");
			ECArt[SHrw.ArtCode & "_" & SHrw.LCPOrowNr] = SHrw.Ship;
			
			IHr.FileName = "SHVc";
			IHr.TransNr = SHr.SerNr;
			IHr.Row = i;
			TrHs = true;
			FIFOcnt = 0;
			CIr.Code = SHrw.ArtCode;
			if(ReadFirstMain(CIr,1,true))then begin 
				SumIHQty = 0;
				while (LoopBackKey("FNTransNr",IHr,3,TrHs)) begin
					if(IHr.FileName!="SHVc")then begin TrHs = false; end;
					if(IHr.TransNr!=SHr.SerNr)then begin TrHs = false; end;
					if(IHr.Row!=i)then begin TrHs = false; end;
					if(IHr.ArtCode==SHrw.ArtCode and TrHs)then begin
							FIFOcnt = FIFOcnt + 1;
							SumIHQty = SumIHQty + (IHr.Qty * -1);
							vItemFifo[CIr.LocCode & "_" & SHrw.LCPOrowNr] = vItemFifo[CIr.LocCode & "_" & SHrw.LCPOrowNr] + IHr.TotCostPriceCurncy;
							vItemHTotCostPr[CIr.LocCode & "_" & SHrw.LCPOrowNr] = vItemHTotCostPr[CIr.LocCode & "_" & SHrw.LCPOrowNr] + IHr.TotCostPrice;
							vCurrRowCode[IHr.ArtCode] = IHr.CurncyCode;
					end;
				end;
				ResetLoop (IHr);
				vItemFifo[CIr.LocCode & "_" & SHrw.LCPOrowNr] = vItemFifo[CIr.LocCode & "_" & SHrw.LCPOrowNr] / SumIHQty;
				vItemFifo[CIr.Code & "_" & SHrw.LCPOrowNr] = vItemFifo[CIr.LocCode & "_" & SHrw.LCPOrowNr];
				vItemHTotCostPr[CIr.LocCode & "_" & SHrw.LCPOrowNr] = vItemHTotCostPr[CIr.LocCode & "_" & SHrw.LCPOrowNr] / SumIHQty;
				if(SHrw.Ship == 0) then begin
					j = j + 1;
				end else begin
					vItemHTotCostPrSH[CIr.LocCode & "_" & i + 1 - j] = vItemHTotCostPr[CIr.LocCode & "_" & SHrw.LCPOrowNr];
					if (nonblank(SHrw.Location)) then begin
						Locr.Code = SHrw.Location;
						if (ReadFirstMain(Locr,1,true)) then begin
							 if (Locr.StockAcc=="41/02") then begin
									consItems [CIr.LocCode & "_" & i + 1 - j] = true;
							 end;
						end;
					end;
					vItemHTotCostPrSH[CIr.Code & "_" & i + 1 - j] = vItemHTotCostPr[CIr.LocCode & "_" & SHrw.LCPOrowNr];
				end;
			end;
		end;
		For(i=0;i<mtrw;i=i+1) begin
			matrowget(ORr,i,ORrw); 
			// logtext(0,"ORrw.ArtCode 1 " & ORrw.ArtCode & "  " & ECArt[ORrw.ArtCode]);
			if(ECArt[ORrw.ArtCode & "_" & ORrw.LCPOrow]>0)then begin
				chsum = false;
				
				if (ORrw.Quant>ECArt[ORrw.ArtCode & "_" & ORrw.LCPOrow] and ORr.OrderClass == "CLIEN") then begin
					ORrw.Quant = ORrw.Quant - ECArt[ORrw.ArtCode & "_" & ORrw.LCPOrow];
					ORrw.Price = 0;
					ORrw.stp = 1;
					ORrw.Shipd1 = blankval;
					ORrw.Shipd2 = blankval;
					ORrw.LCPOrow = mtrw + 1;
					MatRowInsert(ORr,mtrw,ORrw); 
					ORDchsum(ORr,mtrw);
					matrowget(ORr,mtrw,ORrw); 
					ORSumup(ORr);
					matrowput(ORr,mtrw,ORrw); 
					mtrw = matrowcnt(ORr);
					matrowget(ORr,i,ORrw); 
					chsum = false;
				end;
				
				ORrw.Quant = ECArt[ORrw.ArtCode & "_" & ORrw.LCPOrow];
				CIr.Code = ORrw.ArtCode;
				if(ReadFirstMain(CIr,1,true))then begin 
					ORrw.Price = vItemHTotCostPr[CIr.LocCode & "_" & ORrw.LCPOrow];
				end;
				if (nonblank(ORrw.BrndCurrCode)) then begin
					// vCurrRowCode[ORrw.ArtCode] = ORrw.BrndCurrCode;
				end;
				matrowput(ORr,i,ORrw); 
				ORVc_PastePrice(ORr,i,chsum);
				matrowget(ORr,i,ORrw); 
				if (chsum) then begin
					ORDchsum(ORr,i);
					matrowget(ORr,i,ORrw); 
					ORSumup(ORr);
				end;
				matrowget(ORr,i,ORrw); 
				POComp = ORrw.ECReservComp;
				PONr = ORrw.ECReceived;
				logtext(0,ORrw.ECReceived);
				ItemORPriseWRebate[ORrw.ArtCode] = ORrw.Price - ((ORrw.Price / 100) * ORrw.vRebate);
				// Logtext(0,"Цена по счету клиента дл€ заказа поставщика строка " & i & " - " & ItemORPriseWRebate[ORrw.ArtCode]);
			end else begin
				if (ORrw.Quant==ORrw.Shipd2) then begin
					CIr.Code = ORrw.ArtCode;
					if(ReadFirstMain(CIr,1,true))then begin 
						ShippdI[CIr.LocCode & "_" & ORrw.LCPOrow] = true;
					end;
				end;
			end;
		end;
		if(POComp<=0)then begin
			SetCompany(18,false);
			BlockLoad(ECVFSBb);
			ecvcnt = matrowcnt(ECVFSBb);
			for(v=0;v<ecvcnt;v=v+1)begin
				matrowget (ECVFSBb,v,ECVFSBrw);
				if(ECVFSBrw.VendName==ORr.CustCode)then begin
					POComp = ECVFSBrw.CompanyNr;
					PUstock = ECVFSBrw.LocCode;
					logtext(0,ECVFSBrw.CompanyNr & " yes");
					v = ecvcnt;
				end;
			end;
			ResetCompany(OldComp);
		end;
		RecordStore(ORr,true);
	end;
	
	BlockLoad(ECVFSBb);
	
	if(SetCompany(POComp,false))then begin
		POr.SerNr = PONr; 
		logtext(0,"POr " & POr.SerNr & "  comp  " & currentcompany);
		if(ReadFirstMain(POr,1,true))then begin	
			mtrw = matrowcnt(POr);
			logtext(0,"POr read " & POr.SerNr & "  comp  " & currentcompany);
			POCurCode = "";
			j = 0;
			For(i=mtrw;i>=0;i=i-1) begin
				matrowget(POr,i,POrw); 
				if(nonblank(POrw.ArtCode))then begin
					logtext(0,"POr2 " & POrw.ArtCode & "  comp  " & currentcompany);
					INr.Code = POrw.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						if(SetCompany(18,false)) then begin
							if (left(INr.Code,3)=="IN_") then begin
								CIr.Code = POrw.ArtCode;
								key = "Code";
								keys = 1;
							end else begin
								CIr.LocCode = POrw.ArtCode;
								CIr.BrandCode = INr.BPIBrand;
								key = "LocCodeBrand";
								keys = 2;
							end;
							if(ReadFirstKey(key,CIr,keys,true))then begin
								logtext(0,ECArt[CIr.Code & "_" & i + 1]);
								if(ECArt[CIr.Code & "_" & i + 1]>0) then begin
									logtext(0,"POr4 " & CIr.LocCode & "  comp  " & currentcompany);
									ResetCompany(POComp);
									vOutItems[POrw.ArtCode & "_" & i] = 0;
									if (clientTypef and POrw.Quant > ECArt[CIr.Code & "_" & i + 1]) then begin
										vOutItems[POrw.ArtCode & "_" & i] = POrw.Quant - ECArt[CIr.Code & "_" & i + 1];;
									end;
									POrw.Quant = ECArt[CIr.Code & "_" & i + 1];
									logtext(0,"POrw.Price1" & POrw.Price);
									POrw.Price = vItemFifo[POrw.ArtCode & "_" & i + 1];
									POrw.vRebate = 0;
									POrw.Sum = POrw.Price * POrw.Quant;
									matrowput(POr,i,POrw);
									matrowget(POr,i,POrw);
									SetCompany(18,false)
									matrowget(SHr,i,SHrw); 
									if(nonblank(SHrw.Location) or nonblank(SHr.Location)) then begin
										Locr.Code = "";
										TrHs1 = true;
										while(LoopMain(Locr,1,TrHs1)) begin
											if((blank(SHrw.Location) and Locr.ConsigStockCode==SHr.Location) or Locr.ConsigStockCode==SHrw.Location) then begin
												POrw.ItemConsgType = 1;
												TrHs1 = false;
											end;
										end;
									end;
									ResetCompany(POComp);
									matrowput(POr,i,POrw);
									POVc_PasteQuant(POr,i);
									matrowget(POr,i,POrw);
									logtext(0,"POrw.Price2" & POrw.Price);
									POCurCode = vCurrRowCode[CIr.Code];
								end else begin
									if (!clientTypef) then begin 
										ResetCompany(POComp);
										matrowdelete(POr,i);
									end;
								end;
							end else begin
								logtext(0,"False");
								ResetCompany(POComp);
								matrowdelete(POr,i);
							end;
						end;
						ResetCompany(POComp);
					end;
				end;
			end;
			
			mtrw = matrowcnt(POr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(POr,i,POrw); 
				if(nonblank(POrw.ArtCode))then begin
					INr.Code = POrw.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						if(SetCompany(18,false)) then begin
							if (left(INr.Code,3)=="IN_") then begin
								CIr.Code = POrw.ArtCode;
								key = "Code";
								keys = 1;
							end else begin
								CIr.LocCode = POrw.ArtCode;
								CIr.BrandCode = INr.BPIBrand;
								key = "LocCodeBrand";
								keys = 2;
							end;
							if(ReadFirstKey(key,CIr,keys,true))then begin
								if(ECArt[CIr.Code & "_" & i+1]==0) then begin
									vPOQty[POrw.ArtCode & "_" & i] = POrw.Quant;
									POrw.Quant = 0;
									logtext(0,POrw.ItemConsgType & " 2.1POrw.ItemConsgType");
									matrowput(POr,i,POrw);
									// if (clientTypef) then begin 
										// if (ShippdI[POrw.ArtCode & "_" & i + 1]) then begin
											// j=j+1;
											// logtext(0,j & " j2");
											// logtext(0,i & " i4");
										// end else begin
											// shOutItems[POrw.ArtCode & "_" & i - j] = true;
											// logtext(0,j & " j1");
											// logtext(0,i - j & " i1");
										// end;
									// end;
								end;
							end else begin
								ResetCompany(POComp);
								matrowdelete(POr,i);
							end;
						end;
						ResetCompany(POComp);
					end;
				end;
			end;
			
			
			matrowget(CBb,OldComp-1,CBrw);
			POr.InvAddr4 = right(ORr.OfficialSerNr,(len(ORr.OfficialSerNr)-3));
			ecvcnt = matrowcnt(ECVFSBb);
			for(v=0;v<ecvcnt;v=v+1)begin
				matrowget (ECVFSBb,v,ECVFSBrw);
				//logtext(0,ECVFSBrw.LocCode & " <> " & loccode);
				if(ECVFSBrw.LocCode==loccode and cmpnmb==ECVFSBrw.CompanyNr)then begin
					POr.VECode = ECVFSBrw.VendName;
					v = ecvcnt;
				end;
			end;
			logtext(0,"Save PO");
			mtrw = matrowcnt(POr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(POr,i,POrw);
				logtext(0,"POrw price " & POrw.Price & "  comp  " & currentcompany);
			end;
			POr.CurncyCode = POCurCode;
			POr.CheckCurncyCode = POCurCode;
			
			if(RecordStore(POr,true))then begin 
				CreateRecordLink(POr,CurrentCompany,SHr,18);  
				CreateRecordLink(SHr,18,POr,CurrentCompany);  
			end;
			CCPUFromPODsm(POr,PUr,vItemHTotCostPrSH,shOutItems,consItems);
			// GetFullCurncyRate(itemcurrency[c],POr.TransDate,fr,to1,to2,br1,br2);
			// PUr.FrRate = fr;
			// PUr.ToRateB1 = to1;
			// PUr.FreightCompanyRegNr = ECORr.CustOrdNr;
			// mtrw = matrowcnt(PUr);
			// for (i=0;i<mtrw;i=i+1)begin
				// matrowget(PUr,i,PURw); 
				// PURw.UPrice = vItemPrice[OldNewArt[PURw.ArtCode]];
				// PURw.CostPrice = vItemFifo[OldNewArt[PURw.ArtCode]];
				// PUrw.ECCSTItCode = OldNewArt[PURw.ArtCode];
				// PUrw.ECCSTItBarCode = vBarCode[OldNewArt[PURw.ArtCode]];
				// matrowput(PUr,i,PURw); 
				// PUVc_PasteCostPrice(PUr,i);
				// matrowget(PUr,i,PURw); 
				// matrowput(PUr,i,PURw); 
				// PUSumUp(PUr);
			// end;
			logtext(0,"Save PU");
			PUr.Comment=SHr.Comment;
			if(RecordStore(PUr,true))then begin 
				CreateRecordLink(ORr,18,PUr,CurrentCompany);  
				CreateRecordLink(PUr,CurrentCompany,ORr,18); 
				CreateRecordLink(PUr,CurrentCompany,SHr,18);  
				CreateRecordLink(SHr,18,PUr,CurrentCompany);
				if (nonblank(POr.ItemFromOtherSTockObj)) then begin
					RecordCopy(OldPUr,PUr);
					PUr.OKFlag = 1;
					RecordUpdate(OldPUr,PUr,true);
				end;				
			end;
			readfirstmain(POr,1,true);
			mtrw = matrowcnt(POr);
			logtext(0,"POr read " & POr.SerNr & "  comp  " & currentcompany);
			POCurCode = "";
			if (clientTypef) then begin
				For(i=mtrw-1;i>=0;i=i-1) begin
					matrowget(POr,i,POrw); 
					SetCompany(18,false);
					matrowget(SHr,i,SHrw);
					if(nonblank(SHrw.Location) or nonblank(SHr.Location)) then begin
						if((blank(SHrw.Location) and consgStock[SHr.Location]) or consgStock[SHrw.Location]) then begin
							POrw.ConsgType = 1;
						end;
					end;
					ResetCompany(POComp);
					matrowput(POr,i,POrw);
					if (vOutItems[POrw.ArtCode & "_" & i] > 0) then begin
						POrw.Quant = vOutItems[POrw.ArtCode & "_" & i];
						POrw.Price = 0;
						POrw.stp = 1;
						POrw.Shipd1 = blankval;
						POrw.VEQuant = blankval;
						MatRowInsert(POr,mtrw,POrw); 
						matrowput(POr,mtrw,POrw);					
						POVc_PasteQuant(POr,mtrw);
						matrowget(POr,mtrw,POrw);
						// mtrw = matrowcnt(POr);
						// matrowget(POr,i,POrw);
						// SetCompany(18,false);
						// matrowget(SHr,i,SHrw);
						// if(nonblank(SHrw.Location) or nonblank(SHr.Location)) then begin
							// if((blank(SHrw.Location) and consgStock[SHr.Location]) or consgStock[SHrw.Location]) then begin
								// POrw.ConsgType = 1;
							// end;
						// end;
						// ResetCompany(POComp);
						// matrowput(POr,i,POrw);
					end else begin
						if (vPOQty[POrw.ArtCode & "_" & i] > 0) then begin
							POrw.Quant = vPOQty[POrw.ArtCode & "_" & i];
							matrowput(POr,i,POrw);		
						end;
					end;
				end;
			end;
			if(RecordStore(POr,true))then begin end;
		end else begin
			RecordNew (POr);
			POr.SerNr = NextSerNr("POVc",CurrentDate,-1,false,""); 
			POr.VECode = "FOB_SKLAD";
			POVc_PasteVECode(POr,true);
			POr.Location = PUstock;
			POr.IDPrjNum = ProjCode;
			TrHs = false;
			mtrw = matrowcnt(POr);
			POCurCode = "";
			j = 0;
			For(i=0;i<shmtrw;i=i+1) begin
				if(nonblank(artcode[i]))then begin
					if(SetCompany(18,false)) then begin
						CIr.Code = artcode[i];
						if(ReadFirstMain(CIr,1,true))then begin
							INr.Code = CIr.Code;
							ccItemf = ReadFirstMain(INr,1,true);
							if(ECArt[CIr.Code & "_" & aLCPOrowNr[i]]!=0) then begin
								ResetCompany(POComp);
								if(currentcompany!=18 and currentcompany!=29 and currentcompany!=28 and currentcompany!=9) then begin
									POrw.ItemConsgType = 1;
									matrowput(POr,i,POrw);	
								end;	
								LINr.Code = CIr.LocCode;
								if(!ReadFirstMain(LINr,1,true))then begin
									RecordNew (UUINr);
									RecordNew (LINr);
									RecordCopy (LINr,INr);
									LINr.Code = CIr.LocCode;
									LINr.UUID = UUINr.UUID;
									RecordStore (LINr,true);
									logtext(0,LINr.Code & "  Товар");
									logtext(0,CIr.LocCode & "  Товар");
								end else begin
									if (LINr.BPIBrand!=CIr.BrandCode) then begin
									  LINr.Code = CIr.Code;
										INCOde[CIr.LocCode & "_" & aLCPOrowNr[i]] = LINr.Code;
										if(!ReadFirstMain(LINr,1,true))then begin
											RecordNew (UUINr);
											RecordNew (LINr);
											RecordCopy (LINr,INr);
											LINr.Code = CIr.Code;
											LINr.UUID = UUINr.UUID;
											RecordStore (LINr,true);
											logtext(0,LINr.Code & "  Товар");
											logtext(0,CIr.Code & "  Товар");
											INCOde[CIr.LocCode & "_" & aLCPOrowNr[i]] = LINr.Code;
										end;
									end;
								end;
								if (nonblank(INCOde[CIr.LocCode & "_" & aLCPOrowNr[i]])) then begin
									POrw.ArtCode = INCOde[CIr.LocCode & "_" & aLCPOrowNr[i]];
								end else begin
									POrw.ArtCode = CIr.LocCode;
								end;
								matrowput(POr,j,POrw);							
								POVc_PasteArtCode(POr,j,false);
								matrowget(POr,j,POrw);
								POrw.Quant = ECArt[CIr.Code & "_" & aLCPOrowNr[i]];
								matrowput(POr,j,POrw);
								POVc_PasteQuant(POr,j);
								matrowget(POr,j,POrw);
								POrw.Price = vItemFifo[POrw.ArtCode & "_" & aLCPOrowNr[i]];
								POrw.vRebate = 0;
								POrw.Sum = POrw.Price * POrw.Quant;
								POCurCode = vCurrRowCode[CIr.Code];
								matrowput(POr,j,POrw);
								POVc_PasteQuant(POr,j);
								matrowget(POr,j,POrw);
								SetCompany(18,false);
								matrowget(SHr,i,SHrw);
								if(nonblank(SHrw.Location) or nonblank(SHr.Location)) then begin
									if((blank(SHrw.Location) and consgStock[SHr.Location]) or consgStock[SHrw.Location]) then begin
										POrw.ConsgType = 1;
									end;
								end;
								ResetCompany(POComp);
								matrowput(POr,j,POrw);
								j = j + 1;
							end;
						end;
					end;
					ResetCompany(POComp);
				end;
			end;
			matrowget(CBb,OldComp-1,CBrw);
			POr.InvAddr4 = right(ORr.OfficialSerNr,(len(ORr.OfficialSerNr)-3));
			ecvcnt = matrowcnt(ECVFSBb);
			for(v=0;v<ecvcnt;v=v+1)begin
				matrowget (ECVFSBb,v,ECVFSBrw);
				if(ECVFSBrw.LocCode==loccode and cmpnmb==ECVFSBrw.CompanyNr)then begin
					POr.VECode = ECVFSBrw.VendName;
					v = ecvcnt;
				end;
			end;
			POr.CurncyCode = POCurCode;
			POr.CheckCurncyCode = POCurCode;
			if(matrowcnt(POr))then begin
				if(RecordStore(POr,true))then begin 
					logtext(0,POr.SerNr & " Заказ " & currentcompany);
					CreateRecordLink(POr,CurrentCompany,SHr,18);  
					CreateRecordLink(SHr,18,POr,CurrentCompany);  
				end;
				CCPUFromPODsm(POr,PUr,vItemHTotCostPrSH,shOutItems,consItems);
				POr.FrRate = PUr.FrRate;
				POr.ToRateB1 = PUr.ToRateB1;
				if(RecordStore(POr,true))then begin end;
				PUr.Comment=SHr.Comment;
				if(RecordStore(PUr,true))then begin 
					CreateRecordLink(ORr,18,PUr,CurrentCompany);  
					CreateRecordLink(PUr,CurrentCompany,ORr,18); 
					CreateRecordLink(PUr,CurrentCompany,SHr,18);  
					CreateRecordLink(SHr,18,PUr,CurrentCompany); 
				end;
			end;
		end;
	end;
	ResetCompany(OldComp);
return;
end; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger









global updating function boolean CreateUnlinkedVIfromCCRetPU(record VIVc VIr, record RetPUVc RetPUr, vector integer retPurItemRowNr) // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 13:46 03.02.2020
begin
	integer mtrw,i,j,k,pos,rownum,OldComp,shmtrw,orn,cucnt,c,vimtrw,vii,ecvcnt,v,cmpnmb,VIOFFCnt,lcnt,ccnt,FIFOcnt;
	record ORVc ORr, ECORr;
	row ORVc ORrw, ECORrw;
	record SHVc SH2r;
	row SHVc SHrw, SH2rw;
	record POVc POr;
	row POVc POrw;
	string 50 ostr,POCurCode;
	array string 100 class,artcode,itemcurrency,aLCPOrowNr;
	record INVc INr, LINr, UUINr;
	boolean foundf,TrHs,testf,cuf,chsum,locIvOKf,ccItemf;
	record CUVc CUr;
	record DIVc DIr;
	string 200 vendor,loccode,errmsg,OffserNr, PUstock, curcode;
	vector string 255 ECCodes, vItemCurrency, OldNewArt,vBarCode,vLocCashier,vCurrRowCode;
	record CompaniesBlock CBb;
	row CompaniesBlock CBrw;
	vector boolean vArtCodeRepeat;
	vector integer vArtCodeQTY, ECArt,priceinorcnt;
	vector val ItemPrice, ItemRebate, vItemPrice, vItemRowCostCurrPrice, vItemRowQuant, ItemORPriseWRebate;
	record VIVc OldVIr, offVIr;
	row VIVc VIrw, OldVIrw;
	record RcVc RepSpec;
	longint r, shLnkN, POComp, PONr;
	record IVVc IVr;
	record RLinkVc RLinkr;
	record PUVc PUr;
	row PUVc PUrw;
	val ct, SumFO, itemtotcost;
	val fr,to1,to2,br1,br2,totivsum;
	record ItemHistVc IHr;
	record ActVc Actr;
	record ECVendFobSetBlaock ECVFSBb;
	row ECVendFobSetBlaock ECVFSBrw;
	integer ItQty, it, smtrw;
	record RLinkVc RLr;
	record ORVc LORr, GORr;
	record ECCasierDocSetBlock ECCDSb;
	row ECCasierDocSetBlock ECCDSrw;
	record ConsItemVc CIr;
	row RetPUVc RetPUrw;
	val vItemFifo, vItemHTotCostPr, sumItemFifo, SumItemHTotCostPr;
	string 255 vewarn, tstr;
	record LocationVc Locr;
	integer VIItType;
	
	
	for(i=0;i<matrowcnt(RetPUr);i=i+1) begin
		matrowget (RetPUr,i,RetPUrw);
		INr.Code = RetPUrw.ArtCode;
		if (ReadFirstMain(INr,1,true)) then begin end;
		VIItType = INr.ConsgType;
		IHr.FileName = "RetPUVc";
		IHr.TransNr = RetPUr.SerNr;
		IHr.Row = retPurItemRowNr[RetPUrw.ArtCode];
		TrHs = true;
		while (LoopBackKey("FNTransNr",IHr,3,TrHs)) begin
			if(IHr.FileName!="RetPUVc")then begin TrHs = false; end;
			if(IHr.TransNr!=RetPUr.SerNr)then begin TrHs = false; end;
			if(IHr.Row!=retPurItemRowNr[RetPUrw.ArtCode])then begin TrHs = false; end;
			if(IHr.ArtCode==RetPUrw.ArtCode and TrHs)then begin
				vItemFifo = vItemFifo + IHr.TotCostPriceCurncy;
				vItemHTotCostPr = vItemHTotCostPr + IHr.TotCostPrice;
				curcode = IHr.CurncyCode;
			end;
		end;
		ResetLoop (IHr);
	end;
	
	Locr.Code = RetPUr.Location;
	if(ReadFirstMain(Locr,1,true))then begin end;
	// RecordNew(VIr);
	VIr.VECode = RetPUr.VECode;
	VIVc_PasteVECode(VIr,0,false,true,vewarn);
	VIr.SerNr = NextSerNr("VIVc",currentdate,-1,false,""); 
	VIr.TransDate = CurrentDate;
	switch (VIItType) begin
    case 0: VIrw.AccNumber = "41/06";
    case 1: VIrw.AccNumber = "41/02";
    case 2: VIrw.AccNumber = "12";
	end;
	if (GetAccName(VIrw.AccNumber,tstr,60)) then begin end;
	VIrw.Comment = tstr; 
	VIrw.Sum = vItemFifo;
	matrowput(VIr,0,VIrw);  
	VICalcVals(VIr);
	VISumup(VIr,ct); 
	VIr.PayVal = vItemFifo;
	VIVc_PastePayVal(VIr);
	VIr.InvDate = CurrentDate;
	VIr.DueDate = CurrentDate;
	if(nonblank(VIr.Objects) and nonblank(Locr.Objects)) then begin VIr.Objects = VIr.Objects & ","; end;
	VIr.Objects = VIr.Objects & Locr.Objects;
	VIr.PayDeal = "CN";
	VIVc_PastePayDeal(VIr);
	VIr.CurncyCode = curcode;
	if(curcode!="AZN")then begin
		if(vItemFifo<vItemHTotCostPr)then begin
			VIr.FrRate = 1;
			VIr.ToRateB1 = vItemHTotCostPr / vItemFifo;
		end else begin
			VIr.ToRateB1 = 1;
			VIr.FrRate = vItemHTotCostPr / vItemFifo;
		end;
	end else begin
		VIr.ToRateB1 = blankval;
		VIr.FrRate = blankval;
	end;
	if (recordStore(VIr,true)) then begin end;
	CreateUnlinkedVIfromCCRetPU = true;
return;
end; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 13:46 03.02.2020










global procedure POFromORRn(record RcVc RepSpec)
begin
	record ORVc ORr;
	record POVc POr;
	row ORVc ORrw,OR2rw;
	row POVc Porw;
	boolean testf,TrHs,potestf,poTrHs;
	integer mtrw,i,keyint;
	integer pomtrw,poi;
	boolean printf;
	array string 50 artcodes;
	integer acnt,j;
	boolean afound;
	longint curtick;
	
	curtick = getcurtick();
	startreportnoheaderjob("Отчет по необходимым заказам");
	
	startformat(15);
		outstring(0,0,"№ Счета",false);
		outstring(50,0,"Дата сч.",false);
		outstring(150,0,"Клиент",false);
		outstring(200,0,"Имя",false);
		outstring(300,0,"Запланированная отгрузка",false);
	endformat;
	gray_divider(0,150);
	
	
	ORr.OrdDate = RepSpec.sStartDate;
	keyint = 1;
	if(RepSpec.long1>=0)then begin
		ORr.SerNr = RepSpec.long1;
		keyint = 2;
	end;
	TrHs = true;
	while(loopkey("OrdDate",ORr,keyint,TrHs))begin
		printf = false;
		testf = true;
		if(ORr.OrdDate>RepSpec.sEndDate)then begin testf = false; TrHs = false; end;
		if(ORr.Closed>0)then begin testf = false; end;
		if(nonblank(RepSpec.f1) and RepSpec.f1!=ORr.OrderClass)then begin testf = false; end;
		if(blank(ORr.OrderClass))then begin testf = false; end;
		if(RepSpec.long1>=0 and ORr.SerNr!=RepSpec.long1)then begin TrHs = false; end;
		
		if(testf)then begin

			acnt = 0;
			mtrw = matrowcnt(ORr);
			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(ORr,i,ORrw);
	  			afound = true;
	  			For(j=0;j<acnt;j=j+1) begin
	  				if(artcodes[j]==ORrw.ArtCode)then begin
	  					matrowget(ORr,j,OR2rw);
	  					OR2rw.Quant = OR2rw.Quant + ORrw.Quant;
	  					matrowput(ORr,j,OR2rw);
	  					afound = false;
	  				end;
					end;
					if(afound)then begin
						artcodes[acnt] = ORrw.ArtCode;
						acnt = acnt + 1;
					end; 
	  			ORrw.Shipd1 = 0;
	  			ORrw.Invd = 0;
	  		matrowput(ORr,i,ORrw);
	  		if(afound==false)then begin
	  			matrowdelete(ORr,i);
	  			mtrw = mtrw - 1;
	  			i=i-1;
	  		end;
			end; mtrw = matrowcnt(ORr);
			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(ORr,i,ORrw);
	  			ORrw.Shipd1 = 0;
	  		matrowput(ORr,i,ORrw);
			end; 
			
			
			POr.OrdNr = ORr.SerNr;
			poTrHs = true;
			While(loopkey("OrdNr",POr,1,poTrHs)) begin
	  		potestf = true;
	  		if(POr.OrdNr!=ORr.SerNr)then begin potestf = false; poTrHs = false; end;

	  		if(potestf)then begin
	  			pomtrw = matrowcnt(POr);
	  			For(poi=0;poi<pomtrw;poi=poi+1) begin
	  				matrowget(POr,poi,POrw);
	  				For(i=0;i<mtrw;i=i+1) begin
							matrowget(ORr,i,ORrw);
	  					if(POrw.ArtCode==ORrw.ArtCode)then begin
	  						ORrw.Shipd1 = ORrw.Shipd1 + POrw.Quant;
	  						matrowput(ORr,i,ORrw);
	  					end;
	  				end;
					end; 
	  		end;
			end; 
			resetloop(POr);
			
			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(ORr,i,ORrw);
	  			if((ORrw.Quant - ORrw.Shipd1)>0)then begin
	  				printf = true;
	  			end;
			end; 
			
			if(printf)then begin
				startformat(15);
					outstring(0,"DblORVc",ORr.SerNr,false);
					outstring(50,0,ORr.OrdDate,false);
					outstring(150,0,ORr.CustCode,false);
					outstring(200,0,ORr.Addr0,false);
					outstring(300,0,ORr.PlanShip,false);
				endformat;
				gray_divider(0,150);
				startformat(15);
					outstring(70,0,"Товар",false);
					outstring(140,0,"Название",false);
					outstring(400,0,"Кол-во",false);
					outstring(1,0,"К заказу",true);
				endformat;
				For(i=0;i<mtrw;i=i+1) begin
	  			matrowget(ORr,i,ORrw);
	  			if((ORrw.Quant - ORrw.Shipd1)>0)then begin
	  				startformat(15);
							outstring(70,0,ORrw.ArtCode,false);
							outstring(140,0,ORrw.Spec,false);
							outstring(400,0,ORrw.Quant,false);
							outstring(1,0,ORrw.Quant - ORrw.Shipd1,true);
						endformat;
	  			end;
				end; 
			end;
			
		end;
	end;
	
	endjob;
	LogProcTime("POFromORRn",getcurtick()-curtick);
return;
end;


global procedure POFromORstatusRn(record RcVc RepSpec)
begin
	record ORVc ORr;
	record POVc POr;
	row ORVc ORrw,OR2rw;
	row POVc Porw;
	boolean testf,TrHs,potestf,poTrHs;
	integer mtrw,i,keyint;
	integer pomtrw,poi;
	boolean printf;
	record SerBalVc SBr;
	boolean sbTrHs,sbtestf;
	array string 50 artcodes;
	integer acnt,j;
	boolean afound;
	longint curtick;
	
	curtick = getcurtick();
	startreportnoheaderjob("Отчет по заказанным товарам");
	
	if(RepSpec.flags[2]==0)then begin
		startformat(15);
			outstring(0,0,"№ Счета",false);
			outstring(50,0,"Дата сч.",false);
			outstring(150,0,"Клиент",false);
			outstring(200,0,"Имя",false);
			outstring(300,0,"Запланированная отгрузка",false);
		endformat;
	end;
	if(RepSpec.flags[2]==1)then begin
		startformat(15);
			outstring(0,0,"№ Счета",false);
			outstring(50,0,"Дата сч.",false);
			outstring(150,0,"Товар",false);
			outstring(200,0,"Название",false);
			outstring(250,0,"Кол-во",false);
			outstring(300,0,"Заказанно",false);
			outstring(350,0,"Поступление",false);
			outstring(400,0,"Отгруженно",false);
		endformat;
	end;
	
	gray_divider(0,150);
	
	ORr.OrdDate = RepSpec.sStartDate;
	keyint = 1;
	if(RepSpec.long1>=0)then begin
		ORr.SerNr = RepSpec.long1;
		keyint = 2;
	end;
	TrHs = true;

	while(loopkey("OrdDate",ORr,keyint,TrHs))begin
		printf = false;
		testf = true;
		if(ORr.OrdDate>RepSpec.sEndDate)then begin testf = false; TrHs = false; end;
		if(ORr.Closed>0)then begin testf = false; end;
		if(nonblank(RepSpec.f1) and RepSpec.f1!=ORr.OrderClass)then begin testf = false; end;
		if(blank(ORr.OrderClass))then begin testf = false; end;
		if(RepSpec.long1>=0 and ORr.SerNr!=RepSpec.long1)then begin TrHs = false; testf = false; end;
		
		
		if(testf)then begin
			acnt = 0;
			mtrw = matrowcnt(ORr);
			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(ORr,i,ORrw);
	  			afound = true;
	  			For(j=0;j<acnt;j=j+1) begin
	  				if(artcodes[j]==ORrw.ArtCode)then begin
	  					matrowget(ORr,j,OR2rw);
	  					OR2rw.Quant = OR2rw.Quant + ORrw.Quant;
	  					matrowput(ORr,j,OR2rw);
	  					afound = false;
	  				end;
					end;
					if(afound)then begin
						artcodes[acnt] = ORrw.ArtCode;
						acnt = acnt + 1;
					end; 
	  			ORrw.Shipd1 = 0;
	  			ORrw.Invd = 0;
	  		matrowput(ORr,i,ORrw);
	  		if(afound==false)then begin
	  			matrowdelete(ORr,i);
	  			mtrw = mtrw - 1;
	  			i=i-1;
	  		end;
			end; mtrw = matrowcnt(ORr);
			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(ORr,i,ORrw);
	  			ORrw.Shipd1 = 0;
	  		matrowput(ORr,i,ORrw);
			end; 
			
			
			POr.OrdNr = ORr.SerNr;
			poTrHs = true;
			While(loopkey("OrdNr",POr,1,poTrHs)) begin
				
	  		potestf = true;
	  		if(POr.OrdNr!=ORr.SerNr)then begin potestf = false; poTrHs = false; end;

	  		if(potestf)then begin
	  			pomtrw = matrowcnt(POr);
	  			For(poi=0;poi<pomtrw;poi=poi+1) begin
	  				matrowget(POr,poi,POrw);
						For(i=0;i<mtrw;i=i+1) begin
							matrowget(ORr,i,ORrw);
							if(POrw.ArtCode==ORrw.ArtCode)then begin
								ORrw.Shipd1 = ORrw.Shipd1 + POrw.Quant;
								ORrw.Invd = ORrw.Invd + POrw.Shipd2;
								matrowput(ORr,i,ORrw);
							end;
						end; 
					end; 
	  		end;
			end; 
			resetloop(POr);

			For(i=0;i<mtrw;i=i+1) begin
	  		matrowget(ORr,i,ORrw);
	  			if((ORrw.Shipd1)>0)then begin
	  				if(RepSpec.flags[1]==0)then begin
	  					if(ORrw.Quant>ORrw.Shipd2)then begin
								printf = true;
							end;
	  				end else begin
	  					printf = true;
	  				end;
	  			end;
			end; 
			
			if(printf)then begin
				if(RepSpec.flags[2]==0)then begin
					startformat(15);
						outstring(0,"DblORVc",ORr.SerNr,false);
						outstring(50,0,ORr.OrdDate,false);
						outstring(150,0,ORr.CustCode,false);
						outstring(200,0,ORr.Addr0,false);
						outstring(300,0,ORr.PlanShip,false);
					endformat;
					gray_divider(0,150);
					startformat(15);
						outstring(70,0,"Товар",false);
						outstring(140,0,"Название",false);
						outstring(250,0,"Кол-во",false);
						outstring(300,0,"Заказанно",false);
						outstring(350,0,"Поступление",false);
						outstring(400,0,"Отгруженно",false);
					endformat;
				end;

				For(i=0;i<mtrw;i=i+1) begin
	  			matrowget(ORr,i,ORrw);
	  			if((ORrw.Shipd1)>0)then begin
	  				if(RepSpec.flags[2]==0)then begin
							startformat(15);
								//outstring(70,0,ORrw.ArtCode,false);
								OutStringID(70,"DblOpenItemHist",ORrw.ArtCode,false,ORr.OrderClass & ORr.SerNr);
								outstring(140,0,ORrw.Spec,false);
								outstring(250,0,ORrw.Quant,false);
								outstring(300,0,ORrw.Shipd1,false);
								outstring(350,0,ORrw.Invd,false);
								outstring(400,0,ORrw.Shipd2,false);
							endformat;
				
							if(ORrw.Shipd2<ORrw.Quant)then begin
								startformat(15);
									outstring(70,0,"Статус товара",false);
								endformat;
								if(ORrw.Quant>ORrw.Shipd1)then begin
									startformat(15);
										outstring(70,0,"Не заказанно",false);
										outstring(200,0,ORrw.Quant-ORrw.Shipd1,false);
									endformat;
								end;
								if(ORrw.Shipd1>ORrw.Invd)then begin
									startformat(15);
										outstring(70,0,"Не отгруженно поставщиком",false);
										outstring(200,0,ORrw.Shipd1-ORrw.Invd,false);
									endformat;
								end;
								if(ORrw.Invd>0)then begin
									SBr.Item = ORrw.ArtCode;
									SBr.Serial = ORr.OrderClass & ORr.SerNr;
									sbTrHs = true;
									While(loopkey("ItemSerial",SBr,2,sbTrHs)) begin
										sbtestf = true;
										if(SBr.Item!=ORrw.ArtCode or SBr.Serial!=ORr.OrderClass & ORr.SerNr)then begin sbTrHs = false; sbtestf = false; end;
										if(SBr.Quant<=0)then begin sbtestf = false; end;
							
										if(sbtestf)then begin
											startformat(15);
												outstring(70,0,"Находится на складе",false);
												outstring(200,0,SBr.Location,false);
												outstring(250,0,SBr.Quant,false);
											endformat;
										end;
							
									end; 
									resetloop(SBr);
								end;
							end;
						end;
						if(RepSpec.flags[2]==1)then begin
							startformat(15);
								outstring(0,"DblORVc",ORr.SerNr,false);
								outstring(40,0,ORr.OrdDate,false);
								OutStringID(70,"DblOpenItemHist",ORrw.ArtCode,false,ORr.OrderClass & ORr.SerNr);
								outstring(140,0,ORrw.Spec,false);
								outstring(250,0,ORrw.Quant,false);
								outstring(300,0,ORrw.Shipd1,false);
								outstring(350,0,ORrw.Invd,false);
								outstring(400,0,ORrw.Shipd2,false);
							endformat;
						end;
						gray_divider(70,300);
					end;
				end;
			end;
			
		end;
	end;
	
	endjob;
	LogProcTime("POFromORstatusRn",getcurtick()-curtick);
return;
end;



global function boolean CheckPOFromOR(record ORVc ORr)
begin
	boolean res;
	record POVc POr;
	
	res = false;

	POr.OrdNr = ORr.SerNr;
	if(readfirstkey("OrdNr",POr,1,true))then begin
		res = true;
	end;
	
	CheckPOFromOR = res;
return;
end;

