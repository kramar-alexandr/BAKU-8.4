
external function LongInt GetCurUserLastNr(string);
external procedure NextM4Number(string,var string);

SetLangMode(LangRussian,"RUS",0);



global
updating function LongInt BPIBrandVcRecordCheck(var record BPIBrandVc BPIr,record BPIBrandVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  integer err,noErr;
  string 255 host,tstr,nonce,opaque,page;
  LongInt port,pos,mtrw;
  Area req,reply;
  string 255 ha1,ha2;
  row MarcCampVc MCrw;
  integer i;
  json jsresponse;
	record WebReportChBlock WRChb;
	record GlobalBrandsVc BGr,oldBGr;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "BRAND";
			recordstore(BCr,true);
		end;	
	end;
	
	if(stat==Rs_update)then begin
		BGr.Code = BPIr.Code;
		if(readfirstmain(BGr,1,true))then begin
			recordcopy(oldBGr,BGr);
			BGr.Name = BPIr.Name;
			recordupdate(oldBGr,BGr,true);
		end else begin
			BGr.Code = BPIr.Code;
			BGr.Name = BPIr.Name;
			recordStore(BGr,true);
		end;
	end;
	if(stat==Rs_insert)then begin
		recordnew(BGr);
		BGr.Code = BPIr.Code;
		BGr.Name = BPIr.Name;
		recordStore(BGr,true);
	end;
	
	blockload(WRChb);		
	
	res = 0;
	  
  BPIBrandVcRecordCheck = res;
return;
end;


global
updating function LongInt BPICollectionVcRecordCheck(var record BPICollectionVc BPIr,record BPICollectionVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  integer err,noErr;
  string 255 host,tstr,nonce,opaque,page;
  LongInt port,pos,mtrw;
  Area req,reply;
  string 255 ha1,ha2;
  row MarcCampVc MCrw;
  integer i;
  json jsresponse;
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "COLLECT";
			recordstore(BCr,true);
		end;	
	end;
	res = 0;
	
	
	blockload(WRChb);	
	if(WRChb.WEBCheck==1)then begin
		if(stat==Rs_update)then begin
		
			host = "192.168.3.11";
			page = "/api/ProductCategory/Update";
			port = 8087;			
			
			addtexttoarea("{" & chr(13) & chr(10),req);
			addtexttoarea("\"title\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"description\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"id\":" & "\"" & BPIr.CRMid & "\"," & chr(13) & chr(10),req);
			addtexttoarea("}" & chr(13) & chr(10),req);
		
			writeareatofile(req,"CRMRequest.txt",0);
			SendWebRequest(host,port,-1,false,"PATCH",page,"application/json","",false,req,reply,10);
			if(getarealength(reply)>0)then begin
				jsresponse = ParseJSONArea(reply);
				if(nonblank(JSONGet(jsresponse,"result")))then begin
					logtext(0,"SendUpdateBrandToCRM " & JSONGet(jsresponse,"result"));
				end;
			end;

			writeareatofile(reply,"CRMResponse.txt",0);
		
		end;
		if(stat==Rs_insert)then begin
			
			host = "192.168.3.11";
			page = "/api/ProductCategory/Create";
			port = 8087;
		
			addtexttoarea("{" & chr(13) & chr(10),req);
			addtexttoarea("\"title\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"description\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"hansaId\":" & "\"" & BPIr.Code & "\"" & chr(13) & chr(10),req);
			addtexttoarea("}" & chr(13) & chr(10),req);
		
			writeareatofile(req,"CRMRequest.txt",0);
			SendWebRequest(host,port,-1,false,"POST",page,"application/json","",false,req,reply,10);
			if(getarealength(reply)>0)then begin
				jsresponse = ParseJSONArea(reply);
				if(nonblank(JSONGet(jsresponse,"result")))then begin
					BPIr.CRMid = JSONGet(jsresponse,"result");
					logtext(0,"BPIBrandVcRecordCheck " & BPIr.CRMid);
				end;
			end;
			writeareatofile(reply,"CRMResponse.txt",0);
		
		end;
	end;
  
  BPICollectionVcRecordCheck = res;
return;
end;

global
updating function LongInt BPIGroupVcRecordCheck(var record BPIGroupVc BPIr,record BPIGroupVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  integer err,noErr;
  string 255 host,tstr,nonce,opaque,page;
  LongInt port,pos,mtrw;
  Area req,reply;
  string 255 ha1,ha2;
  row MarcCampVc MCrw;
  integer i;
  json jsresponse;
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "GROUP";
			recordstore(BCr,true);
		end;	
	end;
	res = 0;
	blockload(WRChb);		
	
	res = 0;
	
	
	
	if(WRChb.WEBCheck==1)then begin
		if(stat==Rs_update)then begin
		
			host = "192.168.3.11";
			page = "/api/ProductCategory/Update";
			port = 8087;			
			
			addtexttoarea("{" & chr(13) & chr(10),req);
			addtexttoarea("\"title\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"description\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"id\":" & "\"" & BPIr.CRMid & "\"," & chr(13) & chr(10),req);
			addtexttoarea("}" & chr(13) & chr(10),req);
		
			writeareatofile(req,"CRMRequest.txt",0);
			SendWebRequest(host,port,-1,false,"PATCH",page,"application/json","",false,req,reply,10);
			if(getarealength(reply)>0)then begin
				jsresponse = ParseJSONArea(reply);
				if(nonblank(JSONGet(jsresponse,"result")))then begin
					logtext(0,"BPIGroupVcRecordCheck " & JSONGet(jsresponse,"result"));
				end;
			end;

			writeareatofile(reply,"CRMResponse.txt",0);
		
		end;
		if(stat==Rs_insert)then begin
			
			host = "192.168.3.11";
			page = "/api/ProductCategory/Create";
			port = 8087;
		
			addtexttoarea("{" & chr(13) & chr(10),req);
			addtexttoarea("\"title\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"description\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"hansaId\":" & "\"" & BPIr.Code & "\"" & chr(13) & chr(10),req);
			addtexttoarea("}" & chr(13) & chr(10),req);
		
			writeareatofile(req,"CRMRequest.txt",0);
			SendWebRequest(host,port,-1,false,"POST",page,"application/json","",false,req,reply,10);
			if(getarealength(reply)>0)then begin
				jsresponse = ParseJSONArea(reply);
				if(nonblank(JSONGet(jsresponse,"result")))then begin
					BPIr.CRMid = JSONGet(jsresponse,"result");
					logtext(0,"BPIGroupVcRecordCheck " & BPIr.CRMid);
				end;
			end;
			writeareatofile(reply,"CRMResponse.txt",0);
		
		end;
	end;
  
  BPIGroupVcRecordCheck = res;
return;
end;

global
updating function LongInt BPISubGroupVcRecordCheck(var record BPISubGroupVc BPIr,record BPISubGroupVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  integer err,noErr;
  string 255 host,tstr,nonce,opaque,page;
  LongInt port,pos,mtrw;
  Area req,reply;
  string 255 ha1,ha2;
  row MarcCampVc MCrw;
  integer i;
  json jsresponse;
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "SUBGROUP";
			recordstore(BCr,true);
		end;	
	end;
	res = 0;
	blockload(WRChb);		
	
	res = 0;
	
	if(WRChb.WEBCheck==1)then begin
		if(stat==Rs_update)then begin
		
			host = "192.168.3.11";
			page = "/api/ProductCategory/Update";
			port = 8087;			
			
			addtexttoarea("{" & chr(13) & chr(10),req);
			addtexttoarea("\"title\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"description\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"id\":" & "\"" & BPIr.CRMid & "\"," & chr(13) & chr(10),req);
			addtexttoarea("}" & chr(13) & chr(10),req);
		
			writeareatofile(req,"CRMRequest.txt",0);
			SendWebRequest(host,port,-1,false,"PATCH",page,"application/json","",false,req,reply,10);
			if(getarealength(reply)>0)then begin
				jsresponse = ParseJSONArea(reply);
				if(nonblank(JSONGet(jsresponse,"result")))then begin
					logtext(0,"BPIGroupVcRecordCheck " & JSONGet(jsresponse,"result"));
				end;
			end;

			writeareatofile(reply,"CRMResponse.txt",0);
		
		end;
		if(stat==Rs_insert)then begin
			
			host = "192.168.3.11";
			page = "/api/ProductCategory/Create";
			port = 8087;
		
			addtexttoarea("{" & chr(13) & chr(10),req);
			addtexttoarea("\"title\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"description\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"hansaId\":" & "\"" & BPIr.Code & "\"" & chr(13) & chr(10),req);
			addtexttoarea("}" & chr(13) & chr(10),req);
		
			writeareatofile(req,"CRMRequest.txt",0);
			SendWebRequest(host,port,-1,false,"POST",page,"application/json","",false,req,reply,10);
			if(getarealength(reply)>0)then begin
				jsresponse = ParseJSONArea(reply);
				if(nonblank(JSONGet(jsresponse,"result")))then begin
					BPIr.CRMid = JSONGet(jsresponse,"result");
					logtext(0,"BPIGroupVcRecordCheck " & BPIr.CRMid);
				end;
			end;
			writeareatofile(reply,"CRMResponse.txt",0);
		
		end;
	end;
  
  BPISubGroupVcRecordCheck = res;
return;
end;



global
updating function LongInt BPICategoryVcRecordCheck(var record BPICategoryVc BPIr,record BPICategoryVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "CATEGORY";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPICategoryVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIMaterialVcRecordCheck(var record BPIMaterialVc BPIr,record BPIMaterialVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "MATERIAL";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIMaterialVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIColorVcRecordCheck(var record BPIColorVc BPIr,record BPIColorVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "COLOR";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIColorVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIShapeVcRecordCheck(var record BPIShapeVc BPIr,record BPIShapeVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "SHAPE";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIShapeVcRecordCheck = res;
	
return;
end;


global
updating function LongInt BPISizeVcRecordCheck(var record BPISizeVc BPIr,record BPISizeVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "SIZE";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPISizeVcRecordCheck = res;
	
return;
end;


global
updating function LongInt BPIUseVcRecordCheck(var record BPIUseVc BPIr,record BPIUseVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "USE";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIUseVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPISexVcRecordCheck(var record BPISexVc BPIr,record BPISexVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "SEX";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPISexVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIPlatingVcRecordCheck(var record BPIPlatingVc BPIr,record BPIPlatingVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "PLATING";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIPlatingVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIClarityVcRecordCheck(var record BPIClarityVc BPIr,record BPIClarityVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "CLARITY";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIClarityVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIWeightVcRecordCheck(var record BPIWeightVc BPIr,record BPIWeightVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "WEIGHT";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIWeightVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPICutVcRecordCheck(var record BPICutVc BPIr,record BPICutVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "CUT";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPICutVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIStoneVcRecordCheck(var record BPIStoneVc BPIr,record BPIStoneVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "STONE";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIStoneVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIStrapVcRecordCheck(var record BPIStrapVc BPIr,record BPIStrapVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "STRAP";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIStrapVcRecordCheck = res;
	
return;
end;

global
updating function LongInt BPIOdourVcRecordCheck(var record BPIOdourVc BPIr,record BPIOdourVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	if(nonblank(BPIr.Code))then begin
		BCr.Code = BPIr.Code;
		if(readfirstmain(BCr,1,true))then begin
			recordcopy(oldBCr,BCr);
			BCr.Name = BPIr.Name;
			recordupdate(oldBCr,BCr,true);
		end else begin
			BCr.Name = BPIr.Name;
			BCr.Code = BPIr.Code;
			BCr.Type = "ODOUR";
			recordstore(BCr,true);
		end;	
	end;
	
	res = 0;
	
	BPIOdourVcRecordCheck = res;
	
return;
end;


global
updating function LongInt GlobalClassificationsVcRecordCheck(var record GlobalClassificationsVc BPIr,record GlobalClassificationsVc BPI2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  integer err,noErr;
  string 255 host,tstr,nonce,opaque,page;
  LongInt port,pos,mtrw;
  Area req,reply;
  string 255 ha1,ha2;
  row MarcCampVc MCrw;
  integer i;
  json jsresponse;
	record WebReportChBlock WRChb;
	record GlobalClassificationsVc BCr,oldBCr;
	
	res = 0;
	
	blockload(WRChb);	
	if(WRChb.WEBCheck==1)then begin
		if(stat==Rs_insert)then begin
			host = "192.168.3.11";
			page = "/api/ProductCategory/Create";
			port = 8087;
		
			addtexttoarea("{" & chr(13) & chr(10),req);
			addtexttoarea("\"title\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"description\":\"" & BPIr.Name & "\"," & chr(13) & chr(10),req);
			addtexttoarea("\"hansaId\":" & "\"" & BPIr.Code & "\"" & chr(13) & chr(10),req);
			addtexttoarea("}" & chr(13) & chr(10),req);
		
			writeareatofile(req,"CRMRequest.txt",0);
			SendWebRequest(host,port,-1,false,"POST",page,"application/json","",false,req,reply,10);
			if(getarealength(reply)>0)then begin
				jsresponse = ParseJSONArea(reply);
				if(nonblank(JSONGet(jsresponse,"result")))then begin
					logtext(0,"GlobalClassificationsVcRecordCheck " & JSONGet(jsresponse,"result"));
				end;
			end;
			writeareatofile(reply,"CRMResponse.txt",0);
		end;
	end;
	
	GlobalClassificationsVcRecordCheck = res;
	
return;
end;


global
updating function LongInt OSDVcRecordCheck(var record OSDVc OSDr,record OSDVc OSD2r,LongInt stat,LongInt long4)
BEGIN
	longint res,newnr;
	record OSDVc OSDOldr;
	string 255 OldSNr,NewSNr;
	boolean TrHs;
	if(stat==Rs_update and OSD2r.OKFlag==1)then begin
		res = -1;
		MessageBox(0,"Документ утвержден!");
		goto LOSDVcRecordCheck;
	end;
	
	if(blank(OSDr.Code))then begin
		OSDOldr.Code = "ZZZZZZZZZZZZZZZZZZZZZZZZ";
		TrHs = true;
		while (LoopBackKey("Code",OSDOldr,1,TrHs))begin 
			OldSNr = OSDOldr.Code;
			NextM4Number(OldSNr,NewSNr);
			OSDr.Code = NewSNr;
			TrHs = false;
		end;
	end;
	
	
	
	LOSDVcRecordCheck:;
	OSDVcRecordCheck = res;
return;
end;





