external procedure ExtractObj(string,var Integer,var string);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external function roundmode SetRoundModeD(Integer);
external function Boolean SetInSet2(string,string);
external function val AbsoluteVal(val);
external function boolean CompanyIsJWLikeCompany(Integer);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);

function string 200 prepareStr(string input)
begin
integer i,length;
string 200 res;
  length = len(input);
  For(i=0;i<length;i=i+1) begin
	  if(mid(input,i,1)==chr(34))then begin
	    res = res;
	  end else begin
	    res = res & mid(input,i,1);
	  end;	  
	end; 
  
  prepareStr = res;
return;
end;

function string 200 ParseClassification(string class)
begin
	string 200 res,cl;
	record DIVc DIr;
	integer pos;
	
	if(nonblank(class))then begin
		pos = 0;
		ExtractObj(class,pos,cl);
		DIr.Code = cl;
		if(readfirstmain(DIr,1,true))then begin
			res = DIr.Name;
			outstring(0,0,DIr.Name,false);
		end else begin
			outstring(0,0,"",false);
		end;
	
		ExtractObj(class,pos,cl);
		if(nonblank(cl))then begin
			DIr.Code = cl;
			if(readfirstmain(DIr,1,true))then begin
				if(nonblank(DIr.Code))then begin
					res = res & "," & DIr.Name;
				end;
				if(currentcompany>3)then begin
					outstring(0,0,DIr.Name,false);
				end;
			end else begin
				if(currentcompany>3)then begin
					outstring(0,0,"",false);
				end;
			end;
		end else begin
			if(currentcompany>3)then begin
				outstring(0,0,"",false);
			end;
		end;
	end else begin
		outstring(0,0,"",false);
		if(currentcompany>3)then begin
			outstring(0,0,"",false);
		end;
	end;
	
	ParseClassification = res;
return;
end;




global
procedure FindFIFOOrigValAndCurncyIV(longint sernr, integer rownr, var val fifo, var string cur,var val fifobase,boolean updst)
begin
	record ItemHistVc IHr,IH2r;
	record PUVc PUr;
	row PUVc PUrw;
	integer mtrw,i;
	record INVc INr;
	string 20 artcode;
	date ivdate;
	boolean find;
	record IVVc IVr;
	row IVVc IVrw;
	record ORVc ORr;
	row ORVc ORrw;
	record SHVc SHr;
	row SHVc SHrw;
	boolean TrHs,testf,findsec,TrHs1;
	val fr,to1,to2,br1,br2;
	integer halt;	
	
	fifo = 0;
	cur = "";
	fifobase = 0;
	
	if(updst)then begin
		IHr.FileName = "IVVc";
		IHr.TransNr = sernr;
		IHr.Row = rownr;
		TrHs = true;
		while(loopkey("FNTransNr",IHr,3,TrHs))begin
			if(IHr.FileName!="IVVc")then begin TrHs = false; end;
			if(IHr.TransNr!=sernr)then begin TrHs = false; end;
			if(IHr.Row!=rownr)then begin TrHs = false; end;
			
			if(TrHs)then begin
				fifobase = fifobase + IHr.TotCostPrice;
				fifo = fifo + IHr.TotCostPriceCurncy;
				cur = IHr.CurncyCode;
			end;
		end;
	end else begin
		IVr.SerNr = sernr;
		readfirstmain(IVr,1,true);
		matrowget(IVr,rownr,IVrw);
		halt = 0;
		TrHs = true;
		SHr.OrderNr=IVr.OrderNr;
		while(loopkey("OrderKey",SHr,1,TrHs))begin
			if(SHr.OrderNr!=IVr.OrderNr)then begin TrHs=false; end;
			
			if(TrHs)then begin
				mtrw = matrowcnt(SHr);
				For(i=0;i<mtrw;i=i+1) begin
					matrowget(SHr,i,SHrw);
					if(SHrw.OrdRow==IVrw.OrdRow)then begin
						IHr.FileName = "SHVc";
						IHr.TransNr = SHr.SerNr;
						IHr.Row = i;
						TrHs1 = true;
						resetloop(IHr);
						while(loopkey("FNTransNr",IHr,3,TrHs1))begin
							if(IHr.FileName!="SHVc")then begin TrHs1 = false; end;
							if(IHr.TransNr!=SHr.SerNr)then begin TrHs1 = false; end;
							if(IHr.Row!=i)then begin TrHs1 = false; end;
							if(TrHs1)then begin
								if(halt<IVrw.Quant)then begin
									fifobase = fifobase + IHr.TotCostPrice;
									fifo = fifo + IHr.TotCostPriceCurncy;
									cur = IHr.CurncyCode;
									halt = halt - IHr.Qty;
								end else begin
									TrHs1 = false;
									TrHs = false;
								end;
							end;
						end;
					end;
				end;
			end;
		end;
	end;
	
	
	/*if(updst)then begin
		resetloop(IHr);
		IHr.FileName = "IVVc";
		IHr.TransNr = sernr;
		IHr.Row = rownr;
		TrHs = true;
		while(loopkey("FNTransNr",IHr,3,TrHs))begin
			if(IHr.FileName!="IVVc")then begin TrHs = false; end;
			if(IHr.TransNr!=sernr)then begin TrHs = false; end;
			if(IHr.Row!=rownr)then begin TrHs = false; end;
			
			if(TrHs)then begin
				fifobase = fifobase + IHr.TotCostPrice;
				find = false;
				IH2r.Source = IHr.Source;
				halt = 0;
				IH2r.SerNr = IHr.Source;
				while(IH2r.Source>0 and halt<40) begin
					readfirstmain(IH2r,1,true);
					IH2r.SerNr = IH2r.Source;
					halt = halt + 1;
				end;
				if(IH2r.FileName=="PUVc")then begin
					PUr.SerNr = IH2r.TransNr;
					readfirstmain(PUr,1,true);
					matrowget(PUr,IH2r.Row,PUrw);
					fifo = fifo + PUrw.UPrice*IHr.Qty;
					cur = PUr.CurncyCode;
					find = true;
				end;
				findsec=false;
				if(find==false)then begin
					IH2r.ArtCode = artcode;
					IH2r.TransDate = ivdate;
					find = true;
					while(loopbackkey("ArtCode",IH2r,2,find))begin
						if(IH2r.ArtCode!=artcode)then begin find = false; end;
						if(IH2r.FileName=="PUVc" and find)then begin
							PUr.SerNr = IH2r.TransNr;
							readfirstmain(PUr,1,true);
							matrowget(PUr,IH2r.Row,PUrw);
							fifo = fifo + PUrw.UPrice*IHr.Qty;
							cur = PUr.CurncyCode;
							find = false;
							findsec = true;
						end;
					end;
					resetloop(IH2r);
					if(blank(cur) or findsec==false)then begin
						INr.Code = IHr.ArtCode;
						readfirstmain(INr,1,true);
						if(INr.LastPurchPrice2<>0)then begin
							fifo = fifo + INr.LastPurchPrice2*IHr.Qty;
						end else begin
							GetFullCurncyRate(INr.LastPurchCurncyCode,INr.LastBasePriceChange,fr,to1,to2,br1,br2);
							if(fr==0 or to1==0)then begin
								fr = 1; to1 = 1;
							end;
							fifo = fifo + INr.InPrice*fr/to1*IHr.Qty;
						end;
						cur = INr.LastPurchCurncyCode;
					end;
				end;
			end;
		end;
	end else begin
		IVr.SerNr = sernr;
		readfirstmain(IVr,1,true);
		matrowget(IVr,rownr,IVrw);
		
		TrHs = true;
		SHr.OrderNr=IVr.OrderNr;
		while(loopkey("OrderKey",SHr,1,TrHs))begin
			if(SHr.OrderNr!=IVr.OrderNr)then begin TrHs=false; end;
			
			if(TrHs)then begin
			mtrw = matrowcnt(SHr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(SHr,i,SHrw);
				if(SHrw.OrdRow==IVrw.OrdRow)then begin
					IHr.FileName = "SHVc";
					IHr.TransNr = SHr.SerNr;
					IHr.Row = i;
					TrHs1 = true;
					resetloop(IHr);
					while(loopkey("FNTransNr",IHr,3,TrHs1))begin
						if(IHr.FileName!="SHVc")then begin TrHs1 = false; end;
						if(IHr.TransNr!=SHr.SerNr)then begin TrHs1 = false; end;
						if(IHr.Row!=i)then begin TrHs1 = false; end;
						
					
						if(TrHs1)then begin
							fifobase = fifobase + IHr.TotCostPrice;
							find = false;
							IH2r.Source = IHr.Source;
							halt = 0;
							IH2r.SerNr = IHr.Source;
							while(IH2r.Source>0 and halt<40) begin
								readfirstmain(IH2r,1,true);
								IH2r.SerNr = IH2r.Source;
								halt = halt + 1;
							end;
							if(IH2r.FileName=="PUVc")then begin
								PUr.SerNr = IH2r.TransNr;
								readfirstmain(PUr,1,true);
								matrowget(PUr,IH2r.Row,PUrw);
								fifo = fifo + PUrw.UPrice*IHr.Qty;
								cur = PUr.CurncyCode;
								find = true;
							end;
							findsec=false;
							if(find==false)then begin
								IH2r.ArtCode = artcode;
								IH2r.TransDate = ivdate;
								find = true;
								while(loopbackkey("ArtCode",IH2r,2,find))begin
									if(IH2r.ArtCode!=artcode)then begin find = false; end;
									if(IH2r.FileName=="PUVc" and find)then begin
										PUr.SerNr = IH2r.TransNr;
										readfirstmain(PUr,1,true);
										matrowget(PUr,IH2r.Row,PUrw);
										fifo = fifo + PUrw.UPrice*IHr.Qty;
										cur = PUr.CurncyCode;
										find = false;
										findsec = true;
									end;
								end;
								resetloop(IH2r);
								if(blank(cur) or findsec==false)then begin
									INr.Code = IHr.ArtCode;
									readfirstmain(INr,1,true);
									if(INr.LastPurchPrice2<>0)then begin
										fifo = fifo + INr.LastPurchPrice2*IHr.Qty;
									end else begin
										GetFullCurncyRate(INr.LastPurchCurncyCode,INr.LastBasePriceChange,fr,to1,to2,br1,br2);
										if(fr==0 or to1==0)then begin
											fr = 1; to1 = 1;
										end;
										fifo = fifo + INr.InPrice*fr/to1*IHr.Qty;
									end;
									cur = INr.LastPurchCurncyCode;
								end;
							end;
						end;
					end;
				end;	  
			end; 
			end;
		end;
	end;*/

	if(fifo<0)then begin fifo=-fifo; end;
	if(fifobase<0)then begin fifobase=-fifobase; end;
	
return;
end;

//Edit***************************Sasha2,17:31 19.11.2014 {
function integer CalculateCoef(var record IVVc IV2r,var integer rangecnt,string item,string location,var Boolean iteminf,integer arrsize)
begin
  Integer i,rwcnt,coefv,pos;
  row IVVc IV2rw;
  Boolean foundf;
  
  foundf = false;
  iteminf = false;
  rwcnt = MatRowCnt(IV2r);
  for (i=0;i<rwcnt;i=i+1) begin
  	MatRowGet(IV2r,i,IV2rw);
    if (item==IV2rw.ArtCode and location==IV2rw.Location) then begin
      pos = i;
      coefv = IV2rw.Quant;
      foundf = true;
      iteminf = true;
      i = rwcnt;
      IV2rw.Sum = IV2rw.Sum + 1;
    end;
  end;
  if (foundf==false) then begin
    IV2rw.ArtCode = item;
    IV2rw.Location = location;
    IV2rw.Quant = rangecnt*arrsize;
    coefv = rangecnt*arrsize;
    rangecnt = rangecnt + 1;
    pos = rwcnt;
    IV2rw.Sum = 1;
  end;
  MatRowPut(IV2r,pos,IV2rw);
  
  CalculateCoef = coefv;
  
  return;
end; //Edit***************************Sasha2,17:32 19.11.2014 }


procedure PrintGftSertSold(record IVVc IVr,integer rownr,var val total_price,string bcur,string azn,Boolean addclassf)
begin
	row IVVc IVrw;
	integer j;

	matrowget(IVr,rownr,IVrw);
	total_price = total_price + IVrw.Sum;
	
	startformat(15);
		outstring(0,0,USetStr(2186),false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		if (addclassf==false) then begin
		  outstring(0,0,"",false);
		end;
		if(currentcompany==9)then begin
			outstring(0,0,"",false);
		end;
		outstring(0,0,"",false);
		if (addclassf==false) then begin
		  outstring(0,0,"",false);
			outstring(0,0,"",false);
			outstring(0,0,"",false);
			outstring(0,0,"",false);
			if(currentcompany==13)then begin
				outstring(0,0,"",false);
				outstring(0,0,"",false);
			end;
		end else begin
		  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
		    outstring(0,0,"",false);
		  end;
		end;
		outstring(0,0,"",false); //seriinii nomer
		outstring(0,0,"",false);
		outstring(0,0,"",false);//EKNCode
		outstring(0,0,"",false);
		outstring(100,0,"",false);
		outstring(101,0,"",false);
		if(bcur!=azn)then begin
			outstring(102,0,"",false);
		end;
		outstring(110,0,"",false);
		outstring(111,0,"",false);
		if(bcur!=azn)then begin
			outstring(112,0,"",false);
		end;
		outstring(120,0,"",false);
		outstring(121,0,"",false);
		if(bcur!=azn)then begin
			outstring(122,0,"",false);
		end;
		outstring(130,0,"",false);
		outstring(131,0,IVrw.Sum,false);
		if(bcur!=azn)then begin
			outstring(132,0,"",false);
		end;
		outstring(140,0,"",false);
		outstring(141,0,"",false);
		if(bcur!=azn)then begin
			outstring(142,0,"",false);
		end;
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		if(currentcompany==9)then begin
			outstring(0,0,"",false);
		end;
		outstring(0,0,"",false);
	endformat;
return;
end;
//Edit***************************Sasha2,10:05 19.02.2016 {
procedure SortAndClearClassifications(var array string typecode,var vector string typename,val typescnt)
begin
  vector val typelevel;
  val level,val1,val2;
  string 20 code;
  String 200 name;
  Integer i,j;
  
    if (typescnt>1) then begin
      level = 1;
      typelevel["TYPE"] = level; level = level + 1;
      typelevel["COLL_W"] = level; level = level + 1;
      typelevel["MATERIAL_W"] = level; level = level + 1;
      typelevel["GENDER_W"] = level; level = level + 1; ///////
      typelevel["DIAL"] = level; level = level + 1;
      typelevel["STRAP"] = level; level = level + 1;
      typelevel["MECHANISM"] = level; level = level + 1;
      typelevel["FUNCTIONS"] = level; level = level + 1;
      typelevel["DIAMETER"] = level; level = level + 1;
      typelevel["COLL_J"] = level; level = level + 1;
      typelevel["CATEGORY_J"] = level; level = level + 1;
      typelevel["MATERIAL_J"] = level; level = level + 1;
      typelevel["WEIGHT"] = level; level = level + 1;
      typelevel["D_CARAT"] = level; level = level + 1;
      typelevel["CENT_ST"] = level; level = level + 1;
      typelevel["PR_STONES"] = level; level = level + 1;
      typelevel["STYLE_J"] = level; level = level + 1;
      typelevel["R_SIZE"] = level; level = level + 1;
      typelevel["DIVISION"] = level; level = level + 1;
      typelevel["GENDER_J"] = level; level = level + 1; //////
      typelevel["CARAT"] = level; level = level + 1;
      typelevel["CLARITY"] = level; level = level + 1;
      typelevel["C_S"] = level; level = level + 1;
      typelevel["SHAPE_CUT"] = level; level = level + 1;
      typelevel["COLL_A"] = level; level = level + 1;
      typelevel["CATEGORY_A"] = level; level = level + 1;
      typelevel["MATERIAL_A"] = level; level = level + 1;
      typelevel["STYLE_A"] = level; level = level + 1;
      typelevel["C_M"] = level; level = level + 1;
      typelevel["GENDER_A"] = level; level = level + 1; //////
      typelevel["WARCARD"] = level; level = level + 1;
      typelevel["ART"] = level; level = level + 1;
      typelevel["SAP"] = level; level = level + 1;
      
      for (i=0;i<typescnt-1;i=i+1) begin
        for (j=0;j<typescnt-1;j=j+1) begin
          if (typelevel[typecode[j]]<1) then begin
            typename[typecode[j]] = "";
            typecode[j] = "";
          end;
          val1 = typelevel[typecode[j]];
          val2 = typelevel[typecode[j+1]];
          if ((val1>0 and val2>0 and val1>val2) or (val1<1 and val2>0)) then begin
            code = typecode[j];
            name = typename[typecode[j]];
            typecode[j] = typecode[j+1];
            typename[typecode[j]] = typename[typecode[j+1]];
            typecode[j+1] = code;
            typename[typecode[j+1]] = name;
          end;
        end;
      end;
    end;
  
  return;
end; //Edit***************************Sasha2,10:05 19.02.2016 }

//Edit***************************Sasha2,14:42 11.11.2015 {
procedure MyClearVector(var vector string vect1,array string arr,integer cnt)
begin
  integer i;
  
    for (i=0;i<cnt;i=i+1) begin
      vect1[arr[i]] = "";
    end;
  
  return;
end; //Edit***************************Sasha2,14:42 11.11.2015 }


global
procedure SalesReportExtRn(record RcVc RepSpec)
begin
  record LocalMachineVc LMr;
  Date sd,ed;
  Boolean TrHs,testf;
  record IVVc IVr,IV2r;
  row IVVc IVrw;
  integer i,keyi,mtrw,k,j;
  string 20 keystr;
  record INVc INr;
  string 100 classname,classname2,classcode; //Edit***************************Sasha2,11:14 20.11.2014
  record DIVc DIr;
  val brandfifo;
  string 5 brandcur;
  record PLVc PLr;
  val fr,to1,to2,br1,br2;
  val ivfr,ivto1;
  val basesum,curcusm,curprice,fifob1;
  boolean testf1,userlocation;
  string 255 location,tstr;
  record UserVc User;
  integer pos,headrow;
  string 50 uloc,uloc1;
  boolean updst,modef;
	val total_rebate,total_rebate_qty;//Edit***********************Vitalii 14:28 26.08.2014
  val total_qty;
  val total_cost,total_price,total_gp;
  string 200 classfind,model,brand,category;
  record ORVc ORr;
  record BaseCurBlock BCb;
  string 5 bcur,azn;
  val bfr,bto;
  val aznfr,aznto,fifoazn;
  val btotal_cost,btotal_price,btotal_gp;
  array val arrvals; //Edit***************************Sasha2,10:46 20.11.2014
  array string 20 arrstrs; //Edit***************************Sasha2,10:46 20.11.2014
  integer valscnt,strscnt,rangeval,rangecnt,arrsize; //Edit***************************Sasha2,12:11 20.11.2014
  val itemoccurrences; //Edit***************************Sasha2,12:11 20.11.2014
  boolean iteminf,addclassf;
  integer cred;
  Record CTypeVc CTyper; //Edit***************************Sasha2,12:23 11.11.2015
  integer ctypecnt,m; //Edit***************************Sasha2,12:24 11.11.2015
  array string 10 typeindex; //Edit***************************Sasha2,14:08 11.11.2015
  vector string 255 dispnames; //Edit***************************Sasha2,14:08 11.11.2015
  
  vector string 20 typeval; //Edit***************************Sasha2,14:11 08.02.2016
  array string 20 typecode; //Edit***************************Sasha2,14:11 08.02.2016
  vector string 200 typename; //Edit***************************Sasha2,14:11 08.02.2016
  record DiCheckBlock DiCb; //Edit***************************Sasha2,14:10 08.02.2016
  row DiCheckBlock DiCbw; //Edit***************************Sasha2,14:10 08.02.2016
  integer rwcnt,typescnt,pos1; //Edit***************************Sasha2,14:11 08.02.2016
  Boolean collf,metalf; //Edit***************************Sasha2,14:09 02.06.2016
  string 20 collstr,metalstr; //Edit***************************Sasha2,14:09 02.06.2016
  
  blockload(BCb);
  bcur = BCb.BaseCur1;
	azn = "AZN";
	if(currentcompany==10)THEN BEGIN
		azn = "PLN";
	end;
	if(currentcompany==11 or currentcompany==12)THEN BEGIN
		azn = "IRR";
	end;
	headrow = 2;
  //SetLangMode(LangRussian,"RUS",0);
  		
  	
    StartReportJob(USetStr(31041)); //Edit***************************Sasha2,16:57 19.11.2014 {
    
    sd = RepSpec.sStartDate;
    ed = RepSpec.sEndDate;
    location = RepSpec.f1;
    
    Header(headrow,USetStr(13835) & sd & ":" & ed,0);
    headrow = headrow + 1;
    
    if (NonBlank(location)) then begin
  		Header(headrow,USetStr(31097) & ": " & location,0);
  	end else begin
  		Header(headrow,USetStr(31097) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	if (NonBlank(RepSpec.f2)) then begin
  		Header(headrow,USetStr(11605) & RepSpec.f2,0);
  	end else begin
  		Header(headrow,USetStr(11605) & USetStr(12727),0);
  	end;
    headrow = headrow + 1;
    
    if (NonBlank(RepSpec.f4)) then begin
  		Header(headrow,USetStr(31044) & ": " & RepSpec.f4,0);
  	end else begin
  		Header(headrow,USetStr(31044) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	if (NonBlank(RepSpec.f5)) then begin
  		Header(headrow,USetStr(8833) & ": " & RepSpec.f5,0);
  	end else begin
  		Header(headrow,USetStr(8833) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	EndHeader; //Edit***************************Sasha2,16:57 19.11.2014 }
  	
  	if (CompanyIsJWLikeCompany(CurrentCompany)) then begin //Edit***************************Sasha2,11:27 02.06.2016 {
  	  addclassf = true;
  	end else begin
  	  addclassf = false;
  	end; 

  	if (addclassf) then begin
      typescnt = 0;
  	  BlockLoad(DiCb);
      rwcnt = MatRowCnt(DiCb);  
      for (j=0;j<rwcnt;j=j+1) begin
        MatRowGet(DiCb,j,DiCbw);
        if (NonBlank(DiCbw.DiType)) then begin
          DIr.Code = DiCbw.DiCode;
          ReadFirstMain(DIr,1,true);
          DiCbw.DiType = DIr.CType & "," & DiCbw.DiType;
          pos = 0;
    			ExtractObj(DiCbw.DiType,pos,uloc);
    			while (nonblank(uloc)) begin
    				if (blank(typeval[uloc])) then begin
      				CTyper.Code = uloc;
      				if (ReadFirstMain(CTyper,1,true)) then begin
      				  if (CTyper.Code=="GENDER") then begin
      				    switch (UpperCase(Left(DiCbw.DiCode,1))) begin
      				      case "A":
      				        if (blank(typeval[CTyper.Code & "_A"])) then begin
        				        typeval[CTyper.Code & "_A"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_A";
              				  typename[typecode[typescnt]] = "ACCESSORIES " & CTyper.Comment;
              				  typescnt = typescnt + 1;  
      				        end;
      				      case "J":
      				        if (blank(typeval[CTyper.Code & "_J"])) then begin
        				        typeval[CTyper.Code & "_J"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_J";
              				  typename[typecode[typescnt]] = "JEWELRY " & CTyper.Comment;
              				  typescnt = typescnt + 1;  
      				        end;
      				      case "W":
      				        if (blank(typeval[CTyper.Code & "_W"])) then begin
        				        typeval[CTyper.Code & "_W"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_W";
              				  typename[typecode[typescnt]] = "WATCH " & CTyper.Comment;
              				  typescnt = typescnt + 1;
      				        end;
      				    end;
      				  end else begin
        				  typeval[CTyper.Code] = ".";
        				  typecode[typescnt] = CTyper.Code;
        				  typename[CTyper.Code] = CTyper.Comment;
        				  typescnt = typescnt + 1;  
      				  end;
      				end;
    				end;
    				ExtractObj(DiCbw.DiType,pos,uloc);
    			end;
        end;
      end;
      SortAndClearClassifications(typecode,typename,typescnt);
    end;//Edit***************************Sasha2,11:27 02.06.2016 }

  	if (RepSpec.ArtMode==0) then begin
  		modef = true;
  	end else begin
  		modef = false;
  		RECORDNEW(IV2r);
  	end;
  
		userlocation = false;
		User.Code = currentuser;
		if(readfirstmain(User,1,true))then begin
			if(nonblank(User.UserLocations) and usercanaction("AllowReportWithUserLoc",false))then begin
				userlocation = true;
				pos = 0;
				ExtractObj(User.UserLocations,pos,uloc);
				while (nonblank(uloc)) begin
					if(uloc==location)then begin
						userlocation = false;
					end;
					ExtractObj(User.UserLocations,pos,uloc);
				end;
			end;
		end;
	
    if(userlocation)then begin
			startformat(15);
				outstring(50,0,USetStr(31014),false);
			endformat;
		end else begin
			if(nonblank(RepSpec.sStartDate) and nonblank(RepSpec.sEndDate))then begin
				StartFormat(15);
					outstring(0,0,USetStr(31102),false);
					outstring(40,0,RepSpec.sStartDate & ":" & RepSpec.sEndDate,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31103),false);
					if(nonblank(RepSpec.f1))then begin
						outstring(40,0,RepSpec.f1,false);
					end else begin
						outstring(40,0,USetStr(31104),false);
					end;
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31105),false);
					outstring(40,0,RepSpec.f2,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31205),false);
					outstring(40,0,RepSpec.f4,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31206),false);
					outstring(40,0,RepSpec.f5,false);
				endformat;
				StartFormat(15);
				endformat;
				
				
				
				startformat(15);
					outstring(0,0,USetStr(31042),false);
					outstring(0,0,USetStr(31043),false);
					outstring(0,0,USetStr(12815),false); //Sklad
					outstring(0,0,USetStr(31044),false); //Brand
					if (addclassf==false) then begin //Edit***************************Sasha2,13:15 02.06.2016
					  outstring(0,0,USetStr(19357),false); //Klassificatsia
					end;
					if(currentcompany==9)then begin
						outstring(0,0,USetStr(9131),false);		//Edit----------------------Dima  20.03.2015 //categoria
					end;
					outstring(0,0,USetStr(12713),false); //Naimenovanie
					if (addclassf==false) then begin //Edit***************************Sasha2,13:17 02.06.2016 {
  					outstring(0,0,USetStr(31045),false);//Reference //Kollectsia
  					outstring(0,0,USetStr(31047),false); //Tip metalla
  					outstring(0,0,USetStr(14533),false); //Ves
  					outstring(0,0,USetStr(31048),false); //Karatnost
  					//if(CompanyIsJWLikeCompany(currentcompany))then begin
  						//outstring(0,0,USetStr(31049),false); //Braslet/Remeshok
  						//outstring(0,0,USetStr(31050),false); //Tsvet tsyferblata
  					//end;
  					if(currentcompany==13)then begin		//Edit-----------------------------Dima  30.04.2015
  						outstring(0,0,USetStr(31320),false); //Tsvet
  						outstring(0,0,USetStr(35007),false); //Kvadratura
  					end;					
					end else begin //Edit***************************Sasha2,13:17 02.06.2016 }
					  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
      		    outstring(0,0,typename[typecode[j]],false);
      		  end;
					end;
					outstring(0,0,USetStr(31051),false); //seriinii nomer
					outstring(0,0,"EAN code",false);
					outstring(0,0,USetStr(13199),false);//EKNCode
					outstring(0,0,USetStr(31052),false);
					outstring(100,0,USetStr(31053),false);
					if(bcur==azn)then begin
						outstring(101,0,USetStr(31055) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(102,0,USetStr(31055) & bcur,false);
					end;
					outstring(110,0,USetStr(31056),false);
					if(bcur==azn)then begin
					outstring(111,0,USetStr(31058) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(112,0,USetStr(31058) & bcur,false);
					end;
					outstring(120,0,USetStr(31059),false);
					if(bcur==azn)then begin
						outstring(121,0,USetStr(31061) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(122,0,USetStr(31061) & bcur,false);
					end;
					outstring(130,0,USetStr(31062),false);
					if(bcur==azn)then begin
						outstring(131,0,USetStr(31064) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(132,0,USetStr(31064) & bcur,false);
					end;
					outstring(140,0,USetStr(31065),false);
					if(bcur==azn)then begin
						outstring(141,0,USetStr(31067) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(142,0,USetStr(31067) & bcur,false);
					end;
					outstring(0,0,USetStr(31068),false);
					if (modef) then begin
  					outstring(0,0,USetStr(31069),false);
  					outstring(0,0,USetStr(31070),false);
  					outstring(0,0,USetStr(31071),false);
  					outstring(0,0,USetStr(16709),false);
  					outstring(0,0,USetStr(31072),false);
  					outstring(0,0,USetStr(9269),false);
  					outstring(0,0,USetStr(16574),false);
  					if(currentcompany==9)then begin
  						outstring(0,0,USetStr(3264),false);
  					end;
  					outstring(0,0,USetStr(31073),false);
					end;
					if (addclassf) then begin //Edit***************************Sasha2,14:00 08.02.2016 {
    			  for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
      		    outstring(0,0,typename[typecode[j]],false);
      		  end;
    			end; //Edit***************************Sasha2,14:01 08.02.2016 }
					
					/*ctypecnt = 0; //Edit***************************Sasha2,14:10 11.11.2015 { 
					CTyper.Code = "";
					while (LoopMain(CTyper,1,true)) begin
					  typeindex[ctypecnt] = CTyper.Code;
					  dispnames[typeindex[ctypecnt]] = "";
					  outstring(0,0,CTyper.Code,false);
					  ctypecnt = ctypecnt + 1;
					end;*///Edit***************************Sasha2,14:10 11.11.2015 }	
				endformat;

				total_rebate = 0;//Edit***********************Vitalii 14:28 26.08.2014
				total_rebate_qty = 0;
				total_qty = 0;
				total_cost = 0;
				total_price = 0;
				total_gp = 0;
				btotal_cost = 0;
				btotal_price = 0;
				btotal_gp = 0;
				rangecnt = 0; //Edit***************************Sasha2,11:41 20.11.2014
				arrsize = 20; 
				
				//arrsize = arrsize + ctypecnt; //Edit***************************Sasha2,16:49 11.11.2015
				arrsize = arrsize + typescnt;
				
				IVr.TransDate = sd;
				keyi = 1;
				keystr = "TransDate";
				if(nonblank(location))then begin	
					IVr.Location = location;
					keyi = 2;
					keystr = "Location";
				end;
			
				TrHs =true;
				while(loopkey(keystr,IVr,keyi,TrHs)) begin
					testf = true;
					cred = 1;
					if(IVr.InvType==kInvoiceTypeCredit)then begin
						cred = -1;
					end;
					
					if(IVr.InvDate<sd)then begin testf = false; end;
					if(IVr.InvDate>ed)then begin TrHs = false; testf = false; end;
					if(nonblank(location) and IVr.Location!=location)then begin TrHs = false; testf = false; end;
					if(IVr.OKFlag==0)then begin testf = false; end;
					if(IVr.Invalid>0)then begin testf = false; end;
					if(nonblank(RepSpec.f6) and !setinset(IVr.CustCode,RepSpec.f6))then begin testf = false; end;
				
					if(testf)then begin
						mtrw = matrowcnt(IVr);
						
						tstr = "";
						For(i=0;i<mtrw;i=i+1) begin
	  					matrowget(IVr,i,IVrw);
	  					if(setinset(IVrw.PayMode,tstr)==false)then begin
	  						if(nonblank(tstr))then begin
	  							tstr = tstr & ",";
	  						end;
	  						tstr = tstr & IVrw.PayMode;
	  					end;
						end; 
						
						For(i=0;i<mtrw;i=i+1) begin
							matrowget(IVr,i,IVrw);
							if(IVrw.stp==kInvoiceRowTypeGiftVoucherSold and blank(RepSpec.f4) and blank(RepSpec.f5) and blank(RepSpec.f2))then begin
								PrintGftSertSold(IVr,i,total_price,bcur,azn,addclassf);
							end;
							if(IVrw.stp==kInvoiceRowTypeNormal and nonblank(IVrw.ArtCode))then begin
								INr.Code = IVrw.ArtCode;
								readfirstmain(INr,1,true);
								testf1=true;
							
								if(nonblank(RepSpec.f2))then begin
									testf1=SetInSet2(RepSpec.f2,INr.DispGroups);
								end;
								if(testf1)then begin
									if(nonblank(RepSpec.f4) or nonblank(RepSpec.f5))then begin
										brand = "";
										model = "";
										category = "";
										pos = 0;
										classfind = "";
										ExtractObj(INr.DispGroups,pos,classfind);
										while(nonblank(classfind)) begin
											DIr.Code = classfind;
											readfirstmain(DIr,1,true);
											if(DIr.CType=="BRAND")then begin
												brand = DIr.Code;
											end;
											if(DIr.CType=="MODEL")then begin
												model = DIr.Code;
											end;
											ExtractObj(INr.DispGroups,pos,classfind);
										end;
										if(nonblank(RepSpec.f4) and brand!=RepSpec.f4)then begin
											testf1 = false;
										end;
										if(nonblank(RepSpec.f5) and model!=RepSpec.f5)then begin
											testf1 = false;
										end;
									end;
								end;
								
								if(testf1) then begin
								  pos = 0;
              		brand = "";
              		model = "";
              		if (addclassf) then begin //Edit***************************Sasha2,14:05 02.06.2016 {
                		ExtractObj(INr.DispGroups,pos,uloc);
                		while (NonBlank(uloc)) begin
                		  DIr.Code = uloc;
                		  if (readfirstmain(DIr,1,true)) then begin
                		    if (DIr.CType=="BRAND") then begin
                		      brand = DIr.Name;
                		    end;
                		    if (DIr.CType=="MODEL") then begin
                		      model = DIr.Name;
                		    end;
                		    if (NonBlank(DIr.CType)) then begin 
                				  if (DIr.CType=="GENDER") then begin
                				    switch (Left(UpperCase(INr.MainDisp),1)) begin
                				      case "A":
                      				  DIr.CType = DIr.CType & "_A";
                      				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
                				      case "J":
                				        DIr.CType = DIr.CType & "_J";
                      				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
                				      case "W":
                				        DIr.CType = DIr.CType & "_W";
                      				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
                				    end;
                				  end else begin
                				    typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
                				    switch (Left(UpperCase(INr.MainDisp),1)) begin //if classifications in custom separate fields {
                				      case "A":
                				        if (NonBlank(INr.Reference)) then begin
                				          collf = true;
                				          collstr = "COLL_A";
                				        end;
                				        if (NonBlank(INr.Metal)) then begin
                				          metalf = true;
                				          metalstr = "MATERIAL_A";
                				        end;
                				      case "J":
                				        if (NonBlank(INr.Reference)) then begin
                				          collf = true;
                				          collstr = "COLL_J";
                				        end;
                				        if (NonBlank(INr.Metal)) then begin
                				          metalf = true;
                				          metalstr = "MATERIAL_J";
                				        end;
                				        if (NonBlank(INr.RowWeight)) then begin
                				          tstr = typeval["WEIGHT"];
                    			        pos1 = 0;
                    			        ExtractObj(tstr,pos1,uloc1);
                    			        if (uloc1==INr.Code) then begin
                    			          ExtractObj(tstr,pos1,uloc1);
                    			          if (blank(uloc1)) then begin
                    			            typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
                    			          end;
                    			        end else begin
                    			          typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
                    			        end;
                				        end;
                				        if (NonBlank(INr.MajStoneDet)) then begin
                				          tstr = typeval["D_CARAT"];
                    			        pos1 = 0;
                    			        ExtractObj(tstr,pos1,uloc1);
                    			        if (uloc1==INr.Code) then begin
                    			          ExtractObj(tstr,pos1,uloc1);
                    			          if (blank(uloc1)) then begin
                    			            typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
                    			          end;
                    			        end else begin
                    			          typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
                    			        end;
                				        end;
                				      case "W":
                				        if (NonBlank(INr.Reference)) then begin
                				          collf = true;
                				          collstr = "COLL_W";
                				        end;
                				        if (NonBlank(INr.Metal)) then begin
                				          metalf = true;
                				          metalstr = "MATERIAL_W";
                				        end;
                				    end; 
                				    if (collf) then begin
                				      tstr = typeval[collstr];
                			        pos1 = 0;
                			        ExtractObj(tstr,pos1,uloc1);
                			        if (uloc1==INr.Code) then begin
                			          ExtractObj(tstr,pos1,uloc1);
                			          if (blank(uloc1)) then begin
                			            typeval[collstr] = INr.Code & ";" & INr.Reference;
                			          end;
                			        end else begin
                			          typeval[collstr] = INr.Code & ";" & INr.Reference;
                			        end;  
                				      collf = false;
                				    end;
                				    if (metalf) then begin
                		          tstr = typeval[metalstr];
                			        pos1 = 0;
                			        ExtractObj(tstr,pos1,uloc1);
                			        if (uloc1==INr.Code) then begin
                			          ExtractObj(tstr,pos1,uloc1);
                			          if (blank(uloc1)) then begin
                			            typeval[metalstr] = INr.Code & ";" & INr.Metal;
                			          end;
                			        end else begin
                			          typeval[metalstr] = INr.Code & ";" & INr.Metal;
                			        end;
                				      metalf = false;
                				    end;//if classifications in custom separate fields }
                				  end;
                				end;
                		  end; //Edit***************************Sasha2,14:05 02.06.2016 }
                		  ExtractObj(INr.DispGroups,pos,uloc);
                		end;
                	end;
									if (modef) then begin
										startformat(15);
									end;
										if (modef) then begin
											outstring(0,0,IVrw.ArtCode,false);
											outstring(0,0,INr.AlternativeCode,false);
											outstring(0,0,IVr.Location,false);
											
											if (addclassf==false) then begin
  											classname = "";
  											k=0;
  											ExtractObj(INr.DispGroups,k,classcode);
  											DIr.Code = classcode;
  											readfirstmain(DIr,1,true);
  											classname = DIr.Name;
  											outstring(0,0,classname,false);
  											//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
  											
  											classname2 = "";
  											ExtractObj(INr.DispGroups,k,classcode);
  											DIr.Code = classcode;
  											readfirstmain(DIr,1,true);
  											classname2 = DIr.Name;
  											if(currentcompany==9) then begin
  												category = DIr.CCat;	//Edit----------------------Dima  20.03.2015
  											end;											
  											outstring(0,0,classname2,false);
  											//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
											end else begin //Edit***************************Sasha2,14:11 02.06.2016 {
											  outstring(0,0,brand,false);
											end; //Edit***************************Sasha2,14:11 02.06.2016 ]
											
											
											/*ExtractObj(INr.DispGroups,k,classcode); //Edit***************************Sasha2,14:52 11.11.2015 {
											while (NonBlank(classcode)) begin
											  DIr.Code = classcode;
											  if (readfirstmain(DIr,1,true)) then begin
											    dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ",";
											  end;
											  ExtractObj(INr.DispGroups,k,classcode);
											end;*/ //Edit***************************Sasha2,14:52 11.11.2015 }
											
											if(currentcompany==9) then begin
												outstring(0,0,category,false);
											end;
											outstring(0,0,prepareStr(IVrw.Spec),false);
											if (addclassf==false) then begin //Edit***************************Sasha2,14:21 02.06.2016 {
  											outstring(0,0,INr.Reference,false);
  											outstring(0,0,INr.Metal,false);
  											outstring(0,0,INr.RowWeight,false);
  											outstring(0,0,INr.MajStoneDet,false);
  											//if(CompanyIsJWLikeCompany(currentcompany))then begin
  												//outstring(0,0,INr.BrcStr,false);
  												//outstring(0,0,INr.Gender,false);
  											//end;
  											if(currentcompany==13)then begin		//Edit----------------------Dima  30.04.2015
  												outstring(0,0,INr.Size,false);
  												outstring(0,0,INr.Colour,false);											
  											end;  
                  		end else begin
                  		  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
                  		    pos = 0;
                  		    ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                  		    if (uloc==INr.Code) then begin
                  		      ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                            outstring(0,0,uloc,false);
                          end else begin
                            outstring(0,0,"",false);
                  		    end;
                  		  end;
											end; //Edit***************************Sasha2,14:21 02.06.2016 }
											
											outstring(0,0,IVrw.SerialNr,false);
											outstring(0,0,INr.BarCode,false);
											outstring(0,0,INr.EKNCode,false);
											outstring(0,0,IVrw.Quant*cred,false);
										end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
											rangeval = CalculateCoef(IV2r,rangecnt,IVrw.ArtCode,IVr.Location,iteminf,arrsize);
											valscnt = rangeval;
											strscnt = rangeval;
											if (iteminf==false) then begin
												arrstrs[strscnt] = IVrw.ArtCode; strscnt = strscnt + 1;
												arrstrs[strscnt] = INr.AlternativeCode; strscnt = strscnt + 1;
												arrstrs[strscnt] = IVr.Location; strscnt = strscnt + 1;
												
												if (addclassf==false) then begin
  												classname = "";
  												k=0;
  												ExtractObj(INr.DispGroups,k,classcode);
  												DIr.Code = classcode;
  												readfirstmain(DIr,1,true);
  												classname = DIr.Name;
  												//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
  												arrstrs[strscnt] = classname; strscnt = strscnt + 1;
  												
  												classname2 = "";
  												ExtractObj(INr.DispGroups,k,classcode);
  												DIr.Code = classcode;
  												readfirstmain(DIr,1,true);
  												classname2 = DIr.Name;
  												//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
  												arrstrs[strscnt] = classname2; strscnt = strscnt + 1;
												end else begin //Edit***************************Sasha2,14:23 02.06.2016 {
												  arrstrs[strscnt] = brand; strscnt = strscnt + 1;
												end; //Edit***************************Sasha2,14:23 02.06.2016 }
												
												arrstrs[strscnt] = prepareStr(IVrw.Spec); strscnt = strscnt + 1;
												if (addclassf==false) then begin //Edit***************************Sasha2,14:21 02.06.2016 {
    											arrstrs[strscnt] = INr.Reference; strscnt = strscnt + 1; 
  												arrstrs[strscnt] = INr.Metal; strscnt = strscnt + 1; 
  												arrstrs[strscnt] = INr.RowWeight;strscnt = strscnt + 1;
  												arrstrs[strscnt] = INr.MajStoneDet; strscnt = strscnt + 1;
  												//if(CompanyIsJWLikeCompany(currentcompany))then begin
  													//arrstrs[strscnt] = INr.BrcStr; strscnt = strscnt + 1; 
  													//arrstrs[strscnt] = INr.Gender; strscnt = strscnt + 1;
  												//end;
  												if(currentcompany==13)then begin	//Edit----------------------Dima  30.04.2015
  													arrstrs[strscnt] = INr.Size; strscnt = strscnt + 1; 
  													arrstrs[strscnt] = INr.Colour; strscnt = strscnt + 1;
  												end;	  
                    		end else begin
                    		  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
                    		    pos = 0;
                    		    ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                    		    if (uloc==INr.Code) then begin
                    		      ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                              arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
                            end else begin
                              arrstrs[strscnt] = ""; strscnt = strscnt + 1;
                    		    end;
                    		  end;
  											end; //Edit***************************Sasha2,14:21 02.06.2016 }
												//arrstrs[strscnt] = ""; strscnt = strscnt + 1;											
												arrstrs[strscnt] = INr.BarCode; strscnt = strscnt + 1;
												arrstrs[strscnt] = INr.EKNCode; strscnt = strscnt + 1;
                    		
												/*ExtractObj(INr.DispGroups,k,classcode); //Edit***************************Sasha2,14:52 11.11.2015 {
  											while (NonBlank(classcode)) begin
  											  DIr.Code = classcode;
  											  if (readfirstmain(DIr,1,true)) then begin
  											    dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ",";
  											  end;
  											  ExtractObj(INr.DispGroups,k,classcode);
  											end; *///Edit***************************Sasha2,14:52 11.11.2015 }
												
											end else begin
												if(addclassf)then begin
													strscnt = strscnt + 7 + typescnt;
												end else begin
												  if (currentcompany==13) then begin
												    strscnt = strscnt + 14;
												  end else begin
												    strscnt = strscnt + 12;
												  end;
												end;
											end;
											arrvals[valscnt] = arrvals[valscnt] + IVrw.Quant; valscnt = valscnt + 1;
										end; //Edit***************************Sasha2,11:18 20.11.2014 }
										
										total_qty = total_qty + IVrw.Quant;
										fr = IVr.FrRate;
										to1 = IVr.ToRateB1;
										if(fr==0 or to1==0)then begin
											fr = 1;
											to1 = 1;
										end;
										IVrw.Price = IVrw.Price/fr*to1;
										IVrw.Sum = IVrw.Sum/fr*to1;
										
										if(IVr.UpdStockFlag>0 and IVr.OrderNr<0)then begin
											updst = true;
										end else begin
											updst = false;
										end;
										
										
										FindFIFOOrigValAndCurncyIV(IVr.SerNr,i,brandfifo,brandcur,fifob1,updst);
										if(fifob1==0)then begin
											fifob1 = INr.WeighedAvPrice * IVrw.Quant;
										end;
										if(brandfifo==0)then begin
											brandfifo = INr.LastPurchPrice2 * IVrw.Quant;
										end;
										
										
										brandfifo = AbsoluteVal(brandfifo/IVrw.Quant);
										fifob1 = AbsoluteVal(fifob1/IVrw.Quant);
										
										GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
										if(aznfr==0 or aznto==0)then begin
											aznfr = 1; aznto = 1;
										end;
										fifoazn = fifob1*aznfr/aznto;
										
										if (modef) then begin
											outstring(100,0,brandfifo,false);//brandcur
											if(bcur==azn)then begin
												outstring(101,0,fifoazn,false);//AZN
											end;
											if(bcur!=azn)then begin
												outstring(102,0,fifob1,false);//basecur
											end;
											outstring(110,0,brandfifo*IVrw.Quant*cred,false);//brandcur
											if(bcur==azn)then begin
												outstring(111,0,fifoazn*IVrw.Quant*cred,false);//AZN
											end;
											if(bcur!=azn)then begin
												outstring(112,0,fifob1*IVrw.Quant*cred,false);//basecur
											end;
										end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
											arrvals[valscnt] = arrvals[valscnt] + brandfifo; valscnt = valscnt + 1;
											arrvals[valscnt] = arrvals[valscnt] + fifoazn; valscnt = valscnt + 1;
											if(bcur!=azn)then begin
												arrvals[valscnt] = arrvals[valscnt] + fifob1; valscnt = valscnt + 1;
											end;
											arrvals[valscnt] = arrvals[valscnt] + brandfifo*IVrw.Quant*cred; valscnt = valscnt + 1;
											arrvals[valscnt] = arrvals[valscnt] + fifoazn*IVrw.Quant*cred; valscnt = valscnt + 1;
											if(bcur!=azn)then begin
												arrvals[valscnt] = arrvals[valscnt] + fifob1*IVrw.Quant*cred; valscnt = valscnt + 1;
											end;
										end; //Edit***************************Sasha2,11:18 20.11.2014 }
										
										GetFullCurncyRate(brandcur,IVr.TransDate,fr,to1,to2,br1,br2);
										if(fr==0 or to1==0)then begin
											fr = 1; to1 = 1;
										end;
										/*if(fr==0 or to1==0)then begin
											fr = 1; to1 = 1;
										end;*/
										bfr = IVr.FrRate;
										bto = IVr.ToRateB1;
										if(bfr==0 or bto==0)then begin
											bfr = 1;
											bto = 1;
										end;
										
										total_cost = total_cost + fifoazn*IVrw.Quant*cred;
										btotal_cost = btotal_cost + fifob1*IVrw.Quant*cred;
										
										curprice = round(IVrw.Price*fr/to1,SetRoundModeD(1))*cred;
										
										if (modef) then begin
											outstring(120,0,curprice,false);//brandcur
											if(bcur==azn)then begin
												outstring(121,0,IVrw.Price*aznfr/aznto,false);//AZN
											end;
										end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
											arrvals[valscnt] = arrvals[valscnt] + curprice; valscnt = valscnt + 1;
											arrvals[valscnt] = arrvals[valscnt] + IVrw.Price*aznfr/aznto; valscnt = valscnt + 1;
										end; //Edit***************************Sasha2,11:18 20.11.2014 }
										
										total_rebate = total_rebate + IVrw.Price*aznfr/aznto*IVrw.Quant;// Edit ************************** Wednesday, 22 October 2014 16:43:55
										
										if (modef) then begin
											if(bcur!=azn)then begin
												outstring(122,0,IVrw.Price,false);//basecur
											end;
										end else  begin //Edit***************************Sasha2,11:17 20.11.2014 {
											if(bcur!=azn)then begin
												arrvals[valscnt] = arrvals[valscnt] + IVrw.Price; valscnt = valscnt + 1;
											end;
										end; //Edit***************************Sasha2,11:18 20.11.2014 }
										
										curcusm = round(IVrw.Sum*fr/to1,SetRoundModeD(1))*cred;
										
										if (modef) then begin
											outstring(130,0,curcusm,false);//brandcur
											if(bcur==azn)then begin
												outstring(131,0,IVrw.Sum*aznfr/aznto*cred,false);//AZN
											end;
										end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
											arrvals[valscnt] = arrvals[valscnt] + curcusm; valscnt = valscnt + 1;
											arrvals[valscnt] = arrvals[valscnt] + IVrw.Sum*aznfr/aznto*cred; valscnt = valscnt + 1;
										end; //Edit***************************Sasha2,11:17 20.11.2014 }
										
										total_rebate_qty = total_rebate_qty + IVrw.Sum*aznfr/aznto*cred;// Edit ************************** Wednesday, 22 October 2014 16:44:51
										if (modef) then begin
											if(bcur!=azn)then begin
												outstring(132,0,IVrw.Sum*cred,false);//basecur
											end;
										end else  begin //Edit***************************Sasha2,11:17 20.11.2014 {
											if(bcur!=azn)then begin
												arrvals[valscnt] = arrvals[valscnt] + IVrw.Sum*cred; valscnt = valscnt + 1;
											end;
										end; //Edit***************************Sasha2,11:17 20.11.2014 {
										
										total_price = total_price + IVrw.Sum*aznfr/aznto*cred;
										btotal_price = btotal_price + IVrw.Sum*cred;
										
										if (modef) then begin
											outstring(140,0,curcusm - brandfifo*IVrw.Quant*cred,false);//brandcur
											if(bcur==azn)then begin
												outstring(141,0,IVrw.Sum*aznfr/aznto*cred - fifob1*IVrw.Quant*aznfr/aznto*cred,false);//AZN
											end;
											if(bcur!=azn)then begin
												outstring(142,0,(IVrw.Sum - fifob1*IVrw.Quant)*cred,false);//basecur
											end;
											outstring(0,0,brandcur,false);
											outstring(0,0,IVr.CustCode,false);
											outstring(0,0,IVr.Addr0,false);
											outstring(0,0,IVrw.vRebate,false);
											//total_rebate = total_rebate + IVrw.vRebate*AbsoluteVal(IVrw.Quant);//Edit***********************Vitalii 14:28 26.08.2014
											/*if(IVrw.vRebate!=0)then begin
												total_rebate_qty = total_rebate_qty + AbsoluteVal(IVrw.Quant);											
											end;*/
											outstring(0,0,IVr.SalesMan,false);
											outstring(0,0,IVr.TransDate,false);
											outstring(0,0,IVr.PayDeal,false);
											outstring(0,0,IVr.InvComment,false);
										end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
											arrvals[valscnt] = arrvals[valscnt] + (curcusm - brandfifo*IVrw.Quant)*cred; valscnt = valscnt + 1;
											arrvals[valscnt] = arrvals[valscnt] + (IVrw.Sum*aznfr/aznto - fifob1*IVrw.Quant*aznfr/aznto)*cred; valscnt = valscnt + 1;
											if(bcur!=azn)then begin
												arrvals[valscnt] = arrvals[valscnt] + (IVrw.Sum - fifob1*IVrw.Quant)*cred; valscnt = valscnt + 1;
											end;
											arrstrs[strscnt] = brandcur; strscnt = strscnt + 1;
											if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
                  		  for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
                  		    pos = 0;
                  		    ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                  		    if (uloc==INr.Code) then begin
                  		      ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                            arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
                          end else begin
                            arrstrs[strscnt] = ""; strscnt = strscnt + 1;
                  		    end;
                  		  end;
                  		end; //Edit***************************Sasha2,14:37 08.02.2016 }
                      /*for (m=0;m<ctypecnt;m=m+1) begin 
											  arrstrs[strscnt] = dispnames[typeindex[m]]; strscnt = strscnt + 1;
											end; 
											MyClearVector(dispnames,typeindex,ctypecnt);*/
										end; //Edit***************************Sasha2,11:17 20.11.2014 }
										
										if (modef) then begin //Edit***************************Sasha2,11:17 20.11.2014	
											if(currentcompany==9)then begin
												if(IVr.OrderNr>-1)then begin
													ORr.SerNr = IVr.OrderNr;
													readfirstmain(ORr,1,true);
													if(nonblank(ORr.OrderClass))then begin
														outstring(0,0,ORr.OrderClass,false);
													end;
												end;
											end;
											outstring(0,0,tstr,false);
											if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
                  		  for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
                  		    pos = 0;
                  		    ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                  		    if (uloc==INr.Code) then begin
                  		      ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                            outstring(0,0,uloc,false);
                          end else begin
                            outstring(0,0,"",false);
                  		    end;
                  		  end;
                  		end; //Edit***************************Sasha2,14:37 08.02.2016 }
											/*for (m=0;m<ctypecnt;m=m+1) begin //Edit***************************Sasha2,15:28 11.11.2015 {
											  outstring(0,0,Left(dispnames[typeindex[m]],len(dispnames[typeindex[m]])-1),false);
											end; 
											MyClearVector(dispnames,typeindex,ctypecnt);*/ //Edit***************************Sasha2,15:28 11.11.2015 }
										end;
										
									if (modef) then begin	//Edit***************************Sasha2,11:12 20.11.2014								
										endformat;
									end;
								end;
							end;
						end; 
					end;
				end;
				
				if (modef==false) then begin
					mtrw = matrowcnt(IV2r);
					for (i=0;i<mtrw;i=i+1) begin
						matrowget(IV2r,i,IVrw);
						valscnt = IVrw.Quant;
						strscnt = IVrw.Quant;
						itemoccurrences = IVrw.Sum*cred;
						startformat(15);
							outstring(1,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //IVrw.ArtCode
							outstring(2,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.AlternativeCode
							outstring(3,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //IVr.Location
							outstring(4,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname
							if (addclassf==false) then begin //Edit***************************Sasha2,17:43 02.06.2016 {
							  outstring(5,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname2
							end; //Edit***************************Sasha2,17:43 02.06.2016 }
							outstring(6,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //prepareStr(IVrw.Spec)
							if (addclassf==false) then begin
  							outstring(7,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Reference
  							outstring(8,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Metal
  							outstring(9,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.RowWeight
  							outstring(10,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.MajStoneDet
  							//if(CompanyIsJWLikeCompany(currentcompany))then begin
  								//outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.BrcStr
  								//outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Gender
  							//end;
  							if(currentcompany==13)then begin			//Edit----------------------Dima  30.04.2015
  								outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Size
  								outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Colour
  							end;	
							end else begin  //Edit***************************Sasha2,17:43 02.06.2016 {
							  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
          		    outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1;
          		  end;
							end;	//Edit***************************Sasha2,17:43 02.06.2016 }
							outstring(13,0,"",false); //IVrw.SerialNr
							outstring(13,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.BarCode
							outstring(14,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.EKNCode
							outstring(15,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Quant
							outstring(16,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //brandfifo
							if(bcur==azn)then begin
								outstring(17,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //fifoazn
							end;
							if(bcur!=azn)then begin
								outstring(18,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //fifob1
							end;
							outstring(19,0,arrvals[valscnt],false); valscnt = valscnt + 1; //brandfifo*IVrw.Quant
							if(bcur==azn)then begin
								outstring(20,0,arrvals[valscnt],false); valscnt = valscnt + 1; //fifoazn*IVrw.Quant
							end;
							if(bcur!=azn)then begin
								outstring(21,0,arrvals[valscnt],false); valscnt = valscnt + 1; //fifob1*IVrw.Quant
							end;
							outstring(22,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //curprice
							if(bcur==azn)then begin
								outstring(23,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //IVrw.Price*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(24,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //IVrw.Price
							end;
							outstring(25,0,arrvals[valscnt],false); valscnt = valscnt + 1; //curcusm
							if(bcur==azn)then begin
							outstring(26,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(27,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum
							end;
							outstring(28,0,arrvals[valscnt],false); valscnt = valscnt + 1; //curcusm - brandfifo*IVrw.Quant
							if(bcur==azn)then begin
								outstring(29,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum*aznfr/aznto - fifob1*IVrw.Quant*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(30,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum - fifob1*IVrw.Quant
							end;
							outstring(31,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //brandcur
							if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
          		  for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
          		    outstring(32,0,arrstrs[strscnt],false); strscnt = strscnt + 1;
          		  end;
          		end; //Edit***************************Sasha2,14:37 08.02.2016 }
							/*for (m=0;m<ctypecnt;m=m+1) begin //Edit***************************Sasha2,16:15 11.11.2015 {
							  outstring(32,0,Left(arrstrs[strscnt],len(arrstrs[strscnt])-1),false); strscnt = strscnt + 1; //disp types
							end;*/ //Edit***************************Sasha2,16:15 11.11.2015 }
						endformat;
					end;
				end;
								
				startformat(15);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					if (addclassf==false) then begin
					  outstring(0,0,"",false);
					end;
					if (currentcompany==9) then begin
					  outstring(0,0,"",false);
					end;
					outstring(0,0,"",false);
					if (addclassf==false) then begin
					  outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						if (currentcompany==13) then begin
						  outstring(0,0,"",false);
						  outstring(0,0,"",false);
						end;
					end else begin
					  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
      		    outstring(0,0,"",false);
      		  end;
					end;				
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31074),false);
					outstring(0,0,total_qty,false);
					if(bcur!=azn)then begin
						outstring(0,0,"",false);
					end;
					if(bcur==azn)then begin
						outstring(0,0,"",false);
					end;
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31075),false);
					if(bcur==azn)then begin
						outstring(0,0,total_cost,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_cost,false);
						outstring(0,0,"",false);
					end;
					if(bcur==azn)then begin
					outstring(0,0,"",false);
					end;
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31076),false);
					if(bcur==azn)then begin
						outstring(0,0,total_price,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_price,false);
					end;
					outstring(0,0,USetStr(31077),false);
					if(bcur==azn)then begin
						outstring(0,0,total_price - total_cost,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_price - btotal_cost,false);
					end;
					//Edit***********************Vitalii 14:28 26.08.2014
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31078),false);
					//outstring(0,0,total_rebate/total_rebate_qty,false);
					outstring(0,0,100-(100*(total_rebate_qty/total_rebate)),false);// Edit ************************** Wednesday, 22 October 2014 16:45:31
	
				endformat;
			end else begin
				startformat(15);
					outstring(100,0,USetStr(31079),false);
				endformat;
			end;
		end;
	EndJob;
return;
end;
