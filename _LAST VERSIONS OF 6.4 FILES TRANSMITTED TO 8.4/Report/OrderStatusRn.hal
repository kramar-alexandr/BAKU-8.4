external procedure ExtractObj(string,var Integer,var string);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external function longint DateDiff(date,date);
external procedure GetCurncyRoundoff(string,string,string,var roundmode,var roundmode,var roundmode);


//SetLangMode(LangRussian,"RUS",0);  //Edit Dima-----------16.12.2014

procedure PrintInfo(record ORVc ORr)
begin
	integer i,mtrw;
	record IVVc IVr;
	row IVVc IVrw;
	record SHVc SHr;
	row SHVc SHrw;
	boolean TrHs, testf;
	string 50 keystr,class,model;
	record DIVc DIr;
	integer keyint,pos;
	row ORVc ORrw;
	record INVc INr;
	val qtysum,sumpay,ordqty,ivsum,ivqty;
	record IPrsVc IPrsr;
	record IPVc IPr;
	row IPVc IPrw;
	boolean TrHs1,testf1;
	val ordrate,ivrate;
	val fr,to1,to2,br1,br2;
  roundmode rnd,roundlines,rndvat;
  val rate;
	record RetVc Retr;
  row RetVc Retrw;
  boolean retTrHs,rettestf;
  integer reti,retmtrw;
  
	rate = 1;
	if(currentcompany==1)then begin
		rate = 1.1;
	end;
	
	qtysum = 0;
	sumpay = 0;
	ordqty = 0;
	ivsum = 0;
	ivqty = 0;
	
	fr = ORr.FrRate;
	to1 = ORr.ToRateB1;
	if(fr<=0 or to1<=0)then begin
		fr = 1;
		to1 = 1;
	end;
	ordrate = to1/fr;
	
	startformat(15);
		outstring(0,0,USetStr(31266),false);
		outstring(0,0,USetStr(31220),false);
		outstring(0,0,USetStr(31258),false);
		outstring(0,0,"",false);
		outstring(0,0,USetStr(31267),false);
		outstring(0,0,"",false);
		outstring(0,0,USetStr(31245),false);
	endformat;

	startformat(15);
		outstring(0,0,ORr.SerNr,false);
		outstring(0,0,ORr.OrdDate,false);
		outstring(0,0,ORr.CustCode & " " & ORr.Addr0,false);
		outstring(0,0,"",false);
		outstring(0,0,ORr.RebCode,false);
		outstring(0,0,"",false);
		outstring(0,0,ORr.Comment,false);
	endformat;

	startformat(15);
	endformat;

	startformat(15);
		outstring(0,0,USetStr(31268),false);
		outstring(0,0,USetStr(31220),false);
		outstring(0,0,USetStr(31269),false);
		outstring(0,0,USetStr(31270),false);
		outstring(0,0,USetStr(31271),false);
		outstring(0,0,USetStr(31272),false);
		outstring(0,0,USetStr(31273),false);
	endformat;
	mtrw = matrowcnt(ORr);
	For(i=0;i<mtrw;i=i+1) begin
		matrowget(ORr,i,ORrw);
		if(nonblank(ORrw.ArtCode))then begin
			startformat(15);
				if(i==0)then begin
					outstring(0,0,ORr.Sum4*ordrate*rate,false);
				end else begin
					outstring(0,0,"",false);
				end;
				outstring(0,0,ORr.OrdDate,false);
				outstring(0,0,ORrw.ArtCode,false);
	
				pos = 0;
				class = "";
				model = "";
				INr.Code = ORrw.ArtCode;
				readfirstmain(INr,1,true);
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="MODEL")then begin
						model = DIr.Name;
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				outstring(0,0,model & " " & ORrw.Spec,false);
				outstring(0,0,ORrw.Quant,false);
				outstring(0,0,ORrw.Price*ordrate*rate,false);
				outstring(0,0,ORrw.Sum*ordrate*rate,false);
			endformat;
			ordqty = ordqty + ORrw.Quant;
		end;
	end; 
	startformat(15);
		outstring(0,0,USetStr(31222),false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,ordqty,false);
		outstring(0,0,"",false);
		outstring(0,0,ORr.Sum4*ordrate*rate,false);
	endformat;

	startformat(15);
	endformat;

	startformat(15);
		outstring(0,0,USetStr(31274),false);
		outstring(0,0,USetStr(31220),false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,USetStr(31239),false);
	endformat;
	IPrsr.CustCode = ORr.CustCode;
	TrHs1 = true;
	while(loopmain(IPrsr,1,TrHs1))begin
		testf1 = true;
		if(IPrsr.CustCode!=ORr.CustCode)then begin TrHs1 = false; testf1 = false; end;
		if(IPrsr.TransType!=1)then begin testf1 = false; end;
		
		if(testf1)then begin
			if(IPrsr.IVNr>-1)then begin
				IVr.SerNr = IPrsr.IVNr;
				if(readfirstmain(IVr,1,true))then begin
					if(IVr.OrderNr==ORr.SerNr)then begin
						IPr.SerNr = IPrsr.TransNr;
						if(readfirstmain(IPr,1,true))then begin
							mtrw = matrowcnt(IPr);
							For(i=0;i<mtrw;i=i+1) begin
								matrowget(IPr,i,IPrw);
								if(IPrw.CustCode==ORr.CustCode and IPrw.InvoiceNr==IPrsr.IVNr)then begin
									GetFullCurncyRate(IPrw.BankCurncy,IPrw.PayDate,fr,to1,to2,br1,br2);
									if(fr<=0 or to1<=0)then begin
										fr = 1;
										to1 = 1;
									end;
									startformat(15);
										outstring(0,0,USetStr(31275),false);
										outstring(0,0,IPrw.PayDate,false);
										outstring(0,0,"",false);
										outstring(0,0,"",false);
										outstring(0,0,"",false);
										outstring(0,0,"",false);
										outstring(0,0,IPrw.RecVal*to1/fr*rate,false);
									endformat;
									sumpay = sumpay + IPrw.RecVal*to1/fr;
								end;
							end;
						end;
					end;
				end;
			end else begin
				IPr.SerNr = IPrsr.TransNr;
				if(readfirstmain(IPr,1,true))then begin
					mtrw = matrowcnt(IPr);
						For(i=0;i<mtrw;i=i+1) begin
							matrowget(IPr,i,IPrw);
							if(IPrw.CustCode==ORr.CustCode and IPrw.InvoiceNr<0 and IPrw.OrderNr==ORr.SerNr)then begin
								GetFullCurncyRate(IPrw.BankCurncy,IPrw.PayDate,fr,to1,to2,br1,br2);
								if(fr<=0 or to1<=0)then begin
									fr = 1;
									to1 = 1;
								end;
								startformat(15);
									outstring(0,0,USetStr(31276),false);
									outstring(0,0,IPrw.PayDate,false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,IPrw.RecVal*to1/fr*rate,false);
								endformat;
								sumpay = sumpay + IPrw.RecVal*to1/fr;
							end;
						end;
				end;
			end;
		end;
	end;
	resetloop(IPrsr);
	
	IVr.OrderNr = ORr.SerNr;
	TrHs1 = true;
	while(loopkey("OrderNr",IVr,1,TrHs1))begin
		testf1 = true;
		if(IVr.OrderNr!=ORr.SerNr)then begin TrHs1 = false; testf1 = false; end;
		if(IVr.OKFlag!=1)then begin testf1 = false; end;
		if(IVr.Invalid==1)then begin testf1 = false; end;
		
		if(testf1)then begin					
			mtrw = matrowcnt(IVr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(IVr,i,IVrw);
				if(IVrw.stp==kInvoiceRowTypeCashPayment)then begin
					GetCurncyRoundoff(IVrw.CurncyCode,IVr.PayDeal,"IVVc",rnd,roundlines,rndvat);
					GetFullCurncyRate(IVrw.CurncyCode,IVr.InvDate,fr,to1,to2,br1,br2);
					if(fr<=0 or to1<=0)then begin
						fr = 1;
						to1 = 1;
					end;
					startformat(15);
						outstring(0,0,USetStr(31277),false);
						outstring(0,0,IVr.InvDate,false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,round(IVrw.Sum*to1/fr*rate,rnd),false);
					endformat;
					sumpay = sumpay + round(IVrw.Sum*to1/fr,rnd);
				end;
				
				if(IVrw.stp==kInvoiceRowTypeLoyaltyPointsPayment)then begin
					GetCurncyRoundoff(IVrw.CurncyCode,IVr.PayDeal,"IVVc",rnd,roundlines,rndvat);
					GetFullCurncyRate(IVrw.CurncyCode,IVr.InvDate,fr,to1,to2,br1,br2);
					if(fr<=0 or to1<=0)then begin
						fr = 1;
						to1 = 1;
					end;
					startformat(15);
						outstring(0,0,USetStr(31278),false);
						outstring(0,0,IVr.InvDate,false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,round(IVrw.Sum*to1/fr*rate,rnd),false);
					endformat;
					sumpay = sumpay + round(IVrw.Sum*to1/fr,rnd);
				end;
				
				if(IVrw.stp==kInvoiceRowTypeCreditCardPayment)then begin				
					startformat(15);
						outstring(0,0,USetStr(31279),false);
						outstring(0,0,IVr.InvDate,false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,IVrw.Sum*rate,false);
					endformat;
					sumpay = sumpay + IVrw.Sum;
				end;
				
			end; 
		end;
	end;
	resetloop(IVr);
	
	startformat(15);
		outstring(0,0,USetStr(31222),false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,sumpay*rate,false);
	endformat;

	startformat(15);
	endformat;
	startformat(15);
		outstring(0,0,USetStr(31280),false);
		outstring(0,0,USetStr(31220),false);
		outstring(0,0,USetStr(31203),false);
		outstring(0,0,"",false);
		outstring(0,0,USetStr(31238),false);
		outstring(0,0,"",false);
		outstring(0,0,USetStr(31239),false);
	endformat;

	IVr.OrderNr = ORr.SerNr;
	TrHs1 = true;
	while(loopkey("OrderNr",IVr,1,TrHs1))begin
		testf1 = true;
		if(IVr.OrderNr!=ORr.SerNr)then begin TrHs1 = false; testf1 = false; end;
		if(IVr.OKFlag!=1)then begin testf1 = false; end;
		if(IVr.Invalid==1)then begin testf1 = false; end;
		
		
		if(testf1)then begin
			fr = IVr.FrRate;
			to1 = IVr.ToRateB1;
			if(fr<=0 or to1<=0)then begin
				fr = 1;
				to1 = 1;
			end;
			ivrate = to1/fr;
			
			mtrw = matrowcnt(IVr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(IVr,i,IVrw);
				if(IVrw.stp==kInvoiceRowTypeNormal)then begin
					startformat(15);
						outstring(0,0,"",false);
						outstring(0,0,IVr.TransDate,false);
						outstring(0,0,IVrw.ArtCode,false);
						outstring(0,0,"",false);
						outstring(0,0,IVrw.Quant,false);
						outstring(0,0,"",false);
						outstring(0,0,IVrw.Sum*ivrate*rate,false);
					endformat;
					ivsum = ivsum + IVrw.Sum*ivrate;
					ivqty = ivqty + IVrw.Quant;
				end;
			end; 
		end;
	end;
	resetloop(IVr);
	startformat(15);
		outstring(0,0,USetStr(31222),false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,ivqty,false);
		outstring(0,0,"",false);
		outstring(0,0,ivsum*rate,false);
	endformat;
	startformat(15);
	endformat;
	startformat(15);
		outstring(0,0,USetStr(31281),false);
		outstring(0,0,USetStr(31220),false);
		outstring(0,0,USetStr(31203),false);
		outstring(0,0,"",false);
		outstring(0,0,USetStr(31238),false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
	endformat;

	qtysum = 0;
	SHr.OrderNr = ORr.SerNr;
	TrHs1 = true;
	while(loopkey("OrderKey",SHr,1,TrHs1))begin
		testf1 = true;
		if(SHr.OrderNr!=ORr.SerNr)then begin TrHs1 = false; testf1 = false; end;
		if(SHr.OKFlag!=1)then begin testf1 = false; end;			
		
		if(testf1)then begin
			mtrw = matrowcnt(SHr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(SHr,i,SHrw);
				Retr.SHNr = SHr.SerNr;
				retTrHs = true;
				while(loopkey("SHNr",Retr,1,retTrHs))begin
					rettestf = true;
					if(Retr.SHNr!=SHr.SerNr)then begin retTrHs = false; rettestf = false; end;
					if(Retr.OKFlag==0)then begin rettestf = false; end;
					if(Retr.Invalid==1)then begin rettestf = false; end;
					
					if(rettestf)then begin
						retmtrw = matrowcnt(Retr);
						For(reti=0;reti<retmtrw;reti=reti+1) begin
							matrowget(Retr,reti,Retrw);
							if(Retrw.SHRow==i and Retrw.ArtCode==SHrw.ArtCode)then begin
								SHrw.Ship = SHrw.Ship - Retrw.Quant;
							end;
						end; 
					end;
				end;
				resetloop(Retr);
				if(SHrw.Ship!=0)then begin
					startformat(15);
						outstring(0,0,"",false);
						outstring(0,0,SHr.ShipDate,false);
						outstring(0,0,SHrw.ArtCode,false);
						outstring(0,0,"",false);
						outstring(0,0,SHrw.Ship,false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
					endformat;
					qtysum = qtysum + SHrw.Ship;
				end;
			end; 
		end;
	end;
	resetloop(SHr);
	startformat(15);
		outstring(0,0,USetStr(31222),false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,qtysum,false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
	endformat;

	startformat(15);
	endformat;

	startformat(15);
	outstring(0,0,USetStr(31282),false);
	endformat;

	startformat(15);
	outstring(0,0,USetStr(31283),false);
	outstring(0,0,ordqty - qtysum,false);
	endformat;

	startformat(15);
	outstring(0,0,USetStr(31284),false);
	outstring(0,0,ORr.Sum4*ordrate*rate - sumpay*rate,false);
	endformat;

	startformat(15);
	outstring(0,0,USetStr(31285),false);
	outstring(0,0,ordqty - ivqty,false);
	endformat;

	startformat(15);
	outstring(0,0,USetStr(31286),false);
	outstring(0,0,ORr.Sum4*ordrate*rate - ivsum*rate,false);
	endformat;

	startformat(15);
	endformat;
	startformat(15);
	endformat;
	
	
return;
end;

global procedure OrderStatusRn(record RcVc RepSpec)
begin
	integer i,mtrw;
	record IVVc IVr;
	row IVVc IVrw;
	record SHVc SHr;
	row SHVc SHrw;
	boolean TrHs, testf;
	string 50 keystr,class,model;
	record DIVc DIr;
	integer keyint,pos;
	record ORVc ORr;
	row ORVc ORrw;
	record INVc INr;
	val qtysum,sumpay,ordqty,ivsum,ivqty;
	record IPrsVc IPrsr;
	record IPVc IPr;
	row IPVc IPrw;
	boolean TrHs1,testf1;
	val ordrate,ivrate;
	val fr,to1,to2,br1,br2;
  roundmode rnd,roundlines,rndvat;
  val rate;
  record RetVc Retr;
  row RetVc Retrw;
  boolean retTrHs,rettestf;
  integer reti,retmtrw;
  
	
	rate = 1;
	if(currentcompany==1)then begin
		rate = 1.1;
	end;
	if(RepSpec.long1>-1)then begin
		keystr = "SerNr";
		keyint = 1;
		ORr.SerNr = RepSpec.long1;
	end else begin
		keystr = "OrdDate";
		keyint = 1;
		ORr.OrdDate = RepSpec.sStartDate;
	end;
	
	startreportnoheaderjob(USetStr(31287));
	
	TrHs = true;
	while(loopkey(keystr,ORr,keyint,TrHs))begin
		qtysum = 0;
		sumpay = 0;
		ordqty = 0;
		ivsum = 0;
		ivqty = 0;
		testf = true;
		if(RepSpec.long1>-1 and RepSpec.long1!=ORr.SerNr)then begin testf = false; TrHs = false; end;
		if(keystr=="OrdDate" and ORr.OrdDate>RepSpec.sEndDate)then begin testf = false; TrHs = false; end;
		if(nonblank(RepSpec.f1) and ORr.OrderClass!=RepSpec.f1)then begin testf = false; end;
		if(nonblank(RepSpec.f2) and ORr.Location!=RepSpec.f2)then begin testf = false; end;
		if(ORr.Closed==1)then begin testf = false; end;// Edit ************************** Monday, 19 January 2015 11:17:22
		
		if(testf)then begin
			fr = ORr.FrRate;
			to1 = ORr.ToRateB1;
			if(fr<=0 or to1<=0)then begin
				fr = 1;
				to1 = 1;
			end;
			ordrate = to1/fr;
			
			if(RepSpec.flags[0]==0)then begin
				startformat(15);
					outstring(0,0,USetStr(31266),false);
					outstring(0,0,USetStr(31220),false);
					outstring(0,0,USetStr(31258),false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31267),false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31245),false);
				endformat;
			
				startformat(15);
					outstring(0,0,ORr.SerNr,false);
					outstring(0,0,ORr.OrdDate,false);
					outstring(0,0,ORr.CustCode & " " & ORr.Addr0,false);
					outstring(0,0,"",false);
					outstring(0,0,ORr.RebCode,false);
					outstring(0,0,"",false);
					outstring(0,0,ORr.Comment,false);
				endformat;
			
				startformat(15);
				endformat;
			end;
			
			if(RepSpec.flags[0]==0)then begin
				startformat(15);
					outstring(0,0,USetStr(31268),false);
					outstring(0,0,USetStr(31220),false);
					outstring(0,0,USetStr(31269),false);
					outstring(0,0,USetStr(31270),false);
					outstring(0,0,USetStr(31271),false);
					outstring(0,0,USetStr(31272),false);
					outstring(0,0,USetStr(31273),false);
				endformat;
			end;
			mtrw = matrowcnt(ORr);
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(ORr,i,ORrw);
				if(nonblank(ORrw.ArtCode))then begin
					if(RepSpec.flags[0]==0)then begin
						startformat(15);
							if(i==0)then begin
								outstring(0,0,ORr.Sum4*ordrate*rate,false);
							end else begin
								outstring(0,0,"",false);
							end;
							outstring(0,0,ORr.OrdDate,false);
							outstring(0,0,ORrw.ArtCode,false);
				
							pos = 0;
							class = "";
							model = "";
							INr.Code = ORrw.ArtCode;
							readfirstmain(INr,1,true);
							ExtractObj(INr.DispGroups,pos,class);
							while(nonblank(class))begin
								DIr.Code = class;
								readfirstmain(DIr,1,true);
								if(DIr.CType=="MODEL")then begin
									model = DIr.Name;
								end;
								ExtractObj(INr.DispGroups,pos,class);
							end;
				
							outstring(0,0,model & " " & ORrw.Spec,false);
							outstring(0,0,ORrw.Quant,false);
							outstring(0,0,ORrw.Price*ordrate*rate,false);
							outstring(0,0,ORrw.Sum*ordrate*rate,false);
						endformat;
					end;
					ordqty = ordqty + ORrw.Quant;
				end;
			end; 
			if(RepSpec.flags[0]==0)then begin
				startformat(15);
					outstring(0,0,USetStr(31222),false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,ordqty,false);
					outstring(0,0,"",false);
					outstring(0,0,ORr.Sum4*ordrate*rate,false);
				endformat;
			
				startformat(15);
				endformat;
			
				startformat(15);
					outstring(0,0,USetStr(31274),false);
					outstring(0,0,USetStr(31220),false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31239),false);
				endformat;
			end;
			IPrsr.CustCode = ORr.CustCode;
			TrHs1 = true;
			while(loopmain(IPrsr,1,TrHs1))begin
				testf1 = true;
				if(IPrsr.CustCode!=ORr.CustCode)then begin TrHs1 = false; testf1 = false; end;
				if(IPrsr.TransType!=1)then begin testf1 = false; end;
				
				if(testf1)then begin
					if(IPrsr.IVNr>-1)then begin
						IVr.SerNr = IPrsr.IVNr;
						if(readfirstmain(IVr,1,true))then begin
							if(IVr.OrderNr==ORr.SerNr)then begin
								IPr.SerNr = IPrsr.TransNr;
								if(readfirstmain(IPr,1,true))then begin
									mtrw = matrowcnt(IPr);
									For(i=0;i<mtrw;i=i+1) begin
										matrowget(IPr,i,IPrw);
										if(IPrw.CustCode==ORr.CustCode and IPrw.InvoiceNr==IPrsr.IVNr)then begin
											GetFullCurncyRate(IPrw.BankCurncy,IPrw.PayDate,fr,to1,to2,br1,br2);
											if(fr<=0 or to1<=0)then begin
												fr = 1;
												to1 = 1;
											end;
											if(RepSpec.flags[0]==0)then begin
												startformat(15);
													outstring(0,0,USetStr(31275),false);
													outstring(0,0,IPrw.PayDate,false);
													outstring(0,0,"",false);
													outstring(0,0,"",false);
													outstring(0,0,"",false);
													outstring(0,0,"",false);
													outstring(0,0,IPrw.RecVal*to1/fr*rate,false);
												endformat;
											end;
											sumpay = sumpay + IPrw.RecVal*to1/fr;
										end;
									end;
								end;
							end;
						end;
					end else begin
						IPr.SerNr = IPrsr.TransNr;
						if(readfirstmain(IPr,1,true))then begin
							mtrw = matrowcnt(IPr);
								For(i=0;i<mtrw;i=i+1) begin
									matrowget(IPr,i,IPrw);
									if(IPrw.CustCode==ORr.CustCode and IPrw.InvoiceNr<0 and IPrw.OrderNr==ORr.SerNr)then begin
										GetFullCurncyRate(IPrw.BankCurncy,IPrw.PayDate,fr,to1,to2,br1,br2);
										if(fr<=0 or to1<=0)then begin
											fr = 1;
											to1 = 1;
										end;
										if(RepSpec.flags[0]==0)then begin
										startformat(15);
											outstring(0,0,USetStr(31276),false);
											outstring(0,0,IPrw.PayDate,false);
											outstring(0,0,"",false);
											outstring(0,0,"",false);
											outstring(0,0,"",false);
											outstring(0,0,"",false);
											outstring(0,0,IPrw.RecVal*to1/fr*rate,false);
										endformat;
										end;
										sumpay = sumpay + IPrw.RecVal*to1/fr;
									end;
								end;
						end;
					end;
				end;
			end;
			resetloop(IPrsr);
			
			IVr.OrderNr = ORr.SerNr;
			TrHs1 = true;
			while(loopkey("OrderNr",IVr,1,TrHs1))begin
				testf1 = true;
				if(IVr.OrderNr!=ORr.SerNr)then begin TrHs1 = false; testf1 = false; end;
				if(IVr.OKFlag!=1)then begin testf1 = false; end;
				if(IVr.Invalid==1)then begin testf1 = false; end;
				
				if(testf1)then begin					
					mtrw = matrowcnt(IVr);
					For(i=0;i<mtrw;i=i+1) begin
	  				matrowget(IVr,i,IVrw);
	  				if(IVrw.stp==kInvoiceRowTypeCashPayment)then begin
	  					GetCurncyRoundoff(IVrw.CurncyCode,IVr.PayDeal,"IVVc",rnd,roundlines,rndvat);
	  					GetFullCurncyRate(IVrw.CurncyCode,IVr.InvDate,fr,to1,to2,br1,br2);
							if(fr<=0 or to1<=0)then begin
								fr = 1;
								to1 = 1;
							end;
							
							if(RepSpec.flags[0]==0)then begin
								startformat(15);
									outstring(0,0,USetStr(31277),false);
									outstring(0,0,IVr.InvDate,false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,round(IVrw.Sum*to1/fr*rate,rnd),false);
								endformat;
							end;
							sumpay = sumpay + round(IVrw.Sum*to1/fr,rnd);
	  				end;
	  				
	  				if(IVrw.stp==kInvoiceRowTypeLoyaltyPointsPayment)then begin
	  					GetCurncyRoundoff(IVrw.CurncyCode,IVr.PayDeal,"IVVc",rnd,roundlines,rndvat);
	  					GetFullCurncyRate(IVrw.CurncyCode,IVr.InvDate,fr,to1,to2,br1,br2);
							if(fr<=0 or to1<=0)then begin
								fr = 1;
								to1 = 1;
							end;
							
							if(RepSpec.flags[0]==0)then begin
								startformat(15);
									outstring(0,0,USetStr(31278),false);
									outstring(0,0,IVr.InvDate,false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,round(IVrw.Sum*to1/fr*rate,rnd),false);
								endformat;
							end;
							sumpay = sumpay + round(IVrw.Sum*to1/fr,rnd);
	  				end;
	  				
	  				if(IVrw.stp==kInvoiceRowTypeCreditCardPayment)then begin				
							if(RepSpec.flags[0]==0)then begin
								startformat(15);
									outstring(0,0,USetStr(31279),false);
									outstring(0,0,IVr.InvDate,false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
									outstring(0,0,IVrw.Sum*rate,false);
								endformat;
							end;
							sumpay = sumpay + IVrw.Sum;
	  				end;
	  				
					end; 
				end;
			end;
			resetloop(IVr);
			
			if(RepSpec.flags[0]==0)then begin
				startformat(15);
					outstring(0,0,USetStr(31222),false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,sumpay*rate,false);
				endformat;
			
				startformat(15);
				endformat;
				startformat(15);
					outstring(0,0,USetStr(31280),false);
					outstring(0,0,USetStr(31220),false);
					outstring(0,0,USetStr(31203),false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31238),false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31239),false);
				endformat;
			end;

			IVr.OrderNr = ORr.SerNr;
			TrHs1 = true;
			while(loopkey("OrderNr",IVr,1,TrHs1))begin
				testf1 = true;
				if(IVr.OrderNr!=ORr.SerNr)then begin TrHs1 = false; testf1 = false; end;
				if(IVr.OKFlag!=1)then begin testf1 = false; end;
				if(IVr.Invalid==1)then begin testf1 = false; end;
				
				
				if(testf1)then begin
					fr = IVr.FrRate;
					to1 = IVr.ToRateB1;
					if(fr<=0 or to1<=0)then begin
						fr = 1;
						to1 = 1;
					end;
					ivrate = to1/fr;
					
					mtrw = matrowcnt(IVr);
					For(i=0;i<mtrw;i=i+1) begin
	  				matrowget(IVr,i,IVrw);
	  				if(IVrw.stp==kInvoiceRowTypeNormal)then begin
	  					if(RepSpec.flags[0]==0)then begin
								startformat(15);
									outstring(0,0,"",false);
									outstring(0,0,IVr.TransDate,false);
									outstring(0,0,IVrw.ArtCode,false);
									outstring(0,0,"",false);
									outstring(0,0,IVrw.Quant,false);
									outstring(0,0,"",false);
									outstring(0,0,IVrw.Sum*ivrate*rate,false);
								endformat;
							end;
							ivsum = ivsum + IVrw.Sum*ivrate;
							ivqty = ivqty + IVrw.Quant;
	  				end;
					end; 
				end;
			end;
			resetloop(IVr);
			if(RepSpec.flags[0]==0)then begin
				startformat(15);
					outstring(0,0,USetStr(31222),false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,ivqty,false);
					outstring(0,0,"",false);
					outstring(0,0,ivsum*rate,false);
				endformat;
				startformat(15);
				endformat;
				startformat(15);
					outstring(0,0,USetStr(31281),false);
					outstring(0,0,USetStr(31220),false);
					outstring(0,0,USetStr(31203),false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31238),false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
				endformat;
			end;

			qtysum = 0;
			SHr.OrderNr = ORr.SerNr;
			TrHs1 = true;
			while(loopkey("OrderKey",SHr,1,TrHs1))begin
				testf1 = true;
				if(SHr.OrderNr!=ORr.SerNr)then begin TrHs1 = false; testf1 = false; end;
				if(SHr.OKFlag!=1)then begin testf1 = false; end;			
				
				if(testf1)then begin
					mtrw = matrowcnt(SHr);
					For(i=0;i<mtrw;i=i+1) begin
	  				matrowget(SHr,i,SHrw);
	  				Retr.SHNr = SHr.SerNr;
	  				retTrHs = true;
	  				while(loopkey("SHNr",Retr,1,retTrHs))begin
	  					rettestf = true;
	  					if(Retr.SHNr!=SHr.SerNr)then begin retTrHs = false; rettestf = false; end;
	  					if(Retr.OKFlag==0)then begin rettestf = false; end;
	  					if(Retr.Invalid==1)then begin rettestf = false; end;
	  					
	  					if(rettestf)then begin
	  						retmtrw = matrowcnt(Retr);
	  						For(reti=0;reti<retmtrw;reti=reti+1) begin
	  							matrowget(Retr,reti,Retrw);
	  							if(Retrw.SHRow==i and Retrw.ArtCode==SHrw.ArtCode)then begin
	  								SHrw.Ship = SHrw.Ship - Retrw.Quant;
	  							end;
								end; 
	  					end;
	  				end;
	  				resetloop(Retr);
	  				if(SHrw.Ship!=0)then begin
							if(RepSpec.flags[0]==0)then begin
								startformat(15);
									outstring(0,0,"",false);
									outstring(0,0,SHr.ShipDate,false);
									outstring(0,0,SHrw.ArtCode,false);
									outstring(0,0,"",false);
									outstring(0,0,SHrw.Ship,false);
									outstring(0,0,"",false);
									outstring(0,0,"",false);
								endformat;
							end;
							qtysum = qtysum + SHrw.Ship;
						end;
					end; 
				end;
			end;
			resetloop(SHr);
			
			if(RepSpec.flags[0]==0)then begin
				startformat(15);
					outstring(0,0,USetStr(31222),false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,qtysum,false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
				endformat;
			
				startformat(15);
				endformat;
			
				startformat(15);
				outstring(0,0,USetStr(31282),false);
				endformat;
			
				startformat(15);
				outstring(0,0,USetStr(31283),false);
				outstring(0,0,ordqty - qtysum,false);
				endformat;
			
				startformat(15);
				outstring(0,0,USetStr(31284),false);
				outstring(0,0,ORr.Sum4*ordrate*rate - sumpay*rate,false);
				endformat;
			
				startformat(15);
				outstring(0,0,USetStr(31285),false);
				outstring(0,0,ordqty - ivqty,false);
				endformat;
			
				startformat(15);
				outstring(0,0,USetStr(31286),false);
				outstring(0,0,ORr.Sum4*ordrate*rate - ivsum*rate,false);
				endformat;
			
				startformat(15);
				endformat;
				startformat(15);
				endformat;
			end;
			
			if(RepSpec.flags[0]==1 and (ORr.Sum4*ordrate*rate - sumpay*rate)==0 and (ordqty - qtysum)==0 and (ordqty - ivqty)==0)then begin
				PrintInfo(ORr);
			end;
			if(RepSpec.flags[0]==2 and ((ORr.Sum4*ordrate*rate - sumpay*rate)!=0 or (ordqty - qtysum)!=0 or (ordqty - ivqty)!=0))then begin
				PrintInfo(ORr);
			end;
			
		end;
	end;
	endjob;
return;
end;


global procedure OrderStatusDeliverRn(record RcVc RepSpec)
begin
	integer i,j,mtrw;
	record IVVc IVr;
	row IVVc IVrw;
	record SHVc SHr;
	row SHVc SHrw;
	boolean TrHs, testf;
	string 50 keystr,class,model,brand;
	record DIVc DIr;
	integer keyint,pos;
	record ORVc ORr;
	row ORVc ORrw;
	record INVc INr;
	val qtysum,sumpay,ordqty,ivsum,ivqty;
	record IPrsVc IPrsr;
	record IPVc IPr;
	row IPVc IPrw;
	boolean TrHs1,testf1,TrHs2;
	val ordrate,ivrate;
	val fr,to1,to2,br1,br2;
	array string 100 abrand,avendor;
	integer acnt,plandays;
	boolean findar,testf3;
	record POVc POr;
	row POVc POrw;
	string 255 Comment;
	record CUVc CUr;
	integer days1,days2,days3,days4,days5,days6,days7,daysall;
	date podate,prepaydate,podonedate,balancedate,pudate,shipdate;
	record VIVc VIr;
	record OPRsVc OPrsr;
	record OPVc OPr;
	row OPVc OPrw;
	longint posernr;
	record PUVc PUr;
	record ItemHistVc IHr;
	record StockMovVc SMr;
	record LocationVc Locationr;
	
	if(RepSpec.long1>-1)then begin
		keystr = "SerNr";
		keyint = 1;
		ORr.SerNr = RepSpec.long1;
	end else begin
		keystr = "OrdDate";
		keyint = 1;
		ORr.OrdDate = RepSpec.sStartDate;
	end;
	
	startreportnoheaderjob(USetStr(31287));
	
	TrHs = true;
	while(loopkey(keystr,ORr,keyint,TrHs))begin
		qtysum = 0;
		sumpay = 0;
		ordqty = 0;
		ivsum = 0;
		ivqty = 0;
		plandays = 0;
		testf = true;
		if(RepSpec.long1>-1 and RepSpec.long1!=ORr.SerNr)then begin testf = false; TrHs = false; end;
		if(keystr=="OrdDate" and ORr.OrdDate>RepSpec.sEndDate)then begin testf = false; TrHs = false; end;
		if(blank(ORr.OrderClass))then begin testf = false; end;
		if(nonblank(RepSpec.f1) and ORr.OrderClass!=RepSpec.f1)then begin testf = false; end;
		
		if(testf)then begin
			fr = ORr.FrRate;
			to1 = ORr.ToRateB1;
			if(fr<=0 or to1<=0)then begin
				fr = 1;
				to1 = 1;
			end;
			ordrate = to1/fr;
			
			startformat(15);
				outstring(0,0,USetStr(31288),false);
				outstring(20,0,USetStr(31289),false);
				outstring(40,0,USetStr(31290),false);
				outstring(60,0,USetStr(31291),false);
				outstring(80,0,USetStr(31292),false);
				outstring(100,0,USetStr(31293),false);
				outstring(120,0,USetStr(31294),false);
				outstring(140,0,USetStr(31294),false);
				outstring(160,0,USetStr(31295),false);
				outstring(180,0,USetStr(31296),false);
				outstring(200,0,USetStr(31297),false);
				outstring(220,0,USetStr(31298),false);
				outstring(240,0,USetStr(31299),false);
				outstring(260,0,USetStr(31300),false);
				outstring(280,0,USetStr(31301),false);
				outstring(300,0,USetStr(31302),false);
				outstring(320,0,USetStr(31303),false);
			endformat;
			startformat(15);
				outstring(0,0,"",false);
				outstring(20,0,"",false);
				outstring(40,0,"",false);
				outstring(60,0,"",false);
				outstring(80,0,"",false);
				outstring(100,0,"",false);
				outstring(120,0,USetStr(31304),false);
				outstring(140,0,USetStr(31305),false);
				outstring(160,0,"",false);
				outstring(180,0,"+",false);
				outstring(200,0,"",false);
				outstring(220,0,"+",false);
				outstring(2400,0,"+",false);
				outstring(260,0,"+",false);
				outstring(280,0,"",false);
				outstring(300,0,"+",false);
				outstring(320,0,"",false);
			endformat;
			
			
			mtrw = matrowcnt(ORr);
			acnt = 0;
			For(i=0;i<mtrw;i=i+1) begin
				matrowget(ORr,i,ORrw);
				if(nonblank(ORrw.ArtCode))then begin
					pos = 0;
					class = "";
					model = "";
					brand = "";
					INr.Code = ORrw.ArtCode;
					readfirstmain(INr,1,true);
					ExtractObj(INr.DispGroups,pos,class);
					while(nonblank(class))begin
						DIr.Code = class;
						readfirstmain(DIr,1,true);
						if(DIr.CType=="MODEL")then begin
							model = DIr.Name;
						end;
						if(DIr.CType=="BRAND")then begin
							brand = DIr.Name;
						end;
						ExtractObj(INr.DispGroups,pos,class);
					end;
					findar = true;
					For(j=0;j<acnt;j=j+1) begin
	  				if(abrand[j]==brand)then begin
	  					findar = false;
	  				end;
					end; 
					if(findar)then begin
						abrand[acnt]=brand;
						CUr.Name = brand;
						if(readfirstkey("Name",CUr,1,true))then begin
							avendor[acnt] = CUr.Code;
						end;
						acnt = acnt + 1;
					end;
				end else begin
					brand = USetStr(31265);
					findar = true;
					For(j=0;j<acnt;j=j+1) begin
	  				if(abrand[j]==brand)then begin
	  					findar = false;
	  				end;
					end;
					if(findar)then begin
						abrand[acnt]=brand;
						CUr.Name = brand;
						if(readfirstkey("Name",CUr,1,true))then begin
							avendor[acnt] = CUr.Code;
						end else begin
							avendor[acnt] = USetStr(31365);
						end;
						acnt = acnt + 1;
					end;
					
				end;
			end; 
			
			For(i=0;i<acnt;i=i+1) begin
				days1 = 0;
				days2 = 0;
				days3 = 0;
				days4 = 0;
				days5 = 0;
				days6 = 0;
				days7 = 0;
				daysall = 0;
				plandays = 0;
				Comment = "";
				POr.InvAddr4 = ORr.OrderClass & ORr.SerNr;
				TrHs1 = true;
				
				podate = "";
				posernr = -1;
				podonedate = "";
				while(loopkey("InvAddr4",POr,1,TrHs1))begin
					testf3 = true;
					if(POr.InvAddr4!=ORr.OrderClass & ORr.SerNr)then begin TrHs1 = false; testf3 = false; end;
					if(POr.VECode!=avendor[i])then begin testf3 = false; end;
					
					if(testf3)then begin
						Comment = POr.Comment;
						posernr = POr.SerNr;
						if(nonblank(podate))then begin
							if(podate<POr.OKDate)then begin
								podate = POr.OKDate;
								if(POr.OrderDoneFlag==1)then begin
									if(podonedate<POr.OrderDoneDate)then begin
										podonedate = POr.OrderDoneDate;
									end;
								end;
							end;
						end else begin
							podate = POr.OKDate;
							if(POr.OrderDoneFlag==1)then begin
								podonedate = POr.OrderDoneDate;
							end;
						end;
					end;
					if(blank(podate))then begin
						//podate = currentdate;
					end;
				end;
				resetloop(POr);
				
				
					
				if(ORr.OKFlag==0)then begin
					ORr.OKDate = CurrentDate;
				end;
				if(blank(ORr.OKDate))then begin
					ORr.OKDate = currentdate;
				end;
				days1 = 2-datediff(ORr.OKDate,ORr.OrdDate);
				daysall = daysall + days1;
				if(ORr.OKFlag==1)then begin
					if(nonblank(podate))then begin
						days2 = 5-datediff(podate,ORr.OKDate);
					end;
				end;
				
				
				OPrsr.VECode = avendor[i];
				OPrsr.TransType = 1;
				TrHs1 = true;
				prepaydate = "";
				while(loopkey("TransType",OPrsr,2,TrHs1))begin
					if(OPrsr.VECode!=avendor[i])then begin TrHs1 = false; end;
					if(OPrsr.TransType!=1)then begin TrHs1 = false; end;
					
					if(TrHs1)then begin
						OPr.SerNr = OPrsr.TransNr;
						readfirstmain(OPr,1,true);
						mtrw = matrowcnt(OPr);
						For(j=0;j<mtrw;j=j+1) begin
							matrowget(OPr,j,OPrw);
							if(OPrw.OrderNr==posernr and posernr>-1)then begin
								prepaydate = OPr.PayDate;
							end;
						end; 
					end;
				end;
				resetloop(OPrsr);
				if(nonblank(podate))then begin
					days3 = datediff(prepaydate,podate);
					days3 = days2 - days3;
				end;
				daysall = daysall + days3;
				
				CUr.Code = avendor[i];
				readfirstmain(CUr,1,true);
				plandays = CUr.PlanShipDays + 27;
				if(nonblank(podonedate))then begin
					if(nonblank(prepaydate))then begin
						days4 = CUr.PlanShipDays-datediff(podonedate,prepaydate);
					end else begin
						days4 = CUr.PlanShipDays-datediff(podonedate,podate);
					end;
				end else begin
					if(nonblank(prepaydate))then begin
						days4 = CUr.PlanShipDays-datediff(currentdate,prepaydate);
					end else begin
						days4 = blankval;
					end;
				end;
				daysall = daysall + days4;
				
				balancedate = "";
				VIr.POSerNr = posernr;
				TrHs1 = true;
				while(loopkey("POSerNr",VIr,1,TrHs1))begin
					if(VIr.POSerNr!=posernr)then begin TrHs1=false; end;
					
					if(TrHs1)then begin
						OPrsr.VINr = VIr.SerNr;
						OPrsr.TransType = 1;
						TrHs2 = true;
						while(loopkey("VIKey",OPrsr,2,TrHs2))begin
							if(OPrsr.VINr!=VIr.SerNr or OPrsr.TransType!=1)then begin TrHs2 = false; end;
							
							if(TrHs2)then begin
								balancedate = OPrsr.TransDate;
							end;
						end;
						resetloop(OPrsr);
					end;
				end;
				resetloop(VIr);
				if(nonblank(balancedate))then begin
					days5 = -datediff(balancedate,podonedate);
					daysall = daysall + days5;
				end;
				
				pudate = "";
				PUr.PONr = posernr;
				TrHs1 = true;
				if(posernr>-1)then begin
					while(loopkey("PONr",PUr,1,TrHs1))begin
						testf1 = true;
						if(PUr.PONr!=posernr)then begin TrHs1=false; testf1=false; end;
						if(PUr.OKFlag==0)then begin testf1 = false; end;
					
						if(testf1)then begin
							pudate = PUr.TransDate;
						end;
					end;
					resetloop(PUr);
				end;
				
				if(nonblank(pudate))then begin
					if(nonblank(podonedate))then begin
						if(nonblank(balancedate))then begin
							if(balancedate<podonedate)then begin
								days6 = 19 - datediff(pudate,podonedate);
							end else begin
								days6 = 19 - datediff(pudate,balancedate);
							end;
						end else begin
							if(nonblank(podonedate))then begin
								days6 = 19 - datediff(pudate,podonedate);
							end;
						end;
					end;
				end else begin
					if(nonblank(podonedate))then begin
						if(nonblank(balancedate))then begin
							if(balancedate<podonedate)then begin
								days6 = 19 - datediff(pudate,podonedate);
							end else begin
								days6 = 19 - datediff(pudate,balancedate);
							end;
						end else begin
							if(nonblank(podonedate))then begin
								days6 = 19 - datediff(currentdate,podonedate);
							end;
						end;
					end;
				end;
				
				shipdate = "";
				IHr.SerialNr = ORr.OrderClass & ORr.SerNr;
				TrHs1 = true;
				while(loopbackkey("SerialNr",IHr,1,TrHs1))begin
					testf3 = true;
					if(IHr.SerialNr!=ORr.OrderClass & ORr.SerNr)then begin TrHs1 = false; testf3 = false; end;
					if(IHr.FileName!="StockMovVc" and IHr.FileName!="PUVc")then begin testf3 = false; end; 
					if(IHr.Qty<=0)then begin testf3 = false; end;
					INr.Code = IHr.ArtCode;
					readfirstmain(INr,1,true);
					pos = 0;
					brand = "";
					ExtractObj(INr.DispGroups,pos,class);
					while(nonblank(class))begin
						DIr.Code = class;
						readfirstmain(DIr,1,true);
						if(DIr.CType=="BRAND")then begin
							brand = DIr.Name;
						end;
						ExtractObj(INr.DispGroups,pos,class);
					end;
					if(nonblank(brand))then begin
						CUr.Name = brand;
						if(readfirstkey("Name",CUr,1,true))then begin
							if(CUr.Code!=avendor[i])then begin
								testf3 = false;
							end;
						end;
					end;
					
					
					if(testf3)then begin
							Locationr.Code = IHr.Location;
							readfirstmain(Locationr,1,true);
							if(Locationr.Group=="BAKU")then begin
								shipdate = IHr.TransDate;
								TrHs1 = false;
								testf3 = false;
							end;
					end;
				end;
				resetloop(IHr);

				if(nonblank(pudate))then begin
					if(nonblank(shipdate))then begin
						if(nonblank(pudate))then begin
							days7 = days6 - datediff(shipdate,pudate);
						end else begin
							days7 = days6 - datediff(shipdate,podonedate);
						end;
					end else begin
						if(nonblank(pudate))then begin
							days7 = days6 - datediff(currentdate,pudate);
						end;
					end;
					daysall = daysall + days7;
				end;
					
				startformat(15);
					outstring(0,0,ORr.OrderClass & ORr.SerNr,false);
					outstring(20,0,abrand[i],false);
					outstring(40,0,ORr.SalesMan,false);
					outstring(60,0,ORr.Addr0,false);
					outstring(80,0,ORr.Comment,false);
					outstring(100,0,ORr.OrdDate,false);
					outstring(120,0,ORr.PlanShip,false);	
					outstring(140,0,shipdate,false);
					//outstring(160,0,daysall,false);
					outstring(160,0,plandays,false);
					outstring(180,0,days1,false);
					outstring(200,0,days2,false);
					outstring(220,0,days3,false);
					outstring(240,0,days4,false);
					outstring(260,0,days5,false);
					outstring(280,0,days6,false);
					outstring(300,0,days7,false);
					outstring(320,0,daysall,false);
				endformat;
			end; 
			
			startformat(15);
			endformat;
			startformat(15);
			endformat;
			
		end;
	end;
	endjob;
return;
end;