external function Boolean GSXAutoEnrollment(string,record IVVc,Integer,var string);
external function boolean GSXWarrantyStatus(string,string,date,array string,integer,var record SVOSerVc,var record NotepadVc,var record NotepadVc,var string);
external updating function boolean GSXLogin(string,string,string,var string,var string);
external function Integer CountObjects(string);
remote function Integer CancelApprovalRequestAllowed(Integer,string,string,Integer,string);
external function string 255 POSCommandText(Integer,Boolean);
remote procedure SeparateVATIVForNoVAT(var record VATIVVc,var record VATIVVc);
remote function Boolean TestSeparateVATIVFromIVForNoVAT(record IVVc);
external function Integer OpenArtStat(Integer,record RcVc,Boolean);
external procedure OpenCCPayIngenicoOClass(Integer,string,string,LongInt,val,val,string);
external procedure OpenCCPayYomaniBanksysOClass(Integer,string,string,LongInt,val,val,string);
remote function Integer SendForAcceptance_IVVc(var record IVVc,var record RcVc);
external function LongInt IVDefaultsClient(var record IVVc,record IVVc,LongInt,LongInt);
external function Integer TestAcceptanceStatus(Integer);
external function Boolean FindLocalSerialPortDevice(Integer,LongInt,string,var record LSerialPortDeviceVc);
external updating function Boolean IVVc_PrintToFiscalControlUnit(var record IVVc);
external function Integer TestVATIVCorrectionAllowed(record IVVc);
external function Boolean GetWHTaxRow(string,var row WHTaxBlock);
external function Boolean IVPrintReceipt(Integer,var record IVVc,var record IVVc,Integer,Boolean,Boolean,Integer,Integer);
external updating procedure IVVc_PrintToFiscalPrinter(var record IVVc,Boolean);
remote function Integer IVVc_CalcRetentionLine(var record IVVc,var val,var string,var string);
remote function Integer VIVc_CalcRetentionLine(var record IVVc,var val,var string,var string);
external function roundmode DefaultRoundMode();
external procedure OpenCashDrawer_IVVc(record IVVc);
remote procedure RestPMOtherPayRemote_RestAcc(var record RestAccVc,string,Integer);
remote procedure RestPMOtherPayRemote_IV(var record IVVc,string,Integer);
external procedure SubCashRows_IVVc(record IVVc,Boolean,var val,var val);
external procedure OpenCCPayRahaxiDClass(Integer,Integer,LongInt,val,val,string);
external procedure OpenCCPaySteriaDClass(Integer,Integer,LongInt,val,val,string);
external procedure RecalcIVSubtotal(var record IVVc);
remote updating function Integer RecordAction_raPasteInvInCOCUService(var record COCUServiceVc,var record IVVc,var record IVVc);
external procedure IVDchsum(var record IVVc,Integer);
external function Boolean IVDchrsum(var record IVVc,Integer);
remote function Integer CreateCreditNoteIV(record IVVc,Integer,var record IVVc,string,Boolean);
remote function Boolean CreateCredManIV(var record CredManVc,Boolean);
remote procedure ChequeIVsmRemote(var record IVVc,string,Integer);
remote procedure CashIVsmRemote(var record IVVc,string,Integer);
remote function Boolean AddRepaLine(var record IVVc,Boolean,Integer,var val);
external function Boolean TouchScreenLook();
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
remote updating function LongInt RecordAction_raPasteIVInFEIV(var record FEIVVc,LongInt);
remote updating function Integer UpdateTRVATIV(record IVVc,var record VATIVVc,Integer);
remote procedure RecalcDiscountIVD(var record IVVc);
remote procedure RecalculetWeightVolumeIVVc(var record IVVc,Boolean);
remote procedure IVDUpdatePrices(var record IVVc,Boolean);
remote updating procedure RraPasteInvInEDIInv(var record EDIIVVc,var LongInt);
remote updating function Integer RecordAction_raPasteInvInCO(var record COVc,var record IVVc);
external procedure RecordActionIV_Print(var record IVVc,string,string,Integer,Boolean);
external procedure RecActionIV_rlCashInOutDPrint(var record IVVc);
remote procedure GetFullCurncyRate(var string,Date,var val,var val,var val,var val,var val);
external procedure SendArtStat(string,string,string,val,val,val,Date,Integer);
external procedure CalcProc(val,val,var val);
external procedure FindSalesExVat(record TaxMatrixVc,string,val,Integer,Integer,var val);
external procedure GetRecepy(string,var string);
remote procedure IVSumup(var record IVVc,Boolean);
external procedure DisplayIVSubTotalAction(record IVVc);
remote function Boolean DoCLInFromIVDRemote(record IVVc,var record CLInVc);
remote function Boolean ReadFirstItem(string,var record INVc,Boolean,Boolean);
remote function Boolean GetItemPriceDiscount3(string,val,var record INVc,string,val,val,val,val,val,string,string,string,string,
                                                var val,var string,var val,var string,var val,var string,Integer,var Boolean,Date,Time,
                                                string,Boolean,var Boolean,string,var string,var val,string,string,var string);
external updating function Boolean CCPayIVDWithCardDataAndPM(Integer,string,Integer,string);
remote procedure FindReItems(string, date,var array string,var integer);
remote function Boolean IVVc_PasteArtCode(var record IVVc,Integer,var string,var string,Boolean,var Integer);
remote function Boolean IVVc_PasteSum(var record IVVc,Integer,var Boolean,Integer);
external procedure IVDClass_RefreshStringList(Integer,record IVVc);
external function Boolean IVDClassvRebateEFAfter(Integer,Integer,Integer,Integer);
remote updating procedure CreatePOfromOR(record ORVc);// Edit ************************** Thursday, 12 September 2013 09:21:48
remote function boolean CheckPOFromOR(record ORVc);// Edit ************************** Thursday, 12 September 2013 14:45:12
remote procedure FindReItemsMatrix(var record SHVc); //Edit***************************Sasha2,12:58 19.05.2016
external function val AbsoluteVal(val);

//SetLangMode(LangRussian,"RUS",0);

global //Edit***************************Sasha2,16:52 06.05.2015 {
procedure DblOpenMainRep(string dblstr,string l,Integer currepwn)
begin
	record RcVc RepSpec,RcVcr1;
	integer wn;
	
		getwindowrecord(currepwn,RcVcr1);

		ReportDefaults(RepSpec,"MainRClass");   
		wn = curwindow;
		
		RepSpec.sStartDate = RcVcr1.sStartDate;
		RepSpec.sEndDate = RcVcr1.sEndDate;
		RepSpec.Period2Str = RcVcr1.sStartDate & ":" & RcVcr1.sEndDate;
		RepSpec.f4 = RcVcr1.f4;
		RepSpec.ObjStr = dblstr & "," & RcVcr1.ObjStr;
		RepSpec.Media = mtScreen;
		RepSpec.flags[21] = 1;
		RepSpec.flags[22] = 1;
		RepSpec.flags[7] = 2;
    RepSpec.repname = "MainRn";
    
    RunReport(RepSpec,0); 
  
  return;
end; //Edit***************************Sasha2,16:52 06.05.2015 }


global procedure FindLoyaltyCardRemote(string lcard,var record LoyaltyCardVc LoyaltyCardr,var boolean findf)
begin
	record LoyaltyCardVc LoyaltyCardrold;
	
	LoyaltyCardrold.SerNr =lcard;
	if(ReadFirstMain(LoyaltyCardrold,1,true)) then begin
		recordCopy(LoyaltyCardr,LoyaltyCardrold);	
		findf=true;	
	end;

end; 
return;


procedure getVarsFromString(string in,var array string out,var integer cnt)
begin
  integer lenth,i,oldi,k;
    
    k=0;
    oldi=0;
    lenth = len(in);
    for(i=0;i<lenth;i=i+1)begin
      if(mid(in,i,1)==chr(9))then begin
        out[k] = mid(in,oldi,i-oldi);
        oldi=i+1;
        k=k+1;
      end;
    end;
    cnt = k+1;
return;
end;

global procedure PasteRetItems()
begin
integer wn,i,mtrw,mwn,cnt,length,rn;
record IVVc IVr,IV2r; //Edit***************************Sasha2,13:56 03.07.2015
row IVVc IVrw,IV2rw; //Edit***************************Sasha2,13:59 03.07.2015
record SHVc SHr;
row SHVc SHrw;
string 100 artcode,art;
val price,rebate,sum,qty;
array string 100 params;
string 255 inwarning,warning;
Integer sernrf,k;
Boolean chsum;
string 20 tstr,transnr,rowstr; 

  wn = curwindow;
  mwn = motherwindow(wn);
  getwindowrecord(mwn,IVr);
  if(IVr.OKFlag==0 and IVr.Invalid==0)then begin
    
    rn = WindowActiveRow(wn);
    if (rn>-1) then begin
      getwindowrecord(wn,SHr);
      MatRowGet(SHr,rn,SHrw);
      
      mtrw = matrowcnt(IVr);
      ClearRow(IVr,IVrw,1);
      IVrw.ArtCode = SHrw.ArtCode;
      matrowput(IVr,mtrw,IVrw);
      IVVc_PasteArtCode(IVr,mtrw,inwarning,warning,false,sernrf);
      matrowget(IVr,mtrw,IVrw);
      IVrw.Quant = -AbsoluteVal(SHrw.Ship);
      IVrw.Price = SHrw.BasePrice;
      
      IVrw.Sum = -AbsoluteVal(SHrw.TAX2Reb);
      matrowput(IVr,mtrw,IVrw);
      IVVc_PasteSum(IVr,mtrw,chsum,1);
      
      matrowget(IVr,mtrw,IVrw);
      IVrw.vRebate = evaltoval(mid(SHrw.PosCode,0,len(SHrw.PosCode)-1));
      matrowput(IVr,mtrw,IVrw);
      
      matrowget(IVr,mtrw,IVrw);
      IVrw.FIFO = AbsoluteVal(SHrw.FIFO/SHrw.Ship);
      IVrw.FIFORowVal = SHrw.FIFO;
      IVrw.FIFOCur = AbsoluteVal(SHrw.FIFORowVal/SHrw.Ship);
      IVrw.FIFORowValCur = SHrw.FIFORowVal;
      IVrw.CurncyCodeCur = SHrw.TAX2Code;
      IVrw.IVForRetNr = SHrw.OrdRow;
      IVrw.RetFromComp = SHrw.Source;
      matrowput(IVr,mtrw,IVrw);
      
      putwindowrecord(mwn,IVr);
      updatebrowses(mwn);
      IVDClass_RefreshStringList(mwn,IVr);
    end;
    
    /*artcode = getliststring(wn,selectedlistline(wn));
    mtrw = matrowcnt(IVr);
    getVarsFromString(artcode,params,cnt);
    k=0;
    if(currentcompany>1)then begin k = 1; end;
    art = params[0];
    qty = evaltoval(params[1+k]);
    price = evaltoval(params[2+k]);
    rebate = evaltoval(mid(params[3+k],0,len(params[3+k])-1));
    sum = evaltoval(params[4+k]);
    transnr = params[8+k];
    length = len(transnr); //Edit***************************Sasha2,13:51 03.07.2015 {
    for (i=0;i<length;i=i+1) begin
      if (mid(transnr,i,1)==chr(35)) then begin
        transnr = mid(transnr,i+1,length-i-1);
        i = length;
      end;
    end; //Edit***************************Sasha2,13:51 03.07.2015 }
    rowstr = params[9+k];
    
    IV2r.SerNr = StringToLongInt(transnr);
    ReadFirstMain(IV2r,1,true);
    MatRowGet(IV2r,StringToInt(rowstr),IV2rw);
    
    IVrw.ArtCode = art;
    matrowput(IVr,mtrw,IVrw);
    IVVc_PasteArtCode(IVr,mtrw,inwarning,warning,false,sernrf);
    matrowget(IVr,mtrw,IVrw);
    IVrw.Quant = -qty;
    IVrw.Price = price;
    
    IVrw.Sum = -sum;
    matrowput(IVr,mtrw,IVrw);
    IVVc_PasteSum(IVr,mtrw,chsum,1);
    
    matrowget(IVr,mtrw,IVrw);
    IVrw.vRebate = rebate;
    matrowput(IVr,mtrw,IVrw);
    
    matrowget(IVr,mtrw,IVrw); //Edit***************************Sasha2,14:13 03.07.2015 {
    IVrw.FIFO = IV2rw.FIFO;
    matrowput(IVr,mtrw,IVrw); //Edit***************************Sasha2,14:13 03.07.2015 }
    
    putwindowrecord(mwn,IVr);
    updatebrowses(mwn);
    
    IVDClass_RefreshStringList(mwn,IVr);*/
    
  end;
  
return;
end;

global procedure PasteRetItemIVDsm()
begin
integer wn,i,mtrw,nwn,rownr;
record IVVc IVr;
row IVVc IVrw;
record SHVc SHr;
record RcVc RepSpec;

  recordNew(SHr);
  
  wn = curwindow;
  getwindowrecord(wn,IVr);
  deselectwindow(wn,false);
  SHr.PRCode = wn;
  rownr = GetWindowCurRow(wn);
  if (rownr>=0) then begin
    matrowget(IVr,rownr,IVrw);
    if(nonblank(IVrw.ArtCode))then begin
      SHr.DelAddrCode = IVrw.ArtCode;
    end;
  end;
  
  nwn = OpenWindow("PasteRetItemTClass",0,wn,"","",SHr);
  putwindowrecord(nwn,SHr);
  //selectwindow(nwn);
  
return;
end;


global procedure PasteSpecialRebateItemIVDsm()
begin
integer wn,i,mtrw,nwn,rownr;
record IVVc IVr;
row IVVc IVrw;
record RcVc RepSpec;
	  
  wn = curwindow;
  getwindowrecord(wn,IVr);
  if(IVr.OKFlag==0 and IVr.Invalid==0)then begin
		//deselectwindow(wn,false);
		rownr = SelectedListLine(wn);
		if (rownr>=0) then begin
			matrowget(IVr,rownr,IVrw);
			if(nonblank(IVrw.ArtCode))then begin
				if(IVrw.vRebate<20)then begin
					IVrw.vRebate = 20;
					matrowput(IVr,rownr,IVrw);
					IVSumup(IVr,true);
					putwindowrecord(wn,IVr);
					IVDClassvRebateEFAfter(wn,0,rownr,1);
					getwindowrecord(wn,IVr);
					IVDClass_RefreshStringList(wn,IVr);
				end;
			end;
		end;
  end;
  
  
return;
end;

global procedure SearchRetItems()
begin
integer wn;
record RcVc RepSpec;
record SHVc SHr;
row SHVc SHrw;
integer counter,i;
array string 100 artcodes;
 
  
  wn = curwindow;
  deselectwindow(wn,false);
  getwindowrecord(wn,SHr); 
  
  if(currentcompany!=1)then begin
  	SHr.ShipDate = addyear(currentdate,-2);
  end;
  if(nonblank(SHr.DelAddrCode) and nonblank(SHr.ShipDate))then begin
    FindReItemsMatrix(SHr);
    if(MatRowCnt(SHr)>0)then begin
      putwindowrecord(wn,SHr);
    end;
  end else begin
    //messagebox(0,"Beda!!!!");
  end;
  selectwindow(wn);
  
  /*wn = curwindow;
  deselectwindow(wn,false);
  getwindowrecord(wn,RepSpec); //Edit***************************Sasha2,16:21 20.05.2015
  
  ClearStringList(wn);
  
  if(currentcompany!=1)then begin
  	RepSpec.sStartDate = addyear(currentdate,-2);// Edit ************************** Wednesday, 13 May 2015 16:24:17
  end;
  if(nonblank(RepSpec.ObjStr) and nonblank(RepSpec.sStartDate))then begin
    FindReItems(RepSpec.ObjStr,RepSpec.sStartDate,artcodes,counter);

    if(counter>0)then begin
      for(i=0;i<counter;i=i+1) begin
        SetListString(wn,60,artcodes[i],false);
      end;
  
      putwindowrecord(wn,RepSpec);
    end;
  end else begin
    //messagebox(0,"Beda!!!!");
  end;
  selectwindow(wn);*/
  
return;
end;

global
procedure MgrsDiscOverrideIVDsm()
BEGIN
  Integer wn,nwn,mwn;
  record RcVc RepSpec;
  record IVVc IVr;
  row IVVc IVrw;
  Integer rownr;
  
  wn = CurWindow;
  GetWindowRecord(wn,IVr);
  rownr = WindowActiveRow(wn);
  if (rownr>=0) then begin
    MatRowGet(IVr,WindowActiveRow(wn),IVrw);
    RepSpec.f1 = IVrw.ArtCode;
    RepSpec.AccStr = "";
    RepSpec.FirstAcc = "";
    RepSpec.long1 = WindowActiveRow(wn);
    nwn = OpenWindow("MgrsDiscOverrideOClass",0,wn,"","",RepSpec);
  end else begin
    MessageBox(0,USetStr(22057));
  end;
  RETURN;
END;

global
procedure MgrsDiscOverrideIVCashDsm()
begin
  Integer wn,nwn,mwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  Integer rownr;
  
  wn = CurWindow;
  GetWindowRecord(wn,IVCashr);
  rownr = WindowActiveRow(wn);
  if (rownr>=0) then begin
    MatRowGet(IVCashr,WindowActiveRow(wn),IVCashrw);
    RepSpec.f1 = IVCashrw.ArtCode;
    RepSpec.AccStr = "";
    RepSpec.FirstAcc = "";
    RepSpec.long1 = WindowActiveRow(wn);
    nwn = OpenWindow("MgrsDiscOverrideOClass",0,wn,"","",RepSpec);
  end else begin
    MessageBox(0,USetStr(22057));
  end;
  return;
end;

global
updating function Boolean MgrsDiscOverrideOClassOnOKWindow(Integer wn)
begin
  Boolean closef,testf,dummyf;
  record RcVc RepSpec;
  record IVVc IVr;
  row IVVc IVrw;
  record UserVc Userr;
  integer rwcnt,mwn;
  val price,discountprice,t;
  string 255 errstr,tstr;
  record INVc INr;
  string 255 taxtemplatecode;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  
  GetWindowRecord(wn,RepSpec);
  mwn = MotherWindow(wn);
  switch (GetWindowClass(mwn)) begin
    case "IVDClass":
      GetWindowRecord(mwn,IVr);
      rwcnt = MatRowCnt(IVr);
      if (RepSpec.long1>=0) and (RepSpec.long1<MatRowCnt(IVr)) then begin
        MatRowGet(IVr,RepSpec.long1,IVrw);
        if (IVrw.ArtCode==RepSpec.f1) then begin
          Userr.Code = RepSpec.AccStr;
          if (ReadFirstMain(Userr,1,true)) then begin
            if (CalcPassword(RepSpec.FirstAcc,Userr.Code,0)==Userr.DiscPassword) then begin
              testf = true;
              if (nonblank(Userr.MinPLCode)) then begin
                if (ReadFirstItem(IVrw.ArtCode,INr,true,true)) then begin
                  if (GetItemPriceDiscount3(IVrw.ArtCode,IVrw.Quant,INr,IVr.CurncyCode,
                                      IVr.FrRate,IVr.ToRateB1,IVr.ToRateB2,IVr.BaseRate1,IVr.BaseRate2,
                                      IVr.LangCode,IVr.CustCat,Userr.MinPLCode,IVr.RebCode,
                                      price,INr.Name,t,tstr,t,tstr,
                                      IVr.ExportFlag,dummyf,IVr.TransDate,IVr.TransTime,IVr.CustCode,true,dummyf,IVr.PayDeal,tstr,t,IVr.Region,"",taxtemplatecode)) then begin
                    discountprice = IVrw.Sum/IVrw.Quant;
                    if (price>discountprice) then begin 
                      errstr = discountprice;
                      errstr = errstr & USetStr(20111) & price;
                      MessageBox(20112,errstr);
                      testf = false;
                    end;
                  end;
                end;
              end;
              if (testf) begin
                IVrw.DiscApprovedBy = Userr.Code;
                closef = true;
              end;
            end else begin
              MessageBox(2049,"");
              goto LMgrsDiscOverrideOClassOnOKWindow;
            end;
          end else begin 
            MessageBox(2049,"");
            goto LMgrsDiscOverrideOClassOnOKWindow;
          end;
        end;
        MatRowPut(IVr,RepSpec.long1,IVrw);
      end;
    case "IVCashDClass":
      GetWindowRecord(mwn,IVCashr);
      rwcnt = MatRowCnt(IVCashr);
      if (RepSpec.long1>=0) and (RepSpec.long1<MatRowCnt(IVCashr)) then begin
        MatRowGet(IVCashr,RepSpec.long1,IVCashrw);
        if (IVCashrw.ArtCode==RepSpec.f1) then begin
          Userr.Code = RepSpec.AccStr;
          if (ReadFirstMain(Userr,1,true)) then begin
            if (CalcPassword(RepSpec.FirstAcc,Userr.Code,0)==Userr.DiscPassword) then begin
              testf = true;
              if (nonblank(Userr.MinPLCode)) then begin
                if (ReadFirstItem(IVCashrw.ArtCode,INr,true,true)) then begin
                  if (GetItemPriceDiscount3(IVCashrw.ArtCode,IVCashrw.Quant,INr,IVCashr.CurncyCode,
                                      IVCashr.FrRate,IVCashr.ToRateB1,IVCashr.ToRateB2,IVCashr.BaseRate1,IVCashr.BaseRate2,
                                      IVCashr.LangCode,IVCashr.CustCat,Userr.MinPLCode,IVCashr.RebCode,
                                      price,INr.Name,t,tstr,t,tstr,
                                      0,dummyf,IVCashr.TransDate,IVCashr.TransTime,IVCashr.CustCode,true,dummyf,IVCashr.PayDeal,tstr,t,IVCashr.Region,"",taxtemplatecode)) then begin
                    discountprice = IVCashrw.Sum/IVCashrw.Quant;
                    if (price>discountprice) then begin 
                      errstr = discountprice;
                      errstr = errstr & USetStr(20111) & price;
                      MessageBox(20112,errstr);
                      testf = false;
                    end;
                  end;
                end;
              end;
              if (testf) begin
                IVCashrw.DiscApprovedBy = Userr.Code;
                closef = true;
              end;
            end else begin
              MessageBox(2049,"");
              goto LMgrsDiscOverrideOClassOnOKWindow;
            end;
          end else begin 
            MessageBox(2049,"");
            goto LMgrsDiscOverrideOClassOnOKWindow;
          end;
        end;
        MatRowPut(IVCashr,RepSpec.long1,IVCashrw);
      end;
  end;
LMgrsDiscOverrideOClassOnOKWindow:;
  if (closef) then begin
    PutWindowRecord(mwn,IVr);
    CloseWindow(wn);
  end;
  MgrsDiscOverrideOClassOnOKWindow = false;
  return;
end;

global
updating procedure CorrectionIVsm()
BEGIN
  record IVVc tmpIVr;
  record IVVc oldIVr;
  record IVVc IVCreditr;
  record IVVc IVr;
  row IVVc IVrw;
  row IVVc tmpIVrw;
  Integer wn,rwcnt,i,nwn;
	
  wn = CurWindow;

//  KeyPadEnter(wn);
  DeselectWindow(wn,false);  
  GetWindowRecord(wn,IVr);
  if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin
    if (IVr.OKFlag==0) then begin
      RecordCopy(oldIVr,IVr);
      rwcnt = MatRowCnt(IVr);
      ClearRow(IVr,IVrw,kInvoiceRowTypeNormal);
      IVrw.stp = kInvoiceRowTypeNormal;
      IVrw.Spec = USetStr(2078);
      If(currentcompany==10)then begin
      	IVrw.Spec="PRZED KOREKTA";// Edit ************************** Thursday, 15 October 2015 11:23:05
      end;
      MatRowInsert(IVr,1,IVrw);
      ClearRow(IVr,IVrw,kInvoiceRowTypeNormal);
      IVrw.stp = kInvoiceRowTypeNormal;
      IVrw.Spec = USetStr(2079);
      If(currentcompany==10)then begin
      	IVrw.Spec="PO KOREKTA";// Edit ************************** Thursday, 15 October 2015 11:23:05
      end;
      MatRowPut(IVr,rwcnt+1,IVrw);
      for (i=1;i<rwcnt;i=i+1) begin
        MatRowGet(oldIVr,i,IVrw);
        IVrw.stp = kInvoiceRowTypeCorrection;
        MatRowPut(IVr,rwcnt+1+i,IVrw);      
      end;
      if (IVr.CredInv!=-1) then begin
        tmpIVr.SerNr = IVr.CredInv;
        if (ReadFirstMain(tmpIVr,1,true)) then begin
          IVr.Location = tmpIVr.Location;
          rwcnt = MatRowCnt(IVr);
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(IVr,i,IVrw);
            if (IVrw.CreditedRow>=0) then begin
              MatRowGet(tmpIVr,IVrw.CreditedRow,tmpIVrw);
              IVrw.Location = tmpIVrw.Location;
            end else begin            
              if (nonblank(IVrw.Location)) then begin
                IVrw.Location = tmpIVr.Location;
              end;
            end;
            MatRowPut(IVr,i,IVrw);      
          end;
        end;
      end;
      IVSumup(IVr,true);
      PutWindowRecord(wn,IVr);  
      if (IVr.CredInv!=-1) then begin
        tmpIVr.CredInv = IVr.CredInv;
        if (ReadFirstKey("CredInv",tmpIVr,1,true)) then begin
          if (tmpIVr.SerNr!=IVr.SerNr) and (tmpIVr.SerNr!=-1) then begin
            MessageBox(2176,"");
          end;
        end;
      end;
    end;
  end else begin
    if ((IVr.OKFlag!=0) and (IVr.InvType!=kInvoiceTypeCredit and IVr.InvType!=kInvoiceTypeCreditSpecialSales)) then begin
      if (CreateCreditNoteIV(IVr,kInvoiceTypeCredit,IVCreditr,"",true)==0) then begin
/*    
moved to CreateCreditNoteIV
        RecordCopy(oldIVr,IVCreditr);
        rwcnt = MatRowCnt(IVCreditr);
        ClearRow(IVCreditr,IVrw,1);
        IVrw.stp = kInvoiceRowTypeNormal;
        IVrw.Spec = USetStr(2078);
        MatRowInsert(IVCreditr,1,IVrw);
        ClearRow(IVCreditr,IVrw,11);
        IVrw.stp = kInvoiceRowTypeNormal;
        IVrw.Spec = USetStr(2079);
        MatRowPut(IVCreditr,rwcnt+1,IVrw);
        for (i=1;i<rwcnt;i=i+1) begin
          MatRowGet(oldIVr,i,IVrw);
          IVrw.stp = kInvoiceRowTypeCorrection;
          MatRowPut(IVCreditr,rwcnt+1+i,IVrw);      
        end;
        IVSumup(IVCreditr,true);
*/        
        if (IVCreditr.CredInv!=-1) then begin
          tmpIVr.CredInv = IVCreditr.CredInv;
          if (ReadFirstKey("CredInv",tmpIVr,1,true)) then begin
            if (tmpIVr.SerNr!=IVCreditr.SerNr) and (tmpIVr.SerNr!=-1) then begin
              MessageBox(2176,"");
            end;
          end;
        end;
        nwn = OpenWindow("IVDClass",1,0,"","",IVCreditr);
        if (WindowDoOK(nwn,0)) then begin
          UpdateBrowses("IVVc");
        end;
      end;
    end;
  end;
  RETURN;
END;

global
function Boolean IVDClassSwitchRow(Integer wn,Integer rownr)
begin        
  record IVVc IVr;  
  row IVVc IVrw; 
  Integer rwcnt;
  Boolean res;
  val t,tproc,unitprdisc,s,rowsum;
  string 255 recepy;
  string 255 location;
  record TaxMatrixVc TMr;
		
  res = true;
  GetWindowRecord(wn,IVr);
  rwcnt = MatRowCnt(IVr);  
  if ((rownr<rwcnt) and (rownr>=0)) then begin
    MatRowGet(IVr,rownr,IVrw);
    if (IVrw.stp==kInvoiceRowTypeNormal) or (IVrw.stp==kInvoiceRowTypeStructuredItemComponent) then begin
      location = IVrw.Location;
      if (blank(location)) then begin
        location = IVr.Location;
      end;
      t = IVrw.rowGP;
      s = MulRateToBase1(IVr.CurncyCode,IVrw.Sum,IVr.FrRate,IVr.ToRateB1,IVr.ToRateB2,IVr.BaseRate1,IVr.BaseRate2,DefaultCurRoundOff);
      UnpackRowFieldMatrix(IVrw,"TaxMatrix",TMr);
      FindSalesExVat(TMr,IVrw.VATCode,s,IVr.InclVAT,IVr.NoTAXonVAT,rowsum);
      CalcProc(rowsum,t,tproc);
      unitprdisc = IVrw.Sum/IVrw.Quant;
      unitprdisc = Round(unitprdisc,DefaultRoundMode);
      recepy = IVrw.Recepy;
/*  This makes one extra call, I can see why but we need another solution
      if (blank(recepy)) then begin
        GetRecepy(IVrw.ArtCode,recepy);
      end;  
*/
    end;
    SendArtStat(IVrw.ArtCode,location,recepy,IVrw.rowGP,tproc,unitprdisc,IVr.TransDate,0);
  end;
  SetWindowNameArg(wn,IVrw.ArtCode & ":" & location);
  IVDClassSwitchRow = res;  
  return;
end;

global
procedure ItemStatusIVDsm()
BEGIN
  Integer wn,nwn;
  Boolean testf;
  record RcVc RepSpec;
  
  wn = CurWindow;
  nwn = OpenArtStat(wn,RepSpec,true);
  testf = IVDClassSwitchRow(wn,WindowActiveRow(wn));
  RETURN;
END;

global
procedure DoCLInFromIVD()
BEGIN
  record IVVc IVr;
  record CLInVc CLInr;
  Integer wn,nwn;
  Integer normalstate;

  normalstate = 0;
  wn = CurWindow;
  if (WindowState(wn)==normalstate) then begin
    GetWindowRecord(wn,IVr)
    if (IVr.OKFlag!=0) then begin    
      if (DoCLInFromIVDRemote(IVr,CLInr)) then begin
        nwn = OpenWindow("CLInDClass",1,0,"","",CLInr);
      end else begin
        Beep;
      end;
    end else begin
      Beep;
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;

global
updating procedure VATCorrectionIVsm()
begin
  record IVVc IVr;
  record VATIVVc VATIVr;
  record VATIVVc VATIVnoVATr;
  Integer wn,nwn;
  Integer normalstate;
  Integer err;
  Boolean SeparateVATIVFromIVForNoVAT;
  record VATIVTBlock VATIVTb;

  normalstate = 0;
  wn = CurWindow;
  if (WindowState(wn)==normalstate) then begin
    GetWindowRecord(wn,IVr);
    if (IVr.OKFlag==0) then begin
      MessageBox(2072,"");
      goto LVATCorrectionIVsm;
    end;
    if (IVr.Invalid!=0) then begin
      MessageBox(1282,"");
      goto LVATCorrectionIVsm;
    end;
    if (IVr.ARonTR==0) then begin
      MessageBox(20938,"");
      goto LVATCorrectionIVsm;
    end;
    err = TestVATIVCorrectionAllowed(IVr);
    if (err!=0) then begin
      MessageBox(err,"");
      goto LVATCorrectionIVsm;
    end;
    err = UpdateTRVATIV(IVr,VATIVr,0);
    if (err==0) then begin
      if (MatRowCnt(VATIVr)>0) then begin
        BlockLoad(VATIVTb);
        if (VATIVTb.SeparateVATIVFromIVForNoVAT!=0) then begin
          SeparateVATIVFromIVForNoVAT = TestSeparateVATIVFromIVForNoVAT(IVr);
        end;
        if (SeparateVATIVFromIVForNoVAT) then begin
          SeparateVATIVForNoVAT(VATIVr,VATIVnoVATr);
          nwn = OpenWindow("VATIVDClass",1,0,"","",VATIVr);
          nwn = OpenWindow("VATIVDClass",1,0,"","",VATIVnoVATr);
        end else begin
          nwn = OpenWindow("VATIVDClass",1,0,"","",VATIVr);
        end;
      end;
    end else begin
      MessageBox(err,"");
    end;
  end;
LVATCorrectionIVsm:;  
  return;
end;

global
procedure PrintCashInOutIVDsm()
BEGIN
  record IVVc IVr;
  Integer wn,nwn;
  Integer normalstate;

  normalstate = 0;
  wn = CurWindow;
  if (WindowState(wn)==normalstate) then begin
    GetWindowRecord(wn,IVr);
    RecActionIV_rlCashInOutDPrint(IVr);
  end;
  RETURN;
END;

global
function Boolean IVDClassPrint(Integer wn,Boolean previewf)
BEGIN
  record IVVc IVr;
  Integer normalmode,tf,err;
  string 20 docname;
  record LocalMachineBlock LMb;
  record LSerialPortDeviceVc LSPDr;
  record IVVc credIVr;
  Boolean testf;

  BlockLoad(LMb); 
  normalmode = 0;//Rs_normal
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr); 
  testf = true;
  err = TestAcceptanceStatus(IVr.AcceptanceStatus);
  if (err!=0) then begin
    MessageBox(err,"");
    testf = false;
  end;
  if (testf) then begin
    docname = "InvForm";
    switch (IVr.InvType) begin
      case kInvoiceTypeCash: docname = "CashInvForm";
      case kInvoiceTypeCredit: docname = "CredInvForm";
      case kInvoiceTypeInterest: docname = "IIInvForm";
      case kInvoiceTypeCreditSpecialSales: docname = "CredInvForm";
    end;
    switch (IVr.InvType) begin
      case kInvoiceTypeCash:
        if (FindLocalSerialPortDevice(kSerialPortDeviceClassFiscalControlUnit,kSerialPortDeviceModelFiscPrinterCLEANCASHTypeA,LMb.LocalMachineCode,LSPDr)) then begin  
          goto LIVDClassPrint;
        end else begin
          if (FindLocalSerialPortDevice(kSerialPortDeviceClassFiscalControlUnit,kSerialPortDeviceModelFiscPrinterCLEANCASHTypeC,LMb.LocalMachineCode,LSPDr)) then begin  
            goto LIVDClassPrint;
          end;
        end;
      case kInvoiceTypeCreditSpecialSales: goto LkInvoiceTypeCredit;
      case kInvoiceTypeCredit:
        LkInvoiceTypeCredit:;
        credIVr.SerNr = IVr.CredInv;
        if (ReadFirstMain(credIVr,1,true)) then begin
          if (credIVr.InvType==kInvoiceTypeCash) then begin
            if (FindLocalSerialPortDevice(kSerialPortDeviceClassFiscalControlUnit,kSerialPortDeviceModelFiscPrinterCLEANCASHTypeA,LMb.LocalMachineCode,LSPDr)) then begin  
              goto LIVDClassPrint;
            end else begin
              if (FindLocalSerialPortDevice(kSerialPortDeviceClassFiscalControlUnit,kSerialPortDeviceModelFiscPrinterCLEANCASHTypeC,LMb.LocalMachineCode,LSPDr)) then begin  
                goto LIVDClassPrint;
              end;
            end;
          end;
        end;
    end;
    if ((IVr.InvType==kInvoiceTypeNormal or IVr.InvType==kInvoiceTypeNormalSpecialSales) or (IVr.InvType==kInvoiceTypeDownpayment)) then begin
      if (nonblank(IVr.PRCode)) then begin    
        docname = "ProjInvForm";
      end;
    end;
    if ((WindowState(wn)==normalmode) and (previewf==false)) then begin
      RecordActionIV_Print(IVr,"",docname,0,true);//RecidAction(rlIVLPrint,IVVc,recid,NIL);
    end else begin  
      tf = IVr.OKFlag;
      if (previewf==false) then begin
        IVr.OKFlag = 0;
      end else begin
        IVr.OKFlag = 1;
      end;
      if (PrintDocument(IVr,docname,true)) then begin end;
      IVr.OKFlag = tf;
    end;
  end;
LIVDClassPrint:; 
  IVDClassPrint = true;
  RETURN;
END;

global //Edit***************************Sasha2,18:12 23.12.2014 {
function Boolean IV1DClassPrint(Integer wn,Boolean previewf)
BEGIN

  IV1DClassPrint = IVDClassPrint(wn,previewf);
  
  RETURN;
END; //Edit***************************Sasha2,18:12 23.12.2014 }

global
procedure IVInfoIVDsm()
BEGIN
  record IVVc IVr;
  record RcVc RepSpec;
  Integer wn;

  wn = CurWindow;
  GetWindowRecord(wn,IVr);
  RepSpec.repname = "IVInfoRn";
  RepSpec.long1 = IVr.SerNr;
  RepSpec.Media = mtScreen;
  RunReport(RepSpec,0);
  RETURN;
END;

global
procedure PrintProformaIVDsm()
BEGIN
  record IVVc IVr;
  Integer wn;
  record LocalMachineBlock LMb;
  record LSerialPortDeviceVc LSPDr;
  boolean printf;

  wn = CurWindow;
  GetWindowRecord(wn,IVr);
  printf = true;
  switch (IVr.InvType) begin
    case kInvoiceTypeCash:
      if (IVr.OKFlag==0) then begin
        BlockLoad(LMb);
        if (FindLocalSerialPortDevice(kSerialPortDeviceClassFiscalControlUnit,kSerialPortDeviceModelFiscPrinterCLEANCASHTypeA,LMb.LocalMachineCode,LSPDr)) then begin  
          printf = false;
        end else begin
          if (FindLocalSerialPortDevice(kSerialPortDeviceClassFiscalControlUnit,kSerialPortDeviceModelFiscPrinterCLEANCASHTypeC,LMb.LocalMachineCode,LSPDr)) then begin  
            printf = false;
          end;
        end;
      end;
  end;
  if (printf) then begin
    if (PrintDocument(IVr,"Inv1Form",false)) then begin
    end;
  end;
  RETURN;
END;

global
updating procedure COFromIVDsm()
BEGIN
  record IVVc IVr;
  record IVVc newIVr;
  record COVc COr;
  record COCUServiceVc COCUServicer;
  record COCUServiceBlock COCUb;
  Integer wn,nwn;
  Integer r;

  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    GetWindowRecord(wn,IVr);
    COr.InvoiceNr = IVr.SerNr;
    if (UserCanAction("InvToCO",true)) then begin
      BlockLoad(COCUb);
      if (COCUb.BlockUsingStdCO==0) then begin
        r = RecordAction_raPasteInvInCO(COr,IVr);
        if (r!=-1) then begin
          if (MatRowCnt(COr)!=0) then begin
            nwn = OpenWindow("CODClass",1,0,"","",COr);
            UpdateBrowses("IVVc");
          end else begin
            Beep;
          end;
        end else begin
          Beep;
        end;
      end else begin
        r = RecordAction_raPasteInvInCOCUService(COCUServicer,IVr,newIVr);
        if (r!=-1) then begin
          nwn = OpenWindow("COCUServiceDClass",1,0,"","",COCUServicer);
          if (MatRowCnt(newIVr)>0) then begin
            nwn = OpenWindow("IVDClass",1,0,"","",newIVr);
          end;
          UpdateBrowses("IVVc");
          UpdateBrowses("COCUServiceVc");
          UpdateBrowses("CUServiceVc");
        end else begin
          Beep;
        end;
      end;
    end else begin
      MessageBox(1274,StringFromStringSet(3,"InvToCO"));
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;

global
updating procedure DoEDIInvFromIVD()
BEGIN
  record EDIIVVc EDIIVr;
  Integer wn,nwn;
  LongInt r;
  record IVVc IVr;

  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    GetWindowRecord(wn,IVr);
    if (IVr.Invalid==0) then begin
      EDIIVr.SerNr = IVr.SerNr;
      if (UserCanAction("IVToEDIInv",true)) then begin
        RraPasteInvInEDIInv(EDIIVr,r);//RecAction(raPasteInvInEDIInv,EDIIVVc,&EDIIVr,&r);
        if (r!=-1) then begin
          nwn = OpenWindow("EDIIVDClass",1,0,"","",EDIIVr);//is this the same ? nwn = OpenAndSetAccess("EDIIVVc","EDIIVDClass",0,&EDIIVr,true,0);
        end else begin
          Beep;
        end;
      end;
    end else begin
      MessageBox(1274,StringFromStringSet(3,"IVToEDIInv"));
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;

global 
procedure ConnectToPrepayIVDsm()
BEGIN
  record IVVc IVr;
  row IVVc IVrw;
  Integer wn,rownr;
  
  wn = CurWindow;
  KeyPadEnter(wn);
  GetWindowRecord(wn,IVr);
  DeselectWindow(wn,false);
  if (IVr.OKFlag==0) then begin
    rownr = WindowActiveRow(wn);
    if (rownr<0) then begin rownr = 0; end;
    ClearRow(IVr,IVrw,6);
    IVrw.Spec = USetStr(1288);
    MatRowInsert(IVr,rownr,IVrw);
    PutWindowRecord(wn,IVr);
    WindowFieldGoto(wn,IVr,rownr,"CUPNr",true);
  end;
  RETURN;
END;

global 
procedure UpdatePricesIVDsm()
BEGIN
  record IVVc IVr;
  Integer wn;
  
  wn = CurWindow;
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  if (IVr.OKFlag==0) then begin
    IVDUpdatePrices(IVr,false);
    PutWindowRecord(wn,IVr);
  end;
  RETURN;
END;

global 
procedure CreateInstalmentsIVDsm()
BEGIN
  record IVVc IVr;
  record RcVc RepSpec;
  Integer wn,nwn;
  
  wn = CurWindow;
  GetWindowRecord(wn,IVr);
  if (WindowState(wn)==0)then begin//Rs_normal
    nwn = OpenWindow("MakeInstalVClass",1,0,"","",RepSpec);
    DeselectWindow(nwn,false);
    RepSpec.repname = "MakeInstalMn";
    RepSpec.FirstVer = IVr.SerNr;
    RepSpec.long1 = -1;
    RepSpec.long2 = -1;
    RepSpec.vals0 = blankval;
    RepSpec.d1 = CurrentDate;
    PutWindowRecord(nwn,RepSpec);
    SelectWindow(nwn);
  end;
  RETURN;
END;

global
procedure EditInstalmentIVDsm()
begin
  record IVVc IVr;
  record RcVc RepSpec;
  Integer wn;

  wn = CurWindow;
  GetWindowRecord(wn,IVr);
  RepSpec.repname = "EditInstallRn";
  RepSpec.long1 = IVr.SerNr;
  RepSpec.Media = mtScreen;
  RunReport(RepSpec,0);
  return;
end;

global 
procedure RecalcWeightIVDsm()
BEGIN
  record IVVc IVr;
  Integer wn;
  
  wn = CurWindow;
  DeselectWindow(wn,false);
  if (WindowState(wn)==0)then begin//Rs_normal
    GetWindowRecord(wn,IVr);
    if (IVr.OKFlag==0) then begin
      RecalculetWeightVolumeIVVc(IVr,true);
      PutWindowRecord(wn,IVr);
    end;
  end;
  RETURN;
END;

global 
procedure RecalcDiscountIVDsm()
BEGIN
  record IVVc IVr;
  Integer wn;
  
  wn = CurWindow;
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  if (IVr.OKFlag==0) then begin
    RecalcDiscountIVD(IVr);
    PutWindowRecord(wn,IVr);
  end;
  RETURN;
END;

global
procedure AddInvoiceLineType(Integer arownr,Integer t,Boolean firstf)
begin
  record IVVc IVr;
  row IVVc IVrw;
  Integer wn,rownr,rwcnt;
  
  wn = CurWindow;
  rownr = arownr;
  if (rownr<0) then begin
    rownr = WindowActiveRow(wn);
  end;
//  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  if (IVr.OKFlag==0) then begin
    rwcnt = MatRowCnt(IVr);
    if (rownr==-1) then begin
      if (firstf) then begin
        rownr = 0;
      end else begin
        rownr = MatRowCnt(IVr);
      end;
    end else begin
      if (rownr>rwcnt) then begin
        rownr = rwcnt;
      end;
    end;
    ClearRow(IVr,IVrw,t);
    IVrw.Spec = "";
    MatRowInsert(IVr,rownr,IVrw);
    PutWindowRecord(wn,IVr);
    switch (t) begin
      case 17:
        WindowFieldGoto(wn,IVr,rownr,"Spec",true);
    end;
  end;
end;

global
procedure HiddenLineIVDsm()
BEGIN
  AddInvoiceLineType(-1,10,false);
  RETURN;
END;

global
procedure HeaderLineIVDsm()
BEGIN
  AddInvoiceLineType(-1,17,true);
  RETURN;
END;

global
procedure SubTotalLineIVDsm()
begin
  record IVVc IVr;
  row IVVc IVrw;
  Integer wn,i,rwcnt,rownr;
  val pt;
  
  wn = CurWindow;
  rownr = WindowActiveRow(wn);
//  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  if (IVr.OKFlag==0) then begin
    rwcnt = MatRowCnt(IVr);
    if ((rownr==-1) or (rownr>rwcnt)) then begin
      rownr = rwcnt;
    end;
    ClearRow(IVr,IVrw,9);
    MatRowInsert(IVr,rownr,IVrw);
    RecalcIVSubtotal(IVr);
    PutWindowRecord(wn,IVr);
  end;
  return;
end;

global 
procedure SwitchToBase1IVDsm()
BEGIN
  record BaseCurBlock bascur;
  record IVVc IVr;
  row IVVc IVrw;
  Integer wn,i,rwcnt;
  val rowcost, rowgp;
  record CUVc CUr;
  
  wn = CurWindow;
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  if (IVr.InvType==kInvoiceTypeDownpayment) then begin
    MessageBox(20410,"");
    goto LSwitchToBase1IVDsm;
  end;
  BlockLoad(bascur);
  if (IVr.OKFlag==0) and (nonblank(IVr.CurncyCode)) and (IVr.CurncyCode!=bascur.BaseCur1) then begin
    CUr.Code = IVr.CustCode;
    ReadFirstMain(CUr,1,true);
    if (blank(CUr.CurncyCode)) or (CUr.CurncyCode!=IVr.CurncyCode) then begin
      rwcnt = MatRowCnt(IVr);
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(IVr,i,IVrw);
        if (nonblank(IVrw.Sum)) then begin
          switch (IVrw.stp) begin
            case kInvoiceRowTypeCorrection:              
              goto LSwitchToBase1IVDsmRowNormal;
            case kInvoiceRowTypeNormal:
LSwitchToBase1IVDsmRowNormal:;            
              rowcost = IVrw.BasePrice;
              rowgp = IVrw.rowGP;
              IVrw.Price = MulRateToBase1(IVr.CurncyCode,IVrw.Price,IVr.FrRate,IVr.ToRateB1,IVr.ToRateB2,IVr.BaseRate1,IVr.BaseRate2,DefaultCurRoundOff);
              MatRowPut(IVr,i,IVrw);
              if (IVDchrsum(IVr,i)) then begin
                IVDchsum(IVr,i);
              end; 
              MatRowGet(IVr,i,IVrw);
              IVrw.BasePrice = rowcost;
              IVrw.rowGP = rowgp;
              MatRowPut(IVr,i,IVrw);
            case kInvoiceRowTypeDownpayment:
//currency cannot be difrent , we do update downpayrecived assuming Invoice curncy is same as  Sales Order currency
//              IVrw.Sum = MulRateToBase1(IVr.CurncyCode,IVrw.Sum,IVr.FrRate,IVr.ToRateB1,IVr.ToRateB2,IVr.BaseRate1,IVr.BaseRate2,DefaultCurRoundOff);
//              MatRowPut(IVr,i,IVrw);
          end;
        end;
      end;
      IVr.CurncyCode = bascur.BaseCur1;
      IVr.FrRate = blankval;
      IVr.ToRateB1 = blankval;
      IVr.ToRateB2 = blankval;
      IVSumup(IVr,true);
      PutWindowRecord(wn,IVr);
    end;
  end;
LSwitchToBase1IVDsm:;
  RETURN;
END;

global 
procedure RepaIVsm()
BEGIN
  record IVVc IVr;
  Integer wn;
  val t;

  wn = CurWindow;
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  if (IVr.OKFlag==0) then begin
    if (AddRepaLine(IVr,TouchScreenLook,0,t)) then begin
      PutWindowRecord(wn,IVr);
    end;
  end;
  RETURN;
END;

global 
updating procedure FirstEventIVDsm()
BEGIN
  record FEIVVc FEIVr;
  record IVVc IVr;
  Integer wn,nwn;
  LongInt r;

  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    DeselectWindow(wn,false);
    GetWindowRecord(wn,IVr);
    if (IVr.OKFlag!=0) then begin
      r = RecordAction_raPasteIVInFEIV(FEIVr,IVr.SerNr);
      if (r==0) then begin
        nwn = OpenWindow("FEIVDClass",1,0,"","",FEIVr);
      end else begin
        Beep;
      end;
    end else begin
      Beep;
    end;
  end;
  RETURN;
END;

procedure CashPaymentIVActiveField(Integer wn)
begin
  string 255 activefield;
  
  activefield = WindowActiveField(wn);
  if (blank(activefield)) then begin
    goto LCashPaymentIVActiveField;
  end;
  switch (activefield) begin
    case "InvDate":;
    case "PayDeal":;
    case "PayDate":;
    case "TransDate":;
    case "CustOrdNr":;
    case "OurContact":;
    case "LangCode":;
    case "ClientContact":;
    case "SalesMan":;
    case "Location":;
    otherwise 
      KeyPadEnter(wn);    
  end;
LCashPaymentIVActiveField:;  
  return;
end;

global 
procedure GCIVsm()
BEGIN
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  Integer wn,rownr;

  wn = CurWindow;
  CashPaymentIVActiveField(wn);
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  switch (WindowState(wn)) begin
    case 0: //Rs_normal
      GetWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LGCIVsm; end;
    case 1: //Rs_insert
    case 2: 
      GetPrevWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LGCIVsm; end;
  end;
  ClearRow(IVr,IVrw,kInvoiceRowTypeGiftVoucherSold);  
  rownr = MatRowCnt(IVr);
  MatRowPut(IVr,rownr,IVrw);
  PutWindowRecord(wn,IVr);
  WindowFieldGoto(wn,IVr,rownr,"GCNr",true);
LGCIVsm:;  
  RETURN;
END;

global 
procedure GCRIVsm(Integer btnNr)
BEGIN
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  Integer wn,rownr,rowstp;
  string 255 pmcode;

  wn = CurWindow;
  CashPaymentIVActiveField(wn);
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  switch (WindowState(wn)) begin
    case 0: //Rs_normal
      GetWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LGCRIVsm; end;
    case 1: //Rs_insert
    case 2: 
      GetPrevWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LGCRIVsm; end;
  end;
  pmcode = GetWindowString(wn,"IVPMCode" & btnNr);
  rowstp = StringToInt(GetWindowString(wn,"IVrowstp" & btnNr));
  if (rowstp==0) then begin
    ClearRow(IVr,IVrw,kInvoiceRowTypeGiftVoucherPayment); 
  end else begin
    ClearRow(IVr,IVrw,rowstp); 
  end;
  rownr = MatRowCnt(IVr);
  MatRowPut(IVr,rownr,IVrw);
  PutWindowRecord(wn,IVr);
  WindowFieldGoto(wn,IVr,rownr,"GCNr",true);
LGCRIVsm:;  
  RETURN;
END;

global
procedure GCRIVsm1()
begin
  GCRIVsm(1);
  return;
end;

global
procedure GCRIVsm2()
begin
  GCRIVsm(2);
  return;
end;

procedure CashIVsmExecute(integer btnNr)
BEGIN
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  Integer wn,rownr,rowstp;
  val fr,to1,to2,br1,br2;
  string 255 tstr,pmcode;
  record DefCashBlock DefCashRec;

  wn = CurWindow;
  CashPaymentIVActiveField(wn);  
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  switch (WindowState(wn)) begin
    case 0: //Rs_normal
      GetWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LCashIVsm; end;
    case 1: //Rs_insert
    case 2: 
      GetPrevWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LCashIVsm; end;
  end;
  pmcode = GetWindowString(wn,"IVPMCode" & btnNr);
  rowstp = StringToInt(GetWindowString(wn,"IVrowstp" & btnNr));
  CashIVsmRemote(IVr,pmcode,rowstp);
  PutWindowRecord(wn,IVr);
  WindowFieldGoto(wn,IVr,MatRowCnt(IVr)-1,"Sum",true);
  DisplayIVSubTotalAction(IVr);
  if (IsWebClient) then begin
    SelectWindow(wn);
  end;
LCashIVsm:;  
  RETURN;
END;

global
procedure CashIVsm()
begin
  CashIVsmExecute(1);
  return;
end;

global 
procedure CashIVsm1()
begin
  CashIVsmExecute(1);
  return;
end;

global 
procedure CashIVsm2()
begin
  CashIVsmExecute(2);
  return;
end;

global 
procedure ChequeIVsm(integer btnNr)
BEGIN
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  Integer wn,rownr,rowstp;
  val fr,to1,to2,br1,br2;
  string 255 tstr,pmcode;
  record DefCashBlock DefCashRec;

  wn = CurWindow;
  CashPaymentIVActiveField(wn);
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  switch (WindowState(wn)) begin
    case 0: //Rs_normal
      GetWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LChequeIVsm; end;
    case 1: //Rs_insert
    case 2: 
      GetPrevWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LChequeIVsm; end;
  end;
  pmcode = GetWindowString(wn,"IVPMCode" & btnNr);
  rowstp = StringToInt(GetWindowString(wn,"IVrowstp" & btnNr));
  ChequeIVsmRemote(IVr,pmcode,rowstp);
  PutWindowRecord(wn,IVr);
  WindowFieldGoto(wn,IVr,MatRowCnt(IVr)-1,"Sum",true);
  DisplayIVSubTotalAction(IVr);
LChequeIVsm:;  
  RETURN;
END;

global 
procedure ChequeIVsm1()
begin
  ChequeIVsm(1);
  return;
end;

global 
procedure ChequeIVsm2()
begin
  ChequeIVsm(2);
  return;
end;

global 
updating procedure CredCardIVsmDo(integer btnNr)
BEGIN
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  Integer wn,rownr,nwn;
  LongInt rowstp;
  val fr,to1,to2,br1,br2;
  val t,t1;  
  string 255 tstr,pmcode,pmcodelabel;
  record DefCashBlock DefCashRec;
  record RahaxiBlock Rahaxib; 

  BlockLoad(Rahaxib);
  wn = CurWindow;
  CashPaymentIVActiveField(wn);
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  switch (WindowState(wn)) begin
    case 0: //Rs_normal
      GetWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LCredCardIVsmDo; end;
    case 1: //Rs_insert
    case 2: 
      GetPrevWindowRecord(wn,prevIVr); //Rs_update
      if (prevIVr.OKFlag!=0) then begin goto LCredCardIVsmDo; end;
  end;
  if (Rahaxib.TerminalType==kLocalCCTerminalNone) begin
    switch (WindowActiveField(wn)) begin
      otherwise
        BlockLoad(DefCashRec);
        pmcode = GetWindowString(wn,"IVPMCode" & btnNr);
        if (blank(pmcode)) then begin
          pmcode = GetWindowString(wn,"PMCode" & btnNr);
        end;
        if (blank(pmcode)) then begin
          pmcode =  DefCashRec.DefCCPayMode;
        end;
        rowstp = StringToLongInt(GetWindowString(wn,"rowstp" & btnNr));
        if (rowstp<0) then begin
          rowstp = StringToInt(GetWindowString(wn,"IVrowstp" & btnNr));
        end;
        if (CCPayIVDWithCardDataAndPM(wn,"",rowstp,pmcode)==false) then begin
          if (rowstp==0) then begin
            ClearRow(IVr,IVrw,kInvoiceRowTypeCreditCardPayment); 
          end else begin
            ClearRow(IVr,IVrw,rowstp); 
          end;
          tstr = IVrw.CurncyCode;
          GetFullCurncyRate(tstr,IVr.TransDate,fr,to1,to2,br1,br2);
          IVrw.CurncyCode = tstr;
          IVrw.FrRate = fr;
          IVrw.ToRateB1 = to1; 
          IVrw.ToRateB2 = to2;
          IVrw.BaseRate1 = br1;
          IVrw.BaseRate2 = br2;    
          IVrw.PayMode =  pmcode;
          rownr = MatRowCnt(IVr);
          MatRowPut(IVr,rownr,IVrw);
          PutWindowRecord(wn,IVr);
          WindowFieldGoto(wn,IVr,rownr,"Sum",true);
          DisplayIVSubTotalAction(IVr);
        end;
    end;
  end else begin
    SubCashRows_IVVc(IVr,true,t,t1);
    switch (Rahaxib.TerminalType) begin
      case kLocalCCTerminalRahaxi: OpenCCPayRahaxiDClass(wn,rownr,IVr.SerNr,IVr.RetnValue,t,IVr.CurncyCode);
      case kLocalCCTerminalSteriaCOM: OpenCCPaySteriaDClass(wn,rownr,IVr.SerNr,IVr.RetnValue,t,IVr.CurncyCode);
      case kLocalCCTerminalSteriaIP: OpenCCPaySteriaDClass(wn,rownr,IVr.SerNr,IVr.RetnValue,t,IVr.CurncyCode);
      case kLocalCCTerminalYomaniBanksys: 
        pmcode = GetWindowString(wn,"IVPMCode" & btnNr);
        if (blank(pmcode)) then begin
          pmcode = GetWindowString(wn,"PMCode" & btnNr);
        end;
        if (blank(pmcode)) then begin
          BlockLoad(DefCashRec);
          pmcode =  DefCashRec.DefCCPayMode;
        end;
        pmcodelabel = GetWindowString(wn,"IVPMCodeLabel" & btnNr);
        if (blank(pmcodelabel)) then begin
          pmcodelabel = GetWindowString(wn,"PMCodeLabel" & btnNr);
        end;
        OpenCCPayYomaniBanksysOClass(wn,pmcode,pmcodelabel,IVr.SerNr,IVr.RetnValue,t,IVr.CurncyCode);
      case kLocalCCTerminalIngenico6550: 
        pmcode = GetWindowString(wn,"IVPMCode" & btnNr);
        if (blank(pmcode)) then begin
          pmcode = GetWindowString(wn,"PMCode" & btnNr);
        end;
        if (blank(pmcode)) then begin
          BlockLoad(DefCashRec);
          pmcode =  DefCashRec.DefCCPayMode;
        end;
        pmcodelabel = GetWindowString(wn,"IVPMCodeLabel" & btnNr);
        if (blank(pmcodelabel)) then begin
          pmcodelabel = GetWindowString(wn,"PMCodeLabel" & btnNr);
        end;
        OpenCCPayIngenicoOClass(wn,pmcode,pmcodelabel,IVr.SerNr,IVr.RetnValue,t,IVr.CurncyCode);
    end;
  end;
  if (IsWebClient) then begin
    SelectWindow(wn);
  end;
LCredCardIVsmDo:;  
  RETURN;
END;

global 
procedure CredCardIVsmExecute(string paymode,string label)
begin
  record IVVc IVr;
  Integer wn,rownr;
  record RahaxiBlock Rahaxib; 

  wn = CurWindow;
  DeselectWindow(wn,true);
  GetWindowRecord(wn,IVr);
  BlockLoad(Rahaxib);
  if (Rahaxib.TerminalType==kLocalCCTerminalNone) then begin
    PutWindowString(wn,"ivcashcommand",POSCommandText(6,true));
    WindowFieldGoto(wn,IVr,-1,"ivcashcommand",false);
  end else begin
    switch (Rahaxib.TerminalType) begin
      case kLocalCCTerminalRahaxi: OpenCCPayRahaxiDClass(wn,1,IVr.SerNr,IVr.RetValue,IVr.Sum4,IVr.CurncyCode);
      case kLocalCCTerminalSteriaCOM: OpenCCPaySteriaDClass(wn,1,IVr.SerNr,IVr.RetValue,IVr.Sum4,IVr.CurncyCode);
      case kLocalCCTerminalSteriaIP: OpenCCPaySteriaDClass(wn,1,IVr.SerNr,IVr.RetValue,IVr.Sum4,IVr.CurncyCode);
      case kLocalCCTerminalYomaniBanksys: OpenCCPayYomaniBanksysOClass(wn,paymode,label,IVr.SerNr,IVr.RetValue,IVr.Sum4,IVr.CurncyCode);
      case kLocalCCTerminalIngenico6550: OpenCCPayIngenicoOClass(wn,paymode,label,IVr.SerNr,IVr.RetValue,IVr.Sum4,IVr.CurncyCode);
    end;
  end;
  return;
end;

global
updating procedure CredCardIVsm()
begin
  CredCardIVsmDo(0);
  return;
end;

global
updating procedure CredCardIVsm1()
begin
  CredCardIVsmDo(1);
  return;
end;

global
updating procedure CredCardIVsm2()
begin
  CredCardIVsmDo(2);
  return;
end;

global
procedure RestPMOtherIVsm()
begin
  Integer nwn;
  record RcVc RepSpec;
  
  nwn = OpenWindow("RestPMOtherPayVClass",1,CurWindow,"","",RepSpec);
  return;
end;

updating function Boolean IVFinish(Integer wn,var record IVVc IVr)
begin
  Integer nwn;
  Boolean res;
  record IVVc newIVr;
  record IVVc dummyIVr;

  res = false;
  if (IVr.OKFlag!=0) then begin goto LIVFinish; end;
  if (WindowState(wn)==Rs_normal) then begin
    PutWindowRecord(wn,IVr);
  end;
  IVSumup(IVr,true);
  IVr.OKFlag = 1;
  PutWindowRecord(wn,IVr);
  if (WindowDoOK(wn,0)) then begin
    GetWindowRecord(wn,IVr);
    UpdateBrowses("IVVc");
    OpenCashDrawer_IVVc(IVr);
    CloseWindow(wn);
    RecordNew(newIVr);
    IVDefaultsClient(newIVr,dummyIVr,1,1);
    nwn = OpenWindow("IVDClass",1,0,"","",newIVr);
    if (blank(newIVr.CustCode)) then begin
      WindowFieldGoto(nwn,newIVr,-1,"CustCode",true);
    end else begin
      SelectWindow(nwn);
      WindowFieldGoto(nwn,newIVr,0,"ArtCode",true);
    end;
    res = true;
  end else begin
    GetWindowRecord(wn,IVr);
    IVr.OKFlag = 0;
    PutWindowRecord(wn,IVr);
  end;
LIVFinish:;
  IVFinish = res;
  return;
end;

global
updating procedure IVFinishAndPrint()
begin
  Integer wn,wnst;
  record IVVc IVr,prevIVr;
  
  wn = CurWindow;
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  GetPrevWindowRecord(wn,prevIVr);
  wnst = WindowState(wn);
  if (IVr.OKFlag!=0) then begin
    IVPrintReceipt(wn,IVr,prevIVr,-1,true,false,0,wnst);
  end else begin    
    if (IVFinish(wn,IVr)) then begin
      IVPrintReceipt(wn,IVr,prevIVr,-1,true,true,0,wnst);
    end;
  end;
  return;
end;

global
updating procedure PrintToFiscPrntIVDsm()
BEGIN
  Integer wn;
  record IVVc IVr;
  record IVVc oldIVr;
  
  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    GetWindowRecord(wn,IVr);
    if (UserCanAction("PrintToFiscPrnt",true)) then begin
      if (IVr.FiscalFlag!=0) then begin
/*      
        if (IVr.Prntdf!=0) then begin
          RecordCopy(oldIVr,IVr);
          IVr.Prntdf = 0;
          if (RecordUpdate(oldIVr,IVr,false)==0) then begin 
            RecordCopy(oldIVr,IVr);
          end;
        end;
*/        
        IVVc_PrintToFiscalPrinter(IVr,true);
        if (IVVc_PrintToFiscalControlUnit(IVr)) then begin
          PutWindowRecord(wn,IVr);
        end;
      end else begin
        if (IVVc_PrintToFiscalControlUnit(IVr)) then begin
          PutWindowRecord(wn,IVr);
        end;
      end;
    end else begin
      MessageBox(1274,StringFromStringSet(3,"PrintToFiscPrnt"));
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;

global
updating procedure CreateCreditNoteIVDsm()
BEGIN
  record IVVc IVr;
  record IVVc IVCreditr;
  Integer wn,nwn;
  Integer normalstate;
  Integer res;
  record LocalMachineBlock LMb;

  normalstate = 0;//Rs_normal
  wn = CurWindow;
  DeselectWindow(wn,false);
  if (WindowState(wn)==normalstate) then begin
    GetWindowRecord(wn,IVr);
    if ((IVr.OKFlag!=0) and (IVr.InvType!=kInvoiceTypeCredit and IVr.InvType!=kInvoiceTypeCreditSpecialSales)) then begin
      BlockLoad(LMb);
      res = CreateCreditNoteIV(IVr,kInvoiceTypeCredit,IVCreditr,LMb.DefReturnLocation,false);
      if (res==0) then begin
      	if (TouchScreenLook)begin// Edit ************************** Friday, 26 June 2015 11:04:26
      		closewindow(wn);
      	end;
        nwn = OpenWindow("IVDClass",1,0,"","",IVCreditr);
        if (WindowDoOK(nwn,0)) then begin
          UpdateBrowses("IVVc");
        end;
      end else begin
        MessageBox(res,"");
      end;
    end else begin
      MessageBox(12556,"");      
    end;
  end else begin
    MessageBox(20803,"");      
  end;
  RETURN;
END;

global
updating procedure CreateDebitNoteIVDsm()
begin
  record IVVc IVr;
  record IVVc IVCreditr;
  Integer wn,nwn;
  Integer res;
  record LocalMachineBlock LMb;

  wn = CurWindow;
  DeselectWindow(wn,false);
  if (WindowState(wn)==Rs_normal) then begin
    GetWindowRecord(wn,IVr);
    if ((IVr.OKFlag!=0) and (IVr.InvType!=kInvoiceTypeDebit)) then begin
      BlockLoad(LMb);
      res = CreateCreditNoteIV(IVr,5,IVCreditr,LMb.DefReturnLocation,false);
      if (res==0) then begin
        nwn = OpenWindow("IVDClass",1,0,"","",IVCreditr);
        if (WindowDoOK(nwn,0)) then begin
          UpdateBrowses("IVVc");
        end;
      end else begin
        MessageBox(res,"");
      end;
    end else begin
      MessageBox(12556,"");      
    end;
  end else begin
    MessageBox(20803,"");      
  end;
  return;
end;

global
updating procedure CreateCredManIVsm()
BEGIN
  record IVVc IVr;
  record CredManVc CredManr;
  Integer wn,nwn;
  Integer normalstate;
  boolean res;

  normalstate = 0;//Rs_normal
  wn = CurWindow;
  DeselectWindow(wn,false);
  if (WindowState(wn)==normalstate) then begin
    GetWindowRecord(wn,IVr);
    CredManr.IVNr = IVr.SerNr;
    res = CreateCredManIV(CredManr,(IVr.OKFlag!=0) and (IVr.InvType==kInvoiceTypeNormal or IVr.InvType==kInvoiceTypeNormalSpecialSales));
    if (res) then begin
      nwn = OpenWindow("CredManDClass",1,0,"","",CredManr);
    end else begin
      Beep;
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;

updating procedure RestPMOtherPayDsm(Integer wn,string pmcode,Integer rowstp)
begin
  Integer mwn;
  record IVVc IVr;
  record IVVc prevIVr;
  record RestAccVc RestAccr;
  record RestAccVc prevRestAccr;
  record RahaxiBlock Rahaxib; 
  Boolean donef;
  
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    BlockLoad(Rahaxib);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        CloseWindow(wn);      
        CashPaymentIVActiveField(mwn);
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin goto LRestPMOtherPayDsm; end;
          case Rs_insert:
          case Rs_update: 
            GetPrevWindowRecord(mwn,prevIVr); //Rs_update
            if (prevIVr.OKFlag!=0) then begin goto LRestPMOtherPayDsm; end;
        end;
        if (Rahaxib.TerminalType==kLocalCCTerminalNone) then begin
          switch (WindowActiveField(mwn)) begin
            otherwise
              switch (rowstp) begin
                case kInvoiceRowTypeCreditCardPayment:
                  donef = CCPayIVDWithCardDataAndPM(mwn,"",rowstp,pmcode);
              end;
              if (donef==false) then begin
                RestPMOtherPayRemote_IV(IVr,pmcode,rowstp);
                PutWindowRecord(mwn,IVr);
                switch (rowstp) begin
                  case kInvoiceRowTypeGiftVoucherPayment:
                    WindowFieldGoto(mwn,IVr,MatRowCnt(IVr)-1,"GCNr",true);
                  otherwise
                    WindowFieldGoto(mwn,IVr,MatRowCnt(IVr)-1,"Sum",true);                   
                end;
              end;
              DisplayIVSubTotalAction(IVr);
          end;
        end else begin
//Rahaxi/Steria
        end;
      case "RestAccVc":
        KeyPadEnter(wn);
        CloseWindow(wn);      
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr); //Rs_update
            if (prevRestAccr.Closed!=0) then begin goto LRestPMOtherPayDsm; end;
          case Rs_insert:
          case Rs_update: 
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin goto LRestPMOtherPayDsm; end;
        end;
        if (Rahaxib.TerminalType==kLocalCCTerminalNone) then begin
          switch (WindowActiveField(mwn)) begin
            otherwise
              RestPMOtherPayRemote_RestAcc(RestAccr,pmcode,rowstp);
              PutWindowRecord(mwn,RestAccr);
              WindowFieldGoto(mwn,RestAccr,MatRowCnt(RestAccr)-1,"Sum",true);
          end;
        end else begin
//Rahaxi/Steria
        end;
    end;
  end;
LRestPMOtherPayDsm:;  
  return;
end;

updating procedure RestPMOtherPayDsmDo(Integer i)
begin
  Integer wn;
  string 255 pmcode;
  Integer rowstp;
  
  wn = CurWindow;

  pmcode = GetWindowString(wn,"PMCode" & i);
  rowstp = StringToInt(GetWindowString(wn,"rowstp" & i));
  RestPMOtherPayDsm(wn,pmcode,rowstp);
  return;
end;

global
updating procedure RestPMOtherPayDsm1()
begin
  RestPMOtherPayDsmDo(1);
  return;
end;

global
updating procedure RestPMOtherPayDsm2()
begin
  RestPMOtherPayDsmDo(2);
  return;
end;

global
updating procedure RestPMOtherPayDsm3()
begin
  RestPMOtherPayDsmDo(3);
  return;
end;

global
updating procedure RestPMOtherPayDsm4()
begin
  RestPMOtherPayDsmDo(4);
  return;
end;

global
updating procedure RestPMOtherPayDsm5()
begin
  RestPMOtherPayDsmDo(5);
  return;
end;

global
updating procedure RestPMOtherPayDsm6()
begin
  RestPMOtherPayDsmDo(6);
  return;
end;

global
updating procedure RestPMOtherPayDsm7()
begin
  RestPMOtherPayDsmDo(7);
  return;
end;

global
updating procedure RestPMOtherPayDsm8()
begin
  RestPMOtherPayDsmDo(8);
  return;
end;

global
updating procedure RestPMOtherPayDsm9()
begin
  RestPMOtherPayDsmDo(9);
  return;
end;

global
updating procedure RestPMOtherPayDsm10()
begin
  RestPMOtherPayDsmDo(10);
  return;
end;

global
updating procedure RestPMOtherPayDsm11()
begin
  RestPMOtherPayDsmDo(11);
  return;
end;

global
updating procedure RestPMOtherPayDsm12()
begin
  RestPMOtherPayDsmDo(12);
  return;
end;

global
procedure RetentionLineIVDsm()
begin
  Integer wn,nwn;
  record RcVc RepSpec;
  record IVVc IVr;
  
  wn = CurWindow;
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  RepSpec.f1 = IVr.PRCode;
  nwn = OpenWindow("AddPRRetentionDClass",1,wn,"","",RepSpec);  
  return;
end;

global
updating function Boolean AddPRRetentionDClassOnOKWindow(Integer wn)
begin
  record IVVc IVr;
  row IVVc IVrw;
  record VIVc VIr;
  row VIVc VIrw;
  Integer rwcnt,err;
  val retentionv;
  string 255 retentionacc,retentionvatcode;
  record RcVc RepSpec;
  Integer mwn;
  
//  rownr = WindowActiveRow(wn);
  DeselectWindow(wn,false);
  GetWindowRecord(wn,RepSpec);  
  if (blank(RepSpec.f1)) then begin
    err = 1232;
    goto LAddPRRetentionDClassOnOKWindow;
  end;
  
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    DeselectWindow(mwn,false);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        GetWindowRecord(mwn,IVr);
        if (IVr.OKFlag==0) then begin
          IVr.PRCode = RepSpec.f1;
          if (err==0) then begin
            err = IVVc_CalcRetentionLine(IVr,retentionv,retentionacc,retentionvatcode);
          end;
          if (err==0) then begin
            if (retentionv!=0) then begin
              rwcnt = MatRowCnt(IVr);
              ClearRow(IVr,IVrw,kInvoiceRowTypeRetention);
              IVrw.Spec = "";
              IVrw.Sum = retentionv;
              IVrw.SalesAcc = retentionacc;
              IVrw.VATCode = retentionvatcode;
              MatRowPut(IVr,rwcnt,IVrw);
              PutWindowRecord(mwn,IVr);
              if (WindowDoOK(mwn,0)) then begin
              end;        
            end;
          end;
        end;
      case "VIVc":
        GetWindowRecord(mwn,VIr);
        if (VIr.OKFlag==0) then begin
          if (err==0) then begin
            err = VIVc_CalcRetentionLine(VIr,retentionv,retentionacc,retentionvatcode);
          end;
          if (err==0) then begin
            rwcnt = MatRowCnt(VIr);
            ClearRow(VIr,VIrw,kInvoiceRowTypeRetention);
            VIrw.PRCode = RepSpec.f1;
            VIrw.Comment = "";
            VIrw.Sum = retentionv;
            VIrw.AccNumber = retentionacc;
            VIrw.VATCode = retentionvatcode;
//TaxTemplateCode            
            MatRowPut(VIr,rwcnt,VIrw);
            PutWindowRecord(mwn,VIr);
            if (WindowDoOK(mwn,0)) then begin
            end;        
          end;
        end;
    end;
  end;
LAddPRRetentionDClassOnOKWindow:;
  if (err!=0) then begin
    MessageBox(err,"");
  end;
  CloseWindow(wn);
  AddPRRetentionDClassOnOKWindow = false;
  return;
end;

global
updating procedure AddPRRetentionDClassSave()
begin
  DeselectWindow(CurWindow,false);
  AddPRRetentionDClassOnOKWindow(CurWindow);
  return;
end;

global
procedure AddPRRetentionDClassCancel()
begin
  CloseWindow(CurWindow);
  return;
end;

global
updating function Boolean AddWithholdingVClassClassOnOKWindow(Integer wn)
begin
  record IVVc IVr;
  row IVVc IVrw;
  record VIVc VIr;
  row VIVc VIrw;
  Integer rwcnt,err;
  val retentionv;
  string 255 retentionacc;
  record RcVc RepSpec;
  Integer mwn;
  row WHTaxBlock WHTaxrw;
  
//  rownr = WindowActiveRow(wn);
  DeselectWindow(wn,false);
  GetWindowRecord(wn,RepSpec);  
  if (blank(RepSpec.f1)) then begin
    err = 22032;
    goto LAddWithholdingVClassClassOnOKWindow;
  end;
  
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    DeselectWindow(mwn,false);
    GetWindowRecord(mwn,VIr);
    if (VIr.OKFlag==0) then begin
      if (err==0) then begin
        rwcnt = MatRowCnt(VIr);
        ClearRow(VIr,VIrw,kInvoiceRowTypeWithholdingTax);
        VIrw.WHTax = RepSpec.f1;
        GetWHTaxRow(VIrw.WHTax,WHTaxrw);
        VIrw.Comment = "";
        VIrw.AccNumber = WHTaxrw.TmpAccNumber;
        MatRowPut(VIr,rwcnt,VIrw);
        PutWindowRecord(mwn,VIr);
        if (WindowDoOK(mwn,0)) then begin
        end;        
      end;
    end;
  end;
LAddWithholdingVClassClassOnOKWindow:;
  if (err!=0) then begin
    MessageBox(err,"");
  end;
  CloseWindow(wn);
  AddWithholdingVClassClassOnOKWindow = false;
  return;
end;

global
updating procedure AddWithholdingVlassSave()
begin
  DeselectWindow(CurWindow,false);
  AddWithholdingVClassClassOnOKWindow(CurWindow);
  return;
end;

global
procedure AddWithholdingVlassCancel()
begin
  CloseWindow(CurWindow);
  return;
end;

global
updating procedure RestPMOtherPayDsm13()
begin
  RestPMOtherPayDsmDo(13);
  return;
end;

global
updating procedure RestPMOtherPayDsm14()
begin
  RestPMOtherPayDsmDo(14);
  return;
end;

global
updating procedure RestPMOtherPayDsm15()
begin
  RestPMOtherPayDsmDo(15);
  return;
end;

global
updating procedure RestPMOtherPayDsm16()
begin
  RestPMOtherPayDsmDo(16);
  return;
end;

global
updating procedure RestPMOtherPayDsm17()
begin
  RestPMOtherPayDsmDo(17);
  return;
end;

global
updating procedure RestPMOtherPayDsm18()
begin
  RestPMOtherPayDsmDo(18);
  return;
end;

global
updating procedure RestPMOtherPayDsm19()
begin
  RestPMOtherPayDsmDo(19);
  return;
end;

global
updating procedure RestPMOtherPayDsm20()
begin
  RestPMOtherPayDsmDo(20);
  return;
end;

global
updating procedure RestPMOtherPayDsm21()
begin
  RestPMOtherPayDsmDo(21);
  return;
end;

global
updating procedure RestPMOtherPayDsm22()
begin
  RestPMOtherPayDsmDo(22);
  return;
end;

global
updating procedure RestPMOtherPayDsm23()
begin
  RestPMOtherPayDsmDo(23);
  return;
end;

global
updating procedure RestPMOtherPayDsm24()
begin
  RestPMOtherPayDsmDo(24);
  return;
end;

global
updating procedure RestPMOtherPayDsm25()
begin
  RestPMOtherPayDsmDo(25);
  return;
end;

global
procedure TestVatMatrixIVDsmExecute(LongInt arownr)
begin
  record TaxMatrixVc TMr;
  record IVVc IVr;
  row IVVc IVrw;
  longint nwn,wn,rowno;
  
  wn = CurWindow;
  GetWindowRecord(wn,IVr);
  if (arownr<0) then begin
    rowno = WindowActiveRow(wn);
  end;
  
  if (rowno>=0) then begin
    MatRowGet(IVr,rowno,IVrw);
    UnpackRowFieldMatrix(IVrw,"TaxMatrix",TMr);
  end else begin
    UnpackFieldMatrix(IVr,"TaxMatrix",TMr);
  end;
  
  nwn = OpenWindow("TaxMatrixVClass",0,wn,"","",TMr);
  PutWindowString(nwn,"TaxMatrixActiveRow",rowno);
  
  PutWindowRecord(nwn,TMr);
  PutWindowPrevRecord(nwn,TMr);
  SetWindowState(nwn,Rs_normal);
  
  return;
end;

global
procedure TestVatMatrixIVDsm()
begin
  TestVatMatrixIVDsmExecute(-1);
  return;
end;

global
updating procedure IVSendforAcceptanceIVDsmExecute(Integer wn,string acceptanceby,string acceptancefyi)
begin
  Integer err,nwn;
  record IVVc IVr;
  Integer ApproverSelection;
  record RcVc RepSpec;
  
  GetWindowRecord(wn,IVr);
  if (WindowState(wn)!=Rs_normal) then begin
    if (WindowDoOK(wn,0)==false) then begin
      goto LIVSendforAcceptanceIVDsm;
    end;
  end;
  IVr.AcceptanceBy = acceptanceby;
  IVr.AcceptanceFYI = acceptancefyi;
  switch (IVr.AcceptanceStatus) begin
    case kAcceptanceStateNotRequired:
      MessageBox(22404,"");
      goto LIVSendforAcceptanceIVDsm;
    case kAcceptanceStatePending:
      MessageBox(22400,"");
      goto LIVSendforAcceptanceIVDsm;
    case kAcceptanceStateApproved:
      MessageBox(22400,"");
      goto LIVSendforAcceptanceIVDsm;
    case kAcceptanceStateRejected:
      MessageBox(22400,"");
      goto LIVSendforAcceptanceIVDsm;
  end;
  err = SendForAcceptance_IVVc(IVr,RepSpec);
  ApproverSelection = RepSpec.ArtMode;
  if ((ApproverSelection==kAcceptanceApproverSelectionManual) and (blank(IVr.AcceptanceBy))) then begin
    switch (err) begin  
      case 0:
        if (CountObjects(RepSpec.f12)==1) then begin
          RepSpec.f1 = RepSpec.f12;
        end;
        if (CountObjects(RepSpec.f11)==1) then begin
          RepSpec.f2 = RepSpec.f11;
        end;
        nwn = OpenWindow("SelectApproverWClass",0,wn,"","",RepSpec);
      otherwise
        MessageBox(err,"");
    end;
  end else begin
    switch (err) begin  
      case 0:
        PutWindowRecord(wn,IVr);
        if (WindowDoOK(wn,0)) then begin
        end;
      otherwise
        MessageBox(err,"");
    end;
  end;
LIVSendforAcceptanceIVDsm:;  
  return;
end;

global
updating procedure IVSendforAcceptanceIVDsm()
begin
  IVSendforAcceptanceIVDsmExecute(CurWindow,"","");
  return;
end;

global
updating procedure IVCancelApprovalRequest(Integer wn)
begin
  record IVVc IVr;
  Integer err;

  GetWindowRecord(wn,IVr);
  err = CancelApprovalRequestAllowed(kAcceptanceIV,"IVVc",IVr.SerNr,IVr.AcceptanceStatus,IVr.CustCode);
  if (err!=0) then begin
    MessageBox(err,"");
    goto LIVCancelApprovalRequest;
  end;
  IVr.AcceptanceStatus = kAcceptanceStateNotRequested;
  PutWindowRecord(wn,IVr);
  WindowDoOk(wn,0);
LIVCancelApprovalRequest:;
  return;
end;

global
updating procedure GSXAutoEnrollmentIVDsm()
begin
  Integer wn,rownr;
  record GSXSettingsBlock GSb;
  record IVVc IVr;
  row IVVc IVrw;
  string 255 sessionID,errormsg;
  
  wn = CurWindow;
  rownr = WindowActiveRow(wn);
  if (rownr>=0) then begin
    GetWindowRecord(wn,IVr);
  
    BlockLoad(GSb);
    if (GSXLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
      if (GSXAutoEnrollment(sessionID,IVr,rownr,errormsg)) then begin
        PutWindowRecord(wn,IVr);
//      WindowFieldGoto(wn,IVr,0,"PartNumber",true);
      end;
    end;
  
    if (nonblank(errormsg)) then begin
      MessageBox(0,errormsg);
    end;
  end;
  return;
end;

updating procedure AttachGSXNotesToSVOSer(record SVOSerVc SVOSerr,record NotepadVc csNotesr,record NotepadVc Notesr)
begin
  if (SizeTextCnt(csNotesr)>0) then begin
    CreateRecordLink(SVOSerr,CurrentCompany,csNotesr,CurrentCompany);
  end;
  if (SizeTextCnt(Notesr)>0) then begin
    CreateRecordLink(SVOSerr,CurrentCompany,Notesr,CurrentCompany);
  end;
  return;
end;

global
updating procedure WarrantyStatusIVDsm()
begin
  record GSXSettingsBlock GSb;
  integer nwn,wn,rownr;
  date d;
  record SVOSerVc SVOSerr;
  record INVc INr;
  record IVVc IVr;
  row IVVc IVrw;
  record NotepadVc csNotesr,Notesr;
  array string 255 a_partNumbers;
  string 255 sessionID,errormsg;
  record ACPVc ACPr;
  
  wn = CurWindow;
  rownr = WindowActiveRow(wn);
  DeselectWindow(wn,false);
  GetWindowRecord(wn,IVr);
  
  if (rownr<0) then begin
    goto LWarrantyStatusIVDsm;
  end;
  MatRowGet(IVr,rownr,IVrw);
  ACPr.ArtCode = IVrw.ArtCode;
  if (ReadFirstMain(ACPr,1,true)==false) then begin
    MessageBox(23702,"");
    goto LWarrantyStatusIVDsm;
  end;
  if (blank(IVrw.MotherNr)) then begin
    MessageBox(23700,"");
    goto LWarrantyStatusIVDsm;
  end;
  
  SVOSerr.ItemCode = IVrw.ArtCode;
  SVOSerr.SerialNr = IVrw.MotherNr;
  if (ReadFirstMain(SVOSerr,2,true)==false) then begin
    RecordNew(SVOSerr);
    SVOSerr.ItemCode = IVrw.ArtCode;
    SVOSerr.SerialNr = IVrw.MotherNr;
    INr.Code = SVOSerr.ItemCode;
    if (ReadFirstMain(INr,1,true)) then begin
      SVOSerr.ItemName = INr.Name;
    end;
    SVOSerr.CustCode = IVr.CustCode;
    SVOSerr.CustName = IVr.Addr0;
    //TODO: fill in all more of the basics (cost, sold date that we know about, etc)
  end;
  
  BlockLoad(GSb);
  if (GSXLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
    if (GSXWarrantyStatus(sessionID,IVrw.MotherNr,d,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
      RecordStore(SVOSerr,true);
      AttachGSXNotesToSVOSer(SVOSerr,csNotesr,Notesr);      
    end else begin 
      MessageBox(0,errormsg);
    end;
//    if (GSXLogout(sessionID)) then begin StopAlert("logout ok"); end;
  end else begin
    MessageBox(0,errormsg);
    IVrw.MotherNr = "";
    MatRowPut(IVr,rownr,IVrw);
    PutWindowRecord(wn,IVr);
  end;
LWarrantyStatusIVDsm:;
  return;
end;

SetLangMode(LangRussian,"RUS",0);

global
updating procedure SignIVDsm()
begin
  record RcVc RepSpec;
  Integer nwn,wn;
  record IVVc IVr;
  
  wn = CurWindow;
  if (WindowState(wn)!=Rs_insert) then begin
    GetWindowRecord(wn,IVr);
    RepSpec.vals0 = IVr.Sum4;
    nwn = OpenWindow("SignatureWClass",1,wn,"","",RepSpec);
    PutWindowRecord(nwn,RepSpec); //Shouldn't be needed?
  end else begin
    Beep;
  end;
end;




global updating procedure CreatePOfromORDsm()
begin
	integer wn,mtrw;
	record ORVc ORr;
	
	wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    GetWindowRecord(wn,ORr);
    mtrw = matrowcnt(ORr);
    if(mtrw>0 and nonblank(ORr.OrderClass) and ORr.Closed==0)then begin
    	CreatePOfromOR(ORr);
    end else begin
    	Beep;
    	if(blank(ORr.OrderClass))then begin
    		messagebox(0,"   ");
    	end;
    end;
  end else begin
    Beep;
    messagebox(0," ");
  end;

return;
end;

global procedure DblOpenItemHist(string dblstr,string l,Integer currepwn)
begin
record RcVc RepSpec;


	RepSpec.f1 = dblstr;
	RepSpec.f2 = l;
	RepSpec.sStartDate = stringtodate("1/1/2009");
	RepSpec.sEndDate = currentdate;
	RepSpec.repname = "SerialNrRn";
	RunReport(RepSpec,0);
	

return;
end;

global procedure POfromORstatusDsm()
begin
	record RcVc RepSpec;
	integer wn;
	record ORVc ORr;
	
	wn = curwindow;
	getwindowrecord(wn,ORr);
	if(CheckPOFromOR(ORr))then begin
		RepSpec.long1 = ORr.SerNr;
		RepSpec.sStartDate = ORr.OrdDate;
		RepSpec.sEndDate = ORr.OrdDate;
		RepSpec.flags[1] = 1;
		RepSpec.repname = "POFromORstatusRn";
		RunReport(RepSpec,0);
	end else begin
		RepSpec.long1 = ORr.SerNr;
		RepSpec.sStartDate = ORr.OrdDate;
		RepSpec.sEndDate = ORr.OrdDate;
		RepSpec.repname = "POFromORRn";
		RunReport(RepSpec,0);
	end;
	
return;
end;



global
procedure DblMBA(string dblstr,string l,Integer currepwn)
begin
	record AccVc Accr;
	boolean TrHs,testf,first;
	integer lenth;
	string 20 facc,lacc;
	record RcVc RepSpec,RcVcr1;
	
	getwindowrecord(currepwn,RcVcr1);
	
	lenth = len(l);
  Accr.AccNumber = l;
  TrHs = true;
  while(loopmain(Accr,1,TrHs))begin
  	if(left(Accr.AccNumber,lenth)!=l)then begin TrHs = false; end;
  	
  	if(TrHs)then begin
  		if(!first)then begin
  			facc = Accr.AccNumber;
  			first = true;
  		end;
  		lacc = Accr.AccNumber;
  	end;
  end;
		
		ReportDefaults(RepSpec,"MBARClass");    
		RepSpec.sStartDate = RcVcr1.sStartDate;
		RepSpec.sEndDate = RcVcr1.sEndDate;
		RepSpec.ObjStr = RcVcr1.ObjStr;
		RepSpec.AccStr = facc & ":" & lacc;
    RepSpec.repname = "MBA2Rn";
    RunReport(RepSpec,0); 
  
  return;
end;

global
procedure DblMyNL(string dblstr,string l,Integer currepwn)
begin
	record AccVc Accr;
	boolean TrHs,testf,first;
	integer lenth;
	string 20 facc,lacc;
	record RcVc RepSpec,RcVcr1;
	integer wn;
	
		getwindowrecord(currepwn,RcVcr1);

		ReportDefaults(RepSpec,"ObjMainRClass");   
		//OpenWindow("ObjMainRClass",0,0,"","",RepSpec);
		wn = curwindow;
		
		//messagebox(0,RcVcr1.sStartDate);
		RepSpec.sStartDate = RcVcr1.sStartDate;
		RepSpec.sEndDate = RcVcr1.sEndDate;
		RepSpec.Period2Str = RcVcr1.sStartDate & ":" & RcVcr1.sEndDate;
		RepSpec.ObjStr = RcVcr1.ObjStr;
		RepSpec.f4 = dblstr;
		RepSpec.Media = mtScreen;
    RepSpec.repname = "ObjMainRn";

    //PutWindowRecord(wn,RepSpec);
    
    //WindowFieldGoto	(wn,RepSpec,-1,"ObjType",true)
    RunReport(RepSpec,0); 
  
  return;
end;

global updating procedure CreatePUfromIV(record IVVc IVr)
begin
	integer i,pos,rownum;
	Record PUVc PUr;
	record INVc INr;
	boolean foundf;
	record CUVc CUr;
	Integer wn;
				
	recordnew(PUr);
	
	PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,-1,false,""); 
	PUr.Location = IVr.Location;
	PUr.Comment = "  . " & IVr.MachineName;
	
	//recordStore(PUr,false);
	
	wn = OpenWindow("PUDClass",0,0,"","",PUr);
  deselectwindow(wn,false);
	
return;
end;

global updating procedure CreatePUfromIVDsm()
begin
	integer wn,mtrw;
	record IVVc IVr;
	record PUVc PUr;
	
	wn = CurWindow;
  GetWindowRecord(wn,IVr);
  CreatePUfromIV(IVr);

return;
end;

global updating procedure CreateSDfromIV(record IVVc IVr, String param, String buttonName)
begin
	integer i,pos,rownum;
	Record SDVc SDr;
	record INVc INr;
	boolean foundf;
	record CUVc CUr;
	Integer wn;
	record LocationVc Locationr;
	
	recordnew(SDr);
	
	SDr.SerNr = NextSerNr("SDVc",SDr.TransDate,-1,false,""); 
	SDr.Location = IVr.Location;
	

	
	//messagebox(0, "IVr.MachineName = " & IVr.MachineName);
	SDr.Comment = buttonName & " " & IVr.MachineName;
	SDr.CostAcc = FirstInRange(param,10);
	Locationr.Code = SDr.Location;
	if(readfirstmain(Locationr,1,true))then begin
		if(nonblank(Locationr.Objects))then begin
			SDr.Objects = Locationr.Objects;
		end;
	end;
	if(blank(SDr.Objects))then begin
		SDr.Objects = LastInRange(param,10);
	end else begin
		SDr.Objects = SDr.Objects & "," & LastInRange(param,10);
	end;
	//recordStore(SDr,false);
	
	wn = OpenWindow("SDDClass",0,0,"","",SDr);
  deselectwindow(wn,false);
	
return;
end;

global updating procedure CreateSDfromIVDsm(String param, String buttonName)
begin
	integer wn,mtrw;
	record IVVc IVr;
	record SDVc SDr;
	
	wn = CurWindow;
  GetWindowRecord(wn,IVr);
  CreateSDfromIV(IVr, param, buttonName);

return;
end;

global
procedure ExportInvoiceToExcelDsm()	//Edit----------------------Dima  04.03.2015
begin
  record IVVc IVr;
  record RcVc RepSpec;
  integer wn;

  wn = CurWindow;
  GetWindowRecord(wn,IVr);
  if(WindowState(wn)==Rs_normal)then begin
		RepSpec.Media = mtExcel;
		RepSpec.repname = "ExportInvoiceToExcelRn";
		RepSpec.flags[0] = wn;
		RepSpec.long1 = IVr.SerNr;
		RunReport(RepSpec,0);
  end else begin
  	messagebox(0," /   ");
  end;

  
return;
end;

global
procedure OpenCUDsm()	//Edit----------------------Dima  04.03.2015
begin
  record IVVc IVr;
  record CUVc CUr;
  integer wn,nwn;

  wn = CurWindow;
  GetWindowRecord(wn,IVr);
  CUr.Code = IVr.CustCode;
  if (ReadFirstMain(CUr,1,true)) then begin
    nwn = OpenWindow("CUDClass",1,0,"","",CUr);
  end else begin
  	messagebox(0,"  ");
  end;

  
return;
end;

global
procedure OpenSearchContactRnDsm()
begin
  record RcVc RepSpec;
  integer wn,nwn;

  nwn = OpenWindow("SearchContactRClass",0,0,"","",RepSpec);
  DeselectWindow(nwn,false);
  ReportDefaults(RepSpec,"SearchContactRClass");
  RepSpec.repname = "SearchContactRn";
  RepSpec.critname = "SearchContactRClass";
  RepSpec.Media = mtScreen;
  PutWindowRecord(nwn,RepSpec);  
  WindowFieldGoto(nwn,RepSpec,-1,"f1",true);
  
return;
end;

global //Edit***************************Sasha2,16:30 28.08.2017 {
procedure OpenClientCashbackStatusRnDsm()
begin
  record IVVc IVr;
  record RcVc RepSpec;
  integer wn,nwn;

  //nwn = OpenWindow("ClientCashbackStatusRClass",0,0,"","",RepSpec);
  //DeselectWindow(nwn,false);
  wn = curwindow;
  if (GetWindowFileName(wn)=="IVVc") then begin
    GetWindowRecord(wn,IVr);
    ReportDefaults(RepSpec,"ClientCashbackStatusRClass");
    RepSpec.f1 = IVr.CustCode;
    RepSpec.repname = "ClientCashbackStatusRn";
    RepSpec.critname = "ClientCashbackStatusRClass";
    RepSpec.Media = mtScreen;
    RunReport(RepSpec,0);
  end;
  
  
return;
end; //Edit***************************Sasha2,16:30 28.08.2017 }