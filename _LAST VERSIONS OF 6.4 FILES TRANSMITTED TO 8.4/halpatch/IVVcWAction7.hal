remote procedure IVVc_PasteCUPNr(var record IVVc,Integer);
external updating function Boolean GSXResellerCancelAutoEnrollment(record GSXSettingsBlock,string,record IVVc,Integer,var string);
external updating function Boolean GSXResellerAutoEnrollment(record GSXSettingsBlock,string,record IVVc,Integer,var string);
external function Boolean GSXResellerWarrantyStatus(string,record IVVc,Integer,array string,integer,var record SVOSerVc,var record NotepadVc,var record NotepadVc,var string);
external function boolean GSXWarrantyStatus(string,string,date,array string,integer,var record SVOSerVc,var record NotepadVc,var record NotepadVc,var string);
external updating function boolean GSXResellerLogin(string,string,string,var string,var string);
external procedure OpenCashDrawer_IVVc(record IVVc);
external procedure TouchScreenXReading;
external procedure POSMoneyInsm;
external procedure POSMoneyOutsm;
external procedure POSManagersAction(Integer,string);
external procedure RunReportOnServer(string);
external updating procedure OpenPOSSessionsm;
external updating procedure ClosePOSSessionsm;
external procedure IVCashCashupRnsm;
external procedure DisplayIVItem(record IVVc,Integer);
remote procedure IVVc_PastePayDeal(var record IVVc,string,string);
external procedure IVDClassToolIVReturn();
external updating procedure PrintIVReceiptDsm();
external function Boolean IVDClassPrint(Integer,Boolean);
external procedure IVDClassOpenCalendar();
external procedure IVDClassNewActivity();
external updating procedure CreateCreditNoteIVDsm();
external procedure TestVatMatrixIVDsmExecute(LongInt);
external updating procedure CreateMailFromIVDsm();
external procedure DoCLInFromIVD();
external procedure PrintProformaIVDsm();
external updating procedure PrintToFiscPrntIVDsm();
external procedure OpenTRFromIV();
external procedure IVInfoIVDsm();
external procedure AddInvoiceLineType(Integer,Integer ,Boolean);
external procedure RecalcIVSubtotal(var record IVVc);
external procedure HiddenLineIVDsm();
external procedure IVDClassOnWindowRecordChange(Integer);
external function Boolean IVDClassOnOverStrike(Integer,Integer);
external function Boolean IVDClassDeleteRowTest(Integer,Integer);
external procedure OpenNPTSPaymentTClass(Integer,LongInt,val,val,string);
external function Boolean TouchScreenLook();
remote updating function LongInt IVVcRecordCheck(record IVVc,record IVVc,LongInt,LongInt);
external updating procedure IVDClassTouchScreenButtonLogin();
remote function Boolean ReadFirstItem(string,var record INVc,Boolean,Boolean);
external function Boolean IVPrintReceipt(Integer,var record IVVc,var record IVVc,Integer,Boolean,Boolean,Integer,Integer);
remote function Integer CalculateLoyaltyPointsPayment_IVVc(record IVVc,val,var val,var val,var val);
external procedure CredCardIVsmExecute(string,string);
external procedure OpenDCPayTouchScreenDClass(Integer,Integer,LongInt,val,val,val,string,string,string);
external procedure OpenCCPayTouchScreenDClass(Integer,Integer,LongInt,val,val,val,string,string,string);
external procedure OpenChequePayTouchScreenDClass(Integer,Integer,LongInt,val,val,string,string,string);
external procedure OpenGiftVoucherSalesTouchScreenDClass(Integer,string,string);
external procedure OpenNPTSCashPaymentTClass(Integer,LongInt,val,val,string,string,string);
external procedure OpenGiftVoucherTouchScreenDClass(Integer,Integer,LongInt,val,val,string,string,string);
external procedure SetPOSWindowDisplay(string,string);
external procedure M4PadString(string,Integer,string,Boolean,var string);
remote procedure IVSumup(var record IVVc,Boolean);
external function integer GetSelectedPOSItemRowIndex(integer);
external procedure NPTSSearchItemExecute(Integer);
remote function Boolean IVVc_PasteQuantity(record IVVc,Integer);
external procedure IVDClass_RefreshStringList(Integer,record IVVc);
remote function Boolean IVVc_PasteArtCode(var record IVVc,Integer,var string,var string,Boolean,var Integer);
external function boolean POSButtonsForWindow(integer,var record POSButtonsVc);
external procedure ExtractObj(string,var Integer,var string);
external remote function string 255 GetINImageAttach(string);
external procedure PasteRetItemIVDsm();// Edit ************************** Wednesday, 5 December 2012 11:44:46
external procedure PasteSpecialRebateItemIVDsm();// Edit ************************** Thursday, 2 May 2013 11:45:53
external updating procedure ProceedLoyaltyPaymentNPTSSClassExecuteMy(Integer);
external remote function string 255 GetClassString(string);// Edit ************************** Thursday, 9 May 2013 16:59:59
external remote function string 255 GetPriceString(string,string,string);// Edit ************************** Thursday, 9 May 2013 16:59:59
external remote procedure GetTwoStrings(string,string,string,var string,var string,string);// Edit ************************** Thursday, 9 May 2013 17:27:58
remote procedure IVVc_PasteLocation(var record IVVc,Integer);// Edit ************************** Wednesday, 17 September 2014 14:55:33
external updating procedure CreatePUfromIVDsm(); //Edit***************************Sasha2,10:56 11.12.2014
external updating procedure CreateSDfromIVDsm(String,String); //Edit***************************Sasha2,10:56 11.12.2014
remote procedure IVDUpdatePrices(var record IVVc,Boolean);
remote function string 255 SaboPromotion(var record IVVc,string); //Edit***************************Sasha2,13:19 01.06.2016
remote procedure SendToServerArtCode(string,string,string,integer); //Edit***************************Sasha2,15:20 27.04.2017
remote procedure IVDchsum(var record IVVc,Integer);// Edit ************************** Tuesday, 16 May 2017 14:06:35
external function Boolean IVDchrsum(var record IVVc,Integer); //Edit***************************Sasha2,16:46 01.06.2016
remote function Boolean ORVc_PasteArtCode(var record ORVc,Integer,var string,var string,Boolean);
remote procedure ORVc_PasteQuant(var record ORVc,Integer,Boolean,var Boolean);
remote procedure ORDchsum(var record ORVc,Integer);
remote procedure ORSumup(var record ORVc);
external procedure OpenGCBCardckIssueTouchScreenDClass(); //Edit***************************Sasha2,17:30 11.08.2017
remote procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);// Edit ************************** Friday, 20 October 2017 15:15:28

enum begin
  kPOSButtonTypeGoodsReturn = 100,
  kPOSButtonTypeSpecialRebate = 101,
  kPOSButtonTypeUndeclared = 102, //?????????????????
  kPOSButtonTypeNewCustomer = 103,
  kPOSButtonTypeCreateShotSDVc = 104,
  kPOSButtonTypeCreateShotPUVc = 105,
  kPOSButtonTypeOpenCustomAllInvoices = 106,
  kPOSButtonTypeOSashaChtotoDelal = 107,
  kPOSButtonTypeGetBirthRebate = 108,
  kPOSButtonTypeIssueCBLoyaltyCard = 109,
  kPOSButtonTypeTAXBackRet = 110
end;

function string 200 ParseClassification(string class)
begin
	string 200 res,cl;
	record DIVc DIr;
	integer pos;
	
	pos = 0;
	ExtractObj(class,pos,cl);
	DIr.Code = cl;
	if(readfirstmain(DIr,1,true))then begin
	res = DIr.Name;
	end;
  while (nonblank(cl)) begin
    ExtractObj(class,pos,cl);
    DIr.Code = cl;
  	if(readfirstmain(DIr,1,true))then begin
  		res = res & "	" & DIr.Name;
  	end;	
  end;
	
	ParseClassification = res;
return;
end;


procedure NPTSIVOpenLClassOpenExecute(Integer wn)
begin
  record IVVc IVr;
  Integer nwn;
  
  if (ReadMarkedRecord(wn,IVr)) then begin
    CloseWindow(MotherWindow(wn));
//    CloseWindow(wn); 
    nwn = OpenWindow("IVDClass",1,0,"","",IVr);
  end;
  return;
end;

global 
procedure NPTSIVOpenLClassOpen()
begin
  Integer wn,nwn;
  
  wn = CurWindow;  
  NPTSIVOpenLClassOpenExecute(wn);
  return;
end;

global
function Boolean NPTSIVOpenLClassOnOKWindow(integer wn)
begin
  Boolean res,testf;
  string 255 WinSearchField;  

  WinSearchField = GetWindowString(wn,"WinSearchField");
  testf = true;
  switch (WindowState(wn)) begin
    case Rs_search: testf = false;
  end;
  if (testf) then begin
    NPTSIVOpenLClassOpenExecute(wn);
    res = false;
  end else begin
    res = true;
  end;
  NPTSIVOpenLClassOnOKWindow = res;
  return;
end;

function Integer HashTouchScreenPageCode(string tstr)
begin
  LongInt sum;
  Integer i,res;
  
 sum = 0;
  for (i=0;i<len(tstr);i=i+1) begin
    sum = sum + asc(Mid(tstr,i,1));
  end;
  res = BitAnd(sum,65536-1);
  HashTouchScreenPageCode = res;
  return;
end;

global
procedure IVDClassLevelTopExecute(Boolean rerunwdf)
begin
  Integer page,wn;
  
  wn = CurWindow;
  page = StringToInt(GetWindowString(wn,"touchscreenwindowpage"));
  PutWindowString(wn,"touchscreenwindowpageprevious",page);  
  ActivateTile(wn,1);
  PutWindowString(wn,"touchscreenwindowpage",1)
  PutWindowString(wn,"touchscreenwindowpagestack",1);
  PutWindowString(wn,"touchscreenwindowprinterstack","*");
  if (rerunwdf) then begin
    ReRunWindowDef(wn);
  end;
  SetWindowSubset(wn,GetWindowSubset(wn));
  return;
end;

global
procedure IVDClassLevelTop()
begin
  IVDClassLevelTopExecute(true);
  return;
end;

global
procedure IVDClassLevelUp()
begin
  Integer page,wn,levelup;
  
  wn = CurWindow;
  levelup = StringToInt(GetWindowString(wn,"touchscreenwindowpageprevious"));  
  page = StringToInt(GetWindowString(wn,"touchscreenwindowpage"));
  PutWindowString(wn,"touchscreenwindowpageprevious",levelup);  
  PutWindowString(wn,"touchscreenwindowpagestack",levelup);
  //touchscreenwindowprinterstack
  ActivateTile(wn,levelup);
  PutWindowString(wn,"touchscreenwindowpage",levelup);
  switch (GetWindowClass(wn)) begin
    case "IVDClass":
      ReRunWindowDef(wn);
  end;
  SetWindowSubset(wn,GetWindowSubset(wn));
  return;
end;

global
procedure IVDClassLevelDown()
begin
  /*
  Integer page,wn;
  
  wn = CurWindow;
  page = StringToInt(GetWindowString(wn,"touchscreenwindowpage"));
  PutWindowString(wn,"touchscreenwindowpageprevious",page);
  page = page + 1;
  ActivateTile(wn,page);
  PutWindowString(wn,"touchscreenwindowpage",page);
  SetWindowSubset(wn,GetWindowSubset(wn));
  */
  return;
end;

global
procedure IVDClassGotoPage(string pagestr,string printer)
begin
  Integer page,wn,sline;
  string 255 stack;
  string 255 prstack;
  
  wn = CurWindow;
  page = StringToInt(pagestr);
  
  sline = SelectedListLine(wn);

  //page = StringToInt(GetWindowString(wn,"touchscreenwindowpage"));
  stack = GetWindowString(wn,"touchscreenwindowpagestack");
  stack = stack & "," & page;
  PutWindowString(wn,"touchscreenwindowpagestack",stack);
  
  prstack = GetWindowString(wn,"touchscreenwindowprinterstack");
  if (printer=="") then begin
    prstack = prstack & ",*";
  end else begin
    prstack = prstack & "," & printer;
  end;
  PutWindowString(wn,"touchscreenwindowprinterstack",stack);
  
  //ActivateTile(wn,page);
  PutWindowString(wn,"touchscreenwindowpage",page);
  SetWindowSubset(wn,GetWindowSubset(wn));
  switch (GetWindowClass(wn)) begin
    case "IVDClass":
      ReRunWindowDef(wn);
  end;  
  SetSelectedListLine(wn,sline);
  return;
end;

global
function Boolean IVRowAlreadyVoided(var record IVVc IVr,Integer rownr)
begin
  Boolean res;
  row IVVc IVrw;
  Integer i,rwcnt;
  
  rwcnt = MatRowCnt(IVr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(IVr,i,IVrw);
    if (IVrw.VoidedRowNr==rownr) then begin
      res = true;
      goto LIVRowAlreadyVoided; 
    end;
  end;
LIVRowAlreadyVoided:;  
  IVRowAlreadyVoided = res;
  return;
end;

global
function Boolean IVDClassVoidRow(var record IVVc IVr,Integer rownr)
begin
  Boolean res;
  row IVVc IVrw;
  record LocalMachineBlock LMb;
  
  res = false;
  MatRowGet(IVr,rownr,IVrw);
  if (IVrw.stp==kInvoiceRowTypeNormal) then begin
    if (IVRowAlreadyVoided(IVr,rownr)==false) then begin
      BlockLoad(LMb);
      IVrw.ovst = 1;
      MatRowPut(IVr,rownr,IVrw);
      if (LMb.IncrementalReceiptPrinting!=0) then begin
        IVrw.ovst = 0;
        IVrw.stp = kInvoiceRowTypeVoid;
        IVrw.VoidedRowNr = rownr;
        IVrw.VoidedSign = CurrentUser;
        IVrw.Quant = -IVrw.Quant;
        MatRowPut(IVr,MatRowCnt(IVr),IVrw);
      end else begin
        ClearRow(IVr,IVrw,kInvoiceRowTypeUpdateMark);
        IVrw.ovst = 0;
        IVrw.stp = kInvoiceRowTypeUpdateMark;
        IVrw.VoidedRowNr = rownr;
        IVrw.VoidedSign = CurrentUser;
        MatRowPut(IVr,MatRowCnt(IVr),IVrw);
      end;
      IVSumup(IVr,true);
      res = true;
    end;
  end;
  IVDClassVoidRow = res;
  return;
end;

global
function Boolean IVDClasstouchscreenitemEFAfter(Integer wn,Integer pastewn,Boolean changedf)
begin  
  string 255 inwarning;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  string 255 location,tstr;
  Integer rownr;
  LongInt printrownr;
  record LocalMachineBlock LMb;
  Integer sernrf;
  Integer nwn;
  record RcVc RepSpec;
  boolean res;
  Integer suspended;
  string 100 val001;// Edit ************************** Thursday, 11 October 2012 14:58:10
  
  
  res = true;
  
  if (changedf) then begin
    BlockLoad(LMb);
    suspended = StringToInt(GetWindowString(wn,"Suspended"));
    val001 = GetWindowString(wn,"touchscreenitemserialnr");// Edit ************************** Thursday, 11 October 2012 14:58:09
    GetWindowRecord(wn,IVr);
    GetPrevWindowRecord(wn,prevIVr);
    if (IVr.OKFlag!=0) then begin goto LIVDClasstouchscreenitemEFAfter; end;
    if (IVr.Invalid!=0) then begin goto LIVDClasstouchscreenitemEFAfter; end;
    IVr.Suspended = suspended;
    ClearRow(IVr,IVrw,1);
    IVrw.ArtCode = GetWindowString(wn,"touchscreenitem");
    
    rownr = MatRowCnt(IVr);
    MatRowPut(IVr,rownr,IVrw);
    if (IVVc_PasteArtCode(IVr,rownr,inwarning,inwarning,TouchScreenLook,sernrf)) then begin
      if (nonblank(inwarning)) then begin
        MessageBox(0,inwarning);
      end;
      MatRowGet(IVr,rownr,IVrw);
      IVrw.Quant = 1;
      IVrw.SerialNr = val001;
      MatRowPut(IVr,rownr,IVrw);
      tstr = SaboPromotion(IVr,"paste"); //Edit***************************Sasha2,13:36 01.06.2016 {
      if (NonBlank(tstr)) then begin
        MessageBox(0,tstr);
      end; //Edit***************************Sasha2,13:36 01.06.2016 }
      IVVc_PasteQuantity(IVr,rownr);
      MatRowGet(IVr,rownr,IVrw);
      PutWindowString(wn,"touchscreenitemname",IVrw.Spec);
      PutWindowString(wn,"touchscreenitemqty",IVrw.Quant);
      PutWindowString(wn,"touchscreenitemprice",IVrw.Price);
      IVSumup(IVr,true);
//      IVSumupSoftEditFields(wn,IVr);
      PutWindowRecord(wn,IVr);
      IVDClass_RefreshStringList(wn,IVr);
      DisplayIVItem(IVr,rownr);
/*
      if (LMb.IncrementalReceiptPrinting!=0) then begin
        printrownr = StringToLongInt(GetWindowString(wn,"touchscreenitemlastrownr"));
        if (printrownr>=0) then begin
          if (IVCashPrintReceipt(wn,IVCashr,prevIVCashr,printrownr,false,false,LMb.IncrementalReceiptPrinting,WindowState(wn))) then begin
          end;
        end;
      end;
      PutWindowString(wn,"touchscreenitemlastrownr",rownr);
*/
      PutWindowString(wn,"ivcashcommandlastitemsernrf","");
      if(blank(val001))then begin
        if (sernrf==1) or (sernrf==2)  then begin
          PutWindowString(wn,"ivcashcommandlastitemsernrf","true");
          RepSpec.long1 = rownr;
          res = false;
          if (pastewn>0) then begin
            // CloseWindow(pastewn);
            // nwn = 
            ReOpenWindow(pastewn,"SerialNoScanNPTSSClass",0,wn,"","",RepSpec);
          end else begin
            nwn = OpenWindow("SerialNoScanNPTSSClass",0,wn,"","",RepSpec);
          end;
          goto LIVDClasstouchscreenitemEFAfter;
        end;
      end;
    end;
  end;
  SetWindowNameArg(wn,IVrw.ArtCode & ":" & location);
  if (TouchScreenLook) begin
    WindowFieldGoto(wn,IVr,-1,"ivcashcommand",false);
  end;
LIVDClasstouchscreenitemEFAfter:;  
  IVDClasstouchscreenitemEFAfter = true;
  return;
end;

global
procedure IVDClassTouchScreenLoyaltyCard()
begin
  Integer wn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    wn = OpenWindow("LoyalCardNPTSSClass",0,mwn,"","",RepSpec);
//    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
procedure IVDClassTouchScreenReprint()
begin
  Integer wn;
  record IVVc IVr;
  record IVVc prevIVr;
  
  wn = CurWindow;
  if (UserCanAction("AllowNPTSReprint",UseAppStoreEnabler==true)==false) then begin
    POSManagersAction(wn,"Reprint");
    goto LIVDClassTouchScreenReprint;
  end;
  GetWindowRecord(wn,IVr);
  if (IVr.OKFlag!=0) then begin
    GetPrevWindowRecord(wn,prevIVr);
    IVPrintReceipt(wn,IVr,prevIVr,-1,false,false,0,WindowState(wn));
  end;
  OverrideLogout;
LIVDClassTouchScreenReprint:;
  return;  
end;

global 
procedure IVDClassTouchScreenOpenInvoices()
begin
  Integer wn,nwn;
  record IVVc IVr;
  record UserVc Userr;
  string 255 subset;

  Userr.Code = CurrentUser;
  ReadFirstMain(Userr,1,true);
  switch (Userr.limitedAccess) begin
    case 1: subset = Userr.Code;
    case 2: subset = Userr.SalesGroup;
  end;
  wn = CurWindow;
  nwn = OpenWindow("NPTSIVOpenLClass",1,wn,subset,"",IVr);  
  return;
end;

global 
procedure IVDClassTouchScreenXReading()
begin
  TouchScreenXReading;
  return;
end;

// Edit Start ---------------------------------------------- Edit Start
	//Friday, 30 August 2013 14:03:19
	
global
procedure CUNPTSSClassNewCustomerMy()
begin
  Integer wn,mwn,nwn;
  record CUVc CUr;
  
  if (UserCanAction("AllowNewCustomerfromNPTS",true)) then begin
    wn = CurWindow;
    mwn = MotherWindow(wn);
    RecordNew(CUr);
    if(currentcompany==1)then begin
			CUr.CUType = 0;// Edit ************************** Thursday, 24 October 2013 16:05:43
    end;
    nwn = OpenWindow("CUNPTDSClass",1,mwn,"","",CUr);
    WindowFieldGoto(nwn,CUr,-1,"Name",true);
  end else begin
    MessageBox(1274,StringFromStringSet(3,"AllowNewCustomerfromNPTS"));
  end;
  
  return;
end;

	// Edit End ---------------------------------------------- Edit End
	
global 
procedure IVDClassTouchScreenAllInvoices()
begin
  Integer wn,nwn;
  record IVVc IVr;
  record UserVc Userr;
  string 255 subset;

  Userr.Code = CurrentUser;
  ReadFirstMain(Userr,1,true);
  switch (Userr.limitedAccess) begin
    case 1: subset = Userr.Code;
    case 2: subset = Userr.SalesGroup;
  end;
  wn = CurWindow;
  nwn = OpenWindow("IVLClass",1,wn,subset,"",IVr);  
  return;
end;

global //Edit***************************Sasha2,16:23 23.12.2014 {
function Boolean IV1LClassOnOKWindow(Integer wn)
begin
  Integer nwn,mwn; 
  record IVVc IVr;

  mwn = MotherWindow(wn);
  if (ReadMarkedRecord(wn,IVr)) then begin
  	 CloseWindow(wn);
  	nwn = OpenWindow("IV1DClass",0,mwn,"","",IVr);
  	UpdateBrowses("IVVc");
  end;

  IV1LClassOnOKWindow = false;
  return;
end; //Edit***************************Sasha2,16:23 23.12.2014 }

global  //Edit***************************Sasha2,15:45 23.12.2014 {
procedure OpenCustomAllInvoices()
begin
  Integer wn,nwn;
  record IVVc IVr;
  record UserVc Userr;
  string 255 subset;

  Userr.Code = CurrentUser;
  ReadFirstMain(Userr,1,true);
  switch (Userr.limitedAccess) begin
    case 1: subset = Userr.Code;
    case 2: subset = Userr.SalesGroup;
  end;
  wn = CurWindow;
  nwn = OpenWindow("IV1LClass",1,wn,subset,"",IVr);  
  return;
end; //Edit***************************Sasha2,15:45 23.12.2014 }
// Edit Start ---------------------------------------------- Edit Start
	//Tuesday, 16 May 2017 14:22:09
	
global procedure GetBirthRebateDsm() begin
	Integer wn,nwn,i;
  record IVVc IVr;
  row IVVc IVrw;
  record UserVc Userr;
  string 255 subset;
  integer mtrw,rwcnt;
  string 50 artcode;
  Integer sernrf;
  string 255 inwarning,warning;
  record BirthdayRebateBlock BRb;
  date startdate,enddate;
  date birthmin,birth,mirthmax;
  val lastquant; 
  record CUVc CUr;
  boolean notused;
  record RebVc Rebr;
  
	blockload(BRb);
	
	wn = CurWindow;
	getwindowrecord(wn,IVr);
	CUr.Code = IVr.CustCode;
	
	Rebr.Code = IVr.RebCode;
	if(readfirstmain(Rebr,1,true))then begin

	end;
	
	if(readfirstmain(CUr,1,true))then begin
		startdate = addday(IVr.InvDate,-BRb.DayBefore);
		enddate = addday(IVr.InvDate,BRb.DayAfter);
		
		notused = true;
		if(getyear(CUr.BirthRebateLastDate)==getyear(IVr.InvDate))then begin
			messagebox(35102,CUr.BirthRebateInComp & " invoice # " & CUr.BirthRebateTransNr);
			notused = false;
		end;
		if(notused)then begin
			if(IVr.OKFlag==0)then begin
				birthmin = stringtodate(getday(CUr.BirthDate) & "/" & getmonth(CUr.BirthDate) & "/" & getyear(CurrentDate)-1);
				birth = stringtodate(getday(CUr.BirthDate) & "/" & getmonth(CUr.BirthDate) & "/" & getyear(CurrentDate));
				mirthmax = stringtodate(getday(CUr.BirthDate) & "/" & getmonth(CUr.BirthDate) & "/" & getyear(CurrentDate)+1);
			
				if(((birthmin>=startdate and birthmin<=enddate) or (birth>=startdate and birth<=enddate) or (mirthmax>=startdate and mirthmax<=enddate)) or usercanaction("GetBirthRebateAnyway",false))then begin 	
					if(BRb.PrcRebate!=0)then begin
						mtrw = matrowcnt(IVr);
						For(i=0;i<mtrw;i=i+1) begin
							matrowget(IVr,i,IVrw);
							if(nonblank(IVrw.ArtCode) and IVrw.stp==1 and IVrw.vRebate==Rebr.vra0)then begin
								lastquant = IVrw.Quant;
								IVVc_PasteArtCode(IVr,i,inwarning,warning,TouchScreenLook,sernrf);
								matrowget(IVr,i,IVrw);
								IVrw.Quant = lastquant;
								matrowput(IVr,i,IVrw);
								IVVc_PasteQuantity(IVr,i);										
								matrowget(IVr,i,IVrw);
								if(IVrw.vRebate==Rebr.vra0)then begin
									IVrw.vRebate = (1-(100-IVrw.vRebate)/100*(100-BRb.PrcRebate)/100)*100;
									IVrw.UsedBirthRebate = 1;
									IVr.UsedBirthRebateH = 1;
								end;
								matrowput(IVr,i,IVrw);
								IVDchrsum(IVr,i);
								IVDchsum(IVr,i);
							end;
						end;
						IVSumup(IVr,true);
						putwindowrecord(wn,IVr);
						IVDClass_RefreshStringList(wn,IVr);
					end;
				end else begin
					messagebox(35101,"");
				end;
			
				//DisplayIVItem(IVr,rownr);
			end;
		end;
	end;
	
return;
end;

global procedure GetTAXBackRetDsm() begin
	Integer wn,nwn,i;
  record IVVc IVr;
  row IVVc IVrw;
  record UserVc Userr;
  string 255 subset;
  integer mtrw,rwcnt;
  string 50 artcode;
  Integer sernrf;
  string 255 inwarning,warning;
  record BirthdayRebateBlock BRb;
  date startdate,enddate;
  date birthmin,birth,mirthmax;
  val lastquant; 
  record CUVc CUr;
  boolean notused;
  record RebVc Rebr;
  
	//blockload(BRb);
	BRb.PrcRebate = 18;
	wn = CurWindow;
	getwindowrecord(wn,IVr);
	CUr.Code = IVr.CustCode;
	
	Rebr.Code = IVr.RebCode;
	if(readfirstmain(Rebr,1,true))then begin

	end;
	
	if(readfirstmain(CUr,1,true))then begin
		
		notused = true;

		if(notused)then begin
			if(IVr.OKFlag==0)then begin
			
				if(true)then begin 	
					if(BRb.PrcRebate!=0)then begin
						mtrw = matrowcnt(IVr);
						For(i=0;i<mtrw;i=i+1) begin
							matrowget(IVr,i,IVrw);
							if(nonblank(IVrw.ArtCode) and IVrw.stp==1 and IVrw.Quant<0)then begin
								lastquant = IVrw.Quant;
								IVVc_PasteArtCode(IVr,i,inwarning,warning,TouchScreenLook,sernrf);
								matrowget(IVr,i,IVrw);
								IVrw.Quant = lastquant;
								matrowput(IVr,i,IVrw);
								IVVc_PasteQuantity(IVr,i);										
								matrowget(IVr,i,IVrw);
								if(IVrw.vRebate==Rebr.vra0)then begin
									IVrw.vRebate = (1-(100-IVrw.vRebate)/100*(100-BRb.PrcRebate)/100)*100;
									IVrw.UsedBirthRebate = 1;
									IVr.UsedBirthRebateH = 1;
								end;
								matrowput(IVr,i,IVrw);
								IVDchrsum(IVr,i);
								IVDchsum(IVr,i);
							end;
						end;
						IVSumup(IVr,true);
						putwindowrecord(wn,IVr);
						IVDClass_RefreshStringList(wn,IVr);
					end;
				end else begin
					//messagebox(35101,"");
				end;
			
				//DisplayIVItem(IVr,rownr);
			end;
		end;
	end;
	
return;
end;


global procedure GetBirthRebateORDsm() begin
	Integer wn,nwn,i;
  record ORVc ORr;
  row ORVc ORrw;
  record UserVc Userr;
  string 255 subset;
  integer mtrw,rwcnt;
  string 50 artcode;
  Integer sernrf;
  string 255 inwarning,warning;
  record BirthdayRebateBlock BRb;
  date startdate,enddate;
  date birthmin,birth,mirthmax;
  val lastquant; 
  record CUVc CUr;
  boolean notused,chsum;
  record RebVc Rebr;
  
	blockload(BRb);
	
	wn = CurWindow;
	getwindowrecord(wn,ORr);
	CUr.Code = ORr.CustCode;
	
	Rebr.Code = ORr.RebCode;
	if(readfirstmain(Rebr,1,true))then begin

	end;
	
	if(readfirstmain(CUr,1,true))then begin
		startdate = addday(ORr.OrdDate,-BRb.DayBefore);
		enddate = addday(ORr.OrdDate,BRb.DayAfter);
		
		notused = true;
		if(getyear(CUr.BirthRebateLastDate)==getyear(ORr.OrdDate))then begin
			messagebox(35102,CUr.BirthRebateInComp & " invoice # " & CUr.BirthRebateTransNr);
			notused = false;
		end;
		if(notused)then begin
			if(ORr.OKFlag==0)then begin
				birthmin = stringtodate(getday(CUr.BirthDate) & "/" & getmonth(CUr.BirthDate) & "/" & getyear(CurrentDate)-1);
				birth = stringtodate(getday(CUr.BirthDate) & "/" & getmonth(CUr.BirthDate) & "/" & getyear(CurrentDate));
				mirthmax = stringtodate(getday(CUr.BirthDate) & "/" & getmonth(CUr.BirthDate) & "/" & getyear(CurrentDate)+1);
			
				if(((birthmin>=startdate and birthmin<=enddate) or (birth>=startdate and birth<=enddate) or (mirthmax>=startdate and mirthmax<=enddate)) or usercanaction("GetBirthRebateAnyway",false))then begin 	
					if(BRb.PrcRebate!=0)then begin
						mtrw = matrowcnt(ORr);
						For(i=0;i<mtrw;i=i+1) begin
							matrowget(ORr,i,ORrw);
							if(nonblank(ORrw.ArtCode) and ORrw.stp==1 and ORrw.vRebate==Rebr.vra0)then begin
								lastquant = ORrw.Quant;
								//IVVc_PasteArtCode(IVr,i,inwarning,warning,TouchScreenLook,sernrf);
								ORVc_PasteArtCode(ORr,i,warning,warning,false);
								matrowget(ORr,i,ORrw);
								ORrw.Quant = lastquant;
								matrowput(ORr,i,ORrw);
								ORVc_PasteQuant(ORr,i,true,chsum);

								//IVVc_PasteQuantity(IVr,i);										
								matrowget(ORr,i,ORrw);
								if(ORrw.vRebate==Rebr.vra0)then begin
									ORrw.vRebate = (1-(100-ORrw.vRebate)/100*(100-BRb.PrcRebate)/100)*100;
									ORrw.UsedBirthRebate = 1;
									ORr.UsedBirthRebateH = 1;
								end;
								matrowput(ORr,i,ORrw);								
								ORDchsum(ORr,i);
								ORSumup(ORr);
							end;
						end;
						//IVSumup(IVr,true);
						ORSumup(ORr);
						putwindowrecord(wn,ORr);
					end;
				end else begin
					messagebox(35101,"");
				end;
			
				//DisplayIVItem(IVr,rownr);
			end;
		end;
	end;
	
return;
end;
	// Edit End ---------------------------------------------- Edit End
	

global updating
procedure IVDClassTouchScreenPasteButtonDo(integer butnr)
begin
  Integer rwcnt,wn,matrowix;
  record POSButtonsVc POSBr;
  row POSButtonsVc POSBrw;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  Boolean found;
  record RahaxiBlock Rahaxib;
  integer nwn;
  string 255 tag;
  record RcVc RepSpec;
  Integer line,rownr;
  string 255 tstr,t2,paymode,crncy;// Edit ************************** Friday, 20 October 2017 15:09:52
  integer i,mtrw;// Edit ************************** Friday, 22 March 2013 14:08:42
  val amount;// Edit ************************** Friday, 20 October 2017 15:09:59
	val from,to1,to2,base1,base2;// Edit ************************** Monday, 25 March 2013 17:41:57

  wn = CurWindow;
  DeselectWIndow(wn,true);
  GetWindowRecord(wn,IVr);
      
  found = POSButtonsForWindow(wn,POSBr);
  if (found) then begin
    rwcnt = MatRowCnt(POSBr);
  
    if (butnr>rwcnt) then begin
      goto LIVDClassTouchScreenPasteButtonDo;
    end;
    MatRowGet(POSBr,butnr-1,POSBrw);
    switch (POSBrw.ButtonType) begin
      case kPOSButtonTypeGotoPage:
        IVDClassGotoPage(POSBrw.Code,POSBrw.PrintGroupCode);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypOpenInvoices:
        IVDClassTouchScreenOpenInvoices;
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeAllInvoices:
        IVDClassTouchScreenAllInvoices;
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeReprintReceipt:
        IVDClassTouchScreenReprint;
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeNewCustomer:// Edit ************************** Wednesday, 5 December 2012 11:44:24
  		  CUNPTSSClassNewCustomerMy;// Edit ************************** Wednesday, 5 December 2012 11:44:23
  		  updatebrowses(wn);
  		  goto LIVDClassTouchScreenPasteButtonDo;// Edit ************************** Wednesday, 5 December 2012 11:44:15
  		case kPOSButtonTypeOpenCustomAllInvoices: //Edit***************************Sasha2,10:37 11.12.2014
        OpenCustomAllInvoices;
        goto LIVDClassTouchScreenPasteButtonDo;
    end;
  end;
  switch (WindowState(wn)) begin
    case Rs_update:
      GetPrevWindowRecord(wn,prevIVr);
      if (prevIVr.OKFlag!=0) then begin
        goto LIVDClassTouchScreenPasteButtonDo;
      end;
      if (prevIVr.Invalid!=0) then begin 
        goto LIVDClassTouchScreenPasteButtonDo; 
      end;
    otherwise
      if (IVr.OKFlag!=0) then begin
        goto LIVDClassTouchScreenPasteButtonDo;
      end;
      if (IVr.Invalid!=0) then begin 
        goto LIVDClassTouchScreenPasteButtonDo; 
      end;
  end;
  if (found) then begin
    rwcnt = MatRowCnt(POSBr);
    
    if (butnr>rwcnt) then begin
      goto LIVDClassTouchScreenPasteButtonDo;
    end;
    
    MatRowGet(POSBr,butnr-1,POSBrw);
    switch (POSBrw.ButtonType) begin
      case kPOSButtonTypeItem:
        PutWindowString(wn,"touchscreenitem",POSBrw.Code);
        PutWindowString(wn,"touchscreenitemqty",1.00);
        DeselectWindow(wn,false);
        IVDClasstouchscreenitemEFAfter(wn,0,true);
        // WindowFieldGoto(wn,IVr,-1,"touchscreenitem",true);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeGotoPage:
        IVDClassGotoPage(POSBrw.Code,POSBrw.PrintGroupCode);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypePayment:
        BlockLoad(Rahaxib);
        switch (Rahaxib.TerminalType) begin
          case kLocalCCTerminalNone:
            // OpenCashPayTouchScreenDClass(wn,-1,IVr.SerNr,IVr.RetnValue,IVr.Sum4-IVr.TendValue,IVr.CurncyCode,POSBrw.Code,POSBrw.Label);
            OpenNPTSPaymentTClass(wn,IVr.SerNr,IVr.RetnValue,IVr.Sum4,IVr.CurncyCode);
        end;
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeCashPayment:
      	mtrw = matrowcnt(IVr);
      	For(i=0;i<mtrw;i=i+1) begin
	  			MatRowGet(IVr,i,IVrw);
          switch (IVrw.stp) begin
          	case kInvoiceRowTypeCashPayment: MatRowDelete(IVr,i); i=i-1;mtrw = matrowcnt(IVr);// Edit ************************** Saturday, 23 March 2013 14:26:56
          end;
				end; 
				IVSumup(IVr,true);
				putwindowrecord(wn,IVr);
        OpenNPTSCashPaymentTClass(wn,IVr.SerNr,IVr.RetnValue,IVr.Sum4,IVr.CurncyCode,POSBrw.Code,POSBrw.Label);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeGiftVoucherPayment:
//        OpenGiftVoucherTouchScreenDClass(wn,-1,IVr.SerNr,IVr.RetnValue,IVr.Sum4-IVr.TendValue,IVr.CurncyCode,POSBrw.Code,POSBrw.Label);
        OpenGiftVoucherTouchScreenDClass(wn,-1,IVr.SerNr,IVr.RetnValue,blankval,IVr.CurncyCode,POSBrw.Code,POSBrw.Label);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeGiftVoucherSales:
        OpenGiftVoucherSalesTouchScreenDClass(wn,POSBrw.Code,POSBrw.Label);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeChequePayment:
        OpenChequePayTouchScreenDClass(wn,-1,IVr.SerNr,IVr.RetnValue,blankval,IVr.CurncyCode,POSBrw.Code,POSBrw.Label);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeCreditCardPayment:
        BlockLoad(Rahaxib);
        switch (Rahaxib.TerminalType) begin
          case kLocalCCTerminalNone:
          	// Edit ************************** Friday, 20 October 2017 15:07:36
          	// Edit Start ---------------------------------------------- Edit Start
	//Friday, 20 October 2017 15:12:45
	
          	paymode = FirstInRange(POSBrw.Code,10); //Edit***************************Sasha2,16:55 11.02.2015
						amount = StringToVal(LastInRange(POSBrw.Code,10),M4Val); //Edit***************************Sasha2,16:55 
          	if(amount==0)then begin
							OpenCCPayTouchScreenDClass(wn,-1,IVr.SerNr,IVr.Sum4,IVr.RetnValue,blankval,IVr.CurncyCode,POSBrw.Code,POSBrw.Label);
            end else begin
            	if(IVr.Sum4<amount)then begin
								amount = IVr.Sum4;
							end;
            	
            	MessageBox(0,USetStr(31001) & amount & " AZN");
            	ClearRow(IVr,IVrw,kInvoiceRowTypeCreditCardPayment);
            	IVrw.CurncyCode = IVr.CurncyCode;
							IVrw.PayMode = paymode;        
							IVrw.Spec = "Gift Voucher";
							IVrw.Sum = amount;
							crncy = IVr.CurncyCode;
							GetFullCurncyRate(crncy,IVr.TransDate,from,to1,to2,base1,base2);
							IVrw.CurncyCode = crncy;
							IVrw.FrRate = from;
							IVrw.ToRateB1 = to1;
							IVrw.ToRateB2 = to2;
							IVrw.BaseRate1 = base1;
							IVrw.BaseRate2 = base2;  
            	MatRowPut(IVr,MatRowCnt(IVr),IVrw);
							putwindowrecord(wn,IVr);
							ProceedLoyaltyPaymentNPTSSClassExecuteMy(wn);
            end;
            
	// Edit End ---------------------------------------------- Edit End
	
            
          case kLocalCCTerminalYomaniBanksys:
            CredCardIVsmExecute(POSBrw.Code,POSBrw.Label);
          case kLocalCCTerminalIngenico6550:
            CredCardIVsmExecute(POSBrw.Code,POSBrw.Label);
          otherwise
            CredCardIVsmExecute("","");
        end;
        goto LIVDClassTouchScreenPasteButtonDo;
/*
      case kPOSButtonTypeCreditCardPaymentReversal:
        BlockLoad(Rahaxib);
        switch (Rahaxib.TerminalType) begin
          case kLocalCCTerminalNone:
            // OpenCCPayReversalTouchScreenDClass(wn,-1,IVr.SerNr,IVr.RetnValue,IVr.Sum4-IVr.TendValue,IVr.CurncyCode,POSBrw.Code,POSBrw.Label);
          case kLocalCCTerminalYomaniBanksys:
            CredCardReversalPOSPIVsmExecute(POSBrw.Code,POSBrw.Label);
          otherwise
            // CredCardReversalPOSPIVsm;
        end;
        goto LIVDClassTouchScreenPasteButtonDo;
*/
      case kPOSButtonTypeDebitCardPayment:
        BlockLoad(Rahaxib);
        switch (Rahaxib.TerminalType) begin
          case kLocalCCTerminalNone:
            OpenDCPayTouchScreenDClass(wn,-1,IVr.SerNr,IVr.Sum4,IVr.RetnValue,blankval,IVr.CurncyCode,POSBrw.Code,POSBrw.Label);
        end;
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypePOSCommand:
/*
        if (UserCanAction("AllowNPTSIVRowsVoid",UseAppStoreEnabler==true)==false) then begin
          POSManagersAction(wn,"VoidRow");
          goto LIVDClassTouchScreenPasteButtonDo;
        end;
*/
        switch (SetFromString(323,POSBrw.Code)) begin
          case kPOSCommandsTypeVoidRow:
            nwn = OpenWindow("VoidNPTSSClass",0,wn,"","",RepSpec);  
        end;
        goto LIVDClassTouchScreenPasteButtonDo;
/*
      case kPOSButtonTypeVolumetricBarCodeScan:
        ReportDefaults(RepSpec,"VolBarCodeScanVClass");
        RepSpec.UsedOnly = wn;
        nwn = OpenWindow("VolBarcodeScanVClass",0,wn,"","",RepSpec);
        WindowFieldGoto(nwn,RepSpec,-1,"f1",true);
        goto LIVDClassTouchScreenPasteButtonDo;
*/
      case kPOSButtonTypeCustomerSearch:
        ReportDefaults(RepSpec,"SearchCURClass");
        RepSpec.UsedOnly = wn;
        RepSpec.repname = "SearchCuRn";
        RepSpec.Media = mtScreen;
        nwn = OpenWindow("NPTSSearchCURClass",0,wn,"","",RepSpec);
        WindowFieldGoto(nwn,RepSpec,-1,"f1",true);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeSelectSalesman:
        // nwn = OpenWindow("UserNPTSSClass",0,wn,"","",RepSpec);
        WindowFieldGoto(wn,IVr,-1,"SalesMan",true);
        nwn = OpenWindow("EnterSalesmanNPTSOClass",1,wn,"","",RepSpec);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeLoyaltyCard:
        IVDClassTouchScreenLoyaltyCard;
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeItemSearch:
        NPTSSearchItemExecute(wn);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeItemStatus:
        if (SelectedListLine(wn)<>-1) then begin
          matrowix = GetSelectedPOSItemRowIndex(wn);
          MatRowGet(IVr,matrowix,IVrw);
          if(nonblank(IVrw.ArtCode))then begin
						RepSpec.UsedOnly = wn;
						RepSpec.f1 = IVrw.ArtCode;
						//RepSpec.repname = "INInfoRn";
						RepSpec.repname = "ItemLocationStatusRn";
						RepSpec.Media = mtScreen;
						RunReport(RepSpec,0);
          end;
        end;
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeOpenCashDrawer:
        OpenCashDrawer_IVVc(IVr);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeRunReportOnServer:
        RunReportOnServer(POSBrw.Code);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeCustomerSearchFiltered:
        ReportDefaults(RepSpec,"SearchCURClass");
        RepSpec.UsedOnly = wn;
        RepSpec.repname = "SearchCuRn";
        RepSpec.Media = mtScreen;
        nwn = OpenWindow("NPTSSearchBFCURClass",0,wn,"","",RepSpec);
        WindowFieldGoto(nwn,RepSpec,-1,"f1",true);
        goto LIVDClassTouchScreenPasteButtonDo;
  	  case kPOSButtonTypeGoodsReturn:// Edit ************************** Wednesday, 5 December 2012 11:44:24
  		  PasteRetItemIVDsm;// Edit ************************** Wednesday, 5 December 2012 11:44:23
  	    updatebrowses(wn);
  		  goto LIVDClassTouchScreenPasteButtonDo;// Edit ************************** Wednesday, 5 December 2012 11:44:15
      case kPOSButtonTypeSpecialRebate:// Edit ************************** Wednesday, 5 December 2012 11:44:24
		    PasteSpecialRebateItemIVDsm;// Edit ************************** Wednesday, 5 December 2012 11:44:23
		    updatebrowses(wn);
		    goto LIVDClassTouchScreenPasteButtonDo;// Edit ************************** Wednesday, 5 December 2012 11:44:15
      case kPOSButtonTypeCreateShotSDVc: //Edit***************************Sasha2,10:37 11.12.2014
         CreateSDfromIVDsm(POSBrw.Code,POSBrw.Label);
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeCreateShotPUVc: //Edit***************************Sasha2,10:37 11.12.2014
        CreatePUfromIVDsm;
        goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeGetBirthRebate:
      	GetBirthRebateDsm;
      	goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeIssueCBLoyaltyCard: //Edit***************************Sasha2,17:30 11.08.2017
      	OpenGCBCardckIssueTouchScreenDClass;
      	goto LIVDClassTouchScreenPasteButtonDo;
      case kPOSButtonTypeTAXBackRet:// Edit ************************** Tuesday, 17 October 2017 15:22:12
      	GetTAXBackRetDsm;
      	goto LIVDClassTouchScreenPasteButtonDo;
      end;
  end;
LIVDClassTouchScreenPasteButtonDo:;
  return;
end;

global updating
procedure IVDClassTouchScreenPasteButton()
begin
  Integer butnr;
  string 255 tagstr;
  
  tagstr = PushButtonTag;
  butnr = StringToInt(tagstr);
  IVDClassTouchScreenPasteButtonDo(butnr)
end;

global
procedure IVDClassTouchScreenStackButtonExecute(string tag)
begin
  integer i,rwcnt,wn;
  string 60 ostr;
  string 60 prstr;
  Integer pos,prpos;
  string 255 stack;
  string 255 prstack;
  array string 255 stackarr;
  array string 255 prstackarr;
  longint stackend,sline;
  
  wn = CurWindow;
  
  //StopAlert("IVDClassTouchScreenStackButton, tag: " & tag);
  
  //page = StringToInt(GetWindowString(wn,"touchscreenwindowpage"));
  stack = GetWindowString(wn,"touchscreenwindowpagestack");
  prstack = GetWindowString(wn,"touchscreenwindowprinterstack");
  
  stackend = 0;
  pos = 0;
  prpos = 0;
  ExtractObj(stack,pos,ostr);
  ExtractObj(prstack,prpos,prstr);
  
  while (nonblank(ostr)) begin
    stackarr[stackend] = ostr;
    prstackarr[stackend] = prstr;
    stackend = stackend + 1;
    ExtractObj(stack,pos,ostr);
    ExtractObj(prstack,prpos,prstr);
  end;
  
  stackend = stackend - 1;
  
  while ((stackend>0) and (stackarr[stackend]<>tag)) begin
    stackend = stackend - 1;
  end;
  
  stack = stackarr[0];
  prstack = prstackarr[0];
  
  for (i = 1; i<=stackend; i = i + 1) begin
    stack = stack & "," & stackarr[i];
    prstack = prstack & "," & prstackarr[i];
  end;
  
  sline = SelectedListLine(wn);
  
  PutWindowString(wn,"touchscreenwindowpagestack",stack);
  PutWindowString(wn,"touchscreenwindowprinterstack",prstack);
  
  PutWindowString(wn,"touchscreenwindowpage",stackarr[stackend]);
  SetWindowSubset(wn,GetWindowSubset(wn));
  ReRunWindowDef(wn);
  
  SetSelectedListLine(wn,sline);
  
  return;
end;

global
procedure IVDClassTouchScreenStackButton()
begin
  string 255 tag;

  tag = PushButtonTag;
  IVDClassTouchScreenStackButtonExecute(tag);
  return;
end;

global
procedure IVDClassTouchScreenStackButton()
begin
  string 255 tag;

  tag = PushButtonTag;
  IVDClassTouchScreenStackButtonExecute(tag);
  return;
end;

global
procedure IVDClassPageTop()
begin
  IVDClassTouchScreenStackButtonExecute("1");
  return;
end;

global
procedure IVDClassTouchScreenAmendLine()
begin
  Integer wn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  row IVVc IVrw;
  string 255 tstr,tagstr;
  Boolean testf;
  
  mwn = CurWindow;
  line = SelectedListLine(mwn);

  if (line>=0) then begin
/*
    if (UserCanAction("AllowAmendLine",UseAppStoreEnabler==true)==false) then begin
      POSManagersAction(mwn,"AmendLine");
      goto LIVDClassTouchScreenAmendLine;
    end;
*/
    RecordClear(RepSpec);
    tagstr = GetListTag(mwn,line);
    rownr = StringToInt(tagstr);
    if (rownr>=0) then begin
      GetWindowRecord(mwn,IVr);
      MatRowGet(IVr,rownr,IVrw);
      testf = true;
      if (IVr.OKFlag!=0) then begin testf = false; end;
      if (IVr.Invalid!=0) then begin testf = false; end;
//      if (IVrw.stp!=kInvoiceRowTypeNormal) and (IVrw.stp!=kInvoiceRowTypeHeader) then begin testf = false; end;
      if (IVrw.stp!=kInvoiceRowTypeNormal) then begin testf = false; end;
      if (IVrw.ovst!=0) then begin testf = false; end;
      if (testf) then begin
        RepSpec.AccStr = IVrw.ArtCode;
        RepSpec.f1 = IVrw.Spec;
        RepSpec.vals0 = IVrw.Quant;
        RepSpec.vals1 = IVrw.Price;
        RepSpec.vals2 = IVrw.vRebate;
        RepSpec.vals3 = IVrw.Sum;
        RepSpec.vals4 = IVrw.PriceFactor;
        RepSpec.CurncyCode = IVrw.CurncyCode;
        if(blank(IVrw.CurncyCode))then begin
        	RepSpec.CurncyCode = IVr.CurncyCode;// Edit ************************** Monday, 29 June 2015 21:27:35
        end;
        RepSpec.FirstAcc = IVrw.PayMode;
        RepSpec.long1 = rownr;
        wn = OpenWindow("AmendLineNPTSSClass",0,mwn,"","",RepSpec);
        PutWindowString(wn,"BasePrice",IVrw.BasePrice);  
        WindowFieldGoto(wn,RepSpec,-1,"vals0",false);    
      end;
    end;
  end;
LIVDClassTouchScreenAmendLine:;  
  return;
end;

global
updating procedure IVDClassTouchScreenVoidRow()
begin
  Integer wn,line,rownr;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  string 255 tstr,tag,t2;
  record LocalMachineBlock LMb;
  Integer wnst;
  LongInt printrownr;

  wn = CurWindow;
  line = SelectedListLine(wn);
  if (line>=0) then begin
/*
    if (UserCanAction("AllowNPTSIVRowsVoid",UseAppStoreEnabler==true)==false) then begin
      POSManagersAction(wn,"VoidRow");
      goto LIVDClassTouchScreenVoidRow;
    end;
*/
    tag = GetListTag(wn,line);
    rownr = StringToInt(tag);
    if (rownr>=0) then begin
      DeselectWIndow(wn,true);
      GetWindowRecord(wn,IVr);
      wnst = WindowState(wn);
      if (IVr.OKFlag!=0) then begin goto LIVDClassTouchScreenVoidRow; end;
      if (IVr.Invalid!=0) then begin goto LIVDClassTouchScreenVoidRow; end;
      if (IVDClassVoidRow(IVr,rownr)) then begin
        BlockLoad(LMb);
        PutWindowRecord(wn,IVr);    
        MatRowGet(IVr,rownr,IVrw);
        IVDClass_RefreshStringList(wn,IVr);
        tstr = ValToString(-IVrw.Quant,M4UVal,ThousandSeparator,DecimalSeparator,0) & "*" & ValToString(IVrw.Price,M4Val,ThousandSeparator,DecimalSeparator,0);
        M4PadString(ValToString(IVrw.Sum,M4Val,ThousandSeparator,DecimalSeparator,0),20-len(tstr)," ",true,t2);
        tstr = tstr & t2;  
        SetPOSWindowDisplay(IVrw.ArtCode & " " & IVrw.Spec,tstr);
        DeselectWindow(wn,false);
        if (WindowDoOK(wn,0)) then begin
/*
          GetWindowRecord(wn,IVr);
          printrownr = StringToLongInt(GetWindowString(wn,"touchscreenitemlastrownr"));
          if (printrownr>=0) then begin
            GetPrevWindowRecord(wn,prevIVr);
            if (IVPrintReceipt(wn,IVr,prevIVr,printrownr,false,false,LMb.IncrementalReceiptPrinting,wnst)) then begin
            end;
          end;
          PutWindowString(wn,"touchscreenitemlastrownr",MatRowCnt(IVr)-1);
*/
          WindowFieldGoto(wn,IVr,-1,"ivcashcommand",false);
        end;
        OverrideLogout;
      end;
    end;
  end;
LIVDClassTouchScreenVoidRow:;  
  return;
end;

global
updating procedure IVDClassTouchScreenDeleteItem()
begin
  Integer wn,matrowix;
  record IVVc IVr;
  string 255 tstr;
		
  wn = CurWindow;
  if (SelectedListLine(wn)>=0) then begin
/*
    if (UserCanAction("AllowIVTSRowsDelete",UseAppStoreEnabler==true)==false) then begin
      POSManagersAction(wn,"DeleteItem");
      goto LIVDClassTouchScreenDeleteItem;
    end;
*/
    DeselectWIndow(wn,true);
    GetWindowRecord(wn,IVr);
    if (IVr.OKFlag!=0) then begin goto LIVDClassTouchScreenDeleteItem; end;
    if (IVr.Invalid!=0) then begin goto LIVDClassTouchScreenDeleteItem; end;

    matrowix = GetSelectedPOSItemRowIndex(wn);
    if (matrowix>=0) then begin
      if (IVDClassDeleteRowTest(wn,matrowix)) then begin
        IVDClassOnOverStrike(wn,matrowix);
        GetWindowRecord(wn,IVr);
  //      matrowix = GetSelectedPOSItemRowIndex(wn); // Why again? On windows, the selection is cleared between the calls to this function, can't figure out why.
        MatRowDelete(IVr,matrowix);
        if (IVr.OrderNr==-1) then begin	// Edit ************************** Thursday, 7 April 2016 12:16:37
        	IVDUpdatePrices(IVr,false);// Edit ************************** Thursday, 3 March 2016 10:44:29
        end;
        tstr = SaboPromotion(IVr,"deletedrow"); //Edit***************************Sasha2,13:36 01.06.2016 {
        if (NonBlank(tstr)) then begin
          MessageBox(0,tstr);
        end; //Edit***************************Sasha2,13:36 01.06.2016 }
        IVSumup(IVr,true);
        PutWindowRecord(wn,IVr);
        if (GuiType==kGuiCocoa) then begin
          IVDClassOnWindowRecordChange(wn);
        end else begin
          IVDClass_RefreshStringList(wn,IVr);
        end;
      end;
      //WindowDoOK(wn,0);// Edit ************************** Thursday, 14 November 2013 16:33:14
      WindowFieldGoto(wn,IVr,-1,"ivcashcommand",false);
      SetPOSWindowDisplay("","");
      OverrideLogout;
    end;
  end;
LIVDClassTouchScreenDeleteItem:;  
  return;
end;

global
updating procedure IVDClassTouchScreenDeleteAll()
begin
  Integer wn,matrowix;
  record IVVc IVr;
	integer mtrw,i;
	
  wn = CurWindow;
	DeselectWIndow(wn,true);
	GetWindowRecord(wn,IVr);
	if (IVr.OKFlag!=0) then begin goto LIVDClassTouchScreenDeleteAll; end;
	if (IVr.Invalid!=0) then begin goto LIVDClassTouchScreenDeleteAll; end;
	
	mtrw = matrowcnt(IVr);
	GetWindowRecord(wn,IVr);
	for(i=0;i<mtrw;i=i+1)begin
		//if (IVDClassDeleteRowTest(wn,i)) then begin
			//IVDClassOnOverStrike(wn,i);
			
			MatRowDelete(IVr,i);
			mtrw = mtrw-1;
			i = i-1;
			
		//end;
	end;
	IVSumup(IVr,true);
	PutWindowRecord(wn,IVr);
	
	if (GuiType==kGuiCocoa) then begin
		IVDClassOnWindowRecordChange(wn);
	end else begin
		IVDClass_RefreshStringList(wn,IVr);
	end;
	WindowDoOK(wn,0);
	WindowFieldGoto(wn,IVr,-1,"ivcashcommand",false);
	SetPOSWindowDisplay("","");
	OverrideLogout;
LIVDClassTouchScreenDeleteAll:;  
  return;
end;

global
procedure IVDClassTouchScreenLoyaltyPointsBonusExecute()
begin
  Integer wn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  /*
  if (UserCanAction("AllowIVTSLoyaltyPointsBonus",UseAppStoreEnabler==true)==false) then begin
    POSManagersAction(mwn,"LoyaltyPointsBonus");
    goto LIVDClassTouchScreenLoyaltyPointsBonusExecute;
  end;
  */
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    wn = OpenWindow("LoyaltyPointsBonusNPTSSClass",0,mwn,"","",RepSpec);
//    WindowFieldGoto(wn,RepSpec,-1,"vals0",false);    
  end;
//  OverrideLogout;
LIVDClassTouchScreenLoyaltyPointsBonusExecute:;  
  return;
end;

global
updating procedure IVDClassTouchScreenLoyaltyPointsPaymentExecute(string paymode_amount)
begin
  Integer wn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  row IVVc IVrw;
  Integer i,rwcnt;
  string 255 tstr;
  Boolean testf;
  val PointsBalance,totsumb1;
  Integer err;
  val points;
  string 10 paymode; //Edit***************************Sasha2,16:54 11.02.2015
  val amount,salesval; //Edit***************************Sasha2,16:52 11.02.2015
		
  mwn = CurWindow;
  GetWindowRecord(mwn,IVr);
  
  paymode = FirstInRange(paymode_amount,10); //Edit***************************Sasha2,16:55 11.02.2015
  amount = StringToVal(LastInRange(paymode_amount,10),M4Val); //Edit***************************Sasha2,16:55 11.02.2015
  
  rwcnt = matrowcnt(IVr);
  For(i=0;i<rwcnt;i=i+1) begin
	  matrowget(IVr,i,IVrw);
	  if(IVrw.stp==kInvoiceRowTypeLoyaltyPointsPayment)then begin
	  		MessageBox(31000,"");
			goto LIVDClassTouchScreenLoyaltyPointsPaymentExecute;
	  end;
	end; 
  if (blank(IVr.LoyaltyCardNr)) then begin
  	if(paymode=="L1" and currentcompany==4)then begin
  		For(i=0;i<rwcnt;i=i+1) begin
				matrowget(IVr,i,IVrw);
				if(IVrw.stp==9)then begin
					salesval = IVrw.Sum;
				end;
			end; 
			points = salesval; 
			
			if((IVr.Sum4-salesval)<salesval)then begin
				points = IVr.Sum4-salesval;
			end;  
			MessageBox(0,USetStr(35073) & points & " AZN");
			ClearRow(IVr,IVrw,kInvoiceRowTypeLoyaltyPointsPayment); 
			IVrw.Points = points;// Edit ************************** Wednesday, 6 March 2013 12:08:33
			IVrw.Sum = points;// Edit ************************** Wednesday, 6 March 2013 12:08:34
			IVrw.CurncyCode = IVr.CurncyCode;
			IVrw.PayMode = paymode;        
			IVrw.Spec = UsetStr(24182);
			MatRowPut(IVr,MatRowCnt(IVr),IVrw);
			putwindowrecord(mwn,IVr);
			ProceedLoyaltyPaymentNPTSSClassExecuteMy(mwn);
			goto LIVDClassTouchScreenLoyaltyPointsPaymentExecute;
			
			
  	end else begin
  		if(amount!=0)then begin
				MessageBox(0,USetStr(31001) & amount & " AZN"); //Edit***************************Sasha2,17:09 11.02.2015
				ClearRow(IVr,IVrw,kInvoiceRowTypeLoyaltyPointsPayment);    
				points = amount; 
				if(IVr.Sum4<amount)then begin
					points = IVr.Sum4;
				end;    
				IVrw.Points = points;// Edit ************************** Wednesday, 6 March 2013 12:08:33
				IVrw.Sum = points;// Edit ************************** Wednesday, 6 March 2013 12:08:34
				IVrw.CurncyCode = IVr.CurncyCode;
				IVrw.PayMode = paymode;        
				IVrw.Spec = UsetStr(24182);
				MatRowPut(IVr,MatRowCnt(IVr),IVrw);
				putwindowrecord(mwn,IVr);
				ProceedLoyaltyPaymentNPTSSClassExecuteMy(mwn);
			end;
			goto LIVDClassTouchScreenLoyaltyPointsPaymentExecute;
    end;
  end;
 
  
/*
  if (UserCanAction("AllowIVTSLoyaltyPayment",UseAppStoreEnabler==true)==false) then begin
    POSManagersAction(mwn,"LoyaltyPayment");
    goto LIVDClassTouchScreenLoyaltyPointsPaymentExecute;
  end;
*/
  RecordClear(RepSpec);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    err = CalculateLoyaltyPointsPayment_IVVc(IVr,blankval,PointsBalance,RepSpec.vals0,totsumb1);
    if (err!=0) then begin
      MessageBox(err,"");
      goto LIVDClassTouchScreenLoyaltyPointsPaymentExecute;
    end;
    rwcnt = MatRowCnt(IVr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(IVr,i,IVrw);
      switch (IVrw.stp) begin
        case kInvoiceRowTypeLoyaltyPointsPayment:
          PointsBalance = PointsBalance - IVrw.Points;
      end;
    end;
    RepSpec.FirstAcc = paymode;
    RepSpec.vals1 = PointsBalance;
    RepSpec.vals2 = totsumb1;
    wn = OpenWindow("LoyaltyPaymentNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"vals0",false);    
  end;
LIVDClassTouchScreenLoyaltyPointsPaymentExecute:;  
  return;
end;

global
updating procedure IVDClassTouchScreenLoyaltyPointsPayment()
begin
  integer i,wn,rwcnt;
  Boolean found;
  record POSButtonsVc POSBr;
  row POSButtonsVc POSBrw;
  Integer butnr; //Edit***************************Sasha2,17:20 11.02.2015

  wn = CurWindow; 
  butnr = StringToInt(PushButtonTag); //Edit***************************Sasha2,17:21 11.02.2015
  found = POSButtonsForWindow(wn,POSBr);

  if (found) then begin
    //rwcnt = MatRowCnt(POSBr); //Edit***************************Sasha2,18:08 11.02.2015
    //for (i = 0; i<rwcnt; i = i + 1) begin //Edit***************************Sasha2,17:22 11.02.2015
      MatRowGet(POSBr,butnr-1,POSBrw);
      switch (POSBrw.ButtonType) begin
        case kPOSButtonTypeLoyaltyPointsPayment:
          IVDClassTouchScreenLoyaltyPointsPaymentExecute(POSBrw.Code);
          //i = rwcnt; //Edit***************************Sasha2,17:22 11.02.2015
      end;
    //end; //Edit***************************Sasha2,17:22 11.02.2015
  end;
  return;
end;

global 
updating procedure IVDClassTouchScreenSaveInvoice()
begin
  Integer wn,nwn;
  record IVVc IVr;
  record IVVc prevIVr;
  record LocalMachineBlock LMb;
  Integer wnst;
  LongInt printrownr;

  wn = CurWindow;
  wnst = WindowState(wn);
  GetWindowRecord(wn,IVr);
  if (MatRowCnt(IVr)==0) then begin
    goto LIVDClassTouchScreenSaveInvoice;
  end;
  GetPrevWindowRecord(wn,prevIVr);
  BlockLoad(LMb);
  if (LMb.IncrementalReceiptPrinting!=0) then begin
    GetPrevWindowRecord(wn,prevIVr);      
    printrownr = StringToLongInt(GetWindowString(wn,"touchscreenitemlastrownr"));
    if (printrownr>=0) then begin
      IVPrintReceipt(wn,IVr,prevIVr,printrownr,false,false,LMb.IncrementalReceiptPrinting,wnst);
    end;
  end;
  IVr.Suspended = 1;
  PutWindowRecord(wn,IVr);
  if (WindowDoOK(wn,0)) then begin
    GetWindowRecord(wn,IVr);
    IVPrintReceipt(wn,IVr,prevIVr,-1,false,false,LMb.IncrementalReceiptPrinting,wnst);
    WindowDoNew(wn,0);
    PutWindowString(wn,"touchscreenitemlastrownr",-1);
  end;
LIVDClassTouchScreenSaveInvoice:;  
  return;
end;

global
procedure IVDClassTouchScreenLookupSerialNr()
begin
  Integer nwn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  row IVVc IVrw;
  string 255 tagstr;
  Boolean testf,ivcashcommandlastitemsernrf;
  record INVc INr;
  
  mwn = CurWindow;
  ivcashcommandlastitemsernrf = StringToInt(GetWindowString(mwn,"ivcashcommandlastitemsernrf"))!=0;

  RecordClear(RepSpec);
  line = SelectedListLine(mwn);

  if (line>=0) then begin
    tagstr = GetListTag(mwn,line);
    rownr = StringToInt(tagstr);
    if (rownr>=0) then begin
      GetWindowRecord(mwn,IVr);
      MatRowGet(IVr,rownr,IVrw);
      testf = true;
      if (IVr.OKFlag!=0) then begin testf = false; end;
      if (IVr.Invalid!=0) then begin testf = false; end;
      if (IVrw.stp!=kInvoiceRowTypeNormal) and (IVrw.stp!=kInvoiceRowTypeStructuredItemComponent) then begin testf = false; end;
      if (IVrw.ovst!=0) then begin testf = false; end;
      if (testf) then begin
        if (ivcashcommandlastitemsernrf==false) then begin
          ReadFirstItem(IVrw.ArtCode,INr,true,false);
          ivcashcommandlastitemsernrf = true;//INr.SerNrf!=0;// Edit ************************** Monday, 22 April 2013 16:19:36
        end;
        if (ivcashcommandlastitemsernrf==false) then begin
          goto LIVDClassTouchScreenLookupSerialNr;
        end;
        PutWindowString(mwn,"ivcashcommandlastitemsernrf","true");
        RepSpec.long1 = rownr;
        nwn = OpenWindow("SerialNoScanNPTSSClass",0,mwn,"","",RepSpec);

//        nwn = OpenWindow("SerialNrSClass",1,mwn,"","",RepSpec);
//        PutWindowString(mwn,"ivcashcommand","");  
      end;
    end;
  end;
LIVDClassTouchScreenLookupSerialNr:;  
  return;
end;

global
updating procedure IVDClassTouchScreenFinishButtonRun(Boolean newf,Integer awnst)
begin
  Integer wn;
  LongInt printrownr,err;
  record IVVc IVr;
  record IVVc prevIVr;
  Boolean save_recordf,new_recordf;
  record LocalMachineBlock LMb;
  Integer wnst;
  val prevRetValue;
  string 255 tstr;

  err = 0;
  BlockLoad(LMb);
  wn = CurWindow;
  DeselectWindow(wn,true);
  GetWindowRecord(wn,IVr);
   if (IVr.Invalid!=0) then begin 
    goto LIVDClassTouchScreenFinishButtonRun; 
  end;
  if (IVr.OKFlag!=0) then begin 
    goto LIVDClassTouchScreenFinishButtonRun; 
  end;
  wnst = awnst;
  if (wnst==-1) then begin
    wnst = WindowState(wn);
  end;
  GetPrevWindowRecord(wn,prevIVr);
  if (RecordValid(prevIVr)==false) or (prevIVr.SerNr<=0) then begin
    RecordCopy(prevIVr,IVr);
  end;
  printrownr = StringToLongInt(GetWindowString(wn,"touchscreenitemlastrownr"));
  if (printrownr>=0) then begin
    IVPrintReceipt(wn,IVr,prevIVr,printrownr,false,false,LMb.IncrementalReceiptPrinting,wnst);
  end;
  
  IVSumup(IVr,true);              
  IVr.OKFlag = 1;

  SetRecordCheckVc("IVVc");
 
  if (err==0 and CurrentCompany!=10) then begin  //Edit***************************Sasha2,10:12 27.03.2015
    if (!IVPrintReceipt(wn,IVr,prevIVr,-1,true,true,LMb.IncrementalReceiptPrinting,wnst)) then begin
      err = 1;
      new_recordf = false;
    end;
  end;
  
  if (err==0) then begin
    PutWindowRecord(wn,IVr);
    save_recordf = true;
    if (CurrentCompany==10) then begin
      new_recordf = false; //Edit***************************Sasha2,10:13 27.03.2015
    end else begin
      new_recordf = newf;
    end;      

    if (save_recordf) then begin
      if (WindowDoOK(wn,0)==false) then begin 
        IVr.OKFlag = 0;
        PutWindowRecord(wn,IVr);
        new_recordf = false;
      end;
    end;
  end;
   
  IVDClass_RefreshStringList(wn,IVr);
  prevRetValue = IVr.RetnValue;
  if (new_recordf) then begin   
    WindowDoNew(wn,0);
    GetWindowRecord(wn,IVr);
    IVr.RetnValue = prevRetValue;
    PutWindowString(wn,"touchscreenwindowpage",1);
    PutWindowString(wn,"touchscreenwindowpagestack","1");
    PutWindowString(wn,"touchscreenwindowprinterstack","*");
    PutWindowString(wn,"CustomerDisplayData_Line1","");
    PutWindowString(wn,"CustomerDisplayData_Line2","");    
    PutWindowString(wn,"touchscreenitemlastrownr",-1);
    tstr = USetStr(24172) & "  ";
    tstr = tstr & ValToString(prevRetValue,M4Val,ThousandSeparator,DecimalSeparator,0);
    SetPOSWindowDisplay("",tstr);
    PutWindowRecord(wn,IVr);
    IVDClass_RefreshStringList(wn,IVr);
    SelectWindow(wn);
//    ReRunWindowDef(wn);
  end;
LIVDClassTouchScreenFinishButtonRun:;  
  return;
end;

global
updating procedure IVDClassTouchScreenFinishButton()
begin
  IVDClassTouchScreenFinishButtonRun(true,-1);
  return;
end;

updating function Boolean IVDClassTouchScreenButton(record POSButtonsVc POSBr,row POSButtonsVc POSBrw)
begin
  Boolean res;
  
  switch (POSBrw.ButtonType) begin
    case kPOSButtonTypeFinish:
      IVDClassTouchScreenFinishButtonRun(true,-1);   
      res = true;
    case kPOSButtonTypeLookupSerialNr:
      IVDClassTouchScreenLookupSerialNr;
      res = true;
    case kPOSButtonTypeLogin:
      IVDClassTouchScreenButtonLogin;
      res = true;
    case kPOSButtonTypSaveInvoice:
      IVDClassTouchScreenSaveInvoice;
      res = true;
    case kPOSButtonTypeLoyaltyPointsPayment:
      IVDClassTouchScreenLoyaltyPointsPaymentExecute(POSBrw.Code);
      res = true;
    case kPOSButtonTypeLoyaltyPointsBonus:
      IVDClassTouchScreenLoyaltyPointsBonusExecute;
      res = true;
    case kPOSButtonTypeAmendLine:
      IVDClassTouchScreenAmendLine;
      res = true;
    case kPOSButtonTypeVoidRow:
      IVDClassTouchScreenVoidRow;
      res = true;
  end;
  IVDClassTouchScreenButton = res;
  return;
end;

function Boolean IVDClassPageFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Boolean res;
  record POSButtonsVc POSBr;
  Boolean testf,found;
  
  found = true;
  POSBr.WindowClass = "IVDClass";
  while (LoopMain(POSBr,1,found)) begin
    if (POSBr.WindowClass!="IVDClass") then begin
      found = false;
    end;
    if (found) then begin
      if (POSBr.KeyCode==keycode) then begin
        testf = true;
        if (POSBr.Modifiers==kKeyModifierNone and (shflag or ctrlflag)) then begin
          testf = false;
        end;
        if (POSBr.Modifiers==kKeyModifierShift and (shflag==false or ctrlflag)) then begin
          testf = false;
        end;
        if (POSBr.Modifiers==kKeyModifierCtrl and (shflag or ctrlflag==false)) then begin
          testf = false;
        end;
        if (POSBr.Modifiers==kKeyModifierCtrlShift and (shflag==false or ctrlflag==false)) then begin
          testf = false;
        end;
        if (testf) then begin
          IVDClassTouchScreenStackButtonExecute(POSBr.Page);
          res = true;
          goto LIVDClassPageFunctionKey;
        end;
      end;
    end;
  end;
LIVDClassPageFunctionKey:;    
  IVDClassPageFunctionKey = res;
  return;
end;

global
updating procedure IVDClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  boolean found,testf;
  integer i,wn,rwcnt;
  record POSButtonsVc POSBr;
  row POSButtonsVc POSBrw;
  
  wn = CurWindow;

  found = POSButtonsForWindow(wn,POSBr);
  if (found) then begin
    rwcnt = MatRowCnt(POSBr);
    for (i = 0; i<rwcnt; i = i + 1) begin
      MatRowGet(POSBr,i,POSBrw);
      if (POSBrw.KeyCode==keycode) then begin
        testf = true;
        if (POSBrw.Modifiers==kKeyModifierNone and (shflag or ctrlflag)) then begin
          testf = false;
        end;
        if (POSBrw.Modifiers==kKeyModifierShift and (shflag==false or ctrlflag)) then begin
          testf = false;
        end;
        if (POSBrw.Modifiers==kKeyModifierCtrl and (shflag or ctrlflag==false)) then begin
          testf = false;
        end;
        if (POSBrw.Modifiers==kKeyModifierCtrlShift and (shflag==false or ctrlflag==false)) then begin
          testf = false;
        end;
        if (testf) then begin
          if (IVDClassTouchScreenButton(POSBr,POSBrw)==false) then begin
            IVDClassTouchScreenPasteButtonDo(i+1);
          end;
          goto LIVDClassFunctionKey;
        end;
      end;
    end;
  end;
  if (IVDClassPageFunctionKey(keycode,shflag,ctrlflag)) then begin
    goto LIVDClassFunctionKey;
  end;
LIVDClassFunctionKey:;  
  return;
end;

global
procedure IVDClassOnWindowRecordChange(Integer wn)
begin
  record IVVc IVr;
  
  GetWindowRecord(wn,IVr);   
  if (WindowState(wn)!=Rs_normal) then begin
    if (TouchScreenLook) then begin
      IVDClass_RefreshStringList(wn,IVr);
    end;
  end;
  if (TouchScreenLook) then begin
    ReRunWindowDef(wn);
  end;
//  IVSumupSoftEditFields(wn,IVr);
//  PutWindowRecord(wn,IVCashr); causes crash cause PutWindowRecord calls OnWindowRecordChange so ....
  return;
end;


global
function Boolean IVDClassUpdateWebBrowser()
begin
	integer i,wn,mtrw,sline,matrowix;
	record CompaniesBlock CBb;// Edit ************************** Tuesday, 4 December 2012 15:41:07
  row CompaniesBlock CBrw;// Edit ************************** Tuesday, 4 December 2012 15:41:08
  string 50 path,port,tstr1;// Edit ************************** Tuesday, 4 December 2012 15:58:05
  record ProgramStatusBlock PSb;	
  string 255 tag,hostIp;
  record IVVc IVr;
  row IVVc IVrw;
  record INVc INr;
  
  
  wn = curwindow;
  sline = SelectedListLine(wn);
  
  if (sline<>-1) then begin
    tag = GetListTag(wn,sline);
    if ((tag==USetStr(24172)) or (tag==USetStr(24173)) or (tag==USetStr(24171))) then begin
      matrowix = -1;
    end else begin
      matrowix = StringToLongInt(tag);
    end;
  end else begin
    matrowix = -1;
  end;
  
  if (matrowix>=0) then begin
  GetWindowRecord(wn,IVr);
  MatRowGet(IVr,matrowix,IVrw);
		switch (IVrw.stp) begin
			case kInvoiceRowTypeNormal:	
			if(nonblank(IVrw.ArtCode))then begin
				blockload(CBb);
				matrowget(CBb,currentcompany-1,CBrw);
				blockload(PSb);
				port = PSb.httpPort;
				path = CBrw.TCPIP;
				hostIp = CBrw.TCPIP;
				//SWAROVSKI LLADRO J&W V&B Creative Ambiance Carpets Cadenza
				//Edit-------------------Vitalii 15:59 18.10.2017
        /*if(currentcompany==5)then begin
					tstr1 = GetINImageAttach(IVrw.ArtCode);//J&W Cartier itp
				end else begin
					if(currentcompany==9)then begin
						INr.Code = IVrw.ArtCode;
						readfirstmain(INr,1,true);
						tstr1 = INr.AlternativeCode;
					end else begin
						tstr1 = IVrw.ArtCode;
					end;
				end;*/
        tstr1 = IVrw.ArtCode;
        
       	setwindowsubset(wn,"http://" & hostIp & ":1070/index?user=" & currentuser & curmachinename & CurrentCompany);
				//setwindowsubset(wn,"http://" & path & ":" & port & "/WebGetINImage.hal?image=" & tstr1 & "&curcomp=" & currentcompany & "&user=" & currentuser);
				ReRunWindowDef(wn);
			end;
		end;
	end;			
				
  
return;
end;

global
function Boolean IVDClassListDoubleClick(Integer wn,Integer rownr)
begin
	
return;
end;

global
function Boolean IVDClassListClick(Integer wn,Integer rownr)
begin
  integer sline,matrowix,res;
  string 255 tstr,t2,tag,classstr;
  record IVVc IVr;
  row IVVc IVrw;
  val t;
  Boolean testf;
  record PLDefVc PLDefr;// Edit ************************** Thursday, 4 April 2013 10:21:02
  record PLVc PLr;// Edit ************************** Thursday, 4 April 2013 10:21:03
  string 5 plcur;// Edit ************************** Thursday, 4 April 2013 10:21:03
  val plprice;// Edit ************************** Thursday, 4 April 2013 10:28:39
  string 200 pltstr;
  record INVc INr;
  record DIVc DIr;
    
  sline = SelectedListLine(wn);
  if (sline<>-1) then begin
    tag = GetListTag(wn,sline);
    if ((tag==USetStr(24172)) or (tag==USetStr(24173)) or (tag==USetStr(24171))) then begin
      matrowix = -1;
    end else begin
      matrowix = StringToLongInt(tag);
    end;
  end else begin
    matrowix = -1;
  end;
  GetWindowRecord(wn,IVr);


  if (matrowix>=0) then begin
    MatRowGet(IVr,matrowix,IVrw);
    millisleep(50);
    switch (IVrw.stp) begin
      case kInvoiceRowTypeStructuredItemComponent:
        goto LkInvoiceRowTypeNormal1;
      case kInvoiceRowTypeNormal:
LkInvoiceRowTypeNormal1:;
// Edit Start ---------------------------------------------- Edit Start
	//Thursday, 4 April 2013 10:44:04
			/*if(nonblank(IVr.PriceList))then begin
				PLDefr.Code = IVr.PriceList;
				if(readfirstmain(PLDefr,1,true))then begin
					plcur = PLDefr.CurncyCode;
				end;
			end;
				if(nonblank(IVr.PriceList))then begin
					PLr.ArtCode = IVrw.ArtCode;
					PLr.PLCode = IVr.PriceList;
					if(readfirstmain(PLr,2,true))then begin
						if(nonblank(PLr.CurncyCode) and PLr.CurncyCode!=plcur)then begin
							plcur = PLr.CurncyCode;
						end;
						plprice = PLr.ExVatPrice;
					end;
				end;
				pltstr = "";// Edit ************************** Thursday, 4 April 2013 10:43:51
				if(IVr.CurncyCode!=plcur and nonblank(plcur))then begin
					pltstr = "(" & plprice & plcur &")";// Edit ************************** Thursday, 4 April 2013 10:43:52
				end;
				*/
	// Edit End ---------------------------------------------- Edit End
		 		//pltstr = GetPriceString(IVr.PriceList,IVrw.ArtCode,IVr.CurncyCode);
		 		GetTwoStrings(IVr.PriceList,IVrw.ArtCode,IVr.CurncyCode,pltstr,classstr,IVrw.SerialNr);
			  tstr = ValToString(IVrw.Quant,M4UVal,"",".",0) & "*" & ValToString(IVrw.Price,M4Val,"",".",0) & pltstr;
        M4PadString(ValToString(IVrw.Sum,M4Val,"",".",0),40-len(tstr)," ",true,t2);// Edit ************************** Monday, 25 March 2013 13:04:24
        tstr = tstr & t2;  
        SetPOSWindowDisplay(IVrw.ArtCode & " " & IVrw.Spec,tstr);
        
        //INr.Code = IVrw.ArtCode;
        //readfirstmain(INr,1,true);
        //tstr = GetClassString(IVrw.ArtCode);
        PutWindowString(wn,"CustomerDisplayData_Line3",classstr);
        SendToServerArtCode(IVrw.ArtCode,currentuser,curmachinename,CurrentCompany); //Edit***************************Sasha2,15:20 27.04.2017
        //PutWindowString(wn,"CustomerDisplayData_Line3",ParseClassification(INr.DispGroups));// Edit ************************** Thursday, 2 May 2013 11:29:34
     
      case kInvoiceRowTypeCashPayment:
        tstr = IVrw.Spec & "  " & ValToString(IVrw.Sum,M4Val,ThousandSeparator,DecimalSeparator,0);
        SetPOSWindowDisplay(tstr,"");
      otherwise
        SetPOSWindowDisplay("","");
    end;
  end else begin
    testf = true;
    tstr = ""; t2 = "";
    if (tag==USetStr(24172)) then begin
      t = IVr.RetValue;
      if (t<0) then begin t = 0.00; testf = false; end;
      if (blank(t)) then begin t = 0.00; testf = false; end;
      tstr = USetStr(24172) & "  " & ValToString(t,M4Val,ThousandSeparator,DecimalSeparator,0);
    end;
    if (testf) then begin    
      SetPOSWindowDisplay(tstr,t2);
    end else begin
      SetPOSWindowDisplay("","");
    end;
  end;
  //PutWindowString(wn,"touchscreenselecteditemtag",tstr);
  IVDClassListClick = false;
  return;
end;

global
updating procedure ProceedMainSerialNrNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  string 255 tstr,t2;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    if (RepSpec.long1>=0) then begin
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedMainSerialNrNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedMainSerialNrNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedMainSerialNrNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedMainSerialNrNPTSSClass;
            end;
        end;
        MatRowGet(IVr,RepSpec.long1,IVrw);
        IVrw.MotherNr = RepSpec.f1;
        MatRowPut(IVr,RepSpec.long1,IVrw);
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
    end;
    end;
  end;
LProceedMainSerialNrNPTSSClass:;  
  WindowFieldGoto(mwn,IVr,-1,"ivcashcommand",true);
  return;
end;

global
updating procedure ProceedMainSerialNrNPTSSClass()
begin  
  ProceedMainSerialNrNPTSSClassExecute(CurWindow);
  return;
end;

global
procedure IVDClassTouchScreenMainSerialNrExecute(LongInt rownr)
begin
  Integer wn,mwn,line;
  record RcVc RepSpec;
  record IVVc IVr;
  row IVVc IVrw;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  RepSpec.long1 = rownr;
  if (RepSpec.long1<0) then begin
    RepSpec.long1 = GetSelectedPOSItemRowIndex(mwn);
  end;
  if (RepSpec.long1>=0) then begin
    GetWindowRecord(mwn,IVr);
    MatRowGet(IVr,RepSpec.long1,IVrw);
    testf = true;
    if (IVr.OKFlag!=0) then begin testf = false; end;
    if (IVr.Invalid!=0) then begin testf = false; end;
    if (RepSpec.long1<0) then begin testf = false; end;
    if (testf) then begin
      RepSpec.f1 = IVrw.MotherNr;
      wn = OpenWindow("MainSerialNrNPTSSClass",0,mwn,"","",RepSpec);
      WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
    end;
  end;
  return;
end;

global
procedure IVDClassTouchScreenMainSerialNr()
begin
  IVDClassTouchScreenMainSerialNrExecute(-1);
  return;
end;

updating procedure AttachGSXNotesToSVOSer(record SVOSerVc SVOSerr,record NotepadVc csNotesr,record NotepadVc Notesr)
begin
  if (SizeTextCnt(csNotesr)>0) then begin
    CreateRecordLink(SVOSerr,CurrentCompany,csNotesr,CurrentCompany);
  end;
  if (SizeTextCnt(Notesr)>0) then begin
    CreateRecordLink(SVOSerr,CurrentCompany,Notesr,CurrentCompany);
  end;
  return;
end;

global
updating procedure IVDClassTouchScreenAppleWarrantyStatusCheck()
begin
  Integer wn,rownr;
  record IVVc IVr;
  row IVVc IVrw;
  string 255 tstr;
  Boolean testf,found;
  record ACPVc ACPr;
  record SVOSerVc SVOSerr;
  record INVc INr;
  record NotepadVc csNotesr,Notesr;
  array string 255 a_partNumbers;
  string 255 sessionID,errormsg;
  record GSXSettingsBlock GSb;
  date d;
  Boolean eligiblef,resellerstatusf;
  
  wn = CurWindow;
  rownr = GetSelectedPOSItemRowIndex(wn);
  GetWindowRecord(wn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (rownr<0) then begin testf = false; end;
  if (testf) then begin
    MatRowGet(IVr,rownr,IVrw);
    ACPr.ArtCode = IVrw.ArtCode;
    if (ReadFirstMain(ACPr,1,true)==false) then begin
      MessageBox(23702,"");
      goto LIVDClassTouchScreenAppleWarrantyStatusCheck;
    end;
    if (blank(IVrw.MotherNr)) then begin
      MessageBox(23700,"");
      goto LIVDClassTouchScreenAppleWarrantyStatusCheck;
    end;
    SVOSerr.ItemCode = IVrw.ArtCode;
    SVOSerr.SerialNr = IVrw.MotherNr;
    found = ReadFirstMain(SVOSerr,2,true);
    if (found==false) then begin
      SVOSerr.SerialNr = IVrw.MotherNr;
      found = ReadFirstMain(SVOSerr,1,true);
    end;
    resellerstatusf = true;
    if (found==false) then begin
      RecordNew(SVOSerr);
      SVOSerr.ItemCode = ""; //IVrw.ArtCode; find item code of serial nr , but what in case of items we have not sold ? 
      SVOSerr.SerialNr = IVrw.MotherNr;
      INr.Code = SVOSerr.ItemCode;
      if (ReadFirstMain(INr,1,true)) then begin
        SVOSerr.ItemName = INr.Name;
      end;
      SVOSerr.CustCode = IVr.CustCode;
      SVOSerr.CustName = IVr.Addr0;
      //TODO: fill in all more of the basics (cost, sold date that we know about, etc)
    end else begin
      if (SVOSerr.CoverageEndDate>CurrentDate) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = true;
        resellerstatusf = false;
      end;
      if (SVOSerr.CoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.CoverageEndDate)) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = false;
        resellerstatusf = false;
      end;
      if (blankdate(SVOSerr.CoverageEndDate)) and (SVOSerr.ContractCoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = false;
        resellerstatusf = false;
      end;
      if (nonblankdate(SVOSerr.CoverageEndDate)) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
        if (SVOSerr.ContractCoverageEndDate<CurrentDate) then begin
          eligiblef = false;
          resellerstatusf = false;
        end;
        if (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
          eligiblef = true;
          resellerstatusf = false;
        end;
      end;
    end;
//686641
    if (resellerstatusf) then begin
      BlockLoad(GSb);
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
  //      if (GSXWarrantyStatus(sessionID,IVrw.MotherNr,d,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
        if (GSXResellerWarrantyStatus(sessionID,IVr,rownr,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
          RecordStore(SVOSerr,true);
          AttachGSXNotesToSVOSer(SVOSerr,csNotesr,Notesr);      
  
          if (SVOSerr.CoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.CoverageEndDate)) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23704," " & SVOSerr.WarrantyStatus);
          end;
          if (blankdate(SVOSerr.CoverageEndDate)) and (SVOSerr.ContractCoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23704," " & SVOSerr.WarrantyStatus);
          end;

          if (nonblankdate(SVOSerr.CoverageEndDate)) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
            if (SVOSerr.ContractCoverageEndDate<CurrentDate) then begin
              MessageBox(23704," " & SVOSerr.WarrantyStatus);
            end;
            if (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
              MessageBox(23706," " & SVOSerr.WarrantyStatus);
            end;
          end;
          if (SVOSerr.CoverageEndDate>CurrentDate) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23705,"");
          end;
        end else begin 
          MessageBox(0,errormsg);
        end;
  //    if (GSXLogout(sessionID)) then begin StopAlert("logout ok"); end;
      end else begin
        MessageBox(0,errormsg);
  //      IVrw.MotherNr = "";
  //      MatRowPut(IVr,rownr,IVrw);
  //      PutWindowRecord(wn,IVr);
  //      WindowDoOK(wn,0);
      end;
    end else begin
      if (eligiblef) then begin
        MessageBox(23706,"");
      end else begin
        MessageBox(23704,"");
      end;
    end;
  end;
  if (testf) then begin
  end;
LIVDClassTouchScreenAppleWarrantyStatusCheck:;
  return;
end;

global
updating procedure IVDClassTouchScreenAppleCreateAEOrder()
begin
  Integer wn,rownr;
  record IVVc IVr;
  row IVVc IVrw;
  string 255 tstr;
  Boolean testf,found;
  record ACPVc ACPr;
  record SVOSerVc SVOSerr;
  record INVc INr;
  record NotepadVc csNotesr,Notesr;
  array string 255 a_partNumbers;
  string 255 sessionID,errormsg;
  record GSXSettingsBlock GSb;
  date d;
  Boolean eligiblef,resellerstatusf;
  
  wn = CurWindow;
  rownr = GetSelectedPOSItemRowIndex(wn);
  GetWindowRecord(wn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (rownr<0) then begin testf = false; end;
  if (testf) then begin
    MatRowGet(IVr,rownr,IVrw);
    if (IVrw.AEStatus==kGSXAutoEnrollmentSent) then begin
      MessageBox(23708,"");
      goto LIVDClassTouchScreenAppleCreateAEOrder;
    end;
    ACPr.ArtCode = IVrw.ArtCode;
    if (ReadFirstMain(ACPr,1,true)==false) then begin
      MessageBox(23702,"");
      goto LIVDClassTouchScreenAppleCreateAEOrder;
    end;
    if (blank(IVrw.MotherNr)) then begin
      MessageBox(23700,"");
      goto LIVDClassTouchScreenAppleCreateAEOrder;
    end;
    BlockLoad(GSb);
    SVOSerr.ItemCode = IVrw.ArtCode;
    SVOSerr.SerialNr = IVrw.MotherNr;
    found = ReadFirstMain(SVOSerr,2,true);
    if (found==false) then begin
      SVOSerr.SerialNr = IVrw.MotherNr;
      found = ReadFirstMain(SVOSerr,1,true);
    end;
    resellerstatusf = true;
    if (found==false) then begin
      RecordNew(SVOSerr);
      SVOSerr.ItemCode = ""; //IVrw.ArtCode; find item code of serial nr , but what in case of items we have not sold ? 
      SVOSerr.SerialNr = IVrw.MotherNr;
      INr.Code = SVOSerr.ItemCode;
      if (ReadFirstMain(INr,1,true)) then begin
        SVOSerr.ItemName = INr.Name;
      end;
      SVOSerr.CustCode = IVr.CustCode;
      SVOSerr.CustName = IVr.Addr0;
      //TODO: fill in all more of the basics (cost, sold date that we know about, etc)
    end else begin
      if (SVOSerr.CoverageEndDate>CurrentDate) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = true;
        resellerstatusf = false;
      end;
      if (SVOSerr.CoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.CoverageEndDate)) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = false;
        resellerstatusf = false;
      end;
      if (blankdate(SVOSerr.CoverageEndDate)) and (SVOSerr.ContractCoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = false;
        resellerstatusf = false;
      end;
      if (nonblankdate(SVOSerr.CoverageEndDate)) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
        if (SVOSerr.ContractCoverageEndDate<CurrentDate) then begin
          eligiblef = false;
          resellerstatusf = false;
        end;
        if (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
          eligiblef = true;
          resellerstatusf = false;
        end;
      end;
    end;
    if (resellerstatusf) then begin
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
  //      if (GSXWarrantyStatus(sessionID,IVrw.MotherNr,d,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
        if (GSXResellerWarrantyStatus(sessionID,IVr,rownr,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
          RecordStore(SVOSerr,true);
          AttachGSXNotesToSVOSer(SVOSerr,csNotesr,Notesr);      
  
          if (SVOSerr.CoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.CoverageEndDate)) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23704," " & SVOSerr.WarrantyStatus);
            eligiblef = false;
          end;
          if (blankdate(SVOSerr.CoverageEndDate)) and (SVOSerr.ContractCoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23704," " & SVOSerr.WarrantyStatus);
            eligiblef = false;
          end;

          if (nonblankdate(SVOSerr.CoverageEndDate)) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
            if (SVOSerr.ContractCoverageEndDate<CurrentDate) then begin
              MessageBox(23704," " & SVOSerr.WarrantyStatus);
              eligiblef = false;
            end;
            if (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
              MessageBox(23706," " & SVOSerr.WarrantyStatus);
              eligiblef = false;
            end;
          end;
          if (SVOSerr.CoverageEndDate>CurrentDate) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23705,"");
            eligiblef = true;
          end;
        end else begin 
          MessageBox(0,errormsg);
          eligiblef = false;
        end;
        
      end;
    end else begin
      if (eligiblef==false) then begin
        MessageBox(23704,"");
      end;
    end;
    if (eligiblef) then begin
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
        if (GSXResellerAutoEnrollment(GSb,sessionID,IVr,rownr,errormsg)) then begin
          MatRowGet(IVr,rownr,IVrw);
          IVrw.AEStatus = kGSXAutoEnrollmentSent;
          MatRowPut(IVr,rownr,IVrw);
          PutWindowRecord(wn,IVr);
          WindowDoOK(wn,0);
          IVDClass_RefreshStringList(wn,IVr);
        end;
      end;
      MessageBox(0,errormsg);
    end;
  end;
LIVDClassTouchScreenAppleCreateAEOrder:;
  return;
end;

global
updating procedure IVDClassTouchScreenAppleCancelAEOrder()
begin
  Integer wn,rownr;
  record IVVc IVr;
  row IVVc IVrw;
  string 255 tstr;
  Boolean testf,found;
  record ACPVc ACPr;
  record SVOSerVc SVOSerr;
  record INVc INr;
  record NotepadVc csNotesr,Notesr;
  array string 255 a_partNumbers;
  string 255 sessionID,errormsg;
  record GSXSettingsBlock GSb;
  date d;
  
  wn = CurWindow;
  rownr = GetSelectedPOSItemRowIndex(wn);
  GetWindowRecord(wn,IVr);
  testf = true;
//  if (IVr.OKFlag!=0) then begin testf = false; end;
//  if (IVr.Invalid!=0) then begin testf = false; end;
  if (rownr<0) then begin testf = false; end;
  if (testf) then begin
    MatRowGet(IVr,rownr,IVrw);
    if (IVrw.AEStatus!=kGSXAutoEnrollmentSent) then begin
      MessageBox(23705,"");
      goto LIVDClassTouchScreenAppleCancelAEOrder;
    end;
    ACPr.ArtCode = IVrw.ArtCode;
    if (ReadFirstMain(ACPr,1,true)==false) then begin
      MessageBox(23702,"");
      goto LIVDClassTouchScreenAppleCancelAEOrder;
    end;
    if (blank(IVrw.MotherNr)) then begin
      MessageBox(23700,"");
      goto LIVDClassTouchScreenAppleCancelAEOrder;
    end;
    BlockLoad(GSb);
    SVOSerr.ItemCode = IVrw.ArtCode;
    SVOSerr.SerialNr = IVrw.MotherNr;
    found = ReadFirstMain(SVOSerr,2,true);
    if (found==false) then begin
      SVOSerr.SerialNr = IVrw.MotherNr;
      found = ReadFirstMain(SVOSerr,1,true);
    end;
    testf = false;
    if (found==false) then begin
      RecordNew(SVOSerr);
      SVOSerr.ItemCode = ""; //IVrw.ArtCode; find item code of serial nr , but what in case of items we have not sold ? 
      SVOSerr.SerialNr = IVrw.MotherNr;
      INr.Code = SVOSerr.ItemCode;
      if (ReadFirstMain(INr,1,true)) then begin
        SVOSerr.ItemName = INr.Name;
      end;
      SVOSerr.CustCode = IVr.CustCode;
      SVOSerr.CustName = IVr.Addr0;
      //TODO: fill in all more of the basics (cost, sold date that we know about, etc)
    end else begin
      if (SVOSerr.CoverageEndDate>CurrentDate) and (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
        testf = true;
      end;
      if (nonblank(SVOSerr.APPAgreementNumber)) then begin
        testf = true;
      end;
    end;
    if (testf==false) then begin
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
        if (GSXResellerWarrantyStatus(sessionID,IVr,rownr,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
          RecordStore(SVOSerr,true);
          AttachGSXNotesToSVOSer(SVOSerr,csNotesr,Notesr);
          if (SVOSerr.CoverageEndDate>CurrentDate) and (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
            testf = true;
          end;
          if (nonblank(SVOSerr.APPAgreementNumber)) then begin
            testf = true;
          end;
        end else begin 
          MessageBox(0,errormsg);
        end;        
      end;
    end;
    if (testf) then begin
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
        if (GSXResellerCancelAutoEnrollment(GSb,sessionID,IVr,rownr,errormsg)) then begin
          MatRowGet(IVr,rownr,IVrw);
          IVrw.AEStatus = kGSXAutoEnrollmentCancelled;
          MatRowPut(IVr,rownr,IVrw);
          PutWindowRecord(wn,IVr);
          WindowDoOK(wn,0);
          IVDClass_RefreshStringList(wn,IVr);
        end;
      end;
      MessageBox(0,errormsg);
    end else begin
      MessageBox(23704,"");
    end;
  end;
LIVDClassTouchScreenAppleCancelAEOrder:;
  return;
end;

global
updating procedure ProceedHiddenLineNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedHiddenLineNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedHiddenLineNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedHiddenLineNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedHiddenLineNPTSSClass;
            end;
        end;
        ClearRow(IVr,IVrw,17);
        IVrw.Spec = RepSpec.f1;
        MatRowPut(IVr,MatRowCnt(IVr),IVrw);
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        CloseWindow(wn);
        WindowFieldGoto(mwn,IVr,-1,"ivcashcommand",true);
    end;
  end;
LProceedHiddenLineNPTSSClass:;  
  return;
end;

global
updating procedure ProceedHiddenLineNPTSSClass()
begin  
  ProceedHiddenLineNPTSSClassExecute(CurWindow);
  return;
end;

global
updating function boolean HiddenLineNPTSSClassOnOKWindow(integer wn)
begin
  ProceedHiddenLineNPTSSClassExecute(wn);
  HiddenLineNPTSSClassOnOKWindow = false;
  return;
end;

global
procedure IVDClassTouchScreenHeaderLine()
begin
  Integer wn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    wn = OpenWindow("HiddenLineNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
updating procedure ProceedSubtotalLineNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedSubtotalLineNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedSubtotalLineNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedSubtotalLineNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedSubtotalLineNPTSSClass;
            end;
        end;
        if (RepSpec.long1<0) then begin goto LProceedSubtotalLineNPTSSClass; end;
        ClearRow(IVr,IVrw,9);
        IVrw.Spec = RepSpec.f1;
        MatRowInsert(IVr,RepSpec.long1,IVrw);
        RecalcIVSubtotal(IVr);
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        CloseWindow(wn);
        WindowFieldGoto(mwn,IVr,-1,"ivcashcommand",true);
    end;
  end;
LProceedSubtotalLineNPTSSClass:;  
  return;
end;

global
updating procedure ProceedSubtotalLineNPTSSClass()
begin  
  ProceedSubtotalLineNPTSSClassExecute(CurWindow);
  return;
end;

global
updating function boolean HiddenLineNPTSSClassOnOKWindow(integer wn)
begin
  ProceedHiddenLineNPTSSClassExecute(wn);
  HiddenLineNPTSSClassOnOKWindow = false;
  return;
end;

SetLangMode(LangRussian,"RUS",0);

global
updating procedure IVDClassTouchScreenSubtotalLine()
begin
  Integer wn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    RepSpec.long1 = GetSelectedPOSItemRowIndex(mwn)+1;
    if(currentcompany==4)then begin
			RepSpec.f1 = "    1+1";// Edit ************************** Wednesday, 2 March 2016 15:31:36
			
			//ProceedSubtotalLineNPTSSClass;// Edit ************************** Wednesday, 2 March 2016 15:32:28
			
			switch (WindowState(mwn)) begin
				case Rs_update:
					GetPrevWindowRecord(mwn,prevIVr);
					if (prevIVr.OKFlag!=0) then begin
						CloseWindow(wn);
						goto LIVDClassTouchScreenSubtotalLine;
					end;
					if (prevIVr.Invalid!=0) then begin
						CloseWindow(wn);
						goto LIVDClassTouchScreenSubtotalLine;
					end;
				case Rs_normal:
					GetWindowRecord(mwn,prevIVr);
					if (prevIVr.OKFlag!=0) then begin
						CloseWindow(wn);
						goto LIVDClassTouchScreenSubtotalLine;
					end;
					if (prevIVr.Invalid!=0) then begin
						CloseWindow(wn);
						goto LIVDClassTouchScreenSubtotalLine;
					end;
        end;
        if (RepSpec.long1<0) then begin goto LIVDClassTouchScreenSubtotalLine; end;
        ClearRow(IVr,IVrw,9);
        IVrw.Spec = RepSpec.f1;
        MatRowInsert(IVr,RepSpec.long1,IVrw);
        RecalcIVSubtotal(IVr);
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        WindowFieldGoto(mwn,IVr,-1,"ivcashcommand",true);
			
    end else begin
			wn = OpenWindow("SubtotalLineNPTSSClass",0,mwn,"","",RepSpec);
			WindowFieldGoto(wn,RepSpec,-1,"f1",false);
    end;

LIVDClassTouchScreenSubtotalLine:;

  end;
  return;
end;

global
procedure IVDClassTouchScreenHiddenLine()
begin
  Integer wn;
  record IVVc IVr;

  wn = CurWindow;
  AddInvoiceLineType(GetSelectedPOSItemRowIndex(wn)+1,10,false);
  GetWindowRecord(wn,IVr);
  IVDClass_RefreshStringList(wn,IVr);
  return;
end;

global
procedure IVDClassTouchScreenInvoiceStatus()
begin
  IVInfoIVDsm;
  return;
end;

global
procedure IVDClassTouchScreenOpenNLTransaction()
begin
  OpenTRFromIV;
  return;
end;

global
updating procedure IVDClassTouchScreenSendToFiscalDevice()
begin
  PrintToFiscPrntIVDsm;
  return;
end;

global
procedure IVDClassTouchScreenProformaInvoice()
begin
  PrintProformaIVDsm;
  return;
end;

global
procedure IVDClassTouchScreenOpenTaxMatrix()
begin
  TestVatMatrixIVDsmExecute(GetSelectedPOSItemRowIndex(CurWindow));
  return;
end;

global
procedure IVDClassTouchScreenManagerDiscountOverride()
begin
  return;
end;

global
updating procedure IVDClassTouchScreenCreateCreditEMail()
begin
  CreateMailFromIVDsm;
  return;
end;

global
updating procedure IVDClassTouchScreenCreateCreditNote()
begin
  CreateCreditNoteIVDsm;
  return;
end;

global
procedure IVDClassTouchScreenCreateCashin()
begin
  DoCLInFromIVD;
  return;
end;

global
updating procedure ProceedConnectToPrepaymentNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedConnectToPrepaymentNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedConnectToPrepaymentNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedConnectToPrepaymentNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedConnectToPrepaymentNPTSSClass;
            end;
        end;

        rownr = MatRowCnt(IVr);
        ClearRow(IVr,IVrw,6);
        IVrw.Spec = USetStr(1288);
        IVrw.CUPNr = RepSpec.long1;
        MatRowPut(IVr,rownr,IVrw);
        IVVc_PasteCUPNr(IVr,rownr);
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        CloseWindow(wn);
        WindowFieldGoto(mwn,IVr,-1,"ivcashcommand",true);
    end;
  end;
LProceedConnectToPrepaymentNPTSSClass:;  
  return;
end;

global
updating procedure ProceedConnectToPrepaymentNPTSSClass()
begin  
  ProceedConnectToPrepaymentNPTSSClassExecute(CurWindow);
  return;
end;

global
updating function boolean ConnectToPrepaymentNPTSSClassOnOKWindow(integer wn)
begin
  ProceedConnectToPrepaymentNPTSSClassExecute(wn);
  ConnectToPrepaymentNPTSSClassOnOKWindow = false;
  return;
end;

global
procedure IVDClassTouchScreenConnectToPrepayment()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVVc IVr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    wn = OpenWindow("ConnectToPrepaymentNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"long1",false);    
  end;
  return;
end;

global
updating procedure ProceedChangeTermsNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  record IVVc prevIVr;
  string 255 tstr;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeTermsNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeTermsNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeTermsNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeTermsNPTSSClass;
            end;
        end;
        if (IVr.PayDeal!=RepSpec.FirstAcc) then begin
          tstr = IVr.PayDeal;
          IVr.PayDeal = RepSpec.FirstAcc;
          IVVc_PastePayDeal(IVr,tstr,"");
        end;
        IVr.CustOrdNr = RepSpec.f1;
        IVr.OurContact = RepSpec.f2;
        IVr.ClientContact = RepSpec.f3;
        IVr.OfficialSerNr = RepSpec.f4;
        IVr.Location = RepSpec.LastAcc;
        IVr.Objects = RepSpec.ObjStr;
        IVVc_PasteLocation(IVr,-1);// Edit ************************** Wednesday, 17 September 2014 14:54:31
        IVr.LangCode = RepSpec.Language;
        
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        ReRunWindowDef(mwn);
        CloseWindow(wn);
        WindowFieldGoto(mwn,IVr,-1,"ivcashcommand",true);
    end;
  end;
LProceedChangeTermsNPTSSClass:;  
  return;
end;

global
updating procedure ProceedChangeTermsNPTSSClass()
begin  
  ProceedChangeTermsNPTSSClassExecute(CurWindow);
  return;
end;

global
updating function boolean ChangeTermsNPTSSClassOnOKWindow(integer wn)
begin
  ProceedChangeTermsNPTSSClassExecute(wn);
  ChangeTermsNPTSSClassOnOKWindow = false;
  return;
end;

global
procedure IVDClassTouchScreenChangeTerms()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVVc IVr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    RepSpec.FirstAcc = IVr.PayDeal;
    RepSpec.f1 = IVr.CustOrdNr;
    RepSpec.f2 = IVr.OurContact;
    RepSpec.f3 = IVr.ClientContact;
    RepSpec.f4 = IVr.OfficialSerNr;
    RepSpec.LastAcc = IVr.Location;
    RepSpec.Language = IVr.LangCode;
    RepSpec.ObjStr = IVr.Objects;
    wn = OpenWindow("ChangeTermsNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
updating procedure ProceedChangeAddressNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVVc IVr;
  record IVVc prevIVr;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeAddressNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeAddressNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeAddressNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeAddressNPTSSClass;
            end;
        end;
        IVr.Addr0 = RepSpec.f6;
        IVr.Addr1 = RepSpec.f1;
        IVr.Addr2 = RepSpec.f2;
        IVr.Addr3 = RepSpec.f3;
        IVr.InvAddr3 = RepSpec.f4;
        IVr.InvAddr4 = RepSpec.f5;
        IVr.VATNr = RepSpec.f12;
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        ReRunWindowDef(mwn);
        CloseWindow(wn);
        WindowFieldGoto(mwn,IVr,-1,"ivcashcommand",true);
    end;
  end;
LProceedChangeAddressNPTSSClass:;  
  return;
end;

global
updating procedure ProceedChangeAddressNPTSSClass()
begin  
  ProceedChangeAddressNPTSSClassExecute(CurWindow);
  return;
end;

global
updating function boolean ChangeAddressNPTSSClassOnOKWindow(integer wn)
begin
  ProceedChangeAddressNPTSSClassExecute(wn);
  ChangeAddressNPTSSClassOnOKWindow = false;
  return;
end;

global
procedure IVDClassTouchScreenChangeAddress()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVVc IVr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVr);
  testf = true;
  if (IVr.OKFlag!=0) then begin testf = false; end;
  if (IVr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    RepSpec.f6 = IVr.Addr0;
    RepSpec.f1 = IVr.Addr1;
    RepSpec.f2 = IVr.Addr2;
    RepSpec.f3 = IVr.Addr3;
    RepSpec.f4 = IVr.InvAddr3;
    RepSpec.f5 = IVr.InvAddr4;
    RepSpec.f12 = IVr.VATNr;
    wn = OpenWindow("ChangeAddressNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
updating procedure IVDClassTouchScreenOpenSession()
begin
  OpenPOSSessionsm;
  return;
end;

global
updating procedure IVDClassTouchScreenCloseSession()
begin
  ClosePOSSessionsm;
  return;
end;

global
procedure IVDClassTouchScreenPutCashFloat()
begin
  POSMoneyInsm;
  return;
end;

global
procedure IVDClassTouchScreenGetCashFloat()
begin
  POSMoneyOutsm;
  return;
end;

global
procedure IVDClassTouchScreenCashupReport()
begin
  IVCashCashupRnsm;
  return;
end;

global 
procedure IVDClassTouchScreenAllInvoices()
begin
  Integer wn,nwn;
  record IVVc IVr;
  record UserVc Userr;
  string 255 subset;

  Userr.Code = CurrentUser;
  ReadFirstMain(Userr,1,true);
  switch (Userr.limitedAccess) begin
    case 1: subset = Userr.Code;
    case 2: subset = Userr.SalesGroup;
  end;
  wn = CurWindow;
  nwn = OpenWindow("IVLClass",1,wn,subset,"",IVr);  
  return;
end;

global
updating procedure IVDClassTouchScreenCreateActivity()
begin
  IVDClassNewActivity;
  return;
end;

global
procedure IVDClassTouchScreenOpenCalendar()
begin
  IVDClassOpenCalendar;
  return;
end;

global
procedure IVDClassTouchScreenReturn()
begin
  IVDClassToolIVReturn;
  return;
end;

global
updating procedure IVDClassTouchScreenPrint()
begin
  record IVVc IVr;

  PrintIVReceiptDsm;
//  if (WindowDoOK(CurWindow,0)) then begin
//    IVDClassPrint(CurWindow,false);
//  end;
  return;
end;
