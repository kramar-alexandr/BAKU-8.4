//server-only
external procedure ExtractObj(string,var Integer,var string);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external function roundmode SetRoundModeD(Integer);
external function Boolean SetInSet2(string,string);
external function val AbsoluteVal(val);
external function boolean CompanyIsJWLikeCompany(Integer);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);
external  function string 100 BPICodeToName(string);
external function boolean CheckUserBrands(string,var vector boolean);
external procedure LogProcTime(string,longint);
external procedure ExtractObjectsByType(string, string, var array string, var integer);
remote updating procedure AddPLHist(record PLVc,record PLVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 21:14 25.04.2022



SetLangMode(LangRussian,"RUS",0);


function string 30 getINItemCode(record INVc INr)
begin
  record GlobalItemVc GIr;
  string 30 res;
  
  if(nonblank(INr.AlternativeCode))then begin
    res = INr.AlternativeCode;
  end else begin
    if(nonblank(INr.GlobalArtCode))then begin
      GIr.Code = INr.GlobalArtCode;
      readfirstmain(GIr,1,true);
      res = GIr.HansaCode;
    end else begin
      res = INr.BarCode;
    end;
  end;
  getINItemCode = res;
return;
end;

function string 200 prepareStr(string input)
begin
integer i,length;
string 200 res;
  length = len(input);
  For(i=0;i<length;i=i+1) begin
	  if(mid(input,i,1)==chr(34))then begin
	    res = res;
	  end else begin
	    res = res & mid(input,i,1);
	  end;	  
	end; 
  
  prepareStr = res;
return;
end;

function string 200 ParseClassification(string class)
begin
	string 200 res,cl;
	record DIVc DIr;
	integer pos;
	
	if(nonblank(class))then begin
		pos = 0;
		ExtractObj(class,pos,cl);
		DIr.Code = cl;
		if(readfirstmain(DIr,1,true))then begin
			res = DIr.Name;
			outstring(0,0,DIr.Name,false);
		end else begin
			outstring(0,0,"",false);
		end;
	
		ExtractObj(class,pos,cl);
		if(nonblank(cl))then begin
			DIr.Code = cl;
			if(readfirstmain(DIr,1,true))then begin
				if(nonblank(DIr.Code))then begin
					res = res & "," & DIr.Name;
				end;
				if(currentcompany>3)then begin
					outstring(0,0,DIr.Name,false);
				end;
			end else begin
				if(currentcompany>3)then begin
					outstring(0,0,"",false);
				end;
			end;
		end else begin
			if(currentcompany>3)then begin
				outstring(0,0,"",false);
			end;
		end;
	end else begin
		outstring(0,0,"",false);
		if(currentcompany>3)then begin
			outstring(0,0,"",false);
		end;
	end;
	
	ParseClassification = res;
return;
end;


global
procedure FindFIFOOrigValAndCurncySD(longint sernr, integer rownr, var val fifo, var string cur,var val fifobase,boolean updst,var array string addCurs,var vector val currencyBalances,Boolean additionalCurF,var boolean fifofound) //Edit***************************Sasha2,16:03 13.09.2017
begin
	record ItemHistVc IHr,IH2r;
	record PUVc PUr;
	row PUVc PUrw;
	integer mtrw,i,j;
	record INVc INr;
	string 20 artcode;
	date ivdate;
	boolean find;
	record IVVc IVr;
	row IVVc IVrw;
	record ORVc ORr;
	row ORVc ORrw;
	record SHVc SHr;
	row SHVc SHrw;
	boolean TrHs,testf,findsec,TrHs1,TrHs2;
	val fr,to1,to2,br1,br2,tval;
	integer halt;	
	date curDate,blankd;
	
	fifo = 0;
	cur = "";
	fifobase = 0;
  fifofound = false;
	if (additionalCurF) then begin //Edit***************************Sasha2,14:23 14.09.2017 {
    for (j=0;j<addCurs.length;j=j+1) begin
      currencyBalances[addCurs[j]] = BlankVal;
    end;
	end; //Edit***************************Sasha2,14:23 14.09.2017 }
	
	if(true)then begin
		IHr.FileName = "SDVc";
		IHr.TransNr = sernr;
		IHr.Row = rownr;
		TrHs = true;
		while(loopkey("FNTransNr",IHr,3,TrHs)) begin
			if(IHr.FileName!="SDVc")then begin TrHs = false; end;
			if(IHr.TransNr!=sernr)then begin TrHs = false; end;
			if(IHr.Row!=rownr)then begin TrHs = false; end;
			
			if(TrHs)then begin
				fifobase = fifobase + IHr.TotCostPrice;
				fifofound = true;
				if(IHr.CurncyCode=="AZN")then begin
					INr.Code = IHr.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						if(INr.LastPurchCurncyCode!="AZN")then begin
							IH2r.FileName = "SDVc";
							IH2r.ArtCode = IHr.ArtCode;
							IH2r.TransDate = IHr.TransDate;
							IH2r.SerNr = IHr.SerNr;
							TrHs2 = true;
							while(loopbackkey("FNArtCode",IH2r,4,TrHs2))begin
								if(IH2r.FileName!="SDVc")then begin TrHs2 = false; end;
								if(IH2r.ArtCode!=IHr.ArtCode)then begin TrHs2 = false; end;
								
								if(TrHs2 and IH2r.CurncyCode==INr.LastPurchCurncyCode and IHr.TotCostPrice==IHr.TotCostPrice)then begin
									IHr.TotCostPriceCurncy = IH2r.TotCostPriceCurncy;
									IHr.CurncyCode = IH2r.CurncyCode;
									TrHs2 = false;
								end;
							end;
							resetloop(IH2r);
						end;
					end;
				end;
				
				fifo = fifo + IHr.TotCostPriceCurncy;
				cur = IHr.CurncyCode;
				if (additionalCurF) then begin  //Edit***************************Sasha2,16:09 13.09.2017 {
  				for (j=0;j<addCurs.length;j=j+1) begin
  				  if (addCurs[j]==IHr.CurncyCode) then begin
  				    currencyBalances[addCurs[j]] = currencyBalances[addCurs[j]] + IHr.TotCostPriceCurncy;
  				  end else begin
  				    curDate = IHr.InDate;
  				    if (BlankDate(curDate)) then begin
  				      curDate = IHr.TransDate;
  				    end;
  				    if (NonBlankDate(curDate)) then begin
  				      CurValToOtherCur(curDate,IHr.CurncyCode,IHr.TotCostPriceCurncy,addCurs[j],tval,DefaultCurRoundOff);
  				      currencyBalances[addCurs[j]] = currencyBalances[addCurs[j]] + tval;
  				    end else begin
  				      LogText(0,"Report SalesReportExtRn. No date for IV #" & sernr & ", row #" & rownr);
  				    end;
  				  end;
  				end;
				end; //Edit***************************Sasha2,16:09 13.09.2017 }
			end;
		end;
	end;
	
	if(fifo<0)then begin fifo=-fifo; end;
	if(fifobase<0)then begin fifobase=-fifobase; end;
	if (additionalCurF) then begin //Edit***************************Sasha2,14:23 14.09.2017 {
    for (j=0;j<addCurs.length;j=j+1) begin
      if (currencyBalances[addCurs[j]]<0) then begin
        currencyBalances[addCurs[j]] = -currencyBalances[addCurs[j]];
      end;
    end;
	end; //Edit***************************Sasha2,14:23 14.09.2017 }
	
return;
end;

global
procedure FindFIFOOrigValAndCurncyIV(longint sernr, integer rownr, var val fifo, var string cur,var val fifobase,boolean updst,var array string addCurs,var vector val currencyBalances,Boolean additionalCurF,var boolean fifofound) //Edit***************************Sasha2,16:03 13.09.2017
begin
	record ItemHistVc IHr,IH2r;
	record PUVc PUr;
	row PUVc PUrw;
	integer mtrw,i,j,keys;
	record INVc INr;
	string 20 artcode;
	date ivdate;
	boolean find;
	record IVVc IVr;
	row IVVc IVrw;
	record ORVc ORr;
	row ORVc ORrw;
	record SHVc SHr;
	row SHVc SHrw;
	boolean TrHs,testf,findsec,TrHs1,TrHs2;
	val fr,to1,to2,br1,br2,tval;
	val halt;	
	date curDate,blankd;
	
	fifo = 0;
	cur = "";
	fifobase = 0;
  fifofound = false;
	if (additionalCurF) then begin //Edit***************************Sasha2,14:23 14.09.2017 {
    for (j=0;j<addCurs.length;j=j+1) begin
      currencyBalances[addCurs[j]] = BlankVal;
    end;
	end; //Edit***************************Sasha2,14:23 14.09.2017 }
	
	if(updst)then begin
		IHr.FileName = "IVVc";
		IHr.TransNr = sernr;
		IHr.Row = rownr;
		TrHs = true;
		while(loopkey("FNTransNr",IHr,3,TrHs)) begin
			if(IHr.FileName!="IVVc")then begin TrHs = false; end;
			if(IHr.TransNr!=sernr)then begin TrHs = false; end;
			if(IHr.Row!=rownr)then begin TrHs = false; end;
			if(TrHs)then begin
				fifofound = true;
			
					 //CurValToOtherCur(curDate,IHr.CurncyCode,IHr.TotCostPriceCurncy,INr.LastPurchCurncyCode,IHr.TotCostPriceCurncy,DefaultCurRoundOff);
				if(IHr.CurncyCode=="AZN")then begin
					INr.Code = IHr.ArtCode;
					if(readfirstmain(INr,1,true))then begin
						if(INr.LastPurchCurncyCode!="AZN")then begin
							IH2r.FileName = "IVVc";
							IH2r.ArtCode = IHr.ArtCode;
							IH2r.TransDate = IHr.TransDate;
							IH2r.SerNr = IHr.SerNr;
							TrHs2 = true;
							while(loopbackkey("FNArtCode",IH2r,4,TrHs2))begin
								if(IH2r.FileName!="IVVc")then begin TrHs2 = false; end;
								if(IH2r.ArtCode!=IHr.ArtCode)then begin TrHs2 = false; end;
								//if(IH2r.TransNr!=sernr)then begin TrHs2 = false; end;
								
								if(TrHs2 and IH2r.CurncyCode==INr.LastPurchCurncyCode and IHr.TotCostPrice==IHr.TotCostPrice)then begin								
									 
									IHr.TotCostPriceCurncy = IH2r.TotCostPriceCurncy;
									IHr.CurncyCode = IH2r.CurncyCode;
									TrHs2 = false;
								end;
							end;
							resetloop(IH2r);
						end;
					end;
				end;
				fifo = fifo + IHr.TotCostPriceCurncy;
				fifobase = fifobase + IHr.TotCostPrice;
				cur = IHr.CurncyCode;
				if (additionalCurF) then begin  //Edit***************************Sasha2,16:09 13.09.2017 {
  				for (j=0;j<addCurs.length;j=j+1) begin
  				  if (addCurs[j]==IHr.CurncyCode) then begin
  				    currencyBalances[addCurs[j]] = currencyBalances[addCurs[j]] + IHr.TotCostPriceCurncy;
  				  end else begin
  				    curDate = IHr.InDate;
  				    if (BlankDate(curDate)) then begin
  				      curDate = IHr.TransDate;
  				    end;
  				    if (NonBlankDate(curDate)) then begin
  				      CurValToOtherCur(curDate,IHr.CurncyCode,IHr.TotCostPriceCurncy,addCurs[j],tval,DefaultCurRoundOff);
  				      currencyBalances[addCurs[j]] = currencyBalances[addCurs[j]] + tval;
  				    end else begin
  				      LogText(0,"Report SalesReportExtRn. No date for IV #" & sernr & ", row #" & rownr);
  				    end;
  				  end;
  				end;
				end; //Edit***************************Sasha2,16:09 13.09.2017 }
			end;
		end;
	end else begin
		IVr.SerNr = sernr;
    readfirstmain(IVr,1,true);
		matrowget(IVr,rownr,IVrw);
		halt = 0;
		TrHs = true;
		SHr.OrderNr=IVr.OrderNr;
		keys = 1;
		if(IVrw.SHNr>-1)then begin
		  SHr.SerNr = IVrw.SHNr;
		  keys = 2;
		end;
		while(loopkey("OrderKey",SHr,keys,TrHs)) begin
			if(SHr.OrderNr!=IVr.OrderNr)then begin TrHs=false; end;
			if(IVrw.SHNr>-1 and SHr.SerNr!=IVrw.SHNr)then begin TrHs=false; end;
			
			if(TrHs)then begin
				mtrw = matrowcnt(SHr);
				For(i=0;i<mtrw;i=i+1) begin
					matrowget(SHr,i,SHrw);
					if(SHrw.OrdRow==IVrw.OrdRow)then begin
						IHr.FileName = "SHVc";
						IHr.TransNr = SHr.SerNr;
						IHr.Row = i;
						TrHs1 = true;
						resetloop(IHr);
						while(loopkey("FNTransNr",IHr,3,TrHs1)) begin
							if(IHr.FileName!="SHVc")then begin TrHs1 = false; end;
							if(IHr.TransNr!=SHr.SerNr)then begin TrHs1 = false; end;
							if(IHr.Row!=i)then begin TrHs1 = false; end;
							if(TrHs1)then begin
								//if(halt<IVrw.Quant)then begin//Edit-------------------Vitalii 10:51 13.10.2017
									fifobase = fifobase + IHr.TotCostPrice;
									fifofound = true;
									if(IHr.CurncyCode=="AZN")then begin
										INr.Code = IHr.ArtCode;
										if(readfirstmain(INr,1,true))then begin
											if(INr.LastPurchCurncyCode!="AZN")then begin
												IH2r.FileName = "IVVc";
												IH2r.ArtCode = IHr.ArtCode;
												IH2r.TransDate = IHr.TransDate;
												IH2r.SerNr = IHr.SerNr;
												TrHs2 = true;
												while(loopbackkey("FNArtCode",IH2r,4,TrHs2))begin
													if(IH2r.FileName!="IVVc")then begin TrHs2 = false; end;
													if(IH2r.ArtCode!=IHr.ArtCode)then begin TrHs2 = false; end;
								
													if(TrHs2 and IH2r.CurncyCode==INr.LastPurchCurncyCode and IHr.TotCostPrice==IHr.TotCostPrice)then begin
														IHr.TotCostPriceCurncy = IH2r.TotCostPriceCurncy;
														IHr.CurncyCode = IH2r.CurncyCode;
														TrHs2 = false;
													end;
												end;
												resetloop(IH2r);
											end;
										end;
									end;
									fifo = fifo + IHr.TotCostPriceCurncy;
									cur = IHr.CurncyCode;
									if (additionalCurF) then begin //Edit***************************Sasha2,16:09 13.09.2017 {
  									for (j=0;j<addCurs.length;j=j+1) begin
            				  if (addCurs[j]==IHr.CurncyCode) then begin
            				    currencyBalances[addCurs[j]] = currencyBalances[addCurs[j]] + IHr.TotCostPriceCurncy;
            				  end else begin
            				    curDate = IHr.InDate;
            				    if (BlankDate(curDate)) then begin
            				      curDate = IHr.TransDate;
            				    end;
            				    if (NonBlankDate(curDate)) then begin
            				      CurValToOtherCur(curDate,IHr.CurncyCode,IHr.TotCostPriceCurncy,addCurs[j],tval,DefaultCurRoundOff);
            				      currencyBalances[addCurs[j]] = currencyBalances[addCurs[j]] + tval;
            				    end else begin
            				      LogText(0,"Report SalesReportExtRn. No date for SH #" & SHr.SerNr & ", row #" & i);
            				    end;
            				  end;
            				end;
									end; //Edit***************************Sasha2,16:09 13.09.2017 }
									halt = halt - IHr.Qty;
								/*end else begin//Edit-------------------Vitalii 10:51 13.10.2017
									TrHs1 = false;
									TrHs = false;
								end;*/
							end;
						end;
					end;
				end;
			end;
		end;
    fifo = fifo/halt*IVrw.Quant;//Edit-------------------Vitalii 10:51 13.10.2017
    fifobase = fifobase/halt*IVrw.Quant;//Edit-------------------Vitalii 10:51 13.10.2017
	end;
	if(fifo<0)then begin fifo=-fifo; end;
	if(fifobase<0)then begin fifobase=-fifobase; end;
	if (additionalCurF) then begin //Edit***************************Sasha2,14:23 14.09.2017 {
    for (j=0;j<addCurs.length;j=j+1) begin
      if (currencyBalances[addCurs[j]]<0) then begin
        currencyBalances[addCurs[j]] = -currencyBalances[addCurs[j]];
      end;
    end;
	end; //Edit***************************Sasha2,14:23 14.09.2017 }
	
return;
end;

//Edit***************************Sasha2,17:31 19.11.2014 {
function integer CalculateCoef(var record IVVc IV2r,var integer rangecnt,string item,string location,var Boolean iteminf,integer arrsize)
begin
  Integer i,rwcnt,coefv,pos;
  row IVVc IV2rw;
  Boolean foundf;
  
  foundf = false;
  iteminf = false;
  rwcnt = MatRowCnt(IV2r);
  for (i=0;i<rwcnt;i=i+1) begin
  	MatRowGet(IV2r,i,IV2rw);
    if (item==IV2rw.ArtCode and location==IV2rw.Location) then begin
      pos = i;
      coefv = IV2rw.Quant;
      foundf = true;
      iteminf = true;
      i = rwcnt;
      IV2rw.Sum = IV2rw.Sum + 1;
    end;
  end;
  if (foundf==false) then begin
    IV2rw.ArtCode = item;
    IV2rw.Location = location;
    IV2rw.Quant = rangecnt*arrsize;
    coefv = rangecnt*arrsize;
    rangecnt = rangecnt + 1;
    pos = rwcnt;
    IV2rw.Sum = 1;
  end;
  MatRowPut(IV2r,pos,IV2rw);
  
  CalculateCoef = coefv;
  
  return;
end; //Edit***************************Sasha2,17:32 19.11.2014 }

function integer CalculateCoefSD(var record SDVc SD2r,var integer rangecnt,string item,string location,var Boolean iteminf,integer arrsize)
begin
  Integer i,rwcnt,coefv,pos;
  row SDVc SD2rw;
  Boolean foundf;
  
  foundf = false;
  iteminf = false;
  rwcnt = MatRowCnt(SD2r);
  for (i=0;i<rwcnt;i=i+1) begin
  	MatRowGet(SD2r,i,SD2rw);
    if (item==SD2rw.ArtCode and location==SD2rw.Location) then begin
      pos = i;
      coefv = SD2rw.Qty;
      foundf = true;
      iteminf = true;
      i = rwcnt;
      SD2rw.BasePrice = SD2rw.BasePrice + 1;
    end;
  end;
  if (foundf==false) then begin
    SD2rw.ArtCode = item;
    SD2rw.Location = location;
    SD2rw.Qty = rangecnt*arrsize;
    coefv = rangecnt*arrsize;
    rangecnt = rangecnt + 1;
    pos = rwcnt;
    SD2rw.BasePrice = 1;
  end;
  MatRowPut(SD2r,pos,SD2rw);
  
  CalculateCoefSD = coefv;
  
  return;
end;


procedure PrintGftSertSold(record IVVc IVr,integer rownr,var val total_price,string bcur,string azn,Boolean addclassf,boolean modef)
begin
	row IVVc IVrw;
	integer j;

	matrowget(IVr,rownr,IVrw);
	total_price = total_price + IVrw.Sum;
	
	startformat(15);
		outstring(0,0,USetStr(2186),false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		if (modef) then begin
			outstring(0,0,"",false);
			if (addclassf==false) then begin
				outstring(0,0,"",false);
			end;
			if(currentcompany==9)then begin
				outstring(0,0,"",false);
			end;
			outstring(0,0,"",false);
			if (addclassf==false) then begin
				outstring(0,0,"",false);
				outstring(0,0,"",false);
				outstring(0,0,"",false);
				outstring(0,0,"",false);
				if(currentcompany==13)then begin
					outstring(0,0,"",false);
					outstring(0,0,"",false);
				end;
			end else begin
				for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
					outstring(0,0,"",false);
				end;
			end;
		end;
		outstring(0,0,"",false); //seriinii nomer
		outstring(0,0,"",false);
		outstring(0,0,"",false);//EKNCode
		outstring(0,0,"",false);
		outstring(100,0,"",false);
		outstring(101,0,"",false);
		if(bcur!=azn)then begin
			outstring(102,0,"",false);
		end;
		// outstring(110,0,"",false);
		// outstring(111,0,"",false);
		if(bcur!=azn)then begin
			outstring(112,0,"",false);
		end;
		// outstring(120,0,"",false);
		outstring(121,0,"",false);
		if(bcur!=azn)then begin
			outstring(122,0,"",false);
		end;
		outstring(130,0,"",false);
		outstring(131,0,IVrw.Sum,false);
		if(bcur!=azn)then begin
			outstring(132,0,"",false);
		end;
		outstring(140,0,"",false);
		outstring(141,0,"",false);
		if(bcur!=azn)then begin
			outstring(142,0,"",false);
		end;
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		outstring(0,0,"",false);
		if(currentcompany==9)then begin
			outstring(0,0,"",false);
		end;
		outstring(0,0,"",false);
	endformat;
return;
end;
//Edit***************************Sasha2,10:05 19.02.2016 {
procedure SortAndClearClassifications(var array string typecode,var vector string typename,val typescnt)
begin
  vector val typelevel;
  val level,val1,val2;
  string 20 code;
  String 200 name;
  Integer i,j;
  
    if (typescnt>1) then begin
      level = 1;
      typelevel["TYPE"] = level; level = level + 1;
      typelevel["COLL_W"] = level; level = level + 1;
      typelevel["MATERIAL_W"] = level; level = level + 1;
      typelevel["GENDER_W"] = level; level = level + 1; ///////
      typelevel["DIAL"] = level; level = level + 1;
      typelevel["STRAP"] = level; level = level + 1;
      typelevel["MECHANISM"] = level; level = level + 1;
      typelevel["FUNCTIONS"] = level; level = level + 1;
      typelevel["DIAMETER"] = level; level = level + 1;
      typelevel["COLL_J"] = level; level = level + 1;
      typelevel["CATEGORY_J"] = level; level = level + 1;
      typelevel["MATERIAL_J"] = level; level = level + 1;
      typelevel["WEIGHT"] = level; level = level + 1;
      typelevel["D_CARAT"] = level; level = level + 1;
      typelevel["CENT_ST"] = level; level = level + 1;
      typelevel["PR_STONES"] = level; level = level + 1;
      typelevel["STYLE_J"] = level; level = level + 1;
      typelevel["R_SIZE"] = level; level = level + 1;
      typelevel["DIVISION"] = level; level = level + 1;
      typelevel["GENDER_J"] = level; level = level + 1; //////
      typelevel["CARAT"] = level; level = level + 1;
      typelevel["CLARITY"] = level; level = level + 1;
      typelevel["C_S"] = level; level = level + 1;
      typelevel["SHAPE_CUT"] = level; level = level + 1;
      typelevel["COLL_A"] = level; level = level + 1;
      typelevel["CATEGORY_A"] = level; level = level + 1;
      typelevel["MATERIAL_A"] = level; level = level + 1;
      typelevel["STYLE_A"] = level; level = level + 1;
      typelevel["C_M"] = level; level = level + 1;
      typelevel["GENDER_A"] = level; level = level + 1; //////
      typelevel["WARCARD"] = level; level = level + 1;
      typelevel["ART"] = level; level = level + 1;
      typelevel["SAP"] = level; level = level + 1;
      
      for (i=0;i<typescnt-1;i=i+1) begin
        for (j=0;j<typescnt-1;j=j+1) begin
          if (typelevel[typecode[j]]<1) then begin
            typename[typecode[j]] = "";
            typecode[j] = "";
          end;
          val1 = typelevel[typecode[j]];
          val2 = typelevel[typecode[j+1]];
          if ((val1>0 and val2>0 and val1>val2) or (val1<1 and val2>0)) then begin
            code = typecode[j];
            name = typename[typecode[j]];
            typecode[j] = typecode[j+1];
            typename[typecode[j]] = typename[typecode[j+1]];
            typecode[j+1] = code;
            typename[typecode[j+1]] = name;
          end;
        end;
      end;
    end;
  
  return;
end; //Edit***************************Sasha2,10:05 19.02.2016 }

//Edit***************************Sasha2,14:42 11.11.2015 {
procedure MyClearVector(var vector string vect1,array string arr,integer cnt)
begin
  integer i;
  
    for (i=0;i<cnt;i=i+1) begin
      vect1[arr[i]] = "";
    end;
  
  return;
end; //Edit***************************Sasha2,14:42 11.11.2015 }


function string 255 GetECItemBrand (string GlobalCode)
begin
	record GlobalItemVc GIr;
	record BTRxBrandVc Brandr;
	string 255 res;

	GIr.Code = GlobalCode;
	if (ReadFirstMain(Gir,1,true)) then begin
		Brandr.Code = GIr.BPIBrand;
		if (ReadFirstMain(Brandr,1,true)) then begin
			res = Brandr.Name;
		end;
	end;



	GetECItemBrand = res;
return;
end;


function string 255 GetIVRebCode(string tstr,string obj)
begin
	record RebVc Rebr;
	record IVVc IVr;
	string 255 res;
	
	res = "";
	if(nonblank(tstr))then begin
		Rebr.Code = tstr;
		if(readfirstmain(Rebr,1,true))then begin
			if(SetInSet(Rebr.AddObject,obj))then begin
				res = tstr;
			end;
		end;
	end;
	
	GetIVRebCode = res;
return;
end;

function boolean FoundObjEx(row IVVc IVrw)
begin
	array string 255 fonders;
	integer oscnt;
	ExtractObjectsByType(IVrw.Objects,"FOUND",fonders,oscnt);
	if (nonblank(fonders[0])) then begin
		FoundObjEx = true;
	end else begin
		FoundObjEx = false;
	end;
	return;
end;



global
procedure AllItemCodesRn(record RcVc RepSpec)
begin
	record INVc INr;
	record BarcodeVc Brcr;
	
	StartReportJob("");
	startformat(15);
		outstring(11,0,"Код товара",false);
		outstring(150,0,"Альт. код",false);
		outstring(300,0,"Бар-код",false);
		outstring(451,0,"Доп бар-код",false);
	endformat;
	INr.Code = "";
	while(Loopmain(INr,1,true))begin
		startformat(15);
			outstring(11,0,INr.Code,false);
			outstring(150,0,INr.AlternativeCode,false);
			outstring(300,0,INr.BarCode,false);
			Brcr.Itemcode = INr.Code;
			if (ReadFirstMain(Brcr,1,true)) then begin
				outstring(451,0,Brcr.Barcode,false);
			end else begin
				outstring(451,0,"",false);
			end;
		endformat;
	end;
	EndJob;

 return;
end;

global
procedure SalesReportExtRn(record RcVc RepSpec)
begin
  record LocalMachineVc LMr;
  Date sd,ed;
  Boolean TrHs,testf;
  record IVVc IVr,IV2r;
  row IVVc IVrw,IV2rw;
  integer i,keyi,mtrw,k,j;
  string 20 keystr;
  record INVc INr,dupINr;
  string 100 classname,classname2,classcode; //Edit***************************Sasha2,11:14 20.11.2014
  record DIVc DIr;
  val brandfifo;
  string 5 brandcur;
  record PLVc PLr;
  val fr,to1,to2,br1,br2;
  val curcusm,curprice,fifob1;
  boolean testf1,userlocation;
  string 255 location,tstr,OBJStr,Obj,APriceObj,MTRXLoc;
  record UserVc User;
  integer pos,headrow;
  string 50 uloc,uloc1;
  boolean updst,modef;
	val total_rebate,total_rebate_qty;//Edit***********************Vitalii 14:28 26.08.2014
  val total_qty;
  val total_cost,total_price,total_gp;
  string 200 classfind,model,brand,category, conslocation, deflocation;
  record ORVc ORr;
  record BaseCurBlock BCb;
  string 5 bcur,azn;
  val bfr,bto;
  val aznfr,aznto,fifoazn;
  val btotal_cost,btotal_price,btotal_gp;
  array val arrvals; //Edit***************************Sasha2,10:46 20.11.2014
  array string 20 arrstrs; //Edit***************************Sasha2,10:46 20.11.2014
  integer valscnt,strscnt,rangeval,rangecnt,arrsize; //Edit***************************Sasha2,12:11 20.11.2014
  val itemoccurrences; //Edit***************************Sasha2,12:11 20.11.2014
  boolean iteminf,addclassf,tmpbool;
  integer cred;
  Record CTypeVc CTyper; //Edit***************************Sasha2,12:23 11.11.2015
  integer ctypecnt,m; //Edit***************************Sasha2,12:24 11.11.2015
  array string 10 typeindex; //Edit***************************Sasha2,14:08 11.11.2015
  vector string 255 dispnames; //Edit***************************Sasha2,14:08 11.11.2015
  record IVVc locIVr;
  vector string 20 typeval; //Edit***************************Sasha2,14:11 08.02.2016
  array string 20 typecode; //Edit***************************Sasha2,14:11 08.02.2016
  vector string 200 typename; //Edit***************************Sasha2,14:11 08.02.2016
  record DiCheckBlock DiCb; //Edit***************************Sasha2,14:10 08.02.2016
  row DiCheckBlock DiCbw; //Edit***************************Sasha2,14:10 08.02.2016
  integer rwcnt,typescnt,pos1; //Edit***************************Sasha2,14:11 08.02.2016
  Boolean collf,metalf; //Edit***************************Sasha2,14:09 02.06.2016
  string 20 collstr,metalstr; //Edit***************************Sasha2,14:09 02.06.2016
  vector val currencyBalances; //Edit***************************Sasha2,15:49 13.09.2017
	array string 10 addCurs; //Edit***************************Sasha2,15:50 13.09.2017
	Boolean additionalCurF, testf2; //Edit***************************Sasha2,10:33 14.09.2017
	val EURprice,EURcusm; //Edit***************************Sasha2,11:26 14.09.2017
	record CurncyCodeVc CurncyCoder; //Edit***************************Sasha2,13:55 14.09.2017
	record OldDIVc OldDIr;
  record ObjVc Objr;
	vector boolean userbrand;
  boolean userbrandf;
  record MarketingVc MCr;
  vector string 200 vVisitName,vVisitPhone;
  record CUVc CUr;
	record LCCashbackLevelVc LCCBLevelr;
  row LCCashbackLevelVc LCCBLevelrw;
  record LoyaltyCardVc LoyaltyCardr;
  roundmode rnd;
  Boolean found;
  Integer rowcnt;
  val loyCardPointsBalance,cashbackPercent;
	record ItemDuplicatesVc IDr;
  vector string 255 DubCodes;
	record LocationVc Locr;
	
  userbrandf = CheckUserBrands(currentuser,userbrand);
	
  blockload(BCb);
  bcur = BCb.BaseCur1;
	azn = "AZN";
	if(currentcompany==10)THEN BEGIN
		azn = "PLN";
	end;
	if(currentcompany==11 or currentcompany==12)THEN BEGIN
		azn = "IRR";
	end;
	headrow = 2;
  //SetLangMode(LangRussian,"RUS",0);
  		
  	
    StartReportJob(USetStr(31041)); //Edit***************************Sasha2,16:57 19.11.2014 {
    
    sd = RepSpec.sStartDate;
    ed = RepSpec.sEndDate;
    location = RepSpec.f1;
		Locr.Code = location;
		if (ReadFirstMain(Locr,1,true)) then begin
			if (nonblank(Locr.ConsigStockCode)) then begin
				conslocation = Locr.ConsigStockCode;
			end;
			if (nonblank(Locr.DefectStockCode)) then begin
				deflocation = Locr.DefectStockCode;
			end;
		end;
    
    Header(headrow,USetStr(13835) & sd & ":" & ed,0);
    headrow = headrow + 1;
    
    if (NonBlank(location)) then begin
  		Header(headrow,USetStr(31097) & ": " & location,0);
  	end else begin
  		Header(headrow,USetStr(31097) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	if (NonBlank(RepSpec.f2)) then begin
  		Header(headrow,USetStr(11605) & RepSpec.f2,0);
  	end else begin
  		Header(headrow,USetStr(11605) & USetStr(12727),0);
  	end;
    headrow = headrow + 1;
    
    if (NonBlank(RepSpec.f4)) then begin
  		Header(headrow,USetStr(31044) & ": " & RepSpec.f4,0);
  	end else begin
  		Header(headrow,USetStr(31044) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	if (NonBlank(RepSpec.f5)) then begin
  		Header(headrow,USetStr(8833) & ": " & RepSpec.f5,0);
  	end else begin
  		Header(headrow,USetStr(8833) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	EndHeader; //Edit***************************Sasha2,16:57 19.11.2014 }
  	
  	if (NonBlank(RepSpec.f7)) then begin //Edit***************************Sasha2,16:02 13.09.2017 {
  	  CurncyCoder.CurncyCode = RepSpec.f7;
  	  if (ReadFirstMain(CurncyCoder,1,true)) then begin
    	  addCurs[addCurs.length] = CurncyCoder.CurncyCode; 
    	  additionalCurF = true;
  	  end;
  	end;//Edit***************************Sasha2,16:02 13.09.2017 }
  	
  	if (CompanyIsJWLikeCompany(CurrentCompany)) then begin //Edit***************************Sasha2,11:27 02.06.2016 {
  	  addclassf = true;
  	end else begin
  	  addclassf = false;
  	end; 

  	if (addclassf) then begin
      typescnt = 0;
  	  BlockLoad(DiCb);
      rwcnt = MatRowCnt(DiCb);  
      for (j=0;j<rwcnt;j=j+1) begin
        MatRowGet(DiCb,j,DiCbw);
        if (NonBlank(DiCbw.DiType)) then begin
          DIr.Code = DiCbw.DiCode;
          ReadFirstMain(DIr,1,true);
          DiCbw.DiType = DIr.CType & "," & DiCbw.DiType;
          pos = 0;
    			ExtractObj(DiCbw.DiType,pos,uloc);
    			while (nonblank(uloc)) begin
    				if (blank(typeval[uloc])) then begin
      				CTyper.Code = uloc;
      				if (ReadFirstMain(CTyper,1,true)) then begin
      				  if (CTyper.Code=="GENDER") then begin
      				    switch (UpperCase(Left(DiCbw.DiCode,1))) begin
      				      case "A":
      				        if (blank(typeval[CTyper.Code & "_A"])) then begin
        				        typeval[CTyper.Code & "_A"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_A";
              				  typename[typecode[typescnt]] = "ACCESSORIES " & CTyper.Comment;
              				  typescnt = typescnt + 1;  
      				        end;
      				      case "J":
      				        if (blank(typeval[CTyper.Code & "_J"])) then begin
        				        typeval[CTyper.Code & "_J"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_J";
              				  typename[typecode[typescnt]] = "JEWELRY " & CTyper.Comment;
              				  typescnt = typescnt + 1;  
      				        end;
      				      case "W":
      				        if (blank(typeval[CTyper.Code & "_W"])) then begin
        				        typeval[CTyper.Code & "_W"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_W";
              				  typename[typecode[typescnt]] = "WATCH " & CTyper.Comment;
              				  typescnt = typescnt + 1;
      				        end;
      				    end;
      				  end else begin
        				  typeval[CTyper.Code] = ".";
        				  typecode[typescnt] = CTyper.Code;
        				  typename[CTyper.Code] = CTyper.Comment;
        				  typescnt = typescnt + 1;  
      				  end;
      				end;
    				end;
    				ExtractObj(DiCbw.DiType,pos,uloc);
    			end;
        end;
      end;
      SortAndClearClassifications(typecode,typename,typescnt);
    end;//Edit***************************Sasha2,11:27 02.06.2016 }

  	if (RepSpec.ArtMode==0) then begin
  		modef = true;
  	end else begin
  		modef = false;
  		RECORDNEW(IV2r);
  	end;
  
		userlocation = false;
		User.Code = currentuser;
		if(readfirstmain(User,1,true))then begin
			if(nonblank(User.UserLocations) and usercanaction("AllowReportWithUserLoc",false))then begin
				userlocation = true;
				pos = 0;
				ExtractObj(User.UserLocations,pos,uloc);
				while (nonblank(uloc)) begin
					if(uloc==location)then begin
						userlocation = false;
					end;
					ExtractObj(User.UserLocations,pos,uloc);
				end;
			end;
		end;
	
    if(userlocation)then begin
			startformat(15);
				outstring(50,0,USetStr(31014),false);
			endformat;
		end else begin
			if(nonblank(RepSpec.sStartDate) and nonblank(RepSpec.sEndDate))then begin
				StartFormat(15);
					outstring(0,0,USetStr(31102),false);
					outstring(40,0,RepSpec.sStartDate & ":" & RepSpec.sEndDate,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31103),false);
					if(nonblank(RepSpec.f1))then begin
						outstring(40,0,RepSpec.f1,false);
					end else begin
						outstring(40,0,USetStr(31104),false);
					end;
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31105),false);
					outstring(40,0,RepSpec.f2,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31205),false);
					outstring(40,0,RepSpec.f4,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31206),false);
					outstring(40,0,RepSpec.f5,false);
				endformat;
				StartFormat(15);
				endformat;
				
				
				
				startformat(15);
					outstring(0,0,USetStr(31042),false);
					outstring(0,0,USetStr(31043),false);
					if (RepSpec.ArtMode==0) then begin
						outstring(0,0,USetStr(36287),false); // Orirginal item code
						outstring(0,0,"Коды дубликатов",false);
					end;
					outstring(0,0,USetStr(12815),false); //Sklad
					if (modef) then begin
						outstring(0,0,USetStr(31044),false); //Brand
						if (addclassf==false) then begin //Edit***************************Sasha2,13:15 02.06.2016
							outstring(0,0,USetStr(19357),false); //Klassificatsia
						end;
						if(currentcompany==9)then begin
							outstring(0,0,USetStr(9131),false);		//Edit----------------------Dima  20.03.2015 //categoria
						end;
						outstring(0,0,USetStr(12713),false); //Naimenovanie
						if (addclassf==false And CurrentCompany==9) then begin //Edit***************************Sasha2,13:17 02.06.2016 {
							outstring(0,0,USetStr(31045),false);//Reference //Kollectsia
							outstring(0,0,USetStr(31047),false); //Tip metalla
							outstring(0,0,USetStr(14533),false); //Ves
							outstring(0,0,USetStr(31048),false); //Karatnost
							//if(CompanyIsJWLikeCompany(currentcompany))then begin
								//outstring(0,0,USetStr(31049),false); //Braslet/Remeshok
								//outstring(0,0,USetStr(31050),false); //Tsvet tsyferblata
							//end;
							if(currentcompany==13)then begin		//Edit-----------------------------Dima  30.04.2015
								outstring(0,0,USetStr(31320),false); //Tsvet
								outstring(0,0,USetStr(35007),false); //Kvadratura
							end else begin		
							outstring(0,0,USetStr(31320),false); //Tsvet//Edit_-_-_-_-_-_-_-_-Anton 13:42 07.05.2018
							outstring(0,0,USetStr(31321),false); //Razmer//Edit_-_-_-_-_-_-_-_-Anton 13:25 07.05.2018
						end;
						end else begin //Edit***************************Sasha2,13:17 02.06.2016 }
						 // for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
							 // outstring(0,0,typename[typecode[j]],false);
							//end;
						end;
					end;
					// if(CurrentCompany!=9) then begin
						// outstring(0,0,"Reference",false);
						// outstring(0,0,"Group",false); 
						// outstring(0,0,"SubGroup",false);
						// outstring(0,0,"Category",false);
						// if(currentcompany==25)then begin
							// outstring(0,0,"CC Collection",false); 
							// outstring(0,0,"Product Group",false); 							
						// end;
						// outstring(0,0,"Material",false); 		
						// if(currentcompany==13)then begin
							// outstring(0,0,"Size",false);
							// outstring(0,0,"Colour",false); 
						// end else begin
							// outstring(0,0,"Colour",false); 
							// outstring(0,0,"Size",false); 
						// end;						
						// if(CompanyIsJWLikeCompany(currentcompany))then begin
							// outstring(0,0,"Кар.",false); 
							// outstring(0,0,"JW Weight",false);
							// outstring(0,0,"SAP",false);
						// end;					
						// outstring(0,0,"Use",false);
						// outstring(0,0,"Sex",false);
						// outstring(0,0,"Plating",false);						
						// outstring(0,0,"Collection",false); 
						// outstring(0,0,"Clarity",false);
						// outstring(0,0,"Weight",false); 
						// outstring(0,0,"Cut",false); 
						// outstring(0,0,"Shape",false);
						// outstring(0,0,"Stone",false); 
						// outstring(0,0,"Strap",false);
						// outstring(0,0,"Odour",false);
						// outstring(0,0,"Year",false); 
						// outstring(0,0,"High",false); 
					// end;
					
					
					
					if(CurrentCompany!=9 and modef) then begin   // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 13:49 06.11.2020
						outstring(0,0,"Reference",false);
						outstring(0,0,"Collection",false); 
						outstring(0,0,"Group",false); 
						outstring(0,0,"SubGroup",false);
						outstring(0,0,"Category",false);
						outstring(0,0,"Material",false); 		
						outstring(0,0,"Colour",false); 
						outstring(0,0,"Year",false); 
						outstring(0,0,"Life",false); 
						outstring(0,0,"Size",false); 
						outstring(0,0,"Use",false);
						outstring(0,0,"Sex",false);
						outstring(0,0,"Plating",false);	
						outstring(0,0,"CC Collection",false); 						
						outstring(0,0,"Clarity",false);
						outstring(0,0,"Weight",false); 
						outstring(0,0,"Cut",false); 
						outstring(0,0,"Shape",false);
						outstring(0,0,"Stone",false); 
						outstring(0,0,"Strap",false);
						outstring(0,0,"Odour",false);
						outstring(0,0,"Product Group",false);
						if(CompanyIsJWLikeCompany(currentcompany))then begin
							outstring(0,0,"Кар.",false); 
							outstring(0,0,"JW Weight",false);
							outstring(0,0,"SAP",false);
						end;		
					end;
					
					
					
					
					
					
					
					
					outstring(0,0,USetStr(31051),false); //seriinii nomer
					outstring(0,0,"EAN code",false);
					outstring(0,0,USetStr(13199),false);//EKNCode
					outstring(0,0,USetStr(31052),false);
					if (left(CurrentUser,2)=="SA") then begin
						outstring(100,0,"EUR cur.rate",false);
					end;
					outstring(100,0,USetStr(31053),false);
					if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(100,0,USetStr(31055) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(101,0,USetStr(31055) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(102,0,USetStr(31055) & bcur,false);
					end;
					outstring(110,0,USetStr(31056),false);
					if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
					  outstring(110,0,USetStr(31058) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
					  outstring(111,0,USetStr(31058) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(112,0,USetStr(31058) & bcur,false);
					end;
					outstring(120,0,USetStr(31059),false);
					if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(120,0,USetStr(31061) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(121,0,USetStr(31061) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(122,0,USetStr(31061) & bcur,false);
					end;
					outstring(130,0,USetStr(31062),false);
					if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(130,0,USetStr(31064) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(131,0,USetStr(31064) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(132,0,USetStr(31064) & bcur,false);
					end;
					outstring(140,0,USetStr(31065),false);
					if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(140,0,USetStr(31067) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(141,0,USetStr(31067) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(142,0,USetStr(31067) & bcur,false);
					end;
					outstring(0,0,USetStr(31068),false);
					if (modef) then begin
						if(usercanaction("ViewCustomerInfo",true))then begin
							outstring(0,0,USetStr(31069),false);
							outstring(0,0,USetStr(31070),false);
							if (left(currentuser,2)=="SA") then begin
								outstring(0,0,USetStr(36442),false);
							end;
							if(RepSpec.flags[2]==1)then begin
								outstring(0,0,"Телефон клиента",false);
								outstring(0,0,"Фиксация визитов: Имя",false);
								outstring(0,0,"Фиксация визитов: Телефоны",false);
								outstring(0,0,"Карта лояльности",false);
								outstring(0,0,"Пол",false);
								outstring(0,0,"Возраст",false);
							end;
						end;
						
						outstring(0,0,USetStr(31071),false);
						outstring(0,0,USetStr(16709),false);
						outstring(0,0,USetStr(36286),false);
						outstring(0,0,USetStr(31072),false);
						outstring(0,0,USetStr(9269),false);
						
						outstring(0,0,USetStr(16574),false);
						if(currentcompany==9)then begin
							outstring(0,0,USetStr(3264),false);
						end;
						outstring(0,0,USetStr(36250),false);
						outstring(0,0,"Код доп. скидки",false);
						outstring(0,0,USetStr(31073),false);
						outstring(0,0,"Fiscal number",false);
					end;
					if(currentcompany==25 and RepSpec.flags[2]!=0) then begin
						outstring(0,0,"Текущий процент при покупке",false);
					end;
					//if (addclassf) then begin //Edit***************************Sasha2,14:00 08.02.2016 {
    			 // for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
      		 //   outstring(0,0,typename[typecode[j]],false);
      		 // end;
    			//end; //Edit***************************Sasha2,14:01 08.02.2016 }
					
					/*ctypecnt = 0; //Edit***************************Sasha2,14:10 11.11.2015 { 
					CTyper.Code = "";
					while (LoopMain(CTyper,1,true)) begin
					  typeindex[ctypecnt] = CTyper.Code;
					  dispnames[typeindex[ctypecnt]] = "";
					  outstring(0,0,CTyper.Code,false);
					  ctypecnt = ctypecnt + 1;
					end;*///Edit***************************Sasha2,14:10 11.11.2015 }	
				endformat;

				total_rebate = 0;//Edit***********************Vitalii 14:28 26.08.2014
				total_rebate_qty = 0;
				total_qty = 0;
				total_cost = 0;
				total_price = 0;
				total_gp = 0;
				btotal_cost = 0;
				btotal_price = 0;
				btotal_gp = 0;
				rangecnt = 0; //Edit***************************Sasha2,11:41 20.11.2014
				arrsize = 25; 
				
				//arrsize = arrsize + ctypecnt; //Edit***************************Sasha2,16:49 11.11.2015
				arrsize = arrsize + typescnt;
				
				IVr.TransDate = sd;
				keyi = 1;
				keystr = "TransDate";
				
				// _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 14:58 14.01.2020
				
				// Для вывода отчета по кодам локаций с матриц счетов-фактур не подходит следующий ключ
				
				// if(nonblank(location))then begin	
					// IVr.Location = location;
					// keyi = 2;
					// keystr = "Location";
				// end;
				
				if(RepSpec.flags[2]==1)then begin
					MCr.TransDate = sd;
					TrHs = true;
					while(loopkey("TransDate",MCr,1,TrHs))begin
						if(MCr.TransDate>ed)then begin TrHs = false; end;
					
						if(TrHs)then begin
							if(nonblank(MCr.InvNr))then begin
								pos = 0;
								tstr = "";
								ExtractObj(MCr.InvNr,pos,tstr);
								while(nonblank(tstr))begin
									if(nonblank(tstr))then begin
										vVisitName[tstr] = MCr.Name;
										vVisitPhone[tstr] = MCr.Phone3 & " " & MCr.Phone2 & " " & MCr.Phone1;
									end;
									ExtractObj(MCr.InvNr,pos,tstr);
								end;
							end;
						end;
					end;
				end;
				LCCBLevelr.LCMLevel = "CASACOIN";
				found = ReadFirstMain(LCCBLevelr,1,true);
				TrHs = true;
				while(loopkey(keystr,IVr,keyi,TrHs)) begin
					if(CurrentCompany==25 and RepSpec.flags[2]!=0) then begin
						cashbackPercent = 0;
						LoyaltyCardr.SerNr = IVr.LoyaltyCardNr;
						if ((nonblank(IVr.LoyaltyCardNr) and ReadFirstMain(LoyaltyCardr,1,true))) then begin
							rnd = DefaultValRoundoff;
							rnd.decimals = 2;
							rnd.mode = kRoundingModeHalfUp;
							loyCardPointsBalance = LoyaltyCardr.CashbackLevelPoints;
							rowcnt = MatRowCnt(IVr);							
							if (found) then begin						
								rnd.decimals = LCCBLevelr.RndTo;
								rwcnt = MatRowCnt(LCCBLevelr);
								for (i=0;i<rwcnt;i=i+1) begin
									MatRowGet(LCCBLevelr,i,LCCBLevelrw);
									if (LCCBLevelrw.FromPoints<=loyCardPointsBalance and LCCBLevelrw.CashbackPercent>0) then begin									
										if (LCCBLevelrw.ToPoints>=loyCardPointsBalance or LCCBLevelrw.ToPoints==BlankVal) then begin
											cashbackPercent = LCCBLevelrw.CashbackPercent;
											i = rwcnt;
										end;
									end;
								end;
							end;	
						end;
					end;
					testf = true;
					cred = 1;
					if(IVr.InvType==kInvoiceTypeCredit)then begin
						cred = -1;
					end;
										
					
					if(RepSpec.flags[1]!=0 and IVr.OrderNr!=-1) then begin testf = false; end;
					if(IVr.InvDate<sd)then begin testf = false; end;
					if(IVr.InvDate>ed)then begin TrHs = false; testf = false; end;
					// if(nonblank(location) and IVr.Location!=location)then begin TrHs = false; testf = false; end;
					if(IVr.OKFlag==0)then begin testf = false; end;
					if(IVr.Invalid>0)then begin testf = false; end;
					if(nonblank(RepSpec.f6) and !setinset(IVr.CustCode,RepSpec.f6))then begin testf = false; end;
					if(nonblank(RepSpec.f8) and !setinset(RepSpec.f8,IVr.Objects))then begin testf = false; end;
					if(IVr.PriceList!="RRP" and IVr.PriceList!="CC" and RepSpec.flags[3]!=0) then begin testf = false; end;
					
					if(RepSpec.flags[4]==1)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 21 09 2020 y. at 11:38:16 AM
						if(IVr.ECOMMERCEOrdf==0)then begin
							testf = false;
						end;
					end;
					if(RepSpec.flags[4]==2)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 21 09 2020 y. at 11:38:16 AM
						if(IVr.ECOMMERCEOrdf!=0)then begin
							testf = false;
						end;
					end;
					
					if(RepSpec.flags[6]==1)then begin
					  if(blank(IVr.TaxTransactionCode))then begin
					    testf = false;
					  end;
					end;
					
					if(testf)then begin
						mtrw = matrowcnt(IVr);
						
						tstr = "";
						For(i=0;i<mtrw;i=i+1) begin
	  					matrowget(IVr,i,IVrw);
	  					if(setinset(IVrw.PayMode,tstr)==false)then begin
	  						if(nonblank(tstr))then begin
	  							tstr = tstr & ",";
	  						end;
	  						tstr = tstr & IVrw.PayMode;
	  					end;
						end; 
						
						if(RepSpec.flags[2]==1)then begin
							CUr.Code = IVr.CustCode;
							readfirstmain(CUr,1,true);
						end;
						
						For(i=0;i<mtrw;i=i+1) begin
							testf2 = true;
							matrowget(IVr,i,IVrw);
							matrowget(IVr,i,IV2rw);
							
							if(nonblank(IVrw.Location))then begin // conslocation, deflocation
								if(nonblank(location) and IVrw.Location!=location and IVrw.Location!=conslocation and IVrw.Location!=deflocation)then begin testf2 = false; end;
							end else begin
								if(nonblank(location) and IVr.Location!=location and IVr.Location!=conslocation and IVr.Location!=deflocation)then begin testf2 = false; end;
							end;
							if(testf2)then begin
								if(IVrw.stp==kInvoiceRowTypeGiftVoucherSold and blank(RepSpec.f4) and blank(RepSpec.f5) and blank(RepSpec.f2) and blank(RepSpec.f9) and blank(RepSpec.f10) and userbrandf==false)then begin
									PrintGftSertSold(IVr,i,total_price,bcur,azn,addclassf, modef);
								end;
								if(IVrw.stp==kInvoiceRowTypeNormal and nonblank(IVrw.ArtCode))then begin
									INr.Code = IVrw.ArtCode;
									readfirstmain(INr,1,true);
									testf1=true;
									IDr.DupCode = IVrw.ArtCode;
									INr.Code = IVrw.ArtCode;
									if(RepSpec.flags[5]==1 and INr.ConsgType!=1) then begin testf1 = false; end;
									if(ReadFirstKey("DupCode",IDr,1,true) and testf1) then begin
										dupINr.Code = IDr.OrigCode;
										while(LoopMain(dupINr,1,testf2)) begin
											if(dupINr.Code!=IDr.OrigCode) then begin testf2 = false; end;
											if(dupINr.BPIBrand==IDr.OrigBrandCode and testf2) then begin
												INr.Code = IDr.OrigCode;
												DubCodes[IDr.OrigCode] = IDr.DupCode;
											end;
										end;
									end;
									readfirstmain(INr,1,true);
									testf2=true;
								
									if(RepSpec.flags[0]==1 and INr.OutOfOrder==1)then begin testf1 = false; end;
									if(nonblank(RepSpec.f2) and testf1)then begin
										testf1=SetInSet2(RepSpec.f2,INr.DispGroups);
									end;
									if(nonblank(RepSpec.f9) and !setinset(RepSpec.f9,IVrw.Objects))then begin testf1 = false; end;
									if(nonblank(RepSpec.f10) and RepSpec.f10!=IVrw.ArtCode)then begin testf1 = false; end;
									
									if(userbrandf and testf1)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 19 06 2019 y. at 4:35:18 PM
										pos = 0;
										brand = "";
										testf1 = false;
										ExtractObj(INr.DispGroups,pos,brand);
										while(nonblank(brand)) begin
											if(userbrand[brand])then begin
												testf1 = true;
											end;
											ExtractObj(INr.DispGroups,pos,brand);
										end;
									end;
									
									if(testf1)then begin
										if(nonblank(RepSpec.f4) or nonblank(RepSpec.f5))then begin
											brand = "";
											model = "";
											category = "";
											pos = 0;
											classfind = "";
											ExtractObj(INr.DispGroups,pos,classfind);
											while(nonblank(classfind)) begin
												DIr.Code = classfind;
												readfirstmain(DIr,1,true);
												if(DIr.CType=="BRAND")then begin
													brand = DIr.Code;
												end;
												if(DIr.CType=="MODEL")then begin
													model = DIr.Code;
												end;
												ExtractObj(INr.DispGroups,pos,classfind);
											end;
											if(nonblank(RepSpec.f4) and brand!=RepSpec.f4)then begin
												testf1 = false;
											end;
											if(nonblank(RepSpec.f5) and model!=RepSpec.f5)then begin
												testf1 = false;
											end;
										end;
									end;
									
									if(testf1) then begin
										pos = 0;
										brand = "";
										model = "";
										if (addclassf) then begin //Edit***************************Sasha2,14:05 02.06.2016 {
											ExtractObj(INr.DispGroups,pos,uloc);
											while (NonBlank(uloc)) begin
												DIr.Code = uloc;
												if (readfirstmain(DIr,1,true)) then begin
													if (DIr.CType=="BRAND") then begin
														brand = DIr.Name;
													end;
													if (DIr.CType=="MODEL") then begin
														model = DIr.Name;
													end;
													if (NonBlank(DIr.CType)) then begin 
														if (DIr.CType=="GENDER") then begin
															switch (Left(UpperCase(INr.MainDisp),1)) begin
																case "A":
																	DIr.CType = DIr.CType & "_A";
																	typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
																case "J":
																	DIr.CType = DIr.CType & "_J";
																	typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
																case "W":
																	DIr.CType = DIr.CType & "_W";
																	typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
															end;
														end else begin
															typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
															switch (Left(UpperCase(INr.MainDisp),1)) begin //if classifications in custom separate fields {
																case "A":
																	if (NonBlank(INr.Reference)) then begin
																		collf = true;
																		collstr = "COLL_A";
																	end;
																	if (NonBlank(INr.Metal)) then begin
																		metalf = true;
																		metalstr = "MATERIAL_A";
																	end;
																case "J":
																	if (NonBlank(INr.Reference)) then begin
																		collf = true;
																		collstr = "COLL_J";
																	end;
																	if (NonBlank(INr.Metal)) then begin
																		metalf = true;
																		metalstr = "MATERIAL_J";
																	end;
																	if (NonBlank(INr.RowWeight)) then begin
																		tstr = typeval["WEIGHT"];
																		pos1 = 0;
																		ExtractObj(tstr,pos1,uloc1);
																		if (uloc1==INr.Code) then begin
																			ExtractObj(tstr,pos1,uloc1);
																			if (blank(uloc1)) then begin
																				typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
																			end;
																		end else begin
																			typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
																		end;
																	end;
																	if (NonBlank(INr.MajStoneDet)) then begin
																		tstr = typeval["D_CARAT"];
																		pos1 = 0;
																		ExtractObj(tstr,pos1,uloc1);
																		if (uloc1==INr.Code) then begin
																			ExtractObj(tstr,pos1,uloc1);
																			if (blank(uloc1)) then begin
																				typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
																			end;
																		end else begin
																			typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
																		end;
																	end;
																case "W":
																	if (NonBlank(INr.Reference)) then begin
																		collf = true;
																		collstr = "COLL_W";
																	end;
																	if (NonBlank(INr.Metal)) then begin
																		metalf = true;
																		metalstr = "MATERIAL_W";
																	end;
															end; 
															if (collf) then begin
																tstr = typeval[collstr];
																pos1 = 0;
																ExtractObj(tstr,pos1,uloc1);
																if (uloc1==INr.Code) then begin
																	ExtractObj(tstr,pos1,uloc1);
																	if (blank(uloc1)) then begin
																		typeval[collstr] = INr.Code & ";" & INr.Reference;
																	end;
																end else begin
																	typeval[collstr] = INr.Code & ";" & INr.Reference;
																end;  
																collf = false;
															end;
															if (metalf) then begin
																tstr = typeval[metalstr];
																pos1 = 0;
																ExtractObj(tstr,pos1,uloc1);
																if (uloc1==INr.Code) then begin
																	ExtractObj(tstr,pos1,uloc1);
																	if (blank(uloc1)) then begin
																		typeval[metalstr] = INr.Code & ";" & INr.Metal;
																	end;
																end else begin
																	typeval[metalstr] = INr.Code & ";" & INr.Metal;
																end;
																metalf = false;
															end;//if classifications in custom separate fields }
														end;
													end;
												end; //Edit***************************Sasha2,14:05 02.06.2016 }
												ExtractObj(INr.DispGroups,pos,uloc);
											end;
										end;
										if (modef) then begin
											startformat(15);
										end;
											if (modef) then begin
												if(Left(INr.Code,3)=="IN_") then begin
												  outstring(0,0,getINItemCode(INr),false);
													outstring(0,0,INr.Code,false);
												end else begin
													if (left(INr.Code,2)=="IN" and currentcompany==29) then begin
														outstring(0,0,Right(INr.GlobalArtCode,len(INr.GlobalArtCode)-9),false);
														outstring(0,0,INr.Code,false);
													end else begin
														outstring(0,0,INr.Code,false);
														outstring(0,0,INr.AlternativeCode,false);
													end;
												end;
												outstring(0,0,INr.OrigCode,false);  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:48 27.08.2019
												outstring(0,0,DubCodes[INr.Code],false);
												if(nonblank(IVrw.Location))then begin
													outstring(0,0,IVrw.Location,false);
												end else begin
													outstring(0,0,IVr.Location,false);
												end;
												
												if (addclassf==false) then begin
													classname = "";
													if(nonblank(INr.BPIBrand)) then begin
														outstring(0,0,BPICodeToName(INr.BPIBrand),false);
													end else begin
														if (currentcompany==29) then begin
															if (nonblank(GetECItemBrand(INr.GlobalArtCode))) then begin
																outstring(0,0,GetECItemBrand(INr.GlobalArtCode),false);
															end else begin
																outstring(0,0,"",false);
															end;
														end else begin
															outstring(0,0,"",false);
														end;
													end;
													classname2 = "";
													k=0;
													ExtractObj(INr.DispGroups,k,classcode);
													DIr.Code = classcode;
													readfirstmain(DIr,1,true);
													classname2 = DIr.Name;
													if(currentcompany==9) then begin
														category = DIr.CCat;	//Edit----------------------Dima  20.03.2015
													end;	
													if(currentcompany==13)then begin										
														outstring(0,0,DIr.Name,false);
													end else begin
														outstring(0,0,BPICodeToName(INr.BPICollection),false);
													end;
													//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
												end else begin //Edit***************************Sasha2,14:11 02.06.2016 {
													if(nonblank(INr.BPIBrand)) then begin
														outstring(0,0,BPICodeToName(INr.BPIBrand),false);
													end else begin
														outstring(0,0,brand,false);
													end;	
												end; //Edit***************************Sasha2,14:11 02.06.2016 ]

												
												/*ExtractObj(INr.DispGroups,k,classcode); //Edit***************************Sasha2,14:52 11.11.2015 {
												while (NonBlank(classcode)) begin
													DIr.Code = classcode;
													if (readfirstmain(DIr,1,true)) then begin
														dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ",";
													end;
													ExtractObj(INr.DispGroups,k,classcode);
												end;*/ //Edit***************************Sasha2,14:52 11.11.2015 }
												
												if(currentcompany==9) then begin
													outstring(0,0,category,false);
													outstring(0,0,prepareStr(IVrw.Spec),false);
													outstring(0,0,INr.Reference,false);
													outstring(0,0,BPICodeToName(INr.BPIMaterial),false);
													outstring(0,0,INr.MajStoneDet,false);
													outstring(0,0,INr.SN,false);
													outstring(0,0,BPICodeToName(INr.BPISize),false);
													outstring(0,0,BPICodeToName(INr.BPIColor),false);		
												end else begin
													outstring(0,0,prepareStr(IVrw.Spec),false);
													outstring(0,0,INr.Reference,false);
													outstring(0,0,BPICodeToName(INr.BPICollection),false); 
													outstring(0,0,BPICodeToName(INr.BPIGroup),false); 
													outstring(0,0,BPICodeToName(INr.BPISubGroup),false); 
													outstring(0,0,BPICodeToName(INr.BPICategory),false); 
													outstring(0,0,BPICodeToName(INr.BPIMaterial),false);
													outstring(0,0,BPICodeToName(INr.BPIColor),false);//Edit_-_-_-_-_-_-_-_-Anton 13:26 07.05.2018	
													outstring(0,0,INr.High,false);
													outstring(0,0,INr.Life2,false);
													outstring(0,0,BPICodeToName(INr.BPISize),false);//Edit_-_-_-_-_-_-_-_-Anton 13:26 07.05.2018
													outstring(0,0,BPICodeToName(INr.BPIUse),false);
													outstring(0,0,BPICodeToName(INr.BPISex),false); 	
													outstring(0,0,BPICodeToName(INr.BPIPlating),false);		
													if (INr.BPIBrand=="BRND0046") then begin
														outstring(0,0,INr.CCCollectName,false);
													end else begin
														outstring(0,0,"",false);
													end;						
													outstring(0,0,BPICodeToName(INr.BPIClarity),false);
													outstring(0,0,BPICodeToName(INr.BPIWeight),false);	
													outstring(0,0,BPICodeToName(INr.BPICut),false); 
													outstring(0,0,BPICodeToName(INr.BPIShape),false);    
													outstring(0,0,BPICodeToName(INr.BPIStone),false); 
													outstring(0,0,BPICodeToName(INr.BPIStrap),false); 
													outstring(0,0,BPICodeToName(INr.BPIOdour),false);
													if (CurrentCompany==25) then begin
														outstring(0,0,INr.SNOne,false);
													end else begin
														outstring(0,0,"",false);
													end;
													if(CompanyIsJWLikeCompany(currentcompany))then begin
														outstring(0,0,INr.RowWeight,false);
														outstring(0,0,INr.MajStoneDet,false);
														outstring(0,0,INr.SN,false);
													end;
												end else begin
													/*for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
														pos = 0;
														ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
														if (uloc==INr.Code) then begin
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															outstring(0,0,uloc,false);
														end else begin
															outstring(0,0,"",false);
														end;
													end;*/
												end; //Edit***************************Sasha2,14:21 02.06.2016 }
												
												outstring(0,0,IVrw.SerialNr,false);
												outstring(0,0,INr.BarCode,false);
												outstring(0,0,INr.EKNCode,false);
												outstring(0,0,IVrw.Quant*cred,false);
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												if(nonblank(IVrw.Location))then begin
													rangeval = CalculateCoef(IV2r,rangecnt,IVrw.ArtCode,IVrw.Location,iteminf,arrsize);
												end else begin
													rangeval = CalculateCoef(IV2r,rangecnt,IVrw.ArtCode,IVr.Location,iteminf,arrsize);
												end;
												valscnt = rangeval;
												strscnt = rangeval;
												if (iteminf==false) then begin
													arrstrs[strscnt] = IVrw.ArtCode; strscnt = strscnt + 1;
													arrstrs[strscnt] = INr.AlternativeCode; strscnt = strscnt + 1;
													if(nonblank(IVrw.Location))then begin
														arrstrs[strscnt] = IVrw.Location; strscnt = strscnt + 1;
													end else begin
														arrstrs[strscnt] = IVr.Location; strscnt = strscnt + 1;
													end;
													
													if (addclassf==false) then begin
														classname = "";
														k=0;
														ExtractObj(INr.DispGroups,k,classcode);
														DIr.Code = classcode;
														readfirstmain(DIr,1,true);
														classname = DIr.Name;
														//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
														arrstrs[strscnt] = classname; strscnt = strscnt + 1;
														
														classname2 = "";
														ExtractObj(INr.DispGroups,k,classcode);
														DIr.Code = classcode;
														readfirstmain(DIr,1,true);
														classname2 = DIr.Name;
														//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
														arrstrs[strscnt] = classname2; strscnt = strscnt + 1;
													end else begin //Edit***************************Sasha2,14:23 02.06.2016 {
														arrstrs[strscnt] = brand; strscnt = strscnt + 1;
													end; //Edit***************************Sasha2,14:23 02.06.2016 }
													
													arrstrs[strscnt] = prepareStr(IVrw.Spec); strscnt = strscnt + 1;
													if (addclassf==false) then begin //Edit***************************Sasha2,14:21 02.06.2016 {
														arrstrs[strscnt] = INr.Reference; strscnt = strscnt + 1; 
														arrstrs[strscnt] = INr.Metal; strscnt = strscnt + 1; 
														arrstrs[strscnt] = INr.RowWeight;strscnt = strscnt + 1;
														arrstrs[strscnt] = INr.MajStoneDet; strscnt = strscnt + 1;
														//if(CompanyIsJWLikeCompany(currentcompany))then begin
															//arrstrs[strscnt] = INr.BrcStr; strscnt = strscnt + 1; 
															//arrstrs[strscnt] = INr.Gender; strscnt = strscnt + 1;
														//end;
														if(currentcompany==13)then begin	//Edit----------------------Dima  30.04.2015
															arrstrs[strscnt] = INr.Size; strscnt = strscnt + 1; 
															arrstrs[strscnt] = INr.Colour; strscnt = strscnt + 1;
														end;	  
													end else begin
														for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
															pos = 0;
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															if (uloc==INr.Code) then begin
																ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
																arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
															end else begin
																arrstrs[strscnt] = ""; strscnt = strscnt + 1;
															end;
														end;
													end; //Edit***************************Sasha2,14:21 02.06.2016 }
													//arrstrs[strscnt] = ""; strscnt = strscnt + 1;											
													arrstrs[strscnt] = INr.BarCode; strscnt = strscnt + 1;
													arrstrs[strscnt] = INr.EKNCode; strscnt = strscnt + 1;
													
													/*ExtractObj(INr.DispGroups,k,classcode); //Edit***************************Sasha2,14:52 11.11.2015 {
													while (NonBlank(classcode)) begin
														DIr.Code = classcode;
														if (readfirstmain(DIr,1,true)) then begin
															dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ",";
														end;
														ExtractObj(INr.DispGroups,k,classcode);
													end; *///Edit***************************Sasha2,14:52 11.11.2015 }
													
												end else begin
													if(addclassf)then begin
														strscnt = strscnt + 7 + typescnt;
													end else begin
														if (currentcompany==13) then begin
															strscnt = strscnt + 14;
														end else begin
															strscnt = strscnt + 12;
														end;
													end;
												end;
												arrvals[valscnt] = arrvals[valscnt] + IVrw.Quant * cred; valscnt = valscnt + 1;
											end; //Edit***************************Sasha2,11:18 20.11.2014 }
											
											total_qty = total_qty + IVrw.Quant;
											fr = IVr.FrRate;
											to1 = IVr.ToRateB1;
											if(fr==0 or to1==0)then begin
												fr = 1;
												to1 = 1;
											end;
											IVrw.Price = IVrw.Price/fr*to1;
											IVrw.Sum = IVrw.Sum/fr*to1;
											
											if(IVr.UpdStockFlag>0 and IVr.OrderNr<0)then begin
												updst = true;
											end else begin
												updst = false;
											end;
											
											
											FindFIFOOrigValAndCurncyIV(IVr.SerNr,i,brandfifo,brandcur,fifob1,updst,addCurs,currencyBalances,additionalCurF,tmpbool); //Edit***************************Sasha2,16:02 13.09.2017
											if(fifob1==0)then begin
											  if(IVrw.FIFORowVal==0)then begin
											    fifob1 = IVrw.FIFORowVal;
											  end else begin
                          fifob1 = INr.WeighedAvPrice * IVrw.Quant;
												end;
											end;
											if(brandfifo==0)then begin
												brandfifo = INr.LastPurchPrice2 * IVrw.Quant;
											end;
											
											
											brandfifo = AbsoluteVal(brandfifo/IVrw.Quant);
											fifob1 = AbsoluteVal(fifob1/IVrw.Quant);
											for (j=0;j<addCurs.length;j=j+1) begin //Edit***************************Sasha2,11:46 14.09.2017 {
												currencyBalances[addCurs[j]] = AbsoluteVal(currencyBalances[addCurs[j]]/IVrw.Quant);
											end; //Edit***************************Sasha2,11:46 14.09.2017 }
											
											
											if (left(CurrentUser,2)=="SA") then begin
												azn = "EUR";
												GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
												outstring(100,0,aznto,false);
												azn = "AZN";
												if(currentcompany==10)THEN BEGIN
													azn = "PLN";
												end;
												if(currentcompany==11 or currentcompany==12)THEN BEGIN
													azn = "IRR";
												end;
											end;
											
											
											GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
											if(aznfr==0 or aznto==0)then begin
												aznfr = 1; aznto = 1;
											end;
											fifoazn = fifob1*aznfr/aznto;
											if (modef) then begin
												outstring(100,0,brandfifo,false);//brandcur
												if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
													outstring(100,0,currencyBalances[CurncyCoder.CurncyCode],false);
												end;
												if(bcur==azn)then begin
													outstring(101,0,fifoazn,false);//AZN
												end;
												if(bcur!=azn)then begin
													outstring(102,0,fifob1,false);//basecur
												end;
												outstring(110,0,brandfifo*IVrw.Quant*cred,false);//brandcur
												if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
													outstring(110,0,currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant*cred,false);
												end;
												if(bcur==azn)then begin
													outstring(111,0,fifoazn*IVrw.Quant*cred,false);//AZN
												end;
												if(bcur!=azn)then begin
													outstring(112,0,fifob1*IVrw.Quant*cred,false);//basecur
												end;
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												arrvals[valscnt] = arrvals[valscnt] + brandfifo; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + currencyBalances[CurncyCoder.CurncyCode]; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + fifoazn; valscnt = valscnt + 1;
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + fifob1; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + brandfifo*IVrw.Quant*cred; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant*cred; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + fifoazn*IVrw.Quant*cred; valscnt = valscnt + 1;
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + fifob1*IVrw.Quant*cred; valscnt = valscnt + 1;
												end;
											end; //Edit***************************Sasha2,11:18 20.11.2014 }
											
											GetFullCurncyRate(brandcur,IVr.TransDate,fr,to1,to2,br1,br2);
											if(fr==0 or to1==0)then begin
												fr = 1; to1 = 1;
											end;
											/*if(fr==0 or to1==0)then begin
												fr = 1; to1 = 1;
											end;*/
											bfr = IVr.FrRate;
											bto = IVr.ToRateB1;
											if(bfr==0 or bto==0)then begin
												bfr = 1;
												bto = 1;
											end;
											
											total_cost = total_cost + fifoazn*IVrw.Quant*cred;
											btotal_cost = btotal_cost + fifob1*IVrw.Quant*cred;
											
											if(brandcur==IVr.CurncyCode)then begin
												curprice = IV2rw.Price*cred;
											end else begin
												curprice = round(IVrw.Price*fr/to1,SetRoundModeD(1))*cred;
											end;
											
											if (additionalCurF) then begin  //Edit***************************Sasha2,11:27 14.09.2017 {
												if (IVr.CurncyCode==CurncyCoder.CurncyCode) then begin
													EURprice = IV2rw.Price*cred;
												end else begin
													EURprice = BlankVal;
													CurValToOtherCur(IVr.InvDate,azn,IVrw.Price,CurncyCoder.CurncyCode,EURprice,SetRoundModeD(1)); //Edit***************************Sasha2,11:13 14.09.2017
													EURprice = EURprice*cred;
												end;
											end; //Edit***************************Sasha2,11:27 14.09.2017 }
											
											if (modef) then begin
												outstring(120,0,curprice,false);//brandcur
												if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
													outstring(120,0,EURprice,false);
												end;
												if(bcur==azn)then begin
													outstring(121,0,IVrw.Price*aznfr/aznto,false);//AZN
												end;
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												arrvals[valscnt] = arrvals[valscnt] + curprice; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + EURprice; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + IVrw.Price*aznfr/aznto; valscnt = valscnt + 1;
											end; //Edit***************************Sasha2,11:18 20.11.2014 }
											
											total_rebate = total_rebate + IVrw.Price*aznfr/aznto*IVrw.Quant;// Edit ************************** Wednesday, 22 October 2014 16:43:55
											
											if (modef) then begin
												if(bcur!=azn)then begin
													outstring(122,0,IVrw.Price,false);//basecur
												end;
											end else  begin //Edit***************************Sasha2,11:17 20.11.2014 {
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + IV2rw.Price; valscnt = valscnt + 1;
												end;
											end; //Edit***************************Sasha2,11:18 20.11.2014 }
											
											if(brandcur==IVr.CurncyCode)then begin
												curcusm = IV2rw.Sum*cred;
											end else begin
												curcusm = round(IVrw.Sum*fr/to1,SetRoundModeD(1))*cred;
											end;
											if (additionalCurF) then begin  //Edit***************************Sasha2,11:27 14.09.2017 {
												if (IVr.CurncyCode==CurncyCoder.CurncyCode) then begin
													EURcusm = IVrw.Sum*cred*fr/to1;
												end else begin
													EURcusm = BlankVal;
													CurValToOtherCur(IVr.InvDate,azn,IVrw.Sum,CurncyCoder.CurncyCode,EURcusm,SetRoundModeD(1)); //Edit***************************Sasha2,11:13 14.09.2017
													EURcusm = EURcusm*cred;
												end;
											end; //Edit***************************Sasha2,11:27 14.09.2017 }
											
											if (modef) then begin
												outstring(130,0,curcusm,false);//brandcur
												if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
													outstring(130,0,EURcusm,false);
												end;
												if(bcur==azn)then begin
													outstring(131,0,IVrw.Sum*aznfr/aznto*cred,false);//AZN
												end;
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												arrvals[valscnt] = arrvals[valscnt] + curcusm; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + EURcusm; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + IVrw.Sum*aznfr/aznto*cred; valscnt = valscnt + 1;
											end; //Edit***************************Sasha2,11:17 20.11.2014 }
											
											total_rebate_qty = total_rebate_qty + IVrw.Sum*aznfr/aznto*cred;// Edit ************************** Wednesday, 22 October 2014 16:44:51
											if (modef) then begin
												if(bcur!=azn)then begin
													outstring(132,0,IVrw.Sum*cred,false);//basecur
												end;
											end else  begin //Edit***************************Sasha2,11:17 20.11.2014 {
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + IVrw.Sum*cred; valscnt = valscnt + 1;
												end;
											end; //Edit***************************Sasha2,11:17 20.11.2014 {
											
											total_price = total_price + IVrw.Sum*aznfr/aznto*cred;
											btotal_price = btotal_price + IVrw.Sum*cred;
											
											if (modef) then begin
												outstring(140,0,(curcusm - brandfifo*IVrw.Quant)*cred,false);//brandcur
												if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
													outstring(140,0,(EURcusm -  currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant)*cred,false);
												end;
												if(bcur==azn)then begin
													outstring(141,0,IVrw.Sum*aznfr/aznto*cred - fifob1*IVrw.Quant*aznfr/aznto*cred,false);//AZN
												end;
												if(bcur!=azn)then begin
													outstring(142,0,(IVrw.Sum - fifob1*IVrw.Quant)*cred,false);//basecur
												end;
												outstring(0,0,brandcur,false);
												if(usercanaction("ViewCustomerInfo",true))then begin
													outstring(0,0,IVr.CustCode,false);
													outstring(0,0,IVr.Addr0,false);
													if (left(currentuser,2)=="SA") then begin
														if (FoundObjEx(IVrw)) then begin
															outstring(0,0,"FOUNDER",false);
														end else begin
															if (left(IVr.CustCode,4)=="FOB_") then begin
																outstring(0,0,"FOB",false);
															end else begin
																if (IVr.CustCode=="FOBE_COMMERCE") then begin
																	outstring(0,0,"E_COMMERCE",false);
																end else begin
																	outstring(0,0,"CLIENT",false);
																end;
															end;
														end;
													end;
													if(RepSpec.flags[2]==1)then begin
														outstring(0,0,CUr.Phone & " " & CUr.Mobile & " " & CUr.AltPhone,false);
														outstring(0,0,vVisitName[IVr.SerNr],false);
														outstring(0,0,vVisitPhone[IVr.SerNr],false);
														if(IVr.LCMLevel=="CASACOIN") then begin
															outstring(0,0,IVr.LoyaltyCardNr,false);
														end else begin	
															outstring(0,0,"",false);
														end;	
														Switch(CUr.Gender)begin
															case 0: outstring(100,0,"Мужской",false);
															case 1: outstring(100,0,"Женский",false);
															case 2: outstring(100,0,"Компания",false);
															otherwise
																outstring(100,0,"",false);
														end;
														if(nonblankdate(CUr.BirthDate))then begin
															outstring(150,0,getYear(currentdate)-getyear(CUr.BirthDate),false);
														end else begin
															outstring(150,0," ",false);
														end;
													end;
												end;
											
												
												outstring(0,0,IVrw.vRebate,false);
												//total_rebate = total_rebate + IVrw.vRebate*AbsoluteVal(IVrw.Quant);//Edit***********************Vitalii 14:28 26.08.2014
												/*if(IVrw.vRebate!=0)then begin
													total_rebate_qty = total_rebate_qty + AbsoluteVal(IVrw.Quant);											
												end;*/
												outstring(0,0,IVr.SalesMan,false);
												outstring(0,0,IVr.SerNr,false);
												outstring(0,0,IVr.TransDate,false);
												outstring(0,0,IVr.PayDeal,false);
												pos = 0;	
												OBJStr = IVrw.Objects;
												Obj = "";
												APriceObj = "";
												ExtractObjWithSeparator(",",OBJStr,true,pos,Obj);
												while (nonblank(Obj)) begin
													Objr.Code = Obj;
													if(ReadFirstMain(Objr,1,true)) then begin
														if(Objr.OTCode=="PROMO")then begin
															APriceObj = Obj;
														end;	
														if(Objr.OTCode=="APRIC")then begin // Edit ************************** Ihor Trubachov 17*05*2021
															if(nonblank(IVrw.Objects))then begin
																APriceObj = APriceObj & ",";
															end;
															APriceObj = APriceObj & Obj;
														end;	
														if(Objr.OTCode=="AREB")then begin
															if(nonblank(IVrw.Objects))then begin
																APriceObj = APriceObj & ",";
															end;
															APriceObj = APriceObj & Obj;
														end;	
													end;
													ExtractObjWithSeparator(",",OBJStr,true,pos,Obj);
												end;
												outstring(0,0,IVr.InvComment,false);
												outstring(0,0,APriceObj,false);
												outstring(0,0,GetIVRebCode(IVr.AddRebCode,IVrw.Objects),false);
										
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												arrvals[valscnt] = arrvals[valscnt] + (curcusm - brandfifo*IVrw.Quant)*cred; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + (EURcusm -  currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant)*cred; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + (IVrw.Sum*aznfr/aznto - fifob1*IVrw.Quant*aznfr/aznto)*cred; valscnt = valscnt + 1;
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + (IVrw.Sum - fifob1*IVrw.Quant)*cred; valscnt = valscnt + 1;
												end;
												arrstrs[strscnt] = brandcur; strscnt = strscnt + 1;
												if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
													for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
														pos = 0;
														ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
														if (uloc==INr.Code) then begin
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
														end else begin
															arrstrs[strscnt] = ""; strscnt = strscnt + 1;
														end;
													end;
												end; //Edit***************************Sasha2,14:37 08.02.2016 }
												/*for (m=0;m<ctypecnt;m=m+1) begin 
													arrstrs[strscnt] = dispnames[typeindex[m]]; strscnt = strscnt + 1;
												end; 
												MyClearVector(dispnames,typeindex,ctypecnt);*/
											end; //Edit***************************Sasha2,11:17 20.11.2014 }
											
											if (modef) then begin //Edit***************************Sasha2,11:17 20.11.2014	
												if(currentcompany==9)then begin
													if(IVr.OrderNr>-1)then begin
														ORr.SerNr = IVr.OrderNr;
														readfirstmain(ORr,1,true);
														if(nonblank(ORr.OrderClass))then begin
															outstring(0,0,ORr.OrderClass,false);
														end;
													end;
												end;
												outstring(0,0,tstr,false);
												if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
													for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
														pos = 0;
														ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
														if (uloc==INr.Code) then begin
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															outstring(0,0,uloc,false);
														end else begin
															outstring(0,0,"",false);
														end;
													end;
												end; //Edit***************************Sasha2,14:37 08.02.2016 }
												/*for (m=0;m<ctypecnt;m=m+1) begin //Edit***************************Sasha2,15:28 11.11.2015 {
													outstring(0,0,Left(dispnames[typeindex[m]],len(dispnames[typeindex[m]])-1),false);
												end; 
												MyClearVector(dispnames,typeindex,ctypecnt);*/ //Edit***************************Sasha2,15:28 11.11.2015 }
                        outstring(0,0,IVr.TaxTransactionCode,false);
											end;
										if(currentcompany==25 and RepSpec.flags[2]!=0) then begin
											if(cashbackPercent!=0) then begin
												outstring(0,0,cashbackPercent,false);
											end else begin
												outstring(0,0,"",false);
											end;
										end;	
										if (modef) then begin	//Edit***************************Sasha2,11:12 20.11.2014								
											endformat;
										end;
									end;
								end;
							end;
						end; 
					end;
				end;
				if (modef==false) then begin
					mtrw = matrowcnt(IV2r);
					for (i=0;i<mtrw;i=i+1) begin
						matrowget(IV2r,i,IVrw);
						valscnt = IVrw.Quant;
						strscnt = IVrw.Quant;
						itemoccurrences = IVrw.Sum*cred;
						startformat(15);
							outstring(1,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //IVrw.ArtCode
							outstring(2,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.AlternativeCode
							outstring(3,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //IVr.Location
							// outstring(4,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname
							// if (addclassf==false) then begin //Edit***************************Sasha2,17:43 02.06.2016 {
							  // outstring(5,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname2
							// end; //Edit***************************Sasha2,17:43 02.06.2016 }
							// outstring(6,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //prepareStr(IVrw.Spec)
							// if (addclassf==false) then begin
  							// outstring(7,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Reference
  							// outstring(8,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Metal
  							// outstring(9,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.RowWeight
  							// outstring(10,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.MajStoneDet
  							// //if(CompanyIsJWLikeCompany(currentcompany))then begin
  								// //outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.BrcStr
  								// //outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Gender
  							// //end;
  							// if(currentcompany==13)then begin			//Edit----------------------Dima  30.04.2015
  								// outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Size
  								// outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Colour
  							// end;	
							// end else begin  //Edit***************************Sasha2,17:43 02.06.2016 {
							  for (j=0;j<41;j=j+1) begin //if you change "30" do it in other places having "For" loop 
          		    /*outstring(12,0,arrstrs[strscnt],false);*/ strscnt = strscnt + 1;
          		  end;
							// end;	//Edit***************************Sasha2,17:43 02.06.2016 }
							outstring(13,0,"",false); //IVrw.SerialNr
							outstring(13,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.BarCode
							outstring(14,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.EKNCode
							outstring(15,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Quant
							outstring(16,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //brandfifo
							if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
							  outstring(16,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1;
							end;
							if(bcur==azn)then begin
								outstring(17,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //fifoazn
							end;
							if(bcur!=azn)then begin
								outstring(18,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //fifob1
							end;
							outstring(19,0,arrvals[valscnt],false); valscnt = valscnt + 1; //brandfifo*IVrw.Quant
							if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(19,0,arrvals[valscnt],false); valscnt = valscnt + 1;
    					end;
							if(bcur==azn)then begin
								outstring(20,0,arrvals[valscnt],false); valscnt = valscnt + 1; //fifoazn*IVrw.Quant
							end;
							if(bcur!=azn)then begin
								outstring(21,0,arrvals[valscnt],false); valscnt = valscnt + 1; //fifob1*IVrw.Quant
							end;
							outstring(22,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //curprice
							if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(22,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1;
    					end;
							if(bcur==azn)then begin
								outstring(23,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //IVrw.Price*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(24,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //IVrw.Price
							end;
							outstring(25,0,arrvals[valscnt],false); valscnt = valscnt + 1; //curcusm
							if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(25,0,arrvals[valscnt],false); valscnt = valscnt + 1; 
    					end;
							if(bcur==azn)then begin
							outstring(26,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(27,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum
							end;
							outstring(28,0,arrvals[valscnt],false); valscnt = valscnt + 1; //curcusm - brandfifo*IVrw.Quant
							if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(28,0,arrvals[valscnt],false); valscnt = valscnt + 1;
    					end;
							if(bcur==azn)then begin
								outstring(29,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum*aznfr/aznto - fifob1*IVrw.Quant*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(30,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum - fifob1*IVrw.Quant
							end;
							outstring(31,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //brandcur
							if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
          		  for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
          		    outstring(32,0,arrstrs[strscnt],false); strscnt = strscnt + 1;
          		  end;
          		end; //Edit***************************Sasha2,14:37 08.02.2016 }
							/*for (m=0;m<ctypecnt;m=m+1) begin //Edit***************************Sasha2,16:15 11.11.2015 {
							  outstring(32,0,Left(arrstrs[strscnt],len(arrstrs[strscnt])-1),false); strscnt = strscnt + 1; //disp types
							end;*/ //Edit***************************Sasha2,16:15 11.11.2015 }
						endformat;
					end;
				end;
								
				startformat(15);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					if (modef) then begin
						if (addclassf==false) then begin
							outstring(0,0,"",false);
						end;
						if (currentcompany==9) then begin
							outstring(0,0,"",false);
						end;
						outstring(0,0,"",false);
						if (addclassf==false) then begin
							outstring(0,0,"",false);
							outstring(0,0,"",false);
							outstring(0,0,"",false);
							outstring(0,0,"",false);
							if (currentcompany==13) then begin
								outstring(0,0,"",false);
								outstring(0,0,"",false);
							end;
						end else begin
							for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
								outstring(0,0,"",false);
							end;
						end;				
						outstring(0,0,"",false);
					end;
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31074),false);
					outstring(0,0,total_qty,false);
					outstring(0,0,"",false);
					if(bcur!=azn)then begin
						outstring(0,0,"",false);
					end;
					if(bcur==azn)then begin
						outstring(0,0,"",false);
					end;
					if (additionalCurF) then begin //additional currency cost, additional currency cost sum //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					  outstring(0,0,"",false);
					end;
					outstring(0,0,USetStr(31075),false);
					if(bcur==azn)then begin
						outstring(0,0,total_cost,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_cost,false);
					end;
					outstring(0,0,"",false);
					if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					end;
					if(bcur==azn)then begin
					  outstring(0,0,"",false);
					end;
					if (additionalCurF) then begin //additional currency retail sum  //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					end;
					outstring(0,0,USetStr(31076),false);
					if(bcur==azn)then begin
						outstring(0,0,total_price,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_price,false);
					end;
					if (additionalCurF) then begin //additional currency retail difference//Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					end;
					outstring(0,0,USetStr(31077),false);
					if(bcur==azn)then begin
						outstring(0,0,total_price - total_cost,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_price - btotal_cost,false);
					end;
					//Edit***********************Vitalii 14:28 26.08.2014
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31078),false);
					//outstring(0,0,total_rebate/total_rebate_qty,false);
					outstring(0,0,100-(100*(total_rebate_qty/total_rebate)),false);// Edit ************************** Wednesday, 22 October 2014 16:45:31
	
				endformat;
			end else begin
				startformat(15);
					outstring(100,0,USetStr(31079),false);
				endformat;
			end;
		end;
	EndJob;
return;
end;





global
procedure SalesReportExtInFile(var record RcVc RepSpec)
begin
  Date sd,ed;
  Boolean TrHs,testf;
  record IVVc IVr,IV2r;
  row IVVc IVrw,IV2rw;
  integer i,keyi,mtrw,k,j;
  string 20 keystr;
  record INVc INr,dupINr;
  string 100 classname,classname2,classcode; //Edit***************************Sasha2,11:14 20.11.2014
  record DIVc DIr;
  val brandfifo;
  string 5 brandcur;
  val fr,to1,to2,br1,br2;
  val curcusm,curprice,fifob1;
  boolean testf1,userlocation;
  string 255 location,tstr,OBJStr,Obj,APriceObj;
  record UserVc User;
  integer pos,headrow;
  string 50 uloc,uloc1;
  boolean updst,modef;
	val total_rebate,total_rebate_qty;//Edit***********************Vitalii 14:28 26.08.2014
  val total_qty;
  val total_cost,total_price,total_gp;
  string 200 classfind,model,brand,category, conslocation, deflocation;
  record ORVc ORr;
  record BaseCurBlock BCb;
  string 5 bcur,azn;
  val bfr,bto;
  val aznfr,aznto,fifoazn;
  val btotal_cost,btotal_price,btotal_gp;
  array val arrvals; //Edit***************************Sasha2,10:46 20.11.2014
  array string 20 arrstrs; //Edit***************************Sasha2,10:46 20.11.2014
  integer valscnt,strscnt,rangeval,rangecnt,arrsize; //Edit***************************Sasha2,12:11 20.11.2014
  val itemoccurrences; //Edit***************************Sasha2,12:11 20.11.2014
  boolean iteminf,addclassf,tmpbool;
  integer cred;
  Record CTypeVc CTyper; //Edit***************************Sasha2,12:23 11.11.2015
  integer ctypecnt,m; //Edit***************************Sasha2,12:24 11.11.2015
  array string 10 typeindex; //Edit***************************Sasha2,14:08 11.11.2015
  vector string 255 dispnames; //Edit***************************Sasha2,14:08 11.11.2015
  vector string 20 typeval; //Edit***************************Sasha2,14:11 08.02.2016
  array string 20 typecode; //Edit***************************Sasha2,14:11 08.02.2016
  vector string 200 typename; //Edit***************************Sasha2,14:11 08.02.2016
  record DiCheckBlock DiCb; //Edit***************************Sasha2,14:10 08.02.2016
  row DiCheckBlock DiCbw; //Edit***************************Sasha2,14:10 08.02.2016
  integer rwcnt,typescnt,pos1; //Edit***************************Sasha2,14:11 08.02.2016
  Boolean collf,metalf; //Edit***************************Sasha2,14:09 02.06.2016
  string 20 collstr,metalstr; //Edit***************************Sasha2,14:09 02.06.2016
  vector val currencyBalances; //Edit***************************Sasha2,15:49 13.09.2017
	array string 10 addCurs; //Edit***************************Sasha2,15:50 13.09.2017
	Boolean additionalCurF, testf2; //Edit***************************Sasha2,10:33 14.09.2017
	val EURprice,EURcusm; //Edit***************************Sasha2,11:26 14.09.2017
	record CurncyCodeVc CurncyCoder; //Edit***************************Sasha2,13:55 14.09.2017
	record OldDIVc OldDIr;
  record ObjVc Objr;
	vector boolean userbrand;
  boolean userbrandf;
  record MarketingVc MCr;
  vector string 200 vVisitName,vVisitPhone;
  record CUVc CUr;
	record LCCashbackLevelVc LCCBLevelr;
  row LCCashbackLevelVc LCCBLevelrw;
  record LoyaltyCardVc LoyaltyCardr;
  roundmode rnd;
  Boolean found;
  Integer rowcnt;
  val loyCardPointsBalance,cashbackPercent;
	record ItemDuplicatesVc IDr;
  vector string 255 DubCodes;
	record LocationVc Locr;
	area BodyAr;
	string 255 FileName;


	FileName = "SalesReportExt/SalesReportExtInFile_" & DateToString(RepSpec.sStartDate,"DD.MM.YYYY") & "_" & DateToString(RepSpec.sEndDate,"DD.MM.YYYY") & "_" & CurrentCompany & ".txt";
	

	if (!FileExists(FileName)) then begin
		userbrandf = CheckUserBrands(currentuser,userbrand);
		
		blockload(BCb);
		bcur = BCb.BaseCur1;
		azn = "AZN";
		if(currentcompany==10)THEN BEGIN
			azn = "PLN";
		end;
		if(currentcompany==11 or currentcompany==12)THEN BEGIN
			azn = "IRR";
		end;
		headrow = 2;
		//SetLangMode(LangRussian,"RUS",0);
			
			sd = RepSpec.sStartDate;
			ed = RepSpec.sEndDate;
			location = RepSpec.f1;
			Locr.Code = location;
			if (ReadFirstMain(Locr,1,true)) then begin
				if (nonblank(Locr.ConsigStockCode)) then begin
					conslocation = Locr.ConsigStockCode;
				end;
				if (nonblank(Locr.DefectStockCode)) then begin
					deflocation = Locr.DefectStockCode;
				end;
			end;
			
			Header(headrow,USetStr(13835) & sd & ":" & ed,0);
			headrow = headrow + 1;
			
			if (NonBlank(location)) then begin
				Header(headrow,USetStr(31097) & ": " & location,0);
			end else begin
				Header(headrow,USetStr(31097) & ": " & USetStr(12727),0);
			end;
			headrow = headrow + 1;
			
			if (NonBlank(RepSpec.f2)) then begin
				Header(headrow,USetStr(11605) & RepSpec.f2,0);
			end else begin
				Header(headrow,USetStr(11605) & USetStr(12727),0);
			end;
			headrow = headrow + 1;
			
			if (NonBlank(RepSpec.f4)) then begin
				Header(headrow,USetStr(31044) & ": " & RepSpec.f4,0);
			end else begin
				Header(headrow,USetStr(31044) & ": " & USetStr(12727),0);
			end;
			headrow = headrow + 1;
			
			if (NonBlank(RepSpec.f5)) then begin
				Header(headrow,USetStr(8833) & ": " & RepSpec.f5,0);
			end else begin
				Header(headrow,USetStr(8833) & ": " & USetStr(12727),0);
			end;
			headrow = headrow + 1;
			
			EndHeader; //Edit***************************Sasha2,16:57 19.11.2014 }
			
			if (NonBlank(RepSpec.f7)) then begin //Edit***************************Sasha2,16:02 13.09.2017 {
				CurncyCoder.CurncyCode = RepSpec.f7;
				if (ReadFirstMain(CurncyCoder,1,true)) then begin
					addCurs[addCurs.length] = CurncyCoder.CurncyCode; 
					additionalCurF = true;
				end;
			end;//Edit***************************Sasha2,16:02 13.09.2017 }
			
			if (CompanyIsJWLikeCompany(CurrentCompany)) then begin //Edit***************************Sasha2,11:27 02.06.2016 {
				addclassf = true;
			end else begin
				addclassf = false;
			end; 

			if (addclassf) then begin
				typescnt = 0;
				BlockLoad(DiCb);
				rwcnt = MatRowCnt(DiCb);  
				for (j=0;j<rwcnt;j=j+1) begin
					MatRowGet(DiCb,j,DiCbw);
					if (NonBlank(DiCbw.DiType)) then begin
						DIr.Code = DiCbw.DiCode;
						ReadFirstMain(DIr,1,true);
						DiCbw.DiType = DIr.CType & "," & DiCbw.DiType;
						pos = 0;
						ExtractObj(DiCbw.DiType,pos,uloc);
						while (nonblank(uloc)) begin
							if (blank(typeval[uloc])) then begin
								CTyper.Code = uloc;
								if (ReadFirstMain(CTyper,1,true)) then begin
									if (CTyper.Code=="GENDER") then begin
										switch (UpperCase(Left(DiCbw.DiCode,1))) begin
											case "A":
												if (blank(typeval[CTyper.Code & "_A"])) then begin
													typeval[CTyper.Code & "_A"] = ".";
													typecode[typescnt] = CTyper.Code & "_A";
													typename[typecode[typescnt]] = "ACCESSORIES " & CTyper.Comment;
													typescnt = typescnt + 1;  
												end;
											case "J":
												if (blank(typeval[CTyper.Code & "_J"])) then begin
													typeval[CTyper.Code & "_J"] = ".";
													typecode[typescnt] = CTyper.Code & "_J";
													typename[typecode[typescnt]] = "JEWELRY " & CTyper.Comment;
													typescnt = typescnt + 1;  
												end;
											case "W":
												if (blank(typeval[CTyper.Code & "_W"])) then begin
													typeval[CTyper.Code & "_W"] = ".";
													typecode[typescnt] = CTyper.Code & "_W";
													typename[typecode[typescnt]] = "WATCH " & CTyper.Comment;
													typescnt = typescnt + 1;
												end;
										end;
									end else begin
										typeval[CTyper.Code] = ".";
										typecode[typescnt] = CTyper.Code;
										typename[CTyper.Code] = CTyper.Comment;
										typescnt = typescnt + 1;  
									end;
								end;
							end;
							ExtractObj(DiCbw.DiType,pos,uloc);
						end;
					end;
				end;
				SortAndClearClassifications(typecode,typename,typescnt);
			end;//Edit***************************Sasha2,11:27 02.06.2016 }

			if (RepSpec.ArtMode==0) then begin
				modef = true;
			end else begin
				modef = false;
				RECORDNEW(IV2r);
			end;
		
			userlocation = false;
			User.Code = currentuser;
			if(readfirstmain(User,1,true))then begin
				if(nonblank(User.UserLocations) and usercanaction("AllowReportWithUserLoc",false))then begin
					userlocation = true;
					pos = 0;
					ExtractObj(User.UserLocations,pos,uloc);
					while (nonblank(uloc)) begin
						if(uloc==location)then begin
							userlocation = false;
						end;
						ExtractObj(User.UserLocations,pos,uloc);
					end;
				end;
			end;
		
			if(userlocation)then begin
				// startformat(15);
					// outstring(50,0,USetStr(31014),false);
				// endformat;
				
				
				AddTextToArea	(USetStr(31014) & chr(09) 																							
										&	chr(13),BodyAr);
				
				
			end else begin
				if(nonblank(RepSpec.sStartDate) and nonblank(RepSpec.sEndDate))then begin

					
					AddTextToArea	(USetStr(31102) & chr(09) 																						
										& RepSpec.sStartDate & chr(09) 																						
										&	chr(13),BodyAr);

					
					AddTextToArea	(USetStr(31103) & chr(09),BodyAr);	
					if(nonblank(RepSpec.f1))then begin
						AddTextToArea	(RepSpec.f1 & chr(09),BodyAr);	
					end else begin
						AddTextToArea	(USetStr(31104) & chr(09),BodyAr);	
					end;
					AddTextToArea	(chr(13),BodyAr);					
					

					AddTextToArea	(USetStr(31105) & chr(09) 																						
										& RepSpec.f2 & chr(09) 																						
										&	chr(13),BodyAr);
					

					AddTextToArea	(USetStr(31205) & chr(09) 																						
										& RepSpec.f4 & chr(09) 																						
										&	chr(13),BodyAr);
					

					AddTextToArea	(USetStr(31206) & chr(09) 																						
										& RepSpec.f5 & chr(09) 																						
										&	chr(13),BodyAr);

					
					startformat(15);
						AddTextToArea	(USetStr(31042) & chr(09),BodyAr);	
						AddTextToArea	(USetStr(31043) & chr(09),BodyAr);	
						if (RepSpec.ArtMode==0) then begin
							AddTextToArea	(USetStr(36287) & chr(09),BodyAr);	
							AddTextToArea	("Коды дубликатов" & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(12815) & chr(09),BodyAr);	
						if (modef) then begin
							AddTextToArea	(USetStr(31044) & chr(09),BodyAr);	
							if (addclassf==false) then begin //Edit***************************Sasha2,13:15 02.06.2016
								AddTextToArea	(USetStr(19357) & chr(09),BodyAr);	
							end;
							if(currentcompany==9)then begin
								AddTextToArea	(USetStr(9131) & chr(09),BodyAr);	
							end;
							AddTextToArea	(USetStr(12713) & chr(09),BodyAr);	
							if (addclassf==false And CurrentCompany==9) then begin //Edit***************************Sasha2,13:17 02.06.2016 {
								AddTextToArea	(USetStr(31045) & chr(09),BodyAr);	
								AddTextToArea	(USetStr(31047) & chr(09),BodyAr);	
								AddTextToArea	(USetStr(14533) & chr(09),BodyAr);	
								AddTextToArea	(USetStr(31048) & chr(09),BodyAr);	
								//if(CompanyIsJWLikeCompany(currentcompany))then begin
									//outstring(0,0,USetStr(31049),false); //Braslet/Remeshok
									//outstring(0,0,USetStr(31050),false); //Tsvet tsyferblata
								//end;
								if(currentcompany==13)then begin		//Edit-----------------------------Dima  30.04.2015
									AddTextToArea	(USetStr(31320) & chr(09),BodyAr);	
									AddTextToArea	(USetStr(35007) & chr(09),BodyAr);	
								end else begin		
								AddTextToArea	(USetStr(31320) & chr(09),BodyAr);	
								AddTextToArea	(USetStr(31321) & chr(09),BodyAr);	
							end;
							end else begin //Edit***************************Sasha2,13:17 02.06.2016 }
							 // for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
								 // outstring(0,0,typename[typecode[j]],false);
								//end;
							end;
						end;
						// if(CurrentCompany!=9) then begin
							// outstring(0,0,"Reference",false);
							// outstring(0,0,"Group",false); 
							// outstring(0,0,"SubGroup",false);
							// outstring(0,0,"Category",false);
							// if(currentcompany==25)then begin
								// outstring(0,0,"CC Collection",false); 
								// outstring(0,0,"Product Group",false); 							
							// end;
							// outstring(0,0,"Material",false); 		
							// if(currentcompany==13)then begin
								// outstring(0,0,"Size",false);
								// outstring(0,0,"Colour",false); 
							// end else begin
								// outstring(0,0,"Colour",false); 
								// outstring(0,0,"Size",false); 
							// end;						
							// if(CompanyIsJWLikeCompany(currentcompany))then begin
								// outstring(0,0,"Кар.",false); 
								// outstring(0,0,"JW Weight",false);
								// outstring(0,0,"SAP",false);
							// end;					
							// outstring(0,0,"Use",false);
							// outstring(0,0,"Sex",false);
							// outstring(0,0,"Plating",false);						
							// outstring(0,0,"Collection",false); 
							// outstring(0,0,"Clarity",false);
							// outstring(0,0,"Weight",false); 
							// outstring(0,0,"Cut",false); 
							// outstring(0,0,"Shape",false);
							// outstring(0,0,"Stone",false); 
							// outstring(0,0,"Strap",false);
							// outstring(0,0,"Odour",false);
							// outstring(0,0,"Year",false); 
							// outstring(0,0,"High",false); 
						// end;
						
						
						
						if(CurrentCompany!=9 and modef) then begin   // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 13:49 06.11.2020
							AddTextToArea	("Reference" & chr(09),BodyAr);	
							AddTextToArea	("Collection" & chr(09),BodyAr);	
							AddTextToArea	("Group" & chr(09),BodyAr);	
							AddTextToArea	("SubGroup" & chr(09),BodyAr);	
							AddTextToArea	("Category" & chr(09),BodyAr);	
							AddTextToArea	("Material" & chr(09),BodyAr);	
							AddTextToArea	("Colour" & chr(09),BodyAr);	
							AddTextToArea	("Year" & chr(09),BodyAr);	
							AddTextToArea	("Life" & chr(09),BodyAr);	
							AddTextToArea	("Size" & chr(09),BodyAr);	
							AddTextToArea	("Use" & chr(09),BodyAr);	
							AddTextToArea	("Sex" & chr(09),BodyAr);	
							AddTextToArea	("Plating" & chr(09),BodyAr);	
							AddTextToArea	("CC Collection" & chr(09),BodyAr);	
							AddTextToArea	("Clarity" & chr(09),BodyAr);	
							AddTextToArea	("Weight" & chr(09),BodyAr);	
							AddTextToArea	("Cut" & chr(09),BodyAr);	
							AddTextToArea	("Shape" & chr(09),BodyAr);	
							AddTextToArea	("Stone" & chr(09),BodyAr);	
							AddTextToArea	("Strap" & chr(09),BodyAr);	
							AddTextToArea	("Odour" & chr(09),BodyAr);	
							AddTextToArea	("Product Group" & chr(09),BodyAr);	
							if(CompanyIsJWLikeCompany(currentcompany))then begin
								AddTextToArea	("Кар." & chr(09),BodyAr);	
								AddTextToArea	("JW Weight" & chr(09),BodyAr);	
								AddTextToArea	("SAP" & chr(09),BodyAr);	
							end;		
						end;
						
						
						
						
						
						
						
						
						AddTextToArea	(USetStr(31051) & chr(09),BodyAr);	
						AddTextToArea	("EAN code" & chr(09),BodyAr);	
						AddTextToArea	(USetStr(13199) & chr(09),BodyAr);	
						AddTextToArea	(USetStr(31052) & chr(09),BodyAr);	
						AddTextToArea	("EUR cur.rate" & chr(09),BodyAr);	
						AddTextToArea	(USetStr(31053) & chr(09),BodyAr);	
						if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	(USetStr(31055) & chr(09),BodyAr);	
						end;
						if(bcur==azn)then begin
							AddTextToArea	(USetStr(31055) & chr(09),BodyAr);	
						end;
						if(bcur!=azn)then begin
							AddTextToArea	(USetStr(31055) & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(31056) & chr(09),BodyAr);	
						if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	(USetStr(31058) & chr(09),BodyAr);	
						end;
						if(bcur==azn)then begin
							AddTextToArea	(USetStr(31058) & chr(09),BodyAr);	
						end;
						if(bcur!=azn)then begin
							AddTextToArea	(USetStr(31058) & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(31059) & chr(09),BodyAr);	
						if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	(USetStr(31061) & chr(09),BodyAr);	
						end;
						if(bcur==azn)then begin
							AddTextToArea	(USetStr(31061) & chr(09),BodyAr);	
						end;
						if(bcur!=azn)then begin
							AddTextToArea	(USetStr(31061) & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(31062) & chr(09),BodyAr);	
						if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	(USetStr(31064) & chr(09),BodyAr);	
						end;
						if(bcur==azn)then begin
							AddTextToArea	(USetStr(31064) & chr(09),BodyAr);	
						end;
						if(bcur!=azn)then begin
							AddTextToArea	(USetStr(31064) & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(31065) & chr(09),BodyAr);	
						if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	(USetStr(31067) & chr(09),BodyAr);	
						end;
						if(bcur==azn)then begin
							AddTextToArea	(USetStr(31067) & chr(09),BodyAr);	
						end;
						if(bcur!=azn)then begin
							AddTextToArea	(USetStr(31067) & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(31068) & chr(09),BodyAr);	
						if (modef) then begin
							if(usercanaction("ViewCustomerInfo",true))then begin
								AddTextToArea	(USetStr(31069) & chr(09),BodyAr);	
								AddTextToArea	(USetStr(31070) & chr(09),BodyAr);	
								AddTextToArea	(USetStr(36442) & chr(09),BodyAr);	
								if(RepSpec.flags[2]==1)then begin
									AddTextToArea	("Телефон клиента"& chr(09),BodyAr);	
									AddTextToArea	("Фиксация визитов: Имя" & chr(09),BodyAr);	
									AddTextToArea	("Фиксация визитов: Телефоны" & chr(09),BodyAr);	
									AddTextToArea	("Карта лояльности" & chr(09),BodyAr);	
									AddTextToArea	("Пол" & chr(09),BodyAr);	
									AddTextToArea	("Возраст" & chr(09),BodyAr);	
								end;
							end;
							
							AddTextToArea	(USetStr(31071) & chr(09),BodyAr);	
							AddTextToArea	(USetStr(16709) & chr(09),BodyAr);	
							AddTextToArea	(USetStr(36286) & chr(09),BodyAr);	
							AddTextToArea	(USetStr(31072) & chr(09),BodyAr);	
							AddTextToArea	(USetStr(9269) & chr(09),BodyAr);	
							AddTextToArea	(USetStr(16574) & chr(09),BodyAr);	
							if(currentcompany==9)then begin
								AddTextToArea	(USetStr(3264) & chr(09),BodyAr);	
							end;
							AddTextToArea	(USetStr(36250) & chr(09),BodyAr);	
							AddTextToArea	("Код доп. скидки" & chr(09),BodyAr);	
							AddTextToArea	(USetStr(31073) & chr(09),BodyAr);	
							AddTextToArea	("Fiscal number" & chr(09),BodyAr);	
						end;
						if(currentcompany==25 and RepSpec.flags[2]!=0) then begin
							AddTextToArea	("Текущий процент при покупке" & chr(09),BodyAr);	
						end;
						//if (addclassf) then begin //Edit***************************Sasha2,14:00 08.02.2016 {
						 // for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
						 //   outstring(0,0,typename[typecode[j]],false);
						 // end;
						//end; //Edit***************************Sasha2,14:01 08.02.2016 }
						
						/*ctypecnt = 0; //Edit***************************Sasha2,14:10 11.11.2015 { 
						CTyper.Code = "";
						while (LoopMain(CTyper,1,true)) begin
							typeindex[ctypecnt] = CTyper.Code;
							dispnames[typeindex[ctypecnt]] = "";
							outstring(0,0,CTyper.Code,false);
							ctypecnt = ctypecnt + 1;
						end;*///Edit***************************Sasha2,14:10 11.11.2015 }	
					AddTextToArea	(chr(13),BodyAr);

					total_rebate = 0;//Edit***********************Vitalii 14:28 26.08.2014
					total_rebate_qty = 0;
					total_qty = 0;
					total_cost = 0;
					total_price = 0;
					total_gp = 0;
					btotal_cost = 0;
					btotal_price = 0;
					btotal_gp = 0;
					rangecnt = 0; //Edit***************************Sasha2,11:41 20.11.2014
					arrsize = 25; 
					
					//arrsize = arrsize + ctypecnt; //Edit***************************Sasha2,16:49 11.11.2015
					arrsize = arrsize + typescnt;
					
					IVr.TransDate = sd;
					keyi = 1;
					keystr = "TransDate";
					
					// _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 14:58 14.01.2020
					
					// Для вывода отчета по кодам локаций с матриц счетов-фактур не подходит следующий ключ
					
					// if(nonblank(location))then begin	
						// IVr.Location = location;
						// keyi = 2;
						// keystr = "Location";
					// end;
					
					if(RepSpec.flags[2]==1)then begin
						MCr.TransDate = sd;
						TrHs = true;
						while(loopkey("TransDate",MCr,1,TrHs))begin
							if(MCr.TransDate>ed)then begin TrHs = false; end;
						
							if(TrHs)then begin
								if(nonblank(MCr.InvNr))then begin
									pos = 0;
									tstr = "";
									ExtractObj(MCr.InvNr,pos,tstr);
									while(nonblank(tstr))begin
										if(nonblank(tstr))then begin
											vVisitName[tstr] = MCr.Name;
											vVisitPhone[tstr] = MCr.Phone3 & " " & MCr.Phone2 & " " & MCr.Phone1;
										end;
										ExtractObj(MCr.InvNr,pos,tstr);
									end;
								end;
							end;
						end;
					end;
					LCCBLevelr.LCMLevel = "CASACOIN";
					found = ReadFirstMain(LCCBLevelr,1,true);
					TrHs = true;
					while(loopkey(keystr,IVr,keyi,TrHs)) begin
						if(CurrentCompany==25 and RepSpec.flags[2]!=0) then begin
							cashbackPercent = 0;
							LoyaltyCardr.SerNr = IVr.LoyaltyCardNr;
							if ((nonblank(IVr.LoyaltyCardNr) and ReadFirstMain(LoyaltyCardr,1,true))) then begin
								rnd = DefaultValRoundoff;
								rnd.decimals = 2;
								rnd.mode = kRoundingModeHalfUp;
								loyCardPointsBalance = LoyaltyCardr.CashbackLevelPoints;
								rowcnt = MatRowCnt(IVr);							
								if (found) then begin						
									rnd.decimals = LCCBLevelr.RndTo;
									rwcnt = MatRowCnt(LCCBLevelr);
									for (i=0;i<rwcnt;i=i+1) begin
										MatRowGet(LCCBLevelr,i,LCCBLevelrw);
										if (LCCBLevelrw.FromPoints<=loyCardPointsBalance and LCCBLevelrw.CashbackPercent>0) then begin									
											if (LCCBLevelrw.ToPoints>=loyCardPointsBalance or LCCBLevelrw.ToPoints==BlankVal) then begin
												cashbackPercent = LCCBLevelrw.CashbackPercent;
												i = rwcnt;
											end;
										end;
									end;
								end;	
							end;
						end;
						testf = true;
						cred = 1;
						if(IVr.InvType==kInvoiceTypeCredit)then begin
							cred = -1;
						end;
											
						
						if(RepSpec.flags[1]!=0 and IVr.OrderNr!=-1) then begin testf = false; end;
						if(IVr.InvDate<sd)then begin testf = false; end;
						if(IVr.InvDate>ed)then begin TrHs = false; testf = false; end;
						// if(nonblank(location) and IVr.Location!=location)then begin TrHs = false; testf = false; end;
						if(IVr.OKFlag==0)then begin testf = false; end;
						if(IVr.Invalid>0)then begin testf = false; end;
						if(nonblank(RepSpec.f6) and !setinset(IVr.CustCode,RepSpec.f6))then begin testf = false; end;
						if(nonblank(RepSpec.f8) and !setinset(RepSpec.f8,IVr.Objects))then begin testf = false; end;
						if(IVr.PriceList!="RRP" and IVr.PriceList!="CC" and RepSpec.flags[3]!=0) then begin testf = false; end;
						
						if(RepSpec.flags[4]==1)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 21 09 2020 y. at 11:38:16 AM
							if(IVr.ECOMMERCEOrdf==0)then begin
								testf = false;
							end;
						end;
						if(RepSpec.flags[4]==2)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 21 09 2020 y. at 11:38:16 AM
							if(IVr.ECOMMERCEOrdf!=0)then begin
								testf = false;
							end;
						end;
						
						if(RepSpec.flags[6]==1)then begin
							if(blank(IVr.TaxTransactionCode))then begin
								testf = false;
							end;
						end;
						
						if(testf)then begin
							mtrw = matrowcnt(IVr);
							
							tstr = "";
							For(i=0;i<mtrw;i=i+1) begin
								matrowget(IVr,i,IVrw);
								if(setinset(IVrw.PayMode,tstr)==false)then begin
									if(nonblank(tstr))then begin
										tstr = tstr & ",";
									end;
									tstr = tstr & IVrw.PayMode;
								end;
							end; 
							
							if(RepSpec.flags[2]==1)then begin
								CUr.Code = IVr.CustCode;
								readfirstmain(CUr,1,true);
							end;
							
							For(i=0;i<mtrw;i=i+1) begin
								testf2 = true;
								matrowget(IVr,i,IVrw);
								matrowget(IVr,i,IV2rw);
								
								if(nonblank(IVrw.Location))then begin // conslocation, deflocation
									if(nonblank(location) and IVrw.Location!=location and IVrw.Location!=conslocation and IVrw.Location!=deflocation)then begin testf2 = false; end;
								end else begin
									if(nonblank(location) and IVr.Location!=location and IVr.Location!=conslocation and IVr.Location!=deflocation)then begin testf2 = false; end;
								end;
								if(testf2)then begin
									if(IVrw.stp==kInvoiceRowTypeGiftVoucherSold and blank(RepSpec.f4) and blank(RepSpec.f5) and blank(RepSpec.f2) and blank(RepSpec.f9) and blank(RepSpec.f10) and userbrandf==false)then begin
										PrintGftSertSold(IVr,i,total_price,bcur,azn,addclassf, modef);
									end;
									if(IVrw.stp==kInvoiceRowTypeNormal and nonblank(IVrw.ArtCode))then begin
										INr.Code = IVrw.ArtCode;
										readfirstmain(INr,1,true);
										testf1=true;
										IDr.DupCode = IVrw.ArtCode;
										INr.Code = IVrw.ArtCode;
										if(RepSpec.flags[5]==1 and INr.ConsgType!=1) then begin testf1 = false; end;
										if(ReadFirstKey("DupCode",IDr,1,true) and testf1) then begin
											dupINr.Code = IDr.OrigCode;
											while(LoopMain(dupINr,1,testf2)) begin
												if(dupINr.Code!=IDr.OrigCode) then begin testf2 = false; end;
												if(dupINr.BPIBrand==IDr.OrigBrandCode and testf2) then begin
													INr.Code = IDr.OrigCode;
													DubCodes[IDr.OrigCode] = IDr.DupCode;
												end;
											end;
										end;
										readfirstmain(INr,1,true);
										testf2=true;
									
										if(RepSpec.flags[0]==1 and INr.OutOfOrder==1)then begin testf1 = false; end;
										if(nonblank(RepSpec.f2) and testf1)then begin
											testf1=SetInSet2(RepSpec.f2,INr.DispGroups);
										end;
										if(nonblank(RepSpec.f9) and !setinset(RepSpec.f9,IVrw.Objects))then begin testf1 = false; end;
										if(nonblank(RepSpec.f10) and RepSpec.f10!=IVrw.ArtCode)then begin testf1 = false; end;
										
										if(userbrandf and testf1)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 19 06 2019 y. at 4:35:18 PM
											pos = 0;
											brand = "";
											testf1 = false;
											ExtractObj(INr.DispGroups,pos,brand);
											while(nonblank(brand)) begin
												if(userbrand[brand])then begin
													testf1 = true;
												end;
												ExtractObj(INr.DispGroups,pos,brand);
											end;
										end;
										
										if(testf1)then begin
											if(nonblank(RepSpec.f4) or nonblank(RepSpec.f5))then begin
												brand = "";
												model = "";
												category = "";
												pos = 0;
												classfind = "";
												ExtractObj(INr.DispGroups,pos,classfind);
												while(nonblank(classfind)) begin
													DIr.Code = classfind;
													readfirstmain(DIr,1,true);
													if(DIr.CType=="BRAND")then begin
														brand = DIr.Code;
													end;
													if(DIr.CType=="MODEL")then begin
														model = DIr.Code;
													end;
													ExtractObj(INr.DispGroups,pos,classfind);
												end;
												if(nonblank(RepSpec.f4) and brand!=RepSpec.f4)then begin
													testf1 = false;
												end;
												if(nonblank(RepSpec.f5) and model!=RepSpec.f5)then begin
													testf1 = false;
												end;
											end;
										end;
										
										if(testf1) then begin
											pos = 0;
											brand = "";
											model = "";
											if (addclassf) then begin //Edit***************************Sasha2,14:05 02.06.2016 {
												ExtractObj(INr.DispGroups,pos,uloc);
												while (NonBlank(uloc)) begin
													DIr.Code = uloc;
													if (readfirstmain(DIr,1,true)) then begin
														if (DIr.CType=="BRAND") then begin
															brand = DIr.Name;
														end;
														if (DIr.CType=="MODEL") then begin
															model = DIr.Name;
														end;
														if (NonBlank(DIr.CType)) then begin 
															if (DIr.CType=="GENDER") then begin
																switch (Left(UpperCase(INr.MainDisp),1)) begin
																	case "A":
																		DIr.CType = DIr.CType & "_A";
																		typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
																	case "J":
																		DIr.CType = DIr.CType & "_J";
																		typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
																	case "W":
																		DIr.CType = DIr.CType & "_W";
																		typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
																end;
															end else begin
																typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
																switch (Left(UpperCase(INr.MainDisp),1)) begin //if classifications in custom separate fields {
																	case "A":
																		if (NonBlank(INr.Reference)) then begin
																			collf = true;
																			collstr = "COLL_A";
																		end;
																		if (NonBlank(INr.Metal)) then begin
																			metalf = true;
																			metalstr = "MATERIAL_A";
																		end;
																	case "J":
																		if (NonBlank(INr.Reference)) then begin
																			collf = true;
																			collstr = "COLL_J";
																		end;
																		if (NonBlank(INr.Metal)) then begin
																			metalf = true;
																			metalstr = "MATERIAL_J";
																		end;
																		if (NonBlank(INr.RowWeight)) then begin
																			tstr = typeval["WEIGHT"];
																			pos1 = 0;
																			ExtractObj(tstr,pos1,uloc1);
																			if (uloc1==INr.Code) then begin
																				ExtractObj(tstr,pos1,uloc1);
																				if (blank(uloc1)) then begin
																					typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
																				end;
																			end else begin
																				typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
																			end;
																		end;
																		if (NonBlank(INr.MajStoneDet)) then begin
																			tstr = typeval["D_CARAT"];
																			pos1 = 0;
																			ExtractObj(tstr,pos1,uloc1);
																			if (uloc1==INr.Code) then begin
																				ExtractObj(tstr,pos1,uloc1);
																				if (blank(uloc1)) then begin
																					typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
																				end;
																			end else begin
																				typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
																			end;
																		end;
																	case "W":
																		if (NonBlank(INr.Reference)) then begin
																			collf = true;
																			collstr = "COLL_W";
																		end;
																		if (NonBlank(INr.Metal)) then begin
																			metalf = true;
																			metalstr = "MATERIAL_W";
																		end;
																end; 
																if (collf) then begin
																	tstr = typeval[collstr];
																	pos1 = 0;
																	ExtractObj(tstr,pos1,uloc1);
																	if (uloc1==INr.Code) then begin
																		ExtractObj(tstr,pos1,uloc1);
																		if (blank(uloc1)) then begin
																			typeval[collstr] = INr.Code & ";" & INr.Reference;
																		end;
																	end else begin
																		typeval[collstr] = INr.Code & ";" & INr.Reference;
																	end;  
																	collf = false;
																end;
																if (metalf) then begin
																	tstr = typeval[metalstr];
																	pos1 = 0;
																	ExtractObj(tstr,pos1,uloc1);
																	if (uloc1==INr.Code) then begin
																		ExtractObj(tstr,pos1,uloc1);
																		if (blank(uloc1)) then begin
																			typeval[metalstr] = INr.Code & ";" & INr.Metal;
																		end;
																	end else begin
																		typeval[metalstr] = INr.Code & ";" & INr.Metal;
																	end;
																	metalf = false;
																end;//if classifications in custom separate fields }
															end;
														end;
													end; //Edit***************************Sasha2,14:05 02.06.2016 }
													ExtractObj(INr.DispGroups,pos,uloc);
												end;
											end;
											if (modef) then begin
												startformat(15);
											end;
												if (modef) then begin
													if(Left(INr.Code,3)=="IN_") then begin
														AddTextToArea	(INr.AlternativeCode & chr(09),BodyAr);	
														AddTextToArea	(INr.Code & chr(09),BodyAr);	
													end else begin
														if (left(INr.Code,2)=="IN" and currentcompany==29) then begin
															AddTextToArea	(Right(INr.GlobalArtCode,len(INr.GlobalArtCode)-9) & chr(09),BodyAr);	
															AddTextToArea	(INr.Code & chr(09),BodyAr);	
														end else begin
															AddTextToArea	(INr.Code & chr(09),BodyAr);	
															AddTextToArea	(INr.AlternativeCode & chr(09),BodyAr);	
														end;
													end;
													AddTextToArea	(INr.OrigCode & chr(09),BodyAr);	
													AddTextToArea	(DubCodes[INr.Code] & chr(09),BodyAr);	
													if(nonblank(IVrw.Location))then begin
														AddTextToArea	(IVrw.Location & chr(09),BodyAr);	
													end else begin
														AddTextToArea	(IVr.Location & chr(09),BodyAr);	
													end;
													
													if (addclassf==false) then begin
														classname = "";
														if(nonblank(INr.BPIBrand)) then begin
															AddTextToArea	(BPICodeToName(INr.BPIBrand) & chr(09),BodyAr);	
														end else begin
															if (currentcompany==29) then begin
																if (nonblank(GetECItemBrand(INr.GlobalArtCode))) then begin
																	AddTextToArea	(GetECItemBrand(INr.GlobalArtCode) & chr(09),BodyAr);	
																end else begin
																	AddTextToArea	("" & chr(09),BodyAr);	
																end;
															end else begin
																AddTextToArea	("" & chr(09),BodyAr);	
															end;
														end;
														classname2 = "";
														k=0;
														ExtractObj(INr.DispGroups,k,classcode);
														DIr.Code = classcode;
														readfirstmain(DIr,1,true);
														classname2 = DIr.Name;
														if(currentcompany==9) then begin
															category = DIr.CCat;	//Edit----------------------Dima  20.03.2015
														end;	
														if(currentcompany==13)then begin										
															AddTextToArea	(DIr.Name & chr(09),BodyAr);	
														end else begin
															AddTextToArea	(BPICodeToName(INr.BPICollection) & chr(09),BodyAr);	
														end;
														//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
													end else begin //Edit***************************Sasha2,14:11 02.06.2016 {
														if(nonblank(INr.BPIBrand)) then begin
															AddTextToArea	(BPICodeToName(INr.BPIBrand) & chr(09),BodyAr);	
														end else begin
															AddTextToArea	(brand & chr(09),BodyAr);	
														end;	
													end; //Edit***************************Sasha2,14:11 02.06.2016 ]

													
													/*ExtractObj(INr.DispGroups,k,classcode); //Edit***************************Sasha2,14:52 11.11.2015 {
													while (NonBlank(classcode)) begin
														DIr.Code = classcode;
														if (readfirstmain(DIr,1,true)) then begin
															dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ",";
														end;
														ExtractObj(INr.DispGroups,k,classcode);
													end;*/ //Edit***************************Sasha2,14:52 11.11.2015 }
													
													if(currentcompany==9) then begin
														AddTextToArea	(category & chr(09),BodyAr);	
														AddTextToArea	(prepareStr(IVrw.Spec) & chr(09),BodyAr);	
														AddTextToArea	(INr.Reference & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIMaterial) & chr(09),BodyAr);	
														AddTextToArea	(INr.MajStoneDet & chr(09),BodyAr);	
														AddTextToArea	(INr.SN & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPISize) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIColor) & chr(09),BodyAr);	
													end else begin
														AddTextToArea	(prepareStr(IVrw.Spec) & chr(09),BodyAr);	
														AddTextToArea	(INr.Reference & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPICollection) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIGroup) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPISubGroup) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPICategory) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIMaterial) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIColor) & chr(09),BodyAr);	
														AddTextToArea	(INr.High & chr(09),BodyAr);	
														AddTextToArea	(INr.Life2 & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPISize) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIUse) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPISex) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIPlating) & chr(09),BodyAr);	
														if (INr.BPIBrand=="BRND0046") then begin
															AddTextToArea	(INr.CCCollectName & chr(09),BodyAr);	
														end else begin
															AddTextToArea	("" & chr(09),BodyAr);	
														end;						
														AddTextToArea	(BPICodeToName(INr.BPIClarity) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIWeight) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPICut) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIShape) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIStone) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIStrap) & chr(09),BodyAr);	
														AddTextToArea	(BPICodeToName(INr.BPIOdour) & chr(09),BodyAr);	
														if (CurrentCompany==25) then begin
															AddTextToArea	(INr.SNOne & chr(09),BodyAr);	
														end else begin
															AddTextToArea	("" & chr(09),BodyAr);	
														end;
														if(CompanyIsJWLikeCompany(currentcompany))then begin
															AddTextToArea	(INr.RowWeight & chr(09),BodyAr);	
															AddTextToArea	(INr.MajStoneDet & chr(09),BodyAr);	
															AddTextToArea	(INr.SN & chr(09),BodyAr);	
														end;
													end else begin
														/*for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
															pos = 0;
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															if (uloc==INr.Code) then begin
																ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
																outstring(0,0,uloc,false);
															end else begin
																outstring(0,0,"",false);
															end;
														end;*/
													end; //Edit***************************Sasha2,14:21 02.06.2016 }
													
													AddTextToArea	(IVrw.SerialNr & chr(09),BodyAr);	
													AddTextToArea	(INr.BarCode & chr(09),BodyAr);	
													AddTextToArea	(INr.EKNCode & chr(09),BodyAr);	
													AddTextToArea	(IVrw.Quant*cred & chr(09),BodyAr);	
												end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
													if(nonblank(IVrw.Location))then begin
														rangeval = CalculateCoef(IV2r,rangecnt,IVrw.ArtCode,IVrw.Location,iteminf,arrsize);
													end else begin
														rangeval = CalculateCoef(IV2r,rangecnt,IVrw.ArtCode,IVr.Location,iteminf,arrsize);
													end;
													valscnt = rangeval;
													strscnt = rangeval;
													if (iteminf==false) then begin
														arrstrs[strscnt] = IVrw.ArtCode; strscnt = strscnt + 1;
														arrstrs[strscnt] = INr.AlternativeCode; strscnt = strscnt + 1;
														if(nonblank(IVrw.Location))then begin
															arrstrs[strscnt] = IVrw.Location; strscnt = strscnt + 1;
														end else begin
															arrstrs[strscnt] = IVr.Location; strscnt = strscnt + 1;
														end;
														
														if (addclassf==false) then begin
															classname = "";
															k=0;
															ExtractObj(INr.DispGroups,k,classcode);
															DIr.Code = classcode;
															readfirstmain(DIr,1,true);
															classname = DIr.Name;
															//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
															arrstrs[strscnt] = classname; strscnt = strscnt + 1;
															
															classname2 = "";
															ExtractObj(INr.DispGroups,k,classcode);
															DIr.Code = classcode;
															readfirstmain(DIr,1,true);
															classname2 = DIr.Name;
															//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
															arrstrs[strscnt] = classname2; strscnt = strscnt + 1;
														end else begin //Edit***************************Sasha2,14:23 02.06.2016 {
															arrstrs[strscnt] = brand; strscnt = strscnt + 1;
														end; //Edit***************************Sasha2,14:23 02.06.2016 }
														
														arrstrs[strscnt] = prepareStr(IVrw.Spec); strscnt = strscnt + 1;
														if (addclassf==false) then begin //Edit***************************Sasha2,14:21 02.06.2016 {
															arrstrs[strscnt] = INr.Reference; strscnt = strscnt + 1; 
															arrstrs[strscnt] = INr.Metal; strscnt = strscnt + 1; 
															arrstrs[strscnt] = INr.RowWeight;strscnt = strscnt + 1;
															arrstrs[strscnt] = INr.MajStoneDet; strscnt = strscnt + 1;
															//if(CompanyIsJWLikeCompany(currentcompany))then begin
																//arrstrs[strscnt] = INr.BrcStr; strscnt = strscnt + 1; 
																//arrstrs[strscnt] = INr.Gender; strscnt = strscnt + 1;
															//end;
															if(currentcompany==13)then begin	//Edit----------------------Dima  30.04.2015
																arrstrs[strscnt] = INr.Size; strscnt = strscnt + 1; 
																arrstrs[strscnt] = INr.Colour; strscnt = strscnt + 1;
															end;	  
														end else begin
															for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
																pos = 0;
																ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
																if (uloc==INr.Code) then begin
																	ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
																	arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
																end else begin
																	arrstrs[strscnt] = ""; strscnt = strscnt + 1;
																end;
															end;
														end; //Edit***************************Sasha2,14:21 02.06.2016 }
														//arrstrs[strscnt] = ""; strscnt = strscnt + 1;											
														arrstrs[strscnt] = INr.BarCode; strscnt = strscnt + 1;
														arrstrs[strscnt] = INr.EKNCode; strscnt = strscnt + 1;
														
														/*ExtractObj(INr.DispGroups,k,classcode); //Edit***************************Sasha2,14:52 11.11.2015 {
														while (NonBlank(classcode)) begin
															DIr.Code = classcode;
															if (readfirstmain(DIr,1,true)) then begin
																dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ",";
															end;
															ExtractObj(INr.DispGroups,k,classcode);
														end; *///Edit***************************Sasha2,14:52 11.11.2015 }
														
													end else begin
														if(addclassf)then begin
															strscnt = strscnt + 7 + typescnt;
														end else begin
															if (currentcompany==13) then begin
																strscnt = strscnt + 14;
															end else begin
																strscnt = strscnt + 12;
															end;
														end;
													end;
													arrvals[valscnt] = arrvals[valscnt] + IVrw.Quant * cred; valscnt = valscnt + 1;
												end; //Edit***************************Sasha2,11:18 20.11.2014 }
												
												total_qty = total_qty + IVrw.Quant;
												fr = IVr.FrRate;
												to1 = IVr.ToRateB1;
												if(fr==0 or to1==0)then begin
													fr = 1;
													to1 = 1;
												end;
												IVrw.Price = IVrw.Price/fr*to1;
												IVrw.Sum = IVrw.Sum/fr*to1;
												
												if(IVr.UpdStockFlag>0 and IVr.OrderNr<0)then begin
													updst = true;
												end else begin
													updst = false;
												end;
												
												
												FindFIFOOrigValAndCurncyIV(IVr.SerNr,i,brandfifo,brandcur,fifob1,updst,addCurs,currencyBalances,additionalCurF,tmpbool); //Edit***************************Sasha2,16:02 13.09.2017
												if(fifob1==0)then begin
													if(IVrw.FIFORowVal==0)then begin
														fifob1 = IVrw.FIFORowVal;
													end else begin
														fifob1 = INr.WeighedAvPrice * IVrw.Quant;
													end;
												end;
												if(brandfifo==0)then begin
													brandfifo = INr.LastPurchPrice2 * IVrw.Quant;
												end;
												
												
												brandfifo = AbsoluteVal(brandfifo/IVrw.Quant);
												fifob1 = AbsoluteVal(fifob1/IVrw.Quant);
												for (j=0;j<addCurs.length;j=j+1) begin //Edit***************************Sasha2,11:46 14.09.2017 {
													currencyBalances[addCurs[j]] = AbsoluteVal(currencyBalances[addCurs[j]]/IVrw.Quant);
												end; //Edit***************************Sasha2,11:46 14.09.2017 }
												
												
												if (true) then begin
													azn = "EUR";
													GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
													AddTextToArea	(aznto & chr(09),BodyAr);	
													azn = "AZN";
													if(currentcompany==10)THEN BEGIN
														azn = "PLN";
													end;
													if(currentcompany==11 or currentcompany==12)THEN BEGIN
														azn = "IRR";
													end;
												end;
												
												
												GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
												if(aznfr==0 or aznto==0)then begin
													aznfr = 1; aznto = 1;
												end;
												fifoazn = fifob1*aznfr/aznto;
												if (modef) then begin
													AddTextToArea	(brandfifo & chr(09),BodyAr);	
													if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
														AddTextToArea	(currencyBalances[CurncyCoder.CurncyCode] & chr(09),BodyAr);	
													end;
													if(bcur==azn)then begin
														AddTextToArea	(fifoazn & chr(09),BodyAr);	
													end;
													if(bcur!=azn)then begin
														outstring(102,0,fifob1,false);//basecur
														AddTextToArea	(fifob1 & chr(09),BodyAr);	
													end;
													AddTextToArea	(brandfifo*IVrw.Quant*cred & chr(09),BodyAr);	
													if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
														AddTextToArea	(currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant*cred & chr(09),BodyAr);	
													end;
													if(bcur==azn)then begin
														AddTextToArea	(fifoazn*IVrw.Quant*cred & chr(09),BodyAr);	
													end;
													if(bcur!=azn)then begin
														AddTextToArea	(fifob1*IVrw.Quant*cred & chr(09),BodyAr);	
													end;
												end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
													arrvals[valscnt] = arrvals[valscnt] + brandfifo; valscnt = valscnt + 1;
													if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
														arrvals[valscnt] = arrvals[valscnt] + currencyBalances[CurncyCoder.CurncyCode]; valscnt = valscnt + 1;
													end;
													arrvals[valscnt] = arrvals[valscnt] + fifoazn; valscnt = valscnt + 1;
													if(bcur!=azn)then begin
														arrvals[valscnt] = arrvals[valscnt] + fifob1; valscnt = valscnt + 1;
													end;
													arrvals[valscnt] = arrvals[valscnt] + brandfifo*IVrw.Quant*cred; valscnt = valscnt + 1;
													if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
														arrvals[valscnt] = arrvals[valscnt] + currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant*cred; valscnt = valscnt + 1;
													end;
													arrvals[valscnt] = arrvals[valscnt] + fifoazn*IVrw.Quant*cred; valscnt = valscnt + 1;
													if(bcur!=azn)then begin
														arrvals[valscnt] = arrvals[valscnt] + fifob1*IVrw.Quant*cred; valscnt = valscnt + 1;
													end;
												end; //Edit***************************Sasha2,11:18 20.11.2014 }
												
												GetFullCurncyRate(brandcur,IVr.TransDate,fr,to1,to2,br1,br2);
												if(fr==0 or to1==0)then begin
													fr = 1; to1 = 1;
												end;
												/*if(fr==0 or to1==0)then begin
													fr = 1; to1 = 1;
												end;*/
												bfr = IVr.FrRate;
												bto = IVr.ToRateB1;
												if(bfr==0 or bto==0)then begin
													bfr = 1;
													bto = 1;
												end;
												
												total_cost = total_cost + fifoazn*IVrw.Quant*cred;
												btotal_cost = btotal_cost + fifob1*IVrw.Quant*cred;
												
												if(brandcur==IVr.CurncyCode)then begin
													curprice = IV2rw.Price*cred;
												end else begin
													curprice = round(IVrw.Price*fr/to1,SetRoundModeD(1))*cred;
												end;
												
												if (additionalCurF) then begin  //Edit***************************Sasha2,11:27 14.09.2017 {
													if (IVr.CurncyCode==CurncyCoder.CurncyCode) then begin
														EURprice = IV2rw.Price*cred;
													end else begin
														EURprice = BlankVal;
														CurValToOtherCur(IVr.InvDate,azn,IVrw.Price,CurncyCoder.CurncyCode,EURprice,SetRoundModeD(1)); //Edit***************************Sasha2,11:13 14.09.2017
														EURprice = EURprice*cred;
													end;
												end; //Edit***************************Sasha2,11:27 14.09.2017 }
												
												if (modef) then begin
													AddTextToArea	(curprice & chr(09),BodyAr);	
													if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
														AddTextToArea	(EURprice & chr(09),BodyAr);	
													end;
													if(bcur==azn)then begin
														AddTextToArea	(IVrw.Price*aznfr/aznto & chr(09),BodyAr);	
													end;
												end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
													arrvals[valscnt] = arrvals[valscnt] + curprice; valscnt = valscnt + 1;
													if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
														arrvals[valscnt] = arrvals[valscnt] + EURprice; valscnt = valscnt + 1;
													end;
													arrvals[valscnt] = arrvals[valscnt] + IVrw.Price*aznfr/aznto; valscnt = valscnt + 1;
												end; //Edit***************************Sasha2,11:18 20.11.2014 }
												
												total_rebate = total_rebate + IVrw.Price*aznfr/aznto*IVrw.Quant;// Edit ************************** Wednesday, 22 October 2014 16:43:55
												
												if (modef) then begin
													if(bcur!=azn)then begin
														AddTextToArea	(IVrw.Price & chr(09),BodyAr);	
													end;
												end else  begin //Edit***************************Sasha2,11:17 20.11.2014 {
													if(bcur!=azn)then begin
														arrvals[valscnt] = arrvals[valscnt] + IV2rw.Price; valscnt = valscnt + 1;
													end;
												end; //Edit***************************Sasha2,11:18 20.11.2014 }
												
												if(brandcur==IVr.CurncyCode)then begin
													curcusm = IV2rw.Sum*cred;
												end else begin
													curcusm = round(IVrw.Sum*fr/to1,SetRoundModeD(1))*cred;
												end;
												if (additionalCurF) then begin  //Edit***************************Sasha2,11:27 14.09.2017 {
													if (IVr.CurncyCode==CurncyCoder.CurncyCode) then begin
														EURcusm = IVrw.Sum*cred*fr/to1;
													end else begin
														EURcusm = BlankVal;
														CurValToOtherCur(IVr.InvDate,azn,IVrw.Sum,CurncyCoder.CurncyCode,EURcusm,SetRoundModeD(1)); //Edit***************************Sasha2,11:13 14.09.2017
														EURcusm = EURcusm*cred;
													end;
												end; //Edit***************************Sasha2,11:27 14.09.2017 }
												
												if (modef) then begin
													AddTextToArea	(curcusm & chr(09),BodyAr);	
													if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
														AddTextToArea	(EURcusm & chr(09),BodyAr);	
													end;
													if(bcur==azn)then begin
														AddTextToArea	(IVrw.Sum*aznfr/aznto*cred & chr(09),BodyAr);	
													end;
												end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
													arrvals[valscnt] = arrvals[valscnt] + curcusm; valscnt = valscnt + 1;
													if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
														arrvals[valscnt] = arrvals[valscnt] + EURcusm; valscnt = valscnt + 1;
													end;
													arrvals[valscnt] = arrvals[valscnt] + IVrw.Sum*aznfr/aznto*cred; valscnt = valscnt + 1;
												end; //Edit***************************Sasha2,11:17 20.11.2014 }
												
												total_rebate_qty = total_rebate_qty + IVrw.Sum*aznfr/aznto*cred;// Edit ************************** Wednesday, 22 October 2014 16:44:51
												if (modef) then begin
													if(bcur!=azn)then begin
														AddTextToArea	(IVrw.Sum*cred & chr(09),BodyAr);	
													end;
												end else  begin //Edit***************************Sasha2,11:17 20.11.2014 {
													if(bcur!=azn)then begin
														arrvals[valscnt] = arrvals[valscnt] + IVrw.Sum*cred; valscnt = valscnt + 1;
													end;
												end; //Edit***************************Sasha2,11:17 20.11.2014 {
												
												total_price = total_price + IVrw.Sum*aznfr/aznto*cred;
												btotal_price = btotal_price + IVrw.Sum*cred;
												
												if (modef) then begin
													AddTextToArea	((curcusm - brandfifo*IVrw.Quant)*cred & chr(09),BodyAr);	
													if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
														AddTextToArea	((EURcusm -  currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant)*cred & chr(09),BodyAr);	
													end;
													if(bcur==azn)then begin
														AddTextToArea	(IVrw.Sum*aznfr/aznto*cred - fifob1*IVrw.Quant*aznfr/aznto*cred & chr(09),BodyAr);	
													end;
													if(bcur!=azn)then begin
														AddTextToArea	((IVrw.Sum - fifob1*IVrw.Quant)*cred & chr(09),BodyAr);	
													end;
													AddTextToArea	(brandcur & chr(09),BodyAr);	
													if(usercanaction("ViewCustomerInfo",true))then begin
														AddTextToArea	(IVr.CustCode & chr(09),BodyAr);	
														AddTextToArea	(IVr.Addr0 & chr(09),BodyAr);	
														if (true) then begin
															if (FoundObjEx(IVrw)) then begin
																AddTextToArea	("FOUNDER" & chr(09),BodyAr);	
															end else begin
																if (left(IVr.CustCode,4)=="FOB_") then begin
																	AddTextToArea	("FOB" & chr(09),BodyAr);	
																end else begin
																	if (IVr.CustCode=="FOBE_COMMERCE") then begin
																		AddTextToArea	("E_COMMERCE" & chr(09),BodyAr);	
																	end else begin
																		AddTextToArea	("CLIENT" & chr(09),BodyAr);	
																	end;
																end;
															end;
														end;
														if(RepSpec.flags[2]==1)then begin
															AddTextToArea	(CUr.Phone & " " & CUr.Mobile & " " & CUr.AltPhone & chr(09),BodyAr);	
															AddTextToArea	(vVisitName[IVr.SerNr] & chr(09),BodyAr);	
															AddTextToArea	(vVisitPhone[IVr.SerNr] & chr(09),BodyAr);	
															if(IVr.LCMLevel=="CASACOIN") then begin
																AddTextToArea	(IVr.LoyaltyCardNr & chr(09),BodyAr);	
															end else begin	
																AddTextToArea	("" & chr(09),BodyAr);	
															end;	
															Switch(CUr.Gender)begin
																case 0: AddTextToArea	("Мужской" & chr(09),BodyAr);	
																case 1: AddTextToArea	("Женский" & chr(09),BodyAr);	
																case 2: AddTextToArea	("Компания" & chr(09),BodyAr);	
																otherwise
																	AddTextToArea	("" & chr(09),BodyAr);	
															end;
															if(nonblankdate(CUr.BirthDate))then begin
																AddTextToArea	(getYear(currentdate)-getyear(CUr.BirthDate) & chr(09),BodyAr);	
															end else begin
																AddTextToArea	(" " & chr(09),BodyAr);	
															end;
														end;
													end;
												
													
													AddTextToArea	(IVrw.vRebate & chr(09),BodyAr);	
													//total_rebate = total_rebate + IVrw.vRebate*AbsoluteVal(IVrw.Quant);//Edit***********************Vitalii 14:28 26.08.2014
													/*if(IVrw.vRebate!=0)then begin
														total_rebate_qty = total_rebate_qty + AbsoluteVal(IVrw.Quant);											
													end;*/
													AddTextToArea	(IVr.SalesMan & chr(09),BodyAr);	
													AddTextToArea	(IVr.SerNr & chr(09),BodyAr);	
													AddTextToArea	(IVr.TransDate & chr(09),BodyAr);	
													AddTextToArea	(IVr.PayDeal & chr(09),BodyAr);	
													pos = 0;	
													OBJStr = IVrw.Objects;
													Obj = "";
													APriceObj = "";
													ExtractObjWithSeparator(",",OBJStr,true,pos,Obj);
													while (nonblank(Obj)) begin
														Objr.Code = Obj;
														if(ReadFirstMain(Objr,1,true)) then begin
															if(Objr.OTCode=="PROMO")then begin
																APriceObj = Obj;
															end;	
															if(Objr.OTCode=="APRIC")then begin // Edit ************************** Ihor Trubachov 17*05*2021
																if(nonblank(IVrw.Objects))then begin
																	APriceObj = APriceObj & ",";
																end;
																APriceObj = APriceObj & Obj;
															end;	
															if(Objr.OTCode=="AREB")then begin
																if(nonblank(IVrw.Objects))then begin
																	APriceObj = APriceObj & ",";
																end;
																APriceObj = APriceObj & Obj;
															end;	
														end;
														ExtractObjWithSeparator(",",OBJStr,true,pos,Obj);
													end;
													AddTextToArea	(IVr.InvComment & chr(09),BodyAr);	
													AddTextToArea	(APriceObj & chr(09),BodyAr);	
													AddTextToArea	(GetIVRebCode(IVr.AddRebCode,IVrw.Objects) & chr(09),BodyAr);	
											
												end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
													arrvals[valscnt] = arrvals[valscnt] + (curcusm - brandfifo*IVrw.Quant)*cred; valscnt = valscnt + 1;
													if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
														arrvals[valscnt] = arrvals[valscnt] + (EURcusm -  currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant)*cred; valscnt = valscnt + 1;
													end;
													arrvals[valscnt] = arrvals[valscnt] + (IVrw.Sum*aznfr/aznto - fifob1*IVrw.Quant*aznfr/aznto)*cred; valscnt = valscnt + 1;
													if(bcur!=azn)then begin
														arrvals[valscnt] = arrvals[valscnt] + (IVrw.Sum - fifob1*IVrw.Quant)*cred; valscnt = valscnt + 1;
													end;
													arrstrs[strscnt] = brandcur; strscnt = strscnt + 1;
													if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
														for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
															pos = 0;
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															if (uloc==INr.Code) then begin
																ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
																arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
															end else begin
																arrstrs[strscnt] = ""; strscnt = strscnt + 1;
															end;
														end;
													end; //Edit***************************Sasha2,14:37 08.02.2016 }
													/*for (m=0;m<ctypecnt;m=m+1) begin 
														arrstrs[strscnt] = dispnames[typeindex[m]]; strscnt = strscnt + 1;
													end; 
													MyClearVector(dispnames,typeindex,ctypecnt);*/
												end; //Edit***************************Sasha2,11:17 20.11.2014 }
												
												if (modef) then begin //Edit***************************Sasha2,11:17 20.11.2014	
													if(currentcompany==9)then begin
														if(IVr.OrderNr>-1)then begin
															ORr.SerNr = IVr.OrderNr;
															readfirstmain(ORr,1,true);
															if(nonblank(ORr.OrderClass))then begin
																AddTextToArea	(ORr.OrderClass & chr(09),BodyAr);	
															end;
														end;
													end;
													AddTextToArea	(tstr & chr(09),BodyAr);	
													if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
														for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
															pos = 0;
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															if (uloc==INr.Code) then begin
																ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
																AddTextToArea	(uloc & chr(09),BodyAr);	
															end else begin
																AddTextToArea	("" & chr(09),BodyAr);	
															end;
														end;
													end; //Edit***************************Sasha2,14:37 08.02.2016 }
													/*for (m=0;m<ctypecnt;m=m+1) begin //Edit***************************Sasha2,15:28 11.11.2015 {
														outstring(0,0,Left(dispnames[typeindex[m]],len(dispnames[typeindex[m]])-1),false);
													end; 
													MyClearVector(dispnames,typeindex,ctypecnt);*/ //Edit***************************Sasha2,15:28 11.11.2015 }
													AddTextToArea	(IVr.TaxTransactionCode & chr(09),BodyAr);	
												end;
											if(currentcompany==25 and RepSpec.flags[2]!=0) then begin
												if(cashbackPercent!=0) then begin
													AddTextToArea	(cashbackPercent & chr(09),BodyAr);	
												end else begin
													AddTextToArea	("" & chr(09),BodyAr);	
												end;
											end;	
											if (modef) then begin	//Edit***************************Sasha2,11:12 20.11.2014								
												AddTextToArea	(chr(13),BodyAr);
											end;
										end;
									end;
								end;
							end; 
						end;
					end;
					if (modef==false) then begin
						mtrw = matrowcnt(IV2r);
						for (i=0;i<mtrw;i=i+1) begin
							matrowget(IV2r,i,IVrw);
							valscnt = IVrw.Quant;
							strscnt = IVrw.Quant;
							itemoccurrences = IVrw.Sum*cred;
							startformat(15);
								AddTextToArea	(arrstrs[strscnt] & chr(09),BodyAr);	
								AddTextToArea	(arrstrs[strscnt] & chr(09),BodyAr);	
								AddTextToArea	(arrstrs[strscnt] & chr(09),BodyAr);	
								// outstring(4,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname
								// if (addclassf==false) then begin //Edit***************************Sasha2,17:43 02.06.2016 {
									// outstring(5,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname2
								// end; //Edit***************************Sasha2,17:43 02.06.2016 }
								// outstring(6,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //prepareStr(IVrw.Spec)
								// if (addclassf==false) then begin
									// outstring(7,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Reference
									// outstring(8,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Metal
									// outstring(9,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.RowWeight
									// outstring(10,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.MajStoneDet
									// //if(CompanyIsJWLikeCompany(currentcompany))then begin
										// //outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.BrcStr
										// //outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Gender
									// //end;
									// if(currentcompany==13)then begin			//Edit----------------------Dima  30.04.2015
										// outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Size
										// outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Colour
									// end;	
								// end else begin  //Edit***************************Sasha2,17:43 02.06.2016 {
									for (j=0;j<41;j=j+1) begin //if you change "30" do it in other places having "For" loop 
										/*outstring(12,0,arrstrs[strscnt],false);*/ strscnt = strscnt + 1;
									end;
								// end;	//Edit***************************Sasha2,17:43 02.06.2016 }
								AddTextToArea	("" & chr(09),BodyAr);	
								AddTextToArea	(arrstrs[strscnt] & chr(09),BodyAr);	
								AddTextToArea	(arrstrs[strscnt] & chr(09),BodyAr);	
								AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								AddTextToArea	(arrvals[valscnt]/itemoccurrences & chr(09),BodyAr);	
								if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
									AddTextToArea	(arrvals[valscnt]/itemoccurrences & chr(09),BodyAr);	
								end;
								if(bcur==azn)then begin
									AddTextToArea	(arrvals[valscnt]/itemoccurrences & chr(09),BodyAr);	
								end;
								if(bcur!=azn)then begin
									AddTextToArea	(arrvals[valscnt]/itemoccurrences & chr(09),BodyAr);	
								end;
								AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								end;
								if(bcur==azn)then begin
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								end;
								if(bcur!=azn)then begin
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								end;
								AddTextToArea	(arrvals[valscnt]/itemoccurrences & chr(09),BodyAr);	
								if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
									AddTextToArea	(arrvals[valscnt]/itemoccurrences & chr(09),BodyAr);	
								end;
								if(bcur==azn)then begin
									AddTextToArea	(arrvals[valscnt]/itemoccurrences & chr(09),BodyAr);	
								end;
								if(bcur!=azn)then begin
									AddTextToArea	(arrvals[valscnt]/itemoccurrences & chr(09),BodyAr);	
								end;
								AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);									
								end;
								if(bcur==azn)then begin
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								end;
								if(bcur!=azn)then begin
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								end;
								AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								end;
								if(bcur==azn)then begin
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								end;
								if(bcur!=azn)then begin
									AddTextToArea	(arrvals[valscnt] & chr(09),BodyAr);	
								end;
								AddTextToArea	(arrstrs[strscnt] & chr(09),BodyAr);	
								if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
									for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
										AddTextToArea	(arrstrs[strscnt] & chr(09),BodyAr);	
									end;
								end; //Edit***************************Sasha2,14:37 08.02.2016 }
								/*for (m=0;m<ctypecnt;m=m+1) begin //Edit***************************Sasha2,16:15 11.11.2015 {
									outstring(32,0,Left(arrstrs[strscnt],len(arrstrs[strscnt])-1),false); strscnt = strscnt + 1; //disp types
								end;*/ //Edit***************************Sasha2,16:15 11.11.2015 }
								AddTextToArea	(chr(13),BodyAr);

						end;
					end;
									
					startformat(15);
						AddTextToArea	("" & chr(09),BodyAr);	
						AddTextToArea	("" & chr(09),BodyAr);	
						AddTextToArea	("" & chr(09),BodyAr);	
						AddTextToArea	("" & chr(09),BodyAr);	
						if (modef) then begin
							if (addclassf==false) then begin
								AddTextToArea	("" & chr(09),BodyAr);	
							end;
							if (currentcompany==9) then begin
								AddTextToArea	("" & chr(09),BodyAr);	
							end;
							AddTextToArea	("" & chr(09),BodyAr);	
							if (addclassf==false) then begin
								AddTextToArea	("" & chr(09),BodyAr);	
								AddTextToArea	("" & chr(09),BodyAr);	
								AddTextToArea	("" & chr(09),BodyAr);	
								AddTextToArea	("" & chr(09),BodyAr);	
								if (currentcompany==13) then begin
									AddTextToArea	("" & chr(09),BodyAr);	
									AddTextToArea	("" & chr(09),BodyAr);	
								end;
							end else begin
								for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
									AddTextToArea	("" & chr(09),BodyAr);	
								end;
							end;				
							AddTextToArea	("" & chr(09),BodyAr);	
						end;
						AddTextToArea	("" & chr(09),BodyAr);	
						AddTextToArea	(USetStr(31074) & chr(09),BodyAr);	
						AddTextToArea	(total_qty & chr(09),BodyAr);	
						AddTextToArea	("" & chr(09),BodyAr);	
						if(bcur!=azn)then begin
							AddTextToArea	("" & chr(09),BodyAr);	
						end;
						if(bcur==azn)then begin
							AddTextToArea	("" & chr(09),BodyAr);	
						end;
						if (additionalCurF) then begin //additional currency cost, additional currency cost sum //Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	("" & chr(09),BodyAr);	
							AddTextToArea	("" & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(31075) & chr(09),BodyAr);	
						if(bcur==azn)then begin
							AddTextToArea	(total_cost & chr(09),BodyAr);	
						end;
						if(bcur!=azn)then begin
							AddTextToArea	(btotal_cost & chr(09),BodyAr);	
						end;
						AddTextToArea	("" & chr(09),BodyAr);	
						if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	("" & chr(09),BodyAr);	
						end;
						if(bcur==azn)then begin
							AddTextToArea	("" & chr(09),BodyAr);	
						end;
						if (additionalCurF) then begin //additional currency retail sum  //Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	("" & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(31076) & chr(09),BodyAr);	
						if(bcur==azn)then begin
							AddTextToArea	(total_price & chr(09),BodyAr);	
						end;
						if(bcur!=azn)then begin
							AddTextToArea	(btotal_price & chr(09),BodyAr);	
						end;
						if (additionalCurF) then begin //additional currency retail difference//Edit***************************Sasha2,17:02 13.09.2017
							AddTextToArea	("" & chr(09),BodyAr);	
						end;
						AddTextToArea	(USetStr(31077) & chr(09),BodyAr);	
						if(bcur==azn)then begin
							AddTextToArea	(total_price - total_cost & chr(09),BodyAr);	
						end;
						if(bcur!=azn)then begin
							AddTextToArea	(btotal_price - btotal_cost & chr(09),BodyAr);	
						end;
						//Edit***********************Vitalii 14:28 26.08.2014
						AddTextToArea	("" & chr(09),BodyAr);	
						AddTextToArea	("" & chr(09),BodyAr);	
						AddTextToArea	(USetStr(31078) & chr(09),BodyAr);	
						AddTextToArea	(100-(100*(total_rebate_qty/total_rebate)) & chr(09),BodyAr);	
						AddTextToArea	(chr(13),BodyAr);

				end else begin
					startformat(15);
						AddTextToArea	(USetStr(31079) & chr(09),BodyAr);	
						AddTextToArea	(chr(13),BodyAr);
				end;
			end;
			WriteAreaToFile	(BodyAr,FileName,0);
		end;
return;
end;









global
webpublic procedure WebReportExtInFileStart()
begin
	integer compNo, i;
	date startYear;
	record RcVc RepSpec;
	
	
	for (compNo=1;compNo<35;compNo=compNo+1) begin
		if (SetCompany(compNo,false)) then begin
			startYear = "1/1/2017";
			for (i=0;i<6;i=i+1) begin
				logtext(0,CurrentCompany);
				recordnew(RepSpec);
				RepSpec.sStartDate = startYear;
				RepSpec.sEndDate = AddYear(startYear,1);
				RepSpec.f9 = "";
				SalesReportExtInFile(RepSpec);
				startYear = AddYear(startYear,1);
			end;
		end;
	end;
	return;
end;
















// global
// function Boolean GetRebateInfo(record INVc origINr,var val pricep,var val qtp,string cucat,string reb2code,var val rebvp,var Boolean foundstaff,Date tdp,string location)
// BEGIN
  // Boolean res;
  // record CCatVc CCatr;
  // record RebVc Rebr;
  // row RebVc Rebrw;
  // Integer rwcnt;
  // Integer i;
  // string 5 rebcode;
  // Boolean rebfound,testf;// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 17 April 2018 10:22:35
  // string 20 temprebcode; // Edit ************************** Friday, 30 August 2013 11:45:23
  // boolean findreb; // Edit ************************** Friday, 30 August 2013 11:45:23
  // integer checkin; // Edit ************************** Friday, 30 August 2013 11:45:23
  // record MyRebVc MyRebr;// Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 16 April 2018 10:42:44
  // row MyRebVc MyRebrw;// Edit ************************** BPI Ukraine - KramarAlexandr - Monday, 16 April 2018 10:42:45
  // val origrebvp;
  // boolean addflag,presaleflag;
  // record INVc INr;
  // record ItemDuplicatesVc IDr;
  // boolean TrHs2;
  
  // recordcopy(INr,origINr);
  
    // IDr.DupCode = INr.Code;
    // TrHs2 = true;
    // while (loopkey("DupCode",IDr,1,TrHs2)) begin
      // testf = true;
      // if (IDr.DupCode!=INr.Code) then begin TrHs2 = false; testf = false; end;
      // if (IDr.DupBrandCode!=INr.BPIBrand) then begin  testf = false; end;
      // if (testf) then begin
        // INr.Code = IDr.OrigCode;
        // if (ReadFIrstMain(INr,1,true)) then begin end;
      // end;
    // end;
    // ResetLoop(IDr);
  
  
  // addflag = true;
  // rebvp = 0;
  // rebcode = reb2code;
  // if (blank(rebcode)) then begin
    // if (nonblank(cucat)) then begin
      // CCatr.Code = cucat;
      // if (ReadFirstMain(CCatr,1,true)) then begin
        // if (nonblank(CCatr.RebCode)) then begin
          // rebcode = CCatr.RebCode;
        // end;
      // end;
    // end;
  // end;  
  // if (nonblank(rebcode)) then begin
    // temprebcode  = rebcode; //edited by BPI
    // findreb = true;  //edited by BPI
    // checkin = 0;  //edited by BPI
    // while(findreb)begin  //edited by BPI
			// if (GetYear(tdp)>0) then begin
				// Rebr.Replaces = rebcode;
				// Rebr.FromDate = tdp;
				// rebfound = ReadLastKey("Replaces",Rebr,2,false); 
				// if (Rebr.Replaces<>rebcode) then begin rebfound = false; end;
				// if (DateInRange(tdp,Rebr.FromDate,Rebr.ToDate)==false) then begin rebfound = false; end;
				// if (rebfound) then begin rebcode = Rebr.Code; end;
			// end;  
			// if (rebfound==false) then begin
				// Rebr.Code = rebcode;
				// rebfound = ReadFirstMain(Rebr,1,true);
				// findreb = false; //edited by BPI {
			// end; 
			
			// checkin = checkin + 1;
			// If(checkin>20) then begin
				// findreb  = false;
			// end; //edited by BPI }
    // end;
    // if (rebfound and GetYear(tdp)>0) then begin
      // if (DateInRange(tdp,Rebr.FromDate,Rebr.ToDate)==false) then begin rebfound = false; end;
    // end;
    // if (rebfound) then begin
      // if(nonblank(Rebr.AddObject))then begin
        // addflag = false;
      // end;
      // rwcnt = MatRowCnt(Rebr);
      // for (i=0;i<rwcnt;i=i+1) begin
        // MatRowGet(Rebr,i,Rebrw);
				
				// // if(Rebrw.CodeType==2)then begin // Edit ********************** Ihor Trubachov 22*12*2021
					// // if(INr.CCCollectName==Rebr.Collection and nonblank(Rebr.Collection))then begin
						// // rebvp = Rebr.vra0;
						// // res = true;
            // // //goto LGetRebate;
					// // end;
				// // end;
				// if(nonblank(Rebrw.Collection)) then begin // Edit ********************** Ihor Trubachov 20*12*2021
					// if (Rebrw.CodeType==0) then begin
						// if(nonblank(INr.RebGroup))then begin //edited by BPI {
							// if (INr.RebGroup==Rebrw.ITCode and INr.CCCollectName==Rebrw.Collection) then begin
								// GetStaffReb(INr,Rebrw.StaffCode,qtp,pricep,Rebr,i,rebvp,foundstaff);
								// res = true;
								// goto LGetRebate;
							 // end;
						// end;  //edited by BPI }
						// if (INr.Group==Rebrw.ITCode and INr.CCCollectName==Rebrw.Collection) then begin
	// //            GetStaffReb(INr,Rebrw.StaffCode,qtp,pricep,Rebr,rebvp,foundstaff);
							// GetStaffReb(INr,Rebrw.StaffCode,qtp,pricep,Rebr,i,rebvp,foundstaff);
							// res = true;
							// goto LGetRebate;
						// end;
					// end;
					// if (Rebrw.CodeType==1) then begin
						// if (INr.Code==Rebrw.ITCode and INr.CCCollectName==Rebrw.Collection) then begin
							// GetStaffReb(INr,Rebrw.StaffCode,qtp,pricep,Rebr,i,rebvp,foundstaff);
							// res = true;
							// goto LGetRebate;
						// end;
					// end;
				// end else begin	
					// if (Rebrw.CodeType==0) then begin
						// if(nonblank(INr.RebGroup))then begin //edited by BPI {
							// if (INr.RebGroup==Rebrw.ITCode) then begin
								// GetStaffReb(INr,Rebrw.StaffCode,qtp,pricep,Rebr,i,rebvp,foundstaff);
								// res = true;
								// goto LGetRebate;
							 // end;
						// end;  //edited by BPI }
						// if (INr.Group==Rebrw.ITCode) then begin
	// //            GetStaffReb(INr,Rebrw.StaffCode,qtp,pricep,Rebr,rebvp,foundstaff);
							// GetStaffReb(INr,Rebrw.StaffCode,qtp,pricep,Rebr,i,rebvp,foundstaff);
							// res = true;
							// goto LGetRebate;
						// end;
					// end;
					// if (Rebrw.CodeType==1) then begin
						// if (INr.Code==Rebrw.ITCode) then begin
							// GetStaffReb(INr,Rebrw.StaffCode,qtp,pricep,Rebr,i,rebvp,foundstaff);
							// res = true;
							// goto LGetRebate;
						// end;
					// end;
				// end;
      // end;
      // GetStaffReb(INr,Rebr.StaffCode,qtp,pricep,Rebr,-1,rebvp,foundstaff);
      // res = true;
    // end;
    
    // // Edit Start ---------------------------------------------- Edit Start
	// //Monday, 16 April 2018 10:42:06
	
    
    
	// // Edit End ---------------------------------------------- Edit End
	
	// /*
	// if(Inr.Code==MyRebrw.ITCode) then begin
		
	// end;
	// */
  // end;
// LGetRebate:;
	// origrebvp = rebvp;
	// if(nonblank(reb2code) and addflag)then begin
		// MyRebr.Code = "";
		// while(loopmain(MyRebr,1,true))begin
			// if(true)then begin
			  // presaleflag = false;
			  // if(cucat=="APP" and reb2code=="0%")then begin
			    // if(tdp==stringtodate("21/11/2021") or currentuser=="SA1")then begin
			      // if(currentcompany==1)then begin
			        // if(MyRebr.Code=="001")then begin
			          // presaleflag = true;
			        // end;
			      // end;
			      // if(currentcompany==2)then begin
			        // if(MyRebr.Code=="0005")then begin
			          // presaleflag = true;
			        // end;
			      // end;
			      // if(currentcompany==4)then begin
			        // if(MyRebr.Code=="0060")then begin
			          // presaleflag = true;
			        // end;
			      // end;
			      // if(currentcompany==5)then begin
			        // if(MyRebr.Code=="0014")then begin
			          // presaleflag = true;
			        // end;
			      // end;
			      // if(currentcompany==7)then begin
			        // if(MyRebr.Code=="0019")then begin
			          // presaleflag = true;
			        // end;
			      // end;
			      // if(currentcompany==34)then begin
			        // if(MyRebr.Code=="3")then begin
			          // presaleflag = true;
			        // end;
			      // end;
			    // end;
			    // if(tdp==stringtodate("25/11/2021") or currentuser=="SA1")then begin
			      // if(currentcompany==16)then begin
			        // if(MyRebr.Code=="043")then begin
			          // presaleflag = true;
			        // end;
			      // end;
			    // end;
			  // end;
			  
			  
				// if(DateInRange(tdp,MyRebr.FromDate,MyRebr.ToDate) or presaleflag)then begin
					// testf = true;
					// if(tdp==MyRebr.FromDate and MyRebr.FromDate==currentdate)then begin
						// if(nonblanktime(MyRebr.FromTime) and MyRebr.FromTime>currenttime)then begin
							// testf = false;
						// end;
					// end;
					// if(tdp==MyRebr.ToDate and MyRebr.ToDate==currentdate)then begin
						// if(nonblanktime(MyRebr.ToTime) and MyRebr.ToTime<currenttime)then begin
							// testf = false;
						// end;
					// end;
					
					// if(nonblank(MyRebr.Locations))then begin
						// if(!setinset(location,MyRebr.Locations) or blank(location))then begin
							// testf = false;
						// end;
					// end;
					
					// if(testf)then begin
						// rwcnt = MatRowCnt(MyRebr);
						// for (i=0;i<rwcnt;i=i+1) begin
							// MatRowGet(MyRebr,i,MyRebrw);
						
						
							// // if(MyRebrw.CodeType==2)then begin // Edit ********************** Ihor Trubachov 22*12*2021
								// // if(INr.CCCollectName==MyRebr.Collection and nonblank(MyRebr.Collection))then begin
									// // rebvp = MyRebrw.vra0;
									// // if(MyRebrw.vra0==-1)then begin
										// // rebvp = origrebvp;
									// // end;
								// // end;
							// // end;
							// if(nonblank(MyRebrw.Collection)) then begin // Edit ********************** Ihor Trubachov 20*12*2021
								// if(MyRebrw.CodeType==0)then begin
									// if(INr.Group==MyRebrw.ITCode and INr.CCCollectName==MyRebrw.Collection)then begin
										// rebvp = MyRebrw.vra0;
										// if(MyRebrw.vra0==-1)then begin
											// rebvp = origrebvp;
										// end;
									// end;
								// end;
								// if(MyRebrw.CodeType==1)then begin
									// if(INr.Code==MyRebrw.ITCode and INr.CCCollectName==MyRebrw.Collection)then begin
										// rebvp = MyRebrw.vra0;
										// if(MyRebrw.vra0==-1)then begin
											// rebvp = origrebvp;
										// end;
									// end;
								// end;
							// end else begin
								// if(MyRebrw.CodeType==0)then begin
									// if(INr.Group==MyRebrw.ITCode)then begin
										// rebvp = MyRebrw.vra0;
										// if(MyRebrw.vra0==-1)then begin
											// rebvp = origrebvp;
										// end;
									// end;
								// end;
								// if(MyRebrw.CodeType==1)then begin
									// if(INr.Code==MyRebrw.ITCode)then begin
										// rebvp = MyRebrw.vra0;
										// if(MyRebrw.vra0==-1)then begin
											// rebvp = origrebvp;
										// end;
									// end;
								// end;
							// end;
						// end;
					// end;
				// end;
			// end;
		// end;    
	// end;
	
	
	// if(INr.Code=="GLOBALGIFTCARD")then begin// Edit ************************** BPI Ukraine - KramarAlexandr - Friday, 31 August 2018 11:14:07
		// rebvp = blankval;
	// end;

  // GetRebate = res;
  // RETURN;
// END;



procedure GetRebateSales (string ItemCode, date rebSd, date rebEd, date repSd, date repEd, string Location, var val vSaleQtyPrc, val RebPrc, record RcVc RepSpec, vector boolean vIVItem,
														var val fifoazn, var val fifob1, var val rowfifoazn, var val rowfifob1, var val brandfifo, var val rowbrandfifo,
														var val curprice, var val aznprice, var val curcusm, var val aznsum)
begin
		
	
	record INVc INr, dupINr;
	record IVVc IVr;
	row IVVc IVrw, IV2rw;
	longint i,j,k,x,r,INcnt,s;
	vector string 255 vItemRebObj, DubCodes, vRebObj;
	boolean rebfound, TrHs, testf, testf1, testf2, rebf, rebitemf, TrHs2, updst, additionalCurF, tmpbool;
	string 255 brand, conslocation, deflocation, brandcur, azn, bcur;
	vector string 255 vRebItems, vRebObjects, vRebFromDate, vRebToDate, vINGroup;
	array string 255 aRebs, aItems, vRebCodes, addCurs;
	vector date vRebStartDate, vRebEndDate;
	vector longint vRebcnt;
	vector boolean vItemRebInMathm, aRebFound, userbrand;
	record ItemDuplicatesVc IDr;
	integer pos;
	vector val vRebPrc, currencyBalances;
	record ItemHistVc IHr;
	val aznfr, aznto, to2, br1, br2, fr,to1, bfr, bto, brfifo, ffazn, ffobl;
	integer cred;
	record CurncyCodeVc CurncyCoder; //Edit***************************Sasha2,13:55 14.09.2017
	date sd, ed;
	longint iterIV;

	ffobl = 0;
	fifoazn = 0;
	fifob1 = 0;
	rowfifoazn = 0;
	rowfifob1 = 0;
	brandfifo = 0;
	rowbrandfifo = 0;
	curprice = 0;
	aznprice = 0;
	curcusm = 0;
	aznsum = 0;
	brfifo = 0;
	ffazn = 0;

	sd = repSd;
	if (repSd<rebSd) then begin
		sd = rebSd;
	end;
	
	ed = repEd;
	
	if (repSd<rebSd) then begin
		ed = rebEd;
	end;


	IHr.FileName = "IVVc";
	IHr.ArtCode = ItemCode;
	IHr.TransDate = sd;
	IHr.SerNr = "";
	TrHs2 = true;
	vSaleQtyPrc = 0;
	iterIV = 0;
	while (loopkey("FNArtCode",IHr,4,TrHs2)) begin
		testf = true;
		if(IHr.FileName!="IVVc")then begin TrHs2 = false; end;
		if(IHr.ArtCode!=ItemCode)then begin TrHs2 = false; end;
		if(IHr.TransDate<sd)then begin TrHs2 = false; end;
		if(IHr.TransDate>ed)then begin TrHs2 = false; end;
		if(nonblank(Location) and IHr.Location!=Location)then begin testf = false; end;
		if(TrHs2 and testf)then begin
			IVr.SerNr = IHr.TransNr;
			if (ReadFirstMain(IVr,1,true)) then begin
				testf2 = true;
				if(nonblank(RepSpec.f6) and !setinset(IVr.CustCode,RepSpec.f6))then begin testf2 = true; end;
				if(nonblank(RepSpec.f8) and !setinset(RepSpec.f8,IVr.Objects))then begin testf2 = true; end;
				if(IVr.PriceList!="RRP" and IVr.PriceList!="CC" and RepSpec.flags[3]!=0) then begin testf2 = false; end;
				if(nonblank(IVrw.Location))then begin // conslocation, deflocation
					if(nonblank(location) and IHr.Location!=location and IHr.Location!=conslocation and IHr.Location!=deflocation)then begin testf2 = false; end;
				end else begin
					if(nonblank(location) and IHr.Location!=location and IHr.Location!=conslocation and IHr.Location!=deflocation)then begin testf2 = false; end;
				end;
				if (testf2) then begin
					matrowget(IVr,IHr.Row,IVrw);
					matrowget(IVr,IHr.Row,IV2rw);
					if(IVrw.vRebate!=0)then begin testf1=true; end;
					IDr.DupCode = IVrw.ArtCode;
					INr.Code = IVrw.ArtCode;
					if(RepSpec.flags[5]==1 and INr.ConsgType!=1) then begin testf1 = false; end;
					if(ReadFirstKey("DupCode",IDr,1,true) and testf1) then begin
						dupINr.Code = IDr.OrigCode;
						while(LoopMain(dupINr,1,testf2)) begin
							if(dupINr.Code!=IDr.OrigCode) then begin testf2 = false; end;
							if(dupINr.BPIBrand==IDr.OrigBrandCode and testf2) then begin
								INr.Code = IDr.OrigCode;
								DubCodes[IDr.OrigCode] = IDr.DupCode;
							end;
						end;
					end;
					readfirstmain(INr,1,true);
					testf2=true;
				
					if(RepSpec.flags[0]==1 and INr.OutOfOrder==1)then begin testf1 = false; end;
					if(nonblank(RepSpec.f2) and testf1)then begin
						testf1=SetInSet2(RepSpec.f2,INr.DispGroups);
					end;
					if(nonblank(RepSpec.f9) and !setinset(RepSpec.f9,IVrw.Objects))then begin testf1 = false; end;
					if(nonblank(RepSpec.f10) and RepSpec.f10!=IVrw.ArtCode)then begin testf1 = false; end;
					// if(testf1)then begin
						// pos = 0;
						// brand = "";
						// testf1 = false;
						// ExtractObj(INr.DispGroups,pos,brand);
						// while(nonblank(brand)) begin
							// if(userbrand[brand])then begin
								// testf1 = true;
							// end;
							// ExtractObj(INr.DispGroups,pos,brand);
						// end;
					// end;
					
					if(testf1)then begin
						cred = 1;
						if(IVr.InvType==kInvoiceTypeCredit)then begin
							cred = -1;
						end;
						rebitemf = true;
						if (RebPrc!=IVrw.vRebate) then begin rebitemf = false; end;
						if (vIVItem[IVr.SerNr & "_" & IVrw.ArtCode]) then begin rebitemf = false; end;
						if (rebitemf) then begin
							vSaleQtyPrc = vSaleQtyPrc + IVrw.Quant;
							vIVItem[IVr.SerNr & "_" & IVrw.ArtCode] = true;
							if(IVr.UpdStockFlag>0 and IVr.OrderNr<0)then begin
								updst = true;
							end else begin
								updst = false;
							end;
							
							iterIV = iterIV + 1;
							
							FindFIFOOrigValAndCurncyIV(IVr.SerNr,IHr.Row,brfifo,brandcur,ffobl,updst,addCurs,currencyBalances,additionalCurF,tmpbool);
							if(ffobl==0)then begin
								if(IVrw.FIFORowVal==0)then begin
									ffobl = IVrw.FIFORowVal;
								end else begin
									ffobl = INr.WeighedAvPrice * IVrw.Quant;
								end;
							end;
							
							brandfifo = brandfifo + brfifo;
							
							fifob1 = fifob1 + AbsoluteVal(ffobl/IVrw.Quant);
							for (j=0;j<addCurs.length;j=j+1) begin //Edit***************************Sasha2,11:46 14.09.2017 {
								currencyBalances[addCurs[j]] = AbsoluteVal(currencyBalances[addCurs[j]]/IVrw.Quant);
							end; //Edit***************************Sasha2,11:46 14.09.2017 }
							
							GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
							if(aznfr==0 or aznto==0)then begin
								aznfr = 1; aznto = 1;
							end;
							ffazn = ffobl*aznfr/aznto;
							fifoazn = fifoazn + ffobl*aznfr/aznto;
							rowbrandfifo = rowbrandfifo + brfifo*IVrw.Quant*cred;	
							rowfifoazn = rowfifoazn + ffazn*IVrw.Quant*cred;
							
							
							GetFullCurncyRate(brandcur,IVr.TransDate,fr,to1,to2,br1,br2);
							if(fr==0 or to1==0)then begin
								fr = 1; to1 = 1;
							end;
							bfr = IVr.FrRate;
							bto = IVr.ToRateB1;
							if(bfr==0 or bto==0)then begin
								bfr = 1;
								bto = 1;
							end;
							
							if(brandcur==IVr.CurncyCode)then begin
								curprice = curprice + IV2rw.Price*cred;
							end else begin
								curprice = curprice + round(IVrw.Price*fr/to1,SetRoundModeD(1))*cred;
							end;
							aznprice = aznprice + IVrw.Price*aznfr/aznto;
							
							if(brandcur==IVr.CurncyCode)then begin
								curcusm = curcusm + IV2rw.Sum*cred;
							end else begin
								curcusm = curcusm + round(IVrw.Sum*fr/to1,SetRoundModeD(1))*cred;
							end;
							aznsum = aznsum + IVrw.Sum*aznfr/aznto*cred;
						end;
					end;
				end;
			end;
		end;
	end;
	
	fifoazn = round(fifoazn/iterIV,SetRoundModeD(1));
	fifob1 = round(fifob1/iterIV,SetRoundModeD(1));
	brandfifo = round(brandfifo/iterIV,SetRoundModeD(1));
	curprice = round(curprice/iterIV,SetRoundModeD(1));
	aznprice = round(aznprice/iterIV,SetRoundModeD(1));
	
	
	resetloop(IHr);

return;
end;






procedure GetTempPriceSales (string ItemCode, date rebSd, date rebEd, date repSd, date repEd, string Location, var val vSaleQtyPrc, val RebPrc, record RcVc RepSpec, vector boolean vIVItem,
														var val fifoazn, var val fifob1, var val rowfifoazn, var val rowfifob1, var val brandfifo, var val rowbrandfifo,
														var val curprice, var val aznprice, var val curcusm, var val aznsum)
begin
		
	
	record INVc INr, dupINr;
	record IVVc IVr;
	row IVVc IVrw, IV2rw;
	longint i,j,k,x,r,INcnt,s;
	vector string 255 vItemRebObj, DubCodes, vRebObj;
	boolean rebfound, TrHs, testf, testf1, testf2, rebf, rebitemf, TrHs2, updst, additionalCurF, tmpbool;
	string 255 brand, conslocation, deflocation, brandcur, azn, bcur;
	vector string 255 vRebItems, vRebObjects, vRebFromDate, vRebToDate, vINGroup;
	array string 255 aRebs, aItems, vRebCodes, addCurs;
	vector date vRebStartDate, vRebEndDate;
	vector longint vRebcnt;
	vector boolean vItemRebInMathm, aRebFound, userbrand;
	record ItemDuplicatesVc IDr;
	integer pos;
	vector val vRebPrc, currencyBalances;
	record ItemHistVc IHr;
	val aznfr, aznto, to2, br1, br2, fr,to1, bfr, bto, brfifo, ffazn, ffob1;
	integer cred;
	record CurncyCodeVc CurncyCoder; //Edit***************************Sasha2,13:55 14.09.2017
	date sd, ed;
	longint iterIV;

	ffob1 = 0;
	fifoazn = 0;
	fifob1 = 0;
	rowfifoazn = 0;
	rowfifob1 = 0;
	brandfifo = 0;
	rowbrandfifo = 0;
	curprice = 0;
	aznprice = 0;
	curcusm = 0;
	aznsum = 0;
	brfifo = 0;
	ffazn = 0;

	sd = repSd;
	if (repSd<rebSd) then begin
		sd = rebSd;
	end;
	
	ed = repEd;
	
	if (repSd<rebSd) then begin
		ed = rebEd;
	end;


	IHr.FileName = "IVVc";
	IHr.ArtCode = ItemCode;
	IHr.TransDate = sd;
	IHr.SerNr = "";
	TrHs2 = true;
	vSaleQtyPrc = 0;
	iterIV = 0;
	while (loopkey("FNArtCode",IHr,4,TrHs2)) begin
		if (ItemCode=="4100-7128") then begin
			logtext(0,vSaleQtyPrc & " vSaleQtyPrc");
		end;
		testf = true;
		if(IHr.FileName!="IVVc")then begin TrHs2 = false; end;
		if(IHr.ArtCode!=ItemCode)then begin TrHs2 = false; end;
		if(IHr.TransDate<sd)then begin TrHs2 = false; end;
		if(IHr.TransDate>ed)then begin TrHs2 = false; end;
		if(nonblank(Location) and IHr.Location!=Location)then begin testf = false; end;
		if(TrHs2 and testf)then begin
			IVr.SerNr = IHr.TransNr;
			if (ReadFirstMain(IVr,1,true)) then begin
				matrowget(IVr,IHr.Row,IVrw);
				matrowget(IVr,IHr.Row,IV2rw);
				testf2 = true;
				if(nonblank(RepSpec.f6) and !setinset(IVr.CustCode,RepSpec.f6))then begin testf2 = true; end;
				if(nonblank(RepSpec.f8) and !setinset(RepSpec.f8,IVr.Objects))then begin testf2 = true; end;
				if(IVr.PriceList!="RRP" and IVr.PriceList!="CC" and RepSpec.flags[3]!=0) then begin testf2 = false; end;
				if(nonblank(IVrw.Location))then begin // conslocation, deflocation
					if(nonblank(Location) and IHr.Location!=Location and IHr.Location!=conslocation and IHr.Location!=deflocation)then begin testf2 = false; end;
				end else begin
					if(nonblank(Location) and IHr.Location!=Location and IHr.Location!=conslocation and IHr.Location!=deflocation)then begin testf2 = false; end;
				end;
				if (testf2) then begin
					if(RebPrc==IVrw.Price)then begin testf1=true; end;
					IDr.DupCode = IVrw.ArtCode;
					INr.Code = IVrw.ArtCode;
					if(RepSpec.flags[5]==1 and INr.ConsgType!=1) then begin testf1 = false; end;
					if(ReadFirstKey("DupCode",IDr,1,true) and testf1) then begin
						dupINr.Code = IDr.OrigCode;
						while(LoopMain(dupINr,1,testf2)) begin
							if(dupINr.Code!=IDr.OrigCode) then begin testf2 = false; end;
							if(dupINr.BPIBrand==IDr.OrigBrandCode and testf2) then begin
								INr.Code = IDr.OrigCode;
								DubCodes[IDr.OrigCode] = IDr.DupCode;
							end;
						end;
					end;
					readfirstmain(INr,1,true);
					testf2=true;
				
					if(RepSpec.flags[0]==1 and INr.OutOfOrder==1)then begin testf1 = false; end;
					if(nonblank(RepSpec.f9) and !setinset(RepSpec.f9,IVrw.Objects))then begin testf1 = false; end;
					if(nonblank(RepSpec.f10) and RepSpec.f10!=IVrw.ArtCode)then begin testf1 = false; end;
					// if(testf1)then begin
						// pos = 0;
						// brand = "";
						// testf1 = false;
						// ExtractObj(INr.DispGroups,pos,brand);
						// while(nonblank(brand)) begin
							// if(userbrand[brand])then begin
								// testf1 = true;
							// end;
							// ExtractObj(INr.DispGroups,pos,brand);
						// end;
					// end;
					
					if(testf1)then begin
						cred = 1;
						if(IVr.InvType==kInvoiceTypeCredit)then begin
							cred = -1;
						end;
						rebitemf = true;
						if (RebPrc!=IVrw.Price) then begin rebitemf = false; end;
						if (vIVItem[IVr.SerNr & "_" & IVrw.ArtCode]) then begin rebitemf = false; end;
						if (rebitemf) then begin
							vSaleQtyPrc = vSaleQtyPrc + IVrw.Quant;
							vIVItem[IVr.SerNr & "_" & IVrw.ArtCode] = true;
							if(IVr.UpdStockFlag>0 and IVr.OrderNr<0)then begin
								updst = true;
							end else begin
								updst = false;
							end;
							
							iterIV = iterIV + 1;
							
							FindFIFOOrigValAndCurncyIV(IVr.SerNr,IHr.Row,brfifo,brandcur,ffob1,updst,addCurs,currencyBalances,additionalCurF,tmpbool);
							if(ffob1==0)then begin
								if(IVrw.FIFORowVal==0)then begin
									ffob1 = IVrw.FIFORowVal;
								end else begin
									ffob1 = INr.WeighedAvPrice * IVrw.Quant;
								end;
							end;
							
							brandfifo = brandfifo + brfifo;
							
							fifob1 = fifob1 + AbsoluteVal(ffob1/IVrw.Quant);
							for (j=0;j<addCurs.length;j=j+1) begin //Edit***************************Sasha2,11:46 14.09.2017 {
								currencyBalances[addCurs[j]] = AbsoluteVal(currencyBalances[addCurs[j]]/IVrw.Quant);
							end; //Edit***************************Sasha2,11:46 14.09.2017 }
							
							GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
							if(aznfr==0 or aznto==0)then begin
								aznfr = 1; aznto = 1;
							end;
							ffazn = ffob1*aznfr/aznto;
							fifoazn = fifoazn + ffob1*aznfr/aznto;
							rowbrandfifo = rowbrandfifo + brfifo*IVrw.Quant*cred;	
							rowfifoazn = rowfifoazn + ffazn*IVrw.Quant*cred;
							
							
							GetFullCurncyRate(brandcur,IVr.TransDate,fr,to1,to2,br1,br2);
							if(fr==0 or to1==0)then begin
								fr = 1; to1 = 1;
							end;
							bfr = IVr.FrRate;
							bto = IVr.ToRateB1;
							if(bfr==0 or bto==0)then begin
								bfr = 1;
								bto = 1;
							end;
							
							if(brandcur==IVr.CurncyCode)then begin
								curprice = curprice + IV2rw.Price*cred;
							end else begin
								curprice = curprice + round(IVrw.Price*fr/to1,SetRoundModeD(1))*cred;
							end;
							aznprice = aznprice + IVrw.Price*aznfr/aznto;
							
							if(brandcur==IVr.CurncyCode)then begin
								curcusm = curcusm + IV2rw.Sum*cred;
							end else begin
								curcusm = curcusm + round(IVrw.Sum*fr/to1,SetRoundModeD(1))*cred;
							end;
							aznsum = aznsum + IVrw.Sum*aznfr/aznto*cred;
						end;
					end;
				end;
			end;
		end;
	end;
	
	fifoazn = round(fifoazn/iterIV,SetRoundModeD(1));
	fifob1 = round(fifob1/iterIV,SetRoundModeD(1));
	brandfifo = round(brandfifo/iterIV,SetRoundModeD(1));
	curprice = round(curprice/iterIV,SetRoundModeD(1));
	aznprice = round(aznprice/iterIV,SetRoundModeD(1));
	
	
	resetloop(IHr);

return;
end;










global
procedure RebSalesReportMn (record RcVc RepSpec)
begin
	record INVc INr, dupINr;
	record RebVc Rebr;
	row RebVc Rebrw;
	record MyRebVc MyRebr;
	row MyRebVc MyRebrw;
	record OnePOneRebVc OPORr;
	row OnePOneRebVc OPORrw;
	record TemporaryPricesVc TPr;
	row TemporaryPricesVc TPrw;
	record IVVc IVr;
	row IVVc IVrw, IV2rw;
	longint i,j,k,x,r,INcnt,s;
	vector string 255 vItemRebObj, DubCodes, vRebObj, vClassName, vINName, vINAlt, vINBrand, vINCollection, vINIGroup, vINSubGroup, vINCategory, vINMaterial, vINBPIColor, vINShape, vINSize, vINUse, vINSex, vINPlating, vINClarity, vINWeigh, vINCut, vINStone, vINStrap, vINOdour;
	boolean rebfound, TrHs, testf, testf1, testf2, rebf, rebitemf, TrHs2, inStockExf;
	date sd, ed;
	string 255 Location, brand, conslocation, deflocation, ItemCode;
	vector string 255 vRebItems, vRebObjects, vRebFromDate, vRebToDate, vINGroup;
	array string 255 aRebs, aItems, vRebCodes, aLocations, aConsLocations;
	vector date vRebStartDate, vRebEndDate;
	vector longint vRebcnt;
	vector boolean vItemRebInMathm, aRebFound, userbrand;
	record ItemDuplicatesVc IDr;
	integer pos, cCompany;
	vector val vRebPrc, vItemStockQty, vItemSalesStockQty, vEndItemStockQty, vConsItemStockQty, vConsEndItemStockQty;
	val vSaleQtyPrc, RebPrc,  fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo;
	val curprice, aznprice, curcusm, aznsum;
	record ItemHistVc IHr;
	record ConsItemVc CIr;
	vector boolean vIVItem, vItemStockEx;
	record LocationVc Locationr;
	area BodyAr;
	string 255 FileName;
	record BPIBrandVc BPIBrandr;
  record BPICollectionVc BPICollectionr;
  record BPIGroupVc BPIGroupr;
  record BPISubGroupVc BPISubGroupr;
  record BPICategoryVc BPICategoryr;
  record BPIMaterialVc BPIMaterialr;
  record BPIColorVc BPIColorr;
  record BPIShapeVc BPIShaper;
  record BPISizeVc BPISizer;
  record BPIUseVc BPIUser;
  record BPISexVc BPISexr;
  record BPIPlatingVc BPIPlatingr;
  record BPIClarityVc BPIClarityr;
  record BPIWeightVc BPIWeightr;
  record BPICutVc BPICutr;
  record BPIStoneVc BPIStoner;
  record BPIStrapVc BPIStrapr;
  record BPIOdourVc BPIOdourr;
	

	BPIOdourr.Code = "";
	while(loopmain(BPIOdourr,1,true))begin
		vClassName[BPIOdourr.Code] = BPIOdourr.Name;
	end;
	
	BPIStrapr.Code = "";
	while(loopmain(BPIStrapr,1,true))begin
		vClassName[BPIStrapr.Code] = BPIStrapr.Name;
	end;
	
	BPIStoner.Code = "";
	while(loopmain(BPIStoner,1,true))begin
		vClassName[BPIStoner.Code] = BPIStrapr.Name;
	end;
	
	BPICutr.Code = "";
	while(loopmain(BPICutr,1,true))begin
		vClassName[BPICutr.Code] = BPIStrapr.Name;
	end;
	
	BPIWeightr.Code = "";
	while(loopmain(BPIWeightr,1,true))begin
		vClassName[BPIWeightr.Code] = BPIStrapr.Name;
	end;
	
	BPIClarityr.Code = "";
	while(loopmain(BPIClarityr,1,true))begin
		vClassName[BPIClarityr.Code] = BPIStrapr.Name;
	end;
	
	BPIPlatingr.Code = "";
	while(loopmain(BPIPlatingr,1,true))begin
		vClassName[BPIPlatingr.Code] = BPIPlatingr.Name;
	end;
	
	BPISexr.Code = "";
	while(loopmain(BPISexr,1,true))begin
		vClassName[BPISexr.Code] = BPISexr.Name;
	end;
	
	BPIUser.Code = "";
	while(loopmain(BPIUser,1,true))begin
		vClassName[BPIUser.Code] = BPIUser.Name;
	end;
	
	BPISizer.Code = "";
	while(loopmain(BPISizer,1,true))begin
		vClassName[BPISizer.Code] = BPISizer.Name;
	end;
	
	BPIShaper.Code = "";
	while(loopmain(BPIShaper,1,true))begin
		vClassName[BPIShaper.Code] = BPIShaper.Name;
	end;
	
	
	BPIColorr.Code = "";
	while(loopmain(BPIColorr,1,true))begin
		vClassName[BPIColorr.Code] = BPIColorr.Name;
	end;
	
	BPIMaterialr.Code = "";
	while(loopmain(BPIMaterialr,1,true))begin
		vClassName[BPIMaterialr.Code] = BPIMaterialr.Name;
	end;
	
	BPICategoryr.Code = "";
	while(loopmain(BPICategoryr,1,true))begin
		vClassName[BPICategoryr.Code] = BPICategoryr.Name;
	end;
	
	BPISubGroupr.Code = "";
	while(loopmain(BPISubGroupr,1,true))begin
		vClassName[BPISubGroupr.Code] = BPISubGroupr.Name;
	end;
	
	BPIGroupr.Code = "";
	while(loopmain(BPIGroupr,1,true))begin
		vClassName[BPIGroupr.Code] = BPIGroupr.Name;
	end;
	
	BPICollectionr.Code = "";
	while(loopmain(BPICollectionr,1,true))begin
		vClassName[BPICollectionr.Code] = BPICollectionr.Name;
	end;
	
	BPIBrandr.Code = "";
	while(loopmain(BPIBrandr,1,true))begin
		vClassName[BPIBrandr.Code] = BPIBrandr.Name;
	end;
	
	



	// record RcVc RepSpec;
	sd = RepSpec.sStartDate;
	ed = RepSpec.sEndDate;
	Location = RepSpec.f1;
	
	
	
	// FileName = "AllRebateReport" & DateToString(CurrentDate,"DD.MM.YYYY") & ".txt";
	// runprogram("chmod","-R a+rw /mnt/base/RebateReports/");
	
	// logtext(0,"GlobalItemClassInStock Start");
	// if (!fileexists("/mnt/base/RebateReports/" & FileName))then begin
	// FileName = "AllRebateReport" & DateToString(CurrentDate,"DD.MM.YYYY") & ".txt";
	FileName = "SalesReportExt/AllRebateReport" & DateToString(RepSpec.sStartDate,"DD.MM.YYYY") & "_" & DateToString(RepSpec.sEndDate,"DD.MM.YYYY") & "_" & CurrentCompany & ".txt";
	logtext(0,"GlobalItemClassInStock Start");
	if (!fileexists(FileName))then begin
		AddTextToArea	("Товар" & chr(09) 																							//1
									& "Название товара" & chr(09) 																	//2
									& "Дополнительные кодировки товаров" & chr(09) 									//3
									& "Склад" & chr(09) 																						//5
									& "Бренд" & chr(09) 																						//6
									& "COLLECTION" & chr(09) 																				//8
									& "GROUP" & chr(09) 																						//9
									& "SUBGROUP" & chr(09) 																					//10
									& "CATEGORY" & chr(09) 																					//11
									& "MATERIAL" & chr(09) 																					//12
									& "COLOR" & chr(09) 																						//13
									& "SHAPE" & chr(09) 																						//14
									& "SIZE" & chr(09) 																							//15
									& "USE" & chr(09) 																					//16
									& "SEX" & chr(09) 																	//17
									& "PLATING" & chr(09)																		//18
									& "CLARITY" & chr(09)
									& "WEIGH" & chr(09)
									& "CUT" & chr(09)
									& "STONE" & chr(09)
									& "STRAP" & chr(09)
									& "ODOUR" & chr(09)
									& "Акция-название" & chr(09)
									& "Начало акции" & chr(09) 																			//19
									& "Дата окончания акции" & chr(09) 															//
									& "% скидки" & chr(09) 																					//21
									& "Количество стока на начало периода" & chr(09)								//22
									& "Количество стока на конец периода" & chr(09)									//23
									& "Количество стока в ID group на начало периода" & chr(09)			//24
									& "Количество стока в ID group на конец периода" & chr(09)			//25
									& "Количество продажи" & chr(09)
									& "Себестоимость за ед-цу в валюте Бренда" & chr(09)						//26
									& "Себестоимость за ед-цу в валюте AZN" & chr(09)								//27
									& "Сумма по себестоимости в валюте Бренда" & chr(09)						//28
									& "Сумма по себестоимости в валюте AZN" & chr(09)								//29
									& "Ритейл за ед-цу в валюте Бренда" & chr(09)										//30
									& "Ритейл за ед-цу в валюте AZN" & chr(09)											//31
									& "Сумма продажи в валюте Бренда" & chr(09)											//32
									& "Сумма продажи в валюте AZN" & chr(09)												//33
									&	chr(13),BodyAr);
									
									
								
									

	
		// setCompany(4,false);
		// sd = AddYear(CurrentDate,-1);
		// ed = CurrentDate;
		
		logtext(0,"1");
		
		Locationr.Code = "";
		x = 0;
		while (loopmain(Locationr,1,true)) begin
			aLocations[x] = Locationr.Code;
			x = x + 1;
		end;
		Resetloop(Locationr);
		cCompany = CurrentCompany;
		SetCompany(18,false);
		
		Locationr.Code = "";
		x = 0;
		while (loopmain(Locationr,1,true)) begin
			aConsLocations[x] = Locationr.Code;
			x = x + 1;
		end;
		Resetloop(Locationr);
		
		ResetCompany(cCompany);
		
		logtext(0,"2");
		
		x = 0;
		INr.Code = "";
		while (loopmain(INr,1,true)) begin
			if (INr.ConsgType==0) then begin
				aItems[x] = INr.Code;
				vINGroup[INr.Code] = INr.Group;
				vINName[INr.Code] = INr.Name;
				vINAlt[INr.Code] = INr.AlternativeCode;
				vINBrand[INr.Code] = vClassName[INr.BPIBrand];
				vINCollection[INr.Code] = vClassName[INr.BPICollection];
				vINIGroup[INr.Code] = vClassName[INr.BPIGroup];
				vINSubGroup[INr.Code] = vClassName[INr.BPISubGroup];
				vINCategory[INr.Code] = vClassName[INr.BPICategory];
				vINMaterial[INr.Code] = vClassName[INr.BPIMaterial];
				vINBPIColor[INr.Code] = vClassName[INr.BPIColor];
				vINShape[INr.Code] = vClassName[INr.BPIShape];
				vINSize[INr.Code] = vClassName[INr.BPISize];
				vINUse[INr.Code] = vClassName[INr.BPIUse];
				vINSex[INr.Code] = vClassName[INr.BPISex];
				vINPlating[INr.Code] = vClassName[INr.BPIPlating];
				vINClarity[INr.Code] = vClassName[INr.BPIClarity];
				vINWeigh[INr.Code] = vClassName[INr.BPIWeight];
				vINCut[INr.Code] = vClassName[INr.BPICut];
				vINStone[INr.Code] = vClassName[INr.BPIStone];
				vINStrap[INr.Code] = vClassName[INr.BPIStrap];
				vINOdour[INr.Code] = vClassName[INr.BPIOdour];				
				x = x + 1;
				INcnt = x;
				for (s=0;s<aLocations.length;s=s+1) begin
					IHr.ArtCode = INr.Code;
					IHr.Location = aLocations[s];
					TrHs = true;
					while(loopkey("ArtCodeLoc",IHr,2,TrHs))begin
						testf = true;
						if(IHr.ArtCode!=INr.Code or IHr.Location!=aLocations[s])then begin TrHs=false; testf = false; end;
						if(IHr.StockAffectf==0)then begin testf=false; end;
						if(testf and IHr.TransDate<=sd)then begin
							vItemStockQty[INr.Code & "::" & IHr.Location] = vItemStockQty[INr.Code & "::" & IHr.Location] + IHr.Qty;
						end;
						if(testf and IHr.TransDate<=ed)then begin
							vEndItemStockQty[INr.Code & "::" & IHr.Location] = vEndItemStockQty[INr.Code & "::" & IHr.Location] + IHr.Qty;
						end;
					end;
					resetloop(IHr);
					if (vItemStockQty[INr.Code & "::" & IHr.Location]>0) then begin
						vItemStockEx[INr.Code & "::" & IHr.Location] = true;
					end;
				end;
				
				SetCompany(18,false);
				
				x = x + 1;
				INcnt = x;
				for (s=0;s<aConsLocations.length;s=s+1) begin
					
					CIr.LocCode = INr.Code;
					CIr.BrandCode = INr.BPIBrand;								
					if (readfirstkey("LocCodeBrand",CIr,2,true)) then begin
						ItemCode = CIr.Code;
						IHr.ArtCode = ItemCode;
						IHr.Location = aConsLocations[s];
						TrHs = true;
						while(loopkey("ArtCodeLoc",IHr,2,TrHs))begin
							testf = true;
							if(IHr.ArtCode!=ItemCode or IHr.Location!=aConsLocations[s])then begin TrHs=false; testf = false; end;
							if(IHr.StockAffectf==0)then begin testf=false; end;
							if(testf and IHr.TransDate<=sd)then begin
								vConsItemStockQty[INr.Code] = vConsItemStockQty[INr.Code] + IHr.Qty;
							end;
							if(testf and IHr.TransDate<=ed)then begin
								vConsEndItemStockQty[INr.Code] = vConsEndItemStockQty[INr.Code] + IHr.Qty;
							end;
						end;
						resetloop(IHr);
					end;
				end;
				
				ResetCompany(cCompany);
			end;
		end;
		resetloop(INr);
		
		logtext(0,"3");
		
		x = 0;
		k = 0;
		MyRebr.Code = "ZZZZZZZZZZZZZZZ";
		MyRebr.ToDate = CurrentDate;
		while(LoopBackKey("ToDate",MyRebr,2,true)) begin
			clearVector(vItemRebInMathm);
			rebfound = false;
			RepSpec.f9 = MyRebr.Object;
			if (DateInRange(sd,MyRebr.FromDate,MyRebr.ToDate) and nonblank(MyRebr.Object)) then begin rebfound = true; end;
			if (DateInRange(ed,MyRebr.FromDate,MyRebr.ToDate) and nonblank(MyRebr.Object)) then begin rebfound = true; end;
			if (DateInRange(MyRebr.FromDate,sd,ed) and nonblank(MyRebr.Object)) then begin rebfound = true; end;
			if (DateInRange(MyRebr.ToDate,sd,ed) and nonblank(MyRebr.Object)) then begin rebfound = true; end;
			if (blank(MyRebr.FromDate) and nonblank(MyRebr.Object)) then begin rebfound = true; end;
			if (blank(MyRebr.ToDate) and nonblank(MyRebr.Object)) then begin rebfound = true; end;
			if (rebfound) then begin		
				logtext(0,MyRebr.Code);
				AddTextToArea	(MyRebr.Code & chr(09)
									& MyRebr.Comment & chr(09)
									& MyRebr.FromDate & chr(09) 																		//19
									& MyRebr.ToDate & chr(09) 																			
									&	chr(13),BodyAr);
				for (i=0;i<matrowcnt(MyRebr);i=i+1) begin
					matrowget(MyRebr,i,MyRebrw);
					if (MyRebrw.vra0 > 0) then begin
						if (MyRebrw.CodeType==1) then begin
							ItemCode = MyRebrw.ITCode;
							RebPrc = MyRebrw.vra0;
							inStockExf = false;
							ClearVector(vItemSalesStockQty);
							for (k=0;k<aLocations.length;k=k+1) begin
								vSaleQtyPrc = 0;
								GetRebateSales (ItemCode, MyRebr.FromDate, MyRebr.ToDate, sd, ed, aLocations[k], vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																curprice,aznprice,curcusm,aznsum);
								if (vItemStockEx[ItemCode & "::" & aLocations[k]] or vSaleQtyPrc>0) then begin	
									logtext(0,ItemCode);
										AddTextToArea	(ItemCode & chr(09) 																	//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& MyRebr.FromDate & chr(09) 																		//19
												& MyRebr.ToDate & chr(09) 																			
												& MyRebrw.vra0 & chr(09) 																				//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
									inStockExf = true;
								end;
							end;
							
							if (!inStockExf) then begin
								logtext(0,ItemCode);
								vSaleQtyPrc = 0;
								GetRebateSales (ItemCode, MyRebr.FromDate, MyRebr.ToDate, sd, ed, "", vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																curprice,aznprice,curcusm,aznsum);
								
								AddTextToArea	(ItemCode & chr(09) 																//1
									& vINName[ItemCode] & chr(09) 																	//2
									& vINAlt[ItemCode] & chr(09) 																		//3
									& aLocations[k] & chr(09) 																			//5
									& vINBrand[ItemCode] & chr(09) 																	//6
									& vINCollection[ItemCode] & chr(09) 														//8
									& vINIGroup[ItemCode] & chr(09) 																//9
									& vINSubGroup[ItemCode] & chr(09) 															//10
									& vINCategory[ItemCode] & chr(09) 															//11
									& vINMaterial[ItemCode] & chr(09) 															//12
									& vINBPIColor[ItemCode] & chr(09) 															//13
									& vINShape[ItemCode] & chr(09) 																	//14
									& vINSize[ItemCode] & chr(09) 																	//15
									& vINUse[ItemCode] & chr(09) 																		//16
									& vINSex[ItemCode] & chr(09) 																		//17
									& vINPlating[ItemCode] & chr(09)																//18
									& vINClarity[ItemCode] & chr(09)
									& vINWeigh[ItemCode] & chr(09)
									& vINCut[ItemCode] & chr(09)
									& vINStone[ItemCode] & chr(09)
									& vINStrap[ItemCode] & chr(09)
									& vINOdour[ItemCode] & chr(09)
									& MyRebr.Comment & chr(09)
									& MyRebr.FromDate & chr(09) 																		//19
									& MyRebr.ToDate & chr(09) 																			
									& MyRebrw.vra0 & chr(09) 																				//21
									& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
									& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
									& vConsItemStockQty[ItemCode] & chr(09)													//24
									& vConsEndItemStockQty[ItemCode] & chr(09)											//25
									& vSaleQtyPrc & chr(09)
									& brandfifo & chr(09)																						//26
									& fifoazn & chr(09)																							//27
									& rowbrandfifo & chr(09)																				//28
									& rowfifoazn & chr(09)																					//29
									& curprice & chr(09)																						//30
									& aznprice & chr(09)																						//31
									& curcusm & chr(09)																							//32
									& aznsum & chr(09)																							//33
									&	chr(13),BodyAr);
							end;
							
							vItemRebInMathm[ItemCode] = true;
						end;
						if (MyRebrw.CodeType==0) then begin
							for (s=0;s<INcnt;s=s+1) begin
								testf1 = true;
								if (vINGroup[aItems[s]]!=MyRebrw.ITCode) then begin testf1 = false; end;
								if (!vItemRebInMathm[aItems[s]]) then begin testf1 = false; end;
								if (testf1) then begin								
									ItemCode = aItems[s];
									vSaleQtyPrc = 0;
									RebPrc = MyRebrw.vra0;								
									inStockExf = false;
									ClearVector(vItemSalesStockQty);
									for (k=0;k<aLocations.length;k=k+1) begin
										vSaleQtyPrc = 0;
										GetRebateSales (ItemCode, MyRebr.FromDate, MyRebr.ToDate, sd, ed, aLocations[k], vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																		curprice,aznprice,curcusm,aznsum);
										if (vItemStockEx[ItemCode & "::" & aLocations[k]] or vSaleQtyPrc>0) then begin
											
											AddTextToArea	(ItemCode & chr(09) 																			//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& MyRebr.FromDate & chr(09) 																			//19
												& MyRebr.ToDate & chr(09) 																			
												& MyRebrw.vra0 & chr(09) 																					//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
											inStockExf = true;
										end;
									end;
									
									if (!inStockExf) then begin
										vSaleQtyPrc = 0;
										GetRebateSales (ItemCode, MyRebr.FromDate, MyRebr.ToDate, sd, ed, "", vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																		curprice, aznprice, curcusm ,aznsum);
										
										
										
										AddTextToArea	(ItemCode & chr(09) 																	//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& MyRebr.FromDate & chr(09) 																			//19
												& MyRebr.ToDate & chr(09) 																			
												& MyRebrw.vra0 & chr(09) 																					//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
										
									end;
								end;
							end;
						end;
					end;
				end;
			end;
		end;
		
		logtext(0,"4");
		
		x = 0;
		k = 0;
		Rebr.Code = "ZZZZZZZZZZZZZZZ";
		Rebr.ToDate = CurrentDate;
		while(LoopBackKey("ToDate",Rebr,2,true)) begin
			clearVector(vItemRebInMathm);
			rebfound = false;
			RepSpec.f9 = Rebr.Object;
			if (DateInRange(sd,Rebr.FromDate,Rebr.ToDate) and nonblank(Rebr.Object)) then begin rebfound = true; end;
			if (DateInRange(ed,Rebr.FromDate,Rebr.ToDate) and nonblank(Rebr.Object)) then begin rebfound = true; end;
			if (DateInRange(Rebr.FromDate,sd,ed) and nonblank(Rebr.Object)) then begin rebfound = true; end;
			if (DateInRange(Rebr.ToDate,sd,ed) and nonblank(Rebr.Object)) then begin rebfound = true; end;
			if (blank(Rebr.FromDate) and nonblank(Rebr.Object)) then begin rebfound = true; end;
			if (blank(Rebr.ToDate) and nonblank(Rebr.Object)) then begin rebfound = true; end;
			if (rebfound) then begin
				AddTextToArea	(Rebr.Code & chr(09)
									& Rebr.Comment & chr(09)
									& Rebr.FromDate & chr(09) 																		//19
									& Rebr.ToDate & chr(09) 																			
									&	chr(13),BodyAr);
				for (i=0;i<matrowcnt(Rebr);i=i+1) begin
					matrowget(Rebr,i,Rebrw);
					if (Rebrw.vra0 > 0) then begin
						if (Rebrw.CodeType==1) then begin
							ItemCode = Rebrw.ITCode;
							vSaleQtyPrc = 0;
							RebPrc = Rebrw.vra0;						
							inStockExf = false;
							ClearVector(vItemSalesStockQty);
							for (k=0;k<aLocations.length;k=k+1) begin
								vSaleQtyPrc = 0;
								GetRebateSales (ItemCode, Rebr.FromDate, Rebr.ToDate, sd, ed, aLocations[k], vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																curprice, aznprice, curcusm ,aznsum);
								if (vItemStockEx[ItemCode & "::" & aLocations[k]] or vSaleQtyPrc>0) then begin
								
								
									AddTextToArea	(ItemCode & chr(09) 																			//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& Rebr.FromDate & chr(09) 																			//19
												& Rebr.ToDate & chr(09) 																			
												& Rebrw.vra0 & chr(09) 																					//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
								
									inStockExf = true;
								end;
							end;
							
							if (!inStockExf) then begin
								vSaleQtyPrc = 0;
								GetRebateSales (ItemCode, Rebr.FromDate, Rebr.ToDate, sd, ed, "", vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																curprice, aznprice, curcusm ,aznsum);
								
								
								AddTextToArea	(ItemCode & chr(09) 																			//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& Rebr.FromDate & chr(09) 																			//19
												& Rebr.ToDate & chr(09) 																			
												& Rebrw.vra0 & chr(09) 																					//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
							end;
							
							vItemRebInMathm[ItemCode] = true;
						end;
						if (Rebrw.CodeType==0) then begin
							logtext(0,"b");
							for (s=0;s<INcnt;s=s+1) begin
								testf1 = true;
								if (vINGroup[aItems[s]]!=Rebrw.ITCode) then begin testf1 = false; end;
								if (!vItemRebInMathm[aItems[s]]) then begin testf1 = false; end;
								if (testf1) then begin								
									ItemCode = aItems[s];
									vSaleQtyPrc = 0;
									RebPrc = Rebrw.vra0;
									inStockExf = false;
									ClearVector(vItemSalesStockQty);
									for (k=0;k<aLocations.length;k=k+1) begin
										vSaleQtyPrc = 0;
										GetRebateSales (ItemCode, Rebr.FromDate, Rebr.ToDate, sd, ed, aLocations[k], vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																		curprice, aznprice, curcusm, aznsum);
										if (vItemStockEx[ItemCode & "::" & aLocations[k]] or vSaleQtyPrc>0) then begin
										
											
											AddTextToArea	(ItemCode & chr(09) 																//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& Rebr.FromDate & chr(09) 																			//19
												& Rebr.ToDate & chr(09) 																			
												& Rebrw.vra0 & chr(09) 																					//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
											inStockExf = true;
										end;
									end;
									
									if (!inStockExf) then begin
										vSaleQtyPrc = 0;
										GetRebateSales (ItemCode, Rebr.FromDate, Rebr.ToDate, sd, ed, "", vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																		curprice, aznprice, curcusm, aznsum);
										
										AddTextToArea	(ItemCode & chr(09) 																//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& Rebr.FromDate & chr(09) 																			//19
												& Rebr.ToDate & chr(09) 																			
												& Rebrw.vra0 & chr(09) 																					//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
									end;
									vItemRebInMathm[ItemCode] = true;
								end;
							end;
						end;
					end;
				end;
				if (Rebr.vra0 > 0) then begin
					INr.Code = "";
					while (loopmain(INr,1,true)) begin
						if (INr.ConsgType==0) then begin testf1 = true; end;
						testf1 = true;
						if (vItemRebInMathm[INr.Code]) then begin testf1 = false; end;
						if (testf1) then begin
							ItemCode = INr.Code;
							vSaleQtyPrc = 0;
							RebPrc = Rebr.vra0;
							inStockExf = false;
							ClearVector(vItemSalesStockQty);
							for (k=0;k<aLocations.length;k=k+1) begin
								vSaleQtyPrc = 0;
								GetRebateSales (ItemCode, Rebr.FromDate, Rebr.ToDate, sd, ed, aLocations[k], vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																curprice, aznprice, curcusm, aznsum);
								if (vItemStockEx[ItemCode & "::" & aLocations[k]] or vSaleQtyPrc>0) then begin
								
								
									AddTextToArea	(ItemCode & chr(09) 																		//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& Rebr.FromDate & chr(09) 																			//19
												& Rebr.ToDate & chr(09) 																			
												& Rebr.vra0 & chr(09) 																					//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
									inStockExf = true;
								end;
							end;
							
							if (!inStockExf) then begin
								vSaleQtyPrc = 0;
								GetRebateSales (ItemCode, Rebr.FromDate, Rebr.ToDate, sd, ed, "", vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
																curprice, aznprice, curcusm, aznsum);
								
								
								AddTextToArea	(ItemCode & chr(09) 																			//1
												& vINName[ItemCode] & chr(09) 																	//2
												& vINAlt[ItemCode] & chr(09) 																		//3
												& aLocations[k] & chr(09) 																			//5
												& vINBrand[ItemCode] & chr(09) 																	//6
												& vINCollection[ItemCode] & chr(09) 														//8
												& vINIGroup[ItemCode] & chr(09) 																//9
												& vINSubGroup[ItemCode] & chr(09) 															//10
												& vINCategory[ItemCode] & chr(09) 															//11
												& vINMaterial[ItemCode] & chr(09) 															//12
												& vINBPIColor[ItemCode] & chr(09) 															//13
												& vINShape[ItemCode] & chr(09) 																	//14
												& vINSize[ItemCode] & chr(09) 																	//15
												& vINUse[ItemCode] & chr(09) 																		//16
												& vINSex[ItemCode] & chr(09) 																		//17
												& vINPlating[ItemCode] & chr(09)																//18
												& vINClarity[ItemCode] & chr(09)
												& vINWeigh[ItemCode] & chr(09)
												& vINCut[ItemCode] & chr(09)
												& vINStone[ItemCode] & chr(09)
												& vINStrap[ItemCode] & chr(09)
												& vINOdour[ItemCode] & chr(09)
												& MyRebr.Comment & chr(09)
												& Rebr.FromDate & chr(09) 																			//19
												& Rebr.ToDate & chr(09) 																			
												& Rebr.vra0 & chr(09) 																					//21
												& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
												& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
												& vConsItemStockQty[ItemCode] & chr(09)													//24
												& vConsEndItemStockQty[ItemCode] & chr(09)											//25
												& vSaleQtyPrc & chr(09)
												& brandfifo & chr(09)																						//26
												& fifoazn & chr(09)																							//27
												& rowbrandfifo & chr(09)																				//28
												& rowfifoazn & chr(09)																					//29
												& curprice & chr(09)																						//30
												& aznprice & chr(09)																						//31
												& curcusm & chr(09)																							//32
												& aznsum & chr(09)																							//33
												&	chr(13),BodyAr);
							end;
						end;
					end;
					resetloop(INr);
				end;
			end;
		end;
		resetloop(Rebr);	
	end;
	
	
	
	
	
	x = 0;
	k = 0;
	TPr.SerNr = 999999999999;
	TPr.ToDate = CurrentDate;
	while(LoopBackKey("ToFromDate",TPr,2,true)) begin
		RepSpec.f9 = TPr.Object;
		clearVector(vItemRebInMathm);
		rebfound = false;
		if (blank(TPr.Comment)) then begin TPr.Comment = "Temp. price: " & TPr.SerNr; end;
		if (DateInRange(sd,TPr.FromDate,TPr.ToDate) and nonblank(TPr.Object)) then begin rebfound = true; end;
		if (DateInRange(ed,TPr.FromDate,TPr.ToDate) and nonblank(TPr.Object)) then begin rebfound = true; end;
		if (DateInRange(TPr.FromDate,sd,ed) and nonblank(TPr.Object)) then begin rebfound = true; end;
		if (DateInRange(TPr.ToDate,sd,ed) and nonblank(TPr.Object)) then begin rebfound = true; end;
		if (rebfound) then begin	
			AddTextToArea	(TPr.SerNr & chr(09)
					& TPr.Comment & chr(09)
					& TPr.FromDate & chr(09) 																		//19
					& TPr.ToDate & chr(09) 																			
					&	chr(13),BodyAr);

			for (i=0;i<matrowcnt(TPr);i=i+1) begin
				matrowget(TPr,i,TPrw);
				if (TPrw.Price > 0) then begin
					ItemCode = TPrw.ArtCode;
					RebPrc = TPrw.Price;
					inStockExf = false;
					ClearVector(vItemSalesStockQty);
					for (k=0;k<aLocations.length;k=k+1) begin
						vSaleQtyPrc = 0;
						GetTempPriceSales (ItemCode, TPr.FromDate, TPr.ToDate, sd, ed, aLocations[k], vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
														curprice,aznprice,curcusm,aznsum);
						if (vItemStockEx[ItemCode & "::" & aLocations[k]] or vSaleQtyPrc>0) then begin	
								AddTextToArea	(ItemCode & chr(09) 																	//1
										& vINName[ItemCode] & chr(09) 																	//2
										& vINAlt[ItemCode] & chr(09) 																		//3
										& aLocations[k] & chr(09) 																			//5
										& vINBrand[ItemCode] & chr(09) 																	//6
										& vINCollection[ItemCode] & chr(09) 														//8
										& vINIGroup[ItemCode] & chr(09) 																//9
										& vINSubGroup[ItemCode] & chr(09) 															//10
										& vINCategory[ItemCode] & chr(09) 															//11
										& vINMaterial[ItemCode] & chr(09) 															//12
										& vINBPIColor[ItemCode] & chr(09) 															//13
										& vINShape[ItemCode] & chr(09) 																	//14
										& vINSize[ItemCode] & chr(09) 																	//15
										& vINUse[ItemCode] & chr(09) 																		//16
										& vINSex[ItemCode] & chr(09) 																		//17
										& vINPlating[ItemCode] & chr(09)																//18
										& vINClarity[ItemCode] & chr(09)
										& vINWeigh[ItemCode] & chr(09)
										& vINCut[ItemCode] & chr(09)
										& vINStone[ItemCode] & chr(09)
										& vINStrap[ItemCode] & chr(09)
										& vINOdour[ItemCode] & chr(09)
										& TPr.Comment & chr(09)
										& TPr.FromDate & chr(09) 																		//19
										& TPr.ToDate & chr(09) 																			
										& TPrw.Price & chr(09) 																				//21
										& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
										& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
										& vConsItemStockQty[ItemCode] & chr(09)													//24
										& vConsEndItemStockQty[ItemCode] & chr(09)											//25
										& vSaleQtyPrc & chr(09)
										& brandfifo & chr(09)																						//26
										& fifoazn & chr(09)																							//27
										& rowbrandfifo & chr(09)																				//28
										& rowfifoazn & chr(09)																					//29
										& curprice & chr(09)																						//30
										& aznprice & chr(09)																						//31
										& curcusm & chr(09)																							//32
										& aznsum & chr(09)																							//33
										&	chr(13),BodyAr);
							inStockExf = true;
						end;
					end;
					
					if (!inStockExf) then begin
						vSaleQtyPrc = 0;
						GetTempPriceSales (ItemCode, TPr.FromDate, TPr.ToDate, sd, ed, "", vSaleQtyPrc, RebPrc, RepSpec, vIVItem, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
														curprice,aznprice,curcusm,aznsum);
						AddTextToArea	(ItemCode & chr(09) 																//1
							& vINName[ItemCode] & chr(09) 																	//2
							& vINAlt[ItemCode] & chr(09) 																		//3
							& aLocations[k] & chr(09) 																			//5
							& vINBrand[ItemCode] & chr(09) 																	//6
							& vINCollection[ItemCode] & chr(09) 														//8
							& vINIGroup[ItemCode] & chr(09) 																//9
							& vINSubGroup[ItemCode] & chr(09) 															//10
							& vINCategory[ItemCode] & chr(09) 															//11
							& vINMaterial[ItemCode] & chr(09) 															//12
							& vINBPIColor[ItemCode] & chr(09) 															//13
							& vINShape[ItemCode] & chr(09) 																	//14
							& vINSize[ItemCode] & chr(09) 																	//15
							& vINUse[ItemCode] & chr(09) 																		//16
							& vINSex[ItemCode] & chr(09) 																		//17
							& vINPlating[ItemCode] & chr(09)																//18
							& vINClarity[ItemCode] & chr(09)
							& vINWeigh[ItemCode] & chr(09)
							& vINCut[ItemCode] & chr(09)
							& vINStone[ItemCode] & chr(09)
							& vINStrap[ItemCode] & chr(09)
							& vINOdour[ItemCode] & chr(09)
							& TPr.Comment & chr(09)
							& TPr.FromDate & chr(09) 																		//19
							& TPr.ToDate & chr(09) 																			
							& TPrw.Price & chr(09) 																				//21
							& vItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)			//22
							& vEndItemStockQty[ItemCode & "::" & aLocations[k]] & chr(09)		//23
							& vConsItemStockQty[ItemCode] & chr(09)													//24
							& vConsEndItemStockQty[ItemCode] & chr(09)											//25
							& vSaleQtyPrc & chr(09)
							& brandfifo & chr(09)																						//26
							& fifoazn & chr(09)																							//27
							& rowbrandfifo & chr(09)																				//28
							& rowfifoazn & chr(09)																					//29
							& curprice & chr(09)																						//30
							& aznprice & chr(09)																						//31
							& curcusm & chr(09)																							//32
							& aznsum & chr(09)																							//33
							&	chr(13),BodyAr);
					end;
					
					vItemRebInMathm[ItemCode] = true;
				end;
			end;
		end;
	end;
	
	
	
	
	// WriteAreaToFile	(BodyAr,"/mnt/base/GlobalItemReports/" & FileName,0);
	WriteAreaToFile	(BodyAr,FileName,0);
	endjob;
	return;
end;







procedure GetPrice (string ItemCode, date repSd, date repEd, string Location, var val vSaleQtyPrc, record RcVc RepSpec,
														var val fifoazn, var val fifob1, var val rowfifoazn, var val rowfifob1, var val brandfifo, var val rowbrandfifo,
														var val curprice, var val aznprice, var val curcusm, var val aznsum)
begin
		
	
	record INVc INr, dupINr;
	record IVVc IVr;
	row IVVc IVrw, IV2rw;
	longint i,j,k,x,r,INcnt,s;
	vector string 255 vItemRebObj, DubCodes, vRebObj;
	boolean rebfound, TrHs, testf, testf1, testf2, rebf, rebitemf, TrHs2, updst, additionalCurF, tmpbool;
	string 255 brand, conslocation, deflocation, brandcur, azn, bcur;
	vector string 255 vRebItems, vRebObjects, vRebFromDate, vRebToDate, vINGroup;
	array string 255 aRebs, aItems, vRebCodes, addCurs;
	vector date vRebStartDate, vRebEndDate;
	vector longint vRebcnt;
	vector boolean vItemRebInMathm, aRebFound, userbrand;
	record ItemDuplicatesVc IDr;
	integer pos;
	vector val vRebPrc, currencyBalances;
	record ItemHistVc IHr;
	val aznfr, aznto, to2, br1, br2, fr,to1, bfr, bto, brfifo, ffazn, ffob1;
	integer cred;
	record CurncyCodeVc CurncyCoder; //Edit***************************Sasha2,13:55 14.09.2017
	date sd, ed;
	longint iterIV;

	ffob1 = 0;
	fifoazn = 0;
	fifob1 = 0;
	rowfifoazn = 0;
	rowfifob1 = 0;
	brandfifo = 0;
	rowbrandfifo = 0;
	curprice = 0;
	aznprice = 0;
	curcusm = 0;
	aznsum = 0;
	brfifo = 0;
	ffazn = 0;

	sd = repSd;
	
	
	ed = repEd;


	IHr.FileName = "IVVc";
	IHr.ArtCode = ItemCode;
	IHr.TransDate = sd;
	IHr.SerNr = "";
	TrHs2 = true;
	vSaleQtyPrc = 0;
	iterIV = 0;
	while (loopkey("FNArtCode",IHr,4,TrHs2)) begin
		testf = true;
		if(IHr.FileName!="IVVc")then begin TrHs2 = false; end;
		if(IHr.ArtCode!=ItemCode)then begin TrHs2 = false; end;
		if(IHr.TransDate<sd)then begin TrHs2 = false; end;
		if(IHr.TransDate>ed)then begin TrHs2 = false; end;
		if(nonblank(Location) and IHr.Location!=Location)then begin testf = false; end;
		if(TrHs2 and testf)then begin
			IVr.SerNr = IHr.TransNr;
			if (ReadFirstMain(IVr,1,true)) then begin
				matrowget(IVr,IHr.Row,IVrw);
				matrowget(IVr,IHr.Row,IV2rw);
				testf2 = true;
				if(nonblank(RepSpec.f6) and !setinset(IVr.CustCode,RepSpec.f6))then begin testf2 = true; end;
				if(nonblank(RepSpec.f8) and !setinset(RepSpec.f8,IVr.Objects))then begin testf2 = true; end;
				if(IVr.PriceList!="RRP" and IVr.PriceList!="CC" and RepSpec.flags[3]!=0) then begin testf2 = false; end;
				if(nonblank(IVrw.Location))then begin // conslocation, deflocation
					if(nonblank(Location) and IHr.Location!=Location and IHr.Location!=conslocation and IHr.Location!=deflocation)then begin testf2 = false; end;
				end else begin
					if(nonblank(Location) and IHr.Location!=Location and IHr.Location!=conslocation and IHr.Location!=deflocation)then begin testf2 = false; end;
				end;
				if (testf2) then begin
					testf1 = true;
					IDr.DupCode = IVrw.ArtCode;
					INr.Code = IVrw.ArtCode;
					readfirstmain(INr,1,true);
					if(RepSpec.flags[5]==1 and INr.ConsgType!=1) then begin testf1 = false; end;
					// if(ReadFirstKey("DupCode",IDr,1,true) and testf1) then begin
						// dupINr.Code = IDr.OrigCode;
						// while(LoopMain(dupINr,1,testf2)) begin
							// if(dupINr.Code!=IDr.OrigCode) then begin testf2 = false; end;
							// if(dupINr.BPIBrand==IDr.OrigBrandCode and testf2) then begin
								// INr.Code = IDr.OrigCode;
								// DubCodes[IDr.OrigCode] = IDr.DupCode;
							// end;
						// end;
					// end;
					testf2=true;
					if(RepSpec.flags[0]==1 and INr.OutOfOrder==1)then begin testf1 = false; end;
					// if(nonblank(RepSpec.f9) and !setinset(RepSpec.f9,IVrw.Objects))then begin testf1 = false; end;
					if(nonblank(RepSpec.f10) and RepSpec.f10!=IVrw.ArtCode)then begin testf1 = false; end;
					// if(testf1)then begin
						// pos = 0;
						// brand = "";
						// testf1 = false;
						// ExtractObj(INr.DispGroups,pos,brand);
						// while(nonblank(brand)) begin
							// if(userbrand[brand])then begin
								// testf1 = true;
							// end;
							// ExtractObj(INr.DispGroups,pos,brand);
						// end;
					// end;
					
					if(testf1)then begin
						cred = 1;
						if(IVr.InvType==kInvoiceTypeCredit)then begin
							cred = -1;
						end;
						rebitemf = true;
						if (rebitemf) then begin
							vSaleQtyPrc = vSaleQtyPrc + IVrw.Quant;
							if(IVr.UpdStockFlag>0 and IVr.OrderNr<0)then begin
								updst = true;
							end else begin
								updst = false;
							end;
							
							iterIV = iterIV + 1;
							
							FindFIFOOrigValAndCurncyIV(IVr.SerNr,IHr.Row,brfifo,brandcur,ffob1,updst,addCurs,currencyBalances,additionalCurF,tmpbool);
							if(ffob1==0)then begin
								if(IVrw.FIFORowVal==0)then begin
									ffob1 = IVrw.FIFORowVal;
								end else begin
									ffob1 = INr.WeighedAvPrice * IVrw.Quant;
								end;
							end;
							
							brandfifo = brandfifo + brfifo;
							
							fifob1 = fifob1 + AbsoluteVal(ffob1/IVrw.Quant);
							for (j=0;j<addCurs.length;j=j+1) begin //Edit***************************Sasha2,11:46 14.09.2017 {
								currencyBalances[addCurs[j]] = AbsoluteVal(currencyBalances[addCurs[j]]/IVrw.Quant);
							end; //Edit***************************Sasha2,11:46 14.09.2017 }
							
							GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
							if(aznfr==0 or aznto==0)then begin
								aznfr = 1; aznto = 1;
							end;
							ffazn = ffob1*aznfr/aznto;
							fifoazn = fifoazn + ffob1*aznfr/aznto;
							rowbrandfifo = rowbrandfifo + brfifo*IVrw.Quant*cred;	
							rowfifoazn = rowfifoazn + ffazn*IVrw.Quant*cred;
							
							
							GetFullCurncyRate(brandcur,IVr.TransDate,fr,to1,to2,br1,br2);
							if(fr==0 or to1==0)then begin
								fr = 1; to1 = 1;
							end;
							bfr = IVr.FrRate;
							bto = IVr.ToRateB1;
							if(bfr==0 or bto==0)then begin
								bfr = 1;
								bto = 1;
							end;
							
							if(brandcur==IVr.CurncyCode)then begin
								curprice = curprice + IV2rw.Price*cred;
							end else begin
								curprice = curprice + round(IVrw.Price*fr/to1,SetRoundModeD(1))*cred;
							end;
							aznprice = aznprice + IVrw.Price*aznfr/aznto;
							
							if(brandcur==IVr.CurncyCode)then begin
								curcusm = curcusm + IV2rw.Sum*cred;
							end else begin
								curcusm = curcusm + round(IVrw.Sum*fr/to1,SetRoundModeD(1))*cred;
							end;
							aznsum = aznsum + IVrw.Sum*aznfr/aznto*cred;
						end;
					end;
				end;
			end;
		end;
	end;
	
	fifoazn = round(fifoazn/iterIV,SetRoundModeD(1));
	fifob1 = round(fifob1/iterIV,SetRoundModeD(1));
	brandfifo = round(brandfifo/iterIV,SetRoundModeD(1));
	curprice = round(curprice/iterIV,SetRoundModeD(1));
	aznprice = round(aznprice/iterIV,SetRoundModeD(1));
	
	
	resetloop(IHr);

return;
end;








global
procedure ItemSaldReportMn (record RcVc RepSpec)
begin
	record INVc INr, dupINr;
	record RebVc Rebr;
	row RebVc Rebrw;
	record MyRebVc MyRebr;
	row MyRebVc MyRebrw;
	record OnePOneRebVc OPORr;
	row OnePOneRebVc OPORrw;
	record TemporaryPricesVc TPr;
	row TemporaryPricesVc TPrw;
	record IVVc IVr;
	row IVVc IVrw, IV2rw;
	longint i,j,k,x,r,INcnt,s;
	vector string 255 vItemRebObj, DubCodes, vRebObj, vClassName, vINName, vINAlt, vINBrand, vINCollection, vINIGroup, vINSubGroup, vINCategory, vINMaterial, vINBPIColor, vINShape, vINSize, vINUse, vINSex, vINPlating, vINClarity, vINWeigh, vINCut, vINStone, vINStrap, vINOdour;
	boolean rebfound, TrHs, testf, testf1, testf2, rebf, rebitemf, TrHs2, inStockExf, ItemStockEx;
	date sd, ed;
	string 255 Location, brand, conslocation, deflocation, ItemCode;
	vector string 255 vRebItems, vRebObjects, vRebFromDate, vRebToDate, vINGroup;
	array string 255 aRebs, aItems, vRebCodes, aLocations, aConsLocations;
	vector date vRebStartDate, vRebEndDate;
	vector longint vRebcnt;
	vector boolean vItemRebInMathm, aRebFound, userbrand;
	record ItemDuplicatesVc IDr;
	integer pos, cCompany;
	val vSaleQtyPrc, RebPrc,  fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo, ItemStockQty, EndItemStockQty, ItemStockFIFO;
	val curprice, aznprice, curcusm, aznsum, halt, ItemsQty;
	record ItemHistVc IHr;
	record ConsItemVc CIr;
	vector boolean vIVItem;
	record LocationVc Locationr;
	area BodyAr;
	string 255 FileName;
	record BPIBrandVc BPIBrandr;
  record BPICollectionVc BPICollectionr;
  record BPIGroupVc BPIGroupr;
  record BPISubGroupVc BPISubGroupr;
  record BPICategoryVc BPICategoryr;
  record BPIMaterialVc BPIMaterialr;
  record BPIColorVc BPIColorr;
  record BPIShapeVc BPIShaper;
  record BPISizeVc BPISizer;
  record BPIUseVc BPIUser;
  record BPISexVc BPISexr;
  record BPIPlatingVc BPIPlatingr;
  record BPIClarityVc BPIClarityr;
  record BPIWeightVc BPIWeightr;
  record BPICutVc BPICutr;
  record BPIStoneVc BPIStoner;
  record BPIStrapVc BPIStrapr;
  record BPIOdourVc BPIOdourr;
	record ItemStatusVc ISr;

	BPIOdourr.Code = "";
	while(loopmain(BPIOdourr,1,true))begin
		vClassName[BPIOdourr.Code] = BPIOdourr.Name;
	end;
	BPIStrapr.Code = "";
	while(loopmain(BPIStrapr,1,true))begin
		vClassName[BPIStrapr.Code] = BPIStrapr.Name;
	end;
	BPIStoner.Code = "";
	while(loopmain(BPIStoner,1,true))begin
		vClassName[BPIStoner.Code] = BPIStrapr.Name;
	end;
	BPICutr.Code = "";
	while(loopmain(BPICutr,1,true))begin
		vClassName[BPICutr.Code] = BPIStrapr.Name;
	end;
	BPIWeightr.Code = "";
	while(loopmain(BPIWeightr,1,true))begin
		vClassName[BPIWeightr.Code] = BPIStrapr.Name;
	end;
	BPIClarityr.Code = "";
	while(loopmain(BPIClarityr,1,true))begin
		vClassName[BPIClarityr.Code] = BPIStrapr.Name;
	end;
	BPIPlatingr.Code = "";
	while(loopmain(BPIPlatingr,1,true))begin
		vClassName[BPIPlatingr.Code] = BPIPlatingr.Name;
	end;
	BPISexr.Code = "";
	while(loopmain(BPISexr,1,true))begin
		vClassName[BPISexr.Code] = BPISexr.Name;
	end;
	BPIUser.Code = "";
	while(loopmain(BPIUser,1,true))begin
		vClassName[BPIUser.Code] = BPIUser.Name;
	end;
	BPISizer.Code = "";
	while(loopmain(BPISizer,1,true))begin
		vClassName[BPISizer.Code] = BPISizer.Name;
	end;
	BPIShaper.Code = "";
	while(loopmain(BPIShaper,1,true))begin
		vClassName[BPIShaper.Code] = BPIShaper.Name;
	end;
	BPIColorr.Code = "";
	while(loopmain(BPIColorr,1,true))begin
		vClassName[BPIColorr.Code] = BPIColorr.Name;
	end;
	BPIMaterialr.Code = "";
	while(loopmain(BPIMaterialr,1,true))begin
		vClassName[BPIMaterialr.Code] = BPIMaterialr.Name;
	end;
	BPICategoryr.Code = "";
	while(loopmain(BPICategoryr,1,true))begin
		vClassName[BPICategoryr.Code] = BPICategoryr.Name;
	end;
	BPISubGroupr.Code = "";
	while(loopmain(BPISubGroupr,1,true))begin
		vClassName[BPISubGroupr.Code] = BPISubGroupr.Name;
	end;
	BPIGroupr.Code = "";
	while(loopmain(BPIGroupr,1,true))begin
		vClassName[BPIGroupr.Code] = BPIGroupr.Name;
	end;
	BPICollectionr.Code = "";
	while(loopmain(BPICollectionr,1,true))begin
		vClassName[BPICollectionr.Code] = BPICollectionr.Name;
	end;
	BPIBrandr.Code = "";
	while(loopmain(BPIBrandr,1,true))begin
		vClassName[BPIBrandr.Code] = BPIBrandr.Name;
	end;
	
	
	// record RcVc RepSpec;
	sd = RepSpec.sStartDate;
	ed = RepSpec.sEndDate;
	Location = RepSpec.f1;
	
	// FileName = "AllRebateReport" & DateToString(CurrentDate,"DD.MM.YYYY") & ".txt";
	// runprogram("chmod","-R a+rw /mnt/base/RebateReports/");
	
	// logtext(0,"GlobalItemClassInStock Start");
	// if (!fileexists("/mnt/base/RebateReports/" & FileName))then begin
	// FileName = "ItemSaldReport" & DateToString(CurrentDate,"DD.MM.YYYY") & ".txt";
	FileName = "SalesReportExt/" & CurrentCompany & "_ItemSaldoReport_" & DateToString(RepSpec.sStartDate,"DD.MM.YYYY") & "_" & DateToString(RepSpec.sEndDate,"DD.MM.YYYY") & ".txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		AddTextToArea	("Товар" & chr(09) 																							//1
									& "Название товара" & chr(09) 																	//2
									& "Дополнительные кодировки товаров" & chr(09) 									//3
									& "Склад" & chr(09) 																						//5
									& "Бренд" & chr(09) 																						//6
									& "COLLECTION" & chr(09) 																				//8
									& "GROUP" & chr(09) 																						//9
									& "SUBGROUP" & chr(09) 																					//10
									& "CATEGORY" & chr(09) 																					//11
									& "MATERIAL" & chr(09) 																					//12
									& "COLOR" & chr(09) 																						//13
									& "SHAPE" & chr(09) 																						//14
									& "SIZE" & chr(09) 																							//15
									& "USE" & chr(09) 																							//16
									& "SEX" & chr(09) 																							//17
									& "PLATING" & chr(09)																						//18
									& "CLARITY" & chr(09)
									& "WEIGH" & chr(09)
									& "CUT" & chr(09)
									& "STONE" & chr(09)
									& "STRAP" & chr(09)
									& "ODOUR" & chr(09)
									& "Себестоимость за ед-цу в валюте AZN" & chr(09)								//27
									& "Ритейл за ед-цу в валюте AZN" & chr(09)											//31
									& "Количество стока на начало периода" & chr(09)								//22
									& "Сумма по себестоимости в валюте AZN" & chr(09)								//29
									& "Количество стока на конец периода" & chr(09)									//23
									& "Сумма по себестоимости в валюте AZN" & chr(09)	
									& "Дата окончания периода" & chr(09)											//29
									&	chr(13),BodyAr);
		// setCompany(4,false);
		// sd = AddYear(CurrentDate,-1);
		// ed = CurrentDate;
		
		logtext(0,"1");
		
		Locationr.Code = "";
		x = 0;
		while (loopmain(Locationr,1,true)) begin
			aLocations[x] = Locationr.Code;
			x = x + 1;
		end;
		Resetloop(Locationr);
		
		
		logtext(0,"2");
		// s = 0;
		INr.Code = "";
		TrHs2 = true;
		while (loopmain(INr,1,TrHs2)) begin
		
		
			if (INr.ConsgType==0) then begin testf1 = true; end;
			// if (s>1000) then begin testf1 = false; TrHs2 = false; end;
			// logtext(0,s);
			testf1 = true;
			if (testf1) then begin
				ItemCode = INr.Code;
				vSaleQtyPrc = 0;
				RebPrc = Rebr.vra0;
				inStockExf = false;
				
				for (k=0;k<aLocations.length;k=k+1) begin
					ItemStockQty = 0;
					EndItemStockQty = 0;
					ItemStockFIFO = 0;
					ItemStockEx = false;
					ItemsQty = 0;
		
					vSaleQtyPrc = 0;
					IHr.ArtCode = INr.Code;
					IHr.Location = aLocations[k];
					IHr.TransDate = sd;
					TrHs = true;
					halt = 0;
					while(loopkey("ArtCodeLoc",IHr,3,TrHs))begin
						testf = true;
						if(IHr.ArtCode!=ItemCode or IHr.Location!=aLocations[k])then begin TrHs=false; testf = false; end;
						if(IHr.StockAffectf==0)then begin testf=false; end;
						if(testf and IHr.TransDate>=sd)then begin
							ItemStockQty = ItemStockQty + IHr.Qty;
						end;
						if(testf and IHr.TransDate>=ed)then begin
							EndItemStockQty = EndItemStockQty + IHr.Qty;
						end;
					end;
					resetloop(IHr);
					ISr.Code = INr.Code;
					ISr.Location = aLocations[k];
					if (ReadFirstMain(ISr,2,true)) then begin
						ItemStockQty = ISr.Instock - ItemStockQty;
						EndItemStockQty = ISr.Instock - EndItemStockQty;
					end else begin
						ItemStockQty = 0 - ItemStockQty;
						EndItemStockQty = 0 - EndItemStockQty;
					end;
					
					if (ItemStockQty>EndItemStockQty) then begin
						ItemsQty = ItemStockQty;
					end else begin
						ItemsQty = EndItemStockQty;
					end;
					if (ItemsQty>0) then begin
						IHr.ArtCode = INr.Code;
						IHr.Location = aLocations[k];
						IHr.TransDate = ed;
						if (EndItemStockQty==0 and ItemStockQty > 0) then begin IHr.TransDate = sd; end;
						TrHs = true;
						halt = 0;
						while(loopBackkey("ArtCodeLoc",IHr,3,TrHs))begin
							testf = true;
							if(IHr.ArtCode!=ItemCode or IHr.Location!=aLocations[k])then begin TrHs=false; testf=false; end;
							if(IHr.StockAffectf==0)then begin testf=false; end;
							if (IHr.TransDate<=ed and testf) then begin
								halt = halt + IHr.Qty;
								if (IHr.Qty>0) then begin
									ItemStockFIFO = ItemStockFIFO + IHr.TotCostPrice;
								end else begin
									ItemStockFIFO = ItemStockFIFO - IHr.TotCostPrice;
								end;
								if (halt==ItemsQty) then begin
									TrHs = false;
								end;
							end;
						end;
						
						if (ItemStockQty>0 or EndItemStockQty>0) then begin
							ItemStockEx = true;
						end;
						ItemStockFIFO = ItemStockFIFO / halt;					
						resetloop(IHr);
						
						
						if (ItemStockEx) then begin	
							// s = s + 1;
							GetPrice (ItemCode, sd, ed, aLocations[k], vSaleQtyPrc, RepSpec, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
														curprice, aznprice, curcusm, aznsum);					
							AddTextToArea	(ItemCode & chr(09) 																						//1
										& INr.Name & chr(09) 																										//2
										& INr.AlternativeCode & chr(09) 																				//3
										& aLocations[k] & chr(09) 																							//5
										& vClassName[INr.BPIBrand] & chr(09) 																		//6
										& vClassName[INr.BPICollection] & chr(09) 															//8
										& vClassName[INr.BPIGroup] & chr(09) 																		//9
										& vClassName[INr.BPISubGroup] & chr(09) 																//10
										& vClassName[INr.BPICategory] & chr(09) 																//11
										& vClassName[INr.BPIMaterial] & chr(09) 																//12
										& vClassName[INr.BPIColor] & chr(09) 																		//13
										& vClassName[INr.BPIShape] & chr(09) 																		//14
										& vClassName[INr.BPISize] & chr(09) 																		//15
										& vClassName[INr.BPIUse] & chr(09) 																			//16
										& vClassName[INr.BPISex] & chr(09) 																			//17
										& vClassName[INr.BPIPlating] & chr(09)																	//18
										& vClassName[INr.BPIClarity] & chr(09)
										& vClassName[INr.BPIWeight] & chr(09)
										& vClassName[INr.BPICut] & chr(09)
										& vClassName[INr.BPIStone] & chr(09)
										& vClassName[INr.BPIStrap] & chr(09)
										& vClassName[INr.BPIOdour] & chr(09)
										& ItemStockFIFO & chr(09)																								//27
										& aznprice & chr(09)																										//31
										& ItemStockQty & chr(09)																								//22
										& ItemStockQty * ItemStockFIFO & chr(09)																//29
										& EndItemStockQty & chr(09)																							//23
										& EndItemStockQty * ItemStockFIFO & chr(09)
										& ed & chr(09)										//23
										&	chr(13),BodyAr);
						end;
					end;
				end;
			end;
		end;
		logtext(0,"3");
		WriteAreaToFile	(BodyAr,FileName,0);
		resetloop(INr);
	end;
	endjob;
	return;
end;








global
procedure ItemSaldReportPartsMn (record RcVc RepSpec)
begin
	record INVc INr, dupINr;
	record RebVc Rebr;
	row RebVc Rebrw;
	record MyRebVc MyRebr;
	row MyRebVc MyRebrw;
	record OnePOneRebVc OPORr;
	row OnePOneRebVc OPORrw;
	record TemporaryPricesVc TPr;
	row TemporaryPricesVc TPrw;
	record IVVc IVr;
	row IVVc IVrw, IV2rw;
	longint i,j,k,x,r,INcnt,s;
	vector string 255 vItemRebObj, DubCodes, vRebObj, vClassName, vINName, vINAlt, vINBrand, vINCollection, vINIGroup, vINSubGroup, vINCategory, vINMaterial, vINBPIColor, vINShape, vINSize, vINUse, vINSex, vINPlating, vINClarity, vINWeigh, vINCut, vINStone, vINStrap, vINOdour;
	boolean rebfound, TrHs, testf, testf1, testf2, rebf, rebitemf, TrHs2, inStockExf, ItemStockEx;
	date sd, ed;
	string 255 Location, brand, conslocation, deflocation, ItemCode;
	vector string 255 vRebItems, vRebObjects, vRebFromDate, vRebToDate, vINGroup;
	array string 255 aRebs, aItems, vRebCodes, aLocations, aConsLocations;
	vector date vRebStartDate, vRebEndDate;
	vector longint vRebcnt;
	vector boolean vItemRebInMathm, aRebFound, userbrand;
	record ItemDuplicatesVc IDr;
	integer pos, cCompany;
	val vSaleQtyPrc, RebPrc,  fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo, ItemStockQty, EndItemStockQty, ItemStockFIFO, ItemStockPartsQty;
	val curprice, aznprice, curcusm, aznsum, halt, ItemsQty, partscnt;
	record ItemHistVc IHr;
	record ConsItemVc CIr;
	vector boolean vIVItem;
	record LocationVc Locationr;
	area BodyAr;
	string 255 FileName;
	record BPIBrandVc BPIBrandr;
	array date aPUPartsDates;
	array val aPUPartsQty;
	record ItemStatusVc ISr;
	

	BPIBrandr.Code = "";
	while(loopmain(BPIBrandr,1,true))begin
		vClassName[BPIBrandr.Code] = BPIBrandr.Name;
	end;
	
	
	// record RcVc RepSpec;
	sd = RepSpec.sStartDate;
	ed = RepSpec.sEndDate;
	Location = RepSpec.f1;
	
	// FileName = "AllRebateReport" & DateToString(CurrentDate,"DD.MM.YYYY") & ".txt";
	// runprogram("chmod","-R a+rw /mnt/base/RebateReports/");
	
	// logtext(0,"GlobalItemClassInStock Start");
	// if (!fileexists("/mnt/base/RebateReports/" & FileName))then begin
	// FileName = "ItemSaldReport" & DateToString(CurrentDate,"DD.MM.YYYY") & ".txt";
	FileName = "SalesReportExt/" & CurrentCompany & "_ItemSaldoReport_" & DateToString(RepSpec.sStartDate,"DD.MM.YYYY") & "_" & DateToString(RepSpec.sEndDate,"DD.MM.YYYY") & ".txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		AddTextToArea	("Товар" & chr(09) 																							//1
									& "Название товара" & chr(09) 																	//2
									& "Дополнительные кодировки товаров" & chr(09) 									//3
									& "Склад" & chr(09) 																						//5
									& "Бренд" & chr(09) 																						//6
									& "Себестоимость за ед-цу в валюте AZN" & chr(09)								//27
									& "Ритейл за ед-цу в валюте AZN" & chr(09)											//31
									& "Количество стока на начало периода" & chr(09)								//22
									& "Сумма по себестоимости в валюте AZN" & chr(09)								//29
									& "Количество стока на конец периода" & chr(09)									//23
									& "Сумма по себестоимости в валюте AZN" & chr(09)	
									& "Дата окончания периода" & chr(09)											//29
									&	chr(13),BodyAr);
		// setCompany(4,false);
		// sd = AddYear(CurrentDate,-1);
		// ed = CurrentDate;
		
		logtext(0,"1");
		
		Locationr.Code = "";
		x = 0;
		while (loopmain(Locationr,1,true)) begin
			aLocations[x] = Locationr.Code;
			x = x + 1;
		end;
		Resetloop(Locationr);
		
		
		logtext(0,"2");
		// s = 0;
		INr.Code = "";
		TrHs2 = true;
		while (loopmain(INr,1,TrHs2)) begin
		
		
			if (INr.ConsgType==0) then begin testf1 = true; end;
			// if (s>1000) then begin testf1 = false; TrHs2 = false; end;
			// logtext(0,s);
			testf1 = true;
			if (testf1) then begin
				ItemCode = INr.Code;
				vSaleQtyPrc = 0;
				RebPrc = Rebr.vra0;
				inStockExf = false;
				
				for (k=0;k<aLocations.length;k=k+1) begin
					ItemStockQty = 0;
					EndItemStockQty = 0;
					ItemStockFIFO = 0;
					ItemStockEx = false;
					ItemsQty = 0;
		
					vSaleQtyPrc = 0;
					IHr.ArtCode = INr.Code;
					IHr.Location = aLocations[k];
					IHr.TransDate = sd;
					TrHs = true;
					halt = 0;
					while(loopkey("ArtCodeLoc",IHr,3,TrHs))begin
						testf = true;
						if(IHr.ArtCode!=ItemCode or IHr.Location!=aLocations[k])then begin TrHs=false; testf = false; end;
						if(IHr.StockAffectf==0)then begin testf=false; end;
						if(testf and IHr.TransDate>=sd)then begin
							ItemStockQty = ItemStockQty + IHr.Qty;
						end;
						if(testf and IHr.TransDate>=ed)then begin
							EndItemStockQty = EndItemStockQty + IHr.Qty;
						end;
					end;
					resetloop(IHr);
					ISr.Code = INr.Code;
					ISr.Location = aLocations[k];
					if (ReadFirstMain(ISr,2,true)) then begin
						ItemStockQty = ISr.Instock - ItemStockQty;
						EndItemStockQty = ISr.Instock - EndItemStockQty;
					end else begin
						ItemStockQty = 0 - ItemStockQty;
						EndItemStockQty = 0 - EndItemStockQty;
					end;
					ClearArray(aPUPartsDates);
					ClearArray(aPUPartsQty);
					ItemStockPartsQty = 0;
					IHr.ArtCode = INr.Code;
					IHr.Location = aLocations[k];
					IHr.TransDate = ed;
					TrHs = true;
					partscnt = 0;
					while(loopbackkey("ArtCodeLoc",IHr,3,TrHs))begin
						testf = true;
						if (ItemStockPartsQty>=EndItemStockQty) then begin TrHs = false; testf = false; end;
						if(IHr.ArtCode!=ItemCode or IHr.Location!=aLocations[k])then begin TrHs=false; testf = false; end;
						if(IHr.StockAffectf==0)then begin testf=false; end;
						if(IHr.FileName!="PUVc")then begin testf=false; end;
						if(testf and IHr.TransDate<=ed)then begin
							ItemStockPartsQty = ItemStockPartsQty + IHr.Qty;
							aPUPartsDates[partscnt] = IHr.TransDate;
							aPUPartsQty[partscnt] = IHr.Qty;
							if (ItemStockPartsQty > EndItemStockQty) then begin
								aPUPartsQty[partscnt] = aPUPartsQty[partscnt] - (ItemStockPartsQty - EndItemStockQty);
							end;
							partscnt = partscnt + 1;
						end;
					end;
					resetloop(IHr);
					
					if (ItemStockQty>EndItemStockQty) then begin
						ItemsQty = ItemStockQty;
					end else begin
						ItemsQty = EndItemStockQty;
					end;
					if (ItemsQty>0) then begin
						IHr.ArtCode = INr.Code;
						IHr.Location = aLocations[k];
						IHr.TransDate = ed;
						if (EndItemStockQty==0 and ItemStockQty > 0) then begin IHr.TransDate = sd; end;
						TrHs = true;
						halt = 0;
						while(loopBackkey("ArtCodeLoc",IHr,3,TrHs))begin
							testf = true;
							if(IHr.ArtCode!=ItemCode or IHr.Location!=aLocations[k])then begin TrHs=false; testf=false; end;
							if(IHr.StockAffectf==0)then begin testf=false; end;
							if (IHr.TransDate<=ed and testf) then begin
								halt = halt + IHr.Qty;
								if (IHr.Qty>0) then begin
									ItemStockFIFO = ItemStockFIFO + IHr.TotCostPrice;
								end else begin
									ItemStockFIFO = ItemStockFIFO - IHr.TotCostPrice;
								end;
								if (halt==ItemsQty) then begin
									TrHs = false;
								end;
							end;
						end;
						
						if (ItemStockQty>0 or EndItemStockQty>0) then begin
							ItemStockEx = true;
						end;
						ItemStockFIFO = ItemStockFIFO / halt;					
						resetloop(IHr);
						
						
						if (ItemStockEx) then begin	
							// s = s + 1;
							GetPrice (ItemCode, sd, ed, aLocations[k], vSaleQtyPrc, RepSpec, fifoazn, fifob1, rowfifoazn, rowfifob1, brandfifo, rowbrandfifo,
														curprice, aznprice, curcusm, aznsum);					
							AddTextToArea	(ItemCode & chr(09) 																						//1
										& INr.Name & chr(09) 																										//2
										& INr.AlternativeCode & chr(09) 																				//3
										& aLocations[k] & chr(09) 																							//5
										& vClassName[INr.BPIBrand] & chr(09) 																		//6
										& ItemStockFIFO & chr(09)																								//27
										& aznprice & chr(09)																										//31
										& ItemStockQty & chr(09)																								//22
										& ItemStockQty * ItemStockFIFO & chr(09)																//29
										& EndItemStockQty & chr(09)																							//23
										& EndItemStockQty * ItemStockFIFO & chr(09)
										& ed & chr(09),BodyAr);
										
							if (partscnt>0) then begin
								for (x=0;x<partscnt;x=x+1) begin
									AddTextToArea	(aPUPartsDates[x] & chr(09)
																& aPUPartsQty[x] & chr(09),BodyAr);
								end;
							end;										
							AddTextToArea	(chr(13),BodyAr);
						end;
					end;
				end;
			end;
		end;
		logtext(0,"3");
		WriteAreaToFile	(BodyAr,FileName,0);
		resetloop(INr);
	end;
	endjob;
	return;
end;








global
webpublic procedure WebSaldRepInFileStart()
begin
	integer compNo, i;
	date startMonth;
	record RcVc RepSpec;
	
	
	for (compNo=1;compNo<35;compNo=compNo+1) begin
		if (SetCompany(compNo,false)) then begin
			startMonth = "1/1/2017"; //addmonth
			for (i=0;i<66;i=i+1) begin
				logtext(0,CurrentCompany);
				recordnew(RepSpec);
				RepSpec.sStartDate = startMonth;
				RepSpec.sEndDate = addday(addmonth(startMonth,1),-1);
				RepSpec.f9 = "";
				ItemSaldReportMn(RepSpec);
				startMonth = addmonth(startMonth,1);
			end;
		end;
	end;
	return;
end;



global updating procedure UpdPLAndPLHistQueued (string PLCode,string ArtCode,val price)
begin
	record PLVc PLr;
	
	PLr.PLCode = PLCode;
	PLr.ArtCode = ArtCode;
	if (ReadFirstmain(PLr,2,true)) then begin
		if (PLr.ExVatPrice!=price) then begin
			PLr.ExVatPrice = price;
			if (recordstore(PLr,true)) then begin
				AddPLHist(PLr,PLr);
			end;
		end;
	end;
return;
end;



global updating procedure UpdPriceQueued (string PLCode,string ArtCode,string ItemName,val price,string PLcurcode)
begin
		record PLVc PLr;
		
		recordNew(PLr);
		PLr.PLCode = PLCode;
		PLr.ArtCode = ArtCode;
		PLr.Comment = ItemName;
		PLr.SalesAcc = "";
		PLr.CurncyCode = PLcurcode;
		PLr.ExVatPrice = price;
		if (recordstore(PLr,true)) then begin
		end;
return;
end;




global updating procedure Clear_3_4_catsQueued (string ArtCode, string Brand)
begin
		record GlobalItemVc GIr;
		record BPIBrandVc BPIBrandr;
		
		BPIBrandr.Name = Brand;
		if (readfirstkey("Name",BPIBrandr,1,true)) then begin
			GIr.Code = BPIBrandr.Code & "_" & ArtCode;
			if (ReadFIrstMain(GIr,1,true)) then begin
				GIr.BTRxThirdLevCat = "";
				GIr.BTRxFourthLevCat = "";
				if (recordstore(GIr,true)) then begin 
					logtext(0,GIr.Code & " OK")
				end;
			end else begin
				GIr.Code = ArtCode;
				if (ReadFIrstMain(GIr,1,true)) then begin
					GIr.BTRxThirdLevCat = "";
					GIr.BTRxFourthLevCat = "";
					if (recordstore(GIr,true)) then begin 
						logtext(0,GIr.Code & " OK")
					end;
				end;
			end;
		end;
return;
end;







global
webpublic procedure WebGetMaxRRPItemsInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr;
	vector val vlocinst,vmaxprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;

	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetMaxRRPItemsInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		GIr.Code = "";
		while (loopmain(GIr,1,TrHs1)) begin
			testf = true;
			if (GIr.ExtProwItRegulations>0) then begin testf = false; end;
			if(testf)then begin
				for (i=0;i<CompQty;i=i+1)begin
					BlockLoad(Compb);
					matrowget(Compb,i,Comprw);
					if(Comprw.ActiveStatus==0 and i+1!=29 and !CompanyIsJWLikeCompany(i+1) and i+1!=1)then begin
						SetCompany(i+1,false);
						INr.Code = GIr.HansaCode;
						if (ReadFirstMain(INr,1,true)) then begin
							if (left(GIr.Code,8)==INr.BPIBrand) then begin
								PLr.PLCode = "RRP";
								PLr.ArtCode = INr.Code;
								if (ReadFirstMain(PLr,2,true)) then begin
									if (vmaxprice[GIr.Code]<PLr.ExVatPrice) then begin
										testf1 = true;
										if (nonblank(vmaxcurr[GIr.Code]) and vmaxcurr[GIr.Code]!=PLr.CurncyCode) then begin testf1 = false; end;
										if (testf1) then begin
											vmaxprice[GIr.Code] = PLr.ExVatPrice;
											vmaxcurr[GIr.Code] = PLr.CurncyCode;
											vmaxcomp[GIr.Code] = CurrentCompany;
										end;
									end;
								end;
							end;
						end;
					end;
				end;
			end;
		end;	
		resetloop(GIr);
		GIr.Code = "";
		TrHs1 = true;
		while (loopmain(GIr,1,TrHs1)) begin
			testf = true;
			if (GIr.ExtProwItRegulations>0) then begin testf = false; end;
			if (vmaxcomp[GIr.Code]==0) then begin testf = false; end;
			if(testf)then begin
				AddTextToArea	(GIr.Code & chr(09) 																						//1
											& GIr.HansaCode & chr(09) 																			//2
											& GIr.BPIBrand & chr(09)																				//3
											& vmaxprice[GIr.Code] & chr(09) 																//4
											& vmaxcurr[GIr.Code] & chr(09) 																	//5
											& vmaxcomp[GIr.Code] & chr(09) 																	//5
											&	chr(13),BodyAr);
			end;
		end;	
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	
	
  return;
end;










global
webpublic procedure WebGetGlItemInfoInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr;
	vector val vlocinst,vmaxprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;
  
  vector string 255 vClass;
  longint curtick;
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	record BtrxStrapMatVc BtrxStrapMatr;
	record BtrxBracelMatVc BtrxBracelMatr;
	record BtrxCollectionVc BtrxCollectionr;
	record BtrxCollectionGroupVc BtrxCollectionGroupr;
	
	logtext(0,"================================================ WebCompileAllParams");
	
	setcompany(1,false); 
	// Collect Bitrix Name start
	BTRxBrandr.Code = "";
	while (loopMain(BTRxBrandr,1,true)) begin 
		vClass [BTRxBrandr.Code] = BTRxBrandr.Name;
	end;
	
	BTRxMaterialr.Code = "";
	while (loopMain(BTRxMaterialr,1,true)) begin 
		vClass [BTRxMaterialr.Code] = BTRxMaterialr.Name;
	end;
	BTRxColorr.Code = "";
	while (loopMain(BTRxColorr,1,true)) begin 
		vClass [BTRxColorr.Code] = BTRxColorr.Name;
	end;
	BTRxSizer.Code = "";
	while (loopMain(BTRxSizer,1,true)) begin 
		vClass [BTRxSizer.Code] = BTRxSizer.Name;
	end;	
	BTRxSexr.Code = "";
	while (loopMain(BTRxSexr,1,true)) begin 
		vClass [BTRxSexr.Code] = BTRxSexr.Name;
	end;	
	BTRxPlatingr.Code = "";
	while (loopMain(BTRxPlatingr,1,true)) begin 
		vClass [BTRxPlatingr.Code] = BTRxPlatingr.Name;
	end;	
	BTRxStoner.Code = "";
	while (loopMain(BTRxStoner,1,true)) begin 
		vClass [BTRxStoner.Code] = BTRxStoner.Name;
	end;	
	BTRxStrapr.Code = "";
	while (loopMain(BTRxStrapr,1,true)) begin 
		vClass [BTRxStrapr.Code] = BTRxStrapr.Name;
	end;	
	BTRxOdourr.Code = "";
	while (loopMain(BTRxOdourr,1,true)) begin 
		vClass [BTRxOdourr.Code] = BTRxOdourr.Name;
	end;	
	BtrxInternalCatr.Code = "";
	while (loopMain(BtrxInternalCatr,1,true)) begin 
		vClass [BtrxInternalCatr.Code] = BtrxInternalCatr.Name;
	end;	
	BtrxFirstLevelCatr.Code = "";
	while (loopMain(BtrxFirstLevelCatr,1,true)) begin 
		vClass [BtrxFirstLevelCatr.Code] = BtrxFirstLevelCatr.Name;
	end;	
	BtrxSecondLevelCatr.Code = "";
	while (loopMain(BtrxSecondLevelCatr,1,true)) begin 
		vClass [BtrxSecondLevelCatr.Code] = BtrxSecondLevelCatr.Name;
	end;	
	BtrxThirdLevelCatr.Code = "";
	while (loopMain(BtrxThirdLevelCatr,1,true)) begin 
		vClass [BtrxThirdLevelCatr.Code] = BtrxThirdLevelCatr.Name;
	end;	
	BtrxCertificater.Code = "";
	while (loopMain(BtrxCertificater,1,true)) begin 
		vClass [BtrxCertificater.Code] = BtrxCertificater.Name;
	end;	
	BtrxWatchMechanr.Code = "";
	while (loopMain(BtrxWatchMechanr,1,true)) begin 
		vClass [BtrxWatchMechanr.Code] = BtrxWatchMechanr.Name;
	end;	
	BtrxPowerReserver.Code = "";
	while (loopMain(BtrxPowerReserver,1,true)) begin 
		vClass [BtrxPowerReserver.Code] = BtrxPowerReserver.Name;
	end;	
	BtrxWatchGrader.Code = "";
	while (loopMain(BtrxWatchGrader,1,true)) begin 
		vClass [BtrxWatchGrader.Code] = BtrxWatchGrader.Name;
	end;	
	BtrxPhoneModelr.Code = "";
	while (loopMain(BtrxPhoneModelr,1,true)) begin 
		vClass [BtrxPhoneModelr.Code] = BtrxPhoneModelr.Name;
	end;	
	BtrxFillingr.Code = "";
	while (loopMain(BtrxFillingr,1,true)) begin 
		vClass [BtrxFillingr.Code] = BtrxFillingr.Name;
	end;	
	BtrxTyper.Code = "";
	while (loopMain(BtrxTyper,1,true)) begin 
		vClass [BtrxTyper.Code] = BtrxTyper.Name;
	end;	
	BtrxWatResr.Code = "";
	while (loopMain(BtrxWatResr,1,true)) begin 
		vClass [BtrxWatResr.Code] = BtrxWatResr.Name;
	end;	
	BtrxStrapMatr.Code = "";
	while (loopMain(BtrxStrapMatr,1,true)) begin 
		vClass [BtrxStrapMatr.Code] = BtrxStrapMatr.Name;
	end;	
	BtrxBracelMatr.Code = "";
	while (loopMain(BtrxBracelMatr,1,true)) begin 
		vClass [BtrxBracelMatr.Code] = BtrxBracelMatr.Name;
	end;	
	BtrxCollectionr.Code = "";
	while (loopMain(BtrxCollectionr,1,true)) begin 
		vClass [BtrxCollectionr.Code] = BtrxCollectionr.Name;
	end;	
	BtrxCollectionGroupr.Code = "";
	while (loopMain(BtrxCollectionGroupr,1,true)) begin 
		vClass [BtrxCollectionGroupr.Code] = BtrxCollectionGroupr.Name;
	end;	
	// end
	// Collect BPIclassification Name start
	vClass [""] = "";
	BPIBr.Code = "";
	while (loopMain(BPIBr,1,true)) begin 
		vClass [BPIBr.Code] = BPIBr.Name;
	end;
	
	

	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetGlItemInfoInFile.txt";
	logtext(0,"WebGetGlItemInfoInFile Start");
	if (!fileexists(FileName))then begin
		resetloop(GIr);
		GIr.Code = "";
		TrHs1 = true;
		while (loopmain(GIr,1,TrHs1)) begin
			testf = true;
			// if (GIr.ExtProwItRegulations>0) then begin testf = false; end;
			// if (vmaxcomp[GIr.Code]==0) then begin testf = false; end;
			if(testf)then begin
				AddTextToArea	(GIr.Code & chr(09) 																						
											& GIr.HansaCode & chr(09) 																			
											& GIr.BPIBrand & chr(09)
											& vClass[GIr.BPIBrand] & chr(09)
											& GIr.Name & chr(09) 																			
											& GIr.NameRUS & chr(09) 																			
											& GIr.NameAZ & chr(09)																				
											& vClass[GIr.BTRxType] & chr(09) 																
											& vClass[GIr.BtrxCollection] & chr(09) 																	
											&	chr(13),BodyAr);
			end;
		end;	
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	
	
  return;
end;













global
webpublic procedure WebGetJWMaxRRPItemsInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr;
	vector val vlocinst,vmaxprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;

	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetJVMaxRRPItemsInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		GIr.Code = "";
		while (loopmain(GIr,1,TrHs1)) begin
			testf = true;
			if (GIr.ExtProwItRegulations>0) then begin testf = false; end;
			if(testf)then begin
				for (i=0;i<CompQty;i=i+1)begin
					BlockLoad(Compb);
					matrowget(Compb,i,Comprw);
					if(Comprw.ActiveStatus==0 and (i+1==16 or CompanyIsJWLikeCompany(i+1)))then begin
						SetCompany(i+1,false);
						INr.Code = GIr.HansaCode;
						if (ReadFirstMain(INr,1,true)) then begin
							if (left(GIr.Code,8)==INr.BPIBrand) then begin
								PLr.PLCode = "RRP";
								PLr.ArtCode = INr.Code;
								if (ReadFirstMain(PLr,2,true)) then begin
									if (vmaxprice[GIr.Code]<PLr.ExVatPrice) then begin
										testf1 = true;
										if (nonblank(vmaxcurr[GIr.Code]) and vmaxcurr[GIr.Code]!=PLr.CurncyCode) then begin testf1 = false; end;
										if (testf1) then begin
											vmaxprice[GIr.Code] = PLr.ExVatPrice;
											vmaxcurr[GIr.Code] = PLr.CurncyCode;
											vmaxcomp[GIr.Code] = CurrentCompany;
										end;
									end;
								end;
							end;
						end;
					end;
				end;
			end;
		end;	
		resetloop(GIr);
		GIr.Code = "";
		TrHs1 = true;
		while (loopmain(GIr,1,TrHs1)) begin
			testf = true;
			if (GIr.ExtProwItRegulations>0) then begin testf = false; end;
			if (vmaxcomp[GIr.Code]==0) then begin testf = false; end;
			if(testf)then begin
				AddTextToArea	(GIr.Code & chr(09) 																						//1
											& GIr.HansaCode & chr(09) 																			//2
											& GIr.BPIBrand & chr(09)																				//3
											& vmaxprice[GIr.Code] & chr(09) 																//4
											& vmaxcurr[GIr.Code] & chr(09) 																	//5
											& vmaxcomp[GIr.Code] & chr(09) 																	//5
											&	chr(13),BodyAr);
			end;
		end;	
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	
	
  return;
end;






global
webpublic procedure WebGetRSMaxRRPItemsInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr;
	vector val vlocinst,vmaxprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;

	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	setCompany(5,false);
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetRSMaxRRPItemsInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		INr.Code = "";
		while (loopmain(INr,1,TrHs1)) begin
			testf = true;
			// if (GIr.ExtProwItRegulations>0) then begin testf = false; end;
			if(testf)then begin
				// for (i=0;i<CompQty;i=i+1)begin
					// BlockLoad(Compb);
					// matrowget(Compb,i,Comprw);
					// if(Comprw.ActiveStatus==0 and (i+1==16 or CompanyIsJWLikeCompany(i+1)))then begin
						// SetCompany(i+1,false);
						// INr.Code = GIr.HansaCode;
						// if (ReadFirstMain(INr,1,true)) then begin
							// if (left(GIr.Code,8)==INr.BPIBrand) then begin
								PLr.PLCode = "RRP";
								PLr.ArtCode = INr.Code;
								if (ReadFirstMain(PLr,2,true)) then begin
									if (vmaxprice[INr.Code]<PLr.ExVatPrice) then begin
										testf1 = true;
										if (nonblank(vmaxcurr[INr.Code]) and vmaxcurr[INr.Code]!=PLr.CurncyCode) then begin testf1 = false; end;
										if (testf1) then begin
											vmaxprice[INr.Code] = PLr.ExVatPrice;
											vmaxcurr[INr.Code] = PLr.CurncyCode;
											vmaxcomp[INr.Code] = CurrentCompany;
										end;
									end;
								end;
							// end;
						// end;
					// end;
				// end;
			end;
		end;	
		resetloop(INr);
		INr.Code = "";
		TrHs1 = true;
		while (loopmain(INr,1,TrHs1)) begin
			testf = true;
			// if (GIr.ExtProwItRegulations>0) then begin testf = false; end;
			if (vmaxcomp[INr.Code]==0) then begin testf = false; end;
			if(testf)then begin
				AddTextToArea	(INr.Code & chr(09) 																						//1
											& INr.BPIBrand & chr(09)																				//3
											& vmaxprice[INr.Code] & chr(09) 																//4
											& vmaxcurr[INr.Code] & chr(09) 																	//5
											& vmaxcomp[INr.Code] & chr(09) 																	//5
											&	chr(13),BodyAr);
			end;
		end;	
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	  return;
end;

	
	
	



global
webpublic procedure WebGetSWAllItemsInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li,pmtrw;
	array string 20 aloc,alocation;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vPLcurr, vLPPcurr, vPPCurr;
	vector val vlocinst,vPLprice,vLPPprice,vPPprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;
	record PricePointListVc PPLr;
	row PricePointListVc PPLrw;

	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	setCompany(1,false);
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetSWAllItemsInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		INr.Code = "";
		PPLr.TransDate = CurrentDate;
		loopbackkey("TransDate",PPLr,1,true);
		while (loopmain(INr,1,TrHs1)) begin
			testf = true;
			if(testf)then begin
				PLr.PLCode = "RRP";
				PLr.ArtCode = INr.Code;
				if (ReadFirstMain(PLr,2,true)) then begin
					vPLprice[INr.Code] = PLr.ExVatPrice;
					vPLcurr[INr.Code] = PLr.CurncyCode;
				end;
				vLPPprice[INr.Code] = INr.LastPurchPrice2;
				vLPPcurr[INr.Code] = INr.LastPurchCurncyCode;
				pmtrw = matrowcnt(PPLr);
				if(StringToLongInt(INr.CPSCode)<=pmtrw and nonblank(INr.CPSCode))then begin
					matrowget(PPLr,StringToLongInt(INr.CPSCode)-1,PPLrw);
					vPPprice[INr.Code] = PPLrw.Price;
					vPPCurr[INr.Code] = "EUR";
				end;
			end;
		end;	
		resetloop(INr);
		INr.Code = "";
		TrHs1 = true;
		while (loopmain(INr,1,TrHs1)) begin
			AddTextToArea	(INr.Code & chr(09) 																						//1
										& INr.BPIBrand & chr(09)																				//3
										& vPLprice[INr.Code] & chr(09) 																	//4
										& vPLcurr[INr.Code] & chr(09) 																	//5
										& vLPPprice[INr.Code] & chr(09) 																//4
										& vLPPcurr[INr.Code] & chr(09) 																	//5
										& vPPprice[INr.Code] & chr(09) 																	//4
										& vPPCurr[INr.Code] & chr(09) 																	//4
										& INr.UnitCoefficient & chr(09) 																	//4
										&	chr(13),BodyAr);
		end;	
		WriteAreaToFile	(BodyAr,FileName,0);
		runprogram("chmod","-R a+rw SalesReportExt");
	end;
	
  return;
end;

	
	
	
	


global
webpublic procedure WebGetAllItemsWithBMPricesInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y, g;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode,PFCode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li,pmtrw;
	array string 20 aloc,alocation;
	integer aloccnt;
	vector boolean vbrandcode, vITGcode, vItemCode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vPLcurr, vLPPcurr, vPPCurr, groupForm;
	vector val vlocinst,vPLprice,vLPPprice,vPPprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes,vClassName;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;
	record PricePointListVc PPLr;
	row PricePointListVc PPLrw;
	record BPIBrandVc BPIBrandr;
	record BPICollectionVc BPICollectionr;
  record BPIGroupVc BPIGroupr;
  record BPISubGroupVc BPISubGroupr;
  record BPICategoryVc BPICategoryr;
  record BPIMaterialVc BPIMaterialr;
  record BPIColorVc BPIColorr;
  record BPIShapeVc BPIShaper;
  record BPISizeVc BPISizer;
  record BPIUseVc BPIUser;
  record BPISexVc BPISexr;
  record BPIPlatingVc BPIPlatingr;
  record BPIClarityVc BPIClarityr;
  record BPIWeightVc BPIWeightr;
  record BPICutVc BPICutr;
  record BPIStoneVc BPIStoner;
  record BPIStrapVc BPIStrapr;
  record BPIOdourVc BPIOdourr;
	record PLDefVc PLDr;
	record ITVc ITr;
	row PLDefVc PLDrw;
	date blnkDate;

	setCompany(1,false);

	BPIOdourr.Code = "";
	while(loopmain(BPIOdourr,1,true))begin
		vClassName[BPIOdourr.Code] = BPIOdourr.Name;
	end;
	BPIStrapr.Code = "";
	while(loopmain(BPIStrapr,1,true))begin
		vClassName[BPIStrapr.Code] = BPIStrapr.Name;
	end;
	BPIStoner.Code = "";
	while(loopmain(BPIStoner,1,true))begin
		vClassName[BPIStoner.Code] = BPIStrapr.Name;
	end;
	BPICutr.Code = "";
	while(loopmain(BPICutr,1,true))begin
		vClassName[BPICutr.Code] = BPIStrapr.Name;
	end;
	BPIWeightr.Code = "";
	while(loopmain(BPIWeightr,1,true))begin
		vClassName[BPIWeightr.Code] = BPIStrapr.Name;
	end;
	BPIClarityr.Code = "";
	while(loopmain(BPIClarityr,1,true))begin
		vClassName[BPIClarityr.Code] = BPIStrapr.Name;
	end;
	BPIPlatingr.Code = "";
	while(loopmain(BPIPlatingr,1,true))begin
		vClassName[BPIPlatingr.Code] = BPIPlatingr.Name;
	end;
	BPISexr.Code = "";
	while(loopmain(BPISexr,1,true))begin
		vClassName[BPISexr.Code] = BPISexr.Name;
	end;
	BPIUser.Code = "";
	while(loopmain(BPIUser,1,true))begin
		vClassName[BPIUser.Code] = BPIUser.Name;
	end;
	BPISizer.Code = "";
	while(loopmain(BPISizer,1,true))begin
		vClassName[BPISizer.Code] = BPISizer.Name;
	end;
	BPIShaper.Code = "";
	while(loopmain(BPIShaper,1,true))begin
		vClassName[BPIShaper.Code] = BPIShaper.Name;
	end;
	BPIColorr.Code = "";
	while(loopmain(BPIColorr,1,true))begin
		vClassName[BPIColorr.Code] = BPIColorr.Name;
	end;
	BPIMaterialr.Code = "";
	while(loopmain(BPIMaterialr,1,true))begin
		vClassName[BPIMaterialr.Code] = BPIMaterialr.Name;
	end;
	BPICategoryr.Code = "";
	while(loopmain(BPICategoryr,1,true))begin
		vClassName[BPICategoryr.Code] = BPICategoryr.Name;
	end;
	BPISubGroupr.Code = "";
	while(loopmain(BPISubGroupr,1,true))begin
		vClassName[BPISubGroupr.Code] = BPISubGroupr.Name;
	end;
	BPIGroupr.Code = "";
	while(loopmain(BPIGroupr,1,true))begin
		vClassName[BPIGroupr.Code] = BPIGroupr.Name;
	end;
	BPICollectionr.Code = "";
	while(loopmain(BPICollectionr,1,true))begin
		vClassName[BPICollectionr.Code] = BPICollectionr.Name;
	end;
	BPIBrandr.Code = "";
	while(loopmain(BPIBrandr,1,true))begin
		vClassName[BPIBrandr.Code] = BPIBrandr.Name;
	end;
	

	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	FileName = "SalesReportExt/WebGetAllItemsWithBMPricesInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		g = 0;
		for (i=0;i<CompQty;i=i+1)begin
			logtext(0,i+1 & " WebGetAllItemsWithBMPricesInFile");
			BlockLoad(Compb);
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or (i+1)==3) and (i+1)!=18)then begin
				SetCompany(i+1,false);
				
				PLDr.Code = "RRP";
				ClearVector(vITGcode);
				ClearVector(vItemCode);
				if (ReadFIrstMain(PLDr,1,true)) then begin
					for (j=0;j<matrowcnt(PLDr);j=j+1) begin
						matrowget(PLDr,j,PLDrw);
						if (PLDrw.CodeType==0) then begin 
							// if (nonblank(PLDrw.Formula)) then begin
								if (PLDrw.ItemCode=="COINC") then begin logtext(0,"CurrentCompany COINC" & CurrentCompany); end;
								vITGcode[PLDrw.ItemCode & "_" & i+1] = true;
								groupForm[PLDrw.ItemCode & "_" & i+1] = PLDrw.Formula;
							// end;
						end else begin
							// if (nonblank(PLDrw.Formula)) then begin
								vItemCode[PLDrw.ItemCode & "_" & i+1] = true;
								groupForm[PLDrw.ItemCode & "_" & i+1] = PLDrw.Formula;
							// end;
						end;
					end;
				end;
				ITr.Code = "";
				while(loopmain(ITr,1,true))begin
					vClassName[ITr.Code] = ITr.Code;
				end;
				resetloop(ITr);
				INr.Code = "";
				PPLr.TransDate = CurrentDate;
				loopbackkey("TransDate",PPLr,1,true);
				TrHs1=true;
				while (loopmain(INr,1,TrHs1)) begin
					testf = false;
					
					ISr.Code = INr.Code;
					ISr.Location = ";;;";
					if (ReadFirstMain(ISr,2,true)) then begin
						if (ISr.Instock>0) then begin
							testf = true;
						end;
					end;
					IHr.ArtCode = "";
					IHr.TransDate = blnkDate;
					if (testf==false) then begin
						IHr.ArtCode = INr.Code;
						IHr.TransDate = CurrentDate;
						if (loopbackkey("ArtCode",IHr,2,true)) then begin
							if (IHr.TransDate>=AddYear(CurrentDate,-1)) then begin
								testf = true;
							end;
						end;
						ResetLoop(IHr);
					end;
				
					if(testf)then begin
						PLr.PLCode = "RRP";
						PLr.ArtCode = INr.Code;
						if (ReadFirstMain(PLr,2,true)) then begin	end;
						PPLrw.Price = 0;
						pmtrw = matrowcnt(PPLr);
						if(StringToLongInt(INr.CPSCode)<=pmtrw and nonblank(INr.CPSCode) and (CurrentCompany==1 or CurrentCompany==16))then begin
							matrowget(PPLr,StringToLongInt(INr.CPSCode)-1,PPLrw);
						end;
					
					
						PFCode = "";
						if (vItemCode[INr.Code & "_" & i+1]) then begin
							PFCode = groupForm[INr.Code & "_" & i+1];
						end else begin
							if (vITGcode[INr.Group & "_" & i+1]) then begin
								PFCode = groupForm[INr.Group & "_" & i+1];
							end;
						end;
						
						AddTextToArea	(INr.Code & chr(09) 																										//1
													& Comprw.CompName & chr(09)
													& INr.BPIBrand & chr(09)																								//3
													& vClassName[INr.Group] & chr(09) 																			//6
													& vClassName[INr.BPIBrand] & chr(09) 																		//6
													& vClassName[INr.BPICollection] & chr(09) 															//8
													& vClassName[INr.BPIGroup] & chr(09) 																		//9
													& vClassName[INr.BPISubGroup] & chr(09) 																//10
													& vClassName[INr.BPICategory] & chr(09) 																//11
													& vClassName[INr.BPIMaterial] & chr(09) 																//12
													& vClassName[INr.BPIColor] & chr(09) 																		//13
													& vClassName[INr.BPIShape] & chr(09) 																		//14
													& vClassName[INr.BPISize] & chr(09) 																		//15
													& vClassName[INr.BPIUse] & chr(09) 																			//16
													& vClassName[INr.BPISex] & chr(09) 																			//17
													& vClassName[INr.BPIPlating] & chr(09)																	//18
													& vClassName[INr.BPIClarity] & chr(09)
													& vClassName[INr.BPIWeight] & chr(09)
													& vClassName[INr.BPICut] & chr(09)
													& vClassName[INr.BPIStone] & chr(09)
													& vClassName[INr.BPIStrap] & chr(09)
													& vClassName[INr.BPIOdour] & chr(09)
													& PLr.ExVatPrice & chr(09) 																							//4
													& PLr.CurncyCode & chr(09) 																							//5
													& PFCode & chr(09) 																											//5
													& INr.LastPurchPrice2 & chr(09) 																				//4
													& INr.LastPurchCurncyCode & chr(09) 	
													& PPLrw.Price & chr(09) 																								//4
													& INr.CPSCode & chr(09) 																								//4
													& INr.UnitCoefficient & chr(09) 																				//4
													& ISr.Instock & chr(09) 																								//4
													& IHr.TransDate & chr(09) 																							//4
													&	chr(13),BodyAr);
					end;
				end;	
				resetloop(PPLr);
				resetloop(INr);
				INr.Code = "";
				TrHs1 = true;	
			end;
		end;
		WriteAreaToFile	(BodyAr,FileName,0);
		runprogram("chmod","-R a+rw SalesReportExt");
	end;
	
  return;
end;
	
	
	
	
	
	

global
webpublic procedure WebGetRRPNExistfBrandsInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y, g, itcnt;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation,agroup,agroupname;
	integer aloccnt;
	vector boolean vbrandcode, vITGcode, vItemCode, vBrandExInCompf, vBrandActive;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr, vBrandExInCompNames;
	vector val vlocinst,vmaxprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes, vBrandGroup, vBrandGroupf, groupf;
	vector string 255 OrigBrandCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;
	record BPIBrandVc BPIBrandr;
  record PLDefVc PLDr;
	row PLDefVc PLDrw;
	record ITVc ITr;
	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetRRPNExistfBrandsInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		g = 0;
		for (i=0;i<CompQty;i=i+1)begin
			logtext(0,i+1 & " WebGetRRPNExistfBrandsInFile");
			BlockLoad(Compb);
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or (i+1)==3) and (i+1)!=18)then begin
				SetCompany(i+1,false);
				if (i==0) then begin
					BPIBrandr.Code = "";
					while (loopMain(BPIBrandr,1,true)) begin
						vbrandcode[BPIBrandr.Code] = true;
						vbrandname[BPIBrandr.Code] = BPIBrandr.Name;
					end;
					resetloop(BPIBrandr);
				end;
				PLDr.Code = "RRP";
				ClearVector(vITGcode);
				ClearVector(vItemCode);
				ClearVector(vBrandExInCompf);
				if (ReadFIrstMain(PLDr,1,true)) then begin
					for (j=0;j<matrowcnt(PLDr);j=j+1) begin
						matrowget(PLDr,j,PLDrw);
						if (PLDrw.CodeType==0) then begin 
							if (nonblank(PLDrw.Formula)) then begin
								if (PLDrw.ItemCode=="COINC") then begin logtext(0,"CurrentCompany COINC" & CurrentCompany); end;
								vITGcode[PLDrw.ItemCode] = true;
							end;
						end else begin
							if (nonblank(PLDrw.Formula)) then begin
								vItemCode[PLDrw.ItemCode] = true;
							end;
						end;
					end;
				end;
				INr.Code = "";
				TrHs1=true;
				while (loopmain(INr,1,TrHs1)) begin
					ISr.Code = INr.Code;
					ISr.Location = ";;;";
					readfirstmain(ISr,2,true);
					if (INr.LastPriceChange>stringtodate("1/01/2019") or ISr.Instock>0) then begin
						vBrandActive[INr.BPIBrand] = true;
						if (!vBrandExInCompf[INr.BPIBrand]) then begin
							if nonblank(vBrandExInCompNames[INr.BPIBrand]) then begin vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & ","; end;
							vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & Comprw.CompName;
							vBrandExInCompf[INr.BPIBrand] = true;
						end;
						if (!vBrandExInCompf[INr.BPIBrand & "_" & INr.Group]) then begin
							if nonblank(vBrandExInCompNames[INr.BPIBrand & "_" & INr.Group]) then begin vBrandExInCompNames[INr.BPIBrand & "_" & INr.Group] = vBrandExInCompNames[INr.BPIBrand & "_" & INr.Group] & ","; end;
							vBrandExInCompNames[INr.BPIBrand & "_" & INr.Group] = vBrandExInCompNames[INr.BPIBrand & "_" & INr.Group] & Comprw.CompName;
							vBrandExInCompf[INr.BPIBrand & "_" & INr.Group] = true;
						end;
							if (!vBrandGroup[INr.BPIBrand & "_" & INr.Group]) then begin 
							vBrandGroup[INr.BPIBrand & "_" & INr.Group] = true;
							vBrandGroupf[INr.BPIBrand & "_" & INr.Group] = true;
						end;
					end;
					if (!groupf[INr.Group] and nonblank(INr.Group)) then begin
						groupf[INr.Group] = true;
						agroup[g] = INr.Group;
						ITr.Code = INr.Group;
						if(readfirstmain(ITr,1,true))then begin
							agroupname[g] = ITr.Comment;
						end;
						g = g + 1;
					end;
					itcnt = g;
					if (nonblank(INr.CPSCode) and (CurrentCompany==1 or CurrentCompany==16)) then begin
						vbrandcode[INr.BPIBrand] = false;
						vBrandGroupf[INr.BPIBrand & "_" & INr.Group] = false;
					end else begin
						if (vITGcode[INr.Group]) then begin
							if (INr.BPIBrand=="BRND0046") then begin logtext(0,"CurrentCompany COINC" & CurrentCompany & "_" & INr.Code); end;
							vbrandcode[INr.BPIBrand] = false;
							vBrandGroupf[INr.BPIBrand & "_" & INr.Group] = false;
						end else begin
							if (vItemCode[INr.Code]) then begin
								vbrandcode[INr.BPIBrand] = false;
								vBrandGroupf[INr.BPIBrand & "_" & INr.Group] = false;
							end;
						end;
					end;
				end;
				resetloop(INr);
			end;
		end;
		SetCompany(1,false);
		BPIBrandr.Code = "";
		while (loopMain(BPIBrandr,1,true)) begin
			if (vBrandActive[BPIBrandr.Code]) then begin
				if(vbrandcode[BPIBrandr.Code]) then begin
					AddTextToArea	(BPIBrandr.Code & chr(09) 																						//1
												& vbrandname[BPIBrandr.Code] & chr(09)									//2
												& "All groups" & chr(09)
												& "All groups" & chr(09)
												&	vBrandExInCompNames[BPIBrandr.Code] & chr(09)
												&	chr(13),BodyAr);
				end else begin
					for (i=0;i<itcnt;i=i+1) begin
						if(vBrandGroupf[BPIBrandr.Code & "_" & agroup[i]]) then begin
							AddTextToArea	(BPIBrandr.Code & chr(09) 																						//1
												& vbrandname[BPIBrandr.Code] & chr(09) 		
												& agroup[i] & chr(09)
												& agroupname[i] & chr(09)
												&	vBrandExInCompNames[BPIBrandr.Code & "_" & agroup[i]] & chr(09)	
												&	chr(13),BodyAr);
						end;
					end;
				end;
			end;
		end;
		
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	
	
  return;
end;










	
	

global
webpublic procedure WebGetStockMovementsInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RLinkVc RLr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr, LCTr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y, g, itcnt;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation,agroup,agroupname;
	integer aloccnt, mtcnt;
	vector boolean vbrandcode, vITGcode, vItemCode, vBrandExInCompf, vBrandActive;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr, vBrandExInCompNames;
	vector val vlocinst,vmaxprice;
	record POVc POr;
	record PUVc PUr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes, vBrandGroup, vBrandGroupf, groupf;
	vector string 255 OrigBrandCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;
	record SHVc SHr;
	row SHVc SHrw;
  record SDVc SDr;
	row SDVc SDrw;
  record StockMovVc SMr;
	row StockMovVc SMrw;
	record ITVc ITr;
	record TRVc TRr;
	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetStockMovementsInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		
		for (i=0;i<CompQty;i=i+1)begin
			BlockLoad(Compb);
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0)then begin
				if(SetCompany(i+1,false)) then begin
					LCr.Code = "";
					while (loopMain(LCr,1,true)) begin
						vlocname[LCr.Code] = LCr.Name;
						vloc[LCr.Code] = Comprw.CompName;
					end;
					resetloop(LCr);
				end;
			end;
		end;
		
		g = 0;
		for (i=0;i<CompQty;i=i+1)begin
			BlockLoad(Compb);
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0)then begin
				if(SetCompany(i+1,false)) then begin
					if (CurrentCompany!=18) then begin
						SMr.OKFlag = 1;
						SMr.TransDate = stringtodate("01/04/2022");
						TrHs = true;
						while (loopkey("OKFlagTransDate",SMr,2,TrHs)) begin
							if (SMr.TransDate<stringtodate("01/04/2022")) then begin TrHs = false; end;
							if (SMr.OKFlag!=1) then begin TrHs = false; end;
							if (TrHs) then begin
								TRr.Number = SMr.SerNr;
								TRr.IntYc = STMovYc;
								if (ReadFirstMain(TRr,2,true)) then begin end;
									mtcnt = 0;
									for (j=0;j<matrowcnt(SMr);j=j+1) begin
										matrowget(SMr,j,SMrw);
										if (nonblank(SMrw.ArtCode)) then begin mtcnt = mtcnt + 1; end;
									end;
									AddTextToArea	("StockMovVc" & chr(09) 
																& TRr.Sign & chr(09) 	
																& SMr.SerNr & chr(09) 		
																&	Comprw.CompName & chr(09)	 		
																& SMr.FrLocation & chr(09)
																& vlocname[SMr.FrLocation] & chr(09)
																& "StockMovVc" & chr(09) 		
																& SMr.SerNr & chr(09) 		
																& vloc[SMr.ToLocation] & chr(09)
																& SMr.ToLocation & chr(09)
																& vlocname[SMr.ToLocation] & chr(09)
																& SMr.TransDate & chr(09)
																&	mtcnt & chr(09)	
																& SMr.TotQty & chr(09),BodyAr);	
									for (j=0;j<matrowcnt(SMr);j=j+1) begin
										matrowget(SMr,j,SMrw);
										if (nonblank(SMrw.ArtCode)) then begin AddTextToArea(SMrw.ArtCode & " " & SMrw.Spec & " " & SMrw.Quant & "||",BodyAr);   end;
									end;
									AddTextToArea	(chr(13),BodyAr);
																
							end;
						end;
						resetloop(SMr);
						SDr.OKFlag = 1;
						SDr.TransDate = stringtodate("01/04/2022");
						TrHs = true;
						while (loopkey("OKFlagTransDate",SDr,2,TrHs)) begin
							testf = true;
							if (SDr.TransDate<stringtodate("01/04/2022")) then begin TrHs = false; end;
							if (SDr.OKFlag!=1) then begin TrHs = false; end;
							if (SDr.Reservf!=1) then begin testf = false; end;
							if (TrHs and testf) then begin
								if(ReadRecordLink(SDr,1,POr,RLr)) then begin
									TRr.Number = SDr.SerNr;
									TRr.IntYc = SDYc;
									if (ReadFirstMain(TRr,2,true)) then begin end;
									mtcnt = 0;
									for (j=0;j<matrowcnt(SDr);j=j+1) begin
										matrowget(SDr,j,SDrw);
										if (nonblank(SDrw.ArtCode)) then begin mtcnt = mtcnt + 1; end;
									end;
									if(ReadRecordLink(POr,1,PUr,RLr)) then begin end;
									AddTextToArea	("SDVc" & chr(09) 
																& TRr.Sign & chr(09)
																& SDr.SerNr & chr(09) 
																&	Comprw.CompName & chr(09)
																& SDr.Location & chr(09)
																& vlocname[SDr.Location] & chr(09)
																& "PUVc" & chr(09) 		
																& PUr.SerNr & chr(09) 		
																& vloc[POr.Location] & chr(09)
																& POr.Location & chr(09)
																& vlocname[POr.Location] & chr(09)
																& SDr.TransDate & chr(09)
																&	mtcnt & chr(09)	
																& SDr.TotQty & chr(09),BodyAr);		
									for (j=0;j<matrowcnt(SDr);j=j+1) begin
										matrowget(SDr,j,SDrw);
										if (nonblank(SDrw.ArtCode)) then begin AddTextToArea(SDrw.ArtCode & " " & SDrw.Spec & " " & SDrw.Qty & "||",BodyAr);  end;
									end;
									AddTextToArea	(chr(13),BodyAr);
								end;
							end;
							if (TrHs and !testf) then begin
								if(ReadRecordLink(SHr,1,PUr,RLr)) then begin
									TRr.Number = SDr.SerNr;
									TRr.IntYc = SDYc;
									if (ReadFirstMain(TRr,2,true)) then begin end;
										mtcnt = 0;
										for (j=0;j<matrowcnt(SDr);j=j+1) begin
											matrowget(SDr,j,SDrw);
											if (nonblank(SDrw.ArtCode)) then begin mtcnt = mtcnt + 1; end;
										end;
										AddTextToArea	("SDVc" & chr(09) 		
																	& TRr.Sign & chr(09)									//1
																	& SDr.SerNr & chr(09) 
																	&	Comprw.CompName & chr(09)
																	& SDr.Location & chr(09)
																	& vlocname[SDr.Location] & chr(09)
																	& "PUVc" & chr(09) 		
																	& PUr.SerNr & chr(09)
																	& vloc[PUr.Location] & chr(09)
																	& PUr.Location & chr(09)
																	& vlocname[PUr.Location] & chr(09)
																	& SDr.TransDate & chr(09)
																	&	mtcnt & chr(09)	
																	& SDr.TotQty & chr(09),BodyAr);		
									for (j=0;j<matrowcnt(SDr);j=j+1) begin
										matrowget(SDr,j,SDrw);
										if (nonblank(SDrw.ArtCode)) then begin AddTextToArea(SDrw.ArtCode & " " & SDrw.Spec & " " & SDrw.Qty & "||",BodyAr);  end;
									end;
									AddTextToArea	(chr(13),BodyAr);
								end;
							end;
						end;
						resetloop(SDr);
					end else begin
						SHr.OKFlag = 1;
						SHr.ShipDate = stringtodate("01/04/2022");
						TrHs = true;
						while (loopkey("OKFlagShipDate",SHr,2,TrHs)) begin
							testf = true;
							if (SHr.ShipDate<stringtodate("01/04/2022")) then begin TrHs = false; end;
							if (SHr.OKFlag!=1) then begin TrHs = false; end;
							if (TrHs and testf) then begin
								if(ReadRecordLink(SHr,1,POr,RLr)) then begin
									TRr.Number = SHr.SerNr;
									TRr.IntYc = SHYc;
									if (ReadFirstMain(TRr,2,true)) then begin end;
										mtcnt = 0;
										for (j=0;j<matrowcnt(SHr);j=j+1) begin
											matrowget(SHr,j,SHrw);
											if (nonblank(SHrw.ArtCode)) then begin mtcnt = mtcnt + 1; end;
										end;
										if(ReadRecordLink(SHr,1,PUr,RLr)) then begin end;
										AddTextToArea	("SHVc" & chr(09) 		
																	& TRr.Sign & chr(09)									//1
																	& SHr.SerNr & chr(09) 	
																	&	Comprw.CompName & chr(09)
																	& SHr.Location & chr(09)
																	& vlocname[SHr.Location] & chr(09)
																	& "PUVc" & chr(09) 		
																	& PUr.SerNr & chr(09)
																	& vloc[POr.Location] & chr(09)
																	& POr.Location & chr(09)
																	& vlocname[POr.Location] & chr(09)
																	& SHr.ShipDate & chr(09)
																	&	mtcnt & chr(09)	
																	& SHr.TotQty & chr(09),BodyAr);		
									for (j=0;j<matrowcnt(SHr);j=j+1) begin
										matrowget(SHr,j,SHrw);
										if (nonblank(SHrw.ArtCode)) then begin AddTextToArea(SHrw.ArtCode & " " & SHrw.Spec & " " & SHrw.Ship & "||",BodyAr);  end;
									end;
									AddTextToArea	(chr(13),BodyAr);
								end;
							end;
						end;
						resetloop(SHr);
					end;
				end;
			end;
		end;
		
		WriteAreaToFile	(BodyAr,FileName,0);
		runprogram("chmod","-R a+rw SalesReportExt");
	end;
	
	
	
  return;
end;



	
	
	






	
	
	

global
webpublic procedure WebGetRRPExistfBrandsInFileOld()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y, g, itcnt;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation,agroup,agroupname,aitemcode,aitemname;
	integer aloccnt;
	vector boolean vbrandcode, vITGcode, vItemCode, vBrandExInCompf, vBrandActive;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr, vBrandExInCompNames, brandShWay;
	vector val vlocinst,vmaxprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes, vBrandGroup, vBrandGroupf, groupf, itemf;
	vector string 255 OrigBrandCodes, groupForm, brandForm, vBrandCPSCode;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName;
	vector integer vmaxcomp;
	record BPIBrandVc BPIBrandr;
  record PLDefVc PLDr;
	row PLDefVc PLDrw;
	record ITVc ITr;
	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetRRPExistfBrandsInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		g = 0;
		y = 0;
		for (i=0;i<CompQty;i=i+1)begin
			logtext(0,i+1 & " WebGetRRPExistfBrandsInFile");
			BlockLoad(Compb);
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or (i+1)==3) and (i+1)!=18)then begin
				SetCompany(i+1,false);
				if (i==0) then begin
					BPIBrandr.Code = "";
					while (loopMain(BPIBrandr,1,true)) begin
						vbrandcode[BPIBrandr.Code] = true;
						vbrandname[BPIBrandr.Code] = BPIBrandr.Name;
						switch (BPIBrandr.DeliveryWay) begin
							case 0: brandShWay[BPIBrandr.Code] = "AIR";
							case 1: brandShWay[BPIBrandr.Code] = "ROAD";
							case 2: brandShWay[BPIBrandr.Code] = "SEA";
							otherwise
								brandShWay[BPIBrandr.Code] = "N/A";
						end;
					end;
					resetloop(BPIBrandr);
				end;
				PLDr.Code = "RRP";
				ClearVector(vITGcode);
				ClearVector(vItemCode);
				ClearVector(vBrandExInCompf);
				if (ReadFIrstMain(PLDr,1,true)) then begin
					for (j=0;j<matrowcnt(PLDr);j=j+1) begin
						matrowget(PLDr,j,PLDrw);
						if (PLDrw.CodeType==0) then begin 
							// if (nonblank(PLDrw.Formula)) then begin
								if (PLDrw.ItemCode=="COINC") then begin logtext(0,"CurrentCompany COINC" & CurrentCompany); end;
								vITGcode[PLDrw.ItemCode & "_" & i+1] = true;
								groupForm[PLDrw.ItemCode & "_" & i+1] = PLDrw.Formula;
							// end;
						end else begin
							// if (nonblank(PLDrw.Formula)) then begin
								vItemCode[PLDrw.ItemCode & "_" & i+1] = true;
								groupForm[PLDrw.ItemCode & "_" & i+1] = PLDrw.Formula;
							// end;
						end;
					end;
				end;
				INr.Code = "";
				TrHs1=true;
				if (CurrentCompany==3) then begin Comprw.CompName = "All JW Comp."; end;
				while (loopmain(INr,1,TrHs1)) begin
					if (nonblank(INr.BPIBrand)) then begin
						if (!vBrandExInCompf[INr.BPIBrand & "_" & INr.Group] and nonblank(INr.Group) and nonblank(groupForm[INr.Group & "_" & CurrentCompany]) and vITGcode[INr.Group & "_" & CurrentCompany]) then begin
							vBrandExInCompf[INr.BPIBrand & "_" & INr.Group] = true;
							ITr.Code = INr.Group;
							readfirstmain(ITr,1,true);
							AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
														& vbrandname[INr.BPIBrand] & chr(09) 		
														& INr.Group & chr(09)
														& "" & chr(09)
														& ITr.Comment & chr(09)
														&	Comprw.CompName & chr(09)	
														&	groupForm[INr.Group & "_" & CurrentCompany] & chr(09)	
														& brandShWay[INr.BPIBrand] & chr(09)
														& "Price form" & chr(09)
														&	chr(13),BodyAr);
							vBrandActive[INr.BPIBrand] = true;
						end;
						if (!vBrandExInCompf[INr.BPIBrand & "_" & INr.Group] and nonblank(INr.Group) and blank(groupForm[INr.Group & "_" & CurrentCompany]) and vITGcode[INr.Group & "_" & CurrentCompany]) then begin
							vBrandExInCompf[INr.BPIBrand & "_" & INr.Group] = true;
							ITr.Code = INr.Group;
							readfirstmain(ITr,1,true);
							AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
														& vbrandname[INr.BPIBrand] & chr(09) 		
														& INr.Group & chr(09)
														& "" & chr(09)
														& ITr.Comment & chr(09)
														&	Comprw.CompName & chr(09)	
														&	groupForm[INr.Group & "_" & CurrentCompany] & chr(09)	
														& brandShWay[INr.BPIBrand] & chr(09)
														& "Handle" & chr(09)
														&	chr(13),BodyAr);
						end;
						if (nonblank(groupForm[INr.Code & "_" & i+1]) and vItemCode[INr.Code & "_" & CurrentCompany]) then begin
							AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
														& vbrandname[INr.BPIBrand] & chr(09) 	
														& "" & chr(09)														
														& INr.Code & chr(09)
														& INr.Name & chr(09)
														&	Comprw.CompName & chr(09)	
														&	groupForm[INr.Code & "_" & i+1] & chr(09)	
														& brandShWay[INr.BPIBrand] & chr(09)
														& "Price form" & chr(09)
														&	chr(13),BodyAr);
							vBrandActive[INr.BPIBrand] = true;
						end;
						if (blank(groupForm[INr.Code & "_" & i+1]) and nonblank(INr.CPSCode) and !vItemCode[INr.Code & "_" & CurrentCompany]) then begin
							AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
														& vbrandname[INr.BPIBrand] & chr(09) 
														& "" & chr(09)
														& INr.Code & chr(09)
														& INr.Name & chr(09)
														&	Comprw.CompName & chr(09)	
														&	INr.CPSCode & chr(09)	
														& brandShWay[INr.BPIBrand] & chr(09)
														& "PP Code" & chr(09)
														&	chr(13),BodyAr);
							vBrandActive[INr.BPIBrand] = true;
						end;
						if (blank(groupForm[INr.Code & "_" & i+1]) and blank(INr.CPSCode) and vItemCode[INr.Code & "_" & CurrentCompany]) then begin
							AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
														& vbrandname[INr.BPIBrand] & chr(09) 	
														& "" & chr(09)														
														& INr.Code & chr(09)
														& INr.Name & chr(09)
														&	Comprw.CompName & chr(09)	
														&	groupForm[INr.Code & "_" & i+1] & chr(09)	
														& brandShWay[INr.BPIBrand] & chr(09)
														& "Handle" & chr(09)
														&	chr(13),BodyAr);
						end;
					end;
				end;
				resetloop(INr);
			end;
		end;
		SetCompany(1,false);
		BPIBrandr.Code = "";
		while (loopMain(BPIBrandr,1,true)) begin
			if (CurrentCompany==3) then begin Comprw.CompName = "All JW Comp."; end;
			if (!vBrandActive[BPIBrandr.Code] and nonblank(BPIBrandr.Code)) then begin
				AddTextToArea	(BPIBrandr.Code & chr(09) 																						//1
											& BPIBrandr.Name & chr(09) 		
											& "" & chr(09)
											& "" & chr(09)
											& "" & chr(09)
											&	"" & chr(09)	
											&	"" & chr(09)	
											& brandShWay[BPIBrandr.Code] & chr(09)
											& "Handle" & chr(09)
											&	chr(13),BodyAr);
			end;
		end;
		
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	
	
  return;
end;



	
	
	
	
	
	
	

global
webpublic procedure WebGetRRPExistfBrandsInFile()
begin
	area fillitems;
	record GlobalItemVc GIr,mainGIr,DupGir,OldGir,LogGIr;
	row GlobalItemVc GIrw, DupGIrw,OldGirw;
	record INVc INr,oldINr;
	record DIVc DIr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record RebVc Rebr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	row RebVc Rebrw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,pos,rwcnt,j,exportflag,quant,k,OrGCcnt,y, g, itcnt;
	boolean TrHs, testf, JewCompf, TrHs1, dummyf, calcprice, testf1, isfirst, isfirst2, isfirst3, CPSf;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li;
	array string 20 aloc,alocation,agroup,agroupname,aitemcode,aitemname;
	integer aloccnt;
	vector boolean vbrandcode, vITGcode, vItemCode, vBrandExInCompf, vBrandActive;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr, vBrandExInCompNames, brandShWay;
	vector val vlocinst,vmaxprice;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes, vBrandGroup, vBrandGroupf, groupf, itemf, vtestf, instfInJW;
	vector string 255 OrigBrandCodes, groupForm, brandForm, vBrandCPSCode;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName, Item, ItemName;
	vector integer vmaxcomp;
	record BPIBrandVc BPIBrandr;
  record PLDefVc PLDr;
	row PLDefVc PLDrw;
	record ITVc ITr;
	vector val vBGSQty, vBGSQtyInstock, vBGSQtyInstockUnCodes;
	vector date vBGSLastPurchPate;
	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	
	TrHs1=true;
	FileName = "SalesReportExt/WebGetRRPExistfBrandsInFile.txt";
	logtext(0,"ItemSaldReportMn Start");
	if (!fileexists(FileName))then begin
		g = 0;
		y = 0;
		for (i=0;i<CompQty;i=i+1)begin
			logtext(0,i+1 & " WebGetRRPExistfBrandsInFile");
			BlockLoad(Compb);
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0/* and (!CompanyIsJWLikeCompany(i+1) or (i+1)==3)*/ and (i+1)!=18)then begin
				SetCompany(i+1,false);
				if (nonblank(Comprw.CompName)) then begin
					if (i==0) then begin
						BPIBrandr.Code = "";
						while (loopMain(BPIBrandr,1,true)) begin
							vbrandcode[BPIBrandr.Code] = true;
							vbrandname[BPIBrandr.Code] = BPIBrandr.Name;
							switch (BPIBrandr.DeliveryWay) begin
								case 0: brandShWay[BPIBrandr.Code] = "AIR";
								case 1: brandShWay[BPIBrandr.Code] = "ROAD";
								case 2: brandShWay[BPIBrandr.Code] = "SEA";
								otherwise
									brandShWay[BPIBrandr.Code] = "N/A";
							end;
						end;
						resetloop(BPIBrandr);
					end;
					PLDr.Code = "RRP";
					ClearVector(vITGcode);
					ClearVector(vItemCode);
					ClearVector(vBrandExInCompf);
					if (ReadFIrstMain(PLDr,1,true)) then begin
						for (j=0;j<matrowcnt(PLDr);j=j+1) begin
							matrowget(PLDr,j,PLDrw);
							if (PLDrw.CodeType==0) then begin 
								if (PLDrw.ItemCode=="COINC") then begin logtext(0,"CurrentCompany COINC" & CurrentCompany); end;
								vITGcode[PLDrw.ItemCode & "_" & i+1] = true;
								groupForm[PLDrw.ItemCode & "_" & i+1] = PLDrw.Formula;
							end else begin
								vItemCode[PLDrw.ItemCode & "_" & i+1] = true;
								groupForm[PLDrw.ItemCode & "_" & i+1] = PLDrw.Formula;
							end;
						end;
					end;
					INr.Code = "";
					TrHs1=true;
					if (CompanyIsJWLikeCompany(CurrentCompany)) then begin Comprw.CompName = "All JW Comp."; end;
					while (loopmain(INr,1,TrHs1)) begin
						if (nonblank(INr.BPIBrand)) then begin
							ISr.Code = INr.Code;
							ISr.Location = ";;;";
							readfirstmain(ISr,2,true);
							CPSf = false;
							if ((CurrentCompany==1 or CurrentCompany==16) and nonblank(INr.CPSCode)) then begin
								CPSf = true;
							end;
							if (nonblank(INr.Group) and nonblank(groupForm[INr.Group & "_" & CurrentCompany]) and vITGcode[INr.Group & "_" & CurrentCompany] and !vItemCode[INr.Code & "_" & CurrentCompany] and !CPSf) then begin
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] = vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] + 1;
								end;
								vBGSQtyInstock[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] = vBGSQtyInstock[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] + ISr.Instock;
								if (ISr.Instock>0 and (!instfInJW[INr.Code] or !CompanyIsJWLikeCompany(CurrentCompany))) then begin
									vBGSQtyInstockUnCodes[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] = vBGSQtyInstockUnCodes[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] + 1;
									if (CompanyIsJWLikeCompany(CurrentCompany)) then begin
										instfInJW[INr.Code] = true;
									end;
								end;
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									if (vBGSLastPurchPate[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"]<INr.LastPriceChange) then begin
										vBGSLastPurchPate[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] = INr.LastPriceChange;
									end;
									if (!vBrandExInCompf[INr.BPIBrand]) then begin
										if nonblank(vBrandExInCompNames[INr.BPIBrand]) then begin vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & ","; end;
										vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & Comprw.CompName;
										vBrandExInCompf[INr.BPIBrand] = true;
									end;
								end;
							end;
							if (nonblank(INr.Group) and blank(groupForm[INr.Group & "_" & CurrentCompany]) and vITGcode[INr.Group & "_" & CurrentCompany] and !vItemCode[INr.Code & "_" & CurrentCompany] and !CPSf) then begin
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] = vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] + 1;
								end;
								vBGSQtyInstock[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] = vBGSQtyInstock[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] + ISr.Instock;
								if (ISr.Instock>0 and (!instfInJW[INr.Code] or !CompanyIsJWLikeCompany(CurrentCompany))) then begin
									vBGSQtyInstockUnCodes[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] = vBGSQtyInstockUnCodes[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] + 1;
									if (CompanyIsJWLikeCompany(CurrentCompany)) then begin
										instfInJW[INr.Code] = true;
									end;
								end;
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									if (vBGSLastPurchPate[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"]<INr.LastPriceChange) then begin
										vBGSLastPurchPate[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] = INr.LastPriceChange;
									end;
									if (!vBrandExInCompf[INr.BPIBrand]) then begin
										if nonblank(vBrandExInCompNames[INr.BPIBrand]) then begin vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & ","; end;
										vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & Comprw.CompName;
										vBrandExInCompf[INr.BPIBrand] = true;
									end;
								end;
							end;
							if (nonblank(groupForm[INr.Code & "_" & i+1]) and vItemCode[INr.Code & "_" & CurrentCompany] and !CPSf) then begin
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] = vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] + 1;
								end;
								vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] = vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] + ISr.Instock;
								if (ISr.Instock>0 and (!instfInJW[INr.Code] or !CompanyIsJWLikeCompany(CurrentCompany))) then begin
									vBGSQtyInstockUnCodes[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] = vBGSQtyInstockUnCodes[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] + 1;
									if (CompanyIsJWLikeCompany(CurrentCompany)) then begin
										instfInJW[INr.Code] = true;
									end;
								end;

								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									if (vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"]<INr.LastPriceChange) then begin
										vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] = INr.LastPriceChange;
									end;
									if (!vBrandExInCompf[INr.BPIBrand]) then begin
										if nonblank(vBrandExInCompNames[INr.BPIBrand]) then begin vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & ","; end;
										vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & Comprw.CompName;
										vBrandExInCompf[INr.BPIBrand] = true;
									end;
								end;
							end;
							if (CPSf) then begin
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] = vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] + 1;
								end;
								vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] = vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] + ISr.Instock;
								if (ISr.Instock>0 and (!instfInJW[INr.Code] or !CompanyIsJWLikeCompany(CurrentCompany))) then begin
									vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] = vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] + 1;
									if (CompanyIsJWLikeCompany(CurrentCompany)) then begin
										instfInJW[INr.Code] = true;
									end;
								end;
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									if (vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"]<INr.LastPriceChange) then begin
										vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] = INr.LastPriceChange;
									end;
									if (!vBrandExInCompf[INr.BPIBrand]) then begin
										if nonblank(vBrandExInCompNames[INr.BPIBrand]) then begin vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & ","; end;
										vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & Comprw.CompName;
										vBrandExInCompf[INr.BPIBrand] = true;
									end;
								end;
							end;
							if (blank(groupForm[INr.Code & "_" & i+1]) and !CPSf and vItemCode[INr.Code & "_" & CurrentCompany]) then begin
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] + 1;
								end;
								vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] + ISr.Instock;
								if (ISr.Instock>0 and (!instfInJW[INr.Code] or !CompanyIsJWLikeCompany(CurrentCompany))) then begin
									vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] + 1;
									if (CompanyIsJWLikeCompany(CurrentCompany)) then begin
										instfInJW[INr.Code] = true;
									end;
								end;
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									if (vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"]<INr.LastPriceChange) then begin
										vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = INr.LastPriceChange;
									end;
									if (!vBrandExInCompf[INr.BPIBrand]) then begin
										if nonblank(vBrandExInCompNames[INr.BPIBrand]) then begin vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & ","; end;
										vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & Comprw.CompName;
										vBrandExInCompf[INr.BPIBrand] = true;
									end;
								end;
							end;
							if (blank(groupForm[INr.Code & "_" & i+1]) and !CPSf and !vItemCode[INr.Code & "_" & CurrentCompany] and nonblank(INr.BPIBrand) and blank(groupForm[INr.Group & "_" & CurrentCompany]) and !vITGcode[INr.Group & "_" & CurrentCompany]) then begin
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] + 1;
								end;
								vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] + ISr.Instock;
								if (ISr.Instock>0 and (!instfInJW[INr.Code] or !CompanyIsJWLikeCompany(CurrentCompany))) then begin
									vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] + 1;
									if (CompanyIsJWLikeCompany(CurrentCompany)) then begin
										instfInJW[INr.Code] = true;
									end;
								end;
								if (!CompanyIsJWLikeCompany(CurrentCompany) or CurrentCompany==3) then begin
									if (vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"]<INr.LastPriceChange) then begin
										vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = INr.LastPriceChange;
									end;
									if (!vBrandExInCompf[INr.BPIBrand]) then begin
										if nonblank(vBrandExInCompNames[INr.BPIBrand]) then begin vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & ","; end;
										vBrandExInCompNames[INr.BPIBrand] = vBrandExInCompNames[INr.BPIBrand] & Comprw.CompName;
										vBrandExInCompf[INr.BPIBrand] = true;
									end;
								end;
							end;
						end;
					end;
					resetloop(INr);
				end;
			end;
		end;
		SetCompany(1,false);
		g = 0;
		y = 0;
		for (i=0;i<CompQty;i=i+1)begin
			logtext(0,i+1 & " WebGetRRPExistfBrandsInFile");
			BlockLoad(Compb);
			matrowget(Compb,i,Comprw);
			if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or (i+1)==3) and (i+1)!=18)then begin
				SetCompany(i+1,false);
				if (nonblank(Comprw.CompName)) then begin
					PLDr.Code = "RRP";
					ClearVector(vITGcode);
					ClearVector(vItemCode);
					ClearVector(vBrandExInCompf);
					if (ReadFIrstMain(PLDr,1,true)) then begin
						for (j=0;j<matrowcnt(PLDr);j=j+1) begin
							matrowget(PLDr,j,PLDrw);
							if (PLDrw.CodeType==0) then begin 
								// if (nonblank(PLDrw.Formula)) then begin
									if (PLDrw.ItemCode=="COINC") then begin logtext(0,"CurrentCompany COINC" & CurrentCompany); end;
									vITGcode[PLDrw.ItemCode & "_" & i+1] = true;
									groupForm[PLDrw.ItemCode & "_" & i+1] = PLDrw.Formula;
								// end;
							end else begin
								// if (nonblank(PLDrw.Formula)) then begin
									vItemCode[PLDrw.ItemCode & "_" & i+1] = true;
									groupForm[PLDrw.ItemCode & "_" & i+1] = PLDrw.Formula;
								// end;
							end;
						end;
					end;
					INr.Code = "";
					TrHs1=true;
					if (CurrentCompany==3) then begin Comprw.CompName = "All JW Comp."; end;
					while (loopmain(INr,1,TrHs1)) begin
						if (nonblank(INr.BPIBrand)) then begin
							CPSf = false;
							if ((CurrentCompany==1 or CurrentCompany==16) and nonblank(INr.CPSCode)) then begin
								CPSf = true;
							end;
							if (nonblank(INr.Group) and nonblank(groupForm[INr.Group & "_" & CurrentCompany]) and vITGcode[INr.Group & "_" & CurrentCompany] and !vItemCode[INr.Code & "_" & CurrentCompany] and !CPSf) then begin
								Item = "Items in group";
								if (vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"]==1) then begin Item = INr.Code; ItemName = INr.Name; end;
								if (vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"]>0) then begin
									vBrandExInCompf[INr.BPIBrand & "_" & INr.Group] = true;
									ITr.Code = INr.Group;
									readfirstmain(ITr,1,true);
									AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
																& vbrandname[INr.BPIBrand] & chr(09) 	
																& vBrandExInCompNames[INr.BPIBrand] & chr(09) 	
																& INr.Group & chr(09)
																& Item & chr(09)
																& ITr.Comment & chr(09)
																&	Comprw.CompName & chr(09)	
																&	groupForm[INr.Group & "_" & CurrentCompany] & chr(09)	
																& brandShWay[INr.BPIBrand] & chr(09)
																& "Price form (group)" & chr(09)
																& vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] & chr(09)
																& vBGSLastPurchPate[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] & chr(09)
																& vBGSQtyInstock[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] & chr(09)
																& vBGSQtyInstockUnCodes[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] & chr(09)
																&	chr(13),BodyAr);
									vBrandActive[INr.BPIBrand] = true;
									vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_PF"] = 0;
								end;
							end;
							if (nonblank(INr.Group) and blank(groupForm[INr.Group & "_" & CurrentCompany]) and vITGcode[INr.Group & "_" & CurrentCompany] and !vItemCode[INr.Code & "_" & CurrentCompany] and !CPSf) then begin
								Item = "Items in group";
								if (vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"]==1) then begin Item = INr.Code; ItemName = INr.Name; end;
								if (vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"]>0) then begin
									vBrandExInCompf[INr.BPIBrand & "_" & INr.Group] = true;
									ITr.Code = INr.Group;
									readfirstmain(ITr,1,true);
									AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
																& vbrandname[INr.BPIBrand] & chr(09) 	
																& vBrandExInCompNames[INr.BPIBrand] & chr(09)
																& INr.Group & chr(09)
																& Item & chr(09)
																& ITr.Comment & chr(09)
																&	Comprw.CompName & chr(09)	
																&	groupForm[INr.Group & "_" & CurrentCompany] & chr(09)	
																& brandShWay[INr.BPIBrand] & chr(09)
																& "Handle (group)" & chr(09)
																& vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSLastPurchPate[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSQtyInstock[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSQtyInstockUnCodes[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] & chr(09)
																&	chr(13),BodyAr);
									vBGSQty[INr.BPIBrand & "_" & INr.Group & "_" & Comprw.CompName & "_HD"] = 0;
								end;
							end;
							if (nonblank(groupForm[INr.Code & "_" & i+1]) and vItemCode[INr.Code & "_" & CurrentCompany] and !CPSf) then begin
								Item = "Items";
								ItemName = "Items";
								if (vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"]==1) then begin 
									Item = INr.Code; ItemName = INr.Name; 
								end else begin
									groupForm[INr.Code & "_" & i+1] = "Forms";
								end;
								if (vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"]>0) then begin
									AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
																& vbrandname[INr.BPIBrand] & chr(09) 	
																& vBrandExInCompNames[INr.BPIBrand] & chr(09)
																& "" & chr(09)														
																& Item & chr(09)
																& ItemName & chr(09)
																&	Comprw.CompName & chr(09)	
																&	groupForm[INr.Code & "_" & i+1] & chr(09)	
																& brandShWay[INr.BPIBrand] & chr(09)
																& "Price form (items)" & chr(09)
																& vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] & chr(09)
																& vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] & chr(09)
																& vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] & chr(09)
																& vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] & chr(09)
																&	chr(13),BodyAr);
									vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PF"] = 0;
									vBrandActive[INr.BPIBrand] = true;
								end;
							end;
							if (CPSf) then begin
								Item = "Items";
								ItemName = "Items";
								if (vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"]==1) then begin 
									Item = INr.Code; ItemName = INr.Name; 
								end else begin
									INr.CPSCode = "PP codes";
								end;
								if (vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"]>0) then begin
									AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
																& vbrandname[INr.BPIBrand] & chr(09) 
																& vBrandExInCompNames[INr.BPIBrand] & chr(09)
																& "" & chr(09)
																& Item & chr(09)
																& ItemName & chr(09)
																&	Comprw.CompName & chr(09)	
																&	INr.CPSCode & chr(09)	
																& brandShWay[INr.BPIBrand] & chr(09)
																& "PP Code (items)" & chr(09)
																& vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] & chr(09)
																& vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] & chr(09)
																& vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] & chr(09)
																& vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] & chr(09)
																&	chr(13),BodyAr);
									vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_PP"] = 0;
									vBrandActive[INr.BPIBrand] = true;
								end;
							end;
							if (blank(groupForm[INr.Code & "_" & i+1]) and !CPSf and vItemCode[INr.Code & "_" & CurrentCompany]) then begin
								Item = "Items";
								ItemName = "Items";
								if (vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"]==1) then begin 
									Item = INr.Code; ItemName = INr.Name; 
								end else begin
									groupForm[INr.Code & "_" & i+1] = "Forms";
								end;
								if (vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"]>0) then begin
									AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
																& vbrandname[INr.BPIBrand] & chr(09) 
																& vBrandExInCompNames[INr.BPIBrand] & chr(09)
																& "" & chr(09)														
																& Item & chr(09)
																& ItemName & chr(09)
																&	Comprw.CompName & chr(09)	
																&	groupForm[INr.Code & "_" & i+1] & chr(09)	
																& brandShWay[INr.BPIBrand] & chr(09)
																& "Handle (items)" & chr(09)
																& vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] & chr(09)
																&	chr(13),BodyAr);
									vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = 0;
								end;
							end;
							if (blank(groupForm[INr.Code & "_" & i+1]) and !CPSf and !vItemCode[INr.Code & "_" & CurrentCompany] and nonblank(INr.BPIBrand) and blank(groupForm[INr.Group & "_" & CurrentCompany]) and !vITGcode[INr.Group & "_" & CurrentCompany]) then begin
								Item = "Items";
								ItemName = "Items";
								if (vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"]==1) then begin Item = INr.Code; ItemName = INr.Name; end;
								if (vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"]>0) then begin
									AddTextToArea	(INr.BPIBrand & chr(09) 																						//1
																& vbrandname[INr.BPIBrand] & chr(09) 	
																& vBrandExInCompNames[INr.BPIBrand] & chr(09)
																& "" & chr(09)														
																& Item & chr(09)
																& ItemName & chr(09)
																&	Comprw.CompName & chr(09)	
																&	groupForm[INr.Code & "_" & i+1] & chr(09)	
																& brandShWay[INr.BPIBrand] & chr(09)
																& "Handle (items)" & chr(09)
																& vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSLastPurchPate[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSQtyInstock[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] & chr(09)
																& vBGSQtyInstockUnCodes[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] & chr(09)
																&	chr(13),BodyAr);
									vBGSQty[INr.BPIBrand & "_Items_" & Comprw.CompName & "_HD"] = 0;
								end;
							end;
							if (blank(Comprw.CompName)) then begin
								logtext(0,CurrentCompany);
							end;
						end;
					end;
					resetloop(INr);
				end;
			end;
		end;
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	
	
  return;
end;



	






global
webpublic procedure WebGetORClientStatInFile()
begin
	area fillitems;
	record INVc INr,oldINr;
	record ItemStatusVc ISr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, allexf, calcprice, parttestf, allnotextestf, POtestf, PUParttestf, PUtestf;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode, PONr, PUNr, CompORNr, CompPONr;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li, x, itcnt;
	array string 200 aloc,alocation, aItemCodes, aItemNames, aItemBrand;
	array val aItemQty;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr;
	vector val vlocinst,itemQTyOR,vPUITQty,vPOITQty,vSHITEMQTy;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes, vMainItemCodes, vItemVeCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn, ClientCode, ClientName, CompanyName;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName, POSerNrstr, Companystr;
	vector integer vmaxcomp;
	record ORVc ORr, compORr;
	row ORVc ORrw, compORrw;
	record RLinkVc RLinkr, RLink2r;
	record POVc POr, compPOr;
	row POVc POrw;
	record PUVc PUr;
	row PUVc PUrw;
	integer pos;
	record ConsItemVc CIr;
	date ORDate, CompPODate, PODate, PUDate, SHDate, blnkdate;
	
	IDr.OrigCode = "";
	while(loopMain(IDr,1,true))begin
		vMainItemCodes[IDr.DupCode] = IDr.OrigCode;
	end;
	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	SetCompany(18,false);
	CIr.Code = "";
	while(loopMain(CIr,1,true))begin
		vItemVeCodes[CIr.Code] = CIr.LocCode;
	end;
	
	itcnt = 0;
	TrHs1=true;
	FileName = "SalesReportExt/WebGetORClientStatInFile.txt";
	logtext(0,"WebGetORClientStatInFile Start");
	if (!fileexists(FileName))then begin
		while (LoopMain(ORr,1,true)) begin
			if (ORr.OrderClass == "CLIEN") then begin 
				ORDate = blnkdate;
				CompPODate = blnkdate; 
				PODate = blnkdate;
				PUDate = blnkdate;
				SHDate = blnkdate;
				parttestf = false;
				allnotextestf = false;
				allexf = true;
				ClientCode = ""; 
				ClientName = ""; 
				CompanyName = ""; 
				pos = 0;
				ExtractObjWithSeparator(":",ORr.OfficialSerNr,true,pos,POSerNrstr);
				ExtractObjWithSeparator(":",ORr.OfficialSerNr,true,pos,Companystr);
				CompORNr = "";
				CompPONr = "";
				PONr = "";
				PUNr = "";
				clearArray(aItemCodes);
				clearArray(aItemNames);
				clearArray(aItemBrand);
				clearArray(aItemQty);
				
				if(SetCompany(StringToInt(Companystr),false)) then begin
					compPOr.SerNr = StringToInt(POSerNrstr);
					if (ReadFIrstMain(compPOr,1,true)) then begin
						CompPONr = compPOr.SerNr;
						CompPODate = compPOr.TransDate;
						compORr.SerNr = compPOr.OrdNr;
						if (ReadFIrstMain(compORr,1,true)) then begin
							CompORNr = compORr.SerNr;
							ClearVector(itemQTyOR);
							ClientCode = compORr.CustCode; 
							ClientName = compORr.Addr0; 
							y = 0;
							for (i=0;i<matrowcnt(compORr);i=i+1) begin
								matrowget(compORr,i,compORrw);
								INr.Code = compORrw.ArtCode;
								if (ReadFIrstMain(INr,1,true)) then begin
									SetCompany(18,false);
									CIr.LocCode = INr.Code;
									CIr.BrandCode = INr.BPIBrand;
									if(ReadFirstKey("LocCodeBrand",CIr,2,true))then begin
										SetCompany(StringToInt(Companystr),false);
										if (nonblank(vMainItemCodes[CIr.Code])) then begin
											itemQTyOR[vMainItemCodes[CIr.Code]] = -compORrw.Quant;
											aItemCodes[y] = vMainItemCodes[CIr.Code];
											aItemNames[y] = INr.Name;
											aItemBrand[y] = INr.BPIBrand;
											aItemQty[y] = compORrw.Quant;
											y = y + 1;
										end else begin
											itemQTyOR[CIr.Code] = -compORrw.Quant;
											aItemCodes[y] = CIr.Code;
											aItemNames[y] = INr.Name;
											aItemBrand[y] = INr.BPIBrand;
											aItemQty[y] = compORrw.Quant;
											y = y + 1;
										end;
										if (compORrw.Quant>0 and compORrw.Shipd2>0) then begin
											parttestf = true;
										end;
										if (compORrw.Quant>compORrw.Shipd2) then begin
											allexf = false;
										end;
									end;
								end;
							end;
							itcnt = y;
						end;
						if (!parttestf) begin
							allnotextestf = true;
						end;
					end;
				end;
				
				ResetCompany(18);
				POtestf = false;
				PUtestf = false;
				clearVector(vSHITEMQTy);
				clearVector(vPOITQty);
				clearVector(vPUITQty);
				i = 1;
				for (x=0;x<matrowcnt(ORr);x=x+1) begin
					matrowget(ORr,x,ORrw);
					if (nonblank(vMainItemCodes[ORrw.ArtCode])) then begin
						vSHITEMQTy[vMainItemCodes[ORrw.ArtCode]] = ORrw.Shipd2;
					end else begin
						vSHITEMQTy[ORrw.ArtCode] = ORrw.Shipd2;
					end;
				end;
				while (ReadRecordLink(ORr,i,POr,RLinkr))begin
					if (ReadFIrstMain(POr,1,true)) then begin
						if (POr.OrdNr==ORr.SerNr) then begin
							for (x=0;x<matrowcnt(POr);x=x+1) begin
								matrowget(POr,x,POrw);
								if (nonblank(vMainItemCodes[POrw.ArtCode])) then begin
									vPOITQty[vMainItemCodes[POrw.ArtCode]] = POrw.Quant;
								end else begin
									vPOITQty[POrw.ArtCode] = POrw.Quant;
								end;
							end;
							PONr = POr.SerNr;
							PODate = POr.TransDate;
							POtestf = true;
							j = 1;
							while (ReadRecordLink(POr,j,PUr,RLink2r))begin
								if (ReadFIrstMain(PUr,1,true)) then begin
									PUNr = PUr.SerNr;
									PUDate = PUr.TransDate;
									if (PUr.OKFlag==1) then begin
										PUtestf = true;
									end;
									for (x=0;x<matrowcnt(PUr);x=x+1) begin
										matrowget(PUr,x,PUrw);
										if (nonblank(vMainItemCodes[PUrw.ArtCode])) then begin
											itemQTyOR[vMainItemCodes[PUrw.ArtCode]] = itemQTyOR[vMainItemCodes[PUrw.ArtCode]] + PUrw.Quant;
											vPUITQty[vMainItemCodes[PUrw.ArtCode]] = PUrw.Quant;
										end else begin
											itemQTyOR[PUrw.ArtCode] = itemQTyOR[PUrw.ArtCode] + PUrw.Quant;
											vPUITQty[PUrw.ArtCode] = PUrw.Quant;
										end;
									end;
								end;
								j = j + 1;
							end;
						end;
					end;
					i = i + 1;
				end;
				
				
				for (y=0;y<itcnt;y=y+1) begin
					if (allnotextestf) then begin
						if (!POtestf) then begin
							AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "No order has been placed on the customer's account to the supplier (new order)" & chr(09) 				//4
										&	chr(13),BodyAr);
						end else begin
							if (!PUtestf) then begin
								AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "The order has been sent to the supplier" & chr(09) 																							//4
										&	chr(13),BodyAr);
							end else begin
								PUParttestf = false;
								for (i=0;i<matrowcnt(ORr);i=i+1) begin
									matrowget(ORr,i,ORrw);
									if (nonblank(vMainItemCodes[ORrw.ArtCode])) then begin
										if (itemQTyOR[vMainItemCodes[ORrw.ArtCode]]<0) then begin
											PUParttestf = true;
										end;
									end else begin
										if (itemQTyOR[ORrw.ArtCode]<0) then begin
											PUParttestf = true;
										end;
									end;
								end;
								if (PUParttestf) then begin
									AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "Partial receipt made to order and not shipped" & chr(09) 																				//4
										&	chr(13),BodyAr);
								end else begin
									AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "Receipt made by order, but not shipped" & chr(09) 																								//4
										&	chr(13),BodyAr);
								end;
							end;
						end;				
					end else begin
						if (parttestf and !allexf) then begin
							if (!POtestf) then begin
								AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "No order has been placed on the customer's account to the supplier (new order)" & chr(09) 				//4
										&	chr(13),BodyAr);
							end else begin
								if (!PUtestf) then begin
									AddTextToArea	(CompPONr & chr(09)
											& CompPODate & chr(09)
											& ORr.Addr0 & chr(09)
											& ClientCode & chr(09)
											& ClientName & chr(09)
											& aItemBrand[y] & chr(09)
											& vItemVeCodes[aItemCodes[y]] & chr(09)
											& aItemNames[y] & chr(09)
											& aItemQty[y] & chr(09)
											& ORr.SerNr & chr(09) 
											& ORDate & chr(09)										//1
											&	PONr & chr(09) 																																										//2
											& PODate & chr(09)
											& vPOITQty[aItemCodes[y]] & chr(09)		
											& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
											& vSHITEMQTy[aItemCodes[y]] & chr(09)
											& "The order has been sent to the supplier" & chr(09) 																							//4
											&	chr(13),BodyAr);
								end else begin
									PUParttestf = false;
									for (i=0;i<matrowcnt(ORr);i=i+1) begin
										matrowget(ORr,i,ORrw);
										if (nonblank(vMainItemCodes[ORrw.ArtCode])) then begin
											if (itemQTyOR[vMainItemCodes[ORrw.ArtCode]]<0) then begin
												PUParttestf = true;
											end;
										end else begin
											if (itemQTyOR[ORrw.ArtCode]<0) then begin
												PUParttestf = true;
											end;
										end;
									end;
									if (PUParttestf) then begin
									AddTextToArea	(CompPONr & chr(09)
											& CompPODate & chr(09)
											& ORr.Addr0 & chr(09)
											& ClientCode & chr(09)
											& ClientName & chr(09)
											& aItemBrand[y] & chr(09)
											& vItemVeCodes[aItemCodes[y]] & chr(09)
											& aItemNames[y] & chr(09)
											& aItemQty[y] & chr(09)
											& ORr.SerNr & chr(09) 
											& ORDate & chr(09)										//1
											&	PONr & chr(09) 																																										//2
											& PODate & chr(09)
											& vPOITQty[aItemCodes[y]] & chr(09)		
											& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
											& vSHITEMQTy[aItemCodes[y]] & chr(09)
											& "Partial receipt made to order and shipped (partial)" & chr(09) 																	//4
											&	chr(13),BodyAr);
									end else begin
									AddTextToArea	(CompPONr & chr(09)
											& CompPODate & chr(09)
											& ORr.Addr0 & chr(09)
											& ClientCode & chr(09)
											& ClientName & chr(09)
											& aItemBrand[y] & chr(09)
											& vItemVeCodes[aItemCodes[y]] & chr(09)
											& aItemNames[y] & chr(09)
											& aItemQty[y] & chr(09)
											& ORr.SerNr & chr(09) 
											& ORDate & chr(09)										//1
											&	PONr & chr(09) 																																										//2
											& PODate & chr(09)
											& vPOITQty[aItemCodes[y]] & chr(09)		
											& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
											& vSHITEMQTy[aItemCodes[y]] & chr(09)
											& "Receipt made by order and shipped (partial)" & chr(09) 																					//4
											&	chr(13),BodyAr);
									end;
								end;
							end;	
						end;
					end;
				end;
			end;
		end;
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	
	
  return;
end;






global
webpublic procedure WebGetORClientStatInFile()
begin
	area fillitems;
	record INVc INr,oldINr;
	record ItemStatusVc ISr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, allexf, calcprice, parttestf, allnotextestf, POtestf, PUParttestf, PUtestf;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode, PONr, PUNr, CompORNr, CompPONr;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li, x, itcnt;
	array string 200 aloc,alocation, aItemCodes, aItemNames, aItemBrand;
	array val aItemQty;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr;
	vector val vlocinst,itemQTyOR,vPUITQty,vPOITQty,vSHITEMQTy;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes, vMainItemCodes, vItemVeCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn, ClientCode, ClientName, CompanyName;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName, POSerNrstr, Companystr;
	vector integer vmaxcomp;
	record ORVc ORr, compORr;
	row ORVc ORrw, compORrw;
	record RLinkVc RLinkr, RLink2r;
	record POVc POr, compPOr;
	row POVc POrw;
	record PUVc PUr;
	row PUVc PUrw;
	integer pos;
	record ConsItemVc CIr;
	date ORDate, CompPODate, PODate, PUDate, SHDate, blnkdate;
	
	IDr.OrigCode = "";
	while(loopMain(IDr,1,true))begin
		vMainItemCodes[IDr.DupCode] = IDr.OrigCode;
	end;
	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	SetCompany(18,false);
	CIr.Code = "";
	while(loopMain(CIr,1,true))begin
		vItemVeCodes[CIr.Code] = CIr.LocCode;
	end;
	
	itcnt = 0;
	TrHs1=true;
	FileName = "SalesReportExt/WebGetORClientStatInFile.txt";
	logtext(0,"WebGetORClientStatInFile Start");
	if (!fileexists(FileName))then begin
		while (LoopMain(ORr,1,true)) begin
			if (ORr.OrderClass == "CLIEN") then begin 
				ORDate = blnkdate;
				CompPODate = blnkdate; 
				PODate = blnkdate;
				PUDate = blnkdate;
				SHDate = blnkdate;
				parttestf = false;
				allnotextestf = false;
				allexf = true;
				ClientCode = ""; 
				ClientName = ""; 
				CompanyName = ""; 
				pos = 0;
				ExtractObjWithSeparator(":",ORr.OfficialSerNr,true,pos,POSerNrstr);
				ExtractObjWithSeparator(":",ORr.OfficialSerNr,true,pos,Companystr);
				CompORNr = "";
				CompPONr = "";
				PONr = "";
				PUNr = "";
				clearArray(aItemCodes);
				clearArray(aItemNames);
				clearArray(aItemBrand);
				clearArray(aItemQty);
				
				if(SetCompany(StringToInt(Companystr),false)) then begin
					compPOr.SerNr = StringToInt(POSerNrstr);
					if (ReadFIrstMain(compPOr,1,true)) then begin
						CompPONr = compPOr.SerNr;
						CompPODate = compPOr.TransDate;
						compORr.SerNr = compPOr.OrdNr;
						if (ReadFIrstMain(compORr,1,true)) then begin
							CompORNr = compORr.SerNr;
							ClearVector(itemQTyOR);
							ClientCode = compORr.CustCode; 
							ClientName = compORr.Addr0; 
							y = 0;
							for (i=0;i<matrowcnt(compORr);i=i+1) begin
								matrowget(compORr,i,compORrw);
								INr.Code = compORrw.ArtCode;
								if (ReadFIrstMain(INr,1,true)) then begin
									SetCompany(18,false);
									CIr.LocCode = INr.Code;
									CIr.BrandCode = INr.BPIBrand;
									if(ReadFirstKey("LocCodeBrand",CIr,2,true))then begin
										SetCompany(StringToInt(Companystr),false);
										if (nonblank(vMainItemCodes[CIr.Code])) then begin
											itemQTyOR[vMainItemCodes[CIr.Code]] = -compORrw.Quant;
											aItemCodes[y] = vMainItemCodes[CIr.Code];
											aItemNames[y] = INr.Name;
											aItemBrand[y] = INr.BPIBrand;
											aItemQty[y] = compORrw.Quant;
											y = y + 1;
										end else begin
											itemQTyOR[CIr.Code] = -compORrw.Quant;
											aItemCodes[y] = CIr.Code;
											aItemNames[y] = INr.Name;
											aItemBrand[y] = INr.BPIBrand;
											aItemQty[y] = compORrw.Quant;
											y = y + 1;
										end;
										if (compORrw.Quant>0 and compORrw.Shipd2>0) then begin
											parttestf = true;
										end;
										if (compORrw.Quant>compORrw.Shipd2) then begin
											allexf = false;
										end;
									end;
								end;
							end;
							itcnt = y;
						end;
						if (!parttestf) begin
							allnotextestf = true;
						end;
					end;
				end;
				
				ResetCompany(18);
				POtestf = false;
				PUtestf = false;
				clearVector(vSHITEMQTy);
				clearVector(vPOITQty);
				clearVector(vPUITQty);
				i = 1;
				for (x=0;x<matrowcnt(ORr);x=x+1) begin
					matrowget(ORr,x,ORrw);
					if (nonblank(vMainItemCodes[ORrw.ArtCode])) then begin
						vSHITEMQTy[vMainItemCodes[ORrw.ArtCode]] = ORrw.Shipd2;
					end else begin
						vSHITEMQTy[ORrw.ArtCode] = ORrw.Shipd2;
					end;
				end;
				while (ReadRecordLink(ORr,i,POr,RLinkr))begin
					if (ReadFIrstMain(POr,1,true)) then begin
						if (POr.OrdNr==ORr.SerNr) then begin
							for (x=0;x<matrowcnt(POr);x=x+1) begin
								matrowget(POr,x,POrw);
								if (nonblank(vMainItemCodes[POrw.ArtCode])) then begin
									vPOITQty[vMainItemCodes[POrw.ArtCode]] = POrw.Quant;
								end else begin
									vPOITQty[POrw.ArtCode] = POrw.Quant;
								end;
							end;
							PONr = POr.SerNr;
							PODate = POr.TransDate;
							POtestf = true;
							j = 1;
							while (ReadRecordLink(POr,j,PUr,RLink2r))begin
								if (ReadFIrstMain(PUr,1,true)) then begin
									PUNr = PUr.SerNr;
									PUDate = PUr.TransDate;
									if (PUr.OKFlag==1) then begin
										PUtestf = true;
									end;
									for (x=0;x<matrowcnt(PUr);x=x+1) begin
										matrowget(PUr,x,PUrw);
										if (nonblank(vMainItemCodes[PUrw.ArtCode])) then begin
											itemQTyOR[vMainItemCodes[PUrw.ArtCode]] = itemQTyOR[vMainItemCodes[PUrw.ArtCode]] + PUrw.Quant;
											vPUITQty[vMainItemCodes[PUrw.ArtCode]] = PUrw.Quant;
										end else begin
											itemQTyOR[PUrw.ArtCode] = itemQTyOR[PUrw.ArtCode] + PUrw.Quant;
											vPUITQty[PUrw.ArtCode] = PUrw.Quant;
										end;
									end;
								end;
								j = j + 1;
							end;
						end;
					end;
					i = i + 1;
				end;
				
				
				for (y=0;y<itcnt;y=y+1) begin
					if (allnotextestf) then begin
						if (!POtestf) then begin
							AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "No order has been placed on the customer's account to the supplier (new order)" & chr(09) 				//4
										&	chr(13),BodyAr);
						end else begin
							if (!PUtestf) then begin
								AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "The order has been sent to the supplier" & chr(09) 																							//4
										&	chr(13),BodyAr);
							end else begin
								PUParttestf = false;
								for (i=0;i<matrowcnt(ORr);i=i+1) begin
									matrowget(ORr,i,ORrw);
									if (nonblank(vMainItemCodes[ORrw.ArtCode])) then begin
										if (itemQTyOR[vMainItemCodes[ORrw.ArtCode]]<0) then begin
											PUParttestf = true;
										end;
									end else begin
										if (itemQTyOR[ORrw.ArtCode]<0) then begin
											PUParttestf = true;
										end;
									end;
								end;
								if (PUParttestf) then begin
									AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "Partial receipt made to order and not shipped" & chr(09) 																				//4
										&	chr(13),BodyAr);
								end else begin
									AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "Receipt made by order, but not shipped" & chr(09) 																								//4
										&	chr(13),BodyAr);
								end;
							end;
						end;				
					end else begin
						if (parttestf and !allexf) then begin
							if (!POtestf) then begin
								AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ORr.Addr0 & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemBrand[y] & chr(09)
										& vItemVeCodes[aItemCodes[y]] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& ORr.SerNr & chr(09) 
										& ORDate & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "No order has been placed on the customer's account to the supplier (new order)" & chr(09) 				//4
										&	chr(13),BodyAr);
							end else begin
								if (!PUtestf) then begin
									AddTextToArea	(CompPONr & chr(09)
											& CompPODate & chr(09)
											& ORr.Addr0 & chr(09)
											& ClientCode & chr(09)
											& ClientName & chr(09)
											& aItemBrand[y] & chr(09)
											& vItemVeCodes[aItemCodes[y]] & chr(09)
											& aItemNames[y] & chr(09)
											& aItemQty[y] & chr(09)
											& ORr.SerNr & chr(09) 
											& ORDate & chr(09)										//1
											&	PONr & chr(09) 																																										//2
											& PODate & chr(09)
											& vPOITQty[aItemCodes[y]] & chr(09)		
											& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
											& vSHITEMQTy[aItemCodes[y]] & chr(09)
											& "The order has been sent to the supplier" & chr(09) 																							//4
											&	chr(13),BodyAr);
								end else begin
									PUParttestf = false;
									for (i=0;i<matrowcnt(ORr);i=i+1) begin
										matrowget(ORr,i,ORrw);
										if (nonblank(vMainItemCodes[ORrw.ArtCode])) then begin
											if (itemQTyOR[vMainItemCodes[ORrw.ArtCode]]<0) then begin
												PUParttestf = true;
											end;
										end else begin
											if (itemQTyOR[ORrw.ArtCode]<0) then begin
												PUParttestf = true;
											end;
										end;
									end;
									if (PUParttestf) then begin
									AddTextToArea	(CompPONr & chr(09)
											& CompPODate & chr(09)
											& ORr.Addr0 & chr(09)
											& ClientCode & chr(09)
											& ClientName & chr(09)
											& aItemBrand[y] & chr(09)
											& vItemVeCodes[aItemCodes[y]] & chr(09)
											& aItemNames[y] & chr(09)
											& aItemQty[y] & chr(09)
											& ORr.SerNr & chr(09) 
											& ORDate & chr(09)										//1
											&	PONr & chr(09) 																																										//2
											& PODate & chr(09)
											& vPOITQty[aItemCodes[y]] & chr(09)		
											& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
											& vSHITEMQTy[aItemCodes[y]] & chr(09)
											& "Partial receipt made to order and shipped (partial)" & chr(09) 																	//4
											&	chr(13),BodyAr);
									end else begin
									AddTextToArea	(CompPONr & chr(09)
											& CompPODate & chr(09)
											& ORr.Addr0 & chr(09)
											& ClientCode & chr(09)
											& ClientName & chr(09)
											& aItemBrand[y] & chr(09)
											& vItemVeCodes[aItemCodes[y]] & chr(09)
											& aItemNames[y] & chr(09)
											& aItemQty[y] & chr(09)
											& ORr.SerNr & chr(09) 
											& ORDate & chr(09)										//1
											&	PONr & chr(09) 																																										//2
											& PODate & chr(09)
											& vPOITQty[aItemCodes[y]] & chr(09)		
											& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
											& vSHITEMQTy[aItemCodes[y]] & chr(09)
											& "Receipt made by order and shipped (partial)" & chr(09) 																					//4
											&	chr(13),BodyAr);
									end;
								end;
							end;	
						end;
					end;
				end;
			end;
		end;
		WriteAreaToFile	(BodyAr,FileName,0);
	end;
	
	
	
  return;
end;








global
webpublic procedure WebGetIDEAORClientStatInFile()
begin
	area fillitems;
	record INVc INr,oldINr;
	record ItemStatusVc ISr;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	record LocationVc LCr;
	LongInt CompQty,i,OldComp,rwcnt,j,exportflag,quant,k,OrGCcnt,y;
	boolean TrHs, testf, JewCompf, TrHs1, allexf, calcprice, parttestf, allnotextestf, POtestf, PUParttestf, PUtestf;
	string 255 class,BrandName,BrandCode,CurCode,salesacc,location,curitemname,tax2code,taxtemplatecode,vatcode, PONr, PUNr, CompORNr, CompPONr;
	val ITRebate,price,FrRate,ToRateB1,ToRateB2,BaseRate1,BaseRate2,baseprice,tax2prc;
	integer flcnt,flushcnt,li, x, itcnt;
	array string 200 aloc,alocation, aItemCodes, aItemNames, aItemBrand;
	array val aItemQty;
	integer aloccnt;
	vector boolean vbrandcode;
	vector string 255 vbrandname,vcomp,vloc,vlocname,vmaxcurr,vItemOrNr;
	vector val vlocinst,itemQTyOR,vPUITQty,vPOITQty,vSHITEMQTy, ORrwQuant, ORrwShipd2;
	vector date vItemOrDate;
	record BPIBrandVc BPIBr;
	record WEBReservStock WRSb;
	boolean entf,locfnd;
	record ItemDuplicatesVc IDr;
	vector boolean OrigCodes;
	vector string 255 OrigBrandCodes, vMainItemCodes, vItemVeCodes;
	array string 255 aOrigGlobalCodes,acomp;
	string 150 fn, ClientCode, ClientName, CompanyName;
	record PLVc PLr;
	area BodyAr;
	string 255 FileName, POSerNrstr, Companystr, ClName;
	vector integer vmaxcomp;
	record ORVc ORr, compORr;
	row ORVc ORrw, compORrw;
	record RLinkVc RLinkr, RLink2r;
	record POVc POr, compPOr;
	row POVc POrw;
	record PUVc PUr;
	row PUVc PUrw;
	integer pos;
	record ConsItemVc CIr;
	date ORDate, CompPODate, PODate, PUDate, SHDate, blnkdate;
	
	
	CompQty = 35;
	OldComp = CurrentCompany;
	BlockLoad(Compb);
	
	SetCompany(28,false);
	
	itcnt = 0;
	TrHs1=true;
	FileName = "SalesReportExt/WebGetORClientStatInFile.txt";
	logtext(0,"WebGetORClientStatInFile Start");
	if (!fileexists(FileName))then begin
		while (LoopMain(POr,1,true)) begin
			if (POr.IDReguester == "Client") then begin 
				ORDate = blnkdate;
				CompPODate = blnkdate; 
				PODate = blnkdate;
				PUDate = blnkdate;
				SHDate = blnkdate;
				parttestf = false;
				allnotextestf = false;
				allexf = true;
				ClientCode = ""; 
				ClientName = ""; 
				PONr = "";
				PUNr = "";
				ClName = "";
				clearArray(aItemCodes);
				clearArray(aItemNames);
				clearArray(aItemBrand);
				ClearVector(itemQTyOR);
				clearArray(aItemQty);
				x = 0;
				for (i=0;i<matrowcnt(POr);i=i+1) begin
					matrowget(POr,i,POrw);
					INr.Code = POrw.ArtCode;
					if (ReadFIrstMain(INr,1,true)) then begin
						itemQTyOR[INr.Code] = -POrw.Quant;
						aItemCodes[x] = INr.Code;
						aItemNames[x] = INr.Name;
						aItemBrand[x] = INr.BPIBrand;
						aItemQty[x] = POrw.Quant;
						x = x + 1;
					end;
				end;
				itcnt = x;
				ClearVector(ORrwQuant);
				ClearVector(ORrwShipd2);
				ClearVector(vItemOrNr);
				ClearVector(vItemOrDate);
				CompPONr = POr.SerNr;
				CompPODate = POr.TransDate;
				ORr.CustOrdNr = POr.IDRefPRNum;
				TrHs = true;
				while (loopkey("CustOrdNr",ORr,1,TrHs)) begin
					if (ORr.CustOrdNr!=POr.IDRefPRNum) then begin TrHs = false; end;
					if (TrHs) then begin
						ClientCode = ORr.CustCode; 
						ClientName = ORr.Addr0; 
						for (i=0;i<matrowcnt(ORr);i=i+1) begin
							matrowget(ORr,i,ORrw);
							vItemOrNr[INr.Code] = ORr.SerNr;
							vItemOrDate[INr.Code] = ORr.OrdDate;
							INr.Code = ORrw.ArtCode;
							if (ReadFIrstMain(INr,1,true)) then begin
								ORrwQuant[INr.Code] = ORrwQuant[INr.Code] + ORrw.Quant;
								ORrwShipd2[INr.Code] = ORrwShipd2[INr.Code] + ORrw.Shipd2;
							end;
						end;
					end;
				end;
				clearVector(vPOITQty);
				clearVector(vPUITQty);
				clearVector(vSHITEMQTy);


				ResetLoop(ORr);
				for (i=0;i<matrowcnt(POr);i=i+1) begin
					matrowget(POr,i,POrw);
					INr.Code = POrw.ArtCode;
					if (ReadFIrstMain(INr,1,true)) then begin
						vSHITEMQTy[POrw.ArtCode] = ORrwShipd2[POrw.ArtCode];
						vPOITQty[POrw.ArtCode] = POrw.Quant;
						if (POrw.Quant>0 and ORrwShipd2[INr.Code]>0) then begin
							parttestf = true;
						end;
						if (POrw.Quant>ORrwShipd2[INr.Code]) then begin
							allexf = false;
						end;
					end;
				end;
				
				if (!parttestf) begin
					allnotextestf = true;
				end;
				
				PUtestf = false;
				i = 1;
				PONr = POr.SerNr;
				PODate = POr.TransDate;
				j = 1;
				while (ReadRecordLink(POr,j,PUr,RLink2r))begin
					if (ReadFIrstMain(PUr,1,true)) then begin
						PUNr = PUr.SerNr;
						PUDate = PUr.TransDate;
						if (PUr.OKFlag==1) then begin
							PUtestf = true;
						end;
						for (x=0;x<matrowcnt(PUr);x=x+1) begin
							matrowget(PUr,x,PUrw);
							itemQTyOR[PUrw.ArtCode] = itemQTyOR[PUrw.ArtCode] + PUrw.Quant;
							vPUITQty[PUrw.ArtCode] = PUrw.Quant;
						end;
					end;
					j = j + 1;
				end;				
				
				for (y=0;y<itcnt;y=y+1) begin
					if (allnotextestf) then begin
						if (!PUtestf) then begin
							AddTextToArea	(CompPONr & chr(09)
									& CompPODate & chr(09)
									& ClientCode & chr(09)
									& ClientName & chr(09)
									& aItemCodes[y] & chr(09)
									& aItemNames[y] & chr(09)
									& aItemQty[y] & chr(09)
									& vItemOrNr[aItemCodes[y]] & chr(09) 
									& vItemOrDate[aItemCodes[y]] & chr(09)										//1
									&	PONr & chr(09) 																																										//2
									& PODate & chr(09)
									& vPOITQty[aItemCodes[y]] & chr(09)		
									& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
									& vSHITEMQTy[aItemCodes[y]] & chr(09)
									& "The order has been sent to the supplier" & chr(09) 	//+																						//4
									&	chr(13),BodyAr);
						end else begin
							PUParttestf = false;
							for (x=0;x<matrowcnt(POr);x=x+1) begin
								matrowget(POr,x,POrw);
								INr.Code = POrw.ArtCode;
								if (ReadFIrstMain(INr,1,true)) then begin
									if (itemQTyOR[POrw.ArtCode]<0) then begin
										PUParttestf = true;
									end;
								end;
							end;
							if (PUParttestf) then begin
								AddTextToArea	(CompPONr & chr(09)
									& CompPODate & chr(09)
									& ClientCode & chr(09)
									& ClientName & chr(09)
									& aItemCodes[y] & chr(09)
									& aItemNames[y] & chr(09)
									& aItemQty[y] & chr(09)
									& vItemOrNr[aItemCodes[y]] & chr(09) 
									& vItemOrDate[aItemCodes[y]] & chr(09)										//1
									&	PONr & chr(09) 																																										//2
									& PODate & chr(09)
									& vPOITQty[aItemCodes[y]] & chr(09)		
									& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
									& vSHITEMQTy[aItemCodes[y]] & chr(09)
									& "Partial receipt made to order and not shipped" & chr(09) 						//+														//4
									&	chr(13),BodyAr);
							end else begin
								AddTextToArea	(CompPONr & chr(09)
									& CompPODate & chr(09)
									& ClientCode & chr(09)
									& ClientName & chr(09)
									& aItemCodes[y] & chr(09)
									& aItemNames[y] & chr(09)
									& aItemQty[y] & chr(09)
									& vItemOrNr[aItemCodes[y]] & chr(09) 
									& vItemOrDate[aItemCodes[y]] & chr(09)										//1
									&	PONr & chr(09) 																																										//2
									& PODate & chr(09)
									& vPOITQty[aItemCodes[y]] & chr(09)		
									& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
									& vSHITEMQTy[aItemCodes[y]] & chr(09)
									& "Receipt made by order, but not shipped" & chr(09) 					//+																			//4
									&	chr(13),BodyAr);
							end;
						end;
					end else begin
						if (parttestf and !allexf) then begin
							if (!PUtestf) then begin
								AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemCodes[y] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& vItemOrNr[aItemCodes[y]] & chr(09) 
										& vItemOrDate[aItemCodes[y]] & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "The order has been sent to the supplier" & chr(09) 	//+																						//4
										&	chr(13),BodyAr);
							end else begin
								PUParttestf = false;
								for (x=0;x<matrowcnt(POr);x=x+1) begin
									matrowget(POr,x,POrw);
									INr.Code = POrw.ArtCode;
									if (ReadFIrstMain(INr,1,true)) then begin
										if (itemQTyOR[POrw.ArtCode]<0) then begin
											PUParttestf = true;
										end;
									end;
								end;
								if (PUParttestf) then begin
								AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemCodes[y] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& vItemOrNr[aItemCodes[y]] & chr(09) 
										& vItemOrDate[aItemCodes[y]] & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "Partial receipt made to order and shipped (partial)" & chr(09) 		//+															//4
										&	chr(13),BodyAr);
								end else begin
								AddTextToArea	(CompPONr & chr(09)
										& CompPODate & chr(09)
										& ClientCode & chr(09)
										& ClientName & chr(09)
										& aItemCodes[y] & chr(09)
										& aItemNames[y] & chr(09)
										& aItemQty[y] & chr(09)
										& vItemOrNr[aItemCodes[y]] & chr(09) 
										& vItemOrDate[aItemCodes[y]] & chr(09)										//1
										&	PONr & chr(09) 																																										//2
										& PODate & chr(09)
										& vPOITQty[aItemCodes[y]] & chr(09)		
										& vPUITQty[aItemCodes[y]] & chr(09)																																	//3
										& vSHITEMQTy[aItemCodes[y]] & chr(09)
										& "Receipt made by order and shipped (partial)" & chr(09) 		//+																			//4
										&	chr(13),BodyAr);
								end;
							end;
						end;
					end;
				end;
			end;
		end;
		WriteAreaToFile	(BodyAr,FileName,0);
		runprogram("chmod","-R a+rw " & FileName);
	end;
	
	
	
  return;
end;







global
procedure RebSalesReportRn1(record RcVc RepSpec)
begin
  record LocalMachineVc LMr;
  Date sd,ed;
  Boolean TrHs,testf;
  record IVVc IVr,IV2r;
  row IVVc IVrw,IV2rw;
  integer i,keyi,mtrw,k,j;
  string 20 keystr;
  record INVc INr,dupINr;
  string 100 classname,classname2,classcode; //Edit***************************Sasha2,11:14 20.11.2014
  record DIVc DIr;
  val brandfifo;
  string 5 brandcur;
  record PLVc PLr;
  val fr,to1,to2,br1,br2;
  val curcusm,curprice,fifob1;
  boolean testf1,userlocation;
  string 255 location,tstr,OBJStr,Obj,APriceObj,MTRXLoc;
  record UserVc User;
  integer pos,headrow;
  string 50 uloc,uloc1;
  boolean updst,modef;
	val total_rebate,total_rebate_qty;//Edit***********************Vitalii 14:28 26.08.2014
  val total_qty;
  val total_cost,total_price,total_gp;
  string 200 classfind,model,brand,category, conslocation, deflocation;
  record ORVc ORr;
  record BaseCurBlock BCb;
  string 5 bcur,azn;
  val bfr,bto;
  val aznfr,aznto,fifoazn;
  val btotal_cost,btotal_price,btotal_gp;
  array val arrvals; //Edit***************************Sasha2,10:46 20.11.2014
  array string 20 arrstrs; //Edit***************************Sasha2,10:46 20.11.2014
  integer valscnt,strscnt,rangeval,rangecnt,arrsize; //Edit***************************Sasha2,12:11 20.11.2014
  val itemoccurrences; //Edit***************************Sasha2,12:11 20.11.2014
  boolean iteminf,addclassf,tmpbool;
  integer cred;
  Record CTypeVc CTyper; //Edit***************************Sasha2,12:23 11.11.2015
  integer ctypecnt,m; //Edit***************************Sasha2,12:24 11.11.2015
  array string 10 typeindex; //Edit***************************Sasha2,14:08 11.11.2015
  vector string 255 dispnames; //Edit***************************Sasha2,14:08 11.11.2015
  record IVVc locIVr;
  vector string 20 typeval; //Edit***************************Sasha2,14:11 08.02.2016
  array string 20 typecode; //Edit***************************Sasha2,14:11 08.02.2016
  vector string 200 typename; //Edit***************************Sasha2,14:11 08.02.2016
  record DiCheckBlock DiCb; //Edit***************************Sasha2,14:10 08.02.2016
  row DiCheckBlock DiCbw; //Edit***************************Sasha2,14:10 08.02.2016
  integer rwcnt,typescnt,pos1; //Edit***************************Sasha2,14:11 08.02.2016
  Boolean collf,metalf; //Edit***************************Sasha2,14:09 02.06.2016
  string 20 collstr,metalstr; //Edit***************************Sasha2,14:09 02.06.2016
  vector val currencyBalances; //Edit***************************Sasha2,15:49 13.09.2017
	array string 10 addCurs; //Edit***************************Sasha2,15:50 13.09.2017
	Boolean additionalCurF, testf2; //Edit***************************Sasha2,10:33 14.09.2017
	val EURprice,EURcusm; //Edit***************************Sasha2,11:26 14.09.2017
	record CurncyCodeVc CurncyCoder; //Edit***************************Sasha2,13:55 14.09.2017
	record OldDIVc OldDIr;
  record ObjVc Objr;
	vector boolean userbrand;
  boolean userbrandf;
  record MarketingVc MCr;
  vector string 200 vVisitName,vVisitPhone;
  record CUVc CUr;
	record LCCashbackLevelVc LCCBLevelr;
  row LCCashbackLevelVc LCCBLevelrw;
  record LoyaltyCardVc LoyaltyCardr;
  roundmode rnd;
  Boolean found;
  Integer rowcnt;
  val loyCardPointsBalance,cashbackPercent;
	record ItemDuplicatesVc IDr;
  vector string 255 DubCodes;
	record LocationVc Locr;

	
	
  userbrandf = CheckUserBrands(currentuser,userbrand);
	
  blockload(BCb);
  bcur = BCb.BaseCur1;
	azn = "AZN";
	if(currentcompany==10)THEN BEGIN
		azn = "PLN";
	end;
	if(currentcompany==11 or currentcompany==12)THEN BEGIN
		azn = "IRR";
	end;
	headrow = 2;
  //SetLangMode(LangRussian,"RUS",0);
  		
  	
    StartReportJob(USetStr(31041)); //Edit***************************Sasha2,16:57 19.11.2014 {
    
    sd = RepSpec.sStartDate;
    ed = RepSpec.sEndDate;
    location = RepSpec.f1;
		Locr.Code = location;
		if (ReadFirstMain(Locr,1,true)) then begin
			if (nonblank(Locr.ConsigStockCode)) then begin
				conslocation = Locr.ConsigStockCode;
			end;
			if (nonblank(Locr.DefectStockCode)) then begin
				deflocation = Locr.DefectStockCode;
			end;
		end;
    
    Header(headrow,USetStr(13835) & sd & ":" & ed,0);
    headrow = headrow + 1;
    
    if (NonBlank(location)) then begin
  		Header(headrow,USetStr(31097) & ": " & location,0);
  	end else begin
  		Header(headrow,USetStr(31097) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	if (NonBlank(RepSpec.f2)) then begin
  		Header(headrow,USetStr(11605) & RepSpec.f2,0);
  	end else begin
  		Header(headrow,USetStr(11605) & USetStr(12727),0);
  	end;
    headrow = headrow + 1;
    
    if (NonBlank(RepSpec.f4)) then begin
  		Header(headrow,USetStr(31044) & ": " & RepSpec.f4,0);
  	end else begin
  		Header(headrow,USetStr(31044) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	if (NonBlank(RepSpec.f5)) then begin
  		Header(headrow,USetStr(8833) & ": " & RepSpec.f5,0);
  	end else begin
  		Header(headrow,USetStr(8833) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	EndHeader; //Edit***************************Sasha2,16:57 19.11.2014 }
  	
  	if (NonBlank(RepSpec.f7)) then begin //Edit***************************Sasha2,16:02 13.09.2017 {
  	  CurncyCoder.CurncyCode = RepSpec.f7;
  	  if (ReadFirstMain(CurncyCoder,1,true)) then begin
    	  addCurs[addCurs.length] = CurncyCoder.CurncyCode; 
    	  additionalCurF = true;
  	  end;
  	end;//Edit***************************Sasha2,16:02 13.09.2017 }
  	
  	if (CompanyIsJWLikeCompany(CurrentCompany)) then begin //Edit***************************Sasha2,11:27 02.06.2016 {
  	  addclassf = true;
  	end else begin
  	  addclassf = false;
  	end; 

  	if (addclassf) then begin
      typescnt = 0;
  	  BlockLoad(DiCb);
      rwcnt = MatRowCnt(DiCb);  
      for (j=0;j<rwcnt;j=j+1) begin
        MatRowGet(DiCb,j,DiCbw);
        if (NonBlank(DiCbw.DiType)) then begin
          DIr.Code = DiCbw.DiCode;
          ReadFirstMain(DIr,1,true);
          DiCbw.DiType = DIr.CType & "," & DiCbw.DiType;
          pos = 0;
    			ExtractObj(DiCbw.DiType,pos,uloc);
    			while (nonblank(uloc)) begin
    				if (blank(typeval[uloc])) then begin
      				CTyper.Code = uloc;
      				if (ReadFirstMain(CTyper,1,true)) then begin
      				  if (CTyper.Code=="GENDER") then begin
      				    switch (UpperCase(Left(DiCbw.DiCode,1))) begin
      				      case "A":
      				        if (blank(typeval[CTyper.Code & "_A"])) then begin
        				        typeval[CTyper.Code & "_A"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_A";
              				  typename[typecode[typescnt]] = "ACCESSORIES " & CTyper.Comment;
              				  typescnt = typescnt + 1;  
      				        end;
      				      case "J":
      				        if (blank(typeval[CTyper.Code & "_J"])) then begin
        				        typeval[CTyper.Code & "_J"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_J";
              				  typename[typecode[typescnt]] = "JEWELRY " & CTyper.Comment;
              				  typescnt = typescnt + 1;  
      				        end;
      				      case "W":
      				        if (blank(typeval[CTyper.Code & "_W"])) then begin
        				        typeval[CTyper.Code & "_W"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_W";
              				  typename[typecode[typescnt]] = "WATCH " & CTyper.Comment;
              				  typescnt = typescnt + 1;
      				        end;
      				    end;
      				  end else begin
        				  typeval[CTyper.Code] = ".";
        				  typecode[typescnt] = CTyper.Code;
        				  typename[CTyper.Code] = CTyper.Comment;
        				  typescnt = typescnt + 1;  
      				  end;
      				end;
    				end;
    				ExtractObj(DiCbw.DiType,pos,uloc);
    			end;
        end;
      end;
      SortAndClearClassifications(typecode,typename,typescnt);
    end;//Edit***************************Sasha2,11:27 02.06.2016 }

  	if (RepSpec.ArtMode==0) then begin
  		modef = true;
  	end else begin
  		modef = false;
  		RECORDNEW(IV2r);
  	end;
  
		userlocation = false;
		User.Code = currentuser;
		if(readfirstmain(User,1,true))then begin
			if(nonblank(User.UserLocations) and usercanaction("AllowReportWithUserLoc",false))then begin
				userlocation = true;
				pos = 0;
				ExtractObj(User.UserLocations,pos,uloc);
				while (nonblank(uloc)) begin
					if(uloc==location)then begin
						userlocation = false;
					end;
					ExtractObj(User.UserLocations,pos,uloc);
				end;
			end;
		end;
	
    if(userlocation)then begin
			startformat(15);
				outstring(50,0,USetStr(31014),false);
			endformat;
		end else begin
			if(nonblank(RepSpec.sStartDate) and nonblank(RepSpec.sEndDate))then begin
				StartFormat(15);
					outstring(0,0,USetStr(31102),false);
					outstring(40,0,RepSpec.sStartDate & ":" & RepSpec.sEndDate,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31103),false);
					if(nonblank(RepSpec.f1))then begin
						outstring(40,0,RepSpec.f1,false);
					end else begin
						outstring(40,0,USetStr(31104),false);
					end;
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31105),false);
					outstring(40,0,RepSpec.f2,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31205),false);
					outstring(40,0,RepSpec.f4,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31206),false);
					outstring(40,0,RepSpec.f5,false);
				endformat;
				StartFormat(15);
				endformat;
				
				
				
				startformat(15);
					outstring(0,0,USetStr(31042),false);
					outstring(0,0,USetStr(31043),false);
					if (RepSpec.ArtMode==0) then begin
						outstring(0,0,USetStr(36287),false); // Orirginal item code
						outstring(0,0,"Коды дубликатов",false);
					end;
					outstring(0,0,USetStr(12815),false); //Sklad
					if (modef) then begin
						outstring(0,0,USetStr(31044),false); //Brand
						if (addclassf==false) then begin //Edit***************************Sasha2,13:15 02.06.2016
							outstring(0,0,USetStr(19357),false); //Klassificatsia
						end;
						if(currentcompany==9)then begin
							outstring(0,0,USetStr(9131),false);		//Edit----------------------Dima  20.03.2015 //categoria
						end;
						outstring(0,0,USetStr(12713),false); //Naimenovanie
						if (addclassf==false And CurrentCompany==9) then begin //Edit***************************Sasha2,13:17 02.06.2016 {
							outstring(0,0,USetStr(31045),false);//Reference //Kollectsia
							outstring(0,0,USetStr(31047),false); //Tip metalla
							outstring(0,0,USetStr(14533),false); //Ves
							outstring(0,0,USetStr(31048),false); //Karatnost
							//if(CompanyIsJWLikeCompany(currentcompany))then begin
								//outstring(0,0,USetStr(31049),false); //Braslet/Remeshok
								//outstring(0,0,USetStr(31050),false); //Tsvet tsyferblata
							//end;
							if(currentcompany==13)then begin		//Edit-----------------------------Dima  30.04.2015
								outstring(0,0,USetStr(31320),false); //Tsvet
								outstring(0,0,USetStr(35007),false); //Kvadratura
							end else begin		
							outstring(0,0,USetStr(31320),false); //Tsvet//Edit_-_-_-_-_-_-_-_-Anton 13:42 07.05.2018
							outstring(0,0,USetStr(31321),false); //Razmer//Edit_-_-_-_-_-_-_-_-Anton 13:25 07.05.2018
						end;
						end else begin //Edit***************************Sasha2,13:17 02.06.2016 }
						 // for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
							 // outstring(0,0,typename[typecode[j]],false);
							//end;
						end;
					end;
					// if(CurrentCompany!=9) then begin
						// outstring(0,0,"Reference",false);
						// outstring(0,0,"Group",false); 
						// outstring(0,0,"SubGroup",false);
						// outstring(0,0,"Category",false);
						// if(currentcompany==25)then begin
							// outstring(0,0,"CC Collection",false); 
							// outstring(0,0,"Product Group",false); 							
						// end;
						// outstring(0,0,"Material",false); 		
						// if(currentcompany==13)then begin
							// outstring(0,0,"Size",false);
							// outstring(0,0,"Colour",false); 
						// end else begin
							// outstring(0,0,"Colour",false); 
							// outstring(0,0,"Size",false); 
						// end;						
						// if(CompanyIsJWLikeCompany(currentcompany))then begin
							// outstring(0,0,"Кар.",false); 
							// outstring(0,0,"JW Weight",false);
							// outstring(0,0,"SAP",false);
						// end;					
						// outstring(0,0,"Use",false);
						// outstring(0,0,"Sex",false);
						// outstring(0,0,"Plating",false);						
						// outstring(0,0,"Collection",false); 
						// outstring(0,0,"Clarity",false);
						// outstring(0,0,"Weight",false); 
						// outstring(0,0,"Cut",false); 
						// outstring(0,0,"Shape",false);
						// outstring(0,0,"Stone",false); 
						// outstring(0,0,"Strap",false);
						// outstring(0,0,"Odour",false);
						// outstring(0,0,"Year",false); 
						// outstring(0,0,"High",false); 
					// end;
					
					
					
					if(CurrentCompany!=9 and modef) then begin   // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 13:49 06.11.2020
						outstring(0,0,"Reference",false);
						outstring(0,0,"Collection",false); 
						outstring(0,0,"Group",false); 
						outstring(0,0,"SubGroup",false);
						outstring(0,0,"Category",false);
						outstring(0,0,"Material",false); 		
						outstring(0,0,"Colour",false); 
						outstring(0,0,"Year",false); 
						outstring(0,0,"Life",false); 
						outstring(0,0,"Size",false); 
						outstring(0,0,"Use",false);
						outstring(0,0,"Sex",false);
						outstring(0,0,"Plating",false);	
						outstring(0,0,"CC Collection",false); 						
						outstring(0,0,"Clarity",false);
						outstring(0,0,"Weight",false); 
						outstring(0,0,"Cut",false); 
						outstring(0,0,"Shape",false);
						outstring(0,0,"Stone",false); 
						outstring(0,0,"Strap",false);
						outstring(0,0,"Odour",false);
						outstring(0,0,"Product Group",false);
						if(CompanyIsJWLikeCompany(currentcompany))then begin
							outstring(0,0,"Кар.",false); 
							outstring(0,0,"JW Weight",false);
							outstring(0,0,"SAP",false);
						end;		
					end;
					
					
					
					
					
					
					
					
					outstring(0,0,USetStr(31051),false); //seriinii nomer
					outstring(0,0,"EAN code",false);
					outstring(0,0,USetStr(13199),false);//EKNCode
					outstring(0,0,USetStr(31052),false);
					outstring(100,0,USetStr(31053),false);
					if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(100,0,USetStr(31055) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(101,0,USetStr(31055) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(102,0,USetStr(31055) & bcur,false);
					end;
					outstring(110,0,USetStr(31056),false);
					if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
					  outstring(110,0,USetStr(31058) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
					  outstring(111,0,USetStr(31058) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(112,0,USetStr(31058) & bcur,false);
					end;
					outstring(120,0,USetStr(31059),false);
					if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(120,0,USetStr(31061) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(121,0,USetStr(31061) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(122,0,USetStr(31061) & bcur,false);
					end;
					outstring(130,0,USetStr(31062),false);
					if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(130,0,USetStr(31064) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(131,0,USetStr(31064) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(132,0,USetStr(31064) & bcur,false);
					end;
					outstring(140,0,USetStr(31065),false);
					if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(140,0,USetStr(31067) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(141,0,USetStr(31067) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(142,0,USetStr(31067) & bcur,false);
					end;
					outstring(0,0,USetStr(31068),false);
					if (modef) then begin
						if(usercanaction("ViewCustomerInfo",true))then begin
							outstring(0,0,USetStr(31069),false);
							outstring(0,0,USetStr(31070),false);
							if(RepSpec.flags[2]==1)then begin
								outstring(0,0,"Телефон клиента",false);
								outstring(0,0,"Фиксация визитов: Имя",false);
								outstring(0,0,"Фиксация визитов: Телефоны",false);
								outstring(0,0,"Карта лояльности",false);
								outstring(0,0,"Пол",false);
								outstring(0,0,"Возраст",false);
							end;
						end;
						
						outstring(0,0,USetStr(31071),false);
						outstring(0,0,USetStr(16709),false);
							outstring(0,0,USetStr(36286),false);
						outstring(0,0,USetStr(31072),false);
						outstring(0,0,USetStr(9269),false);
						
						outstring(0,0,USetStr(16574),false);
						if(currentcompany==9)then begin
							outstring(0,0,USetStr(3264),false);
						end;
						outstring(0,0,USetStr(36250),false);
						outstring(0,0,"Код доп. скидки",false);
						outstring(0,0,USetStr(31073),false);
						outstring(0,0,"Fiscal number",false);
					end;
					if(currentcompany==25 and RepSpec.flags[2]!=0) then begin
						outstring(0,0,"Текущий процент при покупке",false);
					end;
					//if (addclassf) then begin //Edit***************************Sasha2,14:00 08.02.2016 {
    			 // for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
      		 //   outstring(0,0,typename[typecode[j]],false);
      		 // end;
    			//end; //Edit***************************Sasha2,14:01 08.02.2016 }
					
					/*ctypecnt = 0; //Edit***************************Sasha2,14:10 11.11.2015 { 
					CTyper.Code = "";
					while (LoopMain(CTyper,1,true)) begin
					  typeindex[ctypecnt] = CTyper.Code;
					  dispnames[typeindex[ctypecnt]] = "";
					  outstring(0,0,CTyper.Code,false);
					  ctypecnt = ctypecnt + 1;
					end;*///Edit***************************Sasha2,14:10 11.11.2015 }	
				endformat;

				total_rebate = 0;//Edit***********************Vitalii 14:28 26.08.2014
				total_rebate_qty = 0;
				total_qty = 0;
				total_cost = 0;
				total_price = 0;
				total_gp = 0;
				btotal_cost = 0;
				btotal_price = 0;
				btotal_gp = 0;
				rangecnt = 0; //Edit***************************Sasha2,11:41 20.11.2014
				arrsize = 25; 
				
				//arrsize = arrsize + ctypecnt; //Edit***************************Sasha2,16:49 11.11.2015
				arrsize = arrsize + typescnt;
				
				IVr.TransDate = sd;
				keyi = 1;
				keystr = "TransDate";
				
				// _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 14:58 14.01.2020
				
				// Для вывода отчета по кодам локаций с матриц счетов-фактур не подходит следующий ключ
				
				// if(nonblank(location))then begin	
					// IVr.Location = location;
					// keyi = 2;
					// keystr = "Location";
				// end;
				
				if(RepSpec.flags[2]==1)then begin
					MCr.TransDate = sd;
					TrHs = true;
					while(loopkey("TransDate",MCr,1,TrHs))begin
						if(MCr.TransDate>ed)then begin TrHs = false; end;
					
						if(TrHs)then begin
							if(nonblank(MCr.InvNr))then begin
								pos = 0;
								tstr = "";
								ExtractObj(MCr.InvNr,pos,tstr);
								while(nonblank(tstr))begin
									if(nonblank(tstr))then begin
										vVisitName[tstr] = MCr.Name;
										vVisitPhone[tstr] = MCr.Phone3 & " " & MCr.Phone2 & " " & MCr.Phone1;
									end;
									ExtractObj(MCr.InvNr,pos,tstr);
								end;
							end;
						end;
					end;
				end;
				LCCBLevelr.LCMLevel = "CASACOIN";
				found = ReadFirstMain(LCCBLevelr,1,true);
				TrHs = true;
				while(loopkey(keystr,IVr,keyi,TrHs)) begin
					if(CurrentCompany==25 and RepSpec.flags[2]!=0) then begin
						cashbackPercent = 0;
						LoyaltyCardr.SerNr = IVr.LoyaltyCardNr;
						if ((nonblank(IVr.LoyaltyCardNr) and ReadFirstMain(LoyaltyCardr,1,true))) then begin
							rnd = DefaultValRoundoff;
							rnd.decimals = 2;
							rnd.mode = kRoundingModeHalfUp;
							loyCardPointsBalance = LoyaltyCardr.CashbackLevelPoints;
							rowcnt = MatRowCnt(IVr);							
							if (found) then begin						
								rnd.decimals = LCCBLevelr.RndTo;
								rwcnt = MatRowCnt(LCCBLevelr);
								for (i=0;i<rwcnt;i=i+1) begin
									MatRowGet(LCCBLevelr,i,LCCBLevelrw);
									if (LCCBLevelrw.FromPoints<=loyCardPointsBalance and LCCBLevelrw.CashbackPercent>0) then begin									
										if (LCCBLevelrw.ToPoints>=loyCardPointsBalance or LCCBLevelrw.ToPoints==BlankVal) then begin
											cashbackPercent = LCCBLevelrw.CashbackPercent;
											i = rwcnt;
										end;
									end;
								end;
							end;	
						end;
					end;
					testf = true;
					cred = 1;
					if(IVr.InvType==kInvoiceTypeCredit)then begin
						cred = -1;
					end;
										
					
					if(RepSpec.flags[1]!=0 and IVr.OrderNr!=-1) then begin testf = false; end;
					if(IVr.InvDate<sd)then begin testf = false; end;
					if(IVr.InvDate>ed)then begin TrHs = false; testf = false; end;
					// if(nonblank(location) and IVr.Location!=location)then begin TrHs = false; testf = false; end;
					if(IVr.OKFlag==0)then begin testf = false; end;
					if(IVr.Invalid>0)then begin testf = false; end;
					if(nonblank(RepSpec.f6) and !setinset(IVr.CustCode,RepSpec.f6))then begin testf = false; end;
					if(nonblank(RepSpec.f8) and !setinset(RepSpec.f8,IVr.Objects))then begin testf = false; end;
					if(IVr.PriceList!="RRP" and IVr.PriceList!="CC" and RepSpec.flags[3]!=0) then begin testf = false; end;
					
					if(RepSpec.flags[4]==1)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 21 09 2020 y. at 11:38:16 AM
						if(IVr.ECOMMERCEOrdf==0)then begin
							testf = false;
						end;
					end;
					if(RepSpec.flags[4]==2)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 01, 21 09 2020 y. at 11:38:16 AM
						if(IVr.ECOMMERCEOrdf!=0)then begin
							testf = false;
						end;
					end;
					
					if(RepSpec.flags[6]==1)then begin
					  if(blank(IVr.TaxTransactionCode))then begin
					    testf = false;
					  end;
					end;
					
					if(testf)then begin
						mtrw = matrowcnt(IVr);
						
						tstr = "";
						For(i=0;i<mtrw;i=i+1) begin
	  					matrowget(IVr,i,IVrw);
	  					if(setinset(IVrw.PayMode,tstr)==false)then begin
	  						if(nonblank(tstr))then begin
	  							tstr = tstr & ",";
	  						end;
	  						tstr = tstr & IVrw.PayMode;
	  					end;
						end; 
						
						if(RepSpec.flags[2]==1)then begin
							CUr.Code = IVr.CustCode;
							readfirstmain(CUr,1,true);
						end;
						
						For(i=0;i<mtrw;i=i+1) begin
							testf2 = true;
							matrowget(IVr,i,IVrw);
							matrowget(IVr,i,IV2rw);
							
							if(nonblank(IVrw.Location))then begin // conslocation, deflocation
								if(nonblank(location) and IVrw.Location!=location and IVrw.Location!=conslocation and IVrw.Location!=deflocation)then begin testf2 = false; end;
							end else begin
								if(nonblank(location) and IVr.Location!=location and IVr.Location!=conslocation and IVr.Location!=deflocation)then begin testf2 = false; end;
							end;
							if(testf2)then begin
								if(IVrw.stp==kInvoiceRowTypeGiftVoucherSold and blank(RepSpec.f4) and blank(RepSpec.f5) and blank(RepSpec.f2) and blank(RepSpec.f9) and blank(RepSpec.f10) and userbrandf==false)then begin
									PrintGftSertSold(IVr,i,total_price,bcur,azn,addclassf, modef);
								end;
								if(IVrw.stp==kInvoiceRowTypeNormal and nonblank(IVrw.ArtCode))then begin
									INr.Code = IVrw.ArtCode;
									readfirstmain(INr,1,true);
									if(IVrw.vRebate!=0)then begin testf1=true; end;
									IDr.DupCode = IVrw.ArtCode;
									INr.Code = IVrw.ArtCode;
									if(RepSpec.flags[5]==1 and INr.ConsgType!=1) then begin testf1 = false; end;
									if(ReadFirstKey("DupCode",IDr,1,true) and testf1) then begin
										dupINr.Code = IDr.OrigCode;
										while(LoopMain(dupINr,1,testf2)) begin
											if(dupINr.Code!=IDr.OrigCode) then begin testf2 = false; end;
											if(dupINr.BPIBrand==IDr.OrigBrandCode and testf2) then begin
												INr.Code = IDr.OrigCode;
												DubCodes[IDr.OrigCode] = IDr.DupCode;
											end;
										end;
									end;
									readfirstmain(INr,1,true);
									testf2=true;
								
									if(RepSpec.flags[0]==1 and INr.OutOfOrder==1)then begin testf1 = false; end;
									if(nonblank(RepSpec.f2) and testf1)then begin
										testf1=SetInSet2(RepSpec.f2,INr.DispGroups);
									end;
									if(nonblank(RepSpec.f9) and !setinset(RepSpec.f9,IVrw.Objects))then begin testf1 = false; end;
									if(nonblank(RepSpec.f10) and RepSpec.f10!=IVrw.ArtCode)then begin testf1 = false; end;
									
									if(userbrandf and testf1)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 19 06 2019 y. at 4:35:18 PM
										pos = 0;
										brand = "";
										testf1 = false;
										ExtractObj(INr.DispGroups,pos,brand);
										while(nonblank(brand)) begin
											if(userbrand[brand])then begin
												testf1 = true;
											end;
											ExtractObj(INr.DispGroups,pos,brand);
										end;
									end;
									
									if(testf1)then begin
										if(nonblank(RepSpec.f4) or nonblank(RepSpec.f5))then begin
											brand = "";
											model = "";
											category = "";
											pos = 0;
											classfind = "";
											ExtractObj(INr.DispGroups,pos,classfind);
											while(nonblank(classfind)) begin
												DIr.Code = classfind;
												readfirstmain(DIr,1,true);
												if(DIr.CType=="BRAND")then begin
													brand = DIr.Code;
												end;
												if(DIr.CType=="MODEL")then begin
													model = DIr.Code;
												end;
												ExtractObj(INr.DispGroups,pos,classfind);
											end;
											if(nonblank(RepSpec.f4) and brand!=RepSpec.f4)then begin
												testf1 = false;
											end;
											if(nonblank(RepSpec.f5) and model!=RepSpec.f5)then begin
												testf1 = false;
											end;
										end;
									end;
									
									if(testf1) then begin
										pos = 0;
										brand = "";
										model = "";
										if (addclassf) then begin //Edit***************************Sasha2,14:05 02.06.2016 {
											ExtractObj(INr.DispGroups,pos,uloc);
											while (NonBlank(uloc)) begin
												DIr.Code = uloc;
												if (readfirstmain(DIr,1,true)) then begin
													if (DIr.CType=="BRAND") then begin
														brand = DIr.Name;
													end;
													if (DIr.CType=="MODEL") then begin
														model = DIr.Name;
													end;
													if (NonBlank(DIr.CType)) then begin 
														if (DIr.CType=="GENDER") then begin
															switch (Left(UpperCase(INr.MainDisp),1)) begin
																case "A":
																	DIr.CType = DIr.CType & "_A";
																	typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
																case "J":
																	DIr.CType = DIr.CType & "_J";
																	typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
																case "W":
																	DIr.CType = DIr.CType & "_W";
																	typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
															end;
														end else begin
															typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
															switch (Left(UpperCase(INr.MainDisp),1)) begin //if classifications in custom separate fields {
																case "A":
																	if (NonBlank(INr.Reference)) then begin
																		collf = true;
																		collstr = "COLL_A";
																	end;
																	if (NonBlank(INr.Metal)) then begin
																		metalf = true;
																		metalstr = "MATERIAL_A";
																	end;
																case "J":
																	if (NonBlank(INr.Reference)) then begin
																		collf = true;
																		collstr = "COLL_J";
																	end;
																	if (NonBlank(INr.Metal)) then begin
																		metalf = true;
																		metalstr = "MATERIAL_J";
																	end;
																	if (NonBlank(INr.RowWeight)) then begin
																		tstr = typeval["WEIGHT"];
																		pos1 = 0;
																		ExtractObj(tstr,pos1,uloc1);
																		if (uloc1==INr.Code) then begin
																			ExtractObj(tstr,pos1,uloc1);
																			if (blank(uloc1)) then begin
																				typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
																			end;
																		end else begin
																			typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
																		end;
																	end;
																	if (NonBlank(INr.MajStoneDet)) then begin
																		tstr = typeval["D_CARAT"];
																		pos1 = 0;
																		ExtractObj(tstr,pos1,uloc1);
																		if (uloc1==INr.Code) then begin
																			ExtractObj(tstr,pos1,uloc1);
																			if (blank(uloc1)) then begin
																				typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
																			end;
																		end else begin
																			typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
																		end;
																	end;
																case "W":
																	if (NonBlank(INr.Reference)) then begin
																		collf = true;
																		collstr = "COLL_W";
																	end;
																	if (NonBlank(INr.Metal)) then begin
																		metalf = true;
																		metalstr = "MATERIAL_W";
																	end;
															end; 
															if (collf) then begin
																tstr = typeval[collstr];
																pos1 = 0;
																ExtractObj(tstr,pos1,uloc1);
																if (uloc1==INr.Code) then begin
																	ExtractObj(tstr,pos1,uloc1);
																	if (blank(uloc1)) then begin
																		typeval[collstr] = INr.Code & ";" & INr.Reference;
																	end;
																end else begin
																	typeval[collstr] = INr.Code & ";" & INr.Reference;
																end;  
																collf = false;
															end;
															if (metalf) then begin
																tstr = typeval[metalstr];
																pos1 = 0;
																ExtractObj(tstr,pos1,uloc1);
																if (uloc1==INr.Code) then begin
																	ExtractObj(tstr,pos1,uloc1);
																	if (blank(uloc1)) then begin
																		typeval[metalstr] = INr.Code & ";" & INr.Metal;
																	end;
																end else begin
																	typeval[metalstr] = INr.Code & ";" & INr.Metal;
																end;
																metalf = false;
															end;//if classifications in custom separate fields }
														end;
													end;
												end; //Edit***************************Sasha2,14:05 02.06.2016 }
												ExtractObj(INr.DispGroups,pos,uloc);
											end;
										end;
										if (modef) then begin
											startformat(15);
										end;
											if (modef) then begin
												if(Left(INr.Code,3)=="IN_") then begin
													outstring(0,0,INr.AlternativeCode,false);
													outstring(0,0,INr.Code,false);
												end else begin
													if (left(INr.Code,2)=="IN" and currentcompany==29) then begin
														outstring(0,0,Right(INr.GlobalArtCode,len(INr.GlobalArtCode)-9),false);
														outstring(0,0,INr.Code,false);
													end else begin
														outstring(0,0,INr.Code,false);
														outstring(0,0,INr.AlternativeCode,false);
													end;
												end;
												outstring(0,0,INr.OrigCode,false);  // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:48 27.08.2019
												outstring(0,0,DubCodes[INr.Code],false);
												if(nonblank(IVrw.Location))then begin
													outstring(0,0,IVrw.Location,false);
												end else begin
													outstring(0,0,IVr.Location,false);
												end;
												
												if (addclassf==false) then begin
													classname = "";
													if(nonblank(INr.BPIBrand)) then begin
														outstring(0,0,BPICodeToName(INr.BPIBrand),false);
													end else begin
														if (currentcompany==29) then begin
															if (nonblank(GetECItemBrand(INr.GlobalArtCode))) then begin
																outstring(0,0,GetECItemBrand(INr.GlobalArtCode),false);
															end else begin
																outstring(0,0,"",false);
															end;
														end else begin
															outstring(0,0,"",false);
														end;
													end;
													classname2 = "";
													k=0;
													ExtractObj(INr.DispGroups,k,classcode);
													DIr.Code = classcode;
													readfirstmain(DIr,1,true);
													classname2 = DIr.Name;
													if(currentcompany==9) then begin
														category = DIr.CCat;	//Edit----------------------Dima  20.03.2015
													end;	
													if(currentcompany==13)then begin										
														outstring(0,0,DIr.Name,false);
													end else begin
														outstring(0,0,BPICodeToName(INr.BPICollection),false);
													end;
													//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
												end else begin //Edit***************************Sasha2,14:11 02.06.2016 {
													if(nonblank(INr.BPIBrand)) then begin
														outstring(0,0,BPICodeToName(INr.BPIBrand),false);
													end else begin
														outstring(0,0,brand,false);
													end;	
												end; //Edit***************************Sasha2,14:11 02.06.2016 ]

												
												/*ExtractObj(INr.DispGroups,k,classcode); //Edit***************************Sasha2,14:52 11.11.2015 {
												while (NonBlank(classcode)) begin
													DIr.Code = classcode;
													if (readfirstmain(DIr,1,true)) then begin
														dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ",";
													end;
													ExtractObj(INr.DispGroups,k,classcode);
												end;*/ //Edit***************************Sasha2,14:52 11.11.2015 }
												
												if(currentcompany==9) then begin
													outstring(0,0,category,false);
													outstring(0,0,prepareStr(IVrw.Spec),false);
													outstring(0,0,INr.Reference,false);
													outstring(0,0,BPICodeToName(INr.BPIMaterial),false);
													outstring(0,0,INr.MajStoneDet,false);
													outstring(0,0,INr.SN,false);
													outstring(0,0,BPICodeToName(INr.BPISize),false);
													outstring(0,0,BPICodeToName(INr.BPIColor),false);		
												end else begin
													outstring(0,0,prepareStr(IVrw.Spec),false);
													outstring(0,0,INr.Reference,false);
													outstring(0,0,BPICodeToName(INr.BPICollection),false); 
													outstring(0,0,BPICodeToName(INr.BPIGroup),false); 
													outstring(0,0,BPICodeToName(INr.BPISubGroup),false); 
													outstring(0,0,BPICodeToName(INr.BPICategory),false); 
													outstring(0,0,BPICodeToName(INr.BPIMaterial),false);
													outstring(0,0,BPICodeToName(INr.BPIColor),false);//Edit_-_-_-_-_-_-_-_-Anton 13:26 07.05.2018	
													outstring(0,0,INr.High,false);
													outstring(0,0,INr.Life2,false);
													outstring(0,0,BPICodeToName(INr.BPISize),false);//Edit_-_-_-_-_-_-_-_-Anton 13:26 07.05.2018
													outstring(0,0,BPICodeToName(INr.BPIUse),false);
													outstring(0,0,BPICodeToName(INr.BPISex),false); 	
													outstring(0,0,BPICodeToName(INr.BPIPlating),false);		
													if (INr.BPIBrand=="BRND0046") then begin
														outstring(0,0,INr.CCCollectName,false);
													end else begin
														outstring(0,0,"",false);
													end;						
													outstring(0,0,BPICodeToName(INr.BPIClarity),false);
													outstring(0,0,BPICodeToName(INr.BPIWeight),false);	
													outstring(0,0,BPICodeToName(INr.BPICut),false); 
													outstring(0,0,BPICodeToName(INr.BPIShape),false);    
													outstring(0,0,BPICodeToName(INr.BPIStone),false); 
													outstring(0,0,BPICodeToName(INr.BPIStrap),false); 
													outstring(0,0,BPICodeToName(INr.BPIOdour),false);
													if (CurrentCompany==25) then begin
														outstring(0,0,INr.SNOne,false);
													end else begin
														outstring(0,0,"",false);
													end;
													if(CompanyIsJWLikeCompany(currentcompany))then begin
														outstring(0,0,INr.RowWeight,false);
														outstring(0,0,INr.MajStoneDet,false);
														outstring(0,0,INr.SN,false);
													end;
												end else begin
													/*for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
														pos = 0;
														ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
														if (uloc==INr.Code) then begin
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															outstring(0,0,uloc,false);
														end else begin
															outstring(0,0,"",false);
														end;
													end;*/
												end; //Edit***************************Sasha2,14:21 02.06.2016 }
												
												outstring(0,0,IVrw.SerialNr,false);
												outstring(0,0,INr.BarCode,false);
												outstring(0,0,INr.EKNCode,false);
												outstring(0,0,IVrw.Quant*cred,false);
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												if(nonblank(IVrw.Location))then begin
													rangeval = CalculateCoef(IV2r,rangecnt,IVrw.ArtCode,IVrw.Location,iteminf,arrsize);
												end else begin
													rangeval = CalculateCoef(IV2r,rangecnt,IVrw.ArtCode,IVr.Location,iteminf,arrsize);
												end;
												valscnt = rangeval;
												strscnt = rangeval;
												if (iteminf==false) then begin
													arrstrs[strscnt] = IVrw.ArtCode; strscnt = strscnt + 1;
													arrstrs[strscnt] = INr.AlternativeCode; strscnt = strscnt + 1;
													if(nonblank(IVrw.Location))then begin
														arrstrs[strscnt] = IVrw.Location; strscnt = strscnt + 1;
													end else begin
														arrstrs[strscnt] = IVr.Location; strscnt = strscnt + 1;
													end;
													
													if (addclassf==false) then begin
														classname = "";
														k=0;
														ExtractObj(INr.DispGroups,k,classcode);
														DIr.Code = classcode;
														readfirstmain(DIr,1,true);
														classname = DIr.Name;
														//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
														arrstrs[strscnt] = classname; strscnt = strscnt + 1;
														
														classname2 = "";
														ExtractObj(INr.DispGroups,k,classcode);
														DIr.Code = classcode;
														readfirstmain(DIr,1,true);
														classname2 = DIr.Name;
														//dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ","; //Edit***************************Sasha2,14:50 11.11.2015
														arrstrs[strscnt] = classname2; strscnt = strscnt + 1;
													end else begin //Edit***************************Sasha2,14:23 02.06.2016 {
														arrstrs[strscnt] = brand; strscnt = strscnt + 1;
													end; //Edit***************************Sasha2,14:23 02.06.2016 }
													
													arrstrs[strscnt] = prepareStr(IVrw.Spec); strscnt = strscnt + 1;
													if (addclassf==false) then begin //Edit***************************Sasha2,14:21 02.06.2016 {
														arrstrs[strscnt] = INr.Reference; strscnt = strscnt + 1; 
														arrstrs[strscnt] = INr.Metal; strscnt = strscnt + 1; 
														arrstrs[strscnt] = INr.RowWeight;strscnt = strscnt + 1;
														arrstrs[strscnt] = INr.MajStoneDet; strscnt = strscnt + 1;
														//if(CompanyIsJWLikeCompany(currentcompany))then begin
															//arrstrs[strscnt] = INr.BrcStr; strscnt = strscnt + 1; 
															//arrstrs[strscnt] = INr.Gender; strscnt = strscnt + 1;
														//end;
														if(currentcompany==13)then begin	//Edit----------------------Dima  30.04.2015
															arrstrs[strscnt] = INr.Size; strscnt = strscnt + 1; 
															arrstrs[strscnt] = INr.Colour; strscnt = strscnt + 1;
														end;	  
													end else begin
														for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
															pos = 0;
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															if (uloc==INr.Code) then begin
																ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
																arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
															end else begin
																arrstrs[strscnt] = ""; strscnt = strscnt + 1;
															end;
														end;
													end; //Edit***************************Sasha2,14:21 02.06.2016 }
													//arrstrs[strscnt] = ""; strscnt = strscnt + 1;											
													arrstrs[strscnt] = INr.BarCode; strscnt = strscnt + 1;
													arrstrs[strscnt] = INr.EKNCode; strscnt = strscnt + 1;
													
													/*ExtractObj(INr.DispGroups,k,classcode); //Edit***************************Sasha2,14:52 11.11.2015 {
													while (NonBlank(classcode)) begin
														DIr.Code = classcode;
														if (readfirstmain(DIr,1,true)) then begin
															dispnames[DIr.CType] = dispnames[DIr.CType] & classcode & ",";
														end;
														ExtractObj(INr.DispGroups,k,classcode);
													end; *///Edit***************************Sasha2,14:52 11.11.2015 }
													
												end else begin
													if(addclassf)then begin
														strscnt = strscnt + 7 + typescnt;
													end else begin
														if (currentcompany==13) then begin
															strscnt = strscnt + 14;
														end else begin
															strscnt = strscnt + 12;
														end;
													end;
												end;
												arrvals[valscnt] = arrvals[valscnt] + IVrw.Quant * cred; valscnt = valscnt + 1;
											end; //Edit***************************Sasha2,11:18 20.11.2014 }
											
											total_qty = total_qty + IVrw.Quant;
											fr = IVr.FrRate;
											to1 = IVr.ToRateB1;
											if(fr==0 or to1==0)then begin
												fr = 1;
												to1 = 1;
											end;
											IVrw.Price = IVrw.Price/fr*to1;
											IVrw.Sum = IVrw.Sum/fr*to1;
											
											if(IVr.UpdStockFlag>0 and IVr.OrderNr<0)then begin
												updst = true;
											end else begin
												updst = false;
											end;
											
											
											FindFIFOOrigValAndCurncyIV(IVr.SerNr,i,brandfifo,brandcur,fifob1,updst,addCurs,currencyBalances,additionalCurF,tmpbool); //Edit***************************Sasha2,16:02 13.09.2017
											if(fifob1==0)then begin
											  if(IVrw.FIFORowVal==0)then begin
											    fifob1 = IVrw.FIFORowVal;
											  end else begin
                          fifob1 = INr.WeighedAvPrice * IVrw.Quant;
												end;
											end;
											if(brandfifo==0)then begin
												brandfifo = INr.LastPurchPrice2 * IVrw.Quant;
											end;
											
											
											brandfifo = AbsoluteVal(brandfifo/IVrw.Quant);
											fifob1 = AbsoluteVal(fifob1/IVrw.Quant);
											for (j=0;j<addCurs.length;j=j+1) begin //Edit***************************Sasha2,11:46 14.09.2017 {
												currencyBalances[addCurs[j]] = AbsoluteVal(currencyBalances[addCurs[j]]/IVrw.Quant);
											end; //Edit***************************Sasha2,11:46 14.09.2017 }
											
											GetFullCurncyRate(azn,IVr.TransDate,aznfr,aznto,to2,br1,br2);
											if(aznfr==0 or aznto==0)then begin
												aznfr = 1; aznto = 1;
											end;
											fifoazn = fifob1*aznfr/aznto;
											if (modef) then begin
												outstring(100,0,brandfifo,false);//brandcur
												if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
													outstring(100,0,currencyBalances[CurncyCoder.CurncyCode],false);
												end;
												if(bcur==azn)then begin
													outstring(101,0,fifoazn,false);//AZN
												end;
												if(bcur!=azn)then begin
													outstring(102,0,fifob1,false);//basecur
												end;
												outstring(110,0,brandfifo*IVrw.Quant*cred,false);//brandcur
												if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
													outstring(110,0,currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant*cred,false);
												end;
												if(bcur==azn)then begin
													outstring(111,0,fifoazn*IVrw.Quant*cred,false);//AZN
												end;
												if(bcur!=azn)then begin
													outstring(112,0,fifob1*IVrw.Quant*cred,false);//basecur
												end;
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												arrvals[valscnt] = arrvals[valscnt] + brandfifo; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + currencyBalances[CurncyCoder.CurncyCode]; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + fifoazn; valscnt = valscnt + 1;
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + fifob1; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + brandfifo*IVrw.Quant*cred; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant*cred; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + fifoazn*IVrw.Quant*cred; valscnt = valscnt + 1;
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + fifob1*IVrw.Quant*cred; valscnt = valscnt + 1;
												end;
											end; //Edit***************************Sasha2,11:18 20.11.2014 }
											
											GetFullCurncyRate(brandcur,IVr.TransDate,fr,to1,to2,br1,br2);
											if(fr==0 or to1==0)then begin
												fr = 1; to1 = 1;
											end;
											/*if(fr==0 or to1==0)then begin
												fr = 1; to1 = 1;
											end;*/
											bfr = IVr.FrRate;
											bto = IVr.ToRateB1;
											if(bfr==0 or bto==0)then begin
												bfr = 1;
												bto = 1;
											end;
											
											total_cost = total_cost + fifoazn*IVrw.Quant*cred;
											btotal_cost = btotal_cost + fifob1*IVrw.Quant*cred;
											
											if(brandcur==IVr.CurncyCode)then begin
												curprice = IV2rw.Price*cred;
											end else begin
												curprice = round(IVrw.Price*fr/to1,SetRoundModeD(1))*cred;
											end;
											
											if (additionalCurF) then begin  //Edit***************************Sasha2,11:27 14.09.2017 {
												if (IVr.CurncyCode==CurncyCoder.CurncyCode) then begin
													EURprice = IV2rw.Price*cred;
												end else begin
													EURprice = BlankVal;
													CurValToOtherCur(IVr.InvDate,azn,IVrw.Price,CurncyCoder.CurncyCode,EURprice,SetRoundModeD(1)); //Edit***************************Sasha2,11:13 14.09.2017
													EURprice = EURprice*cred;
												end;
											end; //Edit***************************Sasha2,11:27 14.09.2017 }
											
											if (modef) then begin
												outstring(120,0,curprice,false);//brandcur
												if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
													outstring(120,0,EURprice,false);
												end;
												if(bcur==azn)then begin
													outstring(121,0,IVrw.Price*aznfr/aznto,false);//AZN
												end;
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												arrvals[valscnt] = arrvals[valscnt] + curprice; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + EURprice; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + IVrw.Price*aznfr/aznto; valscnt = valscnt + 1;
											end; //Edit***************************Sasha2,11:18 20.11.2014 }
											
											total_rebate = total_rebate + IVrw.Price*aznfr/aznto*IVrw.Quant;// Edit ************************** Wednesday, 22 October 2014 16:43:55
											
											if (modef) then begin
												if(bcur!=azn)then begin
													outstring(122,0,IVrw.Price,false);//basecur
												end;
											end else  begin //Edit***************************Sasha2,11:17 20.11.2014 {
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + IV2rw.Price; valscnt = valscnt + 1;
												end;
											end; //Edit***************************Sasha2,11:18 20.11.2014 }
											
											if(brandcur==IVr.CurncyCode)then begin
												curcusm = IV2rw.Sum*cred;
											end else begin
												curcusm = round(IVrw.Sum*fr/to1,SetRoundModeD(1))*cred;
											end;
											if (additionalCurF) then begin  //Edit***************************Sasha2,11:27 14.09.2017 {
												if (IVr.CurncyCode==CurncyCoder.CurncyCode) then begin
													EURcusm = IVrw.Sum*cred*fr/to1;
												end else begin
													EURcusm = BlankVal;
													CurValToOtherCur(IVr.InvDate,azn,IVrw.Sum,CurncyCoder.CurncyCode,EURcusm,SetRoundModeD(1)); //Edit***************************Sasha2,11:13 14.09.2017
													EURcusm = EURcusm*cred;
												end;
											end; //Edit***************************Sasha2,11:27 14.09.2017 }
											
											if (modef) then begin
												outstring(130,0,curcusm,false);//brandcur
												if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
													outstring(130,0,EURcusm,false);
												end;
												if(bcur==azn)then begin
													outstring(131,0,IVrw.Sum*aznfr/aznto*cred,false);//AZN
												end;
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												arrvals[valscnt] = arrvals[valscnt] + curcusm; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + EURcusm; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + IVrw.Sum*aznfr/aznto*cred; valscnt = valscnt + 1;
											end; //Edit***************************Sasha2,11:17 20.11.2014 }
											
											total_rebate_qty = total_rebate_qty + IVrw.Sum*aznfr/aznto*cred;// Edit ************************** Wednesday, 22 October 2014 16:44:51
											if (modef) then begin
												if(bcur!=azn)then begin
													outstring(132,0,IVrw.Sum*cred,false);//basecur
												end;
											end else  begin //Edit***************************Sasha2,11:17 20.11.2014 {
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + IVrw.Sum*cred; valscnt = valscnt + 1;
												end;
											end; //Edit***************************Sasha2,11:17 20.11.2014 {
											
											total_price = total_price + IVrw.Sum*aznfr/aznto*cred;
											btotal_price = btotal_price + IVrw.Sum*cred;
											
											if (modef) then begin
												outstring(140,0,(curcusm - brandfifo*IVrw.Quant)*cred,false);//brandcur
												if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
													outstring(140,0,(EURcusm -  currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant)*cred,false);
												end;
												if(bcur==azn)then begin
													outstring(141,0,IVrw.Sum*aznfr/aznto*cred - fifob1*IVrw.Quant*aznfr/aznto*cred,false);//AZN
												end;
												if(bcur!=azn)then begin
													outstring(142,0,(IVrw.Sum - fifob1*IVrw.Quant)*cred,false);//basecur
												end;
												outstring(0,0,brandcur,false);
												if(usercanaction("ViewCustomerInfo",true))then begin
													outstring(0,0,IVr.CustCode,false);
													outstring(0,0,IVr.Addr0,false);
													if(RepSpec.flags[2]==1)then begin
														outstring(0,0,CUr.Phone & " " & CUr.Mobile & " " & CUr.AltPhone,false);
														outstring(0,0,vVisitName[IVr.SerNr],false);
														outstring(0,0,vVisitPhone[IVr.SerNr],false);
														if(IVr.LCMLevel=="CASACOIN") then begin
															outstring(0,0,IVr.LoyaltyCardNr,false);
														end else begin	
															outstring(0,0,"",false);
														end;	
														Switch(CUr.Gender)begin
															case 0: outstring(100,0,"Мужской",false);
															case 1: outstring(100,0,"Женский",false);
															case 2: outstring(100,0,"Компания",false);
															otherwise
																outstring(100,0,"",false);
														end;
														if(nonblankdate(CUr.BirthDate))then begin
															outstring(150,0,getYear(currentdate)-getyear(CUr.BirthDate),false);
														end else begin
															outstring(150,0," ",false);
														end;
													end;
												end;
											
												
												outstring(0,0,IVrw.vRebate,false);
												//total_rebate = total_rebate + IVrw.vRebate*AbsoluteVal(IVrw.Quant);//Edit***********************Vitalii 14:28 26.08.2014
												/*if(IVrw.vRebate!=0)then begin
													total_rebate_qty = total_rebate_qty + AbsoluteVal(IVrw.Quant);											
												end;*/
												outstring(0,0,IVr.SalesMan,false);
												outstring(0,0,IVr.SerNr,false);
												outstring(0,0,IVr.TransDate,false);
												outstring(0,0,IVr.PayDeal,false);
												pos = 0;	
												OBJStr = IVrw.Objects;
												Obj = "";
												APriceObj = "";
												ExtractObjWithSeparator(",",OBJStr,true,pos,Obj);
												while (nonblank(Obj)) begin
													Objr.Code = Obj;
													if(ReadFirstMain(Objr,1,true)) then begin
														if(Objr.OTCode=="PROMO")then begin
															APriceObj = Obj;
														end;	
														if(Objr.OTCode=="APRIC")then begin // Edit ************************** Ihor Trubachov 17*05*2021
															if(nonblank(IVrw.Objects))then begin
																APriceObj = APriceObj & ",";
															end;
															APriceObj = APriceObj & Obj;
														end;	
														if(Objr.OTCode=="AREB")then begin
															if(nonblank(IVrw.Objects))then begin
																APriceObj = APriceObj & ",";
															end;
															APriceObj = APriceObj & Obj;
														end;	
													end;
													ExtractObjWithSeparator(",",OBJStr,true,pos,Obj);
												end;
												outstring(0,0,IVr.InvComment,false);
												outstring(0,0,APriceObj,false);
												outstring(0,0,GetIVRebCode(IVr.AddRebCode,IVrw.Objects),false);
										
											end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
												arrvals[valscnt] = arrvals[valscnt] + (curcusm - brandfifo*IVrw.Quant)*cred; valscnt = valscnt + 1;
												if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
													arrvals[valscnt] = arrvals[valscnt] + (EURcusm -  currencyBalances[CurncyCoder.CurncyCode]*IVrw.Quant)*cred; valscnt = valscnt + 1;
												end;
												arrvals[valscnt] = arrvals[valscnt] + (IVrw.Sum*aznfr/aznto - fifob1*IVrw.Quant*aznfr/aznto)*cred; valscnt = valscnt + 1;
												if(bcur!=azn)then begin
													arrvals[valscnt] = arrvals[valscnt] + (IVrw.Sum - fifob1*IVrw.Quant)*cred; valscnt = valscnt + 1;
												end;
												arrstrs[strscnt] = brandcur; strscnt = strscnt + 1;
												if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
													for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
														pos = 0;
														ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
														if (uloc==INr.Code) then begin
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
														end else begin
															arrstrs[strscnt] = ""; strscnt = strscnt + 1;
														end;
													end;
												end; //Edit***************************Sasha2,14:37 08.02.2016 }
												/*for (m=0;m<ctypecnt;m=m+1) begin 
													arrstrs[strscnt] = dispnames[typeindex[m]]; strscnt = strscnt + 1;
												end; 
												MyClearVector(dispnames,typeindex,ctypecnt);*/
											end; //Edit***************************Sasha2,11:17 20.11.2014 }
											
											if (modef) then begin //Edit***************************Sasha2,11:17 20.11.2014	
												if(currentcompany==9)then begin
													if(IVr.OrderNr>-1)then begin
														ORr.SerNr = IVr.OrderNr;
														readfirstmain(ORr,1,true);
														if(nonblank(ORr.OrderClass))then begin
															outstring(0,0,ORr.OrderClass,false);
														end;
													end;
												end;
												outstring(0,0,tstr,false);
												if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
													for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
														pos = 0;
														ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
														if (uloc==INr.Code) then begin
															ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
															outstring(0,0,uloc,false);
														end else begin
															outstring(0,0,"",false);
														end;
													end;
												end; //Edit***************************Sasha2,14:37 08.02.2016 }
												/*for (m=0;m<ctypecnt;m=m+1) begin //Edit***************************Sasha2,15:28 11.11.2015 {
													outstring(0,0,Left(dispnames[typeindex[m]],len(dispnames[typeindex[m]])-1),false);
												end; 
												MyClearVector(dispnames,typeindex,ctypecnt);*/ //Edit***************************Sasha2,15:28 11.11.2015 }
                        outstring(0,0,IVr.TaxTransactionCode,false);
											end;
										if(currentcompany==25 and RepSpec.flags[2]!=0) then begin
											if(cashbackPercent!=0) then begin
												outstring(0,0,cashbackPercent,false);
											end else begin
												outstring(0,0,"",false);
											end;
										end;	
										if (modef) then begin	//Edit***************************Sasha2,11:12 20.11.2014								
											endformat;
										end;
									end;
								end;
							end;
						end; 
					end;
				end;
				if (modef==false) then begin
					mtrw = matrowcnt(IV2r);
					for (i=0;i<mtrw;i=i+1) begin
						matrowget(IV2r,i,IVrw);
						valscnt = IVrw.Quant;
						strscnt = IVrw.Quant;
						itemoccurrences = IVrw.Sum*cred;
						startformat(15);
							outstring(1,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //IVrw.ArtCode
							outstring(2,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.AlternativeCode
							outstring(3,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //IVr.Location
							// outstring(4,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname
							// if (addclassf==false) then begin //Edit***************************Sasha2,17:43 02.06.2016 {
							  // outstring(5,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname2
							// end; //Edit***************************Sasha2,17:43 02.06.2016 }
							// outstring(6,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //prepareStr(IVrw.Spec)
							// if (addclassf==false) then begin
  							// outstring(7,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Reference
  							// outstring(8,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Metal
  							// outstring(9,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.RowWeight
  							// outstring(10,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.MajStoneDet
  							// //if(CompanyIsJWLikeCompany(currentcompany))then begin
  								// //outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.BrcStr
  								// //outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Gender
  							// //end;
  							// if(currentcompany==13)then begin			//Edit----------------------Dima  30.04.2015
  								// outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Size
  								// outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Colour
  							// end;	
							// end else begin  //Edit***************************Sasha2,17:43 02.06.2016 {
							  for (j=0;j<41;j=j+1) begin //if you change "30" do it in other places having "For" loop 
          		    /*outstring(12,0,arrstrs[strscnt],false);*/ strscnt = strscnt + 1;
          		  end;
							// end;	//Edit***************************Sasha2,17:43 02.06.2016 }
							outstring(13,0,"",false); //IVrw.SerialNr
							outstring(13,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.BarCode
							outstring(14,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.EKNCode
							outstring(15,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Quant
							outstring(16,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //brandfifo
							if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
							  outstring(16,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1;
							end;
							if(bcur==azn)then begin
								outstring(17,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //fifoazn
							end;
							if(bcur!=azn)then begin
								outstring(18,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //fifob1
							end;
							outstring(19,0,arrvals[valscnt],false); valscnt = valscnt + 1; //brandfifo*IVrw.Quant
							if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(19,0,arrvals[valscnt],false); valscnt = valscnt + 1;
    					end;
							if(bcur==azn)then begin
								outstring(20,0,arrvals[valscnt],false); valscnt = valscnt + 1; //fifoazn*IVrw.Quant
							end;
							if(bcur!=azn)then begin
								outstring(21,0,arrvals[valscnt],false); valscnt = valscnt + 1; //fifob1*IVrw.Quant
							end;
							outstring(22,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //curprice
							if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(22,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1;
    					end;
							if(bcur==azn)then begin
								outstring(23,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //IVrw.Price*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(24,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //IVrw.Price
							end;
							outstring(25,0,arrvals[valscnt],false); valscnt = valscnt + 1; //curcusm
							if (additionalCurF) then begin //additional currency retail sum //Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(25,0,arrvals[valscnt],false); valscnt = valscnt + 1; 
    					end;
							if(bcur==azn)then begin
							outstring(26,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(27,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum
							end;
							outstring(28,0,arrvals[valscnt],false); valscnt = valscnt + 1; //curcusm - brandfifo*IVrw.Quant
							if (additionalCurF) then begin //additional currency retail difference //Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(28,0,arrvals[valscnt],false); valscnt = valscnt + 1;
    					end;
							if(bcur==azn)then begin
								outstring(29,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum*aznfr/aznto - fifob1*IVrw.Quant*aznfr/aznto
							end;
							if(bcur!=azn)then begin
								outstring(30,0,arrvals[valscnt],false); valscnt = valscnt + 1; //IVrw.Sum - fifob1*IVrw.Quant
							end;
							outstring(31,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //brandcur
							if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
          		  for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
          		    outstring(32,0,arrstrs[strscnt],false); strscnt = strscnt + 1;
          		  end;
          		end; //Edit***************************Sasha2,14:37 08.02.2016 }
							/*for (m=0;m<ctypecnt;m=m+1) begin //Edit***************************Sasha2,16:15 11.11.2015 {
							  outstring(32,0,Left(arrstrs[strscnt],len(arrstrs[strscnt])-1),false); strscnt = strscnt + 1; //disp types
							end;*/ //Edit***************************Sasha2,16:15 11.11.2015 }
						endformat;
					end;
				end;
								
				startformat(15);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					if (modef) then begin
						if (addclassf==false) then begin
							outstring(0,0,"",false);
						end;
						if (currentcompany==9) then begin
							outstring(0,0,"",false);
						end;
						outstring(0,0,"",false);
						if (addclassf==false) then begin
							outstring(0,0,"",false);
							outstring(0,0,"",false);
							outstring(0,0,"",false);
							outstring(0,0,"",false);
							if (currentcompany==13) then begin
								outstring(0,0,"",false);
								outstring(0,0,"",false);
							end;
						end else begin
							for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
								outstring(0,0,"",false);
							end;
						end;				
						outstring(0,0,"",false);
					end;
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31074),false);
					outstring(0,0,total_qty,false);
					outstring(0,0,"",false);
					if(bcur!=azn)then begin
						outstring(0,0,"",false);
					end;
					if(bcur==azn)then begin
						outstring(0,0,"",false);
					end;
					if (additionalCurF) then begin //additional currency cost, additional currency cost sum //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					  outstring(0,0,"",false);
					end;
					outstring(0,0,USetStr(31075),false);
					if(bcur==azn)then begin
						outstring(0,0,total_cost,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_cost,false);
					end;
					outstring(0,0,"",false);
					if (additionalCurF) then begin //additional currency retail price //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					end;
					if(bcur==azn)then begin
					  outstring(0,0,"",false);
					end;
					if (additionalCurF) then begin //additional currency retail sum  //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					end;
					outstring(0,0,USetStr(31076),false);
					if(bcur==azn)then begin
						outstring(0,0,total_price,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_price,false);
					end;
					if (additionalCurF) then begin //additional currency retail difference//Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					end;
					outstring(0,0,USetStr(31077),false);
					if(bcur==azn)then begin
						outstring(0,0,total_price - total_cost,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_price - btotal_cost,false);
					end;
					//Edit***********************Vitalii 14:28 26.08.2014
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31078),false);
					//outstring(0,0,total_rebate/total_rebate_qty,false);
					outstring(0,0,100-(100*(total_rebate_qty/total_rebate)),false);// Edit ************************** Wednesday, 22 October 2014 16:45:31
	
				endformat;
			end else begin
				startformat(15);
					outstring(100,0,USetStr(31079),false);
				endformat;
			end;
		end;
	EndJob;
return;
end;








global
procedure SDReportExtRn(record RcVc RepSpec)
begin
  record LocalMachineVc LMr;
  Date sd,ed;
  Boolean TrHs,testf;
  record SDVc SDr,SD2r;
  row SDVc SDrw;
  integer i,keyi,mtrw,k,j;
  string 20 keystr;
  record INVc INr;
  string 100 classname,classname2,classcode; //Edit***************************Sasha2,11:14 20.11.2014
  record DIVc DIr;
  val brandfifo;
  string 5 brandcur;
  record PLVc PLr;
  val fr,to1,to2,br1,br2;
  val ivfr,ivto1;
  val basesum,curcusm,curprice,fifob1;
  boolean testf1,userlocation;
  string 255 location,tstr;
  record UserVc User;
  integer pos,headrow;
  string 50 uloc,uloc1;
  boolean updst,modef;
	val total_rebate,total_rebate_qty;//Edit***********************Vitalii 14:28 26.08.2014
  val total_qty;
  val total_cost,total_price,total_gp;
  string 200 classfind,model,brand,category;
  record ORVc ORr;
  record BaseCurBlock BCb;
  string 5 bcur,azn;
  val bfr,bto;
  val aznfr,aznto,fifoazn;
  val btotal_cost,btotal_price,btotal_gp;
  array val arrvals; //Edit***************************Sasha2,10:46 20.11.2014
  array string 20 arrstrs; //Edit***************************Sasha2,10:46 20.11.2014
  integer valscnt,strscnt,rangeval,rangecnt,arrsize; //Edit***************************Sasha2,12:11 20.11.2014
  val itemoccurrences; //Edit***************************Sasha2,12:11 20.11.2014
  boolean iteminf,addclassf,tmpbool;
  integer cred;
  Record CTypeVc CTyper; //Edit***************************Sasha2,12:23 11.11.2015
  integer ctypecnt,m; //Edit***************************Sasha2,12:24 11.11.2015
  array string 10 typeindex; //Edit***************************Sasha2,14:08 11.11.2015
  vector string 255 dispnames; //Edit***************************Sasha2,14:08 11.11.2015
  vector string 20 typeval; //Edit***************************Sasha2,14:11 08.02.2016
  array string 20 typecode; //Edit***************************Sasha2,14:11 08.02.2016
  vector string 200 typename; //Edit***************************Sasha2,14:11 08.02.2016
  record DiCheckBlock DiCb; //Edit***************************Sasha2,14:10 08.02.2016
  row DiCheckBlock DiCbw; //Edit***************************Sasha2,14:10 08.02.2016
  integer rwcnt,typescnt,pos1; //Edit***************************Sasha2,14:11 08.02.2016
  Boolean collf,metalf; //Edit***************************Sasha2,14:09 02.06.2016
  string 20 collstr,metalstr; //Edit***************************Sasha2,14:09 02.06.2016
  vector val currencyBalances; //Edit***************************Sasha2,15:49 13.09.2017
	array string 10 addCurs; //Edit***************************Sasha2,15:50 13.09.2017
	Boolean additionalCurF; //Edit***************************Sasha2,10:33 14.09.2017
	val EURprice,EURcusm; //Edit***************************Sasha2,11:26 14.09.2017
	record CurncyCodeVc CurncyCoder; //Edit***************************Sasha2,13:55 14.09.2017
  vector boolean userbrand;
  boolean userbrandf;
  longint curtick;
	
	curtick = getcurtick();
  userbrandf = CheckUserBrands(currentuser,userbrand);
  
  blockload(BCb);
  bcur = BCb.BaseCur1;
	azn = "AZN";
	if(currentcompany==10)THEN BEGIN
		azn = "PLN";
	end;
	if(currentcompany==11 or currentcompany==12)THEN BEGIN
		azn = "IRR";
	end;
	headrow = 2;
  //SetLangMode(LangRussian,"RUS",0);
  		
  	
    StartReportJob("Отчет по списаниям со склада"); //Edit***************************Sasha2,16:57 19.11.2014 {
    
    sd = RepSpec.sStartDate;
    ed = RepSpec.sEndDate;
    location = RepSpec.f1;
    
    Header(headrow,USetStr(13835) & sd & ":" & ed,0);
    headrow = headrow + 1;
    
    if (NonBlank(location)) then begin
  		Header(headrow,USetStr(31097) & ": " & location,0);
  	end else begin
  		Header(headrow,USetStr(31097) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	if (NonBlank(RepSpec.f2)) then begin
  		Header(headrow,USetStr(11605) & RepSpec.f2,0);
  	end else begin
  		Header(headrow,USetStr(11605) & USetStr(12727),0);
  	end;
    headrow = headrow + 1;
    
    if (NonBlank(RepSpec.f4)) then begin
  		Header(headrow,USetStr(31044) & ": " & RepSpec.f4,0);
  	end else begin
  		Header(headrow,USetStr(31044) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	if (NonBlank(RepSpec.f5)) then begin
  		Header(headrow,USetStr(8833) & ": " & RepSpec.f5,0);
  	end else begin
  		Header(headrow,USetStr(8833) & ": " & USetStr(12727),0);
  	end;
  	headrow = headrow + 1;
  	
  	EndHeader; //Edit***************************Sasha2,16:57 19.11.2014 }
  	
  	if (NonBlank(RepSpec.f7)) then begin //Edit***************************Sasha2,16:02 13.09.2017 {
  	  CurncyCoder.CurncyCode = RepSpec.f7;
  	  if (ReadFirstMain(CurncyCoder,1,true)) then begin
    	  addCurs[addCurs.length] = CurncyCoder.CurncyCode; 
    	  additionalCurF = true;
  	  end;
  	end;//Edit***************************Sasha2,16:02 13.09.2017 }
  	
  	if (CompanyIsJWLikeCompany(CurrentCompany)) then begin //Edit***************************Sasha2,11:27 02.06.2016 {
  	  addclassf = true;
  	end else begin
  	  addclassf = false;
  	end; 

  	if (addclassf) then begin
      typescnt = 0;
  	  BlockLoad(DiCb);
      rwcnt = MatRowCnt(DiCb);  
      for (j=0;j<rwcnt;j=j+1) begin
        MatRowGet(DiCb,j,DiCbw);
        if (NonBlank(DiCbw.DiType)) then begin
          DIr.Code = DiCbw.DiCode;
          ReadFirstMain(DIr,1,true);
          DiCbw.DiType = DIr.CType & "," & DiCbw.DiType;
          pos = 0;
    			ExtractObj(DiCbw.DiType,pos,uloc);
    			while (nonblank(uloc)) begin
    				if (blank(typeval[uloc])) then begin
      				CTyper.Code = uloc;
      				if (ReadFirstMain(CTyper,1,true)) then begin
      				  if (CTyper.Code=="GENDER") then begin
      				    switch (UpperCase(Left(DiCbw.DiCode,1))) begin
      				      case "A":
      				        if (blank(typeval[CTyper.Code & "_A"])) then begin
        				        typeval[CTyper.Code & "_A"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_A";
              				  typename[typecode[typescnt]] = "ACCESSORIES " & CTyper.Comment;
              				  typescnt = typescnt + 1;  
      				        end;
      				      case "J":
      				        if (blank(typeval[CTyper.Code & "_J"])) then begin
        				        typeval[CTyper.Code & "_J"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_J";
              				  typename[typecode[typescnt]] = "JEWELRY " & CTyper.Comment;
              				  typescnt = typescnt + 1;  
      				        end;
      				      case "W":
      				        if (blank(typeval[CTyper.Code & "_W"])) then begin
        				        typeval[CTyper.Code & "_W"] = ".";
              				  typecode[typescnt] = CTyper.Code & "_W";
              				  typename[typecode[typescnt]] = "WATCH " & CTyper.Comment;
              				  typescnt = typescnt + 1;
      				        end;
      				    end;
      				  end else begin
        				  typeval[CTyper.Code] = ".";
        				  typecode[typescnt] = CTyper.Code;
        				  typename[CTyper.Code] = CTyper.Comment;
        				  typescnt = typescnt + 1;  
      				  end;
      				end;
    				end;
    				ExtractObj(DiCbw.DiType,pos,uloc);
    			end;
        end;
      end;
      SortAndClearClassifications(typecode,typename,typescnt);
    end;//Edit***************************Sasha2,11:27 02.06.2016 }

  	if (RepSpec.ArtMode==0) then begin
  		modef = true;
  	end else begin
  		modef = false;
  		RECORDNEW(SD2r);
  	end;
  
		userlocation = false;
		User.Code = currentuser;
		if(readfirstmain(User,1,true))then begin
			if(nonblank(User.UserLocations) and usercanaction("AllowReportWithUserLoc",false))then begin
				userlocation = true;
				pos = 0;
				ExtractObj(User.UserLocations,pos,uloc);
				while (nonblank(uloc)) begin
					if(uloc==location)then begin
						userlocation = false;
					end;
					ExtractObj(User.UserLocations,pos,uloc);
				end;
			end;
		end;
	
    if(userlocation)then begin
			startformat(15);
				outstring(50,0,USetStr(31014),false);
			endformat;
		end else begin
			if(nonblank(RepSpec.sStartDate) and nonblank(RepSpec.sEndDate))then begin
				StartFormat(15);
					outstring(0,0,USetStr(31102),false);
					outstring(40,0,RepSpec.sStartDate & ":" & RepSpec.sEndDate,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31103),false);
					if(nonblank(RepSpec.f1))then begin
						outstring(40,0,RepSpec.f1,false);
					end else begin
						outstring(40,0,USetStr(31104),false);
					end;
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31105),false);
					outstring(40,0,RepSpec.f2,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31205),false);
					outstring(40,0,RepSpec.f4,false);
				endformat;
				StartFormat(15);
					outstring(0,0,USetStr(31206),false);
					outstring(40,0,RepSpec.f5,false);
				endformat;
				StartFormat(15);
				endformat;
				
				
				
				startformat(15);
					outstring(0,0,USetStr(31042),false);
					outstring(0,0,USetStr(31043),false);
					outstring(0,0,USetStr(12815),false); //Sklad
					outstring(0,0,USetStr(31044),false); //Brand
					if (addclassf==false) then begin //Edit***************************Sasha2,13:15 02.06.2016
					  outstring(0,0,USetStr(19357),false); //Klassificatsia
					end;
					if(currentcompany==9)then begin
						outstring(0,0,USetStr(9131),false);		//Edit----------------------Dima  20.03.2015 //categoria
					end;
					outstring(0,0,USetStr(12713),false); //Naimenovanie
					if (addclassf==false) then begin //Edit***************************Sasha2,13:17 02.06.2016 {
  					outstring(0,0,USetStr(31045),false);//Reference //Kollectsia
  					outstring(0,0,USetStr(31047),false); //Tip metalla
  					outstring(0,0,USetStr(14533),false); //Ves
  					outstring(0,0,USetStr(31048),false); //Karatnost
  					//if(CompanyIsJWLikeCompany(currentcompany))then begin
  						//outstring(0,0,USetStr(31049),false); //Braslet/Remeshok
  						//outstring(0,0,USetStr(31050),false); //Tsvet tsyferblata
  					//end;
  					if(currentcompany==13)then begin		//Edit-----------------------------Dima  30.04.2015
  						outstring(0,0,USetStr(31320),false); //Tsvet
  						outstring(0,0,USetStr(35007),false); //Kvadratura
  					end;					
					end else begin //Edit***************************Sasha2,13:17 02.06.2016 }
					  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
      		    outstring(0,0,typename[typecode[j]],false);
      		  end;
					end;
					outstring(0,0,USetStr(31051),false); //seriinii nomer
					outstring(0,0,"EAN code",false);
					outstring(0,0,USetStr(13199),false);//EKNCode
					outstring(0,0,"Списано",false);
					outstring(100,0,USetStr(31053),false);
					if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(100,0,USetStr(31055) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
						outstring(101,0,USetStr(31055) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(102,0,USetStr(31055) & bcur,false);
					end;
					outstring(110,0,USetStr(31056),false);
					if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
					  outstring(110,0,USetStr(31058) & addCurs[0],false);
					end;
					if(bcur==azn)then begin
					  outstring(111,0,USetStr(31058) & bcur,false);
					end;
					if(bcur!=azn)then begin
						outstring(112,0,USetStr(31058) & bcur,false);
					end;
					
					outstring(112,0,"Ритейл за ед-цу в валюте Бренда",false);
					outstring(112,0,"Ритейл за ед-цу в валюте AZN",false);
					
					outstring(112,0,"Валюта бренда",false);
					outstring(112,0,"Дата списания",false);
					outstring(112,0,"Комментарии",false);
				endformat;

				total_rebate = 0;//Edit***********************Vitalii 14:28 26.08.2014
				total_rebate_qty = 0;
				total_qty = 0;
				total_cost = 0;
				total_price = 0;
				total_gp = 0;
				btotal_cost = 0;
				btotal_price = 0;
				btotal_gp = 0;
				rangecnt = 0; //Edit***************************Sasha2,11:41 20.11.2014
				arrsize = 25; 
				
				//arrsize = arrsize + ctypecnt; //Edit***************************Sasha2,16:49 11.11.2015
				arrsize = arrsize + typescnt;
				
				SDr.TransDate = sd;
				keyi = 1;
				keystr = "TransDate";
				if(nonblank(location))then begin	
					SDr.Location = location;
          SDr.OKFlag = 1;
					keyi = 3;
					keystr = "LocOK";
				end;
			
				TrHs =true;
				while(loopkey(keystr,SDr,keyi,TrHs)) begin
					testf = true;
					cred = 1;
					
					if(SDr.TransDate<sd)then begin testf = false; end;
					if(SDr.TransDate>ed)then begin TrHs = false; testf = false; end;
					if(nonblank(location) and SDr.Location!=location)then begin TrHs = false; testf = false; end;
					if(SDr.OKFlag==0)then begin testf = false; end;
					if(nonblank(RepSpec.f8) and !setinset(RepSpec.f8,SDr.Objects))then begin testf = false; end;
					
					
					if(testf)then begin
						mtrw = matrowcnt(SDr);
					
						For(i=0;i<mtrw;i=i+1) begin
							matrowget(SDr,i,SDrw);

							if(true and nonblank(SDrw.ArtCode))then begin
								INr.Code = SDrw.ArtCode;
								readfirstmain(INr,1,true);
								testf1=true;
								
								
								
								
								if(nonblank(RepSpec.f2))then begin
									testf1=SetInSet2(RepSpec.f2,INr.DispGroups);
								end;
								if(nonblank(RepSpec.f9) and !setinset(RepSpec.f9,SDrw.Objects))then begin testf1 = false; end;
								
								if(RepSpec.flags[1]==1 and INr.ConsgType==0)then begin
									testf1 = false;
								end;
								if(RepSpec.flags[2]==1 and INr.ConsgType==1)then begin
									testf1 = false;
								end;
								if(RepSpec.flags[3]==1 and INr.ConsgType==2)then begin
									testf1 = false;
								end;
								if(INr.ConsgType>2)then begin
									testf1 = false;
								end;
								
								if(userbrandf and testf1)then begin// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 19 06 2019 y. at 4:35:18 PM
									pos = 0;
									brand = "";
									testf1 = false;
									ExtractObj(INr.DispGroups,pos,brand);
									while(nonblank(brand)) begin
										if(userbrand[brand])then begin
											testf1 = true;
										end;
										ExtractObj(INr.DispGroups,pos,brand);
									end;
								end;
								
								
								if(testf1)then begin
									if(nonblank(RepSpec.f4) or nonblank(RepSpec.f5))then begin
										brand = "";
										model = "";
										category = "";
										pos = 0;
										classfind = "";
										ExtractObj(INr.DispGroups,pos,classfind);
										while(nonblank(classfind)) begin
											DIr.Code = classfind;
											readfirstmain(DIr,1,true);
											if(DIr.CType=="BRAND")then begin
												brand = DIr.Code;
											end;
											if(DIr.CType=="MODEL")then begin
												model = DIr.Code;
											end;
											ExtractObj(INr.DispGroups,pos,classfind);
										end;
										if(nonblank(RepSpec.f4) and brand!=RepSpec.f4)then begin
											testf1 = false;
										end;
										if(nonblank(RepSpec.f5) and model!=RepSpec.f5)then begin
											testf1 = false;
										end;
									end;
								end;
								
								if(testf1) then begin
								  pos = 0;
              		brand = "";
              		model = "";
              		if (addclassf) then begin //Edit***************************Sasha2,14:05 02.06.2016 {
                		ExtractObj(INr.DispGroups,pos,uloc);
                		while (NonBlank(uloc)) begin
                		  DIr.Code = uloc;
                		  if (readfirstmain(DIr,1,true)) then begin
                		    if (DIr.CType=="BRAND") then begin
                		      brand = DIr.Name;
                		    end;
                		    if (DIr.CType=="MODEL") then begin
                		      model = DIr.Name;
                		    end;
                		    if (NonBlank(DIr.CType)) then begin 
                				  if (DIr.CType=="GENDER") then begin
                				    switch (Left(UpperCase(INr.MainDisp),1)) begin
                				      case "A":
                      				  DIr.CType = DIr.CType & "_A";
                      				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
                				      case "J":
                				        DIr.CType = DIr.CType & "_J";
                      				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
                				      case "W":
                				        DIr.CType = DIr.CType & "_W";
                      				  typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
                				    end;
                				  end else begin
                				    typeval[DIr.CType] = INr.Code & ";" & DIr.Name;
                				    switch (Left(UpperCase(INr.MainDisp),1)) begin //if classifications in custom separate fields {
                				      case "A":
                				        if (NonBlank(INr.Reference)) then begin
                				          collf = true;
                				          collstr = "COLL_A";
                				        end;
                				        if (NonBlank(INr.Metal)) then begin
                				          metalf = true;
                				          metalstr = "MATERIAL_A";
                				        end;
                				      case "J":
                				        if (NonBlank(INr.Reference)) then begin
                				          collf = true;
                				          collstr = "COLL_J";
                				        end;
                				        if (NonBlank(INr.Metal)) then begin
                				          metalf = true;
                				          metalstr = "MATERIAL_J";
                				        end;
                				        if (NonBlank(INr.RowWeight)) then begin
                				          tstr = typeval["WEIGHT"];
                    			        pos1 = 0;
                    			        ExtractObj(tstr,pos1,uloc1);
                    			        if (uloc1==INr.Code) then begin
                    			          ExtractObj(tstr,pos1,uloc1);
                    			          if (blank(uloc1)) then begin
                    			            typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
                    			          end;
                    			        end else begin
                    			          typeval["WEIGHT"] = INr.Code & ";" & INr.RowWeight;
                    			        end;
                				        end;
                				        if (NonBlank(INr.MajStoneDet)) then begin
                				          tstr = typeval["D_CARAT"];
                    			        pos1 = 0;
                    			        ExtractObj(tstr,pos1,uloc1);
                    			        if (uloc1==INr.Code) then begin
                    			          ExtractObj(tstr,pos1,uloc1);
                    			          if (blank(uloc1)) then begin
                    			            typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
                    			          end;
                    			        end else begin
                    			          typeval["D_CARAT"] = INr.Code & ";" & INr.MajStoneDet;
                    			        end;
                				        end;
                				      case "W":
                				        if (NonBlank(INr.Reference)) then begin
                				          collf = true;
                				          collstr = "COLL_W";
                				        end;
                				        if (NonBlank(INr.Metal)) then begin
                				          metalf = true;
                				          metalstr = "MATERIAL_W";
                				        end;
                				    end; 
                				    if (collf) then begin
                				      tstr = typeval[collstr];
                			        pos1 = 0;
                			        ExtractObj(tstr,pos1,uloc1);
                			        if (uloc1==INr.Code) then begin
                			          ExtractObj(tstr,pos1,uloc1);
                			          if (blank(uloc1)) then begin
                			            typeval[collstr] = INr.Code & ";" & INr.Reference;
                			          end;
                			        end else begin
                			          typeval[collstr] = INr.Code & ";" & INr.Reference;
                			        end;  
                				      collf = false;
                				    end;
                				    if (metalf) then begin
                		          tstr = typeval[metalstr];
                			        pos1 = 0;
                			        ExtractObj(tstr,pos1,uloc1);
                			        if (uloc1==INr.Code) then begin
                			          ExtractObj(tstr,pos1,uloc1);
                			          if (blank(uloc1)) then begin
                			            typeval[metalstr] = INr.Code & ";" & INr.Metal;
                			          end;
                			        end else begin
                			          typeval[metalstr] = INr.Code & ";" & INr.Metal;
                			        end;
                				      metalf = false;
                				    end;//if classifications in custom separate fields }
                				  end;
                				end;
                		  end; //Edit***************************Sasha2,14:05 02.06.2016 }
                		  ExtractObj(INr.DispGroups,pos,uloc);
                		end;
                	end;
									if (modef) then begin
										startformat(15);
									end;
										if (modef) then begin
											outstring(0,0,SDrw.ArtCode,false);
											outstring(0,0,INr.AlternativeCode,false);
											outstring(0,0,SDr.Location,false);
											
											if (addclassf==false) then begin
  											classname = "";
  											k=0;
  											ExtractObj(INr.DispGroups,k,classcode);
  											DIr.Code = classcode;
  											readfirstmain(DIr,1,true);
  											classname = DIr.Name;
  											outstring(0,0,classname,false);
  											
  											classname2 = "";
  											ExtractObj(INr.DispGroups,k,classcode);
  											DIr.Code = classcode;
  											readfirstmain(DIr,1,true);
  											classname2 = DIr.Name;
  											if(currentcompany==9) then begin
  												category = DIr.CCat;	//Edit----------------------Dima  20.03.2015
  											end;											
  											outstring(0,0,classname2,false);
											end else begin //Edit***************************Sasha2,14:11 02.06.2016 {
											  outstring(0,0,brand,false);
											end; //Edit***************************Sasha2,14:11 02.06.2016 ]

											if(currentcompany==9) then begin
												outstring(0,0,category,false);
											end;
											outstring(0,0,prepareStr(SDrw.Spec),false);
											if (addclassf==false) then begin //Edit***************************Sasha2,14:21 02.06.2016 {
  											outstring(0,0,INr.Reference,false);
  											outstring(0,0,INr.Metal,false);
  											outstring(0,0,INr.RowWeight,false);
  											outstring(0,0,INr.MajStoneDet,false);

  											if(currentcompany==13)then begin		//Edit----------------------Dima  30.04.2015
  												outstring(0,0,INr.Size,false);
  												outstring(0,0,INr.Colour,false);											
  											end;  
                  		end else begin
                  		  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
                  		    pos = 0;
                  		    ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                  		    if (uloc==INr.Code) then begin
                  		      ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                            outstring(0,0,uloc,false);
                          end else begin
                            outstring(0,0,"",false);
                  		    end;
                  		  end;
											end; //Edit***************************Sasha2,14:21 02.06.2016 }
											
											outstring(0,0,SDrw.SerialNr,false);
											outstring(0,0,INr.BarCode,false);
											outstring(0,0,INr.EKNCode,false);
											outstring(0,0,SDrw.Qty*cred,false);
										end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
											rangeval = CalculateCoefSD(SD2r,rangecnt,SDrw.ArtCode,SDr.Location,iteminf,arrsize);
											valscnt = rangeval;
											strscnt = rangeval;
											if (iteminf==false) then begin
												arrstrs[strscnt] = SDrw.ArtCode; strscnt = strscnt + 1;
												arrstrs[strscnt] = INr.AlternativeCode; strscnt = strscnt + 1;
												arrstrs[strscnt] = SDr.Location; strscnt = strscnt + 1;
												
												if (addclassf==false) then begin
  												classname = "";
  												k=0;
  												ExtractObj(INr.DispGroups,k,classcode);
  												DIr.Code = classcode;
  												readfirstmain(DIr,1,true);
  												classname = DIr.Name;
  												arrstrs[strscnt] = classname; strscnt = strscnt + 1;
  												
  												classname2 = "";
  												ExtractObj(INr.DispGroups,k,classcode);
  												DIr.Code = classcode;
  												readfirstmain(DIr,1,true);
  												classname2 = DIr.Name;
  												arrstrs[strscnt] = classname2; strscnt = strscnt + 1;
												end else begin //Edit***************************Sasha2,14:23 02.06.2016 {
												  arrstrs[strscnt] = brand; strscnt = strscnt + 1;
												end; //Edit***************************Sasha2,14:23 02.06.2016 }
												
												arrstrs[strscnt] = prepareStr(SDrw.Spec); strscnt = strscnt + 1;
												if (addclassf==false) then begin //Edit***************************Sasha2,14:21 02.06.2016 {
    											arrstrs[strscnt] = INr.Reference; strscnt = strscnt + 1; 
  												arrstrs[strscnt] = INr.Metal; strscnt = strscnt + 1; 
  												arrstrs[strscnt] = INr.RowWeight;strscnt = strscnt + 1;
  												arrstrs[strscnt] = INr.MajStoneDet; strscnt = strscnt + 1;
  												if(currentcompany==13)then begin	//Edit----------------------Dima  30.04.2015
  													arrstrs[strscnt] = INr.Size; strscnt = strscnt + 1; 
  													arrstrs[strscnt] = INr.Colour; strscnt = strscnt + 1;
  												end;	  
                    		end else begin
                    		  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
                    		    pos = 0;
                    		    ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                    		    if (uloc==INr.Code) then begin
                    		      ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                              arrstrs[strscnt] = uloc; strscnt = strscnt + 1;
                            end else begin
                              arrstrs[strscnt] = ""; strscnt = strscnt + 1;
                    		    end;
                    		  end;
  											end; //Edit***************************Sasha2,14:21 02.06.2016 }
												arrstrs[strscnt] = INr.BarCode; strscnt = strscnt + 1;
												arrstrs[strscnt] = INr.EKNCode; strscnt = strscnt + 1;
											end else begin
												if(addclassf)then begin
													strscnt = strscnt + 7 + typescnt;
												end else begin
												  if (currentcompany==13) then begin
												    strscnt = strscnt + 14;
												  end else begin
												    strscnt = strscnt + 12;
												  end;
												end;
											end;
											arrvals[valscnt] = arrvals[valscnt] + SDrw.Qty; valscnt = valscnt + 1;
										end; //Edit***************************Sasha2,11:18 20.11.2014 }
										
										total_qty = total_qty + SDrw.Qty;
																				
										FindFIFOOrigValAndCurncySD(SDr.SerNr,i,brandfifo,brandcur,fifob1,updst,addCurs,currencyBalances,additionalCurF,tmpbool); //Edit***************************Sasha2,16:02 13.09.2017
										if(fifob1==0)then begin
											fifob1 = INr.WeighedAvPrice * SDrw.Qty;
										end;
										if(brandfifo==0)then begin
											brandfifo = INr.LastPurchPrice2 * SDrw.Qty;
										end;
										
										
										brandfifo = AbsoluteVal(brandfifo/SDrw.Qty);
										fifob1 = AbsoluteVal(fifob1/SDrw.Qty);
										for (j=0;j<addCurs.length;j=j+1) begin //Edit***************************Sasha2,11:46 14.09.2017 {
										  currencyBalances[addCurs[j]] = AbsoluteVal(currencyBalances[addCurs[j]]/SDrw.Qty);
										end; //Edit***************************Sasha2,11:46 14.09.2017 }
										
										GetFullCurncyRate(azn,SDr.TransDate,aznfr,aznto,to2,br1,br2);
										if(aznfr==0 or aznto==0)then begin
											aznfr = 1; aznto = 1;
										end;
										fifoazn = fifob1*aznfr/aznto;
										
										if (modef) then begin
											outstring(100,0,brandfifo,false);//brandcur
											if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
            					  outstring(100,0,currencyBalances[CurncyCoder.CurncyCode],false);
            					end;
											if(bcur==azn)then begin
												outstring(101,0,fifoazn,false);//AZN
											end;
											if(bcur!=azn)then begin
												outstring(102,0,fifob1,false);//basecur
											end;
											outstring(110,0,brandfifo*SDrw.Qty*cred,false);//brandcur
											if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
            					  outstring(110,0,currencyBalances[CurncyCoder.CurncyCode]*SDrw.Qty*cred,false);
            					end;
											if(bcur==azn)then begin
												outstring(111,0,fifoazn*SDrw.Qty*cred,false);//AZN
											end;
											if(bcur!=azn)then begin
												outstring(112,0,fifob1*SDrw.Qty*cred,false);//basecur
											end;
										end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
											arrvals[valscnt] = arrvals[valscnt] + brandfifo; valscnt = valscnt + 1;
											if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
            					  arrvals[valscnt] = arrvals[valscnt] + currencyBalances[CurncyCoder.CurncyCode]; valscnt = valscnt + 1;
            					end;
											arrvals[valscnt] = arrvals[valscnt] + fifoazn; valscnt = valscnt + 1;
											if(bcur!=azn)then begin
												arrvals[valscnt] = arrvals[valscnt] + fifob1; valscnt = valscnt + 1;
											end;
											arrvals[valscnt] = arrvals[valscnt] + brandfifo*SDrw.Qty*cred; valscnt = valscnt + 1;
											if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
            					  arrvals[valscnt] = arrvals[valscnt] + currencyBalances[CurncyCoder.CurncyCode]*SDrw.Qty*cred; valscnt = valscnt + 1;
            					end;
											arrvals[valscnt] = arrvals[valscnt] + fifoazn*SDrw.Qty*cred; valscnt = valscnt + 1;
											if(bcur!=azn)then begin
												arrvals[valscnt] = arrvals[valscnt] + fifob1*SDrw.Qty*cred; valscnt = valscnt + 1;
											end;
										end; //Edit***************************Sasha2,11:18 20.11.2014 }
										
										GetFullCurncyRate(brandcur,SDr.TransDate,fr,to1,to2,br1,br2);
										if(fr==0 or to1==0)then begin
											fr = 1; to1 = 1;
										end;										
										total_cost = total_cost + fifoazn*SDrw.Qty*cred;
										btotal_cost = btotal_cost + fifob1*SDrw.Qty*cred;
										
										PLr.PLCode = "RRP";
										PLr.ArtCode = SDrw.ArtCode;
										if(readfirstmain(PLr,2,true))then begin
											outstring(100,0,PLr.ExVatPrice,false);//Ритейл за ед-цу в валюте Бренда
											outstring(100,0,PLr.ExVatPrice/fr*to1,false);//Ритейл за ед-цу в валюте AZN
										end else begin
											outstring(100,0,"",false);//Ритейл за ед-цу в валюте Бренда
											outstring(100,0,"",false);//Ритейл за ед-цу в валюте AZN
										end;
										
										
										if (modef) then begin
											outstring(0,0,brandcur,false);
										end else begin //Edit***************************Sasha2,11:17 20.11.2014 {
											

										end; //Edit***************************Sasha2,11:17 20.11.2014 }
										
										
										outstring(0,0,SDr.TransDate,false);
										outstring(0,0,SDr.Comment,false);
										
										if (modef) then begin //Edit***************************Sasha2,11:17 20.11.2014	
											outstring(0,0,tstr,false);
											if (addclassf) then begin //Edit***************************Sasha2,14:37 08.02.2016 {
                  		  for (j=30;j<typescnt;j=j+1) begin //if you change "30" do it in other places having "For" loop 
                  		    pos = 0;
                  		    ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                  		    if (uloc==INr.Code) then begin
                  		      ExtractObjWithSeparator(";",typeval[typecode[j]],true,pos,uloc);
                            outstring(0,0,uloc,false);
                          end else begin
                            outstring(0,0,"",false);
                  		    end;
                  		  end;
                  		end; //Edit***************************Sasha2,14:37 08.02.2016 }
										end;
										
									if (modef) then begin	//Edit***************************Sasha2,11:12 20.11.2014								
										endformat;
									end;
								end;
							end;
						end; 
					end;
				end;
				
				if (modef==false) then begin
					mtrw = matrowcnt(SD2r);
					for (i=0;i<mtrw;i=i+1) begin
						matrowget(SD2r,i,SDrw);
						valscnt = SDrw.Qty;
						strscnt = SDrw.Qty;
						//itemoccurrences = SDrw.Sum*cred;
						startformat(15);
							outstring(1,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //SDrw.ArtCode
							outstring(2,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.AlternativeCode
							outstring(3,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //SDr.Location
							outstring(4,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname
							if (addclassf==false) then begin //Edit***************************Sasha2,17:43 02.06.2016 {
							  outstring(5,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //classname2
							end; //Edit***************************Sasha2,17:43 02.06.2016 }
							outstring(6,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //prepareStr(SDrw.Spec)
							if (addclassf==false) then begin
  							outstring(7,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Reference
  							outstring(8,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Metal
  							outstring(9,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.RowWeight
  							outstring(10,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.MajStoneDet
  							if(currentcompany==13)then begin			//Edit----------------------Dima  30.04.2015
  								outstring(11,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Size
  								outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.Colour
  							end;	
							end else begin  //Edit***************************Sasha2,17:43 02.06.2016 {
							  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
          		    outstring(12,0,arrstrs[strscnt],false); strscnt = strscnt + 1;
          		  end;
							end;	//Edit***************************Sasha2,17:43 02.06.2016 }
							outstring(13,0,"",false); //SDrw.SerialNr
							outstring(13,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.BarCode
							outstring(14,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //INr.EKNCode
							outstring(15,0,arrvals[valscnt],false); valscnt = valscnt + 1; //SDrw.Qty
							outstring(16,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //brandfifo
							if (additionalCurF) then begin //additional currency cost //Edit***************************Sasha2,17:02 13.09.2017
							  outstring(16,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1;
							end;
							if(bcur==azn)then begin
								outstring(17,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //fifoazn
							end;
							if(bcur!=azn)then begin
								outstring(18,0,arrvals[valscnt]/itemoccurrences,false); valscnt = valscnt + 1; //fifob1
							end;
							outstring(19,0,arrvals[valscnt],false); valscnt = valscnt + 1; //brandfifo*SDrw.Qty
							if (additionalCurF) then begin //additional currency cost sum//Edit***************************Sasha2,17:02 13.09.2017
    					  outstring(19,0,arrvals[valscnt],false); valscnt = valscnt + 1;
    					end;
							if(bcur==azn)then begin
								outstring(20,0,arrvals[valscnt],false); valscnt = valscnt + 1; //fifoazn*SDrw.Qty
							end;
							if(bcur!=azn)then begin
								outstring(21,0,arrvals[valscnt],false); valscnt = valscnt + 1; //fifob1*SDrw.Qty
							end;
							outstring(31,0,arrstrs[strscnt],false); strscnt = strscnt + 1; //brandcur
						endformat;
					end;
				end;
								
				startformat(15);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					if (addclassf==false) then begin
					  outstring(0,0,"",false);
					end;
					if (currentcompany==9) then begin
					  outstring(0,0,"",false);
					end;
					outstring(0,0,"",false);
					if (addclassf==false) then begin
					  outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						outstring(0,0,"",false);
						if (currentcompany==13) then begin
						  outstring(0,0,"",false);
						  outstring(0,0,"",false);
						end;
					end else begin
					  for (j=0;j<30;j=j+1) begin //if you change "30" do it in other places having "For" loop 
      		    outstring(0,0,"",false);
      		  end;
					end;				
					outstring(0,0,"",false);
					outstring(0,0,"",false);
					outstring(0,0,USetStr(31074),false);
					outstring(0,0,total_qty,false);
					outstring(0,0,"",false);
					if(bcur!=azn)then begin
						outstring(0,0,"",false);
					end;
					if(bcur==azn)then begin
						outstring(0,0,"",false);
					end;
					if (additionalCurF) then begin //additional currency cost, additional currency cost sum //Edit***************************Sasha2,17:02 13.09.2017
					  outstring(0,0,"",false);
					  outstring(0,0,"",false);
					end;
					outstring(0,0,USetStr(31075),false);
					if(bcur==azn)then begin
						outstring(0,0,total_cost,false);
					end;
					if(bcur!=azn)then begin
						outstring(0,0,btotal_cost,false);
					end;
					outstring(0,0,"",false);
						
				endformat;
			end else begin
				startformat(15);
					outstring(100,0,USetStr(31079),false);
				endformat;
			end;
		end;
	EndJob;
	LogProcTime("SDReportExtRn",getcurtick() - curtick);
return;
end;

global webpublic procedure WebGenSalesReport()
begin
  LongInt rwcnt,oldcomp,i,year;
  record CompaniesBlock Compb;
  row CompaniesBlock Comprw;
  record RcVc RepSpec;
  
  logtext(0,"WebGenSalesReport");
    
  BlockLoad(Compb);
  rwcnt = MatRowCnt(Compb);
  for (i = 0; i<rwcnt; i = i + 1) begin
    setcompany(i+1,false);
    MatRowGet(Compb,i,Comprw);
    if(Comprw.ActiveStatus==0)then begin
      for(year=2022;year>2022;year=year-1)begin
        delete_file("SalesReports/" & Comprw.ShortName & "_" & year & ".tab");
        openexportfile("SalesReports/" & Comprw.ShortName & "_" & year & ".tab",true);
        startformat(15);
					outstring(0,0,i+1,false);
				endformat;
				logtext(0,"SalesReports/" & Comprw.ShortName & "_" & year & ".tab");
        RepSpec.sStartDate = stringtodate("01/01/" & year);
        RepSpec.sEndDate = stringtodate("31/12/" & year);
        if(year==2022)then begin
          RepSpec.sEndDate = stringtodate("20/04/" & year);
        end;
        SalesReportExtRn(RepSpec);
        logtext(0,"SalesReports/" & Comprw.ShortName & "_" & year & ".tab end");
        if(fileexists("stopreports"))then begin
          goto lWebGenSalesReport;
        end;
        closefile;
      end;

    end;
  end;
  
  
lWebGenSalesReport:;
return;
end;