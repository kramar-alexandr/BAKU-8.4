external procedure AutomatedSalesOrderly(string);
remote function Integer POApprovalStatus(record POVc,var record AcceptanceRulesVc);
remote function Integer POTestApprovalStatus(record POVc);
remote procedure PODClassOnOpenWindowRemote(var record POVc,var Integer);
remote updating function Integer RecordAction_POOrdDownPay(LongInt,val,val,var record VIVc,var string,Integer);
remote procedure POSetShipCost(var record POVc,Integer);
external function Integer OpenArtStat(Integer,record RcVc,Boolean);
remote procedure POVc_PasteTaxTemplateCode(var record POVc,Integer,var Boolean);
remote updating function LongInt RecordAction_raPastePOInDropSH(var record POVc,var record DropSHVc);
remote function Boolean POShipdTest(record POVc,Boolean);
external function roundmode DefaultRoundMode();
remote procedure POVc_PasteStockType(var record POVc,Integer);
remote procedure POVc_PasteTREO(var record POVc,Integer);
remote procedure POVc_PasteCurncyCode(var record POVc,string,Boolean);
// The sumup functions are remote, they should be able to NOT be remote...then some of these functions would not be remote...
external function Boolean DateWarned(Date,string);
remote updating function Integer CreateVIFromPO(LongInt,record RcVc,var record VIVc);
remote function Boolean POVc_PasteLocation(var record POVc);
external function Boolean TestForMATVARINS(Integer);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
remote procedure POVc_PasteVATCode(var record POVc,Integer);
remote procedure POVc_PasteSum(var record POVc,Integer);
remote procedure POVc_PastePrice(var record POVc,Integer);
remote procedure POVc_PastevRebate(var record POVc,Integer);
remote procedure POVc_PasteVEQuant(var record POVc,Integer);
remote procedure POVc_PasteQuant(var record POVc,Integer);
remote function Boolean POVc_PasteVEArtCode(var record POVc,Integer);
remote function Boolean POVc_PasteArtCode(var record POVc,Integer,Boolean);
remote function Boolean POVc_PasteVECode(var record POVc,Boolean);
remote procedure POGetRate(var record POVc);
external procedure GetSalesGroup(string,var string);
external function Boolean AllowCurChange(string,Boolean);
remote procedure POSumup(var record POVc );
external updating procedure POCreateHtmlFile(record POVc,record MailVc);
remote updating function Integer CreateMailFromPOD(record POVc,var record MailVc,var string,string);
external procedure SendArtStat(string,string,string,val,val,val,Date,Integer);
external procedure CalcProc(val,val,var val);
external procedure FindSalesExVat(record TaxMatrixVc,string,val,Integer,Integer,var val);
external procedure VIOpenPrepExists(string);
remote updating function Boolean RecordAction_rlPOLClose(var record POVc);
remote updating function Boolean RecordAction_rlPOLOK(var record POVc);
remote updating procedure POCreate(record RcVc);
external updating procedure RecordActionPO_Print(var record POVc,string,Boolean);
remote updating function LongInt RecordAction_raPastePOInPU(var record POVc,var record PUVc);
external function Boolean PODClassCost1_5EFAfter(Integer,Integer,Integer,Integer,Integer);
external function Boolean PODClassRowCost1_5EFAfter(Integer,Integer,Integer,Integer,Integer);
external function Boolean PODClassShipCostEFAfter(Integer,Integer,Integer,Integer);
external function Boolean PODClassCustomsCostEFAfter(Integer,Integer,Integer,Integer);
external function Boolean PODchrsum(record POVc,Integer);
external function Boolean UserCanChangePendingRecord(Integer);
external function Boolean OpenContactRecord(string,string);
external procedure ExtractObj(string,var Integer,var string);// Edit ************************** Thursday, 14 November 2013 13:36:52
remote updating procedure CreateLoyaltyCardRemote(record CUVc,var record LoyaltyCardVc);// Edit ************************** Tuesday, 1 April 2014 16:05:50
remote procedure IDPasteORinPO(var record POVc);
remote procedure PrintOSD(record RcVc,record OSDVc,string);
remote procedure IDPasteItemsPOinOR(var record POVc,var record ORVc); // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger10:18 28.09.2018
remote procedure NextM4SerialNumber(string,var string);//9:51 02.10.2018
external procedure PasteFromSysList(Integer,Integer);
remote updating function LongInt RecordAction_raPastePUInVI(record PUVc,var record VIVc,var string);
remote procedure CreatePufromIVforPLHandle(record RcVc,integer,var string);
remote updating function LongInt RecordAction_raPastePOInPUFromBPU(var record POVc,var record PUVc,var record BigPUVc);
remote updating function integer Remote_ORFromPOConsDsm(var record POVc,var record ORVc,var string);// Edit ************************** BPI Ukraine - KramarAlexandr - 03, 26 06 2019 y. at 2:42:07 PM
remote procedure PODClassWeightRow(var record POVc,integer);
remote procedure PODClassCaratRow(var record POVc,integer);
remote updating function Integer IDCreateVIFromPU(LongInt,record RcVc,var record VIVc,LongInt);
external updating procedure VIFromPUDsm();
remote procedure CheckVIForPU(LongInt,vector boolean,var vector boolean);
remote function Boolean ORVc_PasteArtCode(var record ORVc,Integer,var string,var string,Boolean);
remote updating function Integer RecordAction_raPastePOInVIFBCC (var record POvc, var record IVVc);
remote procedure PUSumUp(var record PUVc);
remote procedure PUCalcCostPrice(string,val,Integer,Integer,string,string,
                                   val,val,val,val,val,
                                   val,val,val,val,val,val,
                                   string,var val,val,var val,string,Integer);
remote function Boolean PUDchrsum(record PUVc,Integer);
remote procedure PUVc_PasteCostPrice(var record PUVc,Integer);
remote function boolean PTCCCodesCheck(string);
remote updating function LongInt RecordAction_raPasteOrdInShip2(var record SHVc,LongInt,var string);
remote updating function integer Remote_ORFromPOConsDsm2(var record POVc,var record ORVc,var string,longint);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
remote function string 60 RemoveObjectFromObjectList(string,string);
remote procedure ExtractObjectsByType(string, string, var array string, var integer);
remote function Boolean remPODClassTax15PercentSumEFAfter(var record POVc,Integer);  // Edit ****************** Ihor Trubachov 18*06*2021

SetLangMode(LangRussian,"RUS",0);
global
procedure PrintOSDD(Integer wn,Boolean previewf)
BEGIN
  record OSDVc OSDr;
  record RcVc RepSpec;
  
  GetWindowRecord(wn,OSDr);
  RepSpec.repname = "OSDRn";
  if (previewf) then begin
    RepSpec.Media = mtScreen;
  end else begin
    RepSpec.Media = mtPrinter;
  end;
  RepSpec.JobDf = 0;
  RepSpec.f1 = OSDr.Code;
  RepSpec.flags[2] = 1;
  RunReport(RepSpec,0);
	PrintDocument(OSDr,"PrintOSDD",previewf);
	
	
  RETURN;
END;


global procedure DoPrintOSDD(record RcVc RepSpec,record OSDVc OSDr)
BEGIN
boolean printf;
string 255 formcode;

formcode = "IDOSDFORM";

if (OpenForm(formcode)) then begin
		PrintOSD(RepSpec,OSDr,formcode)
		CloseForm;
	end else begin
		printf = false;
		MessageBox(1546,formcode);
	end;
	return;
END;

global
updating procedure DropSHFromPODsm()
begin
  record POVc POr;
  record DropSHVc DropSHr;
  LongInt r;
  Integer wn,nwn;
  Boolean testf;
  record AcceptSetBlock AcceptSet;
  record POSettingBlock POSb;
  
  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    if (WindowDoOK(wn,0)==false) then begin
      goto LDropSHFromPODsm;
    end;
  end;
  if (UserCanAction("POToDropSH",true)) then begin
    BlockLoad(POSb);
    GetWindowRecord(wn,POr);
    if (POr.Closed==0) then begin
      testf = true;
/*JJDS      
      if (POr.OrderType!=kOrderTypeDropShip) then begin 
        MessageBox(22073,"");
        testf = false;
        WindowFieldGoto(wn,POr,-1,"OrderType",true);
      end;
*/      
      if (testf) then begin
        r = RecordAction_raPastePOInDropSH(POr,DropSHr);
        switch (r) begin
          case -1: Beep;
          case -2: MessageBox(1281,"");
          case 0:
            nwn = OpenWindow("DropSHDClass",1,0,"","",DropSHr);
            SetRLink(wn,true);  
          otherwise
            MessageBox(r,"");
        end;
        UpdateBrowses("POVc");
      end;       
    end else begin
      MessageBox(22062,"");
    end;
  end else begin
    MessageBox(1274,StringFromStringSet(3,"POToDropSH"));
  end;    
LDropSHFromPODsm:;
  return;
end;

function Boolean AnyNextReservationsExists() // Could get better if we want to
begin
  record StockReservVc StockReservr;
  Boolean foundf;
  Boolean res;
  
  res = false;
  StockReservr.Donef = 0;
  StockReservr.ToFileName = kResTypeNextStockIn;
  StockReservr.ToSerNr = -1;
  foundf = true;
  while (LoopKey("ToItem",StockReservr,3,foundf)) begin
    if (StockReservr.Donef!=0) then begin foundf = false; end;
    if (StockReservr.ToFileName!=kResTypeNextStockIn) then begin foundf = false; end;
    if (StockReservr.ToSerNr!=-1) then begin foundf = false; end;
    if (foundf) then begin
      res = true;
      foundf = false;
    end;
  end;
  AnyNextReservationsExists = res;
  return;
end;

global
updating procedure PUFromPODsm()
BEGIN
  record POVc POr;
  record PUVc PUr, PU2r;
	row PUVc PUrw;
  LongInt r;
  Integer wn,nwn,err,cntIV,cntORIV,i,notenr;
  Boolean testf,TsTr,testf1,testVI,consPOf,corPOf;
  record POSettingBlock POSb;
	record VIVc VIr;
	row VIVc VIrw;
  record ConsCompBlock CCB;
	record AccBlock AccB;
	vector boolean vecVI;
	vector boolean vecVItest, vcorPOf;
	array string 255 tags;
	string 255 warning;
	row POVc POrw;
	record INVc INr;
	record RLinkVc RLr;
	vector string 255 RowArtCodes, CustomsCostRow;
	vector val ShipCostRow, Cost1Row, Cost2Row, Cost3Row, Cost4Row, Cost5Row;
	val p, s;
	
	
	BlockLoad(CCB);
	BlockLoad(AccB);
	
	cntORIV = 0;
	cntIV = 0;
  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    GetWindowRecord(wn,POr);
    switch (POr.OrderType) begin
      case kOrderTypeDropShip:
        DropSHFromPODsm;
        goto LPUFromPODsm; 
    end;
    if (UserCanAction("POToPU",true)) then begin
      BlockLoad(POSb);
      if (POr.Closed==0) then begin
        testf = true;
        if (POr.OKFlag==0) then begin 
          if ((AnyNextReservationsExists) or (POSb.POMustBeOKToPU!=0) or (UserCanAction("NotOKPOToPU",false))) then begin
            testf = false;
            MessageBox(20053,"");
          end; 
        end;
        err = POTestApprovalStatus(POr);
        if (err!=0) then begin
          MessageBox(err,"");
          testf = false;
        end;
        if (testf) then begin
					testf1 = true;
					if(CCB.OKFlagPOr!=0) then begin
						testVI = true;
						i = 0;
						if(nonblank(POr.CustomsCost) and POr.CustomsCost!=0) then begin vecVI["CustomsCost"] = true; vecVItest["CustomsCost"] = false; end;
						if(nonblank(POr.ShipCost) and POr.ShipCost!=0) then begin vecVI["ShipCost"] = true; vecVItest["ShipCost"] = false;  end;
						if(nonblank(POr.Cost1) and POr.Cost1!=0) then begin vecVI["Cost1"] = true; vecVItest["Cost1"] = false;  end;
						if(nonblank(POr.Cost2) and POr.Cost2!=0) then begin vecVI["Cost2"] = true; vecVItest["Cost2"] = false;  end;
						if(nonblank(POr.Cost3) and POr.Cost3!=0) then begin vecVI["Cost3"] = true; vecVItest["Cost3"] = false;  end;
						if(nonblank(POr.Cost4) and POr.Cost4!=0) then begin vecVI["Cost4"] = true; vecVItest["Cost4"] = false;  end;
						if(nonblank(POr.Cost5) and POr.Cost5!=0) then begin vecVI["Cost5"] = true; vecVItest["Cost5"] = false;  end;
						
						getvectortags(vecVItest,tags);
						CheckVIForPU(POr.SerNr,vecVI,vecVItest);
						ResetLoop(VIr);
						// if(currentcompany!=28)then begin
							// if(POr.ShipCostOKFlag!=0) then begin
								// if(blank(POr.ShipCost)) then begin testf1 = false;  MessageBox(36234,""); end;
							// end else begin	
								// if(blank(POr.ShipCost) or POr.ShipCost==0) then begin testf1 = false;  MessageBox(36234,""); end;
							// end;
							// if(POr.CustomsCostOKFlag!=0) then begin
								// if(blank(POr.CustomsCost)) then begin testf1 = false;  MessageBox(36235,""); end;
							// end else begin
								// if(blank(POr.CustomsCost) or POr.CustomsCost==0) then begin testf1 = false;  MessageBox(36235,""); end;
							// end;
							// if(blank(POr.Location)) then begin testf1 = false;  MessageBox(36208,""); end;
							// for(i=0;i<tags.length;i=i+1) begin
								// if(vecVItest[tags[i]]==false) then begin
									// testVI = false;
								// end;
							// end;
						// end else begin
							if(CurrentCompany==18)then begin
									
								for (i=0;i<matrowcnt(POr);i=i+1) begin
									matrowget(POr,i,POrw);
									RowArtCodes[i] = POrw.ArtCode;
								end;

							
								notenr = 1;
								while (ReadRecordLink(POr,notenr,PU2r,RLr)) begin
									for (i=0;i<matrowcnt(PU2r);i=i+1) begin
										matrowget(PU2r,i,PUrw);
										if(PUrw.ArtCode!=RowArtCodes[PUrw.OrdRow])then begin vcorPOf[PUrw.OrdRow] = true; end;
										if(PUrw.ArtCode==RowArtCodes[PUrw.OrdRow])then begin vcorPOf[PUrw.OrdRow] = false; end;
										ShipCostRow[PUrw.OrdRow] = PUrw.ShipCost;
										CustomsCostRow[PUrw.OrdRow] = PUrw.CustomsCost;
										Cost1Row[PUrw.OrdRow] = PUrw.RowCost1;
										Cost2Row[PUrw.OrdRow] = PUrw.RowCost2;
										Cost3Row[PUrw.OrdRow] = PUrw.RowCost3;
										Cost4Row[PUrw.OrdRow] = PUrw.RowCost4;
										Cost5Row[PUrw.OrdRow] = PUrw.RowCost5;
									end;
									notenr = notenr + 1;
								end;
								
								
								for (i=0;i<matrowcnt(POr);i=i+1) begin
									matrowget(POr,i,POrw);
									if(vcorPOf[i])then begin
										corPOf = true;
									end;
								end;
							end;
							
							if(POr.ExtraCostInPU==0 and !corPOf)then begin
								if(POr.ShipCostOKFlag!=0) then begin
									if(blank(POr.ShipCost)) then begin testf1 = false;  MessageBox(36234,""); end;
								end else begin	
									if(blank(POr.ShipCost) or POr.ShipCost==0) then begin testf1 = false;  MessageBox(36234,""); end;
								end;
								
								
								consPOf = false; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 18:22 16.12.2019
								if(matrowcnt(POr)>0)then begin
									matrowget(POr,0,POrw);
									if(POrw.ConsgType==1)then begin
										consPOf = true;
									end;
								end;
								
								
								
								
								
								if(!consPOf)then begin
									if(POr.CustomsCostOKFlag!=0) then begin
										if(blank(POr.CustomsCost)) then begin testf1 = false;  MessageBox(36235,""); end;
									end else begin
										if(blank(POr.CustomsCost) or POr.CustomsCost==0) then begin testf1 = false;  MessageBox(36235,""); end;
									end;
								end;
								if(blank(POr.Location)) then begin testf1 = false;  MessageBox(36208,""); end;
								for(i=0;i<tags.length;i=i+1) begin
									if(vecVItest[tags[i]]==false) then begin
										testVI = false;
										testf1 = false;
										switch(tags[i]) begin
											case "CustomsCost": if(blank(warning)) then begin warning = "Таможня";
												end else begin warning = warning & ",Таможня"; end;
											case "ShipCost": if(blank(warning)) then begin warning = "Фрахт";
												end else begin warning = warning & ",Фрахт"; end;
											case "Cost1": if(blank(warning)) then begin warning = "Накл. расходы 1";
												end else begin warning = warning & ",Накл. расходы 1"; end;
											case "Cost2": if(blank(warning)) then begin warning = "Накл. расходы 2";
												end else begin warning = warning & ",Накл. расходы 2"; end;
											case "Cost3": if(blank(warning)) then begin warning = "Накл. расходы 3";
												end else begin warning = warning & ",Накл. расходы 3"; end;
											case "Cost4": if(blank(warning)) then begin warning = "Накл. расходы 4";
												end else begin warning = warning & ",Накл. расходы 4"; end;
											case "Cost5": if(blank(warning)) then begin warning = "Накл. расходы 5";
												end else begin warning = warning & ",Накл. расходы 5"; end;
										end;		
									end;
								end;
							end;
							if(!testVI) then begin MessageBox(36236,warning); end; 
						// end;  MessageBox(36236,""); end;
					end;	
					if(testf1) then begin
						r = RecordAction_raPastePOInPU(POr,PUr);
						
						
						switch (r) begin
							case -1: Beep;
							case -2: MessageBox(1281,"");
							case 0:
								if(corPOf)then begin
									for (i=0;i<matrowcnt(PUr);i=i+1) begin
										matrowget(PUr,i,PUrw);
										PUrw.ShipCost = ShipCostRow[PUrw.OrdRow];
										PUrw.CustomsCost = CustomsCostRow[PUrw.OrdRow];
										PUrw.RowCost1 = Cost1Row[PUrw.OrdRow];
										PUrw.RowCost2 = Cost2Row[PUrw.OrdRow];
										PUrw.RowCost3 = Cost3Row[PUrw.OrdRow];
										PUrw.RowCost4 = Cost4Row[PUrw.OrdRow];
										PUrw.RowCost5 = Cost5Row[PUrw.OrdRow];
										matrowput(PUr,i,PUrw);
										PUCalcCostPrice(PUrw.ArtCode,PUrw.UPrice,PUr.InclVAT,PUr.NoTAXonVAT,PUrw.Extra,PUr.CurncyCode,
												PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,
												PUrw.ShipCost,PUrw.RowCost1,PUrw.RowCost2,PUrw.RowCost3,PUrw.RowCost4,PUrw.RowCost5,
												PUrw.CustomsCost,p,PUrw.Quant,s,PUrw.VATCode,PUr.ExportFlag);
										PUrw.CostPrice = p;
										PUrw.Sum = s;
										MatRowPut(PUr,i,PUrw);
										PUDchrsum(PUr,i);
									end;
									PUSumUp(PUr);
									if (RecordStore(PUr,true)) then begin end;
								end;
								nwn = OpenWindow("PUDClass",1,0,"","",PUr);
								SetRLink(wn,true);  
							otherwise
								MessageBox(r,"");
						end;
						UpdateBrowses("POVc");
					end;	
        end;       
      end else begin
        MessageBox(22062,"");
      end;
    end else begin
      MessageBox(1274,StringFromStringSet(3,"POToPU"));
    end;    
  end else begin
    Beep;
  end;
LPUFromPODsm:;  
  return;
end;

global
updating function LongInt PUFromBigPUDsm(record BPUVc BPUr,var array longInt PUNr)
BEGIN
  record POVc POr;
  record PUVc PUr;
	row BigPUVc BPUrw;
  LongInt r;
	integer i;
  Integer wn,nwn,err,cntIV,cntORIV,j,count;
  Boolean testf,TsTr,testf1,testVI;
  record POSettingBlock POSb;
	record VIVc VIr;
	row VIVc VIrw;
  record ConsCompBlock CCB;
	record AccBlock AccB;
	vector boolean vecVI;
	array boolean arrVI;
	vector boolean created;
	array string 255 PONr;
	integer cnti;
	record PUVc oldPUr;
	row PUVc PUrw;
	record ClientItemStatusVc CISr;
	record ORVc ORr;
	integer orcnt,k;
	row ORVc ORrw;
	string 255 warning;
	
	BlockLoad(CCB);
	BlockLoad(AccB);
	
	cntORIV = 0;
	cntIV = 0;
		cnti = 0;
	for(j=0;j<matrowcnt(BPUr);j=j+1) begin
		matrowget(BPUr,j,BPUrw);
		if(!created[BPUrw.FromOrdNr]) then begin
			PONr[cnti] = BPUrw.FromOrdNr;
			// messagebox(0,PONr[cnti]);
			cnti = cnti + 1;
			created[BPUrw.FromOrdNr] = true;
		end;
	end;
	testf1 = true;
	testf = true;
	
		for(j=0;j<PONr.length;j=j+1) begin
			if(testf1) then begin
				POr.SerNr = PONr[j];
				ReadFIrstMain(POr,1,true);
				r = RecordAction_raPastePOInPUFromBPU(POr,PUr,BPUr);
				switch (r) begin
					case -1: Beep; 
					case -2: 
					case 0:
						//nwn = OpenWindow("PUDClass",1,0,"","",PUr);
						// recordCopy(oldPUr,PUr);
						// PUr.ShipCostOKFlag=1;
						// PUr.CustomsCostOKFlag=1;
						// PUr.OKFlag = 1;
						// if(RecordUpdate(oldPUr,PUr,true)==0) then begin
						// end;
						SetRLink(wn,true);  
					otherwise
						//MessageBox(r,"");
				end;
				UpdateBrowses("POVc");
				// PUNr[j] = PUr.SerNr;
			end;	
		end;	
		// for(j=0;j<PUNr.length;j=j+1) begin
			// RecordNew(oldPUr);
			// PUr.SerNr = PUNr[j];
			// if(ReadFirstMain(PUr,1,true)) then begin
				// recordCopy(oldPUr,PUr);
				// PUr.ShipCostOKFlag=1;
				// PUr.CustomsCostOKFlag=1;
				// PUr.OKFlag = 1;
				// if(RecordUpdate(oldPUr,PUr,true)==0) then begin
					// /*POr.SerNr = PONr[j]; ///=========================== moved to PUVcRecordUpdateAfter 
					// if(ReadFirstMain(POr,1,true)) then begin 
						// ORr.SerNr = POr.OrdNr;
						// if(readfirstmain(ORr,1,true))then begin
							// if(ORr.OrderClass=="CLIEN") then begin
								// for(i=0;i<matrowcnt(PUr);i=i+1) begin
									// matrowget(PUr,i,PUrw);
									// CISr.ItemCode = PUrw.ArtCode;
									// CISr.OrderNr = POr.OrdNr;
									// if(readfirstmain(CISr,2,true))then begin
										// CISr.Quant = CISr.Quant + PUrw.Quant;
										// RecordStore(CISr,true);
									// end;
								// end;
							// end;	
							// orcnt = matrowcnt(ORr);
							// for (k=0;k<orcnt;k=k+1)begin
								// matrowget(ORr,k,ORrw);
								// ORVc_PasteArtCode(ORr,k,warning,warning,false);							
								// matrowget(ORr,k,ORrw);
								// matrowput(ORr,k,ORrw);
							// end;
							// RecordStore(ORr,true);
						// end;	
					// end;	*/
					
				// end;
			// end;	
		// end;
		PUFromBigPUDsm = r;		
  return;
end;





global
updating procedure ECPUFromPODsm(var record POVc POr, var record PUVc PUr)
BEGIN
  row POVc POrw;
  row PUVc PUrw;
	record ORVc ORr;
	row ORVc ORrw;
  LongInt r;
  Integer mtrw,i,j,ormtrw, orn;
  Boolean testf;
  record POSettingBlock POSb;
	vector string 255 SerialNumber;
	record VIVc VIr;
	string 255 errmsg;
	record RLinkVc RLinkr;
	record IVVc IVr;
	record RcVc RepSpec;
  
  
  r = RecordAction_raPastePOInPU(POr,PUr);
	if(Readfirstmain(PUr,1,true))then begin
		if(r==0)then begin
			ORr.SerNr = POr.InvAddr4;
			if(ReadFirstMain(ORr,1,true))then begin
				ormtrw = matrowcnt(ORr);
				for (i=0;i<ormtrw;i=i+1) begin
					matrowget(ORr,i,ORrw);
					SerialNumber[ORrw.ArtCode] = ORrw.SerialNr;
				end;
			end;
			
			mtrw = matrowcnt(PUr);
			for (i=0;i<mtrw;i=i+1)begin
				matrowget(PUr,i,PUrw);
				PUrw.SerialNr = SerialNumber[PUrw.ArtCode];
				PUrw.CostPrice = PUrw.CostPrice * 0.64;
				matrowput(PUr,i,PUrw);
			end;
			PUr.PONr = "";
		end;
	end;        
  return;
end;

global
updating procedure CCPUFromPODsm(var record POVc POr, var record PUVc PUr, vector val TotCostPrice, vector boolean SHOutItems, vector boolean SHConsItems)
BEGIN
  row POVc POrw;
  row PUVc PUrw;
	record ORVc ORr;
	row ORVc ORrw;
  LongInt r;
  Integer mtrw,i,j,ormtrw, orn;
  Boolean testf;
  record POSettingBlock POSb;
	vector string 255 SerialNumber;
	record VIVc VIr;
	string 255 errmsg, ConsStock;
	record RLinkVc RLinkr;
	record IVVc IVr;
	record RcVc RepSpec;
	record LocationVc Locr;
  
  
  r = RecordAction_raPastePOInPU(POr,PUr);
	if(Readfirstmain(PUr,1,true))then begin
		Locr.Code = PUr.Location;
		if (ReadFIrstMain(Locr,1,true)) then begin
			ConsStock = Locr.ConsigStockCode;
		end;
		
		if(r==0)then begin
			ORr.SerNr = POr.InvAddr4;
			if(ReadFirstMain(ORr,1,true))then begin
				ormtrw = matrowcnt(ORr);
				for (i=0;i<ormtrw;i=i+1) begin
					matrowget(ORr,i,ORrw);
					SerialNumber[ORrw.ArtCode] = ORrw.SerialNr;
				end;
			end;
			
			mtrw = matrowcnt(PUr);
			for (i=mtrw-1;i>=0;i=i-1)begin
				matrowget(PUr,i,PUrw);
				if (TotCostPrice[PUrw.ArtCode & "_" & i + 1]!=blankval) then begin
					matrowget(PUr,i,PUrw);
					PUrw.SerialNr = SerialNumber[PUrw.ArtCode];
					PUrw.CostPrice = TotCostPrice[PUrw.ArtCode & "_" & i + 1];
					logtext(0,TotCostPrice[PUrw.ArtCode & "_" & i + 1] & " TCP");
					matrowput(PUr,i,PUrw);
					PUVc_PasteCostPrice(PUr,i);
					matrowget(PUr,i,PUrw);
					matrowput(PUr,i,PUrw);
					if (SHConsItems[PUrw.ArtCode & "_" & i + 1]) then begin
						PUrw.Location = ConsStock;
						matrowput(PUr,i,PUrw);
					end;
				end;
			end;
			// PUSumUp(PUr);
		end;
	end;        
  return;
end;




global
updating procedure CCPUFromLocalPODsm(var record POVc POr, var record PUVc PUr, vector val TotCostPrice, vector val SHInItems, vector boolean SHConsItems, vector val OtherCompCCQty)
BEGIN
  row POVc POrw;
  row PUVc PUrw;
	record ORVc ORr;
	row ORVc ORrw;
  LongInt r;
  Integer mtrw,i,j,ormtrw, orn;
  Boolean testf;
  record POSettingBlock POSb;
	vector string 255 SerialNumber;
	record VIVc VIr;
	string 255 errmsg, ConsStock;
	record RLinkVc RLinkr;
	record IVVc IVr;
	record RcVc RepSpec;
	record LocationVc Locr;
  
  
  r = RecordAction_raPastePOInPU(POr,PUr);
	if(Readfirstmain(PUr,1,true))then begin
		Locr.Code = PUr.Location;
		if (ReadFIrstMain(Locr,1,true)) then begin
			ConsStock = Locr.ConsigStockCode;
		end;
		
		if(r==0)then begin
			ORr.SerNr = POr.InvAddr4;
			if(ReadFirstMain(ORr,1,true))then begin
				ormtrw = matrowcnt(ORr);
				for (i=0;i<ormtrw;i=i+1) begin
					matrowget(ORr,i,ORrw);
					SerialNumber[ORrw.ArtCode] = ORrw.SerialNr;
				end;
			end;
			
			mtrw = matrowcnt(PUr);
			for (i=0;i<mtrw;i=i+1)begin
				matrowget(PUr,i,PUrw);
				if (SHInItems[PUrw.ArtCode & "_" & i + 1]>0) then begin
					matrowget(PUr,i,PUrw);
					PUrw.SerialNr = SerialNumber[PUrw.ArtCode];
					PUrw.CostPrice = TotCostPrice[PUrw.ArtCode & "_" & i + 1];
					logtext(0,TotCostPrice[PUrw.ArtCode & "_" & i + 1] & " TCP");
					matrowput(PUr,i,PUrw);
					PUVc_PasteCostPrice(PUr,i);
					matrowget(PUr,i,PUrw);
					PUrw.OtherCompCCQty = OtherCompCCQty[PUrw.ArtCode & "_" & i + 1];
					matrowput(PUr,i,PUrw);
					if (SHConsItems[PUrw.ArtCode & "_" & i + 1]) then begin
						PUrw.Location = ConsStock;
						matrowput(PUr,i,PUrw);
					end;
				end else begin
					matrowdelete(PUr,i);
					i=i-1;
					mtrw = matrowcnt(PUr);
				end;
			end;
			// PUSumUp(PUr);
		end;
	end;        
  return;
end;




global  //Transfered by ----------------------Dima  19.05.2015
procedure NormalizeClassName(var string classname)
begin
string 200 newclassname,c;
integer i,lenth,zercnt;
  
  lenth = len(classname);
  newclassname = "";

  if(lenth>0)then begin
    i=lenth - 1;
    while(mid(classname,i,1)==" " and i>=0)begin
      i=i-1;
    end;
  end;
  newclassname = mid(classname,0,i+1);
  
  lenth = len(newclassname);
  if(lenth>0)then begin
    i=0;
    while(mid(classname,i,1)==" " and i<lenth)begin
      i=i+1;
    end;
  end;
  newclassname = mid(newclassname,i,lenth-i);
      
  classname = newclassname;
  newclassname = "";
  lenth = len(classname);
  For(i=0;i<lenth;i=i+1) begin
	  c=mid(classname,i,1);
	  if(asc(c)<32 or asc(c)>126)then begin
	    c="_";
	    newclassname = newclassname & c;
	  end else begin
	    newclassname = newclassname & c;
	  end;
	  
	end; 
  classname = newclassname;
return;
end;

global procedure NormalizeName(var string name)				//Transfered by ----------------------Dima  19.05.2015
begin
string 200 newclassname,c;
integer i,lenth,zercnt;
  
  lenth = len(name);
  for(i=0;i<lenth;i=i+1)begin
  	if((asc(mid(name,i,1))>31 and asc(mid(name,i,1))<127) or (asc(mid(name,i,1))>1039 and asc(mid(name,i,1))<1111))then begin
  		if(mid(name,i,1)!="\"")then begin
  		newclassname = newclassname & mid(name,i,1);
  		end;
  	end;
  end;
  name = newclassname;
return;
end;

global procedure NormalizeArtCode(var string name)			//Transfered by ----------------------Dima  19.05.2015
begin
string 200 newclassname,c;
integer i,lenth,zercnt;
  
  lenth = len(name);
  for(i=0;i<lenth;i=i+1)begin
  	if((asc(mid(name,i,1))>31 and asc(mid(name,i,1))<127) or (asc(mid(name,i,1))>1039 and asc(mid(name,i,1))<1111))then begin
  		if((mid(name,i,1)!="\"") and (mid(name,i,1)!=" ") and (mid(name,i,1)!=","))then begin
  		newclassname = newclassname & mid(name,i,1);
  		end;
  	end;
  end;
  name = newclassname;
return;
end;


global
updating function Boolean PODClassPrint(Integer wn,Boolean previewf)
begin
  record POVc POr;
  Boolean testf;
  Integer err;
 
  testf = true;
  DeselectWindow(wn,false);
  GetWindowRecord(wn,POr); 
  if (UserCanAction("PrintPreviewNotApproved",false)==false) then begin
    err = POTestApprovalStatus(POr);
  end;
  if (err!=0) then begin
    MessageBox(err,"");
    testf = false;
  end;
  if (testf) then begin
    RecordActionPO_Print(POr,false,true);
  end;
  PODClassPrint = true;
  return;
end;

global
updating procedure PrintPOL(Integer wn,Boolean previewf)
BEGIN
  record POVc POr;
  Integer i,err;
  
  StartPrintDialogGroup;
  i = 1;
  while (GetRecordFromBrowse(POr,wn,i)) begin
    err = POTestApprovalStatus(POr);
    if (err!=0) then begin
      MessageBox(err," " & POr.SerNr);
      goto LSKIPOrderPOL;
    end;
    RecordActionPO_Print(POr,previewf,true);
LSKIPOrderPOL:;    
    i = i + 1;
  end;
  EndPrintDialogGroup;
  RETURN;
END;


global
procedure POCreatePOLsm()
BEGIN
  Integer nwn,wn;
  record RcVc RepSpec;

  wn = CurWindow;
  ReportDefaults(RepSpec,"CreatePOVClass");
  nwn = OpenWindow("CreatePOVClass",1,wn,"","",RepSpec);
  DeselectWindow(nwn,false);
  RepSpec.repname = "POCreateMn";
  PutWindowRecord(nwn,RepSpec);
  RETURN;
END;

global
updating function Boolean CreatePOVClassOnOKWindow(Integer wn)
BEGIN
  record RcVc RepSpec;
  
  GetWindowRecord(wn,RepSpec);
  POCreate(RepSpec);
  CloseWindow(wn);
  CreatePOVClassOnOKWindow = false;
  RETURN;
END;




// global
// function Boolean WeightRowAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
// BEGIN
  // Boolean res;
	// res = PODClassWeightRowEFAfter(wn,fn,rownr,changed,4);
  // WeightRowAfterEditField = res;
  // RETURN;
// END;

// global
// function Boolean CaratRowAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
// BEGIN
  // Boolean res;
	// res = PODClassCaratRowEFAfter(wn,fn,rownr,changed,4);
  // CaratRowAfterEditField = res;
  // RETURN;
// END;


// global
// function Boolean CaratTipeSetAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
// BEGIN
  // Boolean res;
	// res = PODClassCaratRowEFAfter(wn,fn,rownr,changed,4);
  // CaratTipeSetAfterEditField = res;
  // RETURN;
// END;


global
updating procedure PUFromPOLsm()
BEGIN
  record POVc POr;
  record PUVc PUr;
  LongInt r;
  Integer wn,nwn,err;
  Boolean testf;
  record POSettingBlock POSb;
  
  wn = CurWindow;
  if (UserCanAction("POToPU",true)) then begin
    if (ReadMarkedRecord(wn,POr)) then begin//Rs_normal
      testf = true;
      BlockLoad(POSb);
      if (POr.OKFlag==0) then begin 
        if ((AnyNextReservationsExists) or (POSb.POMustBeOKToPU!=0) or (UserCanAction("NotOKPOToPU",false))) then begin
          testf = false;
          MessageBox(20053,"");
        end; 
      end;
      err = POTestApprovalStatus(POr);
      if (err!=0) then begin
        MessageBox(err,"");
        testf = false;
      end;
      if (testf) then begin
        r = RecordAction_raPastePOInPU(POr,PUr);
        switch (r) begin
          case -1: Beep;
          case -2: MessageBox(1281,"");
          otherwise
            nwn = OpenWindow("PUDClass",1,0,"","",PUr);
        end;
        UpdateBrowses("POVc");
      end;
    end else begin
      MessageBox(1274,StringFromStringSet(3,"POToPU"));
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;

global
updating procedure OKPOLsm()
BEGIN
  record POVc POr;
  Integer i;
  Integer wn,err;
  Boolean testf;
  
  if (UserCanAction("POOK",true)) then begin
    wn = CurWindow;
    i = 1;
    while (GetRecordFromBrowse(POr,wn,i)) begin
      testf = true;
      err = POTestApprovalStatus(POr);
      if (err!=0) then begin
        MessageBox(err,"");
        testf = false;
      end;
      if (testf) then begin
        if (RecordAction_rlPOLOK(POr)) then begin
        end;
      end;
      i = i + 1;
    end;
    UpdateBrowses("POVc");
  end else begin
    MessageBox(1274,StringFromStringSet(3,"POOK"));
  end;
  RETURN;
END;

global
updating procedure ClosePOLsm()
BEGIN
  record POVc POr;
  Integer i;
  Integer wn;
  
  wn = CurWindow;
  i = 1;
  while (GetRecordFromBrowse(POr,wn,i)) begin
    if (RecordAction_rlPOLClose(POr)) then begin
    end;
    i = i + 1;
  end;
  UpdateBrowses("POVc");
  RETURN;
END;
/*
global
updating procedure VIFromPODsm()
BEGIN
  record POVc POr;
  record VIVc VIr;
  LongInt r;
  Integer wn,nwn;
  
  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    if (UserCanAction("POToVI",true)) then begin
      GetWindowRecord(wn,POr);
      r = RecordAction_raPastePOInVI(POr,VIr);
      if (r!=0) begin
        if (r>0) then begin
          MessageBox(r,"");
        end else begin
          Beep;
        end;
      end else begin
        nwn = OpenWindow("VIDClass",1,0,"","",VIr);
        VIOpenPrepExists(VIr.VECode);          
        SetRLink(wn,true);  
      end;
      UpdateBrowses("POVc");
    end else begin
      MessageBox(1274,StringFromStringSet(3,"POToVI"));
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;
*/




global
updating procedure VIForBrndShipCFromPODsm()
BEGIN
  record POVc POr;
  record VIVc VIr;
  LongInt r;
  Integer wn,nwn;
  
  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    if (UserCanAction("POToVI",true)) then begin
			GetWindowRecord(wn,POr);
			if (POr.Cost3==blankval or POr.Cost3==0) then begin
				r = RecordAction_raPastePOInVIFBCC(POr,VIr);
				if (r!=0) begin
					if (r>0) then begin
						MessageBox(r,"");
					end else begin
						Beep;
					end;
				end else begin
					nwn = OpenWindow("VIDClass",1,0,"","",VIr);
					VIOpenPrepExists(VIr.VECode);          
					SetRLink(wn,true);  
				end;
				UpdateBrowses("POVc");
			end else begin
				MessageBox(36384,"");
			end;
    end else begin
      MessageBox(1274,StringFromStringSet(3,"POToVI"));
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;






global
updating procedure VIFromPODExecute(LongInt PONr)
begin
  Integer nwn;
  record RcVc RepSpec;
  record POSettingBlock POSb;
  record VIVc VIr;
  Integer r;

  if (UserCanAction("POToVI",true)) then begin
    BlockLoad(POSb);
    ReportDefaults(RepSpec,"VIFromPOVClass");
    RepSpec.repname = "";
    RepSpec.FirstVer = PONr;
    RepSpec.flags[0] = 1;
    if (POSb.OpenCreateVIFromPO!=0) then begin
      nwn = OpenWindow("VIFromPOVClass",1,0,"","",RepSpec);
      PutWindowRecord(nwn,RepSpec);
      SelectWindow(nwn);
    end else begin
      RepSpec.flags[0] = 1;
      RepSpec.flags[1] = 1;
      RepSpec.flags[2] = 1;
      RepSpec.flags[3] = 1;
      RepSpec.flags[4] = 1;
      RepSpec.flags[5] = 1;
      RepSpec.flags[6] = 1;
      RepSpec.flags[7] = 1;
      r = CreateVIFromPO(RepSpec.FirstVer,RepSpec,VIr);
      if (r!=0) begin
        if (r>0) then begin
          MessageBox(r,"");
        end else begin
          Beep;
        end;
      end else begin
        nwn = OpenWindow("VIDClass",1,0,"","",VIr);
        VIOpenPrepExists(VIr.VECode);        
        UpdateBrowses("POVc");    
        if (DateWarned(VIr.TransDate,"VIVc")) then begin
          MessageBox(1045,"");
        end;
      end;      
    end;
  end else begin
    MessageBox(1274,StringFromStringSet(3,"POToVI"));
  end;
  return;
end;







global
updating procedure VIFromPODExecute2(LongInt PONr,longInt mwn)
begin
  Integer nwn;
  record RcVc RepSpec;
  record POSettingBlock POSb;
  record VIVc VIr;
  Integer r;

  if (UserCanAction("POToVI",true)) then begin
    BlockLoad(POSb);
    ReportDefaults(RepSpec,"VIFromPOVClass");
    RepSpec.repname = "";
    RepSpec.FirstVer = PONr;
    RepSpec.flags[0] = 1;
    if (POSb.OpenCreateVIFromPO!=0) then begin
      nwn = OpenWindow("VIFromPOVClass",1,mwn,"","",RepSpec);
      PutWindowRecord(nwn,RepSpec);
      SelectWindow(nwn);
    end else begin
      RepSpec.flags[0] = 1;
      RepSpec.flags[1] = 1;
      RepSpec.flags[2] = 1;
      RepSpec.flags[3] = 1;
      RepSpec.flags[4] = 1;
      RepSpec.flags[5] = 1;
      RepSpec.flags[6] = 1;
      RepSpec.flags[7] = 1;
			RepSpec.flags[8] = 1; // Edit ****************** Ihor Trubachov 22*06*2021
      r = CreateVIFromPO(RepSpec.FirstVer,RepSpec,VIr);
      if (r!=0) begin
        if (r>0) then begin
          MessageBox(r,"");
        end else begin
          Beep;
        end;
      end else begin
        nwn = OpenWindow("VIDClass",1,0,"","",VIr);
        VIOpenPrepExists(VIr.VECode);        
        UpdateBrowses("POVc");    
        if (DateWarned(VIr.TransDate,"VIVc")) then begin
          MessageBox(1045,"");
        end;
      end;      
    end;
  end else begin
    MessageBox(1274,StringFromStringSet(3,"POToVI"));
  end;
  return;
end;









global
updating procedure VIFromPUDExecute(LongInt PONr, LongInt PUNr)
begin
  Integer nwn;
  record RcVc RepSpec;
  record POSettingBlock POSb;
  record VIVc VIr;
  Integer r;

  // if (UserCanAction("POToVI",true)) then begin
    BlockLoad(POSb);
    ReportDefaults(RepSpec,"VIFromPOVClass");
    RepSpec.repname = "";
    RepSpec.FirstVer = PONr;
		RepSpec.BaseWidth = PUNr;
    RepSpec.flags[0] = 1;
    if (POSb.OpenCreateVIFromPO!=0) then begin
      nwn = OpenWindow("IDVIFromPUVClass",1,0,"","",RepSpec);
      PutWindowRecord(nwn,RepSpec);
      SelectWindow(nwn);
    end else begin
      RepSpec.flags[0] = 1;
      RepSpec.flags[1] = 1;
      RepSpec.flags[2] = 1;
      RepSpec.flags[3] = 1;
      RepSpec.flags[4] = 1;
      RepSpec.flags[5] = 1;
      RepSpec.flags[6] = 1;
      RepSpec.flags[7] = 1;
			RepSpec.flags[8] = 1; // Edit ****************** Ihor Trubachov 23*06*2021
      r = IDCreateVIFromPU(RepSpec.FirstVer,RepSpec,VIr,PUNr);
      if (r!=0) begin
        if (r>0) then begin
          MessageBox(r,"");
        end else begin
          Beep;
        end;
      end else begin
        nwn = OpenWindow("VIDClass",1,0,"","",VIr);
        VIOpenPrepExists(VIr.VECode);        
        UpdateBrowses("POVc");    
        if (DateWarned(VIr.TransDate,"VIVc")) then begin
          MessageBox(1045,"");
        end;
      end;      
    end;
  // end else begin
    // MessageBox(1274,StringFromStringSet(3,"POToVI"));
  // end;
  return;
end;





global
updating procedure VIFromPUDafterBigPU(LongInt PONr, LongInt PUNr)
begin
  Integer nwn, mwn;
  record RcVc RepSpec;
  record POSettingBlock POSb;
  record VIVc VIr;
  Integer r;
	record PUVc PUr;

  // if (UserCanAction("POToVI",true)) then begin
    BlockLoad(POSb);
    ReportDefaults(RepSpec,"VIFromPOVClass");
    RepSpec.repname = "";
    RepSpec.FirstVer = PONr;
		RepSpec.BaseWidth = PUNr;
    RepSpec.flags[0] = 1;
		mwn = CurWindow;
		getwindowrecord(mwn,PUr);
		RepSpec.f1 = PUr.VECode;
		RepSpec.flags[0] = 1;
		RepSpec.flags[1] = 0;
		RepSpec.flags[2] = 0;
		RepSpec.flags[3] = 0;
		RepSpec.flags[4] = 0;
		RepSpec.flags[5] = 0;
		RepSpec.flags[6] = 0;
		RepSpec.flags[7] = 0;
		RepSpec.flags[8] = 1; // Edit ****************** Ihor Trubachov 23*06*2021
		r = IDCreateVIFromPU(RepSpec.FirstVer,RepSpec,VIr,PUNr);
		LogText(0," Go___________________________________________________________________________________________________________________");
		if (r!=0) begin
			if (r>0) then begin
				MessageBox(r,"");
			end else begin
				Beep;
			end;
		end else begin
			nwn = OpenWindow("VIDClass",1,0,"","",VIr);
			VIOpenPrepExists(VIr.VECode);        
			UpdateBrowses("POVc");    
			if (DateWarned(VIr.TransDate,"VIVc")) then begin
				MessageBox(1045,"");
			end;
		end;      
  return;
end;






global
updating procedure IDFCVIFromPUDsm()
BEGIN
  record PUVc PUr;
  record VIVc VIr;
  LongInt r;
  Integer wn,nwn;
  string 255 errmsg;
  
  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    GetWindowRecord(wn,PUr);
		if (UserCanAction("PUToVI",true)) then begin
			r = RecordAction_raPastePUInVI(PUr,VIr,errmsg);
			switch (r) begin
				case  0:
					nwn = OpenWindow("VIDClass",1,0,"","",VIr);
					VIOpenPrepExists(VIr.VECode);          
				case -1: Beep;
				case -2: MessageBox(1281,"");
				otherwise
					MessageBox(r,errmsg);
			end;
			UpdateBrowses("PUVc");
    end else begin
      Beep;
    end;
  end else begin
    Beep;
  end;
  RETURN;
END;





global
updating procedure IDVIFromPUDsm()
BEGIN
  record PUVc PUr;
  record VIVc VIr;
  LongInt r;
  Integer wn,nwn;
  string 255 errmsg;
	record POVc POr;
	record RLinkVc RLr;
	boolean BPuf;
	record BigPUVc BPUr;
	
  
	
  wn = CurWindow;
  if (WindowState(wn)==Rs_normal) then begin
    GetWindowRecord(wn,PUr);
		if (ReadRecordLink(PUr,1,BPUr,RLr)) then begin
			BPuf = true;
		end;
		POr.SerNr = PUr.PONr;
		if(ReadFIrstMain(POr,1,true))then begin end;
		if(POr.ExtraCostInPU==1 and !BPuf)then begin
			VIFromPUDExecute(PUr.PONr, PUr.SerNr);
		end else begin
			if (!BPuf) then begin
				IDFCVIFromPUDsm;
				LogText(0,"2 Go___________________________________________________________________________________________________________________");
			end else begin
				VIFromPUDafterBigPU(PUr.PONr, PUr.SerNr);
			end;
		end;
  end else begin
    Beep;
  end;
  RETURN;
END;



global
updating procedure VIFromPODsm()
begin
  Integer wn;
  record POVc POr;

  wn = CurWindow;
  if (WindowState(wn)==Rs_normal) then begin
    GetWindowRecord(wn,POr);
    VIFromPODExecute2(POr.SerNr,wn);
  end else begin
    Beep;
  end;
  RETURN;
END;

global
updating function Boolean VIFromPOVClassOnOKWindow(Integer wn)
BEGIN
  record RcVc RepSpec;
  record VIVc VIr;
  Integer nwn;
  Integer r;
  
  GetWindowRecord(wn,RepSpec);
  if (blank(RepSpec.f1)) then begin
    if (RepSpec.flags[0]==0) then begin
//      if ((RepSpec.flags[1]!=0) or (RepSpec.flags[2]!=0) or (RepSpec.flags[3]!=0) or (RepSpec.flags[4]!=0) or (RepSpec.flags[5]!=0) or (RepSpec.flags[6]!=0) or (RepSpec.flags[7]!=0)) then begin
      if ((RepSpec.flags[6]!=0) or (RepSpec.flags[7]!=0)) then begin
        MessageBox(0,USetStr(10426));
        WindowFieldGoto(wn,RepSpec,-1,"f1",true);        
        goto LVIFromPOVClassOnOKWindow;
      end;
    end;
  end;
  r = CreateVIFromPO(RepSpec.FirstVer,RepSpec,VIr);
  if (r!=0) begin
    if (r>0) then begin
      MessageBox(r,"");
    end else begin
      Beep;
    end;
  end else begin
    nwn = OpenWindow("VIDClass",1,0,"","",VIr);
    VIOpenPrepExists(VIr.VECode);        
    UpdateBrowses("POVc");    
  end;
  CloseWindow(wn);
LVIFromPOVClassOnOKWindow:;  
  VIFromPOVClassOnOKWindow = false;
  RETURN;
END;



global
updating function Boolean IDVIFromPUVClassOnOKWindow(Integer wn)
BEGIN
  record RcVc RepSpec;
  record VIVc VIr;
  Integer nwn,mwn;
  Integer r;
  mwn = MotherWindow(wn);
  GetWindowRecord(wn,RepSpec);
  if (blank(RepSpec.f1)) then begin
    if (RepSpec.flags[0]==0) then begin
//      if ((RepSpec.flags[1]!=0) or (RepSpec.flags[2]!=0) or (RepSpec.flags[3]!=0) or (RepSpec.flags[4]!=0) or (RepSpec.flags[5]!=0) or (RepSpec.flags[6]!=0) or (RepSpec.flags[7]!=0)) then begin
      if ((RepSpec.flags[6]!=0) or (RepSpec.flags[7]!=0)) then begin
        MessageBox(0,USetStr(10426));
        WindowFieldGoto(wn,RepSpec,-1,"f1",true);        
        goto LVIFromPOVClassOnOKWindow;
      end;
    end;
  end;
  r = IDCreateVIFromPU(RepSpec.FirstVer,RepSpec,VIr,RepSpec.BaseWidth);
  if (r!=0) begin
    if (r>0) then begin
      MessageBox(r,"");
    end else begin
      Beep;
    end;
  end else begin
    nwn = OpenWindow("VIDClass",1,0,"","",VIr);
    VIOpenPrepExists(VIr.VECode);        
    UpdateBrowses("POVc");    
  end;
  CloseWindow(wn);
LVIFromPOVClassOnOKWindow:;  
  IDVIFromPUVClassOnOKWindow = false;
  RETURN;
END;




procedure PODSwitchRow(Integer wn,Integer rownr)
BEGIN
  record POVc POr;  
  row POVc POrw; 
  Integer rwcnt;
  Boolean res;
  val t,tproc,unitprdisc,s,rowsum;
  record TaxMatrixVc TMr;

  res = true;
  if (rownr>=0) then begin
    GetWindowRecord(wn,POr);
    rwcnt = MatRowCnt(POr);  
    if (rownr<rwcnt) then begin
      MatRowGet(POr,rownr,POrw);
      if (POrw.stp==1) then begin
        s = MulRateToBase1(POr.CurncyCode,POrw.Sum,POr.FrRate,POr.ToRateB1,POr.ToRateB2,POr.BaseRate1,POr.BaseRate2,DefaultCurRoundOff);
        //UnpackRowFieldMatrix(POrw,"TaxMatrix",TMr);// Edit ************************** Saturday, 19 August 2017 11:17:40
        FindSalesExVat(TMr,POrw.VATCode,s,POr.InclVAT,0,rowsum);
        CalcProc(rowsum,t,tproc);
        unitprdisc = POrw.Sum/POrw.Quant;
        unitprdisc = Round(unitprdisc,DefaultRoundMode);
      end;
      SendArtStat(POrw.ArtCode,POr.Location,"",0,tproc,unitprdisc,POr.TransDate,1);
    end;
  end;
  SetWindowNameArg(wn,POrw.ArtCode & ":" & POr.Location);
  RETURN;
END;

global
function Boolean PODClassSwitchRow(Integer wn,Integer rownr)
begin        
  PODSwitchRow(wn,rownr);
  PODClassSwitchRow = true;  
  return;
end;

global
procedure ItemStatusPODsm()
BEGIN
  Integer wn,nwn;
  record RcVc RepSpec;
  
  wn = CurWindow;
  nwn = OpenArtStat(wn,RepSpec,true);
  PODSwitchRow(wn,WindowActiveRow(wn));
  RETURN;
END;

global 
updating procedure CreateMailFromPODsm()
BEGIN
  Integer wn,nwn;
  record MailVc Mailr;
  record POVc POr;
  Integer err;
  string 255 tstr;
  Boolean testf;
  string 255 docname;

  wn = CurWindow;
  if (WindowState(wn)==0) then begin//Rs_normal
    GetWindowRecord(wn,POr);  
    testf = true;
    if (POr.OKFlag==0) then begin
    end else begin
      if (UserCanAction("EMailFromOKPO",false)==false) then begin 
        testf = false; 
        MessageBox(1274,StringFromStringSet(3,"EMailFromOKPO"));
      end;
    end;
    err = POTestApprovalStatus(POr);
    if (err!=0) then begin
      MessageBox(err,"");
      testf = false;
    end;
    if (testf) then begin
      err = CreateMailFromPOD(POr,Mailr,tstr,WindowFormName(wn));
      if (err!=0) then begin
        MessageBox(err,": " & tstr);
      end else begin
        nwn = OpenWindow("MailDClass",1,0,"","",Mailr);
      end;
    end;
  end;
  RETURN;
END;

global
procedure SubtotalPODsm()
BEGIN
  record POVc POr;
  row POVc POrw;
  Integer wn,i,rwcnt,rownr;
  val pt;

  wn = CurWindow;
  if (WindowState(wn)==Rs_normal) then begin
    DoUpdate(wn);
  end;
  if (WindowState(wn)!=Rs_update and WindowState(wn)!=Rs_insert) then begin
    goto LSubtotalPODsm;
  end;
  GetWindowRecord(wn,POr);
  rownr = WindowActiveRow(wn);
  DeselectWindow(wn,false);
  if (rownr==-1) then begin
    rwcnt = MatRowCnt(POr);
  end else begin
    rwcnt = rownr + 1;
  end;
  for (i=rwcnt-1;i>=0;i=i-1) begin
    MatRowGet(POr,i,POrw);
    if (POrw.stp!=9) then begin
      pt = pt + POrw.Sum;
    end else begin
      if (POrw.Sum!=0) then begin goto LBREAK; end;
    end;
  end;
LBREAK:;  
  ClearRow(POr,POrw,9);
  POrw.Sum = pt;
  MatRowInsert(POr,rwcnt,POrw);
  PutWindowRecord(wn,POr);
LSubtotalPODsm:;  
  RETURN;
END;

global
procedure POStatRnPODsm()
BEGIN
  record RcVc RepSpec;
  record POVc POr;

  GetWindowRecord(CurWindow,POr);
  RepSpec.f1 = POr.SerNr;
  RepSpec.sStartDate = POr.TransDate;
  RepSpec.sEndDate = POr.TransDate;
  RepSpec.ArtMode = 1;   //Detailed
  RepSpec.flags[4] = 1;  //Indicates that report was run from Special Menu opf PODClass
  RepSpec.flags[3] = 1;  //include Not Oked
  RepSpec.flags[1] = 1;  //Include Closed
  RepSpec.Media = mtScreen;
  RepSpec.repname = "POStatRn";
  RunReport(RepSpec,0);
  RETURN;
END;

global
procedure POStatusORLsm()
BEGIN
  record RcVc RepSpec;
  record POVc POr;
  
  if (ReadMarkedRecord(CurWindow,POr)) then begin
    RepSpec.f1 = POr.SerNr;
    RepSpec.sStartDate=POr.TransDate;
    RepSpec.sEndDate=POr.TransDate;
    RepSpec.ArtMode=1;   //Detailed
    RepSpec.flags[4]=1;  //Indicates that report was run from Special Menu opf PODClass
    RepSpec.flags[3]=1;  //include Not Oked
    RepSpec.flags[1]=1;  //Include Closed
    RepSpec.Media = mtScreen;
    RepSpec.repname = "POStatRn";
    RunReport(RepSpec,0);
  end;
  RETURN;
END;

global
function Boolean PODClassInclVATButtonAction(Integer wn,Integer value)
BEGIN
  Boolean res;
  record POVc POr;
 
  res = true;
  if (WindowState(wn)==Rs_normal) then begin
    GetWindowRecord(wn,POr);
    if (POr.Closed!=0) then begin
      res = false;
    end;
  end;  
  if (WindowState(wn)==Rs_update) then begin
    GetPrevWindowRecord(wn,POr);
    if (POr.Closed!=0) then begin
      res = false;
    end;
  end;  
  PODClassInclVATButtonAction = res;
  RETURN;
END;

global
function Boolean PODClassClosedButtonAction(Integer wn,Integer value)
BEGIN
  Boolean res;
  record POVc POr;
 
  res = true;
  if (WindowState(wn)==Rs_normal) then begin
    GetWindowRecord(wn,POr);
    if (POr.Closed!=0) then begin
      res = false;
    end;
  end;  
  if (WindowState(wn)==Rs_update) then begin
    GetPrevWindowRecord(wn,POr);
    if (POr.Closed!=0) then begin
      res = false;
    end;
  end;  
  
  if(currentuser=="IRKAKH")then begin
  	res = true;
  end;
  
  PODClassClosedButtonAction = res;
  RETURN;
END;

function Boolean POApprovalStarted(record POVc POr)
begin
  Boolean res;
  record AcceptanceRulesVc Acptr;

  res = false;
  if (POApprovalStatus(POr,Acptr)>=kAcceptanceStatePending) then begin
    res = true;
  end;
  POApprovalStarted = res;
  return;
end;

global
function Boolean PODClassOKFlagButtonAction(Integer wn,Integer value)
BEGIN
  Boolean res;
  record POVc POr;
  record POSettingBlock POSb;
  Integer err;
 
  BlockLoad(POSb);
  res = true;
  if (WindowState(wn)==Rs_insert) then begin
    GetWindowRecord(wn,POr);
    err = POTestApprovalStatus(POr);
    if (err!=0) then begin
      MessageBox(err,"");
      res = false;
      goto LPODClassOKFlagButtonAction;
    end;
  end;
  if (WindowState(wn)==Rs_normal) then begin
    GetWindowRecord(wn,POr);
    if (POr.Closed!=0) then begin
      res = false;
    end;
    if (res) then begin
      err = POTestApprovalStatus(POr);
      if (err!=0) then begin
        MessageBox(err,"");
        res = false;
        goto LPODClassOKFlagButtonAction;
      end;
      if (POr.OKFlag!=0) then begin
        res = false;
        if (UserCanAction("UnOKPO",false)) or (UserCanAction("UnOKAll",false)) then begin
          res = true;
        end;
      end;
    end;
  end;  
  if (WindowState(wn)==Rs_update) then begin
    GetPrevWindowRecord(wn,POr);
    if (POr.Closed!=0) then begin
      res = false;
    end;
    if (res) then begin
      err = POTestApprovalStatus(POr);
      if (err!=0) then begin
        MessageBox(err,"");
        res = false;
        goto LPODClassOKFlagButtonAction;
      end;
      if (POr.OKFlag!=0) then begin
        res = false;
        if (UserCanAction("UnOKPO",false)) or (UserCanAction("UnOKAll",false)) then begin
          res = true;
        end;
      end;
    end;
  end; 
LPODClassOKFlagButtonAction:;   
  PODClassOKFlagButtonAction = res;
  RETURN;
END;


global
function Boolean PODClassConsManualCostButtonAction(Integer wn,Integer value)
BEGIN
  Boolean res;
  record POVc POr;
  row POVc POrw;
  record POSettingBlock POSb;
  Integer err,i,mtrw;
  
  res = true;
 	
 	getwindowrecord(wn,POr);
 	mtrw = matrowcnt(POr);
 	for(i=0;i<mtrw;i=i+1)begin
 		matrowget(POr,i,POrw);
 		if(POrw.Shipd1>0)then begin
 			res = false;
 		end;
 	end;
  
LPODClassOKFlagButtonAction:;   
  PODClassConsManualCostButtonAction = res;
  RETURN;
END;

global
function Boolean PODClassExtraCostsCalculationButtonAction(Integer wn,Integer value)
begin
  Boolean res;
  record POVc POr;
  Integer err;
  record PUVc PUr;

  res = true;  
  switch (WindowState(wn)) begin
    case Rs_normal:
      GetWindowRecord(wn,POr);
      if (POr.OKFlag!=0) then begin res = false; end;
      if (res) then begin
        PUr.PONr = POr.SerNr;
        res = !ReadFirstKey("PONr",PUr,1,true);
      end;
      if (res) then begin
        err = POTestApprovalStatus(POr);
        if (err!=0) then begin
          MessageBox(err,"");
          res = false;
          goto LPODClassExtraCostsCalculationButtonAction;
        end;
      end;
      if (UserCanAction("UnOKAll",false)) then begin
        res = true;
      end;
    case Rs_update:
      GetPrevWindowRecord(wn,POr);
      if (POr.OKFlag!=0) then begin res = false; end;    
      if (res) then begin
        PUr.PONr = POr.SerNr;
        res = !ReadFirstKey("PONr",PUr,1,true);
      end;
      if (res) then begin
        err = POTestApprovalStatus(POr);
        if (err!=0) then begin
          MessageBox(err,"");
          res = false;
          goto LPODClassExtraCostsCalculationButtonAction;
        end;
      end;
  end;  
LPODClassExtraCostsCalculationButtonAction:;  
  PODClassExtraCostsCalculationButtonAction = res;
  return;
end;

global
function Boolean PODClassExtraCostsCalculationButtonAfter(Integer wn,Boolean changedf)
begin        
  record POVc POr;  
  Boolean res;

  GetWindowRecord(wn,POr);
  POSetShipCost(POr,1);
  POSetShipCost(POr,2);
  POSetShipCost(POr,3);
  POSetShipCost(POr,4);
  POSetShipCost(POr,5);
  POSetShipCost(POr,6);
  POSetShipCost(POr,7);
  POSumup(POr);
  PutWindowRecord(wn,POr);
  PODClassExtraCostsCalculationButtonAfter = res;  
  return;
end;

global
function Boolean PODClassExportFlagButtonAfter(Integer wn,Boolean changedf)
begin        
  record POVc POr;  
  Boolean res;

  GetWindowRecord(wn,POr);
  POSumup(POr);
  PutWindowRecord(wn,POr);
  PODClassExportFlagButtonAfter = res;  
  return;
end;

function Boolean POShipdFromRowTest(record POVc POp,Integer rownr)
begin
  Boolean res;
  Integer i,rwcnt;
  row POVc POrw;
  
  rwcnt = MatRowCnt(POp);
  for (i=rownr;i<rwcnt;i=i+1) begin
    MatRowGet(POp,i,POrw);
    if (POrw.Shipd1>0) or (POrw.Invd>0) then begin
      res = true;
      goto LPOShipdFromRowTest;
    end;
  end;
LPOShipdFromRowTest:;
  POShipdFromRowTest = res;
  return;
end;

global 
function Boolean PODClassDeleteRowTest(Integer wn,Integer rownr)
begin
  record POVc POr;
  record POVc PO2r;
  Boolean res;

  res = true;
  GetWindowRecord(wn,POr);
  if (POr.OrderType==kOrderTypeDropShip) then begin 
    res = false;
    goto LPODClassDeleteRowTest;
  end;
  if (WindowState(wn)==Rs_update) then begin
    GetPrevWindowRecord(wn,PO2r);
    if (POApprovalStarted(POr) and UserCanAction("ChangeRecordMatrixWhenPending",false)==false) then begin
      res = false;
      goto LPODClassDeleteRowTest;
    end;
    
    if (POShipdFromRowTest(POr,rownr)) then begin
      res = false;
      MessageBox(1304,"");
    end;
    if (PO2r.OKFlag) then begin
      res = false;
      MessageBox(20589,"");
    end;
  end;
LPODClassDeleteRowTest:;  
  PODClassDeleteRowTest = res;
  return;
end;

global 
function Boolean PODClassInsertRowTest(Integer wn,Integer rownr)
begin
  record POVc POr;
  record POVc PO2r;
  Boolean res;

  res = false;  
  GetWindowRecord(wn,POr);
  if (POr.Closed==0) then begin
    res = true;  
    if (POApprovalStarted(POr) and UserCanAction("ChangeRecordMatrixWhenPending",false)==false) then begin
      res = false;
      goto LPODClassInsertRowTest;
    end;
    if (POr.OrderType==kOrderTypeDropShip) then begin 
      res = false;
      goto LPODClassInsertRowTest;
    end;
    switch (WindowState(wn)) begin
      case 0://Rs_normal
        if (POShipdTest(POr,true)) or (POr.OKFlag!=0) then begin res = false; end;
      case 1://Rs_insert
        res = true;
      case 2://Rs_update
        GetPrevWindowRecord(wn,PO2r);
        if (POShipdTest(PO2r,true)) or (POr.OKFlag!=0) then begin res = false; end;
      otherwise
        res = false;
    end;
  end;  
LPODClassInsertRowTest:;  
  PODClassInsertRowTest = res;
  return;
end;

global
function Boolean PODClassOnOverStrike(Integer wn,Integer rownr)
begin
  record POVc POr;

  if (rownr>=0) then begin
    GetWindowRecord(wn,POr);    
    POSumup(POr);
		remPODClassTax15PercentSumEFAfter(POr,wn); // Edit ****************** Ihor Trubachov 21*06*2021
    PutWindowRecord(wn,POr);    
  end;
  PODClassOnOverStrike = true;
  return;
end;

/*newapproval*/
global
function Boolean PODClassOnOpenWindow(Integer wn)
begin
  record POVc POr;
  Integer AcceptanceStatusFlag;
  record POShipmDataVc POSDr;
  integer nwn;
  
  GetWindowRecord(wn,POr);
  PODClassOnOpenWindowRemote(POr,AcceptanceStatusFlag);
  PutWindowString(wn,"AcceptanceStatusFlag",StringFromSet(443,AcceptanceStatusFlag));  
  if (currentcompany==28) then begin
  	if(POr.SerNr>-1)then begin
			POSDr.POSerNr = POr.SerNr;
			if(readfirstmain(POSDr,1,true))then begin
			end else begin
				RecordNew(POSDr);
				POSDr.POSerNr = POr.SerNr;
			end;
			nwn = FindWindow("POShipmDataDClass");
			if (nwn!=0) then begin
				DeselectWindow(nwn,false);
				PutWindowRecord(nwn,POSDr);
				SelectWindow(nwn);
			end else begin
				if(UserCanAction("OpenPOSHAfterPO",true))then begin nwn = OpenWindow("POShipmDataDClass",0,0,"","",POSDr); end;
			end;
    end;
  end;
  PODClassOnOpenWindow = false;
  return;
end;

global
procedure PODClassOnWindowRecordChange(Integer wn)
begin
  record POVc POr;
  Integer AcceptanceStatusFlag;
  record POShipmDataVc POSDr;
  integer nwn;

  GetWindowRecord(wn,POr);
  PODClassOnOpenWindowRemote(POr,AcceptanceStatusFlag);
  PutWindowString(wn,"AcceptanceStatusFlag",StringFromSet(443,AcceptanceStatusFlag));  
  if (currentcompany==28) then begin
  	if(POr.SerNr>-1)then begin
			POSDr.POSerNr = POr.SerNr;
			if readfirstmain(POSDr,1,true) then begin
			end else begin
				RecordNew(POSDr);
				POSDr.POSerNr = POr.SerNr;
			end;
			nwn = FindWindow("POShipmDataDClass");
			if (nwn!=0) then begin
				DeselectWindow(nwn,false);
				PutWindowRecord(nwn,POSDr);
				SelectWindow(nwn);
			//end else begin
			//  nwn = OpenWindow("POShipmDataDClass",0,0,"","",POSDr);;
			end;
    end;
  end;
  return;
end;

global
updating function boolean PODClassOnOKWindow(integer wn)
begin
  integer nwn;
  record POVc POr;
  record POShipmDataVc POSDr;
  
  if (currentcompany==28) then begin
    nwn = FindWindow("POShipmDataDClass");
    if (nwn!=0) then begin
      DeselectWindow(nwn,false);
      GetWindowRecord(wn,POr);
      GetWindowRecord(nwn,POSDr);
      if(POr.SerNr>-1)then begin
				if (POSDr.POSerNr<0) then begin
					POSDr.POSerNr = POr.SerNr;
				end;
				//RecordStore(POSDr,true);
				PutWindowRecord(nwn,POSDr);
				DeselectWindow(nwn,false);
				//SetWindowState(nwn,Rs_normal);
				WindowDoOK(nwn,0);
      end;
    end;
  end;
  PODClassOnOKWindow = true;

  return;
end;

global
function Boolean PODClassActiveEditField(Integer wn,string fieldname,Integer fn,Integer wnst,Integer rownr,Integer changed)
begin
  Boolean res;
  record POVc POr;
  record POVc PO2r;
  record MainStockBlock MSb;
  record INVc INr;
  row POVc POrw;
  record POShipmDataVc POSDr;
  Integer nwn;
	record PUVc PUr;
	record ConsCompBlock CCB;
	record CUVc CUr;
  
  res = true;
  nwn = FindWindow("SelectApproverWClass");
  if (nwn>0) then begin
    if (MotherWindow(nwn)==wn) then begin
      res = false;
      goto LPODClassActiveEditField;
    end;
  end;
  GetWindowRecord(wn,POr); 
  switch (fieldname) begin
    case "SerNr":
      switch (wnst) begin
        case Rs_insert:
          if (UserCanAction("AllowPOSerNrChange",true)==false) then begin res = false; end;
        otherwise
           res = false;
           goto LPODClassActiveEditField;
      end;
    case "FrRate": 
      if (AllowCurChange(POr.CurncyCode,false)==false) then begin res = false; end;
    case "ToRateB1": 
      if (AllowCurChange(POr.CurncyCode,false)==false) then begin res = false; end;
    case "ToRateB2": 
      if (AllowCurChange(POr.CurncyCode,false)==false) then begin res = false; end;
    case "BaseRate1": 
      if (AllowCurChange(POr.CurncyCode,true)==false) then begin res = false; end;
    case "BaseRate2": 
      if (AllowCurChange(POr.CurncyCode,true)==false) then begin res = false; end;  
    case "Shipd1": 
       res = false;
		case "Tax15Percent": // Edit ****************** Ihor Trubachov 17*06*2021
       res = false;
    case "Shipd2": 
       MatRowGet(POr,rownr,POrw);
       if (POrw.Shipd2<=POrw.Quant) then begin
         BlockLoad(MSb);
         switch (MSb.RecevPlainItems) begin
           case 2:
             res = false;
             INr.Code = POrw.ArtCode;
             if (ReadFIrstMain(INr,1,true)) then begin
               if (INr.ItemType==0) or (INr.ItemType==3) then begin
                 res = true;
               end;
             end;
           otherwise
             res = false;
         end;
       end;
    case "Invd": 
       res = false;
    case "Spec":
      if (HasLocalization("PRT")) then begin
        MatRowGet(POr,rownr,POrw);
        if (nonblank(POrw.ArtCode)) then begin
          res = false;
        end;
      end;
    case "IDPrmsdDt":
      if (rownr>-1) then begin
        res = false;
      end;	
		case "ArtCode":
			if (rownr>-1) then begin
				if(currentCompany==18 and !nonblank(POr.VECode)) then begin
					res = false; 
					messagebox(0,"Введите код поставщика!");
				end;
			end;
  end;
  if (res==false) then begin
    goto LPODClassActiveEditField;
  end;
  if (wnst==2) then begin//Rs_update
    GetPrevWindowRecord(wn,PO2r);
    /*if (POApprovalStarted(POr) and UserCanChangePendingRecord(rownr)==false) then begin//Commented// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 29 10 2019 y. at 11:49:31 AM
      res = false;
      goto LPODClassActiveEditField;
    end;*/
    if (PO2r.OKFlag!=0) then begin
      switch (fieldname) begin
        case "PlanShip": res = true;
        case "LangCode": res = true;
        otherwise res = false;
      end;
      if (rownr>=0) then begin
        res = true;
        switch (fieldname) begin
          case "PlanShipRow":
            res = true;
          otherwise
            res = false;
            goto LPODClassActiveEditField;
        end;
      end else begin
        if (res==false) then begin goto LPODClassActiveEditField; end;
      end;      
    end else begin
      if (POr.OrderType==kOrderTypeDropShip) then begin 
        switch (fieldname) begin
          case "ArtCode": 	
						MatRowGet(POr,rownr,POrw);
						if(POrw.Shipd1==0 or POrw.Shipd1==blankval) then begin
							res = true;
						end else begin res = false; end;	
          case "Quant": res = false;
        end;
        if (res==false) then begin goto LPODClassActiveEditField; end;
      end;
      if (POShipdTest(POr,true)==false) then begin goto LPODClassActiveEditField; end;
      if (rownr<WindowOldRowcnt(wn)) then begin
        switch (fieldname) begin
          case "ArtCode": 	
						MatRowGet(POr,rownr,POrw);
						if(POrw.Shipd1==0 or POrw.Shipd1==blankval) then begin
							res = true;
						end else begin res = false; end;
            if(currentuser=="SA")then begin// Edit ************************** Monday, 18 May 2015 13:29:20
            	res = true;
            end;// Edit ************************** Monday, 18 May 2015 13:29:18
            if (changed!=0) then begin MessageBox(1304,""); end;
            goto LPODClassActiveEditField;          
          case "StockType":
            res = false;
            goto LPODClassActiveEditField;          
        end;
      end;
    end;
  end;
  
  switch (fieldname) begin
		case "OrderDoneDate": if(POr.OrderDoneFlag==1)then begin res = false; end;// Edit ************************** Wednesday, 13 November 2013 17:30:30
  end;
	
	
	
  if (wnst==2) then begin//Rs_update
    GetPrevWindowRecord(wn,PO2r);
		if (PO2r.OKFlag!=0) then begin
			switch (fieldname) begin
				case "OrderDoneDate": if(POr.OrderDoneFlag==0)then begin res = true; end;// Edit ************************** Wednesday, 13 November 2013 17:30:30
				case "OrderDoneFlag": if(POr.OrderDoneFlag==0)then begin res = true; end;// Edit ************************** Wednesday, 13 November 2013 17:30:30
				case "OfficialSerNr": res = true;														//Edit----------------------Dima  01.04.2015
				otherwise res = false;
			end;
		end;
	end;

	
  
LPODClassActiveEditField:;  

	if(usercanaction("AllowChangePOPayments",false)==false)then begin
		switch (fieldname) begin
			case "IDPrepayProc": if(POr.IDPrepayPaid==1)then begin res = false; end;
			case "IDPrepay": if(POr.IDPrepayPaid==1)then begin res = false; end;
			case "IDBalPay": if(POr.IDPrepayPaid==1)then begin res = false; end;
			case "IDBalPayProc": if(POr.IDPrepayPaid==1)then begin res = false; end;
			case "Sum4": if(POr.IDPrepayPaid==1)then begin res = false; end;
			case "Tax15Percent":  res = false; // Edit ****************** Ihor Trubachov 17*06*2021
		end;
	end;

  if (currentcompany==28) then begin
    switch (fieldname) begin
      case "PayDeal": if (POr.IDPrepayPaid==1) then begin MessageBox(35151,""); res = false; end;
			case "IDStatus": res = true;
			case "Tax15Percent":  res = false; // Edit ****************** Ihor Trubachov 17*06*2021
    end;
    nwn = FindWindow("POShipmDataDClass");
    if (nwn!=0) then begin
      DeselectWindow(nwn,false);
      getwindowrecord(nwn,POSDr);
      if (POSDr.POSerNr!=POr.SerNr and POr.SerNr>-1) then begin
        POSDr.POSerNr = POr.SerNr;
        if readfirstmain(POSDr,1,true) then begin
        end else begin
          RecordNew(POSDr);
          POSDr.POSerNr = POr.SerNr;
        end;
        PutWindowRecord(nwn,POSDr);
      end;
    //end else begin
    //  nwn = OpenWindow("POShipmDataDClass",0,0,"","",POSDr);;
    end;
  end;
	if(res)then begin
	//if(CCb.OKFlagPOr!=0)	then begin
		switch (fieldname) begin  //Edit_____________________________________ABR 16.05.19
			case "ShipCost":blockload(CCb);
			case "CustomsCost":	blockload(CCb);
			case "Cost1":	blockload(CCb);
			case "Cost2":	blockload(CCb);
			case "Cost3":	blockload(CCb);
			case "Cost4":	blockload(CCb);
			case "Cost5":	blockload(CCb);
		end;
		
		if(CCb.OKFlagPOr!=0)	then begin
			switch (fieldname) begin  //Edit_____________________________________ABR 16.05.19
				case "ShipCost":
					PUr.PONr = POr.SerNr;
					if(ReadFirstKey("PONr",PUr,1,true)) then begin
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							res = false;
						end;		
					end;
				case "CustomsCost":	
					PUr.PONr = POr.SerNr;
					if(ReadFirstKey("PONr",PUr,1,true)) then begin
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							res = false;
						end;		
					end;
				case "Cost1":	
					PUr.PONr = POr.SerNr;
					if(ReadFirstKey("PONr",PUr,1,true)) then begin
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							res = false;
						end;	
					end;
				case "Cost2":	
					PUr.PONr = POr.SerNr;
					if(ReadFirstKey("PONr",PUr,1,true)) then begin
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							//res = false;
						end;		
					end;
				case "Cost3":	
					PUr.PONr = POr.SerNr;
					if(ReadFirstKey("PONr",PUr,1,true)) then begin
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							res = false;
						end;		
					end;
				case "Cost4":	
					PUr.PONr = POr.SerNr;
					if(ReadFirstKey("PONr",PUr,1,true)) then begin
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							res = false;// Edit ************************** BPI Ukraine - KramarAlexandr - 04, 27 05 2021 y. at 2:26:11 PM
						end;		
					end;
				case "Cost5":	
					PUr.PONr = POr.SerNr;
					if(ReadFirstKey("PONr",PUr,1,true)) then begin
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							res = false;
						end;	
					end;
				case "Tax15Percent":  res = false; // Edit ****************** Ihor Trubachov 17*06*2021
			end;
		end;
	end;	
	if(currentcompany==18) then begin
		switch (fieldname) begin  //Edit_____________________________________ABR 16.05.19
				case "VEArtCode":
						if(CurrentUser!="SA") then begin
							res = false;
						end;	
				// case "Cost1":	
						// res = false;
				case "Cost2":	
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							//res = false;
						end;		
				case "RowCost1":	
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							res = false;
						end;		
				case "RowCost2":	
						if(CurrentUser!="SA" and CurrentUser!="USER1") then begin
							res = false;
						end;		
				case "Tax15Percent":  res = false; // Edit ****************** Ihor Trubachov 17*06*2021
			end;
		
	end;
	  if (POr.OKFlag!=0) then begin
      if (rownr>=0) then begin
        res = false;
        switch (fieldname) begin
					case "ArtCode": 	
						MatRowGet(POr,rownr,POrw);
						if(POrw.Shipd1==0 or POrw.Shipd1==blankval) then begin
							res = true;
						end;	
          otherwise
            res = false;
        end;
      end;      
    end;
	if(currentuser=="SA3")then begin
  	res = true;
  end;
	switch (fieldname) begin
		case "PayDeal": if(!PTCCCodesCheck(POr.PayDeal) and currentcompany==18)then begin res = true; end;// Edit ************************** Wednesday, 13 November 2013 17:30:30
  end;
	
	if (CurrentCompany==18) then begin // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:24 29.09.2020
		switch (fieldname) begin
			case "CurncyCode": 
				CUr.Code = POr.VECode;
				if (ReadFIrstMain(CUr,1,true)) then begin
					if (nonblank(CUr.VECurncyCode)) then begin
						res = false;
					end;
				end;
		end;
	end; // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:24 29.09.2020
	
  PODClassActiveEditField = res;
  return;
end;

global
function Boolean PODClassIDPrepayPaidButtonAction(Integer wn,Integer value)
BEGIN
  Boolean res;
  record POVc POr;
  Integer err;
  
  res = true;  
  
  getwindowrecord(wn,POr);
  if(POr.IDPrepayPaid>0)then begin  
		if(usercanaction("AllowChangePOPayments",false)==false)then begin
			if(currentcompany!=28) then begin
				res = false;
			end;
		end;
  end;
  
  
LPODClassIDPrepayPaidButtonAction:;  
  PODClassIDPrepayPaidButtonAction = res;
  RETURN;
END;


function Boolean PODClassPlanShipEFAfter(Integer wn,Boolean changedf)
begin
  record POVc POr;
  record PlanDeliveryBlock PlanDelRec;
  LongInt week;
  date d;
  
  if (changedf) then begin
    BlockLoad(PlanDelRec);
    GetWindowRecord(wn,POr);
    switch (PlanDelRec.FieldType) begin
      case 1:  /* date */
        d = POr.PlanShip;
        POr.PlanShip = d;
        POr.PlanShipDate = StringToDate(POr.PlanShip);
      case 2:  /* week number (nn) */
        week = POr.PlanShip;
        POr.PlanShip = week;
      case 3:  /* week number (yynn */
        if (nonblank(POr.PlanShip)) then begin
          week = POr.PlanShip;
          POr.PlanShip = week;
          if (len(POr.PlanShip)<4) then begin
            POr.PlanShip = "0" & POr.PlanShip;
          end;
          if (len(POr.PlanShip)>4) then begin
            POr.PlanShip = Left(POr.PlanShip,4);
          end;
        end;
    end;
    PutWindowRecord(wn,POr);    
  end;
  PODClassPlanShipEFAfter = true;
  return;
end;

function Boolean PODClassSalesManEFAfter(Integer wn,Boolean changedf)
BEGIN
  record POVc POr;
  string 255 tstr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    GetSalesGroup(POr.SalesMan,tstr);
    POr.SalesGroup = tstr;
    PutWindowRecord(wn,POr);
  end;
  PODClassSalesManEFAfter = true;
  return;
end;

function Boolean PODClassCurncyCodeEFAfter(Integer wn,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PasteCurncyCode(POr,WindEFstr(wn),true);    
    PutWindowRecord(wn,POr);
		if (CurrentCompany==18) then begin 
			messagebox(0,USetStr(36379)); 
			logtext(0,USetStr(36379))
		end;
  end;
  PODClassCurncyCodeEFAfter = true;
  return;
end;

function Boolean PODClassTransDateEFAfter(Integer wn,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POGetRate(POr);
    PutWindowRecord(wn,POr);
  end;
  PODClassTransDateEFAfter = true;
  return;
end;

function Boolean PODClassLocationEFAfter(Integer wn,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    if (POVc_PasteLocation(POr)==false) then begin
      Beep;
    end;
    PutWindowRecord(wn,POr);
  end;
  PODClassLocationEFAfter = true;
  return;
end;

function Boolean PODClassVECodeEFAfter(Integer wn,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    if (POVc_PasteVECode(POr,true)) then begin
      PutWindowRecord(wn,POr);
    end else begin
      Beep;
    end;
  end;
  PODClassVECodeEFAfter = true;
  return;
end;

function Boolean PODClassPRCodeEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;
  row POVc POrw;
  record PRVc PRr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);   
    if (rownr<0) then begin
      if (nonblank(POr.PRCode)) then begin
        PRr.Code = POr.PRCode;
        if (ReadFirstMain(PRr,1,true)) then begin
          if (nonblank(POr.Objects)) then begin
            POr.Objects = POr.Objects & ",";
          end;
          POr.Objects = POr.Objects & PRr.Objects;
        end;
      end;
    end else begin
      MatRowGet(POr,rownr,POrw);
      if (nonblank(POrw.PRCode)) then begin
        PRr.Code = POrw.PRCode;
        if (ReadFirstMain(PRr,1,true)) then begin
          if (nonblank(POrw.Objects)) then begin
            POrw.Objects = POrw.Objects & ",";
          end;
          POrw.Objects = POrw.Objects & PRr.Objects;
        end;
      end;
      MatRowPut(POr,rownr,POrw);
    end; 
    PutWindowRecord(wn,POr);   
    AutomatedSalesOrderly("HasModTS+Edit_POVc");
  end;
  PODClassPRCodeEFAfter = true;
  return;
end;

function Boolean PODClassPlanShipRowEFAfter(Integer wn,Integer rownr,Boolean changedf)
begin
  record POVc POr;
  row POVc POrw;
  record PlanDeliveryBlock PlanDelRec;
  LongInt week;
  date d;
  
  if (changedf) then begin
    BlockLoad(PlanDelRec);
    GetWindowRecord(wn,POr);
    MatRowGet(POr,rownr,POrw);
    switch (PlanDelRec.FieldType) begin
      case 1:  /* date */
        d = POrw.PlanShipRow;
        POrw.PlanShipRow = d;
      case 2:  /* week number (nn) */
        week = POrw.PlanShipRow;
        POrw.PlanShipRow = week;
      case 3:  /* week number (yynn */
        week = POrw.PlanShipRow;
        POrw.PlanShipRow = week;
        if (len(POrw.PlanShipRow)<4) then begin
          POrw.PlanShipRow = "0" & POrw.PlanShipRow;
        end;
        if (len(POrw.PlanShipRow)>4) then begin
          POrw.PlanShipRow = Left(POrw.PlanShipRow,4);
        end;
    end;
    MatRowPut(POr,rownr,POrw);
    PutWindowRecord(wn,POr);    
  end;
  PODClassPlanShipRowEFAfter = true;
  return;
end;

function Boolean PODClassArtCodeEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;
  row POVc POrw;
  string 200 art;

  GetWindowRecord(wn,POr);    
  MatRowGet(POr,rownr,POrw);
  if ((changedf) or (blank(POrw.Spec) and nonblank(POrw.ArtCode))) then begin
    art = POrw.ArtCode;//Edit-------------------Vitalii 12:25 26.07.2018
    NormalizeArtCode(art);
    if(POrw.ArtCode!=art)then begin
      POrw.ArtCode = art;
      matrowput(POr,rownr,POrw);
    end;
		if(nonblank(POr.PlanShipDate))then begin
			POrw.IDPrmsdDt = POr.PlanShipDate;
			matrowput(POr,rownr,POrw);
		end;
    if (POVc_PasteArtCode(POr,rownr,false)) then begin
      PutWindowRecord(wn,POr);
      if (PODClassSwitchRow(wn,rownr)) then begin end;
    end else begin
      Beep;
    end;
  end;
  PODClassArtCodeEFAfter = true;
  return;
end;

function Boolean PODClassVEArtCodeEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    if (POVc_PasteVEArtCode(POr,rownr)) then begin
      PutWindowRecord(wn,POr);
    end else begin
      Beep;
    end;
  end;
  PODClassVEArtCodeEFAfter = true;
  return;
end;

function Boolean PODClassQuantEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PasteQuant(POr,rownr);
		remPODClassTax15PercentSumEFAfter(POr,wn); // Edit ****************** Ihor Trubachov 18*06*2021
    PutWindowRecord(wn,POr);
  end;
  PODClassQuantEFAfter = true;
  return;
end;

function Boolean PODClassVEQuantEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PasteVEQuant(POr,rownr);
    PutWindowRecord(wn,POr);
  end;
  PODClassVEQuantEFAfter = true;
  return;
end;

function Boolean PODClassPriceEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);  
		POVc_PastePrice(POr,rownr);
		remPODClassTax15PercentSumEFAfter(POr,wn);
    PutWindowRecord(wn,POr);
  end;
  PODClassPriceEFAfter = true;
  return;
end;

function Boolean PODClassvRebateEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PastevRebate(POr,rownr);
		remPODClassTax15PercentSumEFAfter(POr,wn);
    PutWindowRecord(wn,POr);
  end;
  PODClassvRebateEFAfter = true;
  return;
end;

function Boolean PODClassSumEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PasteSum(POr,rownr);
    PutWindowRecord(wn,POr);
  end;
  PODClassSumEFAfter = true;
  return;
end;

function Boolean PODClassVATCodeEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PasteVATCode(POr,rownr);
    PutWindowRecord(wn,POr);
  end;
  PODClassVATCodeEFAfter = true;
  return;
end;

function Boolean PODClassTaxTemplateCodeEFAfter(Integer wn,Integer rownr,Boolean changedf)
BEGIN
  record POVc POr;
  Boolean chsum;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PasteTaxTemplateCode(POr,rownr,chsum);
    if (chsum) then begin
      PODchrsum(POr,rownr);
    end;
    POSumup(POr);
    PutWindowRecord(wn,POr);
  end;
  PODClassTaxTemplateCodeEFAfter = true;
  return;
end;

function Boolean PODClassStockTypeEFAfter(Integer wn,Integer rownr,Boolean changedf)
begin
  record POVc POr;

  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PasteStockType(POr,rownr);
    PutWindowRecord(wn,POr);
  end;
  PODClassStockTypeEFAfter = true;
  return;
end;

function Boolean PODClassTREOEFAfter(Integer wn,Integer rownr,Boolean changedf)
begin
  record POVc POr;


  if (changedf) then begin
    GetWindowRecord(wn,POr);    
    POVc_PasteTREO(POr,rownr);
    POVc_PasteVATCode(POr,rownr);
    PutWindowRecord(wn,POr);
  end;
  PODClassTREOEFAfter = true;
  return;
end;

function boolean PasteClassification(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 classification;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    classification = POrw.xClassification;
    if(nonblank(classification))then begin
      NormalizeClassName(classification);
      if(POrw.xClassification!=classification)then begin
        POrw.xClassification = classification;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteClassification = true;
return;
end;

function boolean PasteSpec(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 spec;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.Spec;
    if(nonblank(spec))then begin
      NormalizeName(spec);
      if(POrw.Spec!=spec)then begin
        POrw.Spec = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteSpec = true;
return;
end;

function boolean PasteEAN13Code(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 spec;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.EAN13Code;
    if(nonblank(spec))then begin
      NormalizeName(spec);
      if(POrw.EAN13Code!=spec)then begin
        POrw.EAN13Code = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteEAN13Code = true;
return;
end;

function boolean PasteComment(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 spec;
  
  
  if(changed==1) and (rownr>-1) then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.Comment;
    if(nonblank(spec))then begin
      NormalizeName(spec);
      if(POrw.Comment!=spec)then begin
        POrw.Comment = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteComment = true;
return;
end;

function boolean PasteRowWeight(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 spec;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.RowWeight;
    if(nonblank(spec))then begin
      NormalizeName(spec);
      if(POrw.RowWeight!=spec)then begin
        POrw.RowWeight = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteRowWeight = true;
return;
end;

function boolean PasteMetal(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 spec;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.Metal;
    if(nonblank(spec))then begin
      NormalizeName(spec);
      if(POrw.Metal!=spec)then begin
        POrw.Metal = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteMetal = true;
return;
end;

function boolean PasteMajStoneDet(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 spec;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.MajStoneDet;
    if(nonblank(spec))then begin
      NormalizeName(spec);
      if(POrw.MajStoneDet!=spec)then begin
        POrw.MajStoneDet = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteMajStoneDet = true;
return;
end;

function boolean PasteSize(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 spec;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.Size;
    if(nonblank(spec))then begin
      NormalizeName(spec);
      if(POrw.Size!=spec)then begin
        POrw.Size = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteSize = true;
return;
end;

function boolean PasteColour(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
record POVc POr;
row POVc POrw;
string 200 spec;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.Colour;
    if(nonblank(spec))then begin
      NormalizeName(spec);
      if(POrw.Colour!=spec)then begin
        POrw.Colour = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteColour = true;
return;
end;

function Boolean PODClassIDPrepayEFAfter(Integer wn,Integer changed)
begin
  record POVc POr;
  
  if (changed!=0) then begin
    GetWindowRecord(wn,POr);
    
    POr.IDPrepayProc = 100*POr.IDPrepay/POr.Sum4;
    POr.IDBalPay = POr.Sum4 - POr.IDPrepay;
    POr.IDBalPayProc = 100 - POr.IDPrepayProc;
    
    PutWindowRecord(wn,POr);
  end;
  PODClassIDPrepayEFAfter = true;
end;

function Boolean PODClassIDPrepayProcEFAfter(Integer wn,Integer changed)
begin
  record POVc POr;
  
  if (changed!=0) then begin
    GetWindowRecord(wn,POr);
    
    POr.IDPrepay = POr.Sum4/100*POr.IDPrepayProc;
    POr.IDBalPay = POr.Sum4 - POr.IDPrepay;
    POr.IDBalPayProc = 100 - POr.IDPrepayProc;
    
    PutWindowRecord(wn,POr);
  end;
  PODClassIDPrepayProcEFAfter = true;
end;

function Boolean PODClassIDBalPayEFAfter(Integer wn,Integer changed)
begin
  record POVc POr;
  
  if (changed!=0) then begin
    GetWindowRecord(wn,POr);
    
    POr.IDBalPayProc = 100*POr.IDBalPay/POr.Sum4;
    POr.IDPrepayProc = 100 - POr.IDBalPayProc;
    POr.IDPrepay = POr.Sum4 - POr.IDBalPay;
    
    PutWindowRecord(wn,POr);    
  end;
  PODClassIDBalPayEFAfter = true;
end;

function Boolean PODClassIDBalPayProcEFAfter(Integer wn,Integer changed)
begin
  record POVc POr;
  
  if (changed!=0) then begin
    GetWindowRecord(wn,POr);
    
    POr.IDBalPay = POr.Sum4/100*POr.IDBalPayProc;
    POr.IDPrepay = POr.Sum4 - POr.IDBalPay;
    POr.IDPrepayProc = 100 - POr.IDBalPayProc;
    
    PutWindowRecord(wn,POr);    
  end;
  PODClassIDBalPayProcEFAfter = true;
end;

function Boolean PODClassSum4EFAfter(Integer wn,Integer changed)
begin
  record POVc POr;
  
  if (changed!=0) then begin
    if (currentcompany==28) then begin
      GetWindowRecord(wn,POr);
      
      if (POr.IDPrepayPaid==1) then begin
        POr.IDPrepayProc = 100*POr.IDPrepay/POr.Sum4;
      end else begin
        POr.IDPrepay = POr.Sum4/100*POr.IDPrepayProc;
      end;
      POr.IDBalPay = POr.Sum4 - POr.IDPrepay;
      POr.IDBalPayProc = 100 - POr.IDPrepayProc;
      
      PutWindowRecord(wn,POr);
    end;
  end;
  PODClassSum4EFAfter = true;
end;




global procedure PayDealEFAfter(var record POVc POr)
begin
	record PDVc PDr;
  row PDVc PDrw;
  boolean res;
  integer i,mtrw;
  
	if (currentcompany==28) then begin
		if (POr.IDPrepayPaid!=1) then begin
			PDr.Code = POr.PayDeal;
			if(ReadFirstMain(PDr,1,true))then begin
				POr.IDPayDealText = PDr.pdComment;
				mtrw = matrowcnt(PDr);
				for (i=0;i<mtrw;i=i+1) begin
					matrowget(PDr,i,PDrw);
					if (UpperCase(left(PDrw.LangCode,4))=="KOEF") then begin
						i = mtrw;
						POr.IDPrepayProc = 100*StringToVal(PDrw.Text,M4Val);
						POr.IDPrepay = POr.Sum4/100*POr.IDPrepayProc;
						POr.IDBalPay = POr.Sum4 - POr.IDPrepay;
						POr.IDBalPayProc = 100 - POr.IDPrepayProc;
					end;
				end;
			end;
		end;
	end;
	if(CurrentCompany==18)then begin
		PDr.Code = POr.PayDeal;
		switch (POr.PayDeal) begin
				case "PC": POr.DaysForBallancePayment = 120;
				case "PD": POr.DaysForBallancePayment = 30;
				case "PE": POr.DaysForBallancePayment = 60;
				case "PF": POr.DaysForBallancePayment = 90;
				case "PJ": POr.DaysForBallancePayment = 45;
				case "PL": POr.DaysForBallancePayment = 30;
				case "PM": POr.DaysForBallancePayment = 120;
				case "PN": POr.DaysForBallancePayment = 30;
				case "PR": POr.DaysForBallancePayment = 60;
				otherwise
					POr.DaysForBallancePayment = 0;
		end;
		if(ReadFirstMain(PDr,1,true))then begin
			POr.IDPayDealText = PDr.pdComment;
		end;
  end;
end;




function Boolean PODClassPayDealEFAfter(Integer wn,Integer changed)
begin
  record POVc POr;
	record PDVc PDr;
  row PDVc PDrw;
  boolean res;
  integer i,mtrw;
  
	GetWindowRecord(wn,POr);
  res = true;
  if (changed!=0) then begin
    PayDealEFAfter(POr);
		Putwindowrecord(wn,POr);
  end;
  PODClassPayDealEFAfter = res;
end;





function boolean PasteArtCode(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
  record POVc POr;
  row POVc POrw;
  string 200 spec;
  
  
  if(changed==1)then begin
    getwindowrecord(wn,POr);
    matrowget(POr,rownr,POrw);
    spec = POrw.ArtCode;
    if(nonblank(spec))then begin
      NormalizeArtCode(spec);
      if(POrw.ArtCode!=spec)then begin
        POrw.ArtCode = spec;
        matrowput(POr,rownr,POrw);
        Putwindowrecord(wn,POr);
      end;
    end;
  end;
  
PasteArtCode = true;
return;
end;


function Boolean PODClassPlanShipDateEFAfter(Integer wn,Integer changed)
begin
  record POVc POr;
	row POVc POrw;
  boolean res;
  integer i,mtrw;
  
  res = true;
  if (changed!=0) then begin
    if (currentcompany==28) then begin
      GetWindowRecord(wn,POr);
      mtrw = matrowcnt(POr);
      if (mtrw>0) then begin
        for (i=0;i<mtrw;i=i+1) begin
          matrowget(POr,i,POrw);
          if (POrw.stp==kInvoiceRowTypeNormal) then begin
            POrw.IDPrmsdDt = POr.PlanShipDate;
            matrowput(POr,i,POrw);
          end;
        end;
      end;
      PutWindowRecord(wn,POr);
    end;
  end;
  PODClassPlanShipDateEFAfter = res;
end;


function Boolean PODClassIDMfrFinConfirmEFAfter(Integer wn,Integer changed)
begin
  record POVc POr, oldPOr;
	row POVc POrw;
  boolean res;
  integer i,mtrw;
  
  res = true;
  if (changed!=0) then begin
    if (currentcompany==28 or currentcompany==18) then begin
      GetWindowRecord(wn,POr);
			oldPOr.SerNr = POr.SerNr;
			if(ReadFIrstMain(oldPOr,1,true))then begin
				if(nonblank(oldPOr.IDMfrFinConfirmDate) and oldPOr.IDMfrFinConfirmDate != POr.IDMfrFinConfirmDate)then begin
					POr.IDOldMfrFinConfirmDate = oldPOr.IDMfrFinConfirmDate;
				end;
			end;
      PutWindowRecord(wn,POr);
    end;
  end;
  PODClassIDMfrFinConfirmEFAfter = res;
end;



function Boolean PODClassPOClassEFAfter(Integer wn,Integer changed)
begin
  record POVc POr, oldPOr;
	row POVc POrw;
  boolean res;
  integer i,mtrw, oscnt, k;
	array string 255 asubdi, aacc;
  
  res = true;
  if (changed!=0) then begin
		GetWindowRecord(wn,POr);
    if (currentcompany==18 and POr.POClass=="S_IDE") then begin
			POr.Location = "CWH_I";
		if (!SetInSet("CC",POr.Objects)) then begin
			if (nonblank(POr.Objects)) then begin POr.Objects = POr.Objects & ","; end;
			POr.Objects = POr.Objects & "CC";
		end;
		if (!SetInSet("IDE",POr.Objects)) then begin
			ExtractObjectsByType(POr.Objects,"SUBDI",asubdi,oscnt);
			for(k=0;k<asubdi.length;k=k+1)begin
				if(nonblank(asubdi[k]))then begin
					POr.Objects = RemoveObjectFromObjectList(POr.Objects,asubdi[k]);
				end;
			end;
			if (nonblank(POr.Objects)) then begin POr.Objects = POr.Objects & ","; end;
			POr.Objects = POr.Objects & "IDE";
		end;
		if (!SetInSet("SNT",POr.Objects)) then begin
			cleararray(aacc);
			ExtractObjectsByType(POr.Objects,"ACC",aacc,oscnt);
			for(k=0;k<aacc.length;k=k+1)begin
				if(nonblank(aacc[k]))then begin
					POr.Objects = RemoveObjectFromObjectList(POr.Objects,aacc[k]);
				end;
			end;
			if (nonblank(POr.Objects)) then begin POr.Objects = POr.Objects & ","; end;
				POr.Objects = POr.Objects & "SNT";
			end;
	
      PutWindowRecord(wn,POr);
    end;
  end;
  PODClassPOClassEFAfter = res;
end;




function Boolean PODClassConsgTypeEFAfter(integer wn,integer fn,integer rownr,integer changed)// Edit ************************** BPI Ukraine - KramarAlexandr - 05, 19 07 2019 y. at 10:46:55 AM
begin
  record POVc POr;
	row POVc POrw;
  boolean res;
  integer i,mtrw;
  record ConsCompBlock CCb;
  val rate;
  
  blockload(CCb);
  
  res = true;
  if(CCb.ConsAddShipCost==1 and POr.ConsManualCost==0)then begin
		if (changed!=0) then begin
			GetWindowRecord(wn,POr);
			mtrw = matrowcnt(POr);
			if (mtrw>0) then begin
				if(rownr>-1)then begin
					matrowget(POr,rownr,POrw);
					if(POrw.ConsgType==1)then begin
						rate = 1;
						if(POr.FrRate!=0 and POr.ToRateB1!=0)then begin
							rate = POr.ToRateB1/POr.FrRate;
						end;
						POrw.CustomsCost = POrw.Price * 0.15 * rate;// Edit ************************** BPI Ukraine - KramarAlexandr - 05, 19 07 2019 y. at 10:46:57 AM
						// matrowput(POr,rownr,POrw);
						// PutWindowRecord(wn,POr);
						// PODClassShipCostEFAfter(wn,fn,rownr,changed);
					end;
				end;
			end;
		end;
  end;
  PODClassConsgTypeEFAfter = res;
end;




global 
function Boolean PODClassWeightRowEFAfter(Integer wn,Integer fn,Integer rownr,Integer changedf,integer column)
begin
  Boolean chsum,chrsum;
  record POVc POr;
  row POVc POrw;
  val p,s;

  if (changedf!=0) then begin
    GetWindowRecord(wn,POr);
    DeselectWindow(wn,false);
		PODClassWeightRow(POr,rownr);
    POSumUp(POr);
    PutWindowRecord(wn,POr);
  end;
  PODClassWeightRowEFAfter = true;
  return;
end;



global 
function Boolean PODClassCaratRowEFAfter(Integer wn,Integer fn,Integer rownr,Integer changedf,integer column)
begin
  Boolean chsum,chrsum;
  record POVc POr;
  row POVc POrw;
  val p,s;

  if (changedf!=0) then begin
    GetWindowRecord(wn,POr);
    DeselectWindow(wn,false);
		PODClassCaratRow(POr,rownr);
    POSumUp(POr);
    PutWindowRecord(wn,POr);
  end;
  PODClassCaratRowEFAfter = true;
  return;
end;


global 
function Boolean PODClassCaratplacerRowEFAfter(Integer wn,Integer fn,Integer rownr,Integer changedf,integer column)
begin
  Boolean chsum,chrsum;
  record POVc POr;
  row POVc POrw;
  val p,s;

  if (changedf!=0) then begin
    GetWindowRecord(wn,POr);
    DeselectWindow(wn,false);
		PODClassCaratRow(POr,rownr);
    POSumUp(POr);
    PutWindowRecord(wn,POr);
  end;
  PODClassCaratplacerRowEFAfter = true;
  return;
end;








global 
function Boolean PODClassConsgTypeEFAfter(Integer wn,Integer fn,Integer rownr,Integer changedf)
begin
  Boolean chsum,chrsum;
  record POVc POr;
  row POVc POrw;
  val p,s;

  if (changedf!=0) then begin
    GetWindowRecord(wn,POr);
    DeselectWindow(wn,false);
		matrowget(POr,rownr,POrw);
		if (POrw.ConsgType==1) then begin
			POrw.CostAcc = "41/02";
			matrowput(POr,rownr,POrw);
		end;
    PutWindowRecord(wn,POr);
  end;
  PODClassConsgTypeEFAfter = true;
  return;
end;





global 
function Boolean PODClassTax15PercentSumEFAfter(Integer wn,Integer fn,Integer rownr,Integer changedf) // Edit ****************** Ihor Trubachov 16*06*2021
begin
 record POVc POr;

  if (changedf!=0) then begin
		GetWindowRecord(wn,POr);   
		remPODClassTax15PercentSumEFAfter(POr,wn);
		PutWindowRecord(wn,POr);
  end;
	
  PODClassTax15PercentSumEFAfter = true;
  return;
end;

global 
function Boolean PODClassTax15PercentfEFAfter(Integer wn,Integer fn,Integer rownr,Integer changedf) // Edit ****************** Ihor Trubachov 17*06*2021
begin
 record POVc POr;

  if (changedf!=0) then begin
		GetWindowRecord(wn,POr);   
		remPODClassTax15PercentSumEFAfter(POr,wn);
		PutWindowRecord(wn,POr);
  end;
	
  PODClassTax15PercentfEFAfter = true;
  return;
end;



global
function Boolean PODClassAfterEditField(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
BEGIN
  Boolean res;

  switch (fieldname) begin
    case "PlanShip": res = PODClassPlanShipEFAfter(wn,changed!=0);
    case "SalesMan": res = PODClassSalesManEFAfter(wn,changed!=0);
    case "CurncyCode": res = PODClassCurncyCodeEFAfter(wn,changed!=0);
    case "TransDate": res = PODClassTransDateEFAfter(wn,changed!=0);
    case "Location": res = PODClassLocationEFAfter(wn,changed!=0);
    case "VECode": res = PODClassVECodeEFAfter(wn,changed!=0);
    case "PRCode": res = PODClassPRCodeEFAfter(wn,rownr,changed!=0);

    case "PlanShipRow": res = PODClassPlanShipRowEFAfter(wn,rownr,changed!=0);
    case "ArtCode": res = PODClassArtCodeEFAfter(wn,rownr,changed!=0);
    case "VEArtCode": res = PODClassVEArtCodeEFAfter(wn,rownr,changed!=0);
    case "Quant": res = PODClassQuantEFAfter(wn,rownr,changed!=0);
    case "VEQuant": res = PODClassVEQuantEFAfter(wn,rownr,changed!=0);
    case "Price": res = PODClassPriceEFAfter(wn,rownr,changed!=0);
    case "vRebate": res = PODClassvRebateEFAfter(wn,rownr,changed!=0);
    case "Sum": res = PODClassSumEFAfter(wn,rownr,changed!=0);
    case "VATCode": res = PODClassVATCodeEFAfter(wn,rownr,changed!=0);
    case "TaxTemplateCode": res = PODClassTaxTemplateCodeEFAfter(wn,rownr,changed!=0);
    
    case "Cost1": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,1);
    case "Cost2": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,2);
    case "Cost3": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,3);
    case "Cost4": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,4);
    case "Cost5": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,5);
    case "RowCost1": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,1);
    case "RowCost2": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,2);
    case "RowCost3": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,3);
    case "RowCost4": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,4);
    case "RowCost5": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,5);
    case "ShipCost": res = PODClassShipCostEFAfter(wn,fn,rownr,changed);
    case "CustomsCost": res = PODClassCustomsCostEFAfter(wn,fn,rownr,changed);
    case "StockType": res = PODClassStockTypeEFAfter(wn,rownr,changed!=0);
    case "TREO": res = PODClassTREOEFAfter(wn,rownr,changed!=0);
    case "xClassification": res = PasteClassification(wn,fieldname,fn,rownr,changed); //edited by---------------------Dima  19.05.2015
    case "Spec": res = PasteSpec(wn,fieldname,fn,rownr,changed);
    case "EAN13Code": res = PasteEAN13Code(wn,fieldname,fn,rownr,changed);
    case "Comment": res = PasteComment(wn,fieldname,fn,rownr,changed);
    case "RowWeight": res = PasteRowWeight(wn,fieldname,fn,rownr,changed);
    case "Metal": res = PasteMetal(wn,fieldname,fn,rownr,changed);
    case "MajStoneDet": res = PasteMajStoneDet(wn,fieldname,fn,rownr,changed);
    case "Size": res = PasteSize(wn,fieldname,fn,rownr,changed);
    case "Colour": res = PasteColour(wn,fieldname,fn,rownr,changed);
    //case "ArtCode": res = PasteArtCode(wn,fieldname,fn,rownr,changed);  //End----------------------Dima  19.05.2015
    case "IDPrepay": res = PODClassIDPrepayEFAfter(wn,changed);//Edit-------------------Vitalii 15:17 22.03.2018
    case "IDPrepayProc": res = PODClassIDPrepayProcEFAfter(wn,changed);
    case "IDBalPay": res = PODClassIDBalPayEFAfter(wn,changed);
    case "IDBalPayProc": res = PODClassIDBalPayProcEFAfter(wn,changed);
    case "Sum4": res = PODClassSum4EFAfter(wn,changed);
    case "PayDeal": res = PODClassPayDealEFAfter(wn,changed);
    case "PlanShipDate": res = PODClassPlanShipDateEFAfter(wn,changed);
		case "WeightRow": res = PODClassWeightRowEFAfter(wn,fn,rownr,changed,4);
    case "CaratRow": res = PODClassCaratRowEFAfter(wn,fn,rownr,changed,5);
		case "CaratplacerRow": res = PODClassCaratRowEFAfter(wn,fn,rownr,changed,5);
		case "ConsgType": res = PODClassConsgTypeEFAfter(wn,fn,rownr,changed);// Edit ************************** BPI Ukraine - KramarAlexandr - 05, 19 07 2019 y. at 10:43:30 AM
		case "IDMfrFinConfirmDate": res = PODClassIDMfrFinConfirmEFAfter(wn,changed);
		case "POClass": res = PODClassPOClassEFAfter(wn,changed);
		case "Tax15PercentSum": res = PODClassTax15PercentSumEFAfter(wn,fn,rownr,changed); // Edit ****************** Ihor Trubachov 16*06*2021
		case "Tax15Percentf": res = PODClassTax15PercentfEFAfter(wn,fn,rownr,changed);  // Edit ****************** Ihor Trubachov 17*06*2021
		
  end;
  PODClassAfterEditField = res;
  RETURN;
END;

global
function Boolean PODClassBeforeEditField(Integer wn,string fieldname,Integer fn, Integer rownr)
BEGIN
  Boolean res;
  record POVc POr;
  row POVc POrw;

  switch (fieldname) begin  
    case "Quant":     
      GetWindowRecord(wn,POr);      
      MatRowGet(POr,rownr,POrw);
      if (POrw.Quant==0) then begin
        if (TestForMATVARINS(wn)) then begin end;
      end;
  end;
  PODClassBeforeEditField = res;
  return;
end;

global
function Boolean PODClassExportFlagButtonAction(Integer wn,Integer value)
BEGIN
  Boolean res;
//vat zone should be as it is on customer card
//otherwise u can paste customer  , filled all, change vat zone and get crap
  res = false;
  PODClassExportFlagButtonAction = res;
  RETURN;
END;

procedure PODClassSpecPasteNameArtCode(Integer wn,var string psname)
begin
  record POVc POr;
  Integer rownr;

  GetWindowRecord(wn,POr);
  rownr = WindowActiveRow(wn);
  DeselectWindow(wn,false);//to get VARINSClass working
  WindowFieldGoto(wn,POr,rownr,"ArtCode",false);
  return;
end;

global
function string 40 PODClassSpecPasteName(Integer wn,string defpsname)
begin
  string 40 psname;

  psname = defpsname;
  switch (WindowActiveField(wn)) begin
    case "ArtCode": PODClassSpecPasteNameArtCode(wn,psname);
  end;
  PODClassSpecPasteName = psname;
  return;
end;

// iOS functions follows

global 
procedure PODClassOpenCurrency()
BEGIN
  Integer wn,nwn;
  string 255 subset;
  record POVc POr;
  
  wn = CurWindow;
  GetWindowRecord(wn,POr);
  nwn = OpenWindow("POCurrencyDClass",1,wn,subset,"",POr);
  PutWindowRecord(wn,POr);
  RETURN;
END;

global
function boolean POCurrencyDClassOnOKWindow(Integer wn)
begin
  record POVc POr;
  Integer mwn;

  mwn = MotherWindow(wn);
  if (WindowState(mwn)==Rs_normal) then begin
    SetWindowState(mwn,Rs_update);
  end;
  if (WindowState(mwn)!=Rs_normal) then begin
    GetWindowRecord(wn,POr);
    PutWindowRecord(mwn,POr);
  end;
  CloseWindow(wn);
  
  POCurrencyDClassOnOKWindow = true;
end;

global
function Boolean POCurrencyDClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
BEGIN
  Boolean res;
  Integer mwn;
  record POVc POr;
  
  switch (fieldname) begin
    case "CurncyCode": 
			res = PODClassCurncyCodeEFAfter(wn,changed!=0);
  end;
  
  POCurrencyDClassAfterEditField = res;
  RETURN;
END;

global 
procedure PODClassOpenDelTerms()
BEGIN
  Integer wn,nwn;
  string 255 subset;
  record POVc POr;
  
  wn = CurWindow;
  GetWindowRecord(wn,POr);
  nwn = OpenWindow("PODelTermsDClass",1,wn,subset,"",POr);
  PutWindowRecord(wn,POr);
  RETURN;
END;

global
function boolean PODelTermsDClassOnOKWindow(Integer wn)
begin
  record POVc POr;
  Integer mwn;

  mwn = MotherWindow(wn);
  if (WindowState(mwn)==Rs_normal) then begin
    SetWindowState(mwn,Rs_update);
  end;
  if (WindowState(mwn)!=Rs_normal) then begin
    GetWindowRecord(wn,POr);
    PutWindowRecord(mwn,POr);
  end;
  CloseWindow(wn);
  
  PODelTermsDClassOnOKWindow = true;
end;

global
function Boolean PODelTermsDClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
BEGIN
  Boolean res;

  switch (fieldname) begin
    case "Location": res = PODClassLocationEFAfter(wn,changed!=0);
  end;
  PODelTermsDClassAfterEditField = res;
  RETURN;
END;

global 
procedure PODClassOpenComment()
BEGIN
  Integer wn,nwn;
  string 255 subset;
  record POVc POr;
  
  wn = CurWindow;
  GetWindowRecord(wn,POr);
  nwn = OpenWindow("POCommentDClass",1,wn,subset,"",POr);
  PutWindowRecord(wn,POr);
  RETURN;
END;

global
function boolean POCommentDClassOnOKWindow(Integer wn)
begin
  record POVc POr;
  Integer mwn;

  mwn = MotherWindow(wn);
  if (WindowState(mwn)==Rs_normal) then begin
    SetWindowState(mwn,Rs_update);
  end;
  if (WindowState(mwn)!=Rs_normal) then begin
    GetWindowRecord(wn,POr);
    PutWindowRecord(mwn,POr);
  end;
  CloseWindow(wn);
  
  POCommentDClassOnOKWindow = true;
end;

/*
global
function Boolean POCommentDClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
BEGIN
  Boolean res;

  switch (fieldname) begin
  end;
  POCommentDClassAfterEditField = res;
  RETURN;
END;
*/

global 
procedure PODClassOpenOrdAddress()
BEGIN
  Integer wn,nwn;
  string 255 subset;
  record POVc POr;
  
  wn = CurWindow;
  GetWindowRecord(wn,POr);
  nwn = OpenWindow("POOrdAddressDClass",1,wn,subset,"",POr);
  PutWindowRecord(wn,POr);
  RETURN;
END;

global
function boolean POOrdAddressDClassOnOKWindow(Integer wn)
begin
  record POVc POr;
  Integer mwn;

  mwn = MotherWindow(wn);
  if (WindowState(mwn)==Rs_normal) then begin
    SetWindowState(mwn,Rs_update);
  end;
  if (WindowState(mwn)!=Rs_normal) then begin
    GetWindowRecord(wn,POr);
    PutWindowRecord(mwn,POr);
  end;
  CloseWindow(wn);
  
  POOrdAddressDClassOnOKWindow = true;
end;

/*
global
function Boolean POOrdAddressDClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
BEGIN
  Boolean res;

  switch (fieldname) begin
  end;
  POInvAddressDClassAfterEditField = res;
  RETURN;
END;
*/

global 
procedure PODClassOpenDelAddress()
BEGIN
  Integer wn,nwn;
  string 255 subset;
  record POVc POr;
  
  wn = CurWindow;
  GetWindowRecord(wn,POr);
  nwn = OpenWindow("PODelAddressDClass",1,wn,subset,"",POr);
  PutWindowRecord(wn,POr);
  RETURN;
END;

global
function boolean PODelAddressDClassOnOKWindow(Integer wn)
begin
  record POVc POr;
  Integer mwn;

  mwn = MotherWindow(wn);
  if (WindowState(mwn)==Rs_normal) then begin
    SetWindowState(mwn,Rs_update);
  end;
  if (WindowState(mwn)!=Rs_normal) then begin
    GetWindowRecord(wn,POr);
    PutWindowRecord(mwn,POr);
  end;
  CloseWindow(wn);
  
  PODelAddressDClassOnOKWindow = true;
end;

/*
global
function Boolean PODelAddressDClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
BEGIN
  Boolean res;

  switch (fieldname) begin
  end;
  PODelAddressDClassAfterEditField = res;
  RETURN;
END;
*/

global 
procedure PODClassOpenExtraCosts()
BEGIN
  Integer wn,nwn;
  string 255 subset;
  record POVc POr;
  
  wn = CurWindow;
  GetWindowRecord(wn,POr);
  nwn = OpenWindow("POExtraCostsDClass",1,wn,subset,"",POr);
  PutWindowRecord(wn,POr);
  RETURN;
END;

global
function boolean POExtraCostsDClassOnOKWindow(Integer wn)
begin
  record POVc POr;
  Integer mwn;

  mwn = MotherWindow(wn);
  if (WindowState(mwn)==Rs_normal) then begin
    SetWindowState(mwn,Rs_update);
  end;
  if (WindowState(mwn)!=Rs_normal) then begin
    GetWindowRecord(wn,POr);
    PutWindowRecord(mwn,POr);
  end;
  CloseWindow(wn);
  
  POExtraCostsDClassOnOKWindow = true;
end;


global
function Boolean POExtraCostsDClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
BEGIN
  Boolean res;

  switch (fieldname) begin
    case "Cost1": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,1);
    case "Cost2": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,2);
    case "Cost3": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,3);
    case "Cost4": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,4);
    case "Cost5": res = PODClassCost1_5EFAfter(wn,fn,rownr,changed,5);
  end;
  POExtraCostsDClassAfterEditField = res;
  RETURN;
END;







global
procedure PODClassEditRow(Integer wn,Integer rwn)
begin
  record POVc POr;
  row POVc POrw;
  record RcVc RepSpec;
  integer nwn;
  
  GetWindowRecord(wn,POr);
  MatRowGet(POr,rwn,POrw);
  
  RepSpec.long1 = rwn;
  RepSpec.f1 = POrw.ArtCode;
  RepSpec.long2 = POrw.Quant;
  RepSpec.ObjType = PORw.UnitCode;
  RepSpec.f2 = POrw.Spec;
  RepSpec.vals0 = POrw.Price;
  RepSpec.vals1 = POrw.vRebate;
  RepSpec.vals2 = POrw.Sum;
  
  nwn = OpenWindow("PORowDClass",0,wn,"","",RepSpec);
end;

global
procedure PODClassAddRow(Integer wn,Integer rwn)
begin
  record POVc POr;
  row POVc POrw;

  GetWindowRecord(wn,POr);
  MatRowGet(POr,rwn,POrw);
  POrw.stp = kInvoiceRowTypeNormal;
  MatRowPut(POr,rwn,POrw);
  PutWindowRecord(wn,POr);
  PODClassEditRow(wn,rwn);
  return;
end;

global
procedure PORowDClassTrash()
begin
  record RcVc RepSpec;
  record POVc POr;
  integer wn;
  integer mwn;
  integer rwn;
  
  wn = CurWindow;
  mwn = MotherWindow(wn);
  
  GetWindowRecord(wn,RepSpec);
  GetWindowRecord(mwn,POr);
  
  rwn = RepSpec.long1;
  MatRowDelete(POr,rwn);
  
  PutWindowRecord(mwn,POr);
  CloseWindow(wn);
end;

global
function boolean PORowDClassOnOKWindow(Integer wn)
begin
  record RcVc RepSpec;
  record POVc POr;
  row POVc POrw;
  integer mwn;
  integer rwn;
  
  mwn = MotherWindow(wn);
  GetWindowRecord(mwn,POr);
  
  GetWindowRecord(wn,RepSpec);
  rwn = RepSpec.long1;
  
  MatRowGet(POr,rwn,POrw);
  
  POrw.ArtCode = RepSpec.f1;
  POrw.Quant = RepSpec.long2;
  POrw.UnitCode = RepSpec.ObjType;
  POrw.Spec = RepSpec.f2;
  POrw.Price = RepSpec.vals0;
  POrw.vRebate = RepSpec.vals1;
  POrw.Sum = RepSpec.vals2;
  POrw.stp = kInvoiceRowTypeNormal;

  MatRowPut(POr,rwn,POrw);
  PutWindowRecord(mwn,POr);
  
  PORowDClassOnOKWindow = true;
end;


global
function Boolean PORowDClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
BEGIN
  Boolean res;
  Integer mwn;
  Integer rwn;
  record RcVc RepSpec;
  record POVc POr,PO2r;
  row POVc POrw;
  
  GetWindowRecord(wn,RepSpec);
  rwn = RepSpec.long1;

  mwn = MotherWindow(wn);
  GetWindowRecord(mwn,POr);
  GetWindowRecord(mwn,PO2r);
  
  MatRowGet(POr,rwn,POrw);
  POrw.ArtCode = RepSpec.f1;
  POrw.Quant = RepSpec.long2;
  POrw.UnitCode = RepSpec.ObjType;
  POrw.Spec = RepSpec.f2;
  POrw.Price = RepSpec.vals0;
  POrw.vRebate = RepSpec.vals1;
  POrw.Sum = RepSpec.vals2;
  MatRowPut(POr,rwn,POrw);
  PutWindowRecord(mwn,POr);
  
  switch (fieldname) begin
//    case "PlanShipRow": res = PODClassPlanShipRowEFAfter(mwn,rwn,changed!=0);
    case "f1": res = PODClassArtCodeEFAfter(mwn,rownr,changed!=0);
//    case "VEArtCode": res = PODClassVEArtCodeEFAfter(mwn,rwn,changed!=0);
    case "long2": res = PODClassQuantEFAfter(mwn,rwn,changed!=0);
//    case "VEQuant": res = PODClassVEQuantEFAfter(wn,rownr,changed!=0);
    case "vals0": res = PODClassPriceEFAfter(mwn,rwn,changed!=0);
    case "vals1": res = PODClassvRebateEFAfter(mwn,rwn,changed!=0);
    case "vals2": res = PODClassSumEFAfter(mwn,rwn,changed!=0);
//    case "VATCode": res = PODClassVATCodeEFAfter(wn,rownr,changed!=0);
//    case "TaxTemplateCode": res = PODClassTaxTemplateCodeEFAfter(wn,rownr,changed!=0);
//    
//    case "RowCost1": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,1);
//    case "RowCost2": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,2);
//    case "RowCost3": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,3);
//    case "RowCost4": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,4);
//    case "RowCost5": res = PODClassRowCost1_5EFAfter(wn,fn,rownr,changed,5);
//    case "ShipCost": res = PODClassShipCostEFAfter(wn,fn,rownr,changed);
//    case "CustomsCost": res = PODClassCustomsCostEFAfter(wn,fn,rownr,changed);
//    case "StockType": res = PODClassStockTypeEFAfter(wn,rownr,changed!=0);
//    case "TREO": res = PODClassTREOEFAfter(wn,rownr,changed!=0);
  end;

  if (res==true and changed!=0) then begin
    GetWindowRecord(mwn,POr);
    MatRowGet(POr,rwn,POrw);
    RepSpec.f1 = POrw.ArtCode;
    RepSpec.long2 = POrw.Quant;
    RepSpec.ObjType = POrw.UnitCode;
    RepSpec.f2 = POrw.Spec;
    RepSpec.vals0 = POrw.Price;
    RepSpec.vals1 = POrw.vRebate;
    RepSpec.vals2 = POrw.Sum;
    PutWindowRecord(wn,RepSpec);
  end;
  PutWindowRecord(mwn,PO2r);

  PORowDClassAfterEditField = res;
  RETURN;
END;

global
function Boolean PODClassOpenRecord(Integer wn,string fieldname,Integer fn,Integer rownr)
begin
  Boolean res;
  record POVc POr;
  
  GetWindowRecord(wn,POr);  
  switch (fieldname) begin
    case "VEContact":
      res = OpenContactRecord(POr.VEContact,POr.VECode);
  end;
  PODClassOpenRecord = res;
end;

global
updating procedure DownPayFromPODsm()
begin
  Integer wn,nwn;
  record RcVc RepSpec;
  record POVc POr;
  record PODownPayBlock DPb;
  record VIVc VIr;
  Integer r;
  string 255 errstr;
  Boolean testf;

  wn = CurWindow;
  DeselectWindow(wn,false);
  if (WindowState(wn)!=Rs_normal) then begin
    Beep;
    goto LDownPayFromPODsm;
  end;
  if (UserCanAction("POToDownPay",true)==false) then begin
    MessageBox(1274,StringFromStringSet(3,"POToDownPay"));
    goto LDownPayFromPODsm;
  end;
  GetWindowRecord(wn,POr);
  r = POTestApprovalStatus(POr);
  if (r!=0) then begin
    MessageBox(r,"");
    goto LDownPayFromPODsm;
  end;
  BlockLoad(DPb);
  if (DPb.DetailsOnVI==0) then begin
    r = RecordAction_POOrdDownPay(POr.SerNr,blankval,blankval,VIr,errstr,0);
    switch (r) begin
      case -1: 
        if (nonblank(errstr)) then begin
          MessageBox(0,errstr);
        end else begin
          Beep;
        end;
      case -2: MessageBox(1281,"");
      otherwise
        nwn = OpenWindow("VIDClass",1,0,"","",VIr);
        UpdateBrowses("POVc");
    end;
  end else begin
    ReportDefaults(RepSpec,"DownPayFromPOVClass");
    RepSpec.FirstVer = POr.SerNr;
    RepSpec.vals0 = DPb.Percentage;
    nwn = OpenWindow("DownPayFromPOVClass",1,0,"","",RepSpec);
    PutWindowRecord(nwn,RepSpec);
    SelectWindow(nwn);
  end;
LDownPayFromPODsm:;  
  return;
end;

global
updating function Boolean DownPayFromPOVClassOnOKWindow(Integer wn)
begin
  record RcVc RepSpec;
  record VIVc VIr;
  Integer nwn;
  Integer r;
  string 255 errstr;
  
  GetWindowRecord(wn,RepSpec);
  if (RepSpec.FirstVer<=0) then begin
    MessageBox(1058,"");
    WindowFieldGoto(wn,RepSpec,-1,"FirstVer",true);
    goto LDownPayFromPOVClassOnOKWindow;
  end;
  r = RecordAction_POOrdDownPay(RepSpec.FirstVer,RepSpec.vals0,blankval,VIr,errstr,RepSpec.flags[1]);
  CloseWindow(wn);
  switch (r) begin
    case -1: 
      if (nonblank(errstr)) then begin
        MessageBox(0,errstr);
      end else begin
        Beep;
      end;
    case -2: MessageBox(1281,"");
    otherwise
      nwn = OpenWindow("VIDClass",1,0,"","",VIr);
      UpdateBrowses("POVc");
  end;
LDownPayFromPOVClassOnOKWindow:;  
  DownPayFromPOVClassOnOKWindow = false;
  return;
end;


function Boolean PODClassOrderDoneFlagButtonAction(Integer wn,Integer value) //edited by BPI {
BEGIN
  Boolean res;
  record POVc POr;
  Integer normalmode,updatemode;
  Integer err;
 
 	res = true;
  getwindowrecord(wn,POr);

  if(POr.OKFlag==1 and POr.OrderDoneFlag==1)then begin
  	res = false;
  end;
     
  PODClassOrderDoneFlagButtonAction = res;
  RETURN;
END; //edited by BPI }


global function ORDeliverTimeDsm() //edited by BPI {
begin
	integer wn;
	record DIVc DIr;
	record CUVc CUr;
	record ORVc ORr;
	row ORVc ORrw;
	integer mtrw,i,j,days;
	date plan;
	string 100 class,model,brand;
	record INVc INr;
	integer acnt,pos;
	array string 100 amodel,abrand,avendor;
	boolean findar;
  boolean TrHs,testf;
		
	wn = curwindow;
	WindowFieldGoto(wn,ORr,-1,"SerNr",true);
	deselectwindow(wn,false);
	getwindowrecord(wn,ORr);
	if(ORr.OKFlag==0)then begin
		mtrw = matrowcnt(ORr);
		
		For(i=0;i<mtrw;i=i+1) begin
			matrowget(ORr,i,ORrw);
			if(nonblank(ORrw.ArtCode))then begin
				pos = 0;
				class = "";
				model = "";
				brand = "";
				INr.Code = ORrw.ArtCode;
				readfirstmain(INr,1,true);
				ExtractObj(INr.DispGroups,pos,class);
				while(nonblank(class))begin
					DIr.Code = class;
					readfirstmain(DIr,1,true);
					if(DIr.CType=="MODEL")then begin
						model = DIr.Name;
					end;
					if(DIr.CType=="BRAND")then begin
						brand = DIr.Name;
					end;
					ExtractObj(INr.DispGroups,pos,class);
				end;
				findar = true;
				For(j=0;j<acnt;j=j+1) begin
					if(abrand[j]==brand)then begin
						findar = false;
					end;
				end; 
				if(findar)then begin
					abrand[acnt]=brand;
					CUr.Name = brand;
          //Edit-------------------Vitalii 11:20 27.03.2018
          TrHs = true;
          while(loopkey("Name",CUr,1,TrHs))begin
            testf = true;
            if(CUr.Name!=brand)then begin TrHs = false; testf = false; end;
            //if(CUr.Code>"0009999" or CUr.Code<"0000001")then begin testf = false; end;
            if ((CUr.VECat=="IDEA") and (currentcompany!=28))then begin testf = false; end;
            if ((CUr.VECat!="IDEA") and (currentcompany==28))then begin testf = false; end;

            if(testf)then begin
              TrHs = false;
              avendor[acnt] = CUr.Code;
            end;
          end;
          resetloop(CUr);
					/*if(readfirstkey("Name",CUr,1,true))then begin
						avendor[acnt] = CUr.Code;
					end;*/
					acnt = acnt + 1;
				end;
			end;
		end; 
		days = 0;
		For(i=0;i<acnt;i=i+1) begin
	  	CUr.Code = avendor[i];
			if(readfirstmain(CUr,1,true))then begin
				if(CUr.PlanShipDays>0)then begin
					if(days<CUr.PlanShipDays)then begin
						days = CUr.PlanShipDays;
					end;
				end;
			end;
		end;
		plan = "";
		if(days>0)then begin
			plan = addday(ORr.OrdDate,days + 27);
		end;
		
		ORr.PlanShip = plan;
		putwindowrecord(wn,ORr);
	end;
return;
end; //edited by BPI }




global //edited by BPI {
function Boolean IVLClassOnOpenWindow(Integer wn)
begin
array string 10 as;
record UserVc USr;
string 5 subset;
  
  subset = "";
  USr.Code = currentuser;
  readfirstmain(USr,1,true);
  if(usercanaction("ViewNextIV",true)==false)then begin
    subset = USr.SalesGroup;
  end;
  if(nonblank(subset))then begin
  	setwindowsubset(wn,subset);
  end;
  IVLClassOnOpenWindow = false;
  
  return;
end; //edited by BPI }

global //edited by BPI {
procedure PrintLabRecDsm()
BEGIN
  record RcVc RepSpec;
  record PUVc PUr;
  record StockMovVc SMr;
  Integer wn;

  wn = CurWindow;
  if (wn>0) then begin
    switch (GetWindowFileName(wn)) begin
      case "PUVc":
        GetWindowRecord(wn,PUr);
        RepSpec.f1 = PUr.SerNr;
        RepSpec.f2 = PUr.Location; //Edit***************************Sasha2,10:25 30.09.2015
        RepSpec.f3 = "PUVc";
        RepSpec.Media = mtPrinter;
        RepSpec.ArtMode = 6;
        RepSpec.repname = "PULabForm";
        RepSpec.JobDf = 1;
        RepSpec.Custf = WindowsMode;
        OpenWindow("PULabMyRClass",1,wn,"","",RepSpec);
      case "StockMovVc":
        GetWindowRecord(wn,SMr);
        RepSpec.f1 = SMr.SerNr;
        RepSpec.f2 = SMr.FrLocation; //Edit***************************Sasha2,10:25 30.09.2015
        RepSpec.f3 = "StockMovVc";
        RepSpec.Media = mtPrinter;
        RepSpec.ArtMode = 0;
        RepSpec.repname = "SMLabForm";
        RepSpec.JobDf = 1;
        RepSpec.Custf = WindowsMode;
        OpenWindow("PULabMyRClass",1,wn,"","",RepSpec);
    end;
  end;
  
  //if (PrintDocument(RepSpec,"PULabForm",false)) then begin end;
  
  RETURN;
END; //edited by BPI }


global //edited by BPI {
updating procedure CreateLoyaltyCardDsm()
begin
	record CUVc CUr;
	integer wn;
	record LoyaltyCardVc LoyaltyCardr;
	
	wn = curwindow;
	getwindowrecord(wn,CUr);
	recordnew(LoyaltyCardr);
	CreateLoyaltyCardRemote(CUr,LoyaltyCardr);
	OpenWindow("LoyaltyCardDClass",0,0,"","",LoyaltyCardr);

return;
end; //edited by BPI }

global
updating procedure OpenPOShipmDataDsm()
begin
	record POVc POr;
  record POShipmDataVc POSDr;
	integer wn,nwn;
	
	wn = curwindow;
	getwindowrecord(wn,POr);
	if(POr.SerNr>-1)then begin
		POSDr.POSerNr = POr.SerNr;
		if readfirstmain(POSDr,1,true) then begin
		end else begin
			RecordNew(POSDr);
			POSDr.POSerNr = POr.SerNr;
		end;
		nwn = FindWindow("POShipmDataDClass");
		if(currentcompany==18)then begin
			nwn = FindWindow("CCPOShipmDataDClass");
		end;
		if (nwn!=0) then begin
			PutWindowRecord(nwn,POSDr);
			SelectWindow(nwn);
		end else begin
			if(currentcompany==18)then begin
				if(UserCanAction("OpenPOSHAfterPO",true))then begin nwn = OpenWindow("CCPOShipmDataDClass",0,0,"","",POSDr); end;
			end else begin
				if(UserCanAction("OpenPOSHAfterPO",true))then begin nwn = OpenWindow("POShipmDataDClass",0,0,"","",POSDr); end;
			end;
		end;
  end;

return;
end;

global
procedure IDAppendPRBtnClick()
begin
  record POVc POr;
  integer wn;
  
  wn = curwindow;
  deselectwindow(wn,false);
  getwindowrecord(wn,POr);
  
  if nonblank(POr.IDRefPRNum) then begin
    IDPasteORinPO(POr);
    putwindowrecord(wn,POr);
  end else begin
    MessageBox(35149,"");
  end;
  
  return;
end;

global
updating procedure IDPasteItemsToPRDsm()
begin
record POVc POr, IDEAPOr;
record ORVc ORr;
integer wn,nwn;

wn = curwindow;
deselectwindow(wn,false);
getwindowrecord(wn,POr);
if (POr.IDGDEAPORef>0 and currentCompany==18) then begin
	SetCompany(28,false);
	IDEAPOr.SerNr = POr.IDGDEAPORef;
	if (ReadFIrstMain(IDEAPOr,1,true)) then begin
		if nonblank(IDEAPOr.IDRefPRNum) then begin
			IDPasteItemsPOinOR(IDEAPOr,ORr);
		end else begin
			MessageBox(35149,"");
		end;
	end;
	ResetCompany(18);
end;

return;
end;

global
updating procedure PasteItemsToPR()
begin
  record POVc POr;
  record ORVc ORr;
  integer wn,nwn;
  
  wn = curwindow;
  deselectwindow(wn,false);
  getwindowrecord(wn,POr);
  
  if nonblank(POr.IDRefPRNum) then begin
    IDPasteItemsPOinOR(POr,ORr);
		if (readfirstkey("CustOrdNr",ORr,1,true)) then begin
      nwn = OpenWindow("ORDClass",0,0,"","",ORr);
    end;
  end else begin
    MessageBox(35149,"");
  end;
  
  return;
end;



global
procedure IDOpenPRFromPO()
begin
  record POVc POr;
  record ORVc ORr;
  integer wn,nwn;
  
  wn = curwindow;
  deselectwindow(wn,false);
  getwindowrecord(wn,POr);
  
  if nonblank(POr.IDRefPRNum) then begin
    ORr.CustOrdNr = POr.IDRefPRNum;
    if (readfirstkey("CustOrdNr",ORr,1,true)) then begin
      nwn = OpenWindow("ORDClass",0,0,"","",ORr);
    end;
  end else begin
    MessageBox(35149,"");
  end;
  
  return;
end;


global procedure OSDSumUp (var record OSDVc OSDr)
begin
	row OSDVc OSDrw;
	longint i, j,rwcnt;
	val sum;
	rwcnt = matrowcnt(OSDr);
	for (i=0;i<rwcnt;i=i+1) begin
		matrowget(OSDr,i,OSDrw);
		sum = sum + OSDrw.Sum;
	end;
	OSDr.Total = sum;
return;
end;



function boolean OSDDDClassQuantAfter(integer wn,integer rownr,Integer changed)
begin
	record OSDVc OSDr;
	row OSDVc OSDrw;
	record INVc INr;
	
	if(changed>0 and rownr>=0)then begin
		getwindowrecord(wn,OSDr);
		matrowget(OSDr,rownr,OSDrw);
		if(nonblank(OSDrw.CostPrice) and nonblank(OSDrw.Quant))then begin
			OSDrw.Sum = OSDrw.CostPrice*OSDrw.Quant;
		end else begin
			OSDrw.Sum = 0;
		end;
		matrowput(OSDr,rownr,OSDrw);
		Putwindowrecord(wn,OSDr);
		getwindowrecord(wn,OSDr);
		OSDSumUp(OSDr);
		Putwindowrecord(wn,OSDr);
	end;
	
	OSDDDClassQuantAfter = true;
return;
end;



function boolean OSDDDClassVendorCodeAfter(integer wn ,Integer changed)
begin
	record OSDVc OSDr;
	row OSDVc OSDrw;
	record INVc INr;
	record CUVc CUr;
	
	if(changed>0)then begin
		getwindowrecord(wn,OSDr);
		CUr.Code = OSDr.VendorCode;
		if(ReadFirstMain(CUr,1,true)) then begin
			OSDr.VendorName = CUr.Name;
			OSDr.Contact = CUr.Person;
			OSDr.Phone = CUr.Phone;
			OSDr.Fax = CUr.Fax;		
		end;
		Putwindowrecord(wn,OSDr);
	end;
	
	OSDDDClassVendorCodeAfter = true;
return;
end;

function boolean OSDDDClassSumAfter(integer wn,integer rownr,Integer changed)
begin
	record OSDVc OSDr;
	row OSDVc OSDrw;
	record INVc INr;
	
	if(changed>0 and rownr>=0)then begin
		getwindowrecord(wn,OSDr);
		matrowget(OSDr,rownr,OSDrw);
		if(nonblank(OSDrw.CostPrice) and nonblank(OSDrw.Quant) and nonblank(OSDrw.Sum))then begin
			OSDrw.CostPrice = OSDrw.Sum/OSDrw.Quant;
		end else begin
			OSDrw.Sum = 0;
		end;
		matrowput(OSDr,rownr,OSDrw);
		Putwindowrecord(wn,OSDr);
		getwindowrecord(wn,OSDr);
		OSDSumUp(OSDr);
		Putwindowrecord(wn,OSDr);
	end;
	
	OSDDDClassSumAfter = true;
return;
end;



function boolean OSDDDClassArtCodeAfter(integer wn,integer rownr,Integer changed)
begin
	record OSDVc OSDr;
	row OSDVc OSDrw;
	record INVc INr;
	record BPIColorVc Colourr;
	record BPISizeVc Sizer;
	
	if(changed>0 and rownr>=0)then begin
		getwindowrecord(wn,OSDr);
		matrowget(OSDr,rownr,OSDrw);
		if(nonblank(OSDrw.ArtCode))then begin
			INr.Code = OSDrw.ArtCode;
			readfirstmain(INr,1,true);
			OSDrw.Spec = INr.Name;
			OSDrw.UnitCode = INr.Unittext;
			OSDrw.Article = INr.AlternativeCode;
			Colourr.Code = INr.BPIColor;
			Sizer.Code = INr.BPISize;
			if(readfirstmain(Sizer,1,true))then begin OSDrw.Classification = Sizer.Name; end;
			if(readfirstmain(Colourr,1,true))then begin OSDrw.Classification = OSDrw.Classification  & "," &  Colourr.Name; end;
		end else begin
			OSDrw.Spec = "";
			OSDrw.Spec = "";
			OSDrw.UnitCode = "";
			OSDrw.Article = "";
			OSDrw.Classification = "";
		end;
		matrowput(OSDr,rownr,OSDrw);
		Putwindowrecord(wn,OSDr);
	end;
	
	OSDDDClassArtCodeAfter = true;
return;
end;

global
function Boolean OSDDClassOnOverStrike(Integer wn,Integer rownr)
BEGIN
  record OSDVc OSDr;

  if (rownr>=0) then begin
    GetWindowRecord(wn,OSDr);
			OSDSumup(OSDr);
    PutWindowRecord(wn,OSDr);    
  end;
  OSDDClassOnOverStrike = true;
  RETURN;
END;



global
function Boolean OSDDClassAfterEditField(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
  Boolean res;
	
	
	switch (fieldname) begin
    case "ArtCode": res = OSDDDClassArtCodeAfter(wn,rownr,changed);
		case "Quant": res = OSDDDClassQuantAfter(wn,rownr,changed);
		case "CostPrice": res = OSDDDClassQuantAfter(wn,rownr,changed);
		case "Sum": res = OSDDDClassSumAfter(wn,rownr,changed);
		case "VendorCode": res = OSDDDClassVendorCodeAfter(wn,changed);
  end;
	
	
	OSDDClassAfterEditField = res;
  return;
end;



global
procedure OSDCodeSClassArrayOnOpen(var Array string astr,var Integer acnt)
begin
  longint i, rwcnt, j;
	record OSDSerialBock OSDSb;
	row OSDSerialBock OSDSrw;
	string 255 OldserNr, CurSerNr;
	
	BlockLoad(OSDSb);
	rwcnt = matrowcnt(OSDSb);
	for (i=0;i<rwcnt;i=i+1) begin
		matrowget(OSDSb,i,OSDSrw);
		OldserNr = OSDSrw.CurNr;
		NextM4SerialNumber(OldserNr,CurSerNr);
		astr[i] = CurSerNr & "    " & OSDSrw.Description;
	end;

	
	acnt = i;
			
    
  return;
end;


global
function Boolean OSDCodeSClassOnOpenWindow(Integer wn)
begin
  Array string 255 astr;
  Integer i,acnt;
  
  OSDCodeSClassArrayOnOpen(astr,acnt);
  for (i=0;i<acnt;i=i+1) begin
    SetListString(wn,len(astr[i]),astr[i],false);    
  end;
  OSDCodeSClassOnOpenWindow = false;
  return;
end;

global
updating function Boolean OSDCodeSClassOnOKWindow(Integer wn)
begin
	record OSDSerialBock OSDSb;
	row OSDSerialBock OSDSrw;
	record OSDVc OSDr;
	longint mwn,rwcnt,i;
	
  PasteFromSysList(wn,8);
	
  OSDCodeSClassOnOKWindow = false;
  return;
end;



global updating procedure ORFromPOConsDsm()
begin
	record POVc POr;
	row POVc POrw;
	integer wn,i,mtrw,curcomp;
	record ORVc ORr;
	row ORVc ORrw;
	record LocationVc Locr;
	string 100 backfob,msg;
	integer res;
	
	wn = curwindow;
	getwindowrecord(wn,POr);
	
	if(windowstate(wn)!=Rs_normal)then begin
		messagebox(0,"Save document first");
		goto lORFromPOConsDsm;
	end;
	
	if(POr.OKFlag==1)then begin
		if(POr.VECode=="FOB_SKLAD")then begin
			mtrw = matrowcnt(POr);
			if(mtrw>0)then begin
				curcomp = currentcompany;
				Locr.Code = POr.Location;
				if(readfirstmain(Locr,1,true))then begin
					backfob = Locr.FOBSuplier;
				end;
				
				if(blank(backfob))then begin
					messagebox(0,"Blank FOB Suppllier for order");
					goto lORFromPOConsDsm;
				end;
				
				
				//SetCompany(18,false);//++++++++++++++++++++++++ CC in
					//recordnew(ORr);
					res = Remote_ORFromPOConsDsm(POr,ORr,msg);
					if(res==-1)then begin
						messagebox(0,msg);
						goto lORFromPOConsDsm;
					end;
					
					if(ORr.SerNr>-1)then begin
						createrecordlink(POr,currentcompany,ORr,18);
						createrecordlink(ORr,18,POr,currentcompany);
					end;
					
				//resetcompany(curcomp);//++++++++++++++++++++++++ CC out
			end else begin
				messagebox(0,"Purchase Order must be with items");
			end;
		end else begin
			messagebox(0,"Purchase Order must be on FOB_SKLAD vendor code");
		end;
	end else begin	
		messagebox(0,"Purchase Order must be OK'ed");
	end;
	
	lORFromPOConsDsm:;

return;
end;



global updating procedure ORFromPOCons(record POVc POr, longInt PUSerNr)
begin
	row POVc POrw;
	integer wn,i,mtrw,curcomp;
	record ORVc ORr, OldORr;
	row ORVc ORrw;
	record LocationVc Locr;
	string 100 backfob,msg, storeObj, Obj, subdiObj;
	integer res, pos, oldcomp, r;
	record ObjVc Objr;
	record OTypeAddControlBlock OType;
	row OTypeAddControlBlock OTyperw;
	string 60 warning;
	record SHVc SHr, OldSHr;
	record PUVc PUr;
	row SDVc SDrw;
	integer possubd;
	string 255 tstrsubd;
	
	if(windowstate(wn)!=Rs_normal)then begin
		messagebox(0,"Save document first");
		goto lORFromPOConsDsm;
	end;
	
	oldcomp = currentCompany;
	
	if(POr.OKFlag==1)then begin
		if(POr.VECode=="FOB_SKLAD")then begin
			mtrw = matrowcnt(POr);
			if(mtrw>0)then begin
				curcomp = currentcompany;
				Locr.Code = POr.Location;
				if(readfirstmain(Locr,1,true))then begin
					backfob = Locr.FOBSuplier;
				end;
				
				if(blank(backfob))then begin
					messagebox(0,"Blank FOB Suppllier for order");
					goto lORFromPOConsDsm;
				end;
				
				
				//SetCompany(18,false);//++++++++++++++++++++++++ CC in
					//recordnew(ORr);
						res = Remote_ORFromPOConsDsm2(POr,ORr,msg,PUSerNr);

					if(res==-1)then begin
						messagebox(0,msg);
						goto lORFromPOConsDsm;
					end;
					
					pos = 0;
					storeObj = "";
					ExtractObj(POr.Objects,pos,Obj);
					while (nonblank(Obj)) begin 
						OBJr.Code = Obj;
						if (ReadFirstMain(OBJr,1,true)) then begin
							if (OBJr.OTCode=="STORE") then begin
								storeObj = OBJr.Code;
							end;
						end;
						ExtractObj(POr.Objects,pos,Obj);
					end;
					
					if (nonblank(storeObj)) then begin
						SetCompany(18,false);
						BlockLoad(OType);
						for (i=0;i<matrowcnt(OType);i=i+1) begin
							matrowget(OType,i,OTyperw);
							if (nonblank(OTyperw.STORE)) then begin
								if (OTyperw.STORE==storeObj) then begin
									possubd = 0;
									tstrsubd = "";
									ExtractObjWithSeparator(",",OTyperw.SUBDI,true,possubd,tstrsubd);
									subdiObj = tstrsubd;
								end;
							end else begin
								i = matrowcnt(OType);
							end;
						end;
						if (nonblank(subdiObj)) then begin
							if (!SetInSet(subdiObj,ORr.Objects)) then begin
								ORr.Objects = ORr.Objects & "," & subdiObj;
							end;
							recordstore(ORr,true);
							recordCopy(OldORr,ORr);
							ORr.OKFlag = 1;
							RecordUpdate(OldORr,ORr,true);
						end;
						r = RecordAction_raPasteOrdInShip2(SHr,ORr.SerNr,warning);
						RecordCopy(OldSHr,SHr);
						SHr.OKFlag = 1;
						if (RecordUpdate(OldSHr,SHr,true)==0) then begin
							PUr.SerNr = PUSerNr;
							if (ReadFirstMain(PUr,1,true)) then begin
								createrecordlink(PUr,currentcompany,SHr,currentcompany);
								createrecordlink(SHr,currentcompany,PUr,currentcompany);
							end;
						end;
						
						ResetCompany(oldcomp);
					end;
					
					if(ORr.SerNr>-1)then begin
						createrecordlink(POr,currentcompany,ORr,18);
						createrecordlink(ORr,18,POr,currentcompany);
					end;
					
				//resetcompany(curcomp);//++++++++++++++++++++++++ CC out
			end else begin
				messagebox(0,"Purchase Order must be with items");
			end;
		end else begin
			messagebox(0,"Purchase Order must be on FOB_SKLAD vendor code");
		end;
	end else begin	
		messagebox(0,"Purchase Order must be OK'ed");
	end;
	
	lORFromPOConsDsm:;

return;
end;




global 
procedure PIConsSClassArrayOnOpen(var Array string astr,var Integer acnt,string item,var Array string items,var Array string vendor,var Array string comment)
BEGIN
  record PIVc PIr;
	boolean TrHs;
	
	PIr.ItemCode = item;
	TrHs = true;
	while(Loopmain(PIr,1,TrHs)) begin
		if(PIr.ItemCode!=item) then begin TrHs = false; end;
		if(TrHs) then begin
			astr[acnt] = PIr.VEItemCode;
			items[acnt] = PIr.ItemCode;
			vendor[acnt] = PIr.VECode;
			comment[acnt] = PIr.Comment;
			acnt = acnt + 1;
		end;	
	end;	
  RETURN;
END;

global 
function Boolean PIConsSClassOnOpenWindow(Integer wn)
BEGIN
  LongInt i,mwn;
  string 255 subset;
  Array string 255 adi,astr,items,vendor,comment;
  Integer acnt,rwnr;
	record POVc POr;
	row POVc POrw;
  
  mwn = MotherWindow(wn);
	if(mwn!=-1)then begin
		GetwindowRecord(mwn,POr);
		rwnr = WindowActiveRow(mwn);
		matrowget(POr,rwnr,POrw);
		PIConsSClassArrayOnOpen(astr,acnt,POrw.ArtCode,items,vendor,comment);
		for (i=0;i<acnt;i=i+1) begin
			SetListString(wn,900,astr[i] & chr(9) & items[i] & chr(9) & vendor[i] & chr(9) & comment[i] ,false); 
		end;
	end;
 
  PIConsSClassOnOpenWindow = true;
  RETURN;
END; 

global
function Boolean PIConsSClassOnOKWindow(Integer wn)
begin
  PasteFromSysList(wn,-2);
  PIConsSClassOnOKWindow = false;
  return;
end;
/*

global procedure POSAudit_EditField()// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 29 10 2019 y. at 11:19:53 AM
begin
	logtext(0,"POSAudit_EditField");
return;
end;

global procedure HTSLogAction()// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 29 10 2019 y. at 11:19:53 AM
begin
	logtext(0,"HTSLogAction");
return;
end;


global procedure SendLogAction()// Edit ************************** BPI Ukraine - KramarAlexandr - 02, 29 10 2019 y. at 11:19:53 AM
begin
	logtext(0,"SendLogAction");
return;
end;
*/