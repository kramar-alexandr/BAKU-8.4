//server-only
external function val AbsoluteVal(val);
external function roundmode SetRoundModeD(Integer);
external procedure NoDupObjs(string,var string);
external procedure ExtractObj(string,var Integer,var string);
remote procedure NextM4SerialNumber(string,var string);
remote function boolean CompanyIsJWLikeCompany(Integer);
external procedure StripSpace(var string,string); //Edit_________________ABR 16.10 10:10; 
external procedure PUSumUp(var record PUVc);
external function Boolean GetItemPurchasePriceDiscount(string,string,Date,string,string,val,string,string,string,string,Integer,Boolean,val,val,val,val,val,
         var record INVc,var record PIVc,var Boolean,var val,var string,var val,var string,var string,var Boolean,var string);
external function Boolean GetFirstPurchaseItem2(string,string,string,var record PIVc);
external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);
external function val DivRateToBase1(string,val,val,val,val,val,val,roundmode);
external procedure GetItemVATCode(string,Integer,var string,Boolean);
external function Boolean GetFirstPurchaseItem(string,string,string,var record PIVc);
external function roundmode GetCostRoundMode(record RoundBlock);
external function string 255 FillupTaxMatrix(Integer,string,string,string,string,string,var record TaxMatrixVc); 
external function string 255 FindINObjects(string,string);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external procedure PUCalcPerc(val,string,var val); 
external procedure DivPIFactor(val,val,var val);
external procedure FindPUStockAcc(string,record CostAccBlock,string,string,string,record INVc,Integer,var string,var string,Boolean);
external procedure PUCalcCostPrice(string,val,Integer,Integer,string,string,
                                   val,val,val,val,val,
                                   val,val,val,val,val,val,
                                   string,var val,val,var val,string,Integer); //Edit***************************Sasha2,13:04 08.04.2015
external updating procedure UpdateGlobalItem(var record INVc);//Edit_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-Anton 10:31 21.08.2018
external updating procedure CreateNewGlobalItem(var record INVc);// Edit ************************** BPI Ukraine - KramarAlexandr - Wednesday, 26 December 2018 12:42:52
external procedure GetPriceItem(string,var val,var val);
external function string 255 StrReplace(string,string,string);// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 19 March 2019 14:26:14
external function Boolean SetInSet2(string,string);
external procedure StripEndingSpaces(var string);
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
external procedure AddAreaAfterArea(var area,area);
external procedure LogProcTime(string,longint);
external updating procedure SendAsyncUpdateContactToCRM(var record CUVc);

SetLangMode(LangRussian,"RUS",0);

procedure PUVc_FillRow(var record PUVc PUr,Integer rownr)		//Edit-----------Dima 25.12.2014
BEGIN
  Boolean res;
  record CostAccBlock CostAccRec;
  record PIVc PIr;
  record INVc INr;
  row PUVc PUrw;
  Boolean chrsum;
  string 60 sz,msk,mskrep,pcstr,tstr;
  val t,p,s,t2;
  record SysFormatBlock SFb;
  string 200 varsubset,location;
  Boolean infoundf;
  record RoundBlock Roundb;
  string 20 stockacc,purchacc;
  record LocationVc Locr;
  record MainStockBlock MSb;
  Boolean nomoreremotecalls,pifound;
  record TaxMatrixVc TMr;
  string 255 taxtemplatecode,vatcode,descstr;
  val price,reb;
  
  MatRowGet(PUr,rownr,PUrw); 

  infoundf = GetItemPurchasePriceDiscount(PUr.VECode,PUr.Location,PUr.TransDate,PUr.CurncyCode,PUrw.ArtCode,PUrw.Quant,
                                   PUr.Location,"","","",0,true,
                                   PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,
                                   INr,PIr,pifound,price,descstr,reb,vatcode,purchacc,nomoreremotecalls,taxtemplatecode);
  if (infoundf) then begin
    BlockLoad(SFb);
    BlockLoad(CostAccRec);    
    BlockLoad(Roundb);    
    BlockLoad(MSb);
    Locr.Code = PUr.Location;
    if (blank(Locr.Code)) then begin
      Locr.Code = MSb.MainStock;
    end;
    ReadFirstMain(Locr,1,true);
		
    pcstr = "";
		/*
    if (GetFirstPurchaseItem(PUrw.ArtCode,PUr.Location,PUr.VECode,PIr)) then begin
      if (PIr.CurncyCode==PUr.CurncyCode) then begin
		if (blank(PUrw.UPrice)) then begin
     	   PUrw.UPrice = PIr.PurPrice;
		   p = PIr.PurPrice;
		end else begin
		   p =  PUrw.UPrice;
		end;
        
      end else begin
        CurValToOtherCur(PUr.TransDate,PIr.CurncyCode,PIr.PurPrice,PUr.CurncyCode,t,GetCostRoundMode(Roundb));
        PUrw.UPrice = t;  
        p = PUrw.UPrice;
      end;          
      PUrw.CountryOfOrg = PIr.OrgCountry;
      PUrw.CustomsCost = PIr.PurchaseCost;
      PUrw.VEItemCode = PIr.VEItemCode;
      PUrw.VEUnit = PIr.VEUnit;
      PUrw.CountryOfOrg = PIr.OrgCountry;
      if (INr.PriceFactor!=0) then begin
        p = p/INr.PriceFactor;
      end;
    end else begin
      PUrw.Spec = INr.Name;
		if (blank(PUrw.UPrice)) then begin
		      PUrw.UPrice = INr.InPrice;
			 p = INr.InPrice;
		end else begin
		      p = PUrw.UPrice;
		end;
      if (INr.PriceFactor!=0) then begin
        p = p/INr.PriceFactor;
      end;
      p = DivRateToBase1(PUr.CurncyCode,p,PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,GetCostRoundMode(Roundb));
    end;*/ 
    PUrw.VATCode = PUr.VEVATCode;    
    if (blank(PUrw.VATCode)) then begin
      GetItemVATCode(PUrw.ArtCode,PUr.ExportFlag,tstr,false);
      PUrw.VATCode = tstr;
    end;
    PUrw.TaxTemplateCode = FillupTaxMatrix(1,PUr.BranchID,PUr.VECode,"","",taxtemplatecode,TMr);
    PUrw.Coefficient = INr.UnitCoefficient;
    //PUrw.InPrice = INr.InPrice;
    PUrw.ArtCode = INr.Code;
    PUrw.Spec = INr.Name;
    PUrw.Objects = FindINObjects(INr.Objects,INr.Group);
    //PUrw.UPrice = p;
    PUrw.UnitXval = INr.Width;
    PUrw.UnitYval = INr.Height;
    PUrw.UnitZval = INr.Depth;
    PUrw.UnitCode = INr.Unittext;
    location = PUrw.Location;
    if (blank(location)) then begin
      location = PUr.Location;
    end;
    if (Locr.RequirePos!=0) then begin
      PUrw.PosCode = Locr.WHMDefPUPosCode;
    end;

    //t2 = MulRateToBase1(PUr.CurncyCode,p,PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,GetCostRoundMode(Roundb));
    //PUCalcPerc(t2,PUrw.CustomsCost,t2);
    pcstr = ValToString(t2,M45Val,SFb.thousSep,SFb.decimalPt,0);
    PUrw.CustomsCost = pcstr;
    //PUrw.BasePrice = INr.UPrice1;
    tstr = INr.ExtraCost;
    PUrw.Extra = tstr;
    PUrw.PIFactor = PIr.PIFactor;
    PUrw.StockType = PIr.DefStockType;
    /*if (PUrw.PIFactor!=0) then begin
      PUrw.UPrice = PUrw.UPrice/PUrw.PIFactor;
    end;*/
    //DivPIFactor(PUrw.Quant,PUrw.PIFactor,t);
    PUrw.VEQuant = t;
    
    if (blank(PUrw.Location)) then begin
      //FindPUStockAcc(PUr.VECode,CostAccRec,PUrw.CostAcc,PUrw.CredAcc,PUr.Location,INr,PUrw.StockType,stockacc,purchacc,true);
    end else begin
      //FindPUStockAcc(PUr.VECode,CostAccRec,PUrw.CostAcc,PUrw.CredAcc,PUrw.Location,INr,PUrw.StockType,stockacc,purchacc,true);
    end;
    PUrw.CostAcc = stockacc;
    PUrw.CredAcc = purchacc;

    PackRowFieldMatrix(PUrw,"TaxMatrix",TMr);
    MatRowPut(PUr,rownr,PUrw);
    chrsum = true;
    res = true;
  end;
	/*
  if (chrsum) then begin
    PUCalcCostPrice(PUrw.ArtCode,PUrw.UPrice,PUr.InclVAT,PUr.NoTAXonVAT,PUrw.Extra,PUr.CurncyCode,
                    PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,
                    PUrw.ShipCost,PUrw.RowCost1,PUrw.RowCost2,PUrw.RowCost3,PUrw.RowCost4,PUrw.RowCost5,
                    PUrw.CustomsCost,p,PUrw.Quant,s,PUrw.VATCode,PUr.ExportFlag);
    PUrw.CostPrice = p;
    PUrw.Sum = s;
  end;*/
  MatRowPut(PUr,rownr,PUrw);    

  RETURN;
END;

Global updating procedure FillNamesIm()
begin
record INVc INr;
record GlobalItemVc GIr;
row INVc INrw;
string 255 code;
array string 255 names,codes;
integer i,oldComp,j,CompQty;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;		
	BlockLoad(Compb);
	
	logtext(0,"start");
	CompQty = matrowcnt(Compb);
	
	oldComp = currentcompany;
		while (TestEOF()==false) begin
			code = importfield;
			//logtext(0,code);
			for (i=0;i<1;i=i+1) begin
				codes[i] = importfield;
			end;
			for (i=0;i<1;i=i+1) begin
				names[i] = importfield;
			end;
			for (j=0;j<CompQty;j=j+1)begin
				matrowget(Compb,j,Comprw);
				if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(j+1) or j+1==3) and j+1!=10)then begin
					setcompany(j+1,false);
					INr.Code = code;
					if(ReadFirstMain(INr,1,true)) then begin
						for (i=0;i<1;i=i+1) begin
							if(nonblank(names[i])) then begin
								matrowget(INr,i,INrw);
								INrw.LangCode = codes[i];
								INrw.Text = names[i];
								matrowput(INr,i,INrw);
							end;
						end;
						// logtext(0,INr.Code);
						RecordStore(INr,true);
						GIr.Code = INr.GlobalArtCode;
						if(ReadFirstkey("Code",GIr,1,true)) then begin
							logtext(0,INr.GlobalArtCode);
							for (i=0;i<1;i=i+1) begin
								if(nonblank(names[i])) then begin
									if(codes[i]=="RUS") then begin GIr.NameRUS = names[i]; end;
									if(codes[i]=="AZ") then begin GIr.NameAZ = names[i]; end;
								end;
							end;
							RecordStore(GIr,true);
						end;
					end;	
	
				end;
			end;	
		NextImportLine(true);
		end;
	setcompany(oldComp,false);
	logtext(0,"finish");
 return;
end;

Global updating procedure FillPresIm()
begin
	record PLVc PLr;
	Integer i,j,oldComp,CompQty;
	array string 255 sfield;
	record GlobalItemVc GIr;
	string 5 flag;
	record INVc INr;
	record PLDefVc PLDr;
	val price, calcprice, calcrebate;		
	record CurncyCodeVc Curncyr;
	string 255 tstr,code;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;		
	BlockLoad(Compb);
	
	
	CompQty = matrowcnt(Compb);
	
		oldComp = currentcompany;
		while (TestEOF()==false) begin
			code = ImportField; 
			for (i=0;i<26;i=i+1) begin
				sfield[i]=ImportField;
			end;
			for (j=0;j<CompQty;j=j+1)begin
				matrowget(Compb,j,Comprw);
				if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(j+1) or j+1==3) and j+1!=10)then begin
					setcompany(j+1,false);
					logtext(0,currentcompany);
					INr.Code = code;
					if(readfirstmain(INr,1,true)) then begin
						INr.BTRxGiftClass = "";
						for (i=0;i<26;i=i+1) begin
							if(nonblank(sfield[i])) then begin
								INr.BTRxGiftClass = INr.BTRxGiftClass & sfield[i] & ",";
							end;
						end;
						/*INr.BTRxGiftClass = left(INr.BTRxGiftClass,len(INr.BTRxGiftClass) - 1);
						RecordStore(INr,true);*/
					
						GIr.Code = INr.GlobalArtCode;
						if(readfirstKey("Code",GIr,1,true)) then begin
							GIr.BTRxGiftClass = "";
							for (i=0;i<26;i=i+1) begin
								if(nonblank(sfield[i])) then begin								
									GIr.BTRxGiftClass = GIr.BTRxGiftClass & sfield[i] & ",";
								end;
							end;
							GIr.BTRxGiftClass = left(GIr.BTRxGiftClass,len(GIr.BTRxGiftClass) - 1);
							RecordStore(GIr,true);
						end;
					end;
				end;
			end;	
		NextImportLine(true);
		end;
	setcompany(oldComp,false);
 return;
end;

Global updating procedure ImportPLIn()
begin
	record PLVc PLr;
	Integer i;
	array string 255 sfield;
	string 5 flag;
	record INVc INr;
	record PLDefVc PLDr;
	val price, calcprice, calcrebate;		
	record CurncyCodeVc Curncyr;
	string 50 tstr;
		
		while (TestEOF()==false) begin
		  for (i=0;i<5;i=i+1) begin
        sfield[i]=ImportField;
        tstr = "";
				StripSpace(tstr,sfield[i]); //Edit_________________ABR 16.10 10:10;
				sfield[i] = tstr;
      end;
      INr.Code = sfield[1];
      if(readfirstmain(INr,1,true))then begin
        PLDr.Code = sfield[0];
        if(readfirstmain(PLDr,1,true))then begin
          if(nonblank(sfield[2]))then begin
            price = evaltoval(sfield[2]);
            if(price>0)then begin
              recordnew(PLr);
              PLr.PLCode = PLDr.Code;
              PLr.ArtCode = INr.Code;
              PLr.Comment = INr.Name;
              PLr.ExVatPrice = price;
              Curncyr.CurncyCode = sfield[3];
              if(readfirstmain(Curncyr,1,true))then begin
              	PLr.CurncyCode = Curncyr.CurncyCode;
              end;
              if(nonblank(sfield[4]) and INr.SerNrf!=0)then begin
              	PLr.SerialNr = sfield[4];
              end;
              if(RecordInsert(PLr,true))then begin
								//GetPriceItem(INr.Code,calcprice,calcrebate);
							end;
            end;            
          end;
        end;
      end else begin
      	INr.AlternativeCode = sfield[1];
      	if(readfirstKey("AlternativeCode",INr,1,true))then begin
					PLDr.Code = sfield[0];
					if(readfirstmain(PLDr,1,true))then begin
						if(nonblank(sfield[2]))then begin
							price = evaltoval(sfield[2]);
							if(price>0)then begin
								recordnew(PLr);
								PLr.PLCode = PLDr.Code;
								PLr.ArtCode = INr.Code;
								PLr.Comment = INr.Name;
								PLr.ExVatPrice = price;
								Curncyr.CurncyCode = sfield[3];
								if(readfirstmain(Curncyr,1,true))then begin
									PLr.CurncyCode = Curncyr.CurncyCode;
								end;
								if(nonblank(sfield[4]) and INr.SerNrf!=0)then begin
									PLr.SerialNr = sfield[4];
								end;
								if(RecordInsert(PLr,true))then begin
									//GetPriceItem(INr.Code,calcprice,calcrebate);
								end;
							end;            
						end;
					end;
				end else begin
					INr.BarCode = sfield[1];
					if(readfirstKey("BarCode",INr,1,true))then begin
						PLDr.Code = sfield[0];
						if(readfirstmain(PLDr,1,true))then begin
							if(nonblank(sfield[2]))then begin
								price = evaltoval(sfield[2]);
								if(price>0)then begin
									recordnew(PLr);
									PLr.PLCode = PLDr.Code;
									PLr.ArtCode = INr.Code;
									PLr.Comment = INr.Name;
									PLr.ExVatPrice = price;
									Curncyr.CurncyCode = sfield[3];
									if(readfirstmain(Curncyr,1,true))then begin
										PLr.CurncyCode = Curncyr.CurncyCode;
									end;
									if(nonblank(sfield[4]) and INr.SerNrf!=0)then begin
										PLr.SerialNr = sfield[4];
									end;
									if(RecordInsert(PLr,true))then begin
										//GetPriceItem(INr.Code,calcprice,calcrebate);
									end;
								end;            
							end;
						end;
					end;
				end;
      end;
      NextImportLine(true);
		end;

 return;
end;

Global updating procedure ImportPLCurIn()
begin
	record PLVc PLr;
	Integer i;
	array string 255 sfield;
	string 5 flag;
	record INVc INr;
	record PLDefVc PLDr;
	val price;		
	record CurncyCodeVc Curncyr;
	string 50 tstr,plcode,item,curncy;
		
		while (TestEOF()==false) begin
		  plcode = ImportField;
		  item = ImportField;
		  curncy = ImportField;
		  
		  if(nonblank(plcode) and nonblank(item) and nonblank(curncy))then begin
		  	PLr.PLCode = plcode;
		  	PLr.ArtCode = item;
		  	if(readfirstmain(PLr,2,true))then begin
		  		PLr.CurncyCode = curncy;
		  		recordstore(PLr,true);
		  	end;
		  end;
		  
      NextImportLine(true);
		end;

 return;
end;


Global updating procedure ImportDiskTableIn()
begin
	record CUVc CUr,oldCUr;
	record RebVc Rebr;
	integer i;
	string 255 sfield0,sfield1;
	
		while (TestEOF()==false) begin
			sfield0 = "";
			sfield1 = "";
			sfield0=ImportField;
			sfield1=ImportField;
      CUr.Code = sfield0;
      if(readfirstmain(CUr,1,true))then begin
        Rebr.Code = sfield1;
        if(readfirstmain(Rebr,1,true))then begin
          if(CUr.RebCode!=Rebr.Code)then begin
          	recordcopy(oldCUr,CUr);
          	CUr.RebCode = Rebr.Code;
          	recordUpdate(oldCUr,CUr,true);
          end;
        end;
      end;
      NextImportLine(true);
		end;

 return;
end;

procedure FormatString(var string field)// Edit ***** 20 June 2013 15:17:00 Larisa
begin
	string 255 tempfield,s;
	integer i,ns;
	
	tempfield = field;
	field = "";
	for (i=0;i<len(tempfield);i=i+1) begin
		s = mid(tempfield,i,1);
		ns = asc(s);
		if(ns>=32 and ns<=126)then begin
			if(ns!=34)then begin
				field = field & s;
			end;
		end;
		if(ns>=1040 and ns<=1103)then begin
			field = field & s;
		end;
	end;
	return;
end;// Edit ***** 20 June 2013 15:17:00 Larisa

global
procedure FormatUpperCaseCode(var string field)// Edit ***** 20 June 2013 15:17:00 Larisa
begin
	string 255 tempfield,s;
	integer i,ns;
	
	tempfield = UpperCase(field);
	field = "";
	for (i=0;i<len(tempfield);i=i+1) begin
		s = mid(tempfield,i,1);
		ns = asc(s);
		if(ns>=32 and ns<=96)then begin
			if(ns!=34 and ns!=44 and ns!=58)then begin
				if(ns==32)then begin
					field = field & chr(95);
				end else begin
					field = field & s;
				end;
			end;
		end;
		if(ns>=123 and ns<=126)then begin
			field = field & s;
		end;
		if(ns>=1040 and ns<=1071)then begin
			field = field & s;
		end;
	end;
	return;
end;// Edit ***** 20 June 2013 15:17:00 Larisa

updating procedure ReturnCodeClassification(var string classification)// Edit ***** 21 June 2013 10:39:00 Larisa
begin
	Integer cnt;
	record DIVc DIr;
	
	if(nonblank(classification))then begin
		DIr.Code = classification;
		if(ReadFirstMain(DIr,1,true)==false)then begin
			DIr.Name = classification;
			if(ReadFirstKey("Name",DIr,1,true)==false)then begin
				cnt = CountRecords("DIVc");
				RecordNew(DIr);
				LCntDIr:;
				DIr.Code = cnt+1;
				if(ReadFirstMain(DIr,1,true))then begin
					cnt = cnt + 1;
					goto LCntDIr;
				end;
				DIr.Code = cnt+1;
				DIr.Name = classification;
				classification = DIr.Code;
				RecordStore(DIr,true);
			end else begin
				classification = DIr.Code;
			end;
		end else begin
			classification = DIr.Code;
		end;
		
	end;
	return;
end;// Edit ***** 21 June 2013 10:39:00 Larisa

Global updating procedure ImportMyINIn()
begin
	record INVc INr;
	record RebVc Rebr;
	record ITVc ITr;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,ressfield4,alternat,color,size;
		
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		alternat = "";
		color = "";
		size = "";
		sfield3 = "";
		sfield4 = "";
		ressfield4 = "";
		sfield0 = ImportField;
		if(nonblank(sfield0))then begin
			FormatUpperCaseCode(sfield0);
			sfield1 = ImportField;
			if(nonblank(sfield1))then begin
				FormatString(sfield1);
			end;
			sfield2 = ImportField;
			if(nonblank(sfield2))then begin
				FormatString(sfield2);
			end;
			alternat = ImportField;
			color = ImportField;
			size = ImportField;
			sfield3 = ImportField;
			if(nonblank(sfield3))then begin//validate group
				ITr.Code = sfield3;
				if(ReadFirstMain(ITr,1,true)==false)then begin
					ITr.Comment = sfield3;
					if(ReadFirstKey("Comment",ITr,1,true)==false)then begin
						sfield3 = "";
					end else begin
						sfield3 = ITr.Code;
					end;
				end else begin
					sfield3 = ITr.Code;
				end;
			end;//validate group
			sfield4 = ImportField;
			if(nonblank(sfield4))then begin
				FormatString(sfield4);
				ReturnCodeClassification(sfield4);
				UpperCase(sfield4);
			end;
			while(nonblank(sfield4))begin
				if(nonblank(ressfield4))then begin
					ressfield4 = ressfield4 & "," & sfield4;
				end else begin
					ressfield4 = ressfield4 & sfield4;
				end;
				sfield4 = ImportField;
				if(nonblank(sfield4))then begin
					FormatString(sfield4);
					ReturnCodeClassification(sfield4);
					UpperCase(sfield4);
				end;
			end;
			INr.Code = sfield0;
			if(ReadFirstMain(INr,1,true))then begin
				if(nonblank(sfield1))then begin
					INr.Name = sfield1;
				end;
				if(nonblank(sfield2))then begin
					INr.BarCode = sfield2;
				end;
				if(nonblank(alternat))then begin
					INr.AlternativeCode = alternat;
				end;
				if(nonblank(color))then begin
					INr.Colour = color;
				end;
				if(nonblank(size))then begin
					INr.Size = size;
				end;
				if(nonblank(sfield3))then begin
					INr.Group = sfield3;
				end;
				if(nonblank(ressfield4))then begin
					INr.DispGroups = ressfield4;
				end;
				recordStore(INr,True);
			end else begin
				if(nonblank(sfield1))then begin
					recordNew(INr);
					INr.Code = sfield0;
					INr.Name = sfield1;
					INr.BarCode = sfield2;
					INr.AlternativeCode = alternat;
					INr.Colour = color;
					INr.Size = size;
					INr.Group = sfield3;
					INr.DispGroups = ressfield4;
					recordStore(INr,true);
				end;//if nonblank(sfield1)
			end;//if RFM INr
		end;//if nonblank(sfield0)
		NextImportLine(true);
	end;
	return;
end;


global updating procedure ImportDIVcIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,color,size;
	boolean TrHs;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield0 = ImportField;
		FormatUpperCaseCode(sfield0);
		if(nonblank(sfield0) and i==0)then begin 
			CType = sfield0;
		end;
		if(nonblank(sfield0) and i==1)then begin 
			CFirstCode = sfield0;
		end;
		if(blank(sfield0) and i==0)then begin 
			TrHs = false;
		end;
		if(blank(sfield0) and i==1)then begin 
			TrHs = false;
		end;
		if(i>1 and TrHs and NameCreatef[sfield0]!=true)then begin
			if(i>2)then begin
				RecordNew(DIr);
				NextM4SerialNumber(CFirstCode,DIr.Code);
				CFirstCode = DIr.Code;
				NameCreatef[sfield0] = true;
			end else begin
				RecordNew(DIr);
				DIr.Code = CFirstCode;
				NameCreatef[sfield0] = true;
			end;
			DIr.CType = CType;
			Dir.Name = sfield0;
			recordStore(DIr,True);
			//logtext(0,DIr.Code);
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;







global updating procedure ImportColourIdeaIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield0 = ImportField;
		CType = "COLOUR";
		TrHs2 = true;
		DIr.Code = "CL99999";
		while(loopbackkey("Code",DIr,1,TrHs2))begin
			if(nonblank(DIr.Code) and left(DIr.Code,2)=="CL")then begin CFirstCode = DIr.Code; /*logtext(0,DIr.Code & "Old Code");*/ end;
			TrHs2 = false;
		end;
		ResetLoop(DIr);
		DIr.Name = sfield0;
		if(!ReadFirstKey("Name",DIr,1,true))then begin
			RecordNew(DIr);
			if(blank(CFirstCode))then begin
				CFirstCode = "CL00000";
			end;
			NextM4SerialNumber(CFirstCode,DIr.Code);
			CFirstCode = DIr.Code;
			DIr.CType = CType;
			Dir.Name = sfield0;
			if(recordStore(DIr,True))then begin
				logtext(0,DIr.Code);
			end;
		end else begin
			//logtext(0,DIr.Name & "___" & DIr.CType & "___" & sfield0);
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;





global updating procedure ImportINDISPColourModelIdeaIn()
begin
	record INVc INr;
	record DIVc DIr;
	integer i, pos;
	string 255 sfield0,sfield1,sfield2,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, CFirstCode, ClassStr, Class;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield0 = ImportField;
		sfield1 = ImportField;
		INr.Code = sfield0;
		if(ReadfirstMain(INr,1,true))then begin
			if(nonblank(sfield1))then begin
				TrHs2 = true;
				DIr.Name = sfield1;
				while(LoopKey("Name",DIr,1,TrHs2))begin
					if(DIr.Name!=sfield1)then begin TrHs2 = false; end;
					if(DIr.CType=="COLOUR" and TrHs2)then begin
						TrHs2 = false;
						INr.Colour = DIr.Code;
						INr.DispGroups = INr.DispGroups & "," & DIr.Code;
						logtext(0,DIr.Name);
					end;
				end;
				pos = 0;
				ClassStr = INr.DispGroups;
				INr.DispGroups = "";
				Class = "";
				ExtractObj(ClassStr,pos,Class);
				while (nonblank(Class)) begin
					if (!NameCreatef[Class & "_" & INr.Code]) then begin
						NameCreatef[Class & "_" & INr.Code] = true;
						if (NonBlank(INr.DispGroups)) then begin
							INr.DispGroups = INr.DispGroups & ",";
						end;
						INr.DispGroups = INr.DispGroups & Class;
					end;
					ExtractObj(ClassStr,pos,Class);
				end;
				resetloop(DIr);
			end else begin
				INr.Colour = "";
				pos = 0;
				ClassStr = INr.DispGroups;
				INr.DispGroups = "";
				Class = "";
				ExtractObj(ClassStr,pos,Class);
				while (nonblank(Class)) begin
					DIr.Code = Class;
					if (ReadFirstMain(DIr,1,true)) then begin
						if(DIr.CType!="COLOUR" and !NameCreatef[Class & "_" & INr.Code])then begin
							NameCreatef[Class & "_" & INr.Code] = true;
							if (NonBlank(INr.DispGroups)) then begin
								INr.DispGroups = INr.DispGroups & ",";
							end;
							INr.DispGroups = INr.DispGroups & Class;
						end;
					end;
					ExtractObj(ClassStr,pos,Class);
				end;
			end;
			if(RecordStore(INr,true))then begin
				logtext(0,INr.Code);
			end;
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;



global updating procedure ImportINDISPModelIdeaIn()
begin
	record INVc INr;
	record DIVc DIr;
	integer i;
	string 255 sfield0,sfield1,sfield2,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield0 = ImportField;
		sfield2 = ImportField;
		INr.Code = sfield0;
		if(ReadfirstMain(INr,1,true))then begin
			if(nonblank(sfield2))then begin
				TrHs2 = true;
				DIr.Name = sfield2;
				while(LoopKey("Name",DIr,1,TrHs2))begin
					if(DIr.Name!=sfield2)then begin TrHs2 = false; end;
					if(DIr.CType=="MODEL" and TrHs2)then begin
						TrHs2 = false;
						INr.Reference = DIr.Code;
						INr.DispGroups = INr.DispGroups & "," & DIr.Code;
						logtext(0,DIr.Name);
					end;
				end;
				resetloop(DIr);
			end else begin
				INr.Reference = "";
			end;
			if(RecordStore(INr,true))then begin
				logtext(0,INr.Code);
			end;
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;







global updating procedure ImportModelIdeaIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield0 = ImportField;
		CType = "MODEL";
		TrHs2 = true;
		DIr.Code = "ML99999";
		while(loopbackkey("Code",DIr,1,TrHs2))begin
			if(nonblank(DIr.Code) and left(DIr.Code,2)=="ML")then begin CFirstCode = DIr.Code; /*logtext(0,DIr.Code & "Old Code");*/ end;
			TrHs2 = false;
		end;
		ResetLoop(DIr);
		DIr.Name = sfield0;
		if(!ReadFirstKey("Name",DIr,1,true))then begin
			RecordNew(DIr);
			if(blank(CFirstCode))then begin
				CFirstCode = "ML00000";
			end;
			NextM4SerialNumber(CFirstCode,DIr.Code);
			CFirstCode = DIr.Code;
			DIr.CType = CType;
			Dir.Name = sfield0;
			if(recordStore(DIr,True))then begin
				logtext(0,DIr.Code);
			end;
		end else begin
			//logtext(0,DIr.Name & "___" & DIr.CType & "___" & sfield0);
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;






global updating procedure ImportCRTbrandIdeaIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, UNUPCName;
	vector boolean NameCreatef;
	string 255 CFirstCode;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield0 = ImportField;
		UNUPCName = sfield0;
		FormatUpperCaseCode(sfield0);
		CType = "BRAND";
		TrHs2 = true;
		DIr.Code = "C999999999";
		while(loopbackkey("Code",DIr,1,TrHs2))begin
			if(nonblank(DIr.Code) and left(DIr.Code,2)=="C0")then begin CFirstCode = DIr.Code; /*logtext(0,DIr.Code & "Old Code");*/ end;
			TrHs2 = false;
		end;
		DIr.Code = sfield0;
		if(!ReadFirstMain(DIr,1,true))then begin
			RecordNew(DIr);
			if(blank(CFirstCode))then begin
				CFirstCode = "C000000000";
			end;
			NextM4SerialNumber(CFirstCode,DIr.Code);
			CFirstCode = DIr.Code;
			DIr.CType = CType;
			Dir.Name = UNUPCName;
			if(recordStore(DIr,True))then begin
				logtext(0,DIr.Code);
			end;
		end else begin
			logtext(0,DIr.Name & "___" & DIr.CType & "___" & sfield0);
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;


global
updating procedure CleanDIMn()
begin
record DIVc DIr;
boolean TrHs;
integer i;
boolean chisla;
	DIr.Code = "";
	while (loopmain(DIr,1,true))begin
		if(DIr.CType!="BRAND" and DIr.CType!="SIZE")then begin
			RecordDelete(DIr);
			StepBack(DIr);
		end;
		if(DIr.CType=="BRAND")then begin
			chisla = true;
			for(i=0;i<len(DIr.Code);i=i+1) begin
				if(ASC(mid(DIr.Code,i,1))<48 or ASC(mid(DIr.Code,i,1))>57)then begin
					chisla = false;
				end;
			end;
			if(!chisla)then begin
				RecordDelete(DIr);
				StepBack(DIr);
			end;
		end;
	end;
	return;
end;




global
updating procedure CleanITMn()
begin
record ITVc ITr;
boolean TrHs;
integer i;
boolean chisla;
	ITr.Code = "";
	while (loopmain(ITr,1,true))begin
		chisla = true;
		for(i=0;i<len(ITr.Code);i=i+1) begin
			if(ASC(mid(ITr.Code,i,1))<48 or ASC(mid(ITr.Code,i,1))>57)then begin
				chisla = false;
			end;
		end;
		if(!chisla)then begin
			RecordDelete(ITr);
			StepBack(ITr);
		end;
	end;
	return;
end;


global updating procedure ImportNormCRTbrandIdeaIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,sfield1,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, UNUPCName;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield0 = ImportField;
		sfield1 = trim(ImportField);
		UNUPCName = sfield1;
		FormatUpperCaseCode(sfield0);
		FormatUpperCaseCode(sfield1);
		CType = "BRAND";
		DIr.Code = sfield0;
		if(!ReadFirstMain(DIr,1,true))then begin
			RecordNew(DIr);
			DIr.Code = sfield1;
			DIr.CType = CType;
			Dir.Name = UNUPCName;
			if(recordStore(DIr,True))then begin
				logtext(0,DIr.Code);
			end;
		end else begin
			if(DIr.CType=="BRAND")then begin
				recorddelete(DIr);
				RecordNew(DIr);
				DIr.Code = sfield1;
				DIr.CType = CType;
				Dir.Name = UNUPCName;
				if(recordStore(DIr,True))then begin
					logtext(0,DIr.Name & "___" & DIr.CType & "___" & sfield0);
				end;
			end;
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;








global updating procedure IMportINMainStockIn()
begin
	record INVc INr;
	integer i;
	boolean TrHs;
	string 50 code,maincode;
	
	TrHs = true;
	while (TestEOF()==false) begin
		code = ImportField;
		INr.Code=code;
		if(ReadFirstMain(INr,1,true)) then begin
			INr.OutOfOrder = 0;
			RecordStore(INr,True);
		end;
		NextImportLine(true);
	end;
	return;
end;




global updating procedure ImportContactsIDIn()
begin
	record INVc INr, OldInr;
	row INVc INrw;
	record DIVc DIr,OldDIr;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,sfield8,sfield9,sfield10,sfield11,sfield12,sfield13,INCODE;
	boolean TrHs, testf;
	string 255 suf;
	
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield5 = "";
		sfield6 = "";
		sfield7 = "";
		sfield8 = "";
		sfield9 = ""; 
		sfield10 = "";
		sfield11 = "";
		sfield12 = "";
		sfield0 = ImportField;
		sfield1 = ImportField;
		sfield2 = ImportField;
		sfield3 = ImportField;
		sfield4 = ImportField;
		sfield5 = ImportField;
		sfield6 = ImportField;
		sfield7 = ImportField;
		sfield8 = ImportField;
		sfield9 = ImportField;
		sfield10 = ImportField;
		sfield11 = ImportField;
		sfield12 = ImportField;
		INr.Code = sfield0;
		if(ReadFirstMain(INr,1,true))then begin
			RecordCopy(OldInr,INr);
			INr.SN = sfield0;
			INr.SNOne = sfield1;
			INr.AlternativeCode = sfield2;
			DIr.Name = sfield3;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Reference = DIr.Code; 
			end else begin
				if(nonblank(sfield3))then begin
					DIr.Code = "ML99999";
					TrHs = true;
					while(LoopBackKey("Code",DIr,1,TrHs))begin
						if(left(DIr.Code,2)=="ML")then begin
							recordnew(DIr);
							suf = StringToInt(right(DIr.Code,5))+1;
							if(len(suf)<5)then begin
								for (i=0;i<(5-len(suf));i=i+1) begin
									suf = "0" & suf;
								end;
							end;
							DIr.Code = left(DIr.Code,2) & suf;
							DIr.Name = sfield3;
							DIr.CType = "MODEL";
							OldDir.Code = DIr.Code;
							if(readfirstmain(OldDir,1,true)==false)then begin
								if (RECORDSTORE(DIr,true)==false) then begin
									INr.Reference = DIr.Code; 
								end;
							end;
						end;
						TrHs = false;
					end;
				end;
			end;
			INr.Name = sfield4;
			INrw.Text = sfield5;
			matrowput(INr,0,INrw);
			DIr.Name = sfield6;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Colour = DIr.Code; 
			end else begin
				if(nonblank(sfield6))then begin
					DIr.Code = "CL99999";
					TrHs = true;
					while(LoopBackKey("Code",DIr,1,TrHs))begin
						if(left(DIr.Code,2)=="ML")then begin
							recordnew(DIr);
							suf = StringToInt(right(DIr.Code,5))+1;
							if(len(suf)<5)then begin
								for (i=0;i<(5-len(suf));i=i+1) begin
									suf = "0" & suf;
								end;
							end;
							DIr.Code = left(DIr.Code,2) & suf;
							DIr.Name = sfield6;
							DIr.CType = "COLOUR";
							OldDir.Code = DIr.Code;
							if(readfirstmain(OldDir,1,true)==false)then begin
								if (RECORDSTORE(DIr,true)==false) then begin
									INr.Reference = DIr.Code; 
								end;
							end;
						end;
						TrHs = false;
					end;
				end;
			end;
			INr.Unittext = sfield7;
			DIr.Name = sfield8;
			while (LoopKey("Name",DIr,1,TrHs))begin 
				if(sfield8==DIr.Name)then begin
					testf = true;
					for (i=0;i<len(DIr.Code);i=i+1)begin
						if(Asc(mid(DIr.Code,i,1))<=48 or Asc(mid(DIr.Code,i,1))>=57)then begin testf = false; end;
					end;
					if(testf==true)then begin
						INr.DispGroups = DIr.Code;
					end;
				end else begin
					TrHs = false;
				end;
			end;
			ResetLoop(DIr);
			INr.Category = sfield9;
			INr.CompletCode = sfield10;
			INr.LastPurchPrice2 = StringToVal(sfield11,M4Val);
			INr.LastPurchCurncyCode = "EUR";
			INr.InPrice = StringToVal(sfield12,M4Val);
			if(RecordUpdate(OldInr,INr,false)==0)then begin end;
		end else begin
			if(nonblank(sfield0))then begin
				RecordNew(INr);
				INr.Code = sfield0;
				INr.SN = sfield0;
				INr.SNOne = sfield1;
				INr.AlternativeCode = sfield2;
				DIr.Name = sfield3;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Reference = DIr.Code; 
				end else begin
					if(nonblank(sfield3))then begin
						DIr.Code = "ML99999";
						TrHs = true;
						while(LoopBackKey("Code",DIr,1,TrHs))begin
							if(left(DIr.Code,2)=="ML")then begin
								recordnew(DIr);
								suf = StringToInt(right(DIr.Code,5))+1;
								if(len(suf)<5)then begin
									for (i=0;i<(5-len(suf));i=i+1) begin
										suf = "0" & suf;
									end;
								end;
								DIr.Code = left(DIr.Code,2) & suf;
								DIr.Name = sfield3;
								DIr.CType = "MODEL";
								OldDir.Code = DIr.Code;
								if(readfirstmain(OldDir,1,true)==false)then begin
									if (RECORDSTORE(DIr,true)==false) then begin
										INr.Reference = DIr.Code; 
									end;
								end;
							end;
							TrHs = false;
						end;
					end;
				end;
				INr.Name = sfield4;
				INrw.Text = sfield5;
				matrowput(INr,0,INrw);
				DIr.Name = sfield6;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Colour = DIr.Code; 
				end else begin
					if(nonblank(sfield6))then begin
						DIr.Code = "CL99999";
						TrHs = true;
						while(LoopBackKey("Code",DIr,1,TrHs))begin
							if(left(DIr.Code,2)=="ML")then begin
								recordnew(DIr);
								suf = StringToInt(right(DIr.Code,5))+1;
								if(len(suf)<5)then begin
									for (i=0;i<(5-len(suf));i=i+1) begin
										suf = "0" & suf;
									end;
								end;
								DIr.Code = left(DIr.Code,2) & suf;
								DIr.Name = sfield6;
								DIr.CType = "COLOUR";
								OldDir.Code = DIr.Code;
								if(readfirstmain(OldDir,1,true)==false)then begin
									if (RECORDSTORE(DIr,true)==false) then begin
										INr.Reference = DIr.Code; 
									end;
								end;
							end;
							TrHs = false;
						end;
					end;
				end;
				INr.Unittext = sfield7;
				DIr.Name = sfield8;
				while (LoopKey("Name",DIr,1,TrHs))begin 
					if(sfield8==DIr.Name)then begin
						testf = true;
						for (i=0;i<len(DIr.Code);i=i+1)begin
							if(Asc(mid(DIr.Code,i,1))<=48 or Asc(mid(DIr.Code,i,1))>=57)then begin testf = false; end;
						end;
						if(testf==true)then begin
							INr.DispGroups = DIr.Code;
						end;
					end else begin
						TrHs = false;
					end;
				end;
				ResetLoop(DIr);
				INr.Category = sfield9;
				INr.CompletCode = sfield10;
				INr.LastPurchPrice2 = StringToVal(sfield11,M4Val);
				INr.LastPurchCurncyCode = "EUR";
				INr.InPrice = StringToVal(sfield12,M4Val);
				RecordInsert(INr,false);
			end;
		end;
		NextImportLine(true);
	end;
	return;
end;







global updating procedure ImportContactsIDfrCRTVIn()
begin
	record INVc INr, OldInr;
	row INVc INrw;
	record DIVc DIr,OldDir;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,sfield8,sfield9,sfield10,sfield11,sfield12,sfield13,sfield14,INCODE;
	record ITVc ITr;
	boolean TrHs, testf;
	string 255 suf;
	
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield5 = "";
		sfield6 = "";
		sfield7 = "";
		sfield8 = "";
		sfield9 = ""; 
		sfield10 = "";
		sfield11 = "";
		sfield12 = "";
		sfield13 = "";
		sfield0 = ImportField;
		sfield1 = ImportField;
		sfield2 = ImportField;
		sfield3 = ImportField;
		sfield4 = ImportField;
		sfield5 = ImportField;
		sfield6 = ImportField;
		sfield14 = ImportField;
		sfield7 = ImportField;
		sfield8 = ImportField;
		sfield9 = ImportField;
		sfield10 = ImportField;
		sfield11 = ImportField;
		sfield12 = ImportField;
		sfield13 = ImportField;
		INr.Code = sfield0;
		if(ReadFirstMain(INr,1,true))then begin
			//RecordCopy(OldInr,INr);
			/*INr.SN = sfield0;
			INr.SNOne = sfield1;
			INr.AlternativeCode = sfield2;
			DIr.Name = sfield3;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Reference = DIr.Code; 
			end else begin
				DIr.Code = "ML99999";
				TrHs = true;
				while(LoopBackKey("Code",DIr,1,TrHs))begin
					if(left(DIr.Code,2)=="ML")then begin
						recordnew(DIr);
						suf = StringToInt(right(DIr.Code,5))+1;
						if(len(suf)<5)then begin
							for (i=0;i<(5-len(suf));i=i+1) begin
								suf = "0" & suf;
							end;
						end;
						DIr.Code = left(DIr.Code,2) & suf;
						DIr.Name = sfield3;
						DIr.CType = "MODEL";
						OldDir.Code = DIr.Code;
						if(readfirstmain(OldDir,1,true)==false)then begin
							if (RECORDSTORE(DIr,true)==false) then begin
								logtext(0,DIr.Code);
								INr.Reference = DIr.Code; 
							end;
						end;
					end;
					TrHs = false;
				end;
			end;*/
			INr.Name = sfield4;
			/*INrw.Text = sfield5;
			matrowput(INr,0,INrw);
			DIr.Name = sfield6;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Colour = DIr.Code; 
			end else begin
				DIr.Code = "CL99999";
				TrHs = true;
				while(LoopBackKey("Code",DIr,1,TrHs))begin
					if(left(DIr.Code,2)=="ML")then begin
						recordnew(DIr);
						suf = StringToInt(right(DIr.Code,5))+1;
						if(len(suf)<5)then begin
							for (i=0;i<(5-len(suf));i=i+1) begin
								suf = "0" & suf;
							end;
						end;
						DIr.Code = left(DIr.Code,2) & suf;
						DIr.Name = sfield6;
						DIr.CType = "COLOUR";
						OldDir.Code = DIr.Code;
						if(readfirstmain(OldDir,1,true)==false)then begin
							if (RECORDSTORE(DIr,true)==false) then begin
								logtext(0,DIr.Code);
								INr.Reference = DIr.Code; 
							end;
						end;
					end;
					TrHs = false;
				end;
			end;
			INr.Unittext = sfield7;
			TrHs = true;
			DIr.Name = sfield8;
			while (LoopKey("Name",DIr,1,TrHs))begin 
				if(sfield8==DIr.Name)then begin
					testf = false;
					for (i=0;i<len(DIr.Code);i=i+1)begin
						if(Asc(mid(DIr.Code,i,1))<=48 or Asc(mid(DIr.Code,i,1))>=57)then begin testf = true; end;
					end;
					if(testf==true)then begin
						INr.DispGroups = DIr.Code;
					end;
				end else begin
					TrHs = false;
				end;
			end;
			ResetLoop(DIr);*/
			/*ITr.Comment = sfield8;
			if(readfirstKey("Comment",ITr,1,true))then begin 
				INr.Group = ITr.Code; 
			end;*/
			/*INr.Category = sfield9;
			INr.CompletCode = sfield10;
			INr.LastPurchPrice2 = StringToVal(sfield11,M4Val);
			INr.LastPurchCurncyCode = "EUR";
			INr.InPrice = StringToVal(sfield12,M4Val);
			INr.IDOldINNr = sfield13;
			DIr.Name = sfield14;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Size = DIr.Code; 
			end else begin
				INr.Size = sfield14;
			end;*/
			//if(RecordUpdate(OldInr,INr,false)==0)then begin end;
			recordstore(INr,true);
		end else begin
			if(nonblank(sfield0))then begin
				RecordNew(INr);
				INr.Code = sfield0;
				INr.SN = sfield0;
				INr.SNOne = sfield1;
				INr.AlternativeCode = sfield2;
				DIr.Name = sfield3;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Reference = DIr.Code; 
				end else begin
					DIr.Code = "ML99999";
					TrHs = true;
					while(LoopBackKey("Code",DIr,1,TrHs))begin
						if(left(DIr.Code,2)=="ML")then begin
							recordnew(DIr);
							suf = StringToInt(right(DIr.Code,5))+1;
							if(len(suf)<7)then begin
								for (i=0;i<(7-len(suf));i=i+1) begin
									suf = "0" & suf;
								end;
							end;
							DIr.Code = left(DIr.Code,2) & suf;
							DIr.Name = sfield3;
							DIr.CType = "MODEL";
							
							if (RECORDSTORE(DIr,true)==false) then begin
								logtext(0,DIr.Code);
								INr.Reference = DIr.Code; 
							end;
						end;
						TrHs = false;
					end;
				end;
				INr.Name = sfield4;
				INrw.Text = sfield5;
				matrowput(INr,0,INrw);
				DIr.Name = sfield6;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Colour = DIr.Code; 
				end else begin
					DIr.Code = "CL99999";
					TrHs = true;
					while(LoopBackKey("Code",DIr,1,TrHs))begin
						if(left(DIr.Code,2)=="ML")then begin
							recordnew(DIr);
							suf = StringToInt(right(DIr.Code,5))+1;
							if(len(suf)<7)then begin
								for (i=0;i<(7-len(suf));i=i+1) begin
									suf = "0" & suf;
								end;
							end;
							DIr.Code = left(DIr.Code,2) & suf;
							DIr.Name = sfield6;
							DIr.CType = "COLOUR";
							if(readfirstmain(OldDir,1,true)==false)then begin
								if (RECORDSTORE(DIr,true)==false) then begin
									logtext(0,DIr.Code);
									INr.Reference = DIr.Code; 
								end;
							end;
						end;
						TrHs = false;
					end;
				end;
				INr.Unittext = sfield7;
				DIr.Name = sfield8;
				while (LoopKey("Name",DIr,1,TrHs))begin 
					if(sfield8==DIr.Name)then begin
						testf = false;
						for (i=0;i<len(DIr.Code);i=i+1)begin
							if(Asc(mid(DIr.Code,i,1))<=48 or Asc(mid(DIr.Code,i,1))>=57)then begin testf = true; end;
						end;
						if(testf==true)then begin
							INr.DispGroups = DIr.Code;
						end;
					end else begin
						TrHs = false;
					end;
				end;
				ResetLoop(DIr);
				/*
				ITr.Comment = sfield8;
				if(readfirstKey("Comment",ITr,1,true))then begin 
					INr.Group = ITr.Code; 
				end;*/
				INr.Category = sfield9;
				INr.CompletCode = sfield10;
				INr.LastPurchPrice2 = StringToVal(sfield11,M4Val);
				INr.LastPurchCurncyCode = "EUR";
				INr.InPrice = StringToVal(sfield12,M4Val);
				INr.IDOldINNr = sfield13;
				DIr.Name = sfield14;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Size = DIr.Code; 
				end else begin
					INr.Size = sfield14;
				end;
				RecordInsert(INr,false);
			end;
		end;
		NextImportLine(true);
	end;
	return;
end;



global updating procedure ImportBrandsIDIn()
begin
	record DIVc DIr, OldDIr;
	record CUVc CUr, OldCUr;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,sfield8,sfield9,sfield10,sfield11,sfield12,sfield13,sfield14;
	
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield5 = "";
		sfield6 = "";
		sfield0 = ImportField;
		sfield1 = ImportField;
		sfield2 = ImportField;
		sfield3 = ImportField;
		sfield4 = ImportField;
		sfield5 = ImportField;
		sfield6 = ImportField;
		DIr.Code = sfield0;
		if(!ReadFirstMain(DIr,1,true))then begin
			if(nonblank(sfield0))then begin
				RecordNew(DIr);
				DIr.Code = sfield0;
				DIr.Name = sfield1;
				Dir.CType = "BRAND";
				RecordInsert(DIr,false);
			end;
		end;
		CUr.Code = sfield0;
		if(ReadFirstMain(CUr,1,true))then begin
			RecordCopy(OldCUr,CUr);
			CUr.Name = sfield1;
			CUr.InvAddr1 = sfield2;
			CUr.Person = sfield3;
			CUr.Phone = sfield4;
			CUr.eMail = sfield5;
			Cur.PlanShipDays = StringToInt(sfield6);
			if(RecordUpdate(OldCUr,CUr,false)==0)then begin end;
		end else begin
			if(nonblank(sfield0))then begin
				RecordNew(CUr);
				CUr.Code = sfield0;
				CUr.Name = sfield1;
				CUr.InvAddr1 = sfield2;
				CUr.Person = sfield3;
				CUr.Phone = sfield4;
				CUr.eMail = sfield5;
				Cur.PlanShipDays = StringToInt(sfield6);
				RecordInsert(CUr,false);
			end;
		end;
		NextImportLine(true);
	end;
	return;
end;






global updating procedure IMportINMainIn()
begin
	record INVc INr,oldINr;
	record GlobalItemVc GIr;
	integer i,curc;
	boolean TrHs,foundf;
	string 50 code,maincode;
	
	curc = currentcompany;
	
	TrHs = true;
	while (TestEOF()==false) begin
		code = ImportField;
		logtext(0,code);
		INr.Code=code;
		if(ReadFirstMain(INr,1,true)) then begin
			if(INr.MainCode!=INr.Code)then begin
				INr.MainCode = ImportField;
				oldINr.Code = INr.MainCode;
				if(readfirstmain(oldINr,1,true))then begin
					GIr.HansaCode = oldINr.Code;
					if(readfirstkey("HansaCode",GIr,1,true)==false)then begin
						CreateNewGlobalItem(oldINr);
						recordstore(oldINr,true);
					end;
					GIr.HansaCode = code;
					foundf = false;
					if(readfirstkey("HansaCode",GIr,1,true))then begin
						UpdateGlobalItem(INr);
					end else begin
						CreateNewGlobalItem(INr);
					end;
					RecordStore(INr,True);
				end;
			end;
		end;
		NextImportLine(true);
	end;
	//resetcompany(curc);
	return;
end;







global updating procedure IMportINMainIn()
begin
	record INVc INr,oldINr;
	record GlobalItemVc GIr;
	integer i,curc;
	boolean TrHs,foundf;
	string 50 code,maincode;
	
	curc = currentcompany;
	
	TrHs = true;
	while (TestEOF()==false) begin
		code = ImportField;
		logtext(0,code);
		INr.Code=code;
		if(ReadFirstMain(INr,1,true)) then begin
			if(INr.MainCode!=INr.Code)then begin
				INr.MainCode = ImportField;
				oldINr.Code = INr.MainCode;
				if(readfirstmain(oldINr,1,true))then begin
					GIr.HansaCode = oldINr.Code;
					if(readfirstkey("HansaCode",GIr,1,true)==false)then begin
						CreateNewGlobalItem(oldINr);
						recordstore(oldINr,true);
					end;
					GIr.HansaCode = code;
					foundf = false;
					if(readfirstkey("HansaCode",GIr,1,true))then begin
						UpdateGlobalItem(INr);
					end else begin
						CreateNewGlobalItem(INr);
					end;
					RecordStore(INr,True);
				end;
			end;
		end;
		NextImportLine(true);
	end;
	//resetcompany(curc);
	return;
end;




Global updating procedure ImportABCINIn()
begin
	record INVc INr;
	record RebVc Rebr;
	record ITVc ITr;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,color,size;
		
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield5 = "";
		sfield6 = "";
		sfield0 = ImportField;
		if(nonblank(sfield0))then begin
			FormatUpperCaseCode(sfield0);
			sfield1 = ImportField;
			if(nonblank(sfield1))then begin
				FormatUpperCaseCode(sfield1);
				if(sfield1!="A" and sfield1!="B" and sfield1!="C" and sfield1!="E")then begin
					sfield1 = "";
				end;
			end;
			sfield2 = ImportField;
			if(nonblank(sfield2))then begin
				FormatUpperCaseCode(sfield2);
				if(sfield2!="S" and sfield2!="X" and sfield2!="Y" and sfield2!="Z")then begin
					sfield2 = "";
				end;
			end;
			sfield3 = ImportField;
			if(nonblank(sfield3))then begin
				FormatUpperCaseCode(sfield3);
				if(sfield3!="C" and sfield3!="D")then begin
					sfield3 = "";
				end;
			end;
			sfield4 = ImportField;
			sfield5 = ImportField;
			if(nonblank(sfield5))then begin
				FormatUpperCaseCode(sfield5);
				if(sfield5!="S" and sfield5!="L")then begin
					sfield5 = "";
				end;
			end;
			sfield6 = ImportField;
			//logtext(0,sfield0 & " <> " & sfield1 & " <> " & sfield2 & " <> " & sfield3 & " <> " & sfield4 & " <> " & sfield5);
			INr.Code = sfield0;
			if(ReadFirstMain(INr,1,true))then begin
				if(nonblank(sfield1))then begin
					INr.ItemCat = sfield1;
				end;
				if(nonblank(sfield2))then begin
					INr.SubItemCat = sfield2;
				end;
				if(nonblank(sfield3))then begin
					INr.TypeSeasNeeds = sfield3;
				end;
				if(nonblank(sfield4))then begin
					INr.LeadTime = sfield4;
				end;
				if(nonblank(sfield5))then begin
					INr.LifeCicle = sfield5;
				end;
				if(nonblank(sfield6))then begin
					INr.SeasonalReorderMonth = sfield6;
				end;
				recordStore(INr,True);
			end;//if RFM INr
		end;//if nonblank(sfield0)
		NextImportLine(true);
	end;
	return;
end;

















global updating procedure AddInchesMn(record RcVc RepSpec)
begin
	record INVc INr;
	longint curtick;
	
	curtick = getcurtick();
	while(loopmain(INr,1,true))begin
		INr.Unittext = "˜’";
		INr.UpdateCost = 1;
		recordStore(INr,true);
	end;
	LogProcTime("AddInchesMn",getcurtick()-curtick); 
return;
end;


global
updating procedure FillStructIn()
BEGIN
record INVc INr;
integer oldComp;
integer i,CompQty;
boolean TrHs;
string 255 code,rec;
	
	compQty = 32;
	while (TestEOF()==false) begin
		code = ImportField;
		rec = importfield;
		for (i=0;i<CompQty;i=i+1)begin
			if((!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32)then begin
				SetCompany(i+1,false);
				INr.Code = code;
				if(ReadFirstMain(INr,1,true)) then begin
					INr.Recepy = rec;
					if(RecordStore(INr,true)) then begin
						logtext(0,INr.Code & " " & INr.Recepy);
					end;
				end;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	setcompany(oldComp,false);
  RETURN;
END;

global
updating procedure ImpCLOut()
BEGIN


    RegisterImport("ITVc2");

  RETURN;
END;


global
updating procedure ImpDocVc()
BEGIN

    RegisterImport("doc3");

  RETURN;
END;




global
updating procedure INImportCostsIn()		//Edit----------------------Dima  10.02.2015
begin
  record INVc INr;
  string 70 code;
  string 15 cost;



	while (TestEOF()==false) begin
			code = ImportField;
			cost = ImportField;
	
			if(nonblank(code) and nonblank(cost)) then begin

				INr.Code = code;				
				if (ReadFirstMain(INr,1,true)) then begin
					INr.InPrice = StringToVal(cost,M4Val);
					RecordStore(INr,true);
				end;
			end;								
				
			if (NextImportLine(true)) then begin end;
	end;		

return;
end;



global
updating procedure ImportOfRegister(record RcVc RepSpec)	//Edit----------------------Dima  28.05.2015
BEGIN
string 100 tag;
boolean first;
		if(first==false)then begin
			tag = ImportField;
		end;
		
		logtext(0,"ImportOfRegister tag " & tag);
		if(first==false)then begin
			first = true;
			RegisterImport(tag);
    end;
  RETURN;
END;



global
updating procedure ImportOfRegisterRewriting(record RcVc RepSpec)	//Edit----------------------Dima  28.05.2015
BEGIN
string 100 tag;
string 50 registerVc;
	record LocClVc LocClr,oldLocClr;
	record INVc INr;
	record CLInVc CLInr;
	record CLOutVc CLOutr;
	record IPVc IPr;
	record OPVc OPr;
	record IVVc IVr;
	record VIVc VIr;
	record POVc POr;
	record SHVc SHr;
	record PUVc PUr;
	record SDVc SDr;
	record StockMovVc StockMovr;
	record RetVc Retr;
	record RetPUVc RetPUr;
	record ORVc ORr;
	record TRVc TRr;
	record FBVc FBr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record AccVc Accr;
	record DocVc Docr;
	record ObjVc Objr;
	record CLCorspVc CLCorspr;
	
	registerVc = UpperCase(RepSpec.f1);
	tag = ImportField;

	if (nonblank(registerVc))	then begin
		while (NextImportLine(false)) begin
			switch(registerVc) begin
				case "LOCCLVC": 					 	
 			  	  ImportOneRecord(LocClr,tag);
 			  	  oldLocClr.Code = LocClr.Code;
 			  	  if (ReadFirstMain(oldLocClr,1,true)) then begin  	  
							RecordUpdate(oldLocClr,LocClr,false);
						end else begin
							RecordStore(LocClr,false);
						end;
				case "DocVc": 					 	
 			  	  ImportOneRecord(Docr,tag);
 			  	  RecordStore(Docr,true);
				
				case "INVC": 					 	
 			  	  ImportOneRecord(INr,tag);
 			  	  RecordStore(INr,true);
 			  	  
				case "CLINVC": 					 	
 			  	  ImportOneRecord(CLInr,tag);
 			  	  RecordStore(CLInr,true); 
 			  	  
				case "CLOUTVC": 					 	
 			  	  ImportOneRecord(CLOutr,tag);
 			  	  RecordStore(CLOutr,true); 
 			  	  
				case "IPVC": 					 	
 			  	  ImportOneRecord(IPr,tag);
 			  	  RecordStore(IPr,true); 
 			  	  
				case "OPVC": 					 	
 			  	  ImportOneRecord(OPr,tag);
 			  	  RecordStore(OPr,true); 
 			  	  
				case "IVVC": 					 	
 			  	  ImportOneRecord(IVr,tag);
 			  	  RecordStore(IVr,true); 
 			  	  
				case "VIVC": 					 	
 			  	  ImportOneRecord(VIr,tag);
 			  	  RecordStore(VIr,true); 
 			  	  
				case "POVC": 					 	
 			  	  ImportOneRecord(POr,tag);
 			  	  RecordStore(POr,true); 
 			  	  
				case "PUVC": 					 	
 			  	  ImportOneRecord(PUr,tag);
 			  	  RecordStore(PUr,true); 
 			  	  
				case "SDVC": 					 	
 			  	  ImportOneRecord(SDr,tag);
 			  	  RecordStore(SDr,true); 
 			  	  
				case "STOCKMOVVC": 					 	
 			  	  ImportOneRecord(StockMovr,tag);
 			  	  RecordStore(StockMovr,true); 
 			  	  
				case "RETVC": 					 	
 			  	  ImportOneRecord(Retr,tag);
 			  	  RecordStore(Retr,true); 
 			  	  
				case "RETPUVC": 					 	
 			  	  ImportOneRecord(RetPUr,tag);
 			  	  RecordStore(RetPUr,true);
 			  	  
				case "ORVC": 					 	
 			  	  ImportOneRecord(ORr,tag);
 			  	  RecordStore(ORr,true);
 			  	  
				case "TRVC": 					 	
 			  	  ImportOneRecord(TRr,tag);
 			  	  RecordStore(TRr,true); 
 			  	  
				case "FBVC": 					 	
 			  	  ImportOneRecord(FBr,tag);
 			  	  RecordStore(FBr,true);
 			  	  
				case "ITEMHISTVC": 					 	
 			  	  ImportOneRecord(IHr,tag);
 			  	  RecordStore(IHr,true); 
 			  	  
				case "ITEMSTATUSVC": 					 	
 			  	  ImportOneRecord(ISr,tag);
 			  	  RecordStore(ISr,true);
 			  	  
 			  case "AccVc": 					 	
 			  	  ImportOneRecord(Accr,tag);
 			  	  RecordStore(Accr,true); 
 			  	  
 			  case "ObjVc": 					 	
 			  	  ImportOneRecord(Objr,tag);
 			  	  RecordStore(Objr,true);  	
 			  
 			  case "CLCorspVc": 					 	
 			  	  ImportOneRecord(CLCorspr,tag);
 			  	  RecordStore(CLCorspr,true);  			  	   			  	   			  	  			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	  			  	  
					
			end;
		end;	
  end;  

  RETURN;
END;


Global updating procedure ImportBarCodesIn()
begin
	record INVc INr;
	record RebVc Rebr;
	record ITVc ITr;
	integer i;
	string 255 artcode,barcode;
		
	while (TestEOF()==false) begin
		artcode = ImportField;
		barcode = ImportField;
		if(nonblank(artcode) and nonblank(barcode))then begin
			INr.Code = artcode;
			if(readfirstmain(INr,1,true))then begin
				if(nonblank(INr.BarCode) and INr.BarCode!=barcode)then begin
					INr.BarCode = barcode;
					INr.AlternativeCode = barcode;
					INr.EKNCode = barcode;
					recordstore(INr,true);
				end else begin
					if(blank(INr.BarCode) and nonblank(INr.AlternativeCode) and INr.AlternativeCode!=barcode)then begin
						INr.BarCode = barcode;
						INr.AlternativeCode = barcode;
						INr.EKNCode = barcode;
						recordstore(INr,true);
					end;
				end;
			end;
		end;
		
		NextImportLine(true);
	end;
	return;
end;

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure HandleCUClassificationIn(integer mode)
begin
  record CUVc CUr;
  record CClassVc CClassr,CClass2r;
  string 20 code;
  string 255 importedClass,importedClassForExchange,newClassList,extractedClass;
  Boolean storeF;
  Integer pos;

	while (TestEOF()==false) begin
			code = ImportField;
			importedClass = UpperCase(ImportField);
			if (mode==1) then begin
			  importedClassForExchange = UpperCase(ImportField);
			end;

			if(nonblank(code)) then begin
				CUr.Code = code;				
				if (ReadFirstMain(CUr,1,true)) then begin
					storeF = false;
					switch (mode) begin
					  case 0: //add classification
					    if (NonBlank(importedClass)) then begin
					      pos = 0;
                ExtractObj(importedClass,pos,extractedClass);
                while (nonblank(extractedClass)) begin
                  CClassr.Code = extractedClass;
                  if (ReadFirstMain(CClassr,1,true) and SetInSet(extractedClass,CUr.Classification)==false) then begin
                    if (NonBlank(CUr.Classification)) then begin
                      CUr.Classification = CUr.Classification & ",";
                    end;
                    CUr.Classification = CUr.Classification & extractedClass;
                    storeF = true;
                  end;
                  ExtractObj(importedClass,pos,extractedClass);
                end;
					    end;
					  case 1: //exchange classification
              pos = 0;
              ExtractObj(importedClass,pos,extractedClass);
              importedClass = extractedClass;
              pos = 0;
              ExtractObj(importedClassForExchange,pos,extractedClass);
              importedClassForExchange = extractedClass;
              
              newClassList = "";
              CClassr.Code = extractedClass;
              CClass2r.Code = importedClassForExchange;
              if (ReadFirstMain(CClassr,1,true) and ReadFirstMain(CClass2r,1,true)) then begin
                if (NonBlank(importedClass) and NonBlank(importedClassForExchange)) then begin
                  pos = 0;
                  ExtractObj(CUr.Classification,pos,extractedClass);
                  while (NonBlank(extractedClass)) begin
                    if (NonBlank(newClassList)) then begin
                      newClassList = newClassList & ",";
                    end;
                    if (extractedClass==importedClass) then begin
                      newClassList = newClassList & importedClassForExchange;
                    end else begin
                      newClassList = newClassList & extractedClass;
                    end;
                    ExtractObj(CUr.Classification,pos,extractedClass);
                  end; 
                  if (newClassList!=CUr.Classification) then begin
                    CUr.Classification = newClassList;
                    storeF = true;
                  end;
                end;
              end;
					  case 2: //remove classification
					    if (NonBlank(importedClass) and NonBlank(CUr.Classification)) then begin
					      pos = 0;
					      newClassList = "";
                ExtractObj(CUr.Classification,pos,extractedClass);
                while (nonblank(extractedClass)) begin
                  if (SetInSet(extractedClass,importedClass)==false) then begin
                    if (NonBlank(newClassList)) then begin
                      newClassList = newClassList & ",";
                    end;
                    newClassList = newClassList & extractedClass;
                  end;
                  ExtractObj(CUr.Classification,pos,extractedClass);
                end;
                if (newClassList!=CUr.Classification) then begin
                  CUr.Classification = newClassList;
                  storeF = true;
                end;
					    end;
					    if (Blank(importedClass) and NonBlank(CUr.Classification)) then begin //clear up CUVc classifications
					      CUr.Classification = "";
                storeF = true;
					    end;
					end;
					if (storeF) then begin
					  RecordStore(CUr,true);
					end;
				end;
			end;								
				
			if (NextImportLine(true)) then begin end;
	end;		

return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure AddCUClassificationIn(record RcVc RepSpec)
begin
  
  HandleCUClassificationIn(0);
  
return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure ChangeCUClassificationIn(record RcVc RepSpec)
begin
  
  HandleCUClassificationIn(1);
  
return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure RemoveCUClassificationIn(record RcVc RepSpec)
begin
  
  HandleCUClassificationIn(2);
  
return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }


global updating procedure ImportIDEACUIn()
begin
	record CUVc CUr;
	string 255 mfrno,mfrname,mfrnameshort;
	string 255 adres,citystate,contact;
	string 255 phone,mail,maxday,minmax;
	string 255 coef,onproj;
	record ObjVc Objr;
	record DIVc DIr;
	
	while (TestEOF()==false) begin
		mfrno = ImportField;
		mfrname = ImportField;
		mfrnameshort = ImportField;
		adres = ImportField;
		citystate = ImportField;
		contact = ImportField;
		phone = ImportField;
		mail = ImportField;
		maxday = ImportField;
		minmax = ImportField;
		coef = ImportField;
		onproj = ImportField;
		
		/*if(nonblank(mfrno))then begin
			CUr.Code = mfrno;
			if(readfirstmain(CUr,1,true))then begin
				CUr.Name = " " & CUr.Name;
				recordstore(CUr,true);
			end;
		end;*/
		
		if(nonblank(mfrno))then begin
			recordnew(CUr);
				CUr.Code = mfrno;
				CUr.VEType = 1;
				CUr.CUType = 0;
				CUr.Name = mfrname;
				if(blank(CUr.Name))then begin
					CUr.Name = "blank_name";
				end;
				CUr.Phone = phone;
				CUr.InvAddr0 = adres;
				CUr.InvAddr1 = citystate;
				CUr.InvAddr2 = contact;
				CUr.Person =contact;
				CUr.SearchKey = mfrnameshort;
				CUr.Comment = coef & "," & onproj;		
				CUr.OnAccount = 1;
				CUr.SelfBilling = 1;
				CUr.VEVATCode = "0%";
				CUr.AccAP = "60";
				CUr.AccCost = "41/01";
				CUr.OnAccAccAP = "64";
				
				Objr.Code = CUr.Code;
				if(readfirstmain(Objr,1,true)==false)then begin
					recordnew(Objr);
					Objr.Code = CUr.Code;
					Objr.Comment = CUr.Name;
					Objr.OTCode = "BRAND";
					recordstore(Objr,true);
				end;
				
				DIr.Code = CUr.Code;
				if(readfirstmain(DIr,1,true)==false)then begin
					recordnew(Objr);
					DIr.Code = CUr.Code;
					DIr.Name = CUr.Name;
					DIr.CType = "BRAND";
					recordstore(DIr,true);
				end;
			
				if(nonblank(maxday))then begin
					CUr.PlanShipDays = stringtoint(maxday);	
				end;
				if(nonblank(minmax))then begin
					CUr.PlanShipDaysMin = stringtoint(minmax);	
				end;
			recordstore(CUr,true);
		end;
		if (NextImportLine(true)) then begin end;
	end;
	
return;
end;



global updating procedure FixIDEAMn()
begin
	record CUVc CUr;
	boolean TrHs,testf;
	
	CUr.Code = "0000001";
	TrHs = true;
	while(loopmain(CUr,1,TrHs))begin
		testf = true;
		if(CUr.Code<"0000001")then begin TrHs = false; testf = false; end;
		if(CUr.Code>"0000424")then begin TrHs = false; testf = false; end;
		if(CUr.VEType==0)then begin testf = false; end;
		if(CUr.Code=="00001")then begin testf = false; end;
		
		
		if(testf)then begin
			//CUr.Name = " " & CUr.Name;
      if (left(CUr.Name,1)==" ") then begin
        CUr.Name = right(CUr.Name,len(CUr.Name)-1);
        CUr.VECat = "IDEA";
      end;
			recordstore(CUr,true);
		end;
	end;
	
	
return;
end;

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure ItemsClassificationsImportIn(record RcVc RepSpec)
begin
	record INVc INr;
	string 100 artcode,brand,collection,group,textbrand,dinameu;  
	string 100 subgrp,category,material,color,shape,size,use,sex,plating,clarity,weight,cut,stone,strap,odour;  
  record OldDIVc DIr;
  record ITVc ITr;
  vector boolean difnd;
  vector string 100 itfind,difound;
  boolean testf,tst,itemfounfd,brnotfound,zerrofl,zerrofl2,zerrofl3;
  integer i,ci,curcmp;
  array string 100 abrnd;
  integer acnt;
  record BPIBrandVc BBr;
  vector string 100 vBrandName;
  
  while(loopmain(BBr,1,true))begin
  	vBrandName[BBr.Code] = BBr.Name;
  end;
  
	curcmp = currentcompany;
	
	for(ci=1;ci<29;ci=ci+1)begin
		tst = true;
		if(ci!=3 and CompanyIsJWLikeCompany(ci))then begin
			tst = false;
		end;
		
		if(tst)then begin

			resetloop(ITr);
			ITr.Code = "";
			while(loopmain(ITr,1,true))begin
					dinameu = uppercase(ITr.Comment);
					itfind[ITr.Code] = dinameu;
			end;

			resetloop(DIr);
			DIr.Code = "";
			while(loopmain(DIr,1,true))begin
				if(DIr.CType=="BRAND")then begin
					abrnd[acnt] = DIr.Code;
					difound[DIr.Code] = uppercase(DIr.Name);
					acnt = acnt + 1;
				end;
			end;
		end;
	end;


  
  while (TestEOF()==false) begin
  	itemfounfd = false;
  	artcode = ImportField;
  	textbrand = ImportField;
  	brand = ImportField;
  	collection = ImportField;
  	group = ImportField;
  	subgrp = ImportField;
		category = ImportField;
		material = ImportField;
		color = ImportField;
		shape = ImportField;
		size = ImportField;
		use = ImportField;
		sex = ImportField;
		plating = ImportField;
		clarity = ImportField;
		weight = ImportField;
		cut = ImportField;
		stone = ImportField;
		strap = ImportField;
		odour = ImportField;
		
		for(ci=1;ci<29;ci=ci+1)begin
			tst = true;
			if(ci!=3 and CompanyIsJWLikeCompany(ci))then begin
				tst = false;
			end;
			if(ci==10)then begin
				tst = false;
			end;
			if(ci==11)then begin
				tst = false;
			end;
			if(ci==12)then begin
				tst = false;
			end;
			
			if(tst)then begin
				setcompany(ci,false);
				INr.Code = artcode;
				zerrofl = true;
				zerrofl2 = true;
				zerrofl3 = true;
	lItemsClassificationsImportIn:;
				if(readfirstmain(INr,1,true))then begin
					brnotfound = false;
					itemfounfd = false;
					testf = true;
					if(nonblank(INr.Group))then begin
						if(left(itfind[INr.Group],len(textbrand))!=textbrand)then begin
							testf = false;
						end else begin
							itemfounfd = true;
						end;
					end else begin
						for(i=0;i<acnt;i=i+1)begin
							if(setinset(abrnd[i],INr.OldDispGroups))then begin
								if(left(difound[abrnd[i]],len(textbrand))!=textbrand)then begin
									testf = false;
								end else begin
									itemfounfd = true;	
								end;
							end else begin
								brnotfound = true;
							end;
						end;
					end;
					if(currentcompany==1 and brand=="BRND0171")then begin
						testf = true;
					end;
					if(currentcompany==2 and brand=="BRND0117")then begin
						testf = true;
					end;
					if(currentcompany==4 and brand=="BRND0182")then begin
						testf = true;
					end;
					if(currentcompany==5 and brand=="BRND0153")then begin
						testf = true;
					end;
					if(currentcompany==6 and brand=="BRND0013")then begin
						testf = true;
					end;
					if(currentcompany==25 and brand=="BRND0046")then begin
						testf = true;
					end;
				
					if(blank(INr.Group) and brnotfound and testf==false)then begin
						testf = true;
					end;

					if(nonblank(INr.BPIBrand) and INr.BPIBrand==brand)then begin
						//testf = true;
					end;
					
					if(blank(INr.BPIGroup) and testf==false)then begin
						//logtext(0,currentcompany & chr(9) & INr.Code & chr(9) & INr.Group & chr(9) & vBrandName[brand]);
						/*if(INr.Group=="AL_P" and vBrandName[brand]=="ALEXANDRE TURPAULT ")then begin testf = true; end;
						if(INr.Group=="ALFI" and vBrandName[brand]=="ALFI")then begin testf = true; end;
						if(INr.Group=="AN_AC" and vBrandName[brand]=="KARE")then begin testf = true; end;
						if(INr.Group=="AN_FU" and vBrandName[brand]=="KARE")then begin testf = true; end;
						if(INr.Group=="BEKA" and vBrandName[brand]=="BEKA")then begin testf = true; end;
						if(INr.Group=="BERNP" and vBrandName[brand]=="BERNARDAUD")then begin testf = true; end;
						if(INr.Group=="BOHEM" and vBrandName[brand]=="BOHEMIA")then begin testf = true; end;
						if(INr.Group=="BR" and vBrandName[brand]=="BRABANTIA")then begin testf = true; end;
						if(INr.Group=="BR_K" and vBrandName[brand]=="BRABANTIA")then begin testf = true; end;
						if(INr.Group=="BR_LC" and vBrandName[brand]=="BRABANTIA")then begin testf = true; end;
						if(INr.Group=="BRAB" and vBrandName[brand]=="BRABANTIA")then begin testf = true; end;
						if(INr.Group=="CANDI" and vBrandName[brand]=="CANDINO")then begin testf = true; end;
						if(INr.Group=="CHR_A" and vBrandName[brand]=="CHRISTOFLE")then begin testf = true; end;
						if(INr.Group=="CHR_F" and vBrandName[brand]=="CHRISTOFLE")then begin testf = true; end;
						if(INr.Group=="CHR_P" and vBrandName[brand]=="CHRISTOFLE")then begin testf = true; end;
						if(INr.Group=="CHURC" and vBrandName[brand]=="CHURCHILL")then begin testf = true; end;
						if(INr.Group=="COG_R" and vBrandName[brand]=="COGAL")then begin testf = true; end;
						if(INr.Group=="COG_T" and vBrandName[brand]=="COGAL")then begin testf = true; end;
						if(INr.Group=="CRIST" and vBrandName[brand]=="CHRISTOFLE")then begin testf = true; end;
						if(INr.Group=="D_S_M" and vBrandName[brand]=="SVAD DONDI")then begin testf = true; end;
						if(INr.Group=="D_S_P" and vBrandName[brand]=="SVAD DONDI")then begin testf = true; end;
						if(INr.Group=="DEKOR" and vBrandName[brand]=="DEKORATIEF  ")then begin testf = true; end;
						if(INr.Group=="DG" and vBrandName[brand]=="De Grisogono")then begin testf = true; end;
						if(INr.Group=="DUPON" and vBrandName[brand]=="Dupont")then begin testf = true; end;
						if(INr.Group=="EGIZI" and vBrandName[brand]=="EGIZIA")then begin testf = true; end;
						if(INr.Group=="ESCAD" and vBrandName[brand]=="ESCADA")then begin testf = true; end;
						if(INr.Group=="F_C_T" and vBrandName[brand]=="CHRISTIAN FISCHBACHER")then begin testf = true; end;
						if(INr.Group=="FESTI" and vBrandName[brand]=="FESTINA")then begin testf = true; end;
						if(INr.Group=="FIS_M" and vBrandName[brand]=="CHRISTIAN FISCHBACHER")then begin testf = true; end;
						if(INr.Group=="FIS_P" and vBrandName[brand]=="CHRISTIAN FISCHBACHER")then begin testf = true; end;
						if(INr.Group=="FISL3" and vBrandName[brand]=="CHRISTIAN FISCHBACHER")then begin testf = true; end;
						if(INr.Group=="FISSL" and vBrandName[brand]=="FISSLER")then begin testf = true; end;*/
						
						testf = true;
						
						if(INr.Group=="AN_AC" and vBrandName[brand]=="CRABTREE&EVELYN")then begin testf = false; end;
						if(INr.Group=="AND_A" and vBrandName[brand]=="IVV")then begin testf = false; end;
						if(INr.Group=="ARCA" and vBrandName[brand]=="CRABTREE&EVELYN")then begin testf = false; end;
						if(INr.Group=="ARCA" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="BODUM" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="CHOPA" and vBrandName[brand]=="CRABTREE&EVELYN")then begin testf = false; end;
						if(INr.Group=="COLLE" and vBrandName[brand]=="RALPH LAUREN HOME")then begin testf = false; end;
						if(INr.Group=="CRA_E" and vBrandName[brand]=="IVV")then begin testf = false; end;
						if(INr.Group=="CRA_E" and vBrandName[brand]=="KARE")then begin testf = false; end;
						if(INr.Group=="CRA_E" and vBrandName[brand]=="LE JACQUARD")then begin testf = false; end;
						if(INr.Group=="CRABT" and vBrandName[brand]=="KARE")then begin testf = false; end;
						if(INr.Group=="DUPON" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="KATRI" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="LAMP" and vBrandName[brand]=="HELIOS")then begin testf = false; end;
						if(INr.Group=="LANGN" and vBrandName[brand]=="KARE")then begin testf = false; end;
						if(INr.Group=="LE_JA" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="LE_JA" and vBrandName[brand]=="KATRIN LEUZE")then begin testf = false; end;
						if(INr.Group=="LE_JA" and vBrandName[brand]=="LALIQUE")then begin testf = false; end;
						if(INr.Group=="LIGHT" and vBrandName[brand]=="LALIQUE")then begin testf = false; end;
						if(INr.Group=="LJ_FR" and vBrandName[brand]=="LALIQUE")then begin testf = false; end;
						if(INr.Group=="POINT" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="RAL_M" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="S_H_F" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="SO_KB" and vBrandName[brand]=="TRUDI")then begin testf = false; end;
						if(INr.Group=="SO_KT" and vBrandName[brand]=="TRUDI")then begin testf = false; end;
						if(INr.Group=="SOHER" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="SZ" and vBrandName[brand]=="ADLER")then begin testf = false; end;
						if(INr.Group=="VAN_R" and vBrandName[brand]=="SIA HOME")then begin testf = false; end;
						if(INr.Group=="VAN_R" and vBrandName[brand]=="YVES DELORME")then begin testf = false; end;
						if(INr.Group=="Y_DEL" and vBrandName[brand]=="CRABTREE&EVELYN")then begin testf = false; end;
						if(INr.Group=="Y_DEL" and vBrandName[brand]=="DINH VAN")then begin testf = false; end;
						if(INr.Group=="YDM" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="YDP" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="YDP" and vBrandName[brand]=="SWAROVSKI")then begin testf = false; end;
						
						if(testf==false)then begin
							logtext(0,currentcompany & chr(9) & INr.Code & chr(9) & INr.Group & chr(9) & vBrandName[brand]);
						end;
					end;	
					if(testf)then begin
						INr.BPIBrand = brand;
						INr.BPICollection = collection;
						INr.BPIGroup = group;
						INr.BPISubGroup = subgrp;
						INr.BPICategory = category;
						INr.BPIMaterial = material;
						INr.BPIColor = color;
						INr.BPIShape = shape;
						INr.BPISize = size;
						INr.BPIUse = use;
						INr.BPISex = sex;
						INr.BPIPlating = plating;
						INr.BPIClarity = clarity;
						INr.BPIWeight = weight;
						INr.BPICut = cut;
						INr.BPIStone = stone;
						INr.BPIStrap = strap;
						INr.BPIOdour = odour;
						recordstore(INr,true);
					end;
				end else begin
					/*if(zerrofl)then begin
						INr.Code = "0" & artcode;
						zerrofl = false;
						goto lItemsClassificationsImportIn;
					end;
					if(zerrofl2)then begin
						INr.Code = "00" & artcode;
						zerrofl2 = false;
						goto lItemsClassificationsImportIn;
					end;
					if(zerrofl3)then begin
						INr.Code = "000" & artcode;
						zerrofl3 = false;
						goto lItemsClassificationsImportIn;
					end;*/
				end;
			end;
		
		end;
  	if (NextImportLine(true)) then begin end;
	end;
	resetcompany(curcmp);	
  
return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }


global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure ImportSuppELevelIn(record RcVc RepSpec)
begin
	record CUVc CUr;
	string 100 cucode,elevel,deltype,supptype,prodtime;
	
	while (TestEOF()==false) begin
		
		cucode = ImportField;
		elevel = ImportField;
		deltype = ImportField;
		supptype = ImportField;
		prodtime = ImportField;
		
		if(nonblank(cucode))then begin
			CUr.Code = cucode;
			if(readfirstmain(CUr,1,true))then begin
				if(nonblank(elevel))then begin
					CUr.ELevel = evaltoval(elevel);
				end;
				if(nonblank(deltype))then begin
					CUr.DeliveryWay = stringtoint(deltype);
				end;
				if(nonblank(supptype))then begin
					CUr.DeliveryFrom = stringtoint(supptype);
				end;
				if(nonblank(prodtime))then begin
					CUr.PlanShipDaysMin = stringtoint(prodtime);
				end;
				recordstore(CUr,true);
			end;
		end;
		
		if (NextImportLine(true)) then begin end;
	end;
	
return;
end;





global 	//Edit_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-Anton 13:08 30.04.2019
updating procedure ImportRUSClassVcIn(record RcVc RepSpec)
begin
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	string 100 code,name,rname;
	
	while (TestEOF()==false) begin
		
		code = ImportField;
		name = ImportField;
		rname = "";
		if(nonblank(code))then begin
			BTRxBrandr.Code = code;
			if(readfirstmain(BTRxBrandr,1,true))then begin
				if(nonblank(BTRxBrandr.Name))then begin
					BTRxBrandr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxBrandr,true);
			end;
			BTRxBrandr.Name = code;
			if(readfirstKey("Name",BTRxBrandr,1,true))then begin
				if(nonblank(BTRxBrandr.Name))then begin
					BTRxBrandr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxBrandr,true);
			end;
			BTRxMaterialr.Code = code;
			if(readfirstmain(BTRxMaterialr,1,true))then begin
				if(nonblank(BTRxMaterialr.Name))then begin
					BTRxMaterialr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxMaterialr,true);
			end;
			BTRxMaterialr.Name = code;
			if(readfirstKey("Name",BTRxMaterialr,1,true))then begin
				if(nonblank(BTRxMaterialr.Name))then begin
					BTRxMaterialr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxMaterialr,true);
			end;
			BTRxColorr.Code = code;
			if(readfirstmain(BTRxColorr,1,true))then begin
				if(nonblank(BTRxColorr.Name))then begin
					BTRxColorr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxColorr,true);
			end;
			BTRxColorr.Name = code;
			if(readfirstKey("Name",BTRxColorr,1,true))then begin
				if(nonblank(BTRxColorr.Name))then begin
					BTRxColorr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxColorr,true);
			end;
			BTRxSizer.Code = code;
			if(readfirstmain(BTRxSizer,1,true))then begin
				if(nonblank(BTRxSizer.Name))then begin
					BTRxSizer.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxSizer,true);
			end;
			BTRxSizer.Name = code;
			if(readfirstKey("Name",BTRxSizer,1,true))then begin
				if(nonblank(BTRxSizer.Name))then begin
					BTRxSizer.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxSizer,true);
			end;
			BTRxSexr.Code = code;
			if(readfirstmain(BTRxSexr,1,true))then begin
				if(nonblank(BTRxSexr.Name))then begin
					BTRxSexr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxSexr,true);
			end;
			BTRxSexr.Name = code;
			if(readfirstKey("Name",BTRxSexr,1,true))then begin
				if(nonblank(BTRxSexr.Name))then begin
					BTRxSexr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxSexr,true);
			end;
			BTRxPlatingr.Code = code;
			if(readfirstmain(BTRxPlatingr,1,true))then begin
				if(nonblank(BTRxPlatingr.Name))then begin
					BTRxPlatingr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxPlatingr,true);
			end;
			BTRxPlatingr.Name = code;
			if(readfirstKey("Name",BTRxPlatingr,1,true))then begin
				if(nonblank(BTRxPlatingr.Name))then begin
					BTRxPlatingr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxPlatingr,true);
			end;
			BTRxStoner.Code = code;
			if(readfirstmain(BTRxStoner,1,true))then begin
				if(nonblank(BTRxStoner.Name))then begin
					BTRxStoner.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxStoner,true);
			end;
			BTRxStoner.Name = code;
			if(readfirstKey("Name",BTRxStoner,1,true))then begin
				if(nonblank(BTRxStoner.Name))then begin
					BTRxStoner.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxStoner,true);
			end;
			BTRxStrapr.Code = code;
			if(readfirstmain(BTRxStrapr,1,true))then begin
				if(nonblank(BTRxStrapr.Name))then begin
					BTRxStrapr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxStrapr,true);
			end;
			BTRxStrapr.Name = code;
			if(readfirstKey("Name",BTRxStrapr,1,true))then begin
				if(nonblank(BTRxStrapr.Name))then begin
					BTRxStrapr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxStrapr,true);
			end;
			BtrxWatResr.Code = code;
			if(readfirstmain(BtrxWatResr,1,true))then begin
				if(nonblank(BtrxWatResr.Name))then begin
					BtrxWatResr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxWatResr,true);
			end;
			BtrxWatResr.Name = code;
			if(readfirstKey("Name",BtrxWatResr,1,true))then begin
				if(nonblank(BtrxWatResr.Name))then begin
					BtrxWatResr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxWatResr,true);
			end;
			BtrxTyper.Code = code;
			if(readfirstmain(BtrxTyper,1,true))then begin
				if(nonblank(BtrxTyper.Name))then begin
					BtrxTyper.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxTyper,true);
			end;
			BtrxTyper.Name = code;
			if(readfirstKey("Name",BtrxTyper,1,true))then begin
				if(nonblank(BtrxTyper.Name))then begin
					BtrxTyper.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxTyper,true);
			end;
			BtrxFillingr.Code = code;
			if(readfirstmain(BtrxFillingr,1,true))then begin
				if(nonblank(BtrxFillingr.Name))then begin
					BtrxFillingr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxFillingr,true);
			end;
			BtrxFillingr.Name = code;
			if(readfirstKey("Name",BtrxFillingr,1,true))then begin
				if(nonblank(BtrxFillingr.Name))then begin
					BtrxFillingr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxFillingr,true);
			end;
			BtrxPhoneModelr.Code = code;
			if(readfirstmain(BtrxPhoneModelr,1,true))then begin
				if(nonblank(BtrxPhoneModelr.Name))then begin
					BtrxPhoneModelr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxPhoneModelr,true);
			end;
			BtrxPhoneModelr.Name = code;
			if(readfirstKey("Name",BtrxPhoneModelr,1,true))then begin
				if(nonblank(BtrxPhoneModelr.Name))then begin
					BtrxPhoneModelr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxPhoneModelr,true);
			end;
			BtrxWatchGrader.Code = code;
			if(readfirstmain(BtrxWatchGrader,1,true))then begin
				if(nonblank(BtrxWatchGrader.Name))then begin
					BtrxWatchGrader.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxWatchGrader,true);
			end;
			BtrxWatchGrader.Name = code;
			if(readfirstKey("Name",BtrxWatchGrader,1,true))then begin
				if(nonblank(BtrxWatchGrader.Name))then begin
					BtrxWatchGrader.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxWatchGrader,true);
			end;
			BtrxPowerReserver.Code = code;
			if(readfirstmain(BtrxPowerReserver,1,true))then begin
				if(nonblank(BtrxPowerReserver.Name))then begin
					BtrxPowerReserver.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxPowerReserver,true);
			end;
			BtrxPowerReserver.Name = code;
			if(readfirstKey("Name",BtrxPowerReserver,1,true))then begin
				if(nonblank(BtrxPowerReserver.Name))then begin
					BtrxPowerReserver.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxPowerReserver,true);
			end;
			BtrxWatchMechanr.Code = code;
			if(readfirstmain(BtrxWatchMechanr,1,true))then begin
				if(nonblank(BtrxWatchMechanr.Name))then begin
					BtrxWatchMechanr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxWatchMechanr,true);
			end;
			BtrxWatchMechanr.Name = code;
			if(readfirstKey("Name",BtrxWatchMechanr,1,true))then begin
				if(nonblank(BtrxWatchMechanr.Name))then begin
					BtrxWatchMechanr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxWatchMechanr,true);
			end;
			BtrxCertificater.Code = code;
			if(readfirstmain(BtrxCertificater,1,true))then begin
				if(nonblank(BtrxCertificater.Name))then begin
					BtrxCertificater.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxCertificater,true);
			end;
			BtrxCertificater.Name = code;
			if(readfirstKey("Name",BtrxCertificater,1,true))then begin
				if(nonblank(BtrxCertificater.Name))then begin
					BtrxCertificater.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxCertificater,true);
			end;
			BtrxThirdLevelCatr.Code = code;
			if(readfirstmain(BtrxThirdLevelCatr,1,true))then begin
				if(nonblank(BtrxThirdLevelCatr.Name))then begin
					BtrxThirdLevelCatr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxThirdLevelCatr,true);
			end;
			BtrxThirdLevelCatr.Name = code;
			if(readfirstKey("Name",BtrxThirdLevelCatr,1,true))then begin
				if(nonblank(BtrxThirdLevelCatr.Name))then begin
					BtrxThirdLevelCatr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxThirdLevelCatr,true);
			end;
			BtrxSecondLevelCatr.Code = code;
			if(readfirstmain(BtrxSecondLevelCatr,1,true))then begin
				if(nonblank(BtrxSecondLevelCatr.Name))then begin
					BtrxSecondLevelCatr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxSecondLevelCatr,true);
			end;
			BtrxSecondLevelCatr.Name = code;
			if(readfirstKey("Name",BtrxSecondLevelCatr,1,true))then begin
				if(nonblank(BtrxSecondLevelCatr.Name))then begin
					BtrxSecondLevelCatr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxSecondLevelCatr,true);
			end;
			BtrxFirstLevelCatr.Code = code;
			if(readfirstmain(BtrxFirstLevelCatr,1,true))then begin
				if(nonblank(BtrxFirstLevelCatr.Name))then begin
					BtrxFirstLevelCatr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxFirstLevelCatr,true);
			end;
			BtrxFirstLevelCatr.Name = code;
			if(readfirstKey("Name",BtrxFirstLevelCatr,1,true))then begin
				if(nonblank(BtrxFirstLevelCatr.Name))then begin
					BtrxFirstLevelCatr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxFirstLevelCatr,true);
			end;
			BtrxInternalCatr.Code = code;
			if(readfirstmain(BtrxInternalCatr,1,true))then begin
				if(nonblank(BtrxInternalCatr.Name))then begin
					BtrxInternalCatr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxInternalCatr,true);
			end;
			BtrxInternalCatr.Name = code;
			if(readfirstKey("Name",BtrxInternalCatr,1,true))then begin
				if(nonblank(BtrxInternalCatr.Name))then begin
					BtrxInternalCatr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BtrxInternalCatr,true);
			end;
			BTRxOdourr.Code = code;
			if(readfirstmain(BTRxOdourr,1,true))then begin
				if(nonblank(BTRxOdourr.Name))then begin
					BTRxOdourr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxOdourr,true);
			end;
			BTRxOdourr.Name = code;
			if(readfirstKey("Name",BTRxOdourr,1,true))then begin
				if(nonblank(BTRxOdourr.Name))then begin
					BTRxOdourr.NameRUS = name;
					//rname = "";
				end;
				recordstore(BTRxOdourr,true);
			end;
		end;
		rname = "";
		if (NextImportLine(true)) then begin end;
	end;
return;
end;




global 	 // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 10:30 27.08.2019
updating procedure ImportfillOrigItemCodeIn(record RcVc RepSpec)
begin
	record INVc INr;
	string 255 OrCode, INCode;

	while (TestEOF()==false) begin
		INCode = 0;
		OrCode = 0;
	
		INCode = ImportField;
		OrCode = ImportField;
		
		INr.Code = INCode;
		if (ReadFirstMain(INr,1,true)) then begin
			INr.OrigCode = OrCode;
			RecordStore(INr,true);
		end;
		
		INr.AlternativeCode = INCode;
		if (ReadFirstKey("AlternativeCode",INr,1,true)) then begin
			INr.OrigCode = OrCode;
			RecordStore(INr,true);
		end;
		
		
		if (NextImportLine(true)) then begin end;
	end;
return;
end;


global 	//Edit_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-Anton 13:08 30.04.2019
updating procedure ImportAZClassVcIn(record RcVc RepSpec)
begin
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	string 100 code,name,rname;
	
	while (TestEOF()==false) begin
		
		code = ImportField;
		name = ImportField;
		logtext(0,code);
		rname = "";
		if(nonblank(code))then begin
			BTRxBrandr.Code = code;
			if(readfirstmain(BTRxBrandr,1,true))then begin
				if(nonblank(BTRxBrandr.Name))then begin
					BTRxBrandr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxBrandr,true);
			end;
			BTRxBrandr.Name = code;
			if(readfirstKey("Name",BTRxBrandr,1,true))then begin
				if(nonblank(BTRxBrandr.Name))then begin
					BTRxBrandr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxBrandr,true);
			end;
			BTRxMaterialr.Code = code;
			if(readfirstmain(BTRxMaterialr,1,true))then begin
				if(nonblank(BTRxMaterialr.Name))then begin
					BTRxMaterialr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxMaterialr,true);
			end;
			BTRxMaterialr.Name = code;
			if(readfirstKey("Name",BTRxMaterialr,1,true))then begin
				if(nonblank(BTRxMaterialr.Name))then begin
					BTRxMaterialr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxMaterialr,true);
			end;
			BTRxColorr.Code = code;
			if(readfirstmain(BTRxColorr,1,true))then begin
				if(nonblank(BTRxColorr.Name))then begin
					BTRxColorr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxColorr,true);
			end;
			BTRxColorr.Name = code;
			if(readfirstKey("Name",BTRxColorr,1,true))then begin
				if(nonblank(BTRxColorr.Name))then begin
					BTRxColorr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxColorr,true);
			end;
			BTRxSizer.Code = code;
			if(readfirstmain(BTRxSizer,1,true))then begin
				if(nonblank(BTRxSizer.Name))then begin
					BTRxSizer.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxSizer,true);
			end;
			BTRxSizer.Name = code;
			if(readfirstKey("Name",BTRxSizer,1,true))then begin
				if(nonblank(BTRxSizer.Name))then begin
					BTRxSizer.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxSizer,true);
			end;
			BTRxSexr.Code = code;
			if(readfirstmain(BTRxSexr,1,true))then begin
				if(nonblank(BTRxSexr.Name))then begin
					BTRxSexr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxSexr,true);
			end;
			BTRxSexr.Name = code;
			if(readfirstKey("Name",BTRxSexr,1,true))then begin
				if(nonblank(BTRxSexr.Name))then begin
					BTRxSexr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxSexr,true);
			end;
			BTRxPlatingr.Code = code;
			if(readfirstmain(BTRxPlatingr,1,true))then begin
				if(nonblank(BTRxPlatingr.Name))then begin
					BTRxPlatingr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxPlatingr,true);
			end;
			BTRxPlatingr.Name = code;
			if(readfirstKey("Name",BTRxPlatingr,1,true))then begin
				if(nonblank(BTRxPlatingr.Name))then begin
					BTRxPlatingr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxPlatingr,true);
			end;
			BTRxStoner.Code = code;
			if(readfirstmain(BTRxStoner,1,true))then begin
				if(nonblank(BTRxStoner.Name))then begin
					BTRxStoner.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxStoner,true);
			end;
			BTRxStoner.Name = code;
			if(readfirstKey("Name",BTRxStoner,1,true))then begin
				if(nonblank(BTRxStoner.Name))then begin
					BTRxStoner.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxStoner,true);
			end;
			BTRxStrapr.Code = code;
			if(readfirstmain(BTRxStrapr,1,true))then begin
				if(nonblank(BTRxStrapr.Name))then begin
					BTRxStrapr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxStrapr,true);
			end;
			BTRxStrapr.Name = code;
			if(readfirstKey("Name",BTRxStrapr,1,true))then begin
				if(nonblank(BTRxStrapr.Name))then begin
					BTRxStrapr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxStrapr,true);
			end;
			BtrxWatResr.Code = code;
			if(readfirstmain(BtrxWatResr,1,true))then begin
				if(nonblank(BtrxWatResr.Name))then begin
					BtrxWatResr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxWatResr,true);
			end;
			BtrxWatResr.Name = code;
			if(readfirstKey("Name",BtrxWatResr,1,true))then begin
				if(nonblank(BtrxWatResr.Name))then begin
					BtrxWatResr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxWatResr,true);
			end;
			BtrxTyper.Code = code;
			if(readfirstmain(BtrxTyper,1,true))then begin
				if(nonblank(BtrxTyper.Name))then begin
					BtrxTyper.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxTyper,true);
			end;
			BtrxTyper.Name = code;
			if(readfirstKey("Name",BtrxTyper,1,true))then begin
				if(nonblank(BtrxTyper.Name))then begin
					BtrxTyper.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxTyper,true);
			end;
			BtrxFillingr.Code = code;
			if(readfirstmain(BtrxFillingr,1,true))then begin
				if(nonblank(BtrxFillingr.Name))then begin
					BtrxFillingr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxFillingr,true);
			end;
			BtrxFillingr.Name = code;
			if(readfirstKey("Name",BtrxFillingr,1,true))then begin
				if(nonblank(BtrxFillingr.Name))then begin
					BtrxFillingr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxFillingr,true);
			end;
			BtrxPhoneModelr.Code = code;
			if(readfirstmain(BtrxPhoneModelr,1,true))then begin
				if(nonblank(BtrxPhoneModelr.Name))then begin
					BtrxPhoneModelr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxPhoneModelr,true);
			end;
			BtrxPhoneModelr.Name = code;
			if(readfirstKey("Name",BtrxPhoneModelr,1,true))then begin
				if(nonblank(BtrxPhoneModelr.Name))then begin
					BtrxPhoneModelr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxPhoneModelr,true);
			end;
			BtrxWatchGrader.Code = code;
			if(readfirstmain(BtrxWatchGrader,1,true))then begin
				if(nonblank(BtrxWatchGrader.Name))then begin
					BtrxWatchGrader.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxWatchGrader,true);
			end;
			BtrxWatchGrader.Name = code;
			if(readfirstKey("Name",BtrxWatchGrader,1,true))then begin
				if(nonblank(BtrxWatchGrader.Name))then begin
					BtrxWatchGrader.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxWatchGrader,true);
			end;
			BtrxPowerReserver.Code = code;
			if(readfirstmain(BtrxPowerReserver,1,true))then begin
				if(nonblank(BtrxPowerReserver.Name))then begin
					BtrxPowerReserver.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxPowerReserver,true);
			end;
			BtrxPowerReserver.Name = code;
			if(readfirstKey("Name",BtrxPowerReserver,1,true))then begin
				if(nonblank(BtrxPowerReserver.Name))then begin
					BtrxPowerReserver.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxPowerReserver,true);
			end;
			BtrxWatchMechanr.Code = code;
			if(readfirstmain(BtrxWatchMechanr,1,true))then begin
				if(nonblank(BtrxWatchMechanr.Name))then begin
					BtrxWatchMechanr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxWatchMechanr,true);
			end;
			BtrxWatchMechanr.Name = code;
			if(readfirstKey("Name",BtrxWatchMechanr,1,true))then begin
				if(nonblank(BtrxWatchMechanr.Name))then begin
					BtrxWatchMechanr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxWatchMechanr,true);
			end;
			BtrxCertificater.Code = code;
			if(readfirstmain(BtrxCertificater,1,true))then begin
				if(nonblank(BtrxCertificater.Name))then begin
					BtrxCertificater.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxCertificater,true);
			end;
			BtrxCertificater.Name = code;
			if(readfirstKey("Name",BtrxCertificater,1,true))then begin
				if(nonblank(BtrxCertificater.Name))then begin
					BtrxCertificater.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxCertificater,true);
			end;
			BtrxThirdLevelCatr.Code = code;
			if(readfirstmain(BtrxThirdLevelCatr,1,true))then begin
				if(nonblank(BtrxThirdLevelCatr.Name))then begin
					BtrxThirdLevelCatr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxThirdLevelCatr,true);
			end;
			BtrxThirdLevelCatr.Name = code;
			if(readfirstKey("Name",BtrxThirdLevelCatr,1,true))then begin
				if(nonblank(BtrxThirdLevelCatr.Name))then begin
					BtrxThirdLevelCatr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxThirdLevelCatr,true);
			end;
			BtrxSecondLevelCatr.Code = code;
			if(readfirstmain(BtrxSecondLevelCatr,1,true))then begin
				if(nonblank(BtrxSecondLevelCatr.Name))then begin
					BtrxSecondLevelCatr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxSecondLevelCatr,true);
			end;
			BtrxSecondLevelCatr.Name = code;
			if(readfirstKey("Name",BtrxSecondLevelCatr,1,true))then begin
				if(nonblank(BtrxSecondLevelCatr.Name))then begin
					BtrxSecondLevelCatr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxSecondLevelCatr,true);
			end;
			BtrxFirstLevelCatr.Code = code;
			if(readfirstmain(BtrxFirstLevelCatr,1,true))then begin
				if(nonblank(BtrxFirstLevelCatr.Name))then begin
					BtrxFirstLevelCatr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxFirstLevelCatr,true);
			end;
			BtrxFirstLevelCatr.Name = code;
			if(readfirstKey("Name",BtrxFirstLevelCatr,1,true))then begin
				if(nonblank(BtrxFirstLevelCatr.Name))then begin
					BtrxFirstLevelCatr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxFirstLevelCatr,true);
			end;
			BtrxInternalCatr.Code = code;
			if(readfirstmain(BtrxInternalCatr,1,true))then begin
				if(nonblank(BtrxInternalCatr.Name))then begin
					BtrxInternalCatr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxInternalCatr,true);
			end;
			BtrxInternalCatr.Name = code;
			if(readfirstKey("Name",BtrxInternalCatr,1,true))then begin
				if(nonblank(BtrxInternalCatr.Name))then begin
					BtrxInternalCatr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BtrxInternalCatr,true);
			end;
			BTRxOdourr.Code = code;
			if(readfirstmain(BTRxOdourr,1,true))then begin
				if(nonblank(BTRxOdourr.Name))then begin
					BTRxOdourr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxOdourr,true);
			end;
			BTRxOdourr.Name = code;
			if(readfirstKey("Name",BTRxOdourr,1,true))then begin
				if(nonblank(BTRxOdourr.Name))then begin
					BTRxOdourr.NameAZ = name;
					//rname = "";
				end;
				recordstore(BTRxOdourr,true);
			end;
		end;
		rname = "";
		if (NextImportLine(true)) then begin end;
	end;
return;
end;








global 	//Edit_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-Anton 13:08 30.04.2019
updating procedure ImportReRUSClassVcIn(record RcVc RepSpec)
begin
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	string 100 code,name,rname;
	
	while (TestEOF()==false) begin
		
		code = ImportField;
		name = ImportField;
		rname = "";
		if(nonblank(code))then begin
			BTRxBrandr.Code = code;
			if(readfirstmain(BTRxBrandr,1,true))then begin
				if(nonblank(BTRxBrandr.Name))then begin
					rname = BTRxBrandr.Name;
					BTRxBrandr.Name = name;
					BTRxBrandr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxBrandr,true);
			end;
			BTRxMaterialr.Code = code;
			if(readfirstmain(BTRxMaterialr,1,true))then begin
				if(nonblank(BTRxMaterialr.Name))then begin
					rname = BTRxMaterialr.Name;
					BTRxMaterialr.Name = name;
					BTRxMaterialr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxMaterialr,true);
			end;
			BTRxColorr.Code = code;
			if(readfirstmain(BTRxColorr,1,true))then begin
				if(nonblank(BTRxColorr.Name))then begin
					rname = BTRxColorr.Name;
					BTRxColorr.Name = name;
					BTRxColorr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxColorr,true);
			end;
			BTRxSizer.Code = code;
			if(readfirstmain(BTRxSizer,1,true))then begin
				if(nonblank(BTRxSizer.Name))then begin
					rname = BTRxSizer.Name;
					BTRxSizer.Name = name;
					BTRxSizer.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxSizer,true);
			end;
			BTRxSexr.Code = code;
			if(readfirstmain(BTRxSexr,1,true))then begin
				if(nonblank(BTRxSexr.Name))then begin
					rname = BTRxSexr.Name;
					BTRxSexr.Name = name;
					BTRxSexr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxSexr,true);
			end;
			BTRxPlatingr.Code = code;
			if(readfirstmain(BTRxPlatingr,1,true))then begin
				if(nonblank(BTRxPlatingr.Name))then begin
					rname = BTRxPlatingr.Name;
					BTRxPlatingr.Name = name;
					BTRxPlatingr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxPlatingr,true);
			end;
			BTRxStoner.Code = code;
			if(readfirstmain(BTRxStoner,1,true))then begin
				if(nonblank(BTRxStoner.Name))then begin
					rname = BTRxStoner.Name;
					BTRxStoner.Name = name;
					BTRxStoner.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxStoner,true);
			end;
			BTRxStrapr.Code = code;
			if(readfirstmain(BTRxStrapr,1,true))then begin
				if(nonblank(BTRxStrapr.Name))then begin
					rname = BTRxStrapr.Name;
					BTRxStrapr.Name = name;
					BTRxStrapr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxStrapr,true);
			end;
			BtrxWatResr.Code = code;
			if(readfirstmain(BtrxWatResr,1,true))then begin
				if(nonblank(BtrxWatResr.Name))then begin
					rname = BtrxWatResr.Name;
					BtrxWatResr.Name = name;
					BtrxWatResr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxWatResr,true);
			end;
			BtrxTyper.Code = code;
			if(readfirstmain(BtrxTyper,1,true))then begin
				if(nonblank(BtrxTyper.Name))then begin
					rname = BtrxTyper.Name;
					BtrxTyper.Name = name;
					BtrxTyper.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxTyper,true);
			end;
			BtrxFillingr.Code = code;
			if(readfirstmain(BtrxFillingr,1,true))then begin
				if(nonblank(BtrxFillingr.Name))then begin
					rname = BtrxFillingr.Name;
					BtrxFillingr.Name = name;
					BtrxFillingr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxFillingr,true);
			end;
			BtrxPhoneModelr.Code = code;
			if(readfirstmain(BtrxPhoneModelr,1,true))then begin
				if(nonblank(BtrxPhoneModelr.Name))then begin
					rname = BtrxPhoneModelr.Name;
					BtrxPhoneModelr.Name = name;
					BtrxPhoneModelr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxPhoneModelr,true);
			end;
			BtrxWatchGrader.Code = code;
			if(readfirstmain(BtrxWatchGrader,1,true))then begin
				if(nonblank(BtrxWatchGrader.Name))then begin
					rname = BtrxWatchGrader.Name;
					BtrxWatchGrader.Name = name;
					BtrxWatchGrader.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxWatchGrader,true);
			end;
			BtrxPowerReserver.Code = code;
			if(readfirstmain(BtrxPowerReserver,1,true))then begin
				if(nonblank(BtrxPowerReserver.Name))then begin
					rname = BtrxPowerReserver.Name;
					BtrxPowerReserver.Name = name;
					BtrxPowerReserver.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxPowerReserver,true);
			end;
			BtrxWatchMechanr.Code = code;
			if(readfirstmain(BtrxWatchMechanr,1,true))then begin
				if(nonblank(BtrxWatchMechanr.Name))then begin
					rname = BtrxWatchMechanr.Name;
					BtrxWatchMechanr.Name = name;
					BtrxWatchMechanr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxWatchMechanr,true);
			end;
			BtrxCertificater.Code = code;
			if(readfirstmain(BtrxCertificater,1,true))then begin
				if(nonblank(BtrxCertificater.Name))then begin
					rname = BtrxCertificater.Name;
					BtrxCertificater.Name = name;
					BtrxCertificater.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxCertificater,true);
			end;
			BtrxThirdLevelCatr.Code = code;
			if(readfirstmain(BtrxThirdLevelCatr,1,true))then begin
				if(nonblank(BtrxThirdLevelCatr.Name))then begin
					rname = BtrxThirdLevelCatr.Name;
					BtrxThirdLevelCatr.Name = name;
					BtrxThirdLevelCatr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxThirdLevelCatr,true);
			end;
			BtrxSecondLevelCatr.Code = code;
			if(readfirstmain(BtrxSecondLevelCatr,1,true))then begin
				if(nonblank(BtrxSecondLevelCatr.Name))then begin
					rname = BtrxSecondLevelCatr.Name;
					BtrxSecondLevelCatr.Name = name;
					BtrxSecondLevelCatr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxSecondLevelCatr,true);
			end;
			BtrxFirstLevelCatr.Code = code;
			if(readfirstmain(BtrxFirstLevelCatr,1,true))then begin
				if(nonblank(BtrxFirstLevelCatr.Name))then begin
					rname = BtrxFirstLevelCatr.Name;
					BtrxFirstLevelCatr.Name = name;
					BtrxFirstLevelCatr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxFirstLevelCatr,true);
			end;
			BtrxInternalCatr.Code = code;
			if(readfirstmain(BtrxInternalCatr,1,true))then begin
				if(nonblank(BtrxInternalCatr.Name))then begin
					rname = BtrxInternalCatr.Name;
					BtrxInternalCatr.Name = name;
					BtrxInternalCatr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BtrxInternalCatr,true);
			end;
			BTRxOdourr.Code = code;
			if(readfirstmain(BTRxOdourr,1,true))then begin
				if(nonblank(BTRxOdourr.Name))then begin
					rname = BTRxOdourr.Name;
					BTRxOdourr.Name = name;
					BTRxOdourr.NameRUS = rname;
					rname = "";
				end;
				recordstore(BTRxOdourr,true);
			end;
		end;
		rname = "";
		if (NextImportLine(true)) then begin end;
	end;
return;
end;






global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure BMIn(record RcVc RepSpec)
begin
	record BPIBrandVc BBr;
	integer i;
	string 200 code,mng;
	i = 0;
	while (TestEOF()==false) begin
		code = ImportField;
		mng = ImportField;
		i = i+1;
		logtext(0,i);
		BBr.Code = code;
		if(ReadFirstMain(BBr,1,true)) then begin
			logtext(0,i);
			BBr.BrndMngr = mng;
			RecordStore(BBr,true);
		end;	
		if (NextImportLine(true)) then begin end;
	end;
	
return;
end;

global updating procedure ImportGroupsNewIn()
begin
	boolean floine,snrfnd;
	integer i,cnt;
	array string 100 group,subgrp;
	string 255 tmp;
	record NewClassSetVc NCSr;
	row NewClassSetVc NCSrw;
	record BPIBrandVc BPIBrandr;
	record BPICollectionVc BPICollectionr;
	record BPIGroupVc BPIGroupr;
	record BPISubGroupVc BPISubGroupr;
	record BPICategoryVc BPICategoryr;
	record BPIMaterialVc BPIMaterialr;
	record BPIColorVc BPIColorr;
	record BPIShapeVc BPIShaper;
	record BPISizeVc BPISizer;
	record BPIUseVc BPIUser;
	record BPISexVc BPISexr;
	record BPIPlatingVc BPIPlatingr;
	record BPIClarityVc BPIClarityr;
	record BPIWeightVc BPIWeightr;
	record BPICutVc BPICutr;
	record BPIStoneVc BPIStoner;
	record BPIStrapVc BPIStrapr;
	record BPIOdourVc BPIOdourr;
	vector string 100 vgroup,vsubgroup,vCategory,vMaterial,vColor,vShape,vSize,vUse,vSex,vPlating,vClarity,vWeight,vCut,vStone,vStrap,vOdour;
	integer catcnt,j;
	vector string 100 vcat;
	
	while(loopmain(BPICategoryr,1,true))begin
		vCategory[BPICategoryr.Name] = BPICategoryr.Code;
	end;
	
	while(loopmain(BPIMaterialr,1,true))begin
		vMaterial[BPIMaterialr.Name] = BPIMaterialr.Code;
	end;
	
	while(loopmain(BPIColorr,1,true))begin
		vColor[BPIColorr.Name] = BPIColorr.Code;
	end;
	
	while(loopmain(BPISizer,1,true))begin
		vSize[BPISizer.Name] = BPISizer.Code;
	end;
	
	while(loopmain(BPIShaper,1,true))begin
		vShape[BPIShaper.Name] = BPIShaper.Code;
	end;
	
	while(loopmain(BPIUser,1,true))begin
		vUse[BPIUser.Name] = BPIUser.Code;
	end;
	
	while(loopmain(BPISexr,1,true))begin
		vSex[BPISexr.Name] = BPISexr.Code;
	end;
	
	while(loopmain(BPIPlatingr,1,true))begin
		vPlating[BPIPlatingr.Name] = BPIPlatingr.Code;
	end;
	
	while(loopmain(BPIClarityr,1,true))begin
		vClarity[BPIClarityr.Name] = BPIClarityr.Code;
	end;
	
	while(loopmain(BPIWeightr,1,true))begin
		vWeight[BPIWeightr.Name] = BPIWeightr.Code;
	end;
	
	while(loopmain(BPICutr,1,true))begin
		vCut[BPICutr.Name] = BPICutr.Code;
	end;
	
	while(loopmain(BPIStoner,1,true))begin
		vStone[BPIStoner.Name] = BPIStoner.Code;
	end;
	
	while(loopmain(BPIStrapr,1,true))begin
		vStrap[BPIStrapr.Name] = BPIStrapr.Code;
	end;
	
	while(loopmain(BPIOdourr,1,true))begin
		vOdour[BPIOdourr.Name] = BPIOdourr.Code;
	end;
	
	
	
	while(loopmain(BPIGroupr,1,true))begin
		vgroup[BPIGroupr.Name] = BPIGroupr.Code;
	end;
	while(loopmain(BPISubGroupr,1,true))begin
		vsubgroup[BPISubGroupr.Name] = BPISubGroupr.Code;
	end;
	
	
	while(loopmain(NCSr,1,true))begin
		recorddelete(NCSr);
		stepback(NCSr);
	end;
	
	floine = false;
	while (TestEOF()==false) begin
		if(snrfnd)then begin
			logtext(0,"Import Categ===========");
			for(i=0;i<cnt;i=i+1)begin
				tmp = "";
				tmp = ImportField;
				vcat[catcnt & "_" & i] = tmp;
			end;
			catcnt = catcnt + 1;
		end;
		if(floine and snrfnd==false)then begin
			logtext(0,"Import SubGroups===========" & cnt);
			for(i=0;i<cnt;i=i+1)begin
				tmp = ImportField;
				subgrp[i] = tmp;
				snrfnd = true;
			end;
		end;
		
		if(floine==false)then begin
			logtext(0,"Import Groups===========");
			tmp = ImportField;
			while(nonblank(tmp))begin
				group[cnt] = tmp;
				cnt=cnt+1;
				tmp = ImportField;
			end;
			floine = true;
		end;
				
		if (NextImportLine(true)) then begin end;
	end;
	
	if(snrfnd)then begin
		for(i=1;i<cnt;i=i+1)begin
			recordnew(NCSr);
				NCSr.Group = vgroup[group[i]];
				if(blank(NCSr.Group))then begin
					NCSr.Group = group[i];
				end;
				NCSr.Type = vsubgroup[subgrp[i]];
				if(blank(NCSr.Type))then begin
					NCSr.Group = subgrp[i];
				end;
				NCSr.GroupName = group[i];
				NCSr.TypeName = subgrp[i];

				for(j=0;j<catcnt;j=j+1)begin
					if(nonblank(vcat[j & "_" & i]))then begin
						NCSrw.CType = vcat[j & "_" & 0];
						NCSrw.CCode = vcat[j & "_" & i];
						NCSrw.CTypeName = vcat[j & "_" & 0];
						NCSrw.CCodeName = vcat[j & "_" & i];
						switch(vcat[j & "_" & 0]) begin
							case "Category": NCSrw.CType = "CATEGORY";
							NCSrw.CCode = vCategory[vcat[j & "_" & i]];
							case "Clarity": NCSrw.CType = "CLARITY";
							NCSrw.CCode = vClarity[vcat[j & "_" & i]];
							case "Color": NCSrw.CType = "COLOR";
							NCSrw.CCode = vColor[vcat[j & "_" & i]];
							case "Cut": NCSrw.CType = "CUT";
							NCSrw.CCode = vCut[vcat[j & "_" & i]];
							case "Material": NCSrw.CType = "MATERIAL";
							NCSrw.CCode = vMaterial[vcat[j & "_" & i]];
							case "Odour": NCSrw.CType = "ODOUR";
							NCSrw.CCode = vOdour[vcat[j & "_" & i]];
							case "Plating": NCSrw.CType = "PLATING";
							NCSrw.CCode = vPlating[vcat[j & "_" & i]];
							case "Sex": NCSrw.CType = "SEX";
							NCSrw.CCode = vSex[vcat[j & "_" & i]];
							case "Shape": NCSrw.CType = "SHAPE";
							NCSrw.CCode = vShape[vcat[j & "_" & i]];
							case "Size": NCSrw.CType = "SIZE";
							NCSrw.CCode = vSize[vcat[j & "_" & i]];
							case "Stone": NCSrw.CType = "STONE";
							NCSrw.CCode = vStone[vcat[j & "_" & i]];
							case "Strap": NCSrw.CType = "STRAP";
							NCSrw.CCode = vStrap[vcat[j & "_" & i]];
							case "Use": NCSrw.CType = "USE";
							NCSrw.CCode = vUse[vcat[j & "_" & i]];
							case "Weight": NCSrw.CType = "WEIGHT";
							NCSrw.CCode = vWeight[vcat[j & "_" & i]];
						end;
						
						matrowput(NCSr,matrowcnt(NCSr),NCSrw);
					end;
				end;
				
				logtext(0,"recordstore(NCSr,true);");
			recordstore(NCSr,true);
		end;
	end;

return;
end;

global updating procedure ImportABCXMLIn()
begin
	area axml;
	xml xdata;
	string 255 xkey,crncy,tstr,OwnID,BankID,ABC,XYZ,CurCode,CdtDbtInd,bookdate,impfilename;
	record INVc INr;
	longint cntchld,i,dcf;
	date ndat;
	area afile;
	
	logtext(0,"ImportABCIn " & GetImportFileName);
	cntchld = 0;
	xdata = ParseXMLFile(GetImportFileName);
	impfilename = "Categorization Data for Hansa.xml";
	addfiletoarea(GetImportFileName,afile,0);
	if(DirExists("CategorizationDataforHansa")==false)then begin
		CreateFolder("CategorizationDataforHansa");
	end;
	impfilename = impfilename & currentdate & "-" & currenttime;
	writeareatofile(afile,"CategorizationDataforHansa/" & impfilename,0);
	cntchld = XmlCountChildren(xdata,"dataroot");
	logtext(0,cntchld);
	for(i=0;i<cntchld;i=i+1) begin
		CurCode = XmlGet(xdata,"dataroot/Categorization_x0020_Data_x0020_for_x0020_Hansa[" & i & "]/Item_x0020_ID");
		logtext(0,CurCode);
		INr.Code=CUrCode;
		if(ReadFirstMain(INr,1,true)) then begin
			ABC = XmlGet(xdata,"dataroot/Categorization_x0020_Data_x0020_for_x0020_Hansa[" & i & "]/ABC_x002C__x0020_E");
			XYZ = XmlGet(xdata,"dataroot/Categorization_x0020_Data_x0020_for_x0020_Hansa[" & i & "]/XYZ_x002C__x0020_S");
			logtext(0,ABC & XYZ);
			INr.ItemCat = ABC;
			INr.SubItemCat = XYZ;
			RecordStore(INr,true);
		end;
	end;	
	
	while (TestEOF==false) begin
    tstr = ImportField;
    if (NextImportLine(true)) then begin
    end;
  end;
return;
end;

global webpublic updating procedure WebIDEAFixCost()
begin
	record INVc INr;
	
	setcompany(28,false);
	
	INr.Code = "";
	while(loopmain(INr,1,true))begin
		if(INr.LastPurchCurncyCode=="EUR")then begin
			if(INr.LastPurchPrice2>INr.InPrice)then begin
				logtext(0,INr.Code & "___" & INr.InPrice & "->" & round(INr.LastPurchPrice2 * 1.954,SetRoundModeD(2)));
				INr.InPrice = round(INr.LastPurchPrice2 * 1.954,SetRoundModeD(2));
				
				recordstore(INr,true);
			end;
		end;
	end;

return;
end;





global webpublic updating procedure WebCWH5SGFill()
begin
	record BPIBrandVc BRNDr;
	
	setcompany(18,false);
	
	BRNDr.Code = "";
	while(loopmain(BRNDr,1,true))begin
		if(BRNDr.CWHCode=="CWH5")then begin
			if(BRNDr.CWHCode=="CWH5" and BRNDr.StockGroup!="Eleqant R  MMC")then begin logtext (0,"Brand: " & BRNDr.Code & " Old SG: " & BRNDr.StockGroup); end;
			BRNDr.StockGroup = "Eleqant R  MMC";
			recordstore(BRNDr,true);
		end;
	end;

return;
end;






global webpublic updating procedure WebIDEAChechIHPU()
begin
	record INVc INr;
	record PUVc PUr;
	row PUVc PUrw;
	record ItemHistVc IHr;
	integer i,mtrw;
	
	
	setcompany(28,false);
	
	PUr.SerNr = -1;
	while(loopmain(PUr,1,true))begin
		mtrw = matrowcnt(PUr);
		For(i=0;i<mtrw;i=i+1) begin
	  	matrowget(PUr,i,PUrw);
	  	IHr.FileName = "PUVc";
	  	IHr.TransNr = PUr.SerNr;
	  	IHr.Row = i;
	  	if(readfirstkey("FNTransNr",IHr,3,true))then begin
	  		if(IHr.TotCostPrice!=PUrw.Sum)then begin
	  			logtext(0,PUrw.ArtCode & "  " & PUrw.Sum & " -> " & IHr.TotCostPrice);
	  		end;
	  	end;
		end; 
	end;
	
return;
end;

global webpublic updating procedure WebIDEACheckCost()
begin
	record INVc INr;
	
	setcompany(28,false);
	
	INr.Code = "";
	while(loopmain(INr,1,true))begin
		if(INr.LastPurchPrice2==0 and INr.InPrice>0)then begin
			logtext(0,INr.Code & "___" & INr.InPrice & "->" & round(INr.LastPurchPrice2,SetRoundModeD(2)));
		end;
	end;

return;
end;

global webpublic updating procedure WebIDEACheckCostPU()
begin
	record INVc INr;
	record PUVc PUr;
	row PUVc PUrw;
	integer mtrw,i;
	boolean changed;
	
	setcompany(28,false);
	
	PUr.SerNr = 0;
	while(loopmain(PUr,1,true))begin
		changed = false;
		mtrw = matrowcnt(PUr);
		for(i=0;i<mtrw;i=i+1)begin
			matrowget(PUr,i,PUrw);
			if(true)then begin
				INr.Code = PUrw.ArtCode;
				if(readfirstmain(INr,1,true))then begin
					if(PUrw.UPrice!=INr.LastPurchPrice2 or PUrw.CostPrice!=INr.InPrice)then begin
						//logtext(0,PUrw.ArtCode & "  " & PUrw.UPrice & " " & PUrw.CostPrice);
						//logtext(0,INr.Code & "___" & INr.InPrice & "->" & INr.LastPurchPrice2);
					
						PUrw.UPrice = INr.LastPurchPrice2;
						if(PUrw.UPrice==blankval)then begin
							PUrw.UPrice = 0;
						end;
						PUrw.CostPrice = INr.InPrice;
						if(PUrw.CostPrice==blankval)then begin
							PUrw.CostPrice = 0;
						end;
						PUrw.Sum = INr.InPrice * PUrw.Quant;
						matrowput(PUr,i,PUrw);
						changed = true;
						logtext(0,PUrw.ArtCode);
						logtext(0,INr.Code & "___" & INr.InPrice & "->" & round(INr.LastPurchPrice2,SetRoundModeD(2)));
					end;
				//if(INr.LastPurchPrice2==0 and INr.InPrice>0)then begin
					//logtext(0,INr.Code & "___" & INr.InPrice & "->" & round(INr.LastPurchPrice2,SetRoundModeD(2)));
				end;	
				//end;
			end;
		end;
		if(changed)then begin
			//PUSumUp(PUr);
			recordstore(PUr,true);
		end;
	end;

return;
end;

global
updating procedure ImportFixCreativeCostIn()//   Edit-------------------------------------------Dima    23.12.2014  
begin
	record INVc INr;
	string 255 artcode,eurcost,azncost,creativeartcode;
	val eurvalcost,aznvalcost;
	
	while (TestEOF()==false) begin	
		artcode = importfield;
		creativeartcode = importfield;
		eurcost = importfield;
		azncost = importfield;
		
		if(nonblank(artcode))then begin
			INr.Code = artcode;
			if(readfirstmain(INr,1,true))then begin
				eurvalcost = blankval;
				aznvalcost = blankval;
				if(nonblank(eurcost))then begin
					eurvalcost =  stringtoval(eurcost,M45Val);
				end else begin
					eurvalcost = 0;
				end;
				if(nonblank(azncost))then begin
					aznvalcost =  stringtoval(azncost,M45Val);
				end else begin
					aznvalcost = 0;
				end;
				if(AbsoluteVal(INr.InPrice-aznvalcost)>1 or AbsoluteVal(INr.LastPurchPrice2-eurvalcost)>1)then begin
					INr.InPrice = aznvalcost;
					INr.LastPurchPrice2 = eurvalcost;
					logtext(0,INr.Code & " fixed");
					recordstore(INr,True);
				end;
			end;
		end;
		
		if (NextImportLine(true)) then begin end;
	end;
return;
end;


global
updating procedure PUImportIn()//   Edit-------------------------------------------Dima    23.12.2014  
begin
  record PUVc PUr,PU2r;
  row PUVc PUrw;
	record PosVc Posr;
  record LocationVc Locr;
  string 50 location,curLoc, artcode, quant,binNr,sum1,sum2,sum;
  Integer pucnt;
  record INVc INr;
	integer coefx;
	vector string 50 serialNr;
	record SysFormatBlock SysFormatRec;
  
  BlockLoad(SysFormatRec);
	
	pucnt =0;
	logtext(0,"start");
	while (TestEOF()==false) begin	
		PUr.CurncyCode = "EUR";
		artcode = ImportField;
		location = ImportField;
	
		if ((location == curLoc) and (pucnt < 999) and nonblank(artcode)) then begin	//çàïîëíåíèå òàáëèöû äàííûìè
			binNr = ImportField;
			quant = ImportField;

			PUr.FrRate = 1;
			PUr.ToRateB1 = 1.954;
			INr.Code = artcode;
			Posr.Code = binNr;
			if(blank(serialNr[artcode])) then begin
				Purw.SerialNr = "1";
				serialNr[artcode] = "1";
			end else begin 
				serialNr[artcode] = ValToString((StringToVal(serialNr[artcode],M4UVal)+1), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
				Purw.SerialNr = ValToString((StringToVal(serialNr[artcode],M4UVal)), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
			end;
			if(!ReadFirstMain(Posr,1,true)) then begin
				RecordNew(Posr);
				Posr.Code = binNr;
				Posr.Location = location;
				RecordStore(Posr,true);
				logtext(0,"new polochka " & Locr.Name);
			end;
			If(readfirstmain(INr,1,true))then begin
				coefx = INr.Conversion1;
				if(coefx<1)then begin
					coefx = 1;
				end;
				PUrw.ArtCode = artcode;
				//PUrw.UPrice = StringToVal(price,M45Val);
				PUrw.Quant = StringToVal(quant,M4UVal)*coefx;
				PUrw.UPrice = INr.LastPurchPrice2;
				if(PUrw.UPrice==blankval)then begin PUrw.UPrice = 0; end;
				PUrw.CostPrice = INr.InPrice;
				if(PUrw.CostPrice==blankval)then begin PUrw.CostPrice = 0; end;
				Purw.Sum = INr.InPrice * PUrw.Quant ;
		
				MatRowPut(PUr,pucnt,PUrw);
				PUVc_FillRow(PUr,pucnt);
				pucnt= pucnt + 1;	
			end else begin
				INr.Code = artcode;
				if(readfirstMain(INr,1,true))then begin
					PUrw.ArtCode = INr.Code;
					//PUrw.UPrice = StringToVal(price,M45Val);
					PUrw.Quant = StringToVal(quant,M4UVal);
					PUrw.UPrice = INr.LastPurchPrice2;
					if(PUrw.UPrice==blankval)then begin PUrw.UPrice = 0; end;
					PUrw.CostPrice = INr.InPrice;
					if(PUrw.CostPrice==blankval)then begin PUrw.CostPrice = 0; end;
					Purw.Sum = INr.InPrice * PUrw.Quant ;
					PUrw.ToPosCode = binNr;
					MatRowPut(PUr,pucnt,PUrw);
					PUVc_FillRow(PUr,pucnt);
					pucnt= pucnt + 1;	
				end;
			end;
		end else begin			//ñîçäàíèå íîâîé PU çàïèñè
			if (NonBlank(curLoc)) then begin			
				PUSumUp(PUr);
				RecordInsert(PUr,true);
			end;

			Locr.Code = location;

			if (nonblank(location) and ReadFirstMain(Locr,1,true) and nonblank(artcode)) then begin			
				logtext(0,location);
				RecordNew(PUr);				
  			PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,-1,false,"");  		
				pucnt = 0;
				binNr	=	ImportField;
				quant = ImportField;
      		
				PUr.Location = location;
				PUr.FrRate = 1;
				PUr.ToRateB1 = 1.954;
				Posr.Code = binNr;
			if(blank(serialNr[artcode])) then begin
						Purw.SerialNr = "1";
						serialNr[artcode] = "1";
					end else begin 
						serialNr[artcode] = ValToString((StringToVal(serialNr[artcode],M4UVal)+1), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
						Purw.SerialNr = ValToString((StringToVal(serialNr[artcode],M4UVal)), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
					end;
				if(!ReadFirstMain(Posr,1,true)) then begin
					RecordNew(Posr);
					Posr.Code = binNr;
					Posr.Location = location;
					RecordStore(Posr,true);
					logtext(0,"new polochka " & Locr.Name);
				end;
				INr.Code = artcode;
				If(readfirstmain(INr,1,true))then begin
					coefx = INr.Conversion1;
					if(coefx<1)then begin
						coefx = 1;
					end;
					PUrw.ArtCode = artcode;
					//PUrw.UPrice = StringToVal(price,M45Val);
					PUrw.Quant = StringToVal(quant,M4UVal)*coefx;
					PUrw.UPrice = INr.LastPurchPrice2;
					if(PUrw.UPrice==blankval)then begin PUrw.UPrice = 0; end;
					PUrw.CostPrice = INr.InPrice;
					if(PUrw.CostPrice==blankval)then begin PUrw.CostPrice = 0; end;
					Purw.Sum = INr.InPrice * PUrw.Quant ;
					PUrw.ToPosCode = binNr;
					MatRowPut(PUr,pucnt,PUrw);
					PUVc_FillRow(PUr,pucnt);
					pucnt= pucnt + 1;	
				end else begin
					INr.Code = artcode;
					if(readfirstMain(INr,1,true))then begin
						PUrw.ArtCode = INr.Code;
						//PUrw.UPrice = StringToVal(price,M45Val);
						PUrw.Quant = StringToVal(quant,M4UVal);
						PUrw.UPrice = INr.LastPurchPrice2;
						if(PUrw.UPrice==blankval)then begin PUrw.UPrice = 0; end;
						PUrw.CostPrice = INr.InPrice;
						if(PUrw.CostPrice==blankval)then begin PUrw.CostPrice = 0; end;
						Purw.Sum = INr.InPrice * PUrw.Quant ;
						MatRowPut(PUr,pucnt,PUrw);
						PUVc_FillRow(PUr,pucnt);
						pucnt= pucnt + 1;	
					end;
				end;
								     		
				curLoc = location;
			end;			
				
		end;
		
		if (NextImportLine(true)) then begin end;
	end;

	if (pucnt>0) then begin	//äîáàâëåíèå ïîñëåäíåé çàïèñè
 			PUSumUp(PUr);
			RecordInsert(PUr,true);	
	end;
logtext(0,"end");
return;
end;

global
updating procedure PUImportIn2()//   Edit-------------------------------------------Dima    23.12.2014  
begin
  record PUVc PUr,PU2r;
  row PUVc PUrw;
	record PosVc Posr;
  record LocationVc Locr;
  string 50 location,curLoc, artcode, quant,binNr,sum1,sum2,sum;
  Integer pucnt;
  record INVc INr;
	integer coefx;
	vector string 50 serialNr;
	record SysFormatBlock SysFormatRec;
  
  BlockLoad(SysFormatRec);
	
	pucnt =0;
	logtext(0,"start");
	while (TestEOF()==false) begin	
		PUr.CurncyCode = "EUR";
		artcode = ImportField;
		location = ImportField;
	
		if ((location == curLoc) and (pucnt < 999) and nonblank(artcode)) then begin	//çàïîëíåíèå òàáëèöû äàííûìè
			binNr = ImportField;
			quant = ImportField;
			sum1 = ImportField;
			if(blank(sum1))then begin sum1 = "0"; end;
			sum2 = ImportField;
			if(blank(sum2))then begin sum2 = "0"; end;
			PUr.FrRate = 1;
			PUr.ToRateB1 = 1.954;
			INr.Code = artcode;
			Posr.Code = binNr;
			if(blank(serialNr[artcode])) then begin
						Purw.SerialNr = "1";
						serialNr[artcode] = "1";
					end else begin 
						serialNr[artcode] = ValToString((StringToVal(serialNr[artcode],M4UVal)+1), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
						Purw.SerialNr = ValToString((StringToVal(serialNr[artcode],M4UVal)), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
					end;
			if(!ReadFirstMain(Posr,1,true)) then begin
					RecordNew(Posr);
					Posr.Code = binNr;
					Posr.Location = location;
					RecordStore(Posr,true);
					logtext(0,"new polochka " & Locr.Name);
			end;
			If(readfirstmain(INr,1,true))then begin
				coefx = INr.Conversion1;
				if(coefx<1)then begin
					coefx = 1;
				end;
				PUrw.ArtCode = artcode;
				//PUrw.UPrice = StringToVal(price,M45Val);
				PUrw.Quant = StringToVal(quant,M4UVal)*coefx;
				PUrw.UPrice = StringToVal(sum1,M4UVal);
				PUrw.CostPrice = StringToVal(sum2,M4UVal);
				PUrw.Sum = PUrw.CostPrice * PUrw.Quant;
				PUrw.ToPosCode = binNr;
				MatRowPut(PUr,pucnt,PUrw);
				PUVc_FillRow(PUr,pucnt);
				/*PUrw.UPrice = StringToVal(sum1,M4UVal);
						PUrw.CostPrice = StringToVal(sum2,M4UVal);
						PUrw.Sum = PUrw.CostPrice * PUrw.Quant;
						PUrw.UnitCode = INr.Unittext;
						MatRowPut(PUr,pucnt,PUrw);*/
				pucnt= pucnt + 1;	
			end else begin
				logtext(0,"ItemNotFound " & artcode);
			end;
		end else begin			//ñîçäàíèå íîâîé PU çàïèñè
			if (NonBlank(curLoc)) then begin			
				PUSumUp(PUr);
				RecordInsert(PUr,true);
			end;

			Locr.Code = location;

			if (nonblank(location) and ReadFirstMain(Locr,1,true) and nonblank(artcode)) then begin			
				logtext(0,location);
				RecordNew(PUr);				
  			PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,-1,false,"");  		
				pucnt = 0;
				binNr	=	ImportField;
				quant = ImportField;
      	sum1 = ImportField;
				sum2 = ImportField;	
				PUr.Location = location;
				PUr.FrRate = 1;
				PUr.ToRateB1 = 1.954;
				Posr.Code = binNr;
				if(blank(serialNr[artcode])) then begin
						Purw.SerialNr = "1";
						serialNr[artcode] = "1";
					end else begin 
						serialNr[artcode] = ValToString((StringToVal(serialNr[artcode],M4UVal)+1), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
						Purw.SerialNr = ValToString((StringToVal(serialNr[artcode],M4UVal)), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
					end;
				if(!ReadFirstMain(Posr,1,true)) then begin
					RecordNew(Posr);
					Posr.Code = binNr;
					Posr.Location = location;
					RecordStore(Posr,true);
					logtext(0,"new polochka " & Locr.Name);
				end;
				INr.Code = artcode;
				If(readfirstmain(INr,1,true))then begin
					coefx = INr.Conversion1;
					if(coefx<1)then begin
						coefx = 1;
					end;
					PUrw.ArtCode = artcode;
					//PUrw.UPrice = StringToVal(price,M45Val);
					PUrw.Quant = StringToVal(quant,M4UVal)*coefx;
					PUrw.UPrice = StringToVal(sum1,M4UVal);
					PUrw.CostPrice = StringToVal(sum2,M4UVal);
					PUrw.Sum = PUrw.CostPrice * PUrw.Quant;
					PUrw.ToPosCode = binNr;
					MatRowPut(PUr,pucnt,PUrw);
					PUVc_FillRow(PUr,pucnt);
					/*PUrw.UPrice = StringToVal(sum1,M4UVal);
						PUrw.CostPrice = StringToVal(sum2,M4UVal);
						PUrw.Sum = PUrw.CostPrice * PUrw.Quant;
						PUrw.UnitCode = INr.Unittext;
						MatRowPut(PUr,pucnt,PUrw);*/
					pucnt= pucnt + 1;	
				end else begin
					logtext(0,"ItemNotFound " & artcode);
				end;
								     		
				curLoc = location;
			end;			
				
		end;
		
		if (NextImportLine(true)) then begin end;
	end;

	if (pucnt>0) then begin	//äîáàâëåíèå ïîñëåäíåé çàïèñè
 			PUSumUp(PUr);
			RecordInsert(PUr,true);	
	end;
logtext(0,"end");
return;
end;

global updating procedure OutOfOrderIn()
begin
record INVc INr;
integer i,curcomp,cnt;
string 100 item,brand;
record BPIBrandVc BPIBrandr;
boolean error;

	curcomp = currentcompany;
	logtext(0,"start");
	LogText(3, "Check OutOfOrder - bulk update by codes and brand names");
	
	error = false;

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		item = importfield;
		brand = importfield;
		BPIBrandr.Name = brand;
		if(readfirstkey("Name",BPIBrandr,1,true))then begin
			brand = BPIBrandr.Code;
		end;
		for(i=1;i<34; i=i+1) begin
			if(!CompanyIsJWLikeCompany(i) or i==3) then begin
				SetCompany(i,false);
				INr.Code = item;
				if(readfirstmain(INr,1,true)) begin
					if(INr.Code==item and INr.BPIBrand==brand and INr.OutOfOrder==0) then begin
						INr.OutOfOrder = 1;
						logtext(0,cnt & ". Updated: " & INr.Code & " " & INr.BPIBrand & " Company code: " & i);
						RecordStore(INr,true);
					end else begin
						error = true;
						LogText(3, cnt & ". Didn't update: " & item & " " & brand & " Company code: " & i & " ---------- Reason: incorrect brand name! ");
					end;
				end;
			end;
		end;
		
		if (NextImportLine(true)) then begin end;
	end;
	SetCompany(curcomp,false);
	
	if(error) then begin
		MessageBox(0, "Imported successfully, but in some rows error occured! Did not import! Please contact administrator - hansa.log");
	end else begin
		MessageBox(0, "Imported successfully!");
	end;
	
logtext(0,"end");
return;
end;	


global updating procedure CheckOffOutOfOrderIn()
begin
record INVc INr;
integer i,curcomp,cnt;
string 100 item,brand;
record BPIBrandVc BPIBrandr;
boolean error;

	curcomp = currentcompany;
	logtext(0,"start");
	LogText(3, "Uncheck OutOfOrder - bulk update by codes and brand names");

	
	error = false;

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		item = importfield;
		brand = importfield;
		BPIBrandr.Name = brand;
		if(readfirstkey("Name",BPIBrandr,1,true))then begin
			brand = BPIBrandr.Code;
		end;
		for(i=1;i<34; i=i+1) begin
			if(!CompanyIsJWLikeCompany(i) or i==3) then begin
				SetCompany(i,false);
				INr.Code = item;
				if(readfirstmain(INr,1,true)) begin
					if(INr.Code==item and INr.BPIBrand==brand and INr.OutOfOrder!=0) then begin
						INr.OutOfOrder = 0;
						logtext(0,cnt & ". Updated: " & INr.Code & " " & INr.BPIBrand & " Company code: " & i);
						RecordStore(INr,true);
					end else begin
						error = true;
						LogText(3, cnt & ". Didn't update: " & item & " " & brand & " Company code: " & i & " ---------- Reason: incorrect brand name! ");
					end;
				end;
			end;
		end;
		
		if (NextImportLine(true)) then begin end;
	end;
	SetCompany(curcomp,false);
	
	if(error) then begin
		error = true;
		MessageBox(0, "Imported successfully, but in some rows error occured! Did not import! Please contact administrator - hansa.log");
	end else begin
		MessageBox(0, "Imported successfully!");
	end;
	
logtext(0,"end");
return;
end;	

global updating procedure ChangeBPIGroupIn()
begin
record INVc INr;
integer i,curcomp,cnt;
string 100 item,brand,oldgroup,newgroup,newkey,oldkey;
record BPIBrandVc BPIBrandr;
record BPIGroupVc BPIGroupr;


	curcomp = currentcompany;
	logtext(0,"start");

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		item = importfield;
		brand = importfield;
		oldgroup = importfield;
		newgroup = importfield;
		for(i=1;i<30; i=i+1) begin
			if(!CompanyIsJWLikeCompany(i) or i==3) then begin
				SetCompany(i,false);
				INr.Code = item;
				if(readfirstmain(INr,1,true)) begin
					BPIBrandr.Name = brand;
					if((readfirstkey("Name",BPIBrandr,1,true) and INr.BPIBrand==BPIBrandr.Code) or brand=="*")then begin
						BPIGroupr.Name = oldgroup;
						oldkey = "Name";
						if(left(oldgroup,5)=="GROUP")then begin
								BPIGroupr.Code = oldgroup;
								oldkey = "Code";
							end;
						if(readfirstkey(oldkey,BPIGroupr,1,true) and INr.BPIGroup==BPIGroupr.Code)then begin
							BPIGroupr.Name = newgroup;
							newkey = "Name";
							if(left(newgroup,5)=="GROUP")then begin
								BPIGroupr.Code = newgroup;
								newkey = "Code";
							end;
							if(readfirstkey(newkey,BPIGroupr,1,true))then begin
								logtext(0,INr.DispGroups & " <- " & INr.BPIGroup);
								logtext(0,setinset2(INr.BPIGroup,INr.DispGroups));
								if(setinset(INr.BPIGroup,INr.DispGroups))then begin
									logtext(0,"Try to change subgroup");
									logtext(0,INr.DispGroups & " -> " & StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code));
									INr.DispGroups = StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code);
									
								end;
								INr.BPIGroup = BPIGroupr.Code;
								logtext(0,INr.Code);
								recordstore(INr,true);
							end;
						end;
					end;
				end;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	SetCompany(curcomp,false);
	
logtext(0,"end");
return;
end;


global updating procedure PriceFillIn()
begin
string 100 Code;
record GlobalItemVc GIr;
integer cnt;

logtext(0,"start");

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		Code = importfield;
		GIr.Code = Code;
		if(readfirstmain(GIr,1,true)) then begin
			logtext(0,"PriceFillIn Code:" & GIr.Code & " Global item price = " & blankval);
			GIr.Price = blankval;
			RecordStore(GIr,true);
			logtext(0,GIr.Code & " - " & GIr.Price)//????????????????????????
		end;
		if (NextImportLine(true)) then begin end;
	end;
logtext(0,"end");
return;
end;

global updating procedure BrandFillCWHIn()
begin
string 100 CWHCode,brand,StockGroup;
record BPIBrandVc Brandr;
integer cnt;

logtext(0,"start");

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		brand = importfield;
		CWHCode = importfield;
		StockGroup = importfield;
		Brandr.Name = brand;
		if(readfirstkey("Name",Brandr,1,true)) then begin
			if(blank(Brandr.CWHCode))then begin
				//Brandr.CWHCode = CWHCode;
			end;
			Brandr.StockGroup = StockGroup;
			RecordStore(Brandr,true);
		end;
		if (NextImportLine(true)) then begin end;
	end;
logtext(0,"end");
return;
end;

global updating procedure ChangeAllBrandBPIBrandIn()
begin
record INVc INr,oldINr;
integer i,curcomp,cnt,j,k;
record GlobalItemVc GIr;
string 100 item,oldBrand,newBrand,code,glCode;
record BPIBrandVc BPIBrandr;
record BPIBrandVc BPIBrand1r;
array string 100 abrand,anewbrand;


	curcomp = currentcompany;
	logtext(0,"start");

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		code = importfield;
		oldBrand = importfield;
		newBrand = importfield;
		BPIBrandr.Code = oldBrand;
		if(readfirstkey("Code",BPIBrandr,1,true))then begin
			if(uppercase(oldBrand)==uppercase(BPIBrandr.Code))then begin		
				BPIBrand1r.Code = newBrand;
				if(readfirstkey("Code",BPIBrand1r,1,true))then begin
						
						
					for(i=1;i<33; i=i+1) begin
						if(!CompanyIsJWLikeCompany(i) or i==3) then begin
							SetCompany(i,false);
							INr.Code = code;
							if(readfirstMain(INr,1,true))then begin
								if(nonblank(INr.BPIBrand))then begin
									RecordCopy(oldINr,INr);
									if(INr.BPIBrand==BPIBrandr.Code)then begin;
										logtext(0,INr.Code);
										if(setinset(INr.BPIBrand,INr.DispGroups))then begin										
											INr.DispGroups = StrReplace(INr.DispGroups,INr.BPIBrand,BPIBrand1r.Code);
										end;
										glCode = INr.GlobalArtCode;
										INr.GlobalArtCode = "";
										INr.BPIBrand = BPIBrand1r.Code;
										GIr.Code = glCode;
										if(ReadFirstMain(GIr,1,true)) then begin
											logtext(0,"del" & GIr.Code);
											RecordDelete(GIr);
										end;
										CreateNewGlobalItem(INr);
										if(recordStore(INr,true)) then begin  end;
									end; 
								end;
							end;
						end;
					end;
				end;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	SetCompany(curcomp,false);
	
logtext(0,"end");
return;
end;

global updating procedure ChangeAllBrandBPIGroupIn()
begin
record INVc INr;
integer i,curcomp,cnt,j,k;
string 100 item,brand,oldgroup,newgroup;
record BPIBrandVc BPIBrandr;
record BPIGroupVc BPIGroupr;
array string 100 abrand,aoldgroup,anewgroup;


	curcomp = currentcompany;
	logtext(0,"start");

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		brand = importfield;
		oldgroup = importfield;
		newgroup = importfield;
		logtext(0,brand & " " & oldgroup & " " & newgroup);
		BPIBrandr.Name = brand;
		if(readfirstkey("Name",BPIBrandr,1,false))then begin
			logtext(0,BPIBrandr.Name & " " & oldgroup & " " & newgroup);
			if(uppercase(brand)==uppercase(BPIBrandr.Name))then begin
				abrand[abrand.length] = BPIBrandr.Code;
				BPIGroupr.Name = oldgroup;
				if(readfirstkey("Name",BPIGroupr,1,false))then begin
					aoldgroup[aoldgroup.length] = BPIGroupr.Code;
					BPIGroupr.Name = newgroup;
					if(readfirstkey("Name",BPIGroupr,1,false))then begin
						anewgroup[anewgroup.length] = BPIGroupr.Code;
					
						logtext(0,abrand[abrand.length-1] & " " & aoldgroup[aoldgroup.length-1] & " -> " & anewgroup[anewgroup.length-1]);
						
						
						for(i=1;i<30; i=i+1) begin
						if(!CompanyIsJWLikeCompany(i) or i==3) then begin
							SetCompany(i,false);
							resetloop(INr);
							INr.Code = "";
							while(loopmain(INr,1,true)) begin
								if(nonblank(INr.BPIGroup) and nonblank(INr.BPIBrand))then begin
									For(j=0;j<abrand.length;j=j+1) begin
										if(INr.BPIBrand==abrand[j])then begin
											if(INr.BPIGroup==aoldgroup[j])then begin
												logtext(0,INr.Code & " " & aoldgroup[j] & " -> " & anewgroup[j]);
												if(setinset(INr.BPIGroup,INr.DispGroups))then begin
													logtext(0,INr.Code & "  " & INr.DispGroups & " -> " & StrReplace(INr.DispGroups,INr.BPIGroup,anewgroup[j]));
													INr.DispGroups = StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code);
												end;
												INr.BPIGroup = anewgroup[j];
												recordstore(INr,true);
											end;
										end;
									end; 
								end;
							end;
						end;
					end;
						
					end;
				end;
			end;
		end;
		/*
		for(i=1;i<30; i=i+1) begin
			if(!CompanyIsJWLikeCompany(i) or i==3) then begin
				SetCompany(i,false);
				INr.Code = item;
				if(readfirstmain(INr,1,true)) begin
					BPIBrandr.Name = brand;
					if(readfirstkey("Name",BPIBrandr,1,true) and INr.BPIBrand==BPIBrandr.Code)then begin
						BPIGroupr.Name = oldgroup;
						if(readfirstkey("Name",BPIGroupr,1,true) and INr.BPIGroup==BPIGroupr.Code)then begin
							BPIGroupr.Name = newgroup;
							if(readfirstkey("Name",BPIGroupr,1,true))then begin
								logtext(0,INr.DispGroups & " <- " & INr.BPIGroup);
								logtext(0,setinset2(INr.BPIGroup,INr.DispGroups));
								if(setinset(INr.BPIGroup,INr.DispGroups))then begin
									logtext(0,"Try to change subgroup");
									logtext(0,INr.DispGroups & " -> " & StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code));
									INr.DispGroups = StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code);
									
								end;
								INr.BPIGroup = BPIGroupr.Code;
								logtext(0,INr.Code);
								recordstore(INr,true);
							end;
						end;
					end;
				end;
			end;
		end;*/
		if (NextImportLine(true)) then begin end;
	end;
	SetCompany(curcomp,false);
	
logtext(0,"end");
return;
end;






global updating procedure Rebuild3catTreeGIMn()
begin
	record GlobalItemVc GIr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	boolean TrHs, catrtreef;
	string 255 Name3catrus,Name3cataz,Name3,OldCode;


	GIr.Code = "";
	while (loopmain(GIr,1,true)) begin
		BtrxThirdLevelCatr.Code = GIr.BTRxThirdLevCat;
		if(ReadFirstMain(BtrxThirdLevelCatr,1,true))then begin
			Name3 = BtrxThirdLevelCatr.Name;
			OldCode = BtrxThirdLevelCatr.Code;
			BtrxThirdLevelCatr.Name = Name3;
			if(ReadFirstkey("Name",BtrxThirdLevelCatr,1,true))then begin
				GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
				recordStore(GIr,true);
				logtext(0,GIr.BTRxThirdLevCat);
				if(BtrxThirdLevelCatr.Code != OldCode)then begin
					BtrxThirdLevelCatr.Code = OldCode;
					if(ReadFirstMain(BtrxThirdLevelCatr,1,true))then begin
						recordDelete(BtrxThirdLevelCatr);
					end;
				end;
			end;
		end;
	end;
return;
end;

global updating procedure Rebuild3catTreeMn()
begin
	record GlobalItemVc GIr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	boolean TrHs, catrtreef, createdf;
	string 255 Name3catrus,Name3cataz,Name3,OldCode;
	
	
	GIr.Code = "";
	while (loopmain(GIr,1,true)) begin
		if(nonblank(GIr.BTRxThirdLevCat) and nonblank(GIr.BTRxSecondLevCat))then begin
			BtrxSecondLevelCatr.Code = GIr.BTRxSecondLevCat;
			if(ReadFirstMain(BtrxSecondLevelCatr,1,true))then begin
				BtrxThirdLevelCatr.Code = GIr.BTRxThirdLevCat;
				catrtreef = false;
				TrHs = true;
				Name3catrus = "";
				Name3cataz = "";
				Name3 = "";
				createdf = false;
				while (loopmain(BtrxThirdLevelCatr,1,TrHs)) begin
					if(BtrxThirdLevelCatr.Code!=GIr.BTRxThirdLevCat)then begin TrHs = false; end;
					if(BtrxThirdLevelCatr.Code==GIr.BTRxThirdLevCat)then begin 
						Name3catrus = BtrxThirdLevelCatr.NameRUS;
						Name3cataz = BtrxThirdLevelCatr.NameAZ;
						Name3 = BtrxThirdLevelCatr.Name;
						createdf = true;
					end;
					if(GIr.BTRxSecondLevCat==BtrxThirdLevelCatr.RelatedTo and TrHs)then begin
						catrtreef = true;
						logtext (0,GIr.Code & " Good");
						TrHs = false;
					end;
				end;
				resetloop(BtrxThirdLevelCatr);
				if(!catrtreef and createdf)then begin
					BtrxThirdLevelCatr.Code = "THLVL9999";
					TrHs = true;
					while (LoopBackKey("Code",BtrxThirdLevelCatr,1,TrHs)) begin
						OldCode = BtrxThirdLevelCatr.Code;
						TrHs = false;
					end;
					ResetLoop(BtrxThirdLevelCatr);
					recordnew(BtrxThirdLevelCatr);
					if(blank(OldCode))then begin OldCode = "THLVL0000"; end;
					NextM4SerialNumber(OldCode,BtrxThirdLevelCatr.Code);
					BtrxThirdLevelCatr.RelatedTo = GIr.BTRxSecondLevCat;
					BtrxThirdLevelCatr.Name = Name3;
					BtrxThirdLevelCatr.NameRUS = Name3catrus;
					BtrxThirdLevelCatr.NameAZ = Name3cataz;
					recordstore(BtrxThirdLevelCatr,true);
					GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
					recordStore(GIr,true);
					OldCode = "";
					LogText(0,GIr.Code);
				end;
			end;
		end;
	end;


return;
end;


updating function boolean SetItemBitrixClass(var record GlobalItemVc GIr,array string headers,array string params, var array string ErrAr, var integer ErrCnt,var array string ErrAr2)
begin
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr, BSLLastCoder;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;
	record BtrxStrapMatVc BtrxStrapMatr;
	record BtrxBracelMatVc BtrxBracelMatr;
	record BtrxCollectionVc BtrxCollectionr;
	
	integer i, pos;
	string 100 param, OldCode;
	boolean res, TrHs, testf, THRDf, catrtreef, createdf;
	string 255 catName, catNameRUS, catNameAZ, parametr, paramsStr, Name3catrus, Name3cataz, tree3Code;
	
	GIr.BTRxGiftClass = "";
	res = true;
	logtext(0,GIr.Code);
	for(i=0;i<headers.length;i=i+1)begin
		param = headers[i];
		params[i] = trim(params[i]);
		switch(param)begin
			case"Brand": 			if(blank(params[i]))then begin
													GIr.BPIBrand = "";
												end else begin
													BTRxBrandr.Name = params[i];
													if(readfirstkey("Name",BTRxBrandr,1,true))then begin
														GIr.BPIBrand = BTRxBrandr.Code;
													end else begin
														BTRxBrandr.Code = params[i];
														if(readfirstmain(BTRxBrandr,1,true))then begin
															GIr.BPIBrand = BTRxBrandr.Code;
														end else begin
															//GIr.BPIBrand = "";
															//ErrAr[ErrCnt] = param & ": " & params[i];
															//ErrCnt = ErrCnt + 1;
															 BTRxBrandr.Code = "BRND9999";
															 TrHs = true;
															 while (LoopBackKey("Code",BTRxBrandr,1,TrHs)) begin
																 OldCode = BTRxBrandr.Code;
																 TrHs = false;
															 end;
															 ResetLoop(BTRxBrandr);
															 recordnew(BTRxBrandr);
															 if(blank(OldCode))then begin OldCode = "BRND0000"; end;
															 NextM4SerialNumber(OldCode,BTRxBrandr.Code);
															 BTRxBrandr.Name = params[i];
															 recordinsert(BTRxBrandr,true);
															 recordupdate(BTRxBrandr,BTRxBrandr,true);
															 GIr.BPIBrand = BTRxBrandr.Code;
															 res = true;
															 OldCode = "";
														end;
													end;
												end;
			case"IntCat": 		if(blank(params[i]))then begin
													GIr.BTRxInterCatClass = "";
												end else begin
													BtrxInternalCatr.Name = params[i];
													if(readfirstkey("Name",BtrxInternalCatr,1,true))then begin
														GIr.BTRxInterCatClass = BtrxInternalCatr.Code;
													end else begin
														BtrxInternalCatr.Code = params[i];
														if(readfirstmain(BtrxInternalCatr,1,true))then begin
															GIr.BTRxInterCatClass = BtrxInternalCatr.Code;
														end else begin
															GIr.BTRxInterCatClass = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxInternalCatr.Code = "INCAT9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxInternalCatr,1,TrHs)) begin
																// OldCode = BtrxInternalCatr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxInternalCatr);
															// recordnew(BtrxInternalCatr);
															// if(blank(OldCode))then begin OldCode = "INCAT0000"; end;
															// NextM4SerialNumber(OldCode,BtrxInternalCatr.Code);
															// BtrxInternalCatr.Name = params[i];
															// recordinsert(BtrxInternalCatr,true);
															// recordupdate(BtrxInternalCatr,BtrxInternalCatr,true);
															// GIr.BTRxInterCatClass = BtrxInternalCatr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Type": 			if(blank(params[i]))then begin
													GIr.BTRxType = "";
												end else begin
													BtrxTyper.Name = params[i];
													if(readfirstkey("Name",BtrxTyper,1,true))then begin
														GIr.BTRxType = BtrxTyper.Code;
													end else begin
														BtrxTyper.Code = params[i];
														if(readfirstmain(BtrxTyper,1,true))then begin
															GIr.BTRxType = BtrxTyper.Code;
														end else begin
															GIr.BTRxType = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxTyper.Code = "BTYPE9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxTyper,1,TrHs)) begin
																// OldCode = BtrxTyper.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxTyper);
															// recordnew(BtrxTyper);
															// if(blank(OldCode))then begin OldCode = "BTYPE0000"; end;
															// NextM4SerialNumber(OldCode,BtrxTyper.Code);
															// BtrxTyper.Name = params[i];
															// recordinsert(BtrxTyper,true);
															// recordupdate(BtrxTyper,BtrxTyper,true);
															// GIr.BTRxType = BtrxTyper.Code;
															// res = true;
															// OldCode = "";
														end;
													end;					
												end;
			case"Cat1":				if(blank(params[i]))then begin
													GIr.BTRxFirstLevCat = "";
												end else begin
													pos = 0;
													BtrxFirstLevelCatr.Name = "";
													paramsStr = "";
													parametr = params[i];
													ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													while (nonblank(paramsStr)) begin
														if(nonblank(BtrxFirstLevelCatr.Name))then begin
															BtrxFirstLevelCatr.Name = BtrxFirstLevelCatr.Name & " ";
														end;
														BtrxFirstLevelCatr.Name = BtrxFirstLevelCatr.Name & paramsStr;
														ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													end;
													if(readfirstkey("Name",BtrxFirstLevelCatr,1,true))then begin
														GIr.BTRxFirstLevCat = BtrxFirstLevelCatr.Code;
													end else begin
														BtrxFirstLevelCatr.Code = params[i];
														if(readfirstmain(BtrxFirstLevelCatr,1,true))then begin
															GIr.BTRxFirstLevCat = BtrxFirstLevelCatr.Code;
														end else begin
															GIr.BTRxFirstLevCat = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// logtext(0,"yes");
															// BtrxFirstLevelCatr.Code = "FILVL9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxFirstLevelCatr,1,TrHs)) begin
																// OldCode = BtrxFirstLevelCatr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxFirstLevelCatr);
															// recordnew(BtrxFirstLevelCatr);
															// if(blank(OldCode))then begin OldCode = "FILVL0000"; end;
															// NextM4SerialNumber(OldCode,BtrxFirstLevelCatr.Code);
															// BtrxFirstLevelCatr.Name = params[i];
															// recordinsert(BtrxFirstLevelCatr,true);
															// recordupdate(BtrxFirstLevelCatr,BtrxFirstLevelCatr,true);
															// GIr.BTRxFirstLevCat = BtrxFirstLevelCatr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Cat2":				if(blank(params[i]))then begin
													GIr.BTRxSecondLevCat = "";
												end else begin
													pos = 0;
													BtrxSecondLevelCatr.Name = "";
													paramsStr = "";
													parametr = params[i];
													ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													while (nonblank(paramsStr)) begin
														if(nonblank(BtrxSecondLevelCatr.Name))then begin
															BtrxSecondLevelCatr.Name = BtrxSecondLevelCatr.Name & " ";
														end;
														BtrxSecondLevelCatr.Name = BtrxSecondLevelCatr.Name & paramsStr;
														ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													end;
													if(readfirstkey("Name",BtrxSecondLevelCatr,1,true))then begin
														GIr.BTRxSecondLevCat = BtrxSecondLevelCatr.Code;
													end else begin
														BtrxSecondLevelCatr.Code = params[i];
														if(readfirstmain(BtrxSecondLevelCatr,1,true))then begin
															GIr.BTRxSecondLevCat = BtrxSecondLevelCatr.Code;
														end else begin
															GIr.BTRxSecondLevCat = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
														end;
													end;
												end;
			case"Cat3":				if(blank(params[i]))then begin
													GIr.BTRxThirdLevCat = GIr.BTRxGiftClass;
												end else begin
													TrHs = true;
													resetloop(BtrxThirdLevelCatr);
													BtrxThirdLevelCatr.Name = params[i];
													while(loopkey("Name",BtrxThirdLevelCatr,1,TrHs))begin
														if(BtrxThirdLevelCatr.Name!=params[i])then begin TrHs = false; end;
														
														if(TrHs)then begin
															if(BtrxThirdLevelCatr.PathScndCode==GIr.BTRxSecondLevCat)then begin
																if(nonblank(GIr.BTRxGiftClass))then begin
																	GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code & "," & GIr.BTRxGiftClass;
																end else begin
																	GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
																end;
															end;
														end;
													end;
													
												end;
												/*if(blank(params[i]))then begin
													GIr.BTRxThirdLevCat = "";
												end else begin
													pos = 0;
													BtrxThirdLevelCatr.Name = "";
													paramsStr = "";
													parametr = params[i];
													ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													while (nonblank(paramsStr)) begin
														if(nonblank(BtrxThirdLevelCatr.Name))then begin
															BtrxThirdLevelCatr.Name = BtrxThirdLevelCatr.Name & " ";
														end;
														BtrxThirdLevelCatr.Name = BtrxThirdLevelCatr.Name & paramsStr;
														ExtractObjWithSeparator("_",parametr,true,pos,paramsStr);
													end;
													if(readfirstkey("Name",BtrxThirdLevelCatr,1,true))then begin
														Name3catrus = BtrxThirdLevelCatr.NameRUS;
														Name3cataz = BtrxThirdLevelCatr.NameAZ;
														if(BtrxThirdLevelCatr.RelatedTo==GIr.BTRxSecondLevCat)then begin
															if(nonblank(GIr.BTRxThirdLevCat))then begin
																GIr.BTRxThirdLevCat = "," & GIr.BTRxThirdLevCat;
															end;
															GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code & GIr.BTRxThirdLevCat;
															pos = 0;
															BtrxThirdLevelCatr.Name = "";
															paramsStr = "";
															parametr = GIr.BTRxThirdLevCat;
															GIr.BTRxThirdLevCat = "";
															ExtractObjWithSeparator(",",parametr,true,pos,paramsStr);
															THRDf = false;
															while (nonblank(paramsStr)) begin
																BtrxThirdLevelCatr.Name = paramsStr;
																if(ReadFirstMain(BtrxThirdLevelCatr,1,true) and !THRDf)then begin
																	THRDf = true;
																	if(nonblank(GIr.BTRxThirdLevCat))then begin GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ","; end;
																	GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & paramsStr;
																end else begin
																	BtrxThirdLevelCatr.Name = paramsStr;
																	if(!ReadFirstMain(BtrxThirdLevelCatr,1,true)) then begin
																		if(nonblank(GIr.BTRxThirdLevCat))then begin GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ","; end;
																		GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & paramsStr;
																	end;
																end;
																ExtractObjWithSeparator(",",parametr,true,pos,paramsStr);
															end;
														end else begin

														end;
													end else begin
														BtrxThirdLevelCatr.Code = params[i];
														if(readfirstmain(BtrxThirdLevelCatr,1,true))then begin
															GIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
														end else begin
															GIr.BTRxThirdLevCat = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
														end;
													end;
												end;*/
			case"Name":				if(nonblank(params[i]))then begin GIr.Name = params[i]; end;
			case"NameRUS":		if(nonblank(params[i]))then begin GIr.NameRUS = params[i]; end;
			case"NameAZ":			if(nonblank(params[i]))then begin GIr.NameAZ = params[i]; end;
			case"Material":		if(blank(params[i]))then begin
													GIr.BPIMaterial = "";
												end else begin
													BTRxMaterialr.Name = params[i];
													if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
														GIr.BPIMaterial = BTRxMaterialr.Code;
													end else begin
														BTRxMaterialr.Code = params[i];
														if(readfirstmain(BTRxMaterialr,1,true))then begin
															GIr.BPIMaterial = BTRxMaterialr.Code;
														end else begin
															GIr.BPIMaterial = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
														end;
													end;
												end;
			case"Plating":		if(blank(params[i]))then begin
													GIr.BPIPlating = "";
												end else begin
													BTRxPlatingr.Name = params[i];
													if(readfirstkey("Name",BTRxPlatingr,1,true))then begin
														GIr.BPIPlating = BTRxPlatingr.Code;
													end else begin
														BTRxPlatingr.Code = params[i];
														if(readfirstmain(BTRxPlatingr,1,true))then begin
															GIr.BPIPlating = BTRxPlatingr.Code;
														end else begin
															GIr.BPIPlating = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxPlatingr.Code = "PLAT99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxPlatingr,1,TrHs)) begin
																// OldCode = BTRxPlatingr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxPlatingr);
															// recordnew(BTRxPlatingr);
															// if(blank(OldCode))then begin OldCode = "PLAT00000"; end;
															// NextM4SerialNumber(OldCode,BTRxPlatingr.Code);
															// BTRxPlatingr.Name = params[i];
															// recordinsert(BTRxPlatingr,true);
															// recordupdate(BTRxPlatingr,BTRxPlatingr,true);
															// GIr.BPIPlating = BTRxPlatingr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Gender":			if(blank(params[i]))then begin
													GIr.BPISex = "";
												end else begin
													BTRxSexr.Name = params[i];
													if(readfirstkey("Name",BTRxSexr,1,true))then begin
														GIr.BPISex = BTRxSexr.Code;
													end else begin
														BTRxSexr.Code = params[i];
														if(readfirstmain(BTRxSexr,1,true))then begin
															GIr.BPISex = BTRxSexr.Code;
														end else begin
															GIr.BPISex = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxSexr.Code = "SEX99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxSexr,1,TrHs)) begin
																// OldCode = BTRxSexr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxSexr);
															// recordnew(BTRxSexr);
															// if(blank(OldCode))then begin OldCode = "SEX00000"; end;
															// NextM4SerialNumber(OldCode,BTRxSexr.Code);
															// BTRxSexr.Name = params[i];
															// recordinsert(BTRxSexr,true);
															// recordupdate(BTRxSexr,BTRxSexr,true);
															// GIr.BPISex = BTRxSexr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Size":				if(blank(params[i]))then begin
													GIr.BPISize = "";
												end else begin
													BTRxSizer.Name = params[i];
													if(readfirstkey("Name",BTRxSizer,1,true))then begin
														GIr.BPISize = BTRxSizer.Code;
													end else begin
														BTRxSizer.Code = params[i];
														if(readfirstmain(BTRxSizer,1,true))then begin
															GIr.BPISize = BTRxSizer.Code;
														end else begin
															GIr.BPISize = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxSizer.Code = "SIZE99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxSizer,1,TrHs)) begin
																// OldCode = BTRxSizer.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxSizer);
															// recordnew(BTRxSizer);
															// if(blank(OldCode))then begin OldCode = "SIZE00000"; end;
															// NextM4SerialNumber(OldCode,BTRxSizer.Code);
															// BTRxSizer.Name = params[i];
															// recordinsert(BTRxSizer,true);
															// recordupdate(BTRxSizer,BTRxSizer,true);
															// GIr.BPISize = BTRxSizer.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Weight":			GIr.StrWeight = params[i];
			case"Volume":			GIr.StrVolume = params[i];
			case"Diameter":		GIr.StrBTRxDiam = params[i];
			case"Width":			GIr.StrWidth = params[i];
			case"Length":			GIr.StrDepth = params[i];
			case"Height":			GIr.StrHeight = params[i];
			case"SetQty":			GIr.StrBTRxSetQty = params[i];
			case"FinGirth":		GIr.BTRxFingerGirth = params[i];
			case"ProdColor":	if(blank(params[i]))then begin
													GIr.BTRxProdColour = "";
												end else begin
													BTRxColorr.Name = params[i];
													if(readfirstkey("Name",BTRxColorr,1,true))then begin
														GIr.BTRxProdColour = BTRxColorr.Code;
													end else begin
														BTRxColorr.Code = params[i];
														if(readfirstmain(BTRxColorr,1,true))then begin
															GIr.BTRxProdColour = BTRxColorr.Code;
														end else begin
															GIr.BTRxProdColour = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxColorr.Code = "CL99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxColorr,1,TrHs)) begin
																// OldCode = BTRxColorr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxColorr);
															// recordnew(BTRxColorr);
															// if(blank(OldCode))then begin OldCode = "CL00000"; end;
															// NextM4SerialNumber(OldCode,BTRxColorr.Code);
															// BTRxColorr.Name = params[i];
															// recordinsert(BTRxColorr,true);
															// recordupdate(BTRxColorr,BTRxColorr,true);
															// GIr.BTRxProdColour = BTRxColorr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Cert":				GIr.Cert = params[i];
			case"isLimit":		if(params[i]=="1")then begin GIr.BTRxLimitedGood = 1; end;
			case"Mech":				if(blank(params[i]))then begin
													GIr.BTRxWatchMechanism = "";
												end else begin
													BtrxWatchMechanr.Name = params[i];
													if(readfirstkey("Name",BtrxWatchMechanr,1,true))then begin
														GIr.BTRxWatchMechanism = BtrxWatchMechanr.Code;
													end else begin
														BtrxWatchMechanr.Code = params[i];
														if(readfirstmain(BtrxWatchMechanr,1,true))then begin
															GIr.BTRxWatchMechanism = BtrxWatchMechanr.Code;
														end else begin
															GIr.BTRxWatchMechanism = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxWatchMechanr.Code = "WTMEC9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatchMechanr,1,TrHs)) begin
																// OldCode = BtrxWatchMechanr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatchMechanr);
															// recordnew(BtrxWatchMechanr);
															// if(blank(OldCode))then begin OldCode = "WTMEC0000"; end;
															// NextM4SerialNumber(OldCode,BtrxWatchMechanr.Code);
															// BtrxWatchMechanr.Name = params[i];
															// recordinsert(BtrxWatchMechanr,true);
															// recordupdate(BtrxWatchMechanr,BtrxWatchMechanr,true);
															// GIr.BTRxWatchMechanism = BtrxWatchMechanr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"LifeTime":		if(blank(params[i]))then begin
													GIr.BTRxPowerReserve = "";
												end else begin
													BtrxPowerReserver.Name = params[i];
													if(readfirstkey("Name",BtrxPowerReserver,1,true))then begin
														GIr.BTRxPowerReserve = BtrxPowerReserver.Code;
													end else begin
														BtrxPowerReserver.Code = params[i];
														if(readfirstmain(BtrxPowerReserver,1,true))then begin
															GIr.BTRxPowerReserve = BtrxPowerReserver.Code;
														end else begin
															GIr.BTRxPowerReserve = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxPowerReserver.Code = "PWRES9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxPowerReserver,1,TrHs)) begin
																// OldCode = BtrxPowerReserver.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxPowerReserver);
															// recordnew(BtrxPowerReserver);
															// if(blank(OldCode))then begin OldCode = "PWRES0000"; end;
															// NextM4SerialNumber(OldCode,BtrxPowerReserver.Code);
															// BtrxPowerReserver.Name = params[i];
															// recordinsert(BtrxPowerReserver,true);
															// recordupdate(BtrxPowerReserver,BtrxPowerReserver,true);
															// GIr.BTRxPowerReserve = BtrxPowerReserver.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Strap":			if(blank(params[i]))then begin
													GIr.BPIStrap = "";
												end else begin
													BTRxStrapr.Name = params[i];
													if(readfirstkey("Name",BTRxStrapr,1,true))then begin
														GIr.BPIStrap = BTRxStrapr.Code;
													end else begin
														BTRxStrapr.Code = params[i];
														if(readfirstmain(BTRxStrapr,1,true))then begin
															GIr.BPIStrap = BTRxStrapr.Code;
														end else begin
															GIr.BPIStrap = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxStrapr.Code = "STRP99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxStrapr,1,TrHs)) begin
																// OldCode = BTRxStrapr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxStrapr);
															// recordnew(BTRxStrapr);
															// if(blank(OldCode))then begin OldCode = "STRP00000"; end;
															// NextM4SerialNumber(OldCode,BTRxStrapr.Code);
															// BTRxStrapr.Name = params[i];
															// recordinsert(BTRxStrapr,true);
															// recordupdate(BTRxStrapr,BTRxStrapr,true);
															// GIr.BPIStrap = BTRxStrapr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"StClolor":		if(blank(params[i]))then begin
													GIr.BTRxStrapColour = "";
												end else begin
													BTRxColorr.Name = params[i];
													if(readfirstkey("Name",BTRxColorr,1,true))then begin
														GIr.BTRxStrapColour = BTRxColorr.Code;
													end else begin
														BTRxColorr.Code = params[i];
														if(readfirstmain(BTRxColorr,1,true))then begin
															GIr.BTRxStrapColour = BTRxColorr.Code;
														end else begin
															GIr.BTRxStrapColour = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxColorr.Code = "CL99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxColorr,1,TrHs)) begin
																// OldCode = BTRxColorr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxColorr);
															// recordnew(BTRxColorr);
															// if(blank(OldCode))then begin OldCode = "CL00000"; end;
															// NextM4SerialNumber(OldCode,BTRxColorr.Code);
															// BTRxColorr.Name = params[i];
															// recordinsert(BTRxColorr,true);
															// recordupdate(BTRxColorr,BTRxColorr,true);
															// GIr.BTRxStrapColour = BTRxColorr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Com1":				if(blank(params[i]))then begin
													GIr.BTRxWatchGradeA = "";
												end else begin
													BtrxWatchGrader.Name = params[i];
													if(readfirstkey("Name",BtrxWatchGrader,1,true))then begin
														GIr.BTRxWatchGradeA = BtrxWatchGrader.Code;
													end else begin
														BtrxWatchGrader.Code = params[i];
														if(readfirstmain(BtrxWatchGrader,1,true))then begin
															GIr.BTRxWatchGradeA = BtrxWatchGrader.Code;
														end else begin
															GIr.BTRxWatchGradeA = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxWatchGrader.Code = "WTGRD9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatchGrader,1,TrHs)) begin
																// OldCode = BtrxWatchGrader.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatchGrader);
															// recordnew(BtrxWatchGrader);
															// if(blank(OldCode))then begin OldCode = "WTGRD0000"; end;
															// NextM4SerialNumber(OldCode,BtrxWatchGrader.Code);
															// BtrxWatchGrader.Name = params[i];
															// recordinsert(BtrxWatchGrader,true);
															// recordupdate(BtrxWatchGrader,BtrxWatchGrader,true);
															// GIr.BTRxWatchGradeA = BtrxWatchGrader.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Com2":				if(blank(params[i]))then begin
													GIr.BTRxWatchGradeB = "";
												end else begin
													BtrxWatchGrader.Name = params[i];
													if(readfirstkey("Name",BtrxWatchGrader,1,true))then begin
														GIr.BTRxWatchGradeB = BtrxWatchGrader.Code;
													end else begin
														BtrxWatchGrader.Code = params[i];
														if(readfirstmain(BtrxWatchGrader,1,true))then begin
															GIr.BTRxWatchGradeB = BtrxWatchGrader.Code;
														end else begin
															GIr.BTRxWatchGradeB = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxWatchGrader.Code = "WTGRD9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatchGrader,1,TrHs)) begin
																// OldCode = BtrxWatchGrader.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatchGrader);
															// recordnew(BtrxWatchGrader);
															// if(blank(OldCode))then begin OldCode = "WTGRD0000"; end;
															// NextM4SerialNumber(OldCode,BtrxWatchGrader.Code);
															// BtrxWatchGrader.Name = params[i];
															// recordinsert(BtrxWatchGrader,true);
															// recordupdate(BtrxWatchGrader,BtrxWatchGrader,true);
															// GIr.BTRxWatchGradeB = BtrxWatchGrader.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Com3":				if(blank(params[i]))then begin
													GIr.BTRxWatchGradeC = "";
												end else begin
													BtrxWatchGrader.Name = params[i];
													if(readfirstkey("Name",BtrxWatchGrader,1,true))then begin
														GIr.BTRxWatchGradeC = BtrxWatchGrader.Code;
													end else begin
														BtrxWatchGrader.Code = params[i];
														if(readfirstmain(BtrxWatchGrader,1,true))then begin
															GIr.BTRxWatchGradeC = BtrxWatchGrader.Code;
														end else begin
															GIr.BTRxWatchGradeC = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxWatchGrader.Code = "WTGRD9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatchGrader,1,TrHs)) begin
																// OldCode = BtrxWatchGrader.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatchGrader);
															// recordnew(BtrxWatchGrader);
															// if(blank(OldCode))then begin OldCode = "WTGRD0000"; end;
															// NextM4SerialNumber(OldCode,BtrxWatchGrader.Code);
															// BtrxWatchGrader.Name = params[i];
															// recordinsert(BtrxWatchGrader,true);
															// recordupdate(BtrxWatchGrader,BtrxWatchGrader,true);
															// GIr.BTRxWatchGradeC = BtrxWatchGrader.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Stone1":			if(blank(params[i]))then begin
													GIr.BTRxStoneA = "";
												end else begin
													BTRxStoner.Name = params[i];
													if(readfirstkey("Name",BTRxStoner,1,true))then begin
														GIr.BTRxStoneA = BTRxStoner.Code;
													end else begin
														BTRxStoner.Code = params[i];
														if(readfirstmain(BTRxStoner,1,true))then begin
															GIr.BTRxStoneA = BTRxStoner.Code;
														end else begin
															GIr.BTRxStoneA = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxStoner.Code = "STN99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxStoner,1,TrHs)) begin
																// OldCode = BTRxStoner.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxStoner);
															// recordnew(BTRxStoner);
															// if(blank(OldCode))then begin OldCode = "STN00000"; end;
															// NextM4SerialNumber(OldCode,BTRxStoner.Code);
															// BTRxStoner.Name = params[i];
															// recordinsert(BTRxStoner,true);
															// recordupdate(BTRxStoner,BTRxStoner,true);
															// GIr.BTRxStoneA = BTRxStoner.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Carat1":			GIr.BTRxStoneScattA = stringtoval(params[i],m4val);
			case"Stone2":			if(blank(params[i]))then begin
													GIr.BTRxStoneB = "";
												end else begin
													BTRxStoner.Name = params[i];
													if(readfirstkey("Name",BTRxStoner,1,true))then begin
														GIr.BTRxStoneB = BTRxStoner.Code;
													end else begin
														BTRxStoner.Code = params[i];
														if(readfirstmain(BTRxStoner,1,true))then begin
															GIr.BTRxStoneB = BTRxStoner.Code;
														end else begin
															GIr.BTRxStoneB = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxStoner.Code = "STN99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxStoner,1,TrHs)) begin
																// OldCode = BTRxStoner.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxStoner);
															// recordnew(BTRxStoner);
															// if(blank(OldCode))then begin OldCode = "STN00000"; end;
															// NextM4SerialNumber(OldCode,BTRxStoner.Code);
															// BTRxStoner.Name = params[i];
															// recordinsert(BTRxStoner,true);
															// recordupdate(BTRxStoner,BTRxStoner,true);
															// GIr.BTRxStoneB = BTRxStoner.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Carat2":			GIr.BTRxStoneScattB = stringtoval(params[i],m4val);
			case"Stone3":			if(blank(params[i]))then begin
													GIr.BTRxStoneC = "";
												end else begin
													BTRxStoner.Name = params[i];
													if(readfirstkey("Name",BTRxStoner,1,true))then begin
														GIr.BTRxStoneC = BTRxStoner.Code;
													end else begin
														BTRxStoner.Code = params[i];
														if(readfirstmain(BTRxStoner,1,true))then begin
															GIr.BTRxStoneC = BTRxStoner.Code;
														end else begin
															GIr.BTRxStoneC = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxStoner.Code = "STN99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxStoner,1,TrHs)) begin
																// OldCode = BTRxStoner.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxStoner);
															// recordnew(BTRxStoner);
															// if(blank(OldCode))then begin OldCode = "STN00000"; end;
															// NextM4SerialNumber(OldCode,BTRxStoner.Code);
															// BTRxStoner.Name = params[i];
															// recordinsert(BTRxStoner,true);
															// recordupdate(BTRxStoner,BTRxStoner,true);
															// GIr.BTRxStoneC = BTRxStoner.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Carat3":			GIr.BTRxStoneScattC = stringtoval(params[i],m4val);
			case"AllCarat":		GIr.BTRxPlacerScatt = stringtoval(params[i],m4val);
											
			case"Color":			if(blank(params[i]))then begin
													GIr.BPIColor = "";
												end else begin
													BTRxColorr.Name = params[i];
													if(readfirstkey("Name",BTRxColorr,1,true))then begin
														GIr.BPIColor = BTRxColorr.Code;
													end else begin
														BTRxColorr.Code = params[i];
														if(readfirstmain(BTRxColorr,1,true))then begin
															GIr.BPIColor = BTRxColorr.Code;
														end else begin
															GIr.BPIColor = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxColorr.Code = "CL99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxColorr,1,TrHs)) begin
																// OldCode = BTRxColorr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxColorr);
															// recordnew(BTRxColorr);
															// if(blank(OldCode))then begin OldCode = "CL00000"; end;
															// NextM4SerialNumber(OldCode,BTRxColorr.Code);
															// BTRxColorr.Name = params[i];
															// recordinsert(BTRxColorr,true);
															// recordupdate(BTRxColorr,BTRxColorr,true);
															// GIr.BPIColor = BTRxColorr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Odour":			if(blank(params[i]))then begin
													GIr.BPIOdour = "";
												end else begin
													BTRxOdourr.Name = params[i];
													if(readfirstkey("Name",BTRxOdourr,1,true))then begin
														GIr.BPIOdour = BTRxOdourr.Code;
													end else begin
														BTRxOdourr.Code = params[i];
														if(readfirstmain(BTRxOdourr,1,true))then begin
															GIr.BPIOdour = BTRxOdourr.Code;
														end else begin
															GIr.BPIOdour = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxOdourr.Code = "ODR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxOdourr,1,TrHs)) begin
																// OldCode = BTRxOdourr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxOdourr);
															// recordnew(BTRxOdourr);
															// if(blank(OldCode))then begin OldCode = "ODR00000"; end;
															// NextM4SerialNumber(OldCode,BTRxOdourr.Code);
															// BTRxOdourr.Name = params[i];
															// recordinsert(BTRxOdourr,true);
															// recordupdate(BTRxOdourr,BTRxOdourr,true);
															// GIr.BPIOdour = BTRxOdourr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Phone":			if(blank(params[i]))then begin
													GIr.BTRxPhoneModel = "";
												end else begin
													BtrxPhoneModelr.Name = params[i];
													if(readfirstkey("Name",BtrxPhoneModelr,1,true))then begin
														GIr.BTRxPhoneModel = BtrxPhoneModelr.Code;
													end else begin
														BtrxPhoneModelr.Code = params[i];
														if(readfirstmain(BtrxPhoneModelr,1,true))then begin
															GIr.BTRxPhoneModel = BtrxPhoneModelr.Code;
														end else begin
															GIr.BTRxPhoneModel = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxPhoneModelr.Code = "PHMOD9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxPhoneModelr,1,TrHs)) begin
																// OldCode = BtrxPhoneModelr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxPhoneModelr);
															// recordnew(BtrxPhoneModelr);
															// if(blank(OldCode))then begin OldCode = "PHMOD0000"; end;
															// NextM4SerialNumber(OldCode,BtrxPhoneModelr.Code);
															// BtrxPhoneModelr.Name = params[i];
															// recordinsert(BtrxPhoneModelr,true);
															// recordupdate(BtrxPhoneModelr,BtrxPhoneModelr,true);
															// GIr.BTRxPhoneModel = BtrxPhoneModelr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"ChaninMat":	if(blank(params[i]))then begin
													GIr.BTRxChainMaterial = "";
												end else begin
													BTRxMaterialr.Name = params[i];
													if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
														GIr.BTRxChainMaterial = BTRxMaterialr.Code;
													end else begin
														BTRxMaterialr.Code = params[i];
														if(readfirstmain(BTRxMaterialr,1,true))then begin
															GIr.BTRxChainMaterial = BTRxMaterialr.Code;
														end else begin
															GIr.BTRxChainMaterial = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxMaterialr.Code = "MATR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxMaterialr,1,TrHs)) begin
																// OldCode = BTRxMaterialr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxMaterialr);
															// recordnew(BTRxMaterialr);
															// if(blank(OldCode))then begin OldCode = "MATR00000"; end;
															// NextM4SerialNumber(OldCode,BTRxMaterialr.Code);
															// BTRxMaterialr.Name = params[i];
															// recordinsert(BTRxMaterialr,true);
															// recordupdate(BTRxMaterialr,BTRxMaterialr,true);
															// GIr.BTRxChainMaterial = BTRxMaterialr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"Fill":				if(blank(params[i]))then begin
													GIr.BTRxFilling = "";
												end else begin
													BtrxFillingr.Name = params[i];
													if(readfirstkey("Name",BtrxFillingr,1,true))then begin
														GIr.BTRxFilling = BtrxFillingr.Code;
													end else begin
														BtrxFillingr.Code = params[i];
														if(readfirstmain(BtrxFillingr,1,true))then begin
															GIr.BTRxFilling = BtrxFillingr.Code;
														end else begin
															GIr.BTRxFilling = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxFillingr.Code = "FILLN9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxFillingr,1,TrHs)) begin
																// OldCode = BtrxFillingr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxFillingr);
															// recordnew(BtrxFillingr);
															// if(blank(OldCode))then begin OldCode = "FILLN0000"; end;
															// NextM4SerialNumber(OldCode,BtrxFillingr.Code);
															// BtrxFillingr.Name = params[i];
															// recordinsert(BtrxFillingr,true);
															// recordupdate(BtrxFillingr,BtrxFillingr,true);
															// GIr.BTRxFilling = BtrxFillingr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"WaterRes":		if(blank(params[i]))then begin
													GIr.BTRxWatterRes = "";
												end else begin
													BtrxWatResr.Name = params[i];
													if(readfirstkey("Name",BtrxWatResr,1,true))then begin
														GIr.BTRxWatterRes = BtrxWatResr.Code;
													end else begin
														BtrxWatResr.Code = params[i];
														if(readfirstmain(BtrxWatResr,1,true))then begin
															GIr.BTRxWatterRes = BtrxWatResr.Code;
														end else begin
															GIr.BTRxWatterRes = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BtrxWatResr.Code = "WTRS9999";
															// TrHs = true;
															// while (LoopBackKey("Code",BtrxWatResr,1,TrHs)) begin
																// OldCode = BtrxWatResr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BtrxWatResr);
															// recordnew(BtrxWatResr);
															// if(blank(OldCode))then begin OldCode = "WTRS0000"; end;
															// NextM4SerialNumber(OldCode,BtrxWatResr.Code);
															// BtrxWatResr.Name = params[i];
															// recordinsert(BtrxWatResr,true);
															// recordupdate(BtrxWatResr,BtrxWatResr,true);
															// GIr.BTRxWatterRes = BtrxWatResr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"StrapMat":		if(blank(params[i]))then begin
													GIr.BTRxStrapMat = "";
												end else begin
													BTRxMaterialr.Name = params[i];
													if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
														GIr.BTRxStrapMat = BTRxMaterialr.Code;
													end else begin
														BTRxMaterialr.Code = params[i];
														if(readfirstmain(BTRxMaterialr,1,true))then begin
															GIr.BTRxStrapMat = BTRxMaterialr.Code;
														end else begin
															GIr.BTRxStrapMat = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxMaterialr.Code = "MATR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxMaterialr,1,TrHs)) begin
																// OldCode = BTRxMaterialr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxMaterialr);
															// recordnew(BTRxMaterialr);
															// if(blank(OldCode))then begin OldCode = "MATR00000"; end;
															// NextM4SerialNumber(OldCode,BTRxMaterialr.Code);
															// BTRxMaterialr.Name = params[i];
															// recordinsert(BTRxMaterialr,true);
															// recordupdate(BTRxMaterialr,BTRxMaterialr,true);
															// GIr.BTRxStrapMat = BTRxMaterialr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
			case"BracelMat":		if(blank(params[i]))then begin
													GIr.BTRxBracelMat = "";
												end else begin
													BTRxMaterialr.Name = params[i];
													if(readfirstkey("Name",BTRxMaterialr,1,true))then begin
														GIr.BTRxBracelMat = BTRxMaterialr.Code;
													end else begin
														BTRxMaterialr.Code = params[i];
														if(readfirstmain(BTRxMaterialr,1,true))then begin
															GIr.BTRxBracelMat = BTRxMaterialr.Code;
														end else begin
															GIr.BTRxBracelMat = "";
															ErrAr[ErrCnt] = param & ": " & params[i];
															ErrAr2[ErrCnt] = param & chr(09) & params[i];
															ErrCnt = ErrCnt + 1;
															// BTRxMaterialr.Code = "MATR99999";
															// TrHs = true;
															// while (LoopBackKey("Code",BTRxMaterialr,1,TrHs)) begin
																// OldCode = BTRxMaterialr.Code;
																// TrHs = false;
															// end;
															// ResetLoop(BTRxMaterialr);
															// recordnew(BTRxMaterialr);
															// if(blank(OldCode))then begin OldCode = "MATR00000"; end;
															// NextM4SerialNumber(OldCode,BTRxMaterialr.Code);
															// BTRxMaterialr.Name = params[i];
															// recordinsert(BTRxMaterialr,true);
															// recordupdate(BTRxMaterialr,BTRxMaterialr,true);
															// GIr.BTRxBracelMat = BTRxMaterialr.Code;
															// res = true;
															// OldCode = "";
														end;
													end;
												end;
				case"Collection":		if(blank(params[i]))then begin
															GIr.BtrxCollection = "";
														end else begin
															BtrxCollectionr.Name = params[i];
															if(readfirstkey("Name",BtrxCollectionr,1,true))then begin
																GIr.BtrxCollection = BtrxCollectionr.Code;
															end else begin
																BtrxCollectionr.Code = params[i];
																if(readfirstmain(BtrxCollectionr,1,true))then begin
																	GIr.BtrxCollection = BtrxCollectionr.Code;
																end else begin
																	GIr.BTRxBracelMat = "";
																	ErrAr[ErrCnt] = param & ": " & params[i];
																	ErrAr2[ErrCnt] = param & chr(09) & params[i];
																	ErrCnt = ErrCnt + 1;
																end;
															end;
														end;
				case"PF1":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF10":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF11":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF2":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF3":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF4":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF5":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF6":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF7":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF8":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PF9":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PG1":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PG2":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PG3":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO1":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO10":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO11":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO12":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO2":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO3":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO4":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO5":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO6":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO7":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO8":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				case"PO9":		if(nonblank(params[i]))then begin
												if(!SetInSet(params[i],GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & params[i];
												end;
												if(!SetInSet(params[i],GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & params[i];
												end;
											end;
				
			//otherwise res = false;
		end;
	end;
	SetItemBitrixClass = res;
return;
end;





global updating procedure AddClassInRegisters (string param,string name)
begin
	record BTRxBrandVc BTRxBrandr;
	record BTRxMaterialVc BTRxMaterialr;
	record BTRxColourVc BTRxColorr;
	record BTRxSizeVc BTRxSizer;
	record BTRxSexVc BTRxSexr;
	record BTRxPlatingVc BTRxPlatingr;
	record BTRxStoneVc BTRxStoner;
	record BTRxStrapVc BTRxStrapr;
	record BTRxOdourVc BTRxOdourr;
	record BtrxInternalCatVc BtrxInternalCatr;
	record BtrxFirstLevelCatVc BtrxFirstLevelCatr;
	record BtrxSecondLevelCatVc BtrxSecondLevelCatr;
	record BtrxThirdLevelCatVc BtrxThirdLevelCatr;
	record BtrxCertificateVc BtrxCertificater;
	record BtrxWatchMechanVc BtrxWatchMechanr;
	record BtrxPowerReserveVc BtrxPowerReserver;
	record BtrxWatchGradeVc BtrxWatchGrader;
	record BtrxPhoneModelVc BtrxPhoneModelr;
	record BtrxFillingVc BtrxFillingr;
	record BtrxTypeVc BtrxTyper;
	record BtrxWaterResistantVc BtrxWatResr;

	if(nonblank(param))then begin
		switch(param)begin
			case"IntCat": 		BtrxInternalCatr.Name = name;
												if(!readfirstkey("Name",BtrxInternalCatr,1,true))then begin
													recordnew(BtrxInternalCatr);
													BtrxInternalCatr.Name = name;
													recordinsert(BtrxInternalCatr,true);
													recordupdate(BtrxInternalCatr,BtrxInternalCatr,true);
												end;
			case"Type": 			BtrxTyper.Name = name;
												if(!readfirstkey("Name",BtrxTyper,1,true))then begin
													recordnew(BtrxTyper);
													BtrxTyper.Name = name;
													recordinsert(BtrxTyper,true);
													recordupdate(BtrxTyper,BtrxTyper,true);
												end;									
			case"Cat1":				BtrxFirstLevelCatr.Name = name;
												if(!readfirstkey("Name",BtrxFirstLevelCatr,1,true))then begin
													recordnew(BtrxFirstLevelCatr);
													BtrxFirstLevelCatr.Name = name;
													recordinsert(BtrxFirstLevelCatr,true);
													recordupdate(BtrxFirstLevelCatr,BtrxFirstLevelCatr,true);
												end;
			case"Cat2":				BtrxSecondLevelCatr.Name = name;
												if(!readfirstkey("Name",BtrxSecondLevelCatr,1,true))then begin
													recordnew(BtrxSecondLevelCatr);
													BtrxSecondLevelCatr.Name = name;
													recordinsert(BtrxSecondLevelCatr,true);
													recordupdate(BtrxSecondLevelCatr,BtrxSecondLevelCatr,true);
												end;
			case"Cat3":				BtrxThirdLevelCatr.Name = name;
												if(!readfirstkey("Name",BtrxThirdLevelCatr,1,true))then begin
													recordnew(BtrxThirdLevelCatr);
													BtrxThirdLevelCatr.Name = name;
													recordinsert(BtrxThirdLevelCatr,true);
													recordupdate(BtrxThirdLevelCatr,BtrxThirdLevelCatr,true);
												end;
			case"Material":		BtrxMaterialr.Name = name;
												if(!readfirstkey("Name",BtrxMaterialr,1,true))then begin
													recordnew(BtrxMaterialr);
													BtrxMaterialr.Name = name;
													recordinsert(BtrxMaterialr,true);
													recordupdate(BtrxMaterialr,BtrxMaterialr,true);
												end;
			case"Plating":		BtrxPlatingr.Name = name;
												if(!readfirstkey("Name",BtrxPlatingr,1,true))then begin
													recordnew(BtrxPlatingr);
													BtrxPlatingr.Name = name;
													recordinsert(BtrxPlatingr,true);
													recordupdate(BtrxPlatingr,BtrxPlatingr,true);
												end;
			case"Gender":			BtrxSexr.Name = name;
												if(!readfirstkey("Name",BtrxSexr,1,true))then begin
													recordnew(BtrxSexr);
													BtrxSexr.Name = name;
													recordinsert(BtrxSexr,true);
													recordupdate(BtrxSexr,BtrxSexr,true);
												end;
			case"Size":				BtrxSizer.Name = name;
												if(!readfirstkey("Name",BtrxSizer,1,true))then begin
													recordnew(BtrxSizer);
													BtrxSizer.Name = name;
													recordinsert(BtrxSizer,true);
													recordupdate(BtrxSizer,BtrxSizer,true);
												end;
			case"ProdColor":	BtrxColorr.Name = name;
												if(!readfirstkey("Name",BtrxColorr,1,true))then begin
													recordnew(BtrxColorr);
													BtrxColorr.Name = name;
													recordinsert(BtrxColorr,true);
													recordupdate(BtrxColorr,BtrxColorr,true);
												end;
			case"Mech":				BtrxWatchMechanr.Name = name;
												if(!readfirstkey("Name",BtrxWatchMechanr,1,true))then begin
													recordnew(BtrxWatchMechanr);
													BtrxWatchMechanr.Name = name;
													recordinsert(BtrxWatchMechanr,true);
													recordupdate(BtrxWatchMechanr,BtrxWatchMechanr,true);
												end;
			case"LifeTime":		BtrxPowerReserver.Name = name;
												if(!readfirstkey("Name",BtrxPowerReserver,1,true))then begin
													recordnew(BtrxPowerReserver);
													BtrxPowerReserver.Name = name;
													recordinsert(BtrxPowerReserver,true);
													recordupdate(BtrxPowerReserver,BtrxPowerReserver,true);
												end;
			case"Strap":			BtrxStrapr.Name = name;
												if(!readfirstkey("Name",BtrxStrapr,1,true))then begin
													recordnew(BtrxStrapr);
													BtrxStrapr.Name = name;
													recordinsert(BtrxStrapr,true);
													recordupdate(BtrxStrapr,BtrxStrapr,true);
												end;
			case"StClolor":		BtrxColorr.Name = name;
												if(!readfirstkey("Name",BtrxColorr,1,true))then begin
													recordnew(BtrxColorr);
													BtrxColorr.Name = name;
													recordinsert(BtrxColorr,true);
													recordupdate(BtrxColorr,BtrxColorr,true);
												end;
			case"Com":				BtrxWatchGrader.Name = name;
												if(!readfirstkey("Name",BtrxWatchGrader,1,true))then begin
													recordnew(BtrxWatchGrader);
													BtrxWatchGrader.Name = name;
													recordinsert(BtrxWatchGrader,true);
													recordupdate(BtrxWatchGrader,BtrxWatchGrader,true);
												end;
			case"Stone":			BtrxStoner.Name = name;
												if(!readfirstkey("Name",BtrxStoner,1,true))then begin
													recordnew(BtrxStoner);
													BtrxStoner.Name = name;
													recordinsert(BtrxStoner,true);
													recordupdate(BtrxStoner,BtrxStoner,true);
												end;
			case"Color":			BtrxColorr.Name = name;
												if(!readfirstkey("Name",BtrxColorr,1,true))then begin
													recordnew(BtrxColorr);
													BtrxColorr.Name = name;
													recordinsert(BtrxColorr,true);
													recordupdate(BtrxColorr,BtrxColorr,true);
												end;
			case"Odour":			BtrxOdourr.Name = name;
												if(!readfirstkey("Name",BtrxOdourr,1,true))then begin
													recordnew(BtrxOdourr);
													BtrxOdourr.Name = name;
													recordinsert(BtrxOdourr,true);
													recordupdate(BtrxOdourr,BtrxOdourr,true);
												end;
			case"Phone":			BtrxPhoneModelr.Name = name;
												if(!readfirstkey("Name",BtrxPhoneModelr,1,true))then begin
													recordnew(BtrxPhoneModelr);
													BtrxPhoneModelr.Name = name;
													recordinsert(BtrxPhoneModelr,true);
													recordupdate(BtrxPhoneModelr,BtrxPhoneModelr,true);
												end;
			case"ChaninMat":	BtrxMaterialr.Name = name;
												if(!readfirstkey("Name",BtrxMaterialr,1,true))then begin
													recordnew(BtrxMaterialr);
													BtrxMaterialr.Name = name;
													recordinsert(BtrxMaterialr,true);
													recordupdate(BtrxMaterialr,BtrxMaterialr,true);
												end;
			case"Fill":				BtrxFillingr.Name = name;
												if(!readfirstkey("Name",BtrxFillingr,1,true))then begin
													recordnew(BtrxFillingr);
													BtrxFillingr.Name = name;
													recordinsert(BtrxFillingr,true);
													recordupdate(BtrxFillingr,BtrxFillingr,true);
												end;
			case"WaterRes":		BtrxWatResr.Name = name;
												if(!readfirstkey("Name",BtrxWatResr,1,true))then begin
													recordnew(BtrxWatResr);
													BtrxWatResr.Name = name;
													recordinsert(BtrxWatResr,true);
													recordupdate(BtrxWatResr,BtrxWatResr,true);
												end;
		end;
	end;
return;
end;





global updating procedure ImportAddClassInRegistersIn(record RcVc RepSpec)
begin
record INVc INr,oldINr;
integer i,curcomp,cnt,j,k,CompQty;
record GlobalItemVc GIr;
string 100 artcode,brand,newBrand,code,glCode,tstr;
record BPIBrandVc BPIBrandr;
record BPIBrandVc BPIBrand1r;
array string 100 headers;
string 100 param;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
		
	BlockLoad(Compb);
	
	logtext(0,"start");
	CompQty = matrowcnt(Compb);
	curcomp = currentcompany;	
	
	tstr = importfield;
	if(tstr!=USetStr(36229))then begin
		logtext(0,"ImportAddClassIn codepage error");
		while (TestEOF()==false) begin
			if (NextImportLine(true)) then begin end;
		end;
		goto lImportAddClassInRegistersIn;
	end;
	if (NextImportLine(true)) then begin end;
	while(nonblank(tstr))begin
		tstr = importfield;
		if(nonblank(tstr))then begin
			StripEndingSpaces(tstr);
			headers[headers.length] = tstr;
		end;
	end;
	if (NextImportLine(true)) then begin end;

	while (TestEOF()==false) begin
		for(i=0;i<headers.length;i=i+1)begin
			param = importfield;
			if(nonblank(param))then begin
				AddClassInRegisters(headers[i],param);
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	lImportAddClassInRegistersIn:;
logtext(0,"end");
return;
end;






global updating procedure ImportGiftsSearchItemCodesFromBarIn(record RcVc RepSpec)
begin
	record INVc INr,oldINr;
	integer i,curcomp,cnt,j,k,CompQty,ErrCnt1,ErrCnt2,mtrw,INComp;
	record GlobalItemVc GIr;
	string 100 artcode,brand,newBrand,code,glCode,tstr,cntstr;
	record BPIBrandVc BPIBrandr;
	record BPIBrandVc BPIBrand1r;
	area ErrAr1, ErrAr2, reply;
	array string 255 abrand,anewbrand,ErrArr;
	array string 100 headers,params;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	vector boolean Errf;
	boolean Itemf;
	area ArtArea;

	cnt = 0;
	tstr = importfield;
	while (nonblank(tstr)) begin
		cnt = cnt + 1;
		tstr = importfield;
	end;
	if (NextImportLine(true)) then begin end;
	while (TestEOF()==false) begin
		Itemf = false;
		tstr = importfield;
		INr.Code = tstr;
		if(ReadFirstMain(INr,1,true))then begin
			GIr.Code = INr.GlobalArtCode;
			if(ReadFirstMain(GIr,1,true))then begin
				Itemf = true;
			end;
		end else begin
			INr.BarCode = tstr;
			if(ReadFirstKey("BarCode",INr,1,true))then begin
				GIr.Code = INr.GlobalArtCode;
				if(ReadFirstMain(GIr,1,true))then begin
					Itemf = true;
				end;
			end else begin
				INr.AlternativeCode = tstr;
				if(ReadFirstKey("AlternativeCode",INr,1,true))then begin
					GIr.Code = INr.GlobalArtCode;
					if(ReadFirstMain(GIr,1,true))then begin
						Itemf = true;
					end;
				end;
			end;
		end;
		if(Itemf)then begin
			tstr = importfield;
			for (i=0;i<cnt;i=i+1) begin
				switch(tstr)begin
					case"PF1":		if(nonblank(tstr))then begin
												if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
													if(nonblank(GIr.BTRxThirdLevCat))then begin
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
													end;
													GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
												end;
												if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
													if(nonblank(GIr.BTRxGiftClass))then begin
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
													end;
													GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
												end;
											end;
					case"PF10":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF11":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF2":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF3":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF4":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF5":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF6":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF7":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF8":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PF9":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PG1":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PG2":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PG3":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO1":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO10":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO11":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO12":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO2":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO3":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO4":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO5":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO6":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO7":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO8":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					case"PO9":		if(nonblank(tstr))then begin
													if(!SetInSet(tstr,GIr.BTRxThirdLevCat))then begin
														if(nonblank(GIr.BTRxThirdLevCat))then begin
															GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & ",";
														end;
														GIr.BTRxThirdLevCat = GIr.BTRxThirdLevCat & tstr;
													end;
													if(!SetInSet(tstr,GIr.BTRxGiftClass))then begin
														if(nonblank(GIr.BTRxGiftClass))then begin
															GIr.BTRxGiftClass = GIr.BTRxGiftClass & ",";
														end;
														GIr.BTRxGiftClass = GIr.BTRxGiftClass & tstr;
													end;
												end;
					
				end;
				tstr = importfield;
			end;
			if(Itemf and RecordStore(GIr,true))then begin
				logtext(0,GIr.Code);
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;



return;
end;



global updating procedure ImportSearchItemCodesFromBarIn(record RcVc RepSpec)
begin
	record INVc INr,oldINr;
	integer i,curcomp,cnt,j,k,CompQty,ErrCnt1,ErrCnt2,mtrw,INComp;
	record GlobalItemVc GIr;
	string 100 artcode,brand,newBrand,code,glCode,tstr,cntstr;
	record BPIBrandVc BPIBrandr;
	record BPIBrandVc BPIBrand1r;
	area ErrAr1, ErrAr2, reply;
	array string 255 abrand,anewbrand,ErrArr;
	array string 100 headers,params;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	vector boolean Errf;
	boolean Itemf;
	area ArtArea;
	
	curcomp = CurrentCompany;
	logtext(0,"start");
	AddTextToArea	("Code type" & chr(09) & "Source" & chr(09) & "Item Code" & chr(09) & "Company" & chr(13),ArtArea);
	while (TestEOF()==false) begin
		Itemf = false;
		tstr = importfield;
		if(nonblank(tstr))then begin
			BlockLoad(Compb);
			mtrw = matrowcnt(Compb);
			for (i=0;i<mtrw;i=i+1) begin
				matrowget(Compb,i,Comprw);
				if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32 and i+1!=29 and i+1!=18)then begin
					SetCompany(i+1,false);
					INr.Code = tstr;
					if(ReadFirstMain(INr,1,true))then begin
						AddTextToArea	("ItemCode: " & chr(09) & tstr & chr(09) & INr.Code & chr(09) & Comprw.ShortName & chr(13),ArtArea);
						logtext(0,"ItemCode: " & INr.Code);
						Itemf = true;
					end else begin
						INr.BarCode = tstr;
						if(ReadFirstKey("BarCode",INr,1,true))then begin
							AddTextToArea	("BarCode: " & chr(09) & tstr & chr(09) & INr.Code & chr(09) & Comprw.ShortName & chr(13),ArtArea);
							logtext(0,"ItemCode: " & INr.Code);
							Itemf = true;
						end else begin
							INr.AlternativeCode = tstr;
							if(ReadFirstKey("AlternativeCode",INr,1,true))then begin
								AddTextToArea	("AlternativeCode: " & chr(09) & tstr & chr(09) & INr.Code & chr(09) & Comprw.ShortName & chr(13),ArtArea);
								logtext(0,"ItemCode: " & INr.Code);
								Itemf = true;
							end;
						end;
					end;
				end;
			end;
			if(!Itemf)then begin
				AddTextToArea	("This code: " & chr(09) & tstr & chr(09) & "Not found!" & chr(13),ArtArea);
			end;
		end;
		ResetCompany(curcomp);
		if (NextImportLine(true)) then begin end;
	end;

	WriteAreaToFile	(ArtArea,"BTRxErrMail.txt",0);
	logtext(0,"finish");
	return;
end;


global updating procedure FindItemParamForCRMIn(record RcVc RepSpec)
begin
	record INVc INr,oldINr;
	integer i,curcomp,cnt,j,k,CompQty,ErrCnt1,ErrCnt2,mtrw,INComp;
	record GlobalItemVc GIr;
	string 100 type,item;
	area ErrAr1, ErrAr2, reply;
	vector string 255 agroup,asubgroup,acollection,acateg;
	record CompaniesBlock Compb;
	row CompaniesBlock Comprw;
	vector boolean Errf;
	boolean Itemf;
	area ArtArea;
	boolean TrHs;
	record BPIGroupVc BPIGroupr; 
	record BPISubGroupVc BPISubGroupr;
	record BPICollectionVc BPICollectionr;
	record BPICategoryVc BPICategoryr;
		
	while(loopmain(BPIGroupr,1,true))begin
		agroup[BPIGroupr.Code] = BPIGroupr.Name;
	end;
	while(loopmain(BPISubGroupr,1,true))begin
		asubgroup[BPISubGroupr.Code] = BPISubGroupr.Name;
	end;
	while(loopmain(BPICollectionr,1,true))begin
		acollection[BPICollectionr.Code] = BPICollectionr.Name;
	end;
	while(loopmain(BPICategoryr,1,true))begin
		acateg[BPICategoryr.Code] = BPICategoryr.Name;
	end;
	
	curcomp = CurrentCompany;
	logtext(0,"start FindItemParamForCRMIn");
	AddTextToArea	("ItemCode" & chr(09) & "Group" & chr(09) & chr(09) & "SubGroup" & chr(09) & chr(09) & "Collection" & chr(09) & chr(09) & "Category" & chr(13),ArtArea);
	while (TestEOF()==false) begin
		type = importfield;
		item = importfield;
		
		TrHs = true;
		resetloop(GIr);
		GIr.HansaCode = item;
		while(loopkey("HansaCode",GIr,1,TrHs))begin
			if(GIr.HansaCode!=item)then begin TrHs = false; end;
			
			if(TrHs and GIr.BPISubGroup==type)then begin
					AddTextToArea	(GIr.HansaCode & chr(09) & GIr.BPIGroup & chr(09) & agroup[GIr.BPIGroup] & chr(09) & GIr.BPISubGroup & chr(09) & asubgroup[GIr.BPISubGroup] & chr(09) & GIr.BPICollection & chr(09) & acollection[GIr.BPICollection] & chr(09) & GIr.BPICategory & chr(09) & acateg[GIr.BPICategory] & chr(13),ArtArea);
			end;
		end;
		
		if (NextImportLine(true)) then begin end;
	end;
	createfile("CRMItemsParams.txt");
	WriteAreaToFile	(ArtArea,"CRMItemsParams.txt",0);
	logtext(0,"finish FindItemParamForCRMIn");
	return;
end;






global updating procedure ImportAddMainItemIn(record RcVc RepSpec)
begin
record INVc INr,oldINr;
integer i,curcomp,cnt,j,k,CompQty,ErrCnt1,ErrCnt2,mtrw,INComp,pos;
record GlobalItemVc GIr, MainGIr;
string 100 artcode,brand,newBrand,code,glCode,tstr,cntstr,OldCode,lev3cat, LevCode;
record BPIBrandVc BPIBrandr;
record BPIBrandVc BPIBrand1r;
area ErrAr1, ErrAr2, reply;
array string 255 abrand,anewbrand,ErrArr;
array string 100 headers,params;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
vector boolean Errf;
boolean INrf, TrHs2;
record BtrxThirdLevelCatVc BtrxThirdLevelCatr, BTLLastCoder;

		
	i = 0;
	k = 0;
	logtext(0,"start");
	while (TestEOF()==false) begin
		brand = ImportField;
		artcode = ImportField;
		if(nonblank(brand) and nonblank(artcode))then begin
			BPIBrandr.Name = brand;
			if(readfirstkey("Name",BPIBrandr,1,true))then begin
				artcode = BPIBrandr.Code & "_" & artcode;
				GIr.Code = artcode;
				if(readfirstmain(GIr,1,true))then begin
					glCode = ImportField;
					MainGIr.Code = glCode;
					if(ReadFirstMain(MainGIr,1,true))then begin
						GIr.MainCode = MainGIr.Code;
						GIr.MainItemFlag = 1;
						GIr.IsVariant = 1;
						if(RecordStore(GIr,true))then begin
							logtext(0,GIr.Code & "  Updated MainCode");
						end;
					end else begin
						MainGIr.Code = glCode;
						MainGIr.Brand = brand;
						MainGIr.NameRUS = ImportField;
						MainGIr.Name = ImportField;
						MainGIr.BTRxFirstLevCat = GIr.BTRxFirstLevCat;
						MainGIr.BTRxSecondLevCat = GIr.BTRxSecondLevCat;
						MainGIr.MainItemFlag = 0;
						MainGIr.IsVariant = 1;
						MainGIr.BPIBrand = GIr.BPIBrand;
						MainGIr.AlternativeCode = glCode;
						MainGIr.HansaCode = glCode;
						lev3cat = GIr.BTRxThirdLevCat;
						pos = 0;
						ExtractObjWithSeparator(",",lev3cat,true,pos,LevCode);
						while (nonblank(LevCode) and left(LevCode,5)=="THLVL") begin
							BtrxThirdLevelCatr.Code = LevCode;
							if(ReadFirstmain(BtrxThirdLevelCatr,1,true))then begin
								MainGIr.BTRxThirdLevCat = BtrxThirdLevelCatr.Code;
							end;
							ExtractObjWithSeparator(",",lev3cat,true,pos,LevCode);
						end;
						if(RecordStore(MainGIr,true))then begin
							logtext(0,MainGIr.Code & "  Created MainItem");
							GIr.MainCode = MainGIr.Code;
							GIr.MainItemFlag = 1;
							GIr.IsVariant = 1;
							if(RecordStore(GIr,true))then begin
								logtext(0,GIr.Code & "  Updated MainCode");
							end;
						end;
					end;
				end;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	
return;
end;











//  Import("ˆìïîðò ïàðàìåòðîâ òîâàðîâ äëß Bitrix",ImportIClass,ImportAddClassIn,modBtrx);
// 36229 = ðîâåðêà êîäèðîâêè
global updating procedure ImportAddClassIn(record RcVc RepSpec)
begin
record INVc INr,oldINr;
integer i,curcomp,cnt,j,k,CompQty,ErrCnt1,ErrCnt2,mtrw,INComp,StatAllRows,StatOkRows,StatFailItemRows,StatFailClassRows,ErrClasscnt,ErrCnt3;
record GlobalItemVc GIr;
string 100 artcode,brand,newBrand,code,glCode,tstr,cntstr,origartcode;
record BPIBrandVc BPIBrandr;
record BPIBrandVc BPIBrand1r;
area ErrAr1, ErrAr2, reply;
array string 255 abrand,anewbrand,ErrArr,ErrAr3;
array string 100 headers,params;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
vector boolean Errf, Classf;
array string 255 Class;
boolean INrf;
		
	BlockLoad(Compb);
	
	logtext(0,"start");
	CompQty = matrowcnt(Compb);
	curcomp = currentcompany;	
	//SetImportCodePage("CP1251");
	SetCompany(1,false);
	tstr = importfield;
	tstr = right(tstr,(len(tstr)-1));
	logtext(0,tstr);
	logtext(0,USetStr(36229));
	if(tstr!=USetStr(36229))then begin
		logtext(0,"ImportAddClassIn codepage error");
		while (TestEOF()==false) begin
			if (NextImportLine(true)) then begin end;
		end;
		goto lImportAddClassIn;
	end;
	if (NextImportLine(true)) then begin end;
	tstr = importfield;
	//tstr = importfield;
	while(nonblank(tstr))begin
		tstr = importfield;
		if(nonblank(tstr))then begin
			StripEndingSpaces(tstr);
			headers[headers.length] = tstr;
		end;
	end;
	if (NextImportLine(true)) then begin end;
	ErrCnt1 = 2;
	AddTextToArea	(USetStr(36266) & chr(09) & USetStr(36267) & chr(09) & USetStr(36268) & chr(09) & USetStr(36269) & chr(13),ErrAr1);
	StatAllRows = 0;
	StatOkRows = 0;
	StatFailItemRows = 0;
	StatFailClassRows = 0;
	ErrClasscnt = 0;
	while (TestEOF()==false) begin
		StatAllRows = StatAllRows + 1;
		for(i=0;i<headers.length;i=i+1)begin
			params[i] = "";
		end;
		cnt = cnt + 1;
		artcode = importfield;
		StripEndingSpaces(artcode);
		origartcode = artcode;
		brand = importfield;
		StripEndingSpaces(brand);
		params[0] = brand;
		for(i=1;i<headers.length;i=i+1)begin
			tstr = importfield;
			params[i] = tstr;
		end;
		BPIBrandr.Name = brand;
		if(readfirstkey("Name",BPIBrandr,1,true))then begin
			mtrw = matrowcnt(Compb);
			INrf = false;
			INComp = 0;
			for (i=0;i<mtrw;i=i+1) begin
				matrowget(Compb,i,Comprw);
				if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32)then begin
					SetCompany(i+1,false);
					INr.Code = artcode;
					if(ReadFirstMain(INr,1,true))then begin
						if(INr.BPIBrand==BPIBrandr.Code)then begin 
							INComp = i+1;
							INrf = true; 
							i = mtrw;
						end;
					end;
				end;
			end;
			resetcompany(curcomp);
			artcode = BPIBrandr.Code & "_" & artcode;
			GIr.Code = artcode;
			if(readfirstmain(GIr,1,true))then begin
				ErrCnt2 = 0;
				if(SetItemBitrixClass(GIr,headers,params,ErrArr,ErrCnt2,ErrAr3))then begin
					if(ErrCnt2>0)then begin
						ErrCnt1 = ErrCnt1 + 1;
						AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & brand & chr(09) & USetStr(36264) & chr(09),ErrAr1);
						for (i=0;i<ErrCnt2;i=i+1) begin
							AddTextToArea	((i+1) & ". " & ErrArr[i] & " - " & USetStr(36238) & chr(09),ErrAr1);
							if(!Classf[ErrArr[i]])then begin
								Classf[ErrArr[i]] = true;
								Class[ErrClasscnt] = ErrAr3[i];
								ErrClasscnt = ErrClasscnt + 1;
							end;
						end;
						AddTextToArea	(chr(13),ErrAr1);
						StatFailClassRows = StatFailClassRows + 1;
					end else begin
						ErrCnt1 = ErrCnt1 + 1;
						AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & brand &  chr(09) & USetStr(36265) & chr(13),ErrAr1);
						StatOkRows = StatOkRows + 1;
					end;
					recordstore(GIr,true);
				end;
			end else begin
				if(!INrf)then begin
					ErrCnt1 = ErrCnt1 + 1;
					AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & brand & chr(09) & USetStr(36237) & chr(13),ErrAr1);
					StatFailItemRows = StatFailItemRows + 1;
				end else begin
					SetCompany(INComp,false);
					CreateNewGlobalItem(INr);
					ResetCompany(curcomp);
					GIr.Code = BPIBrandr.Code & "_" & artcode;
					if(readfirstmain(GIr,1,true))then begin
						ErrCnt2 = 0;
						if(SetItemBitrixClass(GIr,headers,params,ErrArr,ErrCnt2,ErrAr3))then begin
							if(ErrCnt2>0)then begin
								ErrCnt1 = ErrCnt1 + 1;
								AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & brand & chr(09) & USetStr(36264) & chr(09),ErrAr1);
								for (i=0;i<ErrCnt2;i=i+1) begin
									AddTextToArea	((i+1) & ". " & ErrArr[i] & " - " & USetStr(36238) & chr(09),ErrAr1);
									if(!Classf[ErrArr[i]])then begin
										Classf[ErrArr[i]] = true;
										Class[ErrClasscnt] = ErrAr3[i];
										ErrClasscnt = ErrClasscnt + 1;
									end;
								end;
								AddTextToArea	(chr(13),ErrAr1);
								StatFailClassRows = StatFailClassRows + 1;
							end else begin
								ErrCnt1 = ErrCnt1 + 1;
								AddTextToArea	(ErrCnt1 & chr(09) & chr(09)  & origartcode  & chr(09) & brand &  chr(09) & USetStr(36265) & chr(13),ErrAr1);
								StatOkRows = StatOkRows + 1;
							end;
							recordstore(GIr,true);
						end;
					end;
				end;
			end;
		end else begin
			BPIBrandr.Code = brand;
			if(readfirstkey("Code",BPIBrandr,1,true))then begin
				mtrw = matrowcnt(Compb);
				INrf = false;
				INComp = 0;
				for (i=0;i<mtrw;i=i+1) begin
					matrowget(Compb,i,Comprw);
					if(Comprw.ActiveStatus==0 and (!CompanyIsJWLikeCompany(i+1) or i+1==3) and i+1!=10 and i+1!=32)then begin
						SetCompany(i+1,false);
						INr.Code = artcode;
						if(ReadFirstMain(INr,1,true))then begin
							if(INr.BPIBrand==brand)then begin 
								INComp = i+1;
								INrf = true; 
								i = mtrw;
							end;
						end;
					end;
				end;
				resetcompany(curcomp);
				artcode = BPIBrandr.Code & "_" & artcode;
				GIr.Code = artcode;
				if(readfirstmain(GIr,1,true))then begin
					ErrCnt2 = 0;
					if(SetItemBitrixClass(GIr,headers,params,ErrArr,ErrCnt2,ErrAr3))then begin
						if(ErrCnt2>0)then begin
							ErrCnt1 = ErrCnt1 + 1;
							AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & brand & USetStr(36264) & chr(09),ErrAr1);
							for (i=0;i<ErrCnt2;i=i+1) begin
								AddTextToArea	((i+1) & ". " & ErrArr[i] & " - " & USetStr(36238) & chr(09),ErrAr1);
								if(!Classf[ErrArr[i]])then begin
									Classf[ErrArr[i]] = true;
									Class[ErrClasscnt] = ErrAr3[i];
									ErrClasscnt = ErrClasscnt + 1;
								end;
							end;
							AddTextToArea	(chr(13),ErrAr1);
							StatFailClassRows = StatFailClassRows + 1;
						end else begin
							ErrCnt1 = ErrCnt1 + 1;
							AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & brand &  chr(09) & USetStr(36265) & chr(13),ErrAr1);
							StatOkRows = StatOkRows + 1;
						end;
						recordstore(GIr,true);
					end;
				end else begin
					if(!INrf)then begin
						ErrCnt1 = ErrCnt1 + 1;
						AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & chr(09) & chr(09) & brand & chr(09) & USetStr(36237) & chr(13),ErrAr1);
						StatFailItemRows = StatFailItemRows + 1;
					end else begin
						SetCompany(INComp,false);
						CreateNewGlobalItem(INr);
						ResetCompany(curcomp);
						GIr.Code = BPIBrandr.Code & "_" & artcode;
						if(readfirstmain(GIr,1,true))then begin
							ErrCnt2 = 0;
							if(SetItemBitrixClass(GIr,headers,params,ErrArr,ErrCnt2,ErrAr3))then begin
								if(ErrCnt2>0)then begin
									ErrCnt1 = ErrCnt1 + 1;
									AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & brand & USetStr(36264) & chr(09),ErrAr1);
									for (i=0;i<ErrCnt2;i=i+1) begin
										AddTextToArea	((i+1) & ". " & ErrArr[i] & " - " & USetStr(36238) & chr(09),ErrAr1);
										if(!Classf[ErrArr[i]])then begin
											Classf[ErrArr[i]] = true;
											Class[ErrClasscnt] = ErrAr3[i];
											ErrClasscnt = ErrClasscnt + 1;
										end;
									end;
									AddTextToArea	(chr(13),ErrAr1);
									StatFailClassRows = StatFailClassRows + 1;
								end else begin
									ErrCnt1 = ErrCnt1 + 1;
									AddTextToArea	(ErrCnt1 & chr(09) & origartcode & chr(09) & brand & chr(09) & USetStr(36265) & chr(13),ErrAr1);
									StatOkRows = StatOkRows + 1;
								end;
								recordstore(GIr,true);
							end;
						end;
					end;
				end;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	// j = 0;
	// for (i=0;i<ErrCnt2;i=i+1) begin
		// if(!Errf[ErrArr[i]])then begin
			// j = j + 1;
			// Errf[ErrArr[i]] = true;
			// AddTextToArea	(j & ". " & USetStr(36238) & ": " & ErrArr[i] & ";" & chr(13),ErrAr1);
		// end;
	// end;
	AddTextToArea	(USetStr(36272) & chr(09) & chr(09) & chr(09) & StatAllRows & chr(13),ErrAr2);
	AddTextToArea	(USetStr(36273) & chr(09) & chr(09) & chr(09) & StatOkRows & chr(13),ErrAr2);
	AddTextToArea	(USetStr(36274) & chr(09) & chr(09) & chr(09) & StatFailItemRows & chr(13),ErrAr2);
	AddTextToArea	(USetStr(36275) & chr(09) & chr(09) & chr(09) & StatFailClassRows & chr(13),ErrAr2);
	AddTextToArea	(USetStr(36276) & chr(09) & chr(09) & chr(09) & ErrClasscnt & chr(13),ErrAr2);
	AddTextToArea	(chr(09) &  chr(09) &  chr(09) & USetStr(36277) & chr(09) & USetStr(36278) & chr(09) & USetStr(36279) & chr(13),ErrAr2);
	for (i=0;i<ErrClasscnt;i=i+1) begin
		AddTextToArea	( chr(09) &  chr(09) &  chr(09) & (i+1) & chr(09) & Class[i] & chr(13),ErrAr2);
	end;
	
	AddTextToArea	(chr(13),ErrAr2);

	
	AddAreaAfterArea(ErrAr2,ErrAr1);
	WriteAreaToFile	(ErrAr1,"BTRxErrMail.txt",0);
	resetcompany(curcomp);
	lImportAddClassIn:;
logtext(0,"end");
return;
end;











 // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 13:11 20.08.2019
 
 
 
 
 
global updating procedure ImportNewItemWAllClassIn(record RcVc RepSpec)
begin
record INVc INr,oldINr,ConsINr,OldConsINr;
integer i,curcomp,cnt,j,k,CompQty,ErrCnt1,ErrCnt2,mtrw,INComp,StatAllRows,StatOkRows,StatFailItemRows,StatFailClassRows,ErrClasscnt,ErrCnt3,HeadrCnt;
record GlobalItemVc GIr;
string 100 artcode,EANCode,VECode,brand,newBrand,code,glCode,tstr,cntstr,origartcode,OldCode;
record BPIBrandVc BPIBrandr;
record BPIBrandVc BPIBrand1r;
area ErrAr1, ErrAr2, reply;
array string 255 abrand,anewbrand,ErrArr,ErrAr3;
array string 100 headers,params;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
vector boolean Errf, Classf;
array string 255 Class;
boolean INrf, TrHs, TrHs2;
record ConsItemVc CIr, OldCIr;
		
	BlockLoad(Compb);
	
	logtext(0,"start");
	CompQty = matrowcnt(Compb);
	curcomp = currentcompany;	
	SetCompany(1,false);
	tstr = importfield;
	tstr = right(tstr,(len(tstr)-1));
	logtext(0,tstr);
	logtext(0,USetStr(36229));
	if(tstr!=USetStr(36229))then begin
		logtext(0,"ImportAddClassIn codepage error");
		while (TestEOF()==false) begin
			if (NextImportLine(true)) then begin end;
		end;
		goto lImportNewItemWAllClass;
	end;
	if (NextImportLine(true)) then begin end;
	tstr = importfield;
	tstr = importfield;
	tstr = importfield;
	tstr = importfield;
	HeadrCnt = 0;
	while(nonblank(tstr))begin
		tstr = importfield;
		if(nonblank(tstr))then begin
			StripEndingSpaces(tstr);
			headers[headers.length] = tstr;
			logtext(0,tstr);
		end else begin
			headers[headers.length] = "HField";
			tstr = "HField";
		end;
	end;
	if (NextImportLine(true)) then begin end;
	if (NextImportLine(true)) then begin end;
	while (TestEOF()==false) begin
		SetCompany(18,false);
		artcode = importfield;
		VECode = importfield;
		EANCode = importfield;
		brand = importfield;
		for(i=0;i<headers.length;i=i+1)begin
			params[i] = "";
		end;
		for(i=0;i<headers.length;i=i+1)begin
			tstr = importfield;
			params[i] = tstr;
		end;
		CIr.LocCode = artcode;
		CIr.BrandCode = brand;
		if(!ReadFirstKey("LocCodeBrand",CIr,2,true))then begin
			recordNew(ConsINr);
			OldConsINr.Code = "IN_9999999";
			TrHs2 = true;
			while (LoopBackKey("Code",OldConsINr,1,TrHs2)) begin
				OldCode = OldConsINr.Code;
				TrHs2 = false;
			end;
			ResetLoop(OldConsINr);
			if(blank(OldCode)) then begin oldCode = "IN_0000000"; end;
			NextM4SerialNumber(OldCode,ConsINr.Code);
			ConsINr.BPIBrand = brand;
			if(RecordStore(ConsINr,true))then begin
				recordNew(CIr);
				CIr.Code = ConsINr.Code;
				CIr.LocCode = artcode;
				CIr.BrandCode = brand;
				if(RecordStore(CIr,true)) then begin
					// CheckClassifGLImport(headers,params,ConsINr);
				end;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	
	
	lImportNewItemWAllClass:;
return;
end;
 
 
 
 
 
 
 // _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_- Anton Preisinger 13:11 20.08.2019











global function boolean IDOkedSHs(longint ORSer)
begin
record ORVc ORr;
row ORVc ORrw;
Integer wn,i,rwcnt,rownr;
val pt;
Boolean deliveredf, TrHs, testf;
record SHVc SHr;

	SHr.OrderNr = ORSer;
	TrHs = true;
	testf = true;
	while (loopkey("OrderKey",SHr,1,TrHs)) begin
		if(SHr.OrderNr != ORSer) then begin TrHs = false; end;
		if(TrHs and SHr.OKFlag==1)then begin testf = false; end;
	end;
IDOkedSHs = testf;
RETURN;
end;




global updating procedure ReturnOldNamesINIn(record RcVc RepSpec)
begin
record INVc INr,oldINr;
integer i,curcomp,cnt,j,k,CompQty;
record GlobalItemVc GIr;
string 100 artcode,brand,newBrand,code,glCode,tstr;
record BPIBrandVc BPIBrandr;
record BPIBrandVc BPIBrand1r;
array string 100 abrand,anewbrand;
array string 100 headers,params;
record CompaniesBlock Compb;
row CompaniesBlock Comprw;
boolean TrHs1, TrHs, TrHs2;
record RHistVc RHistr;
string 200 rstr;
		
	BlockLoad(Compb);

	while (TestEOF()==false) begin
		artcode = importfield;
		StripEndingSpaces(artcode);
		brand = importfield;
		StripEndingSpaces(brand);
		BPIBrandr.Name = brand;
		TrHs2 = true;
		if(readfirstkey("Name",BPIBrandr,1,true))then begin
			INr.Code = artcode;
			while(LoopMain(INr,1,TrHs2))begin
				if(INr.BPIBrand==BPIBrandr.Code)then begin
					TrHs2 = false;
					resetloop(RHistr);
					TrHs1 = true;
					rstr = BuildRecordIdStr(INr,currentcompany);
	  			RHistr.RecidStr = rstr;
					while(loopbackkey("RecidStr",RHistr,1,TrHs1)) begin		
						if(TrHs1)then begin
							logtext(0,RHistr.TransDate);
							ReadOriginalRecord(RHistr,oldINr);
							if(oldINr.Code!=INr.Code)then begin TrHs1 = false; end;
							if(nonblank(oldINr.Name) and RHistr.TransDate<AddMonth(CurrentDate,-1) and TrHs1)then begin
								INr.Name = oldINr.Name;
								recordstore(INr,true);
								logtext(0,INr.Code);
								TrHs1 = false;
							end;
						end;
					end;
					ResetLoop(RHistr);
				end else begin
					TrHs2 = false;
				end;
			end;
			ResetLoop(INr);
		end;
		if (NextImportLine(true)) then begin end;
	end;
	
	lImportAddClassIn:;
logtext(0,"end");
return;
end;


global updating procedure ImportFixToCoin()
begin
	record INVc INr;
	string 100 code;
	
	while (TestEOF()==false) begin
	code = importfield;
	
	//EditField(h,v+=vs,80,"Šîëëåêöèß",Normal,SN,false,0);
	//EditField(h+180,v,80,"àèì.êîëë.",Normal,MainDisp,false,0); 
	//EditField(h+360,v,80,"Œîäåëü",Normal,SNOne,false,0); 
	//EditField(h,v+=vs, 140,"Šîëëåêöèß",Normal,Reference,false,0); 

	INr.Code = code;
	if(readfirstmain(INr,1,true))then begin
		if(nonblank(INr.MainDisp))then begin
			INr.Reference = INr.MainDisp;
		end;
		if(nonblank(INr.SNOne))then begin
			INr.MainDisp = INr.SNOne;
			INr.MainDisp = StrReplace(INr.MainDisp,"_"," ");
			INr.SNOne = "";
		end;
		recordstore(INr,true);
	end;
	
	if (NextImportLine(true)) then begin end;
	end;
return;
end;



global updating procedure ImportFixGlobalItems3level()
begin
	record GlobalItemVc GIr;
	string 100 code,param;
	vector string 255 gift;
	
	while (TestEOF()==false) begin
		code = importfield;
		param = importfield;
		if(nonblank(param) and nonblank(code))then begin
			if(blank(gift[code]))then begin
				gift[code] = param;
			end else begin
				gift[code] = gift[code] & "," & param;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	
	
	while(loopmain(GIr,1,true))begin
		if(nonblank(gift[GIr.Code]))then begin
			if(gift[GIr.Code]!=GIr.BTRxThirdLevCat)then begin
				logtext(0,GIr.Code & "|" & GIr.BTRxThirdLevCat & " -> " & gift[GIr.Code]);
				GIr.BTRxThirdLevCat = gift[GIr.Code];
				recordstore(GIr,true);
			end;
		end;
	end;
	
return;
end;

global updating procedure FixCRMSum()
begin
	record GlobalItemVc GIr;
	string 100 code,param;
	vector string 255 gift;
	record IVVc IVr;
	area output;
	
	while (TestEOF()==false) begin
		code = importfield;
		param = importfield;
		
		if(setcompany(stringtoint(code),false))then begin
			IVr.SerNr = stringtolongint(param);
			if(readfirstmain(IVr,1,true))then begin
				if(nonblank(IVr.CRMid))then begin
					addtexttoarea(IVr.CRMid,output);
					addtexttoarea(chr(9),output);
					addtexttoarea(valtostring(IVr.Sum4,M45Val,"",".",0),output);
					addtexttoarea(chr(13) & chr(10),output);
				end else begin
					logtext(0,currentcompany & " " & IVr.SerNr & " " & "NoCRMId");
				end;
			end else begin
				logtext(0,currentcompany & " " & IVr.SerNr & " " & "NoRecord");
			end;
		end;
		
		if (NextImportLine(true)) then begin end;		
	end;
	writeareatofile(output,"WrongSum.txt",1);
	
return;
end;


global updating procedure ClearFIOCUVcIn(record RcVc RepSpec)
begin
record CUVc CUr;
string 20 tstr;
	
	logtext(0,"start");

	while (TestEOF()==false) begin	
	
		tstr = importfield;
		if(nonblank(tstr))then begin
			CUr.Code = tstr;
			logtext(0,"ClearFIOCUVcIn " & CUr.Code);
			if(readfirstmain(CUr,1,true))then begin
				CUr.CRMLName = "";
				CUr.CRMName = "";
				CUr.CRMPatr = "";
				recordstore(CUr,true);
			end;
		end;
	
		if (NextImportLine(true)) then begin end;
	end;

logtext(0,"end");
return;
end;

global updating procedure CRMUpdateFIOCUVcIn(record RcVc RepSpec)
begin
record CUVc CUr;
string 20 tstr;
	
	logtext(0,"start");

	while (TestEOF()==false) begin	
	
		tstr = importfield;
		if(nonblank(tstr))then begin
			CUr.Code = tstr;
			if(readfirstmain(CUr,1,true))then begin
				logtext(0,"CRMUpdateFIOCUVcIn " & CUr.Code);
				SendAsyncUpdateContactToCRM(CUr);
				millisleep(500);
			end;
		end;
	
		if (NextImportLine(true)) then begin end;
	end;

logtext(0,"end");
return;
end;
