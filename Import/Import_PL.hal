//server-only
external function val AbsoluteVal(val);
external function roundmode SetRoundModeD(Integer);
external procedure NoDupObjs(string,var string);
external procedure ExtractObj(string,var Integer,var string);
remote procedure NextM4SerialNumber(string,var string);
remote function boolean CompanyIsJWLikeCompany(Integer);
external procedure StripSpace(var string,string); //Edit_________________ABR 16.10 10:10; 
external procedure PUSumUp(var record PUVc);
external function Boolean GetItemPurchasePriceDiscount(string,string,Date,string,string,val,string,string,string,string,Integer,Boolean,val,val,val,val,val,
         var record INVc,var record PIVc,var Boolean,var val,var string,var val,var string,var string,var Boolean,var string);
external function Boolean GetFirstPurchaseItem2(string,string,string,var record PIVc);
external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);
external function val DivRateToBase1(string,val,val,val,val,val,val,roundmode);
external procedure GetItemVATCode(string,Integer,var string,Boolean);
external function Boolean GetFirstPurchaseItem(string,string,string,var record PIVc);
external function roundmode GetCostRoundMode(record RoundBlock);
external function string 255 FillupTaxMatrix(Integer,string,string,string,string,string,var record TaxMatrixVc); 
external function string 255 FindINObjects(string,string);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external procedure PUCalcPerc(val,string,var val); 
external procedure DivPIFactor(val,val,var val);
external procedure FindPUStockAcc(string,record CostAccBlock,string,string,string,record INVc,Integer,var string,var string,Boolean);
external procedure PUCalcCostPrice(string,val,Integer,Integer,string,string,
                                   val,val,val,val,val,
                                   val,val,val,val,val,val,
                                   string,var val,val,var val,string,Integer); //Edit***************************Sasha2,13:04 08.04.2015
external updating procedure UpdateGlobalItem(var record INVc);//Edit_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-Anton 10:31 21.08.2018
external updating procedure CreateNewGlobalItem(var record INVc);// Edit ************************** BPI Ukraine - KramarAlexandr - Wednesday, 26 December 2018 12:42:52
remote function boolean CompanyIsJWLikeCompany(Integer);
external procedure GetPriceItem(string,var val,var val);
external function string 255 StrReplace(string,string,string);// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 19 March 2019 14:26:14
external function Boolean SetInSet2(string,string);
					 
SetLangMode(LangRussian,"RUS",0);

procedure PUVc_FillRow(var record PUVc PUr,Integer rownr)		//Edit-----------Dima 25.12.2014
BEGIN
  Boolean res;
  record CostAccBlock CostAccRec;
  record PIVc PIr;
  record INVc INr;
  row PUVc PUrw;
  Boolean chrsum;
  string 60 sz,msk,mskrep,pcstr,tstr;
  val t,p,s,t2;
  record SysFormatBlock SFb;
  string 200 varsubset,location;
  Boolean infoundf;
  record RoundBlock Roundb;
  string 20 stockacc,purchacc;
  record LocationVc Locr;
  record MainStockBlock MSb;
  Boolean nomoreremotecalls,pifound;
  record TaxMatrixVc TMr;
  string 255 taxtemplatecode,vatcode,descstr;
  val price,reb;
  
  MatRowGet(PUr,rownr,PUrw); 

  infoundf = GetItemPurchasePriceDiscount(PUr.VECode,PUr.Location,PUr.TransDate,PUr.CurncyCode,PUrw.ArtCode,PUrw.Quant,
                                   PUr.Location,"","","",0,true,
                                   PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,
                                   INr,PIr,pifound,price,descstr,reb,vatcode,purchacc,nomoreremotecalls,taxtemplatecode);
  if (infoundf) then begin
    BlockLoad(SFb);
    BlockLoad(CostAccRec);    
    BlockLoad(Roundb);    
    BlockLoad(MSb);
    Locr.Code = PUr.Location;
    if (blank(Locr.Code)) then begin
      Locr.Code = MSb.MainStock;
    end;
    ReadFirstMain(Locr,1,true);
		
    pcstr = "";
		/*
    if (GetFirstPurchaseItem(PUrw.ArtCode,PUr.Location,PUr.VECode,PIr)) then begin
      if (PIr.CurncyCode==PUr.CurncyCode) then begin
		if (blank(PUrw.UPrice)) then begin
     	   PUrw.UPrice = PIr.PurPrice;
		   p = PIr.PurPrice;
		end else begin
		   p =  PUrw.UPrice;
		end;
        
      end else begin
        CurValToOtherCur(PUr.TransDate,PIr.CurncyCode,PIr.PurPrice,PUr.CurncyCode,t,GetCostRoundMode(Roundb));
        PUrw.UPrice = t;  
        p = PUrw.UPrice;
      end;          
      PUrw.CountryOfOrg = PIr.OrgCountry;
      PUrw.CustomsCost = PIr.PurchaseCost;
      PUrw.VEItemCode = PIr.VEItemCode;
      PUrw.VEUnit = PIr.VEUnit;
      PUrw.CountryOfOrg = PIr.OrgCountry;
      if (INr.PriceFactor!=0) then begin
        p = p/INr.PriceFactor;
      end;
    end else begin
      PUrw.Spec = INr.Name;
		if (blank(PUrw.UPrice)) then begin
		      PUrw.UPrice = INr.InPrice;
			 p = INr.InPrice;
		end else begin
		      p = PUrw.UPrice;
		end;
      if (INr.PriceFactor!=0) then begin
        p = p/INr.PriceFactor;
      end;
      p = DivRateToBase1(PUr.CurncyCode,p,PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,GetCostRoundMode(Roundb));
    end;*/ 
    PUrw.VATCode = PUr.VEVATCode;    
    if (blank(PUrw.VATCode)) then begin
      GetItemVATCode(PUrw.ArtCode,PUr.ExportFlag,tstr,false);
      PUrw.VATCode = tstr;
    end;
    PUrw.TaxTemplateCode = FillupTaxMatrix(1,PUr.BranchID,PUr.VECode,"","",taxtemplatecode,TMr);
    PUrw.Coefficient = INr.UnitCoefficient;
    //PUrw.InPrice = INr.InPrice;
    PUrw.ArtCode = INr.Code;
    PUrw.Spec = INr.Name;
    PUrw.Objects = FindINObjects(INr.Objects,INr.Group);
    //PUrw.UPrice = p;
    PUrw.UnitXval = INr.Width;
    PUrw.UnitYval = INr.Height;
    PUrw.UnitZval = INr.Depth;
    PUrw.UnitCode = INr.Unittext;
    location = PUrw.Location;
    if (blank(location)) then begin
      location = PUr.Location;
    end;
    if (Locr.RequirePos!=0) then begin
      PUrw.PosCode = Locr.WHMDefPUPosCode;
    end;

    //t2 = MulRateToBase1(PUr.CurncyCode,p,PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,GetCostRoundMode(Roundb));
    //PUCalcPerc(t2,PUrw.CustomsCost,t2);
    pcstr = ValToString(t2,M45Val,SFb.thousSep,SFb.decimalPt,0);
    PUrw.CustomsCost = pcstr;
    //PUrw.BasePrice = INr.UPrice1;
    tstr = INr.ExtraCost;
    PUrw.Extra = tstr;
    PUrw.PIFactor = PIr.PIFactor;
    PUrw.StockType = PIr.DefStockType;
    /*if (PUrw.PIFactor!=0) then begin
      PUrw.UPrice = PUrw.UPrice/PUrw.PIFactor;
    end;*/
    //DivPIFactor(PUrw.Quant,PUrw.PIFactor,t);
    PUrw.VEQuant = t;
    
    if (blank(PUrw.Location)) then begin
      //FindPUStockAcc(PUr.VECode,CostAccRec,PUrw.CostAcc,PUrw.CredAcc,PUr.Location,INr,PUrw.StockType,stockacc,purchacc,true);
    end else begin
      //FindPUStockAcc(PUr.VECode,CostAccRec,PUrw.CostAcc,PUrw.CredAcc,PUrw.Location,INr,PUrw.StockType,stockacc,purchacc,true);
    end;
    PUrw.CostAcc = stockacc;
    PUrw.CredAcc = purchacc;

    PackRowFieldMatrix(PUrw,"TaxMatrix",TMr);
    MatRowPut(PUr,rownr,PUrw);
    chrsum = true;
    res = true;
  end;
	/*
  if (chrsum) then begin
    PUCalcCostPrice(PUrw.ArtCode,PUrw.UPrice,PUr.InclVAT,PUr.NoTAXonVAT,PUrw.Extra,PUr.CurncyCode,
                    PUr.FrRate,PUr.ToRateB1,PUr.ToRateB2,PUr.BaseRate1,PUr.BaseRate2,
                    PUrw.ShipCost,PUrw.RowCost1,PUrw.RowCost2,PUrw.RowCost3,PUrw.RowCost4,PUrw.RowCost5,
                    PUrw.CustomsCost,p,PUrw.Quant,s,PUrw.VATCode,PUr.ExportFlag);
    PUrw.CostPrice = p;
    PUrw.Sum = s;
  end;*/
  MatRowPut(PUr,rownr,PUrw);    

  RETURN;
END;

Global updating procedure ImportPLIn()
begin
	record PLVc PLr;
	Integer i;
	array string 255 sfield;
	string 5 flag;
	record INVc INr;
	record PLDefVc PLDr;
	val price, calcprice, calcrebate;		
	record CurncyCodeVc Curncyr;
	string 50 tstr;
		
		while (TestEOF()==false) begin
		  for (i=0;i<5;i=i+1) begin
        sfield[i]=ImportField;
        tstr = "";
				StripSpace(tstr,sfield[i]); //Edit_________________ABR 16.10 10:10;
				sfield[i] = tstr;
      end;
      INr.Code = sfield[1];
      if(readfirstmain(INr,1,true))then begin
        PLDr.Code = sfield[0];
        if(readfirstmain(PLDr,1,true))then begin
          if(nonblank(sfield[2]))then begin
            price = evaltoval(sfield[2]);
            if(price>0)then begin
              recordnew(PLr);
              PLr.PLCode = PLDr.Code;
              PLr.ArtCode = INr.Code;
              PLr.Comment = INr.Name;
              PLr.ExVatPrice = price;
              Curncyr.CurncyCode = sfield[3];
              if(readfirstmain(Curncyr,1,true))then begin
              	PLr.CurncyCode = Curncyr.CurncyCode;
              end;
              if(nonblank(sfield[4]))then begin
              	PLr.SerialNr = sfield[4];
              end;
              if(RecordInsert(PLr,true))then begin
								GetPriceItem(INr.Code,calcprice,calcrebate);
							end;
            end;            
          end;
        end;
      end else begin
      	INr.AlternativeCode = sfield[1];
      	if(readfirstKey("AlternativeCode",INr,1,true))then begin
					PLDr.Code = sfield[0];
					if(readfirstmain(PLDr,1,true))then begin
						if(nonblank(sfield[2]))then begin
							price = evaltoval(sfield[2]);
							if(price>0)then begin
								recordnew(PLr);
								PLr.PLCode = PLDr.Code;
								PLr.ArtCode = INr.Code;
								PLr.Comment = INr.Name;
								PLr.ExVatPrice = price;
								Curncyr.CurncyCode = sfield[3];
								if(readfirstmain(Curncyr,1,true))then begin
									PLr.CurncyCode = Curncyr.CurncyCode;
								end;
								if(nonblank(sfield[4]))then begin
									PLr.SerialNr = sfield[4];
								end;
								if(RecordInsert(PLr,true))then begin
									GetPriceItem(INr.Code,calcprice,calcrebate);
								end;
							end;            
						end;
					end;
				end else begin
					INr.BarCode = sfield[1];
					if(readfirstKey("BarCode",INr,1,true))then begin
						PLDr.Code = sfield[0];
						if(readfirstmain(PLDr,1,true))then begin
							if(nonblank(sfield[2]))then begin
								price = evaltoval(sfield[2]);
								if(price>0)then begin
									recordnew(PLr);
									PLr.PLCode = PLDr.Code;
									PLr.ArtCode = INr.Code;
									PLr.Comment = INr.Name;
									PLr.ExVatPrice = price;
									Curncyr.CurncyCode = sfield[3];
									if(readfirstmain(Curncyr,1,true))then begin
										PLr.CurncyCode = Curncyr.CurncyCode;
									end;
									if(nonblank(sfield[4]))then begin
										PLr.SerialNr = sfield[4];
									end;
									if(RecordInsert(PLr,true))then begin
										GetPriceItem(INr.Code,calcprice,calcrebate);
									end;
								end;            
							end;
						end;
					end;
				end;
      end;
      NextImportLine(true);
		end;

 return;
end;

Global updating procedure ImportPLCurIn()
begin
	record PLVc PLr;
	Integer i;
	array string 255 sfield;
	string 5 flag;
	record INVc INr;
	record PLDefVc PLDr;
	val price;		
	record CurncyCodeVc Curncyr;
	string 50 tstr,plcode,item,curncy;
		
		while (TestEOF()==false) begin
		  plcode = ImportField;
		  item = ImportField;
		  curncy = ImportField;
		  
		  if(nonblank(plcode) and nonblank(item) and nonblank(curncy))then begin
		  	PLr.PLCode = plcode;
		  	PLr.ArtCode = item;
		  	if(readfirstmain(PLr,2,true))then begin
		  		PLr.CurncyCode = curncy;
		  		recordstore(PLr,true);
		  	end;
		  end;
		  
      NextImportLine(true);
		end;

 return;
end;


Global updating procedure ImportDiskTableIn()
begin
	record CUVc CUr,oldCUr;
	record RebVc Rebr;
	integer i;
	string 255 sfield0,sfield1;
	
		while (TestEOF()==false) begin
			sfield0 = "";
			sfield1 = "";
			sfield0=ImportField;
			sfield1=ImportField;
      CUr.Code = sfield0;
      if(readfirstmain(CUr,1,true))then begin
        Rebr.Code = sfield1;
        if(readfirstmain(Rebr,1,true))then begin
          if(CUr.RebCode!=Rebr.Code)then begin
          	recordcopy(oldCUr,CUr);
          	CUr.RebCode = Rebr.Code;
          	recordUpdate(oldCUr,CUr,true);
          end;
        end;
      end;
      NextImportLine(true);
		end;

 return;
end;

procedure FormatString(var string field)// Edit ***** 20 June 2013 15:17:00 Larisa
begin
	string 255 tempfield,s;
	integer i,ns;
	
	tempfield = field;
	field = "";
	for (i=0;i<len(tempfield);i=i+1) begin
		s = mid(tempfield,i,1);
		ns = asc(s);
		if(ns>=32 and ns<=126)then begin
			if(ns!=34)then begin
				field = field & s;
			end;
		end;
		if(ns>=1040 and ns<=1103)then begin
			field = field & s;
		end;
	end;
	return;
end;// Edit ***** 20 June 2013 15:17:00 Larisa

global
procedure FormatUpperCaseCode(var string field)// Edit ***** 20 June 2013 15:17:00 Larisa
begin
	string 255 tempfield,s;
	integer i,ns;
	
	tempfield = UpperCase(field);
	field = "";
	for (i=0;i<len(tempfield);i=i+1) begin
		s = mid(tempfield,i,1);
		ns = asc(s);
		if(ns>=32 and ns<=96)then begin
			if(ns!=34 and ns!=44 and ns!=58)then begin
				if(ns==32)then begin
					field = field & chr(95);
				end else begin
					field = field & s;
				end;
			end;
		end;
		if(ns>=123 and ns<=126)then begin
			field = field & s;
		end;
		if(ns>=1040 and ns<=1071)then begin
			field = field & s;
		end;
	end;
	return;
end;// Edit ***** 20 June 2013 15:17:00 Larisa

updating procedure ReturnCodeClassification(var string classification)// Edit ***** 21 June 2013 10:39:00 Larisa
begin
	Integer cnt;
	record DIVc DIr;
	
	if(nonblank(classification))then begin
		DIr.Code = classification;
		if(ReadFirstMain(DIr,1,true)==false)then begin
			DIr.Name = classification;
			if(ReadFirstKey("Name",DIr,1,true)==false)then begin
				cnt = CountRecords("DIVc");
				RecordNew(DIr);
				LCntDIr:;
				DIr.Code = cnt+1;
				if(ReadFirstMain(DIr,1,true))then begin
					cnt = cnt + 1;
					goto LCntDIr;
				end;
				DIr.Code = cnt+1;
				DIr.Name = classification;
				classification = DIr.Code;
				RecordStore(DIr,true);
			end else begin
				classification = DIr.Code;
			end;
		end else begin
			classification = DIr.Code;
		end;
		
	end;
	return;
end;// Edit ***** 21 June 2013 10:39:00 Larisa

Global updating procedure ImportMyINIn()
begin
	record INVc INr;
	record RebVc Rebr;
	record ITVc ITr;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,ressfield4,alternat,color,size;
		
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		alternat = "";
		color = "";
		size = "";
		sfield3 = "";
		sfield4 = "";
		ressfield4 = "";
		sfield0 = ImportField;
		if(nonblank(sfield0))then begin
			FormatUpperCaseCode(sfield0);
			sfield1 = ImportField;
			if(nonblank(sfield1))then begin
				FormatString(sfield1);
			end;
			sfield2 = ImportField;
			if(nonblank(sfield2))then begin
				FormatString(sfield2);
			end;
			alternat = ImportField;
			color = ImportField;
			size = ImportField;
			sfield3 = ImportField;
			if(nonblank(sfield3))then begin//validate group
				ITr.Code = sfield3;
				if(ReadFirstMain(ITr,1,true)==false)then begin
					ITr.Comment = sfield3;
					if(ReadFirstKey("Comment",ITr,1,true)==false)then begin
						sfield3 = "";
					end else begin
						sfield3 = ITr.Code;
					end;
				end else begin
					sfield3 = ITr.Code;
				end;
			end;//validate group
			sfield4 = ImportField;
			if(nonblank(sfield4))then begin
				FormatString(sfield4);
				ReturnCodeClassification(sfield4);
				UpperCase(sfield4);
			end;
			while(nonblank(sfield4))begin
				if(nonblank(ressfield4))then begin
					ressfield4 = ressfield4 & "," & sfield4;
				end else begin
					ressfield4 = ressfield4 & sfield4;
				end;
				sfield4 = ImportField;
				if(nonblank(sfield4))then begin
					FormatString(sfield4);
					ReturnCodeClassification(sfield4);
					UpperCase(sfield4);
				end;
			end;
			INr.Code = sfield0;
			if(ReadFirstMain(INr,1,true))then begin
				if(nonblank(sfield1))then begin
					INr.Name = sfield1;
				end;
				if(nonblank(sfield2))then begin
					INr.BarCode = sfield2;
				end;
				if(nonblank(alternat))then begin
					INr.AlternativeCode = alternat;
				end;
				if(nonblank(color))then begin
					INr.Colour = color;
				end;
				if(nonblank(size))then begin
					INr.Size = size;
				end;
				if(nonblank(sfield3))then begin
					INr.Group = sfield3;
				end;
				if(nonblank(ressfield4))then begin
					INr.DispGroups = ressfield4;
				end;
				recordStore(INr,True);
			end else begin
				if(nonblank(sfield1))then begin
					recordNew(INr);
					INr.Code = sfield0;
					INr.Name = sfield1;
					INr.BarCode = sfield2;
					INr.AlternativeCode = alternat;
					INr.Colour = color;
					INr.Size = size;
					INr.Group = sfield3;
					INr.DispGroups = ressfield4;
					recordStore(INr,true);
				end;//if nonblank(sfield1)
			end;//if RFM INr
		end;//if nonblank(sfield0)
		NextImportLine(true);
	end;
	return;
end;


global updating procedure ImportDIVcIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,color,size;
	boolean TrHs;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield0 = ImportField;
		FormatUpperCaseCode(sfield0);
		if(nonblank(sfield0) and i==0)then begin 
			CType = sfield0;
		end;
		if(nonblank(sfield0) and i==1)then begin 
			CFirstCode = sfield0;
		end;
		if(blank(sfield0) and i==0)then begin 
			TrHs = false;
		end;
		if(blank(sfield0) and i==1)then begin 
			TrHs = false;
		end;
		if(i>1 and TrHs and NameCreatef[sfield0]!=true)then begin
			if(i>2)then begin
				RecordNew(DIr);
				NextM4SerialNumber(CFirstCode,DIr.Code);
				CFirstCode = DIr.Code;
				NameCreatef[sfield0] = true;
			end else begin
				RecordNew(DIr);
				DIr.Code = CFirstCode;
				NameCreatef[sfield0] = true;
			end;
			DIr.CType = CType;
			Dir.Name = sfield0;
			recordStore(DIr,True);
			//logtext(0,DIr.Code);
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;







global updating procedure ImportColourIdeaIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield0 = ImportField;
		CType = "COLOUR";
		TrHs2 = true;
		DIr.Code = "CL99999";
		while(loopbackkey("Code",DIr,1,TrHs2))begin
			if(nonblank(DIr.Code) and left(DIr.Code,2)=="CL")then begin CFirstCode = DIr.Code; /*logtext(0,DIr.Code & "Old Code");*/ end;
			TrHs2 = false;
		end;
		ResetLoop(DIr);
		DIr.Name = sfield0;
		if(!ReadFirstKey("Name",DIr,1,true))then begin
			RecordNew(DIr);
			if(blank(CFirstCode))then begin
				CFirstCode = "CL00000";
			end;
			NextM4SerialNumber(CFirstCode,DIr.Code);
			CFirstCode = DIr.Code;
			DIr.CType = CType;
			Dir.Name = sfield0;
			if(recordStore(DIr,True))then begin
				logtext(0,DIr.Code);
			end;
		end else begin
			//logtext(0,DIr.Name & "___" & DIr.CType & "___" & sfield0);
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;





global updating procedure ImportINDISPColourModelIdeaIn()
begin
	record INVc INr;
	record DIVc DIr;
	integer i;
	string 255 sfield0,sfield1,sfield2,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield0 = ImportField;
		sfield1 = ImportField;
		sfield2 = ImportField;
		INr.Code = sfield0;
		if(ReadfirstMain(INr,1,true))then begin
			if(nonblank(sfield1))then begin
				TrHs2 = true;
				DIr.Name = sfield1;
				while(LoopKey("Name",DIr,1,TrHs2))begin
					if(DIr.Name!=sfield1)then begin TrHs2 = false; end;
					if(DIr.CType=="COLOUR" and TrHs2)then begin
						TrHs2 = false;
						INr.Colour = DIr.Code;
						INr.DispGroups = INr.DispGroups & "," & DIr.Code;
						logtext(0,DIr.Name);
					end;
				end;
				resetloop(DIr);
			end else begin
				INr.Colour = "";
			end;
			if(RecordStore(INr,true))then begin
				logtext(0,INr.Code);
			end;
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;



global updating procedure ImportINDISPModelIdeaIn()
begin
	record INVc INr;
	record DIVc DIr;
	integer i;
	string 255 sfield0,sfield1,sfield2,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield0 = ImportField;
		sfield2 = ImportField;
		INr.Code = sfield0;
		if(ReadfirstMain(INr,1,true))then begin
			if(nonblank(sfield2))then begin
				TrHs2 = true;
				DIr.Name = sfield2;
				while(LoopKey("Name",DIr,1,TrHs2))begin
					if(DIr.Name!=sfield2)then begin TrHs2 = false; end;
					if(DIr.CType=="MODEL" and TrHs2)then begin
						TrHs2 = false;
						INr.Reference = DIr.Code;
						INr.DispGroups = INr.DispGroups & "," & DIr.Code;
						logtext(0,DIr.Name);
					end;
				end;
				resetloop(DIr);
			end else begin
				INr.Reference = "";
			end;
			if(RecordStore(INr,true))then begin
				logtext(0,INr.Code);
			end;
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;







global updating procedure ImportModelIdeaIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, CFirstCode;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield0 = ImportField;
		CType = "MODEL";
		TrHs2 = true;
		DIr.Code = "ML99999";
		while(loopbackkey("Code",DIr,1,TrHs2))begin
			if(nonblank(DIr.Code) and left(DIr.Code,2)=="ML")then begin CFirstCode = DIr.Code; /*logtext(0,DIr.Code & "Old Code");*/ end;
			TrHs2 = false;
		end;
		ResetLoop(DIr);
		DIr.Name = sfield0;
		if(!ReadFirstKey("Name",DIr,1,true))then begin
			RecordNew(DIr);
			if(blank(CFirstCode))then begin
				CFirstCode = "ML00000";
			end;
			NextM4SerialNumber(CFirstCode,DIr.Code);
			CFirstCode = DIr.Code;
			DIr.CType = CType;
			Dir.Name = sfield0;
			if(recordStore(DIr,True))then begin
				logtext(0,DIr.Code);
			end;
		end else begin
			//logtext(0,DIr.Name & "___" & DIr.CType & "___" & sfield0);
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;






global updating procedure ImportCRTbrandIdeaIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, UNUPCName;
	vector boolean NameCreatef;
	string 255 CFirstCode;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield0 = ImportField;
		UNUPCName = sfield0;
		FormatUpperCaseCode(sfield0);
		CType = "BRAND";
		TrHs2 = true;
		DIr.Code = "C999999999";
		while(loopbackkey("Code",DIr,1,TrHs2))begin
			if(nonblank(DIr.Code) and left(DIr.Code,2)=="C0")then begin CFirstCode = DIr.Code; /*logtext(0,DIr.Code & "Old Code");*/ end;
			TrHs2 = false;
		end;
		DIr.Code = sfield0;
		if(!ReadFirstMain(DIr,1,true))then begin
			RecordNew(DIr);
			if(blank(CFirstCode))then begin
				CFirstCode = "C000000000";
			end;
			NextM4SerialNumber(CFirstCode,DIr.Code);
			CFirstCode = DIr.Code;
			DIr.CType = CType;
			Dir.Name = UNUPCName;
			if(recordStore(DIr,True))then begin
				logtext(0,DIr.Code);
			end;
		end else begin
			logtext(0,DIr.Name & "___" & DIr.CType & "___" & sfield0);
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;


global
updating procedure CleanDIMn()
begin
record DIVc DIr;
boolean TrHs;
integer i;
boolean chisla;
	DIr.Code = "";
	while (loopmain(DIr,1,true))begin
		if(DIr.CType!="BRAND" and DIr.CType!="SIZE")then begin
			RecordDelete(DIr);
			StepBack(DIr);
		end;
		if(DIr.CType=="BRAND")then begin
			chisla = true;
			for(i=0;i<len(DIr.Code);i=i+1) begin
				if(ASC(mid(DIr.Code,i,1))<48 or ASC(mid(DIr.Code,i,1))>57)then begin
					chisla = false;
				end;
			end;
			if(!chisla)then begin
				RecordDelete(DIr);
				StepBack(DIr);
			end;
		end;
	end;
	return;
end;




global
updating procedure CleanITMn()
begin
record ITVc ITr;
boolean TrHs;
integer i;
boolean chisla;
	ITr.Code = "";
	while (loopmain(ITr,1,true))begin
		chisla = true;
		for(i=0;i<len(ITr.Code);i=i+1) begin
			if(ASC(mid(ITr.Code,i,1))<48 or ASC(mid(ITr.Code,i,1))>57)then begin
				chisla = false;
			end;
		end;
		if(!chisla)then begin
			RecordDelete(ITr);
			StepBack(ITr);
		end;
	end;
	return;
end;


global updating procedure ImportNormCRTbrandIdeaIn()
begin
	record DIVc DIr;
	integer i;
	string 255 sfield0,sfield1,color,size;
	boolean TrHs, TrHs2;
	string 255 CType, UNUPCName;
	vector boolean NameCreatef;
	
	i = 0;
	TrHs = true;
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield0 = ImportField;
		sfield1 = trim(ImportField);
		UNUPCName = sfield1;
		FormatUpperCaseCode(sfield0);
		FormatUpperCaseCode(sfield1);
		CType = "BRAND";
		DIr.Code = sfield0;
		if(!ReadFirstMain(DIr,1,true))then begin
			RecordNew(DIr);
			DIr.Code = sfield1;
			DIr.CType = CType;
			Dir.Name = UNUPCName;
			if(recordStore(DIr,True))then begin
				logtext(0,DIr.Code);
			end;
		end else begin
			if(DIr.CType=="BRAND")then begin
				recorddelete(DIr);
				RecordNew(DIr);
				DIr.Code = sfield1;
				DIr.CType = CType;
				Dir.Name = UNUPCName;
				if(recordStore(DIr,True))then begin
					logtext(0,DIr.Name & "___" & DIr.CType & "___" & sfield0);
				end;
			end;
		end;
		NextImportLine(true);
		i = i + 1;
	end;
	return;
end;








global updating procedure IMportINMainStockIn()
begin
	record INVc INr;
	integer i;
	boolean TrHs;
	string 50 code,maincode;
	
	TrHs = true;
	while (TestEOF()==false) begin
		code = ImportField;
		INr.Code=code;
		if(ReadFirstMain(INr,1,true)) then begin
			INr.OutOfOrder = 0;
			RecordStore(INr,True);
		end;
		NextImportLine(true);
	end;
	return;
end;




global updating procedure ImportContactsIDIn()
begin
	record INVc INr, OldInr;
	row INVc INrw;
	record DIVc DIr,OldDIr;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,sfield8,sfield9,sfield10,sfield11,sfield12,sfield13,INCODE;
	boolean TrHs, testf;
	string 255 suf;
	
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield5 = "";
		sfield6 = "";
		sfield7 = "";
		sfield8 = "";
		sfield9 = ""; 
		sfield10 = "";
		sfield11 = "";
		sfield12 = "";
		sfield0 = ImportField;
		sfield1 = ImportField;
		sfield2 = ImportField;
		sfield3 = ImportField;
		sfield4 = ImportField;
		sfield5 = ImportField;
		sfield6 = ImportField;
		sfield7 = ImportField;
		sfield8 = ImportField;
		sfield9 = ImportField;
		sfield10 = ImportField;
		sfield11 = ImportField;
		sfield12 = ImportField;
		INr.Code = sfield0;
		if(ReadFirstMain(INr,1,true))then begin
			RecordCopy(OldInr,INr);
			INr.SN = sfield0;
			INr.SNOne = sfield1;
			INr.AlternativeCode = sfield2;
			DIr.Name = sfield3;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Reference = DIr.Code; 
			end else begin
				if(nonblank(sfield3))then begin
					DIr.Code = "ML99999";
					TrHs = true;
					while(LoopBackKey("Code",DIr,1,TrHs))begin
						if(left(DIr.Code,2)=="ML")then begin
							recordnew(DIr);
							suf = StringToInt(right(DIr.Code,5))+1;
							if(len(suf)<5)then begin
								for (i=0;i<(5-len(suf));i=i+1) begin
									suf = "0" & suf;
								end;
							end;
							DIr.Code = left(DIr.Code,2) & suf;
							DIr.Name = sfield3;
							DIr.CType = "MODEL";
							OldDir.Code = DIr.Code;
							if(readfirstmain(OldDir,1,true)==false)then begin
								if (RECORDSTORE(DIr,true)==false) then begin
									INr.Reference = DIr.Code; 
								end;
							end;
						end;
						TrHs = false;
					end;
				end;
			end;
			INr.Name = sfield4;
			INrw.Text = sfield5;
			matrowput(INr,0,INrw);
			DIr.Name = sfield6;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Colour = DIr.Code; 
			end else begin
				if(nonblank(sfield6))then begin
					DIr.Code = "CL99999";
					TrHs = true;
					while(LoopBackKey("Code",DIr,1,TrHs))begin
						if(left(DIr.Code,2)=="ML")then begin
							recordnew(DIr);
							suf = StringToInt(right(DIr.Code,5))+1;
							if(len(suf)<5)then begin
								for (i=0;i<(5-len(suf));i=i+1) begin
									suf = "0" & suf;
								end;
							end;
							DIr.Code = left(DIr.Code,2) & suf;
							DIr.Name = sfield6;
							DIr.CType = "COLOUR";
							OldDir.Code = DIr.Code;
							if(readfirstmain(OldDir,1,true)==false)then begin
								if (RECORDSTORE(DIr,true)==false) then begin
									INr.Reference = DIr.Code; 
								end;
							end;
						end;
						TrHs = false;
					end;
				end;
			end;
			INr.Unittext = sfield7;
			DIr.Name = sfield8;
			while (LoopKey("Name",DIr,1,TrHs))begin 
				if(sfield8==DIr.Name)then begin
					testf = true;
					for (i=0;i<len(DIr.Code);i=i+1)begin
						if(Asc(mid(DIr.Code,i,1))<=48 or Asc(mid(DIr.Code,i,1))>=57)then begin testf = false; end;
					end;
					if(testf==true)then begin
						INr.DispGroups = DIr.Code;
					end;
				end else begin
					TrHs = false;
				end;
			end;
			ResetLoop(DIr);
			INr.Category = sfield9;
			INr.CompletCode = sfield10;
			INr.LastPurchPrice2 = StringToVal(sfield11,M4Val);
			INr.LastPurchCurncyCode = "EUR";
			INr.InPrice = StringToVal(sfield12,M4Val);
			if(RecordUpdate(OldInr,INr,false)==0)then begin end;
		end else begin
			if(nonblank(sfield0))then begin
				RecordNew(INr);
				INr.Code = sfield0;
				INr.SN = sfield0;
				INr.SNOne = sfield1;
				INr.AlternativeCode = sfield2;
				DIr.Name = sfield3;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Reference = DIr.Code; 
				end else begin
					if(nonblank(sfield3))then begin
						DIr.Code = "ML99999";
						TrHs = true;
						while(LoopBackKey("Code",DIr,1,TrHs))begin
							if(left(DIr.Code,2)=="ML")then begin
								recordnew(DIr);
								suf = StringToInt(right(DIr.Code,5))+1;
								if(len(suf)<5)then begin
									for (i=0;i<(5-len(suf));i=i+1) begin
										suf = "0" & suf;
									end;
								end;
								DIr.Code = left(DIr.Code,2) & suf;
								DIr.Name = sfield3;
								DIr.CType = "MODEL";
								OldDir.Code = DIr.Code;
								if(readfirstmain(OldDir,1,true)==false)then begin
									if (RECORDSTORE(DIr,true)==false) then begin
										INr.Reference = DIr.Code; 
									end;
								end;
							end;
							TrHs = false;
						end;
					end;
				end;
				INr.Name = sfield4;
				INrw.Text = sfield5;
				matrowput(INr,0,INrw);
				DIr.Name = sfield6;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Colour = DIr.Code; 
				end else begin
					if(nonblank(sfield6))then begin
						DIr.Code = "CL99999";
						TrHs = true;
						while(LoopBackKey("Code",DIr,1,TrHs))begin
							if(left(DIr.Code,2)=="ML")then begin
								recordnew(DIr);
								suf = StringToInt(right(DIr.Code,5))+1;
								if(len(suf)<5)then begin
									for (i=0;i<(5-len(suf));i=i+1) begin
										suf = "0" & suf;
									end;
								end;
								DIr.Code = left(DIr.Code,2) & suf;
								DIr.Name = sfield6;
								DIr.CType = "COLOUR";
								OldDir.Code = DIr.Code;
								if(readfirstmain(OldDir,1,true)==false)then begin
									if (RECORDSTORE(DIr,true)==false) then begin
										INr.Reference = DIr.Code; 
									end;
								end;
							end;
							TrHs = false;
						end;
					end;
				end;
				INr.Unittext = sfield7;
				DIr.Name = sfield8;
				while (LoopKey("Name",DIr,1,TrHs))begin 
					if(sfield8==DIr.Name)then begin
						testf = true;
						for (i=0;i<len(DIr.Code);i=i+1)begin
							if(Asc(mid(DIr.Code,i,1))<=48 or Asc(mid(DIr.Code,i,1))>=57)then begin testf = false; end;
						end;
						if(testf==true)then begin
							INr.DispGroups = DIr.Code;
						end;
					end else begin
						TrHs = false;
					end;
				end;
				ResetLoop(DIr);
				INr.Category = sfield9;
				INr.CompletCode = sfield10;
				INr.LastPurchPrice2 = StringToVal(sfield11,M4Val);
				INr.LastPurchCurncyCode = "EUR";
				INr.InPrice = StringToVal(sfield12,M4Val);
				RecordInsert(INr,false);
			end;
		end;
		NextImportLine(true);
	end;
	return;
end;







global updating procedure ImportContactsIDfrCRTVIn()
begin
	record INVc INr, OldInr;
	row INVc INrw;
	record DIVc DIr,OldDir;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,sfield8,sfield9,sfield10,sfield11,sfield12,sfield13,sfield14,INCODE;
	record ITVc ITr;
	boolean TrHs, testf;
	string 255 suf;
	
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield5 = "";
		sfield6 = "";
		sfield7 = "";
		sfield8 = "";
		sfield9 = ""; 
		sfield10 = "";
		sfield11 = "";
		sfield12 = "";
		sfield13 = "";
		sfield0 = ImportField;
		sfield1 = ImportField;
		sfield2 = ImportField;
		sfield3 = ImportField;
		sfield4 = ImportField;
		sfield5 = ImportField;
		sfield6 = ImportField;
		sfield14 = ImportField;
		sfield7 = ImportField;
		sfield8 = ImportField;
		sfield9 = ImportField;
		sfield10 = ImportField;
		sfield11 = ImportField;
		sfield12 = ImportField;
		sfield13 = ImportField;
		INr.Code = sfield0;
		if(ReadFirstMain(INr,1,true))then begin
			//RecordCopy(OldInr,INr);
			/*INr.SN = sfield0;
			INr.SNOne = sfield1;
			INr.AlternativeCode = sfield2;
			DIr.Name = sfield3;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Reference = DIr.Code; 
			end else begin
				DIr.Code = "ML99999";
				TrHs = true;
				while(LoopBackKey("Code",DIr,1,TrHs))begin
					if(left(DIr.Code,2)=="ML")then begin
						recordnew(DIr);
						suf = StringToInt(right(DIr.Code,5))+1;
						if(len(suf)<5)then begin
							for (i=0;i<(5-len(suf));i=i+1) begin
								suf = "0" & suf;
							end;
						end;
						DIr.Code = left(DIr.Code,2) & suf;
						DIr.Name = sfield3;
						DIr.CType = "MODEL";
						OldDir.Code = DIr.Code;
						if(readfirstmain(OldDir,1,true)==false)then begin
							if (RECORDSTORE(DIr,true)==false) then begin
								logtext(0,DIr.Code);
								INr.Reference = DIr.Code; 
							end;
						end;
					end;
					TrHs = false;
				end;
			end;*/
			INr.Name = sfield4;
			/*INrw.Text = sfield5;
			matrowput(INr,0,INrw);
			DIr.Name = sfield6;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Colour = DIr.Code; 
			end else begin
				DIr.Code = "CL99999";
				TrHs = true;
				while(LoopBackKey("Code",DIr,1,TrHs))begin
					if(left(DIr.Code,2)=="ML")then begin
						recordnew(DIr);
						suf = StringToInt(right(DIr.Code,5))+1;
						if(len(suf)<5)then begin
							for (i=0;i<(5-len(suf));i=i+1) begin
								suf = "0" & suf;
							end;
						end;
						DIr.Code = left(DIr.Code,2) & suf;
						DIr.Name = sfield6;
						DIr.CType = "COLOUR";
						OldDir.Code = DIr.Code;
						if(readfirstmain(OldDir,1,true)==false)then begin
							if (RECORDSTORE(DIr,true)==false) then begin
								logtext(0,DIr.Code);
								INr.Reference = DIr.Code; 
							end;
						end;
					end;
					TrHs = false;
				end;
			end;
			INr.Unittext = sfield7;
			TrHs = true;
			DIr.Name = sfield8;
			while (LoopKey("Name",DIr,1,TrHs))begin 
				if(sfield8==DIr.Name)then begin
					testf = false;
					for (i=0;i<len(DIr.Code);i=i+1)begin
						if(Asc(mid(DIr.Code,i,1))<=48 or Asc(mid(DIr.Code,i,1))>=57)then begin testf = true; end;
					end;
					if(testf==true)then begin
						INr.DispGroups = DIr.Code;
					end;
				end else begin
					TrHs = false;
				end;
			end;
			ResetLoop(DIr);*/
			/*ITr.Comment = sfield8;
			if(readfirstKey("Comment",ITr,1,true))then begin 
				INr.Group = ITr.Code; 
			end;*/
			/*INr.Category = sfield9;
			INr.CompletCode = sfield10;
			INr.LastPurchPrice2 = StringToVal(sfield11,M4Val);
			INr.LastPurchCurncyCode = "EUR";
			INr.InPrice = StringToVal(sfield12,M4Val);
			INr.IDOldINNr = sfield13;
			DIr.Name = sfield14;
			if(readfirstKey("Name",DIr,1,true))then begin 
				INr.Size = DIr.Code; 
			end else begin
				INr.Size = sfield14;
			end;*/
			//if(RecordUpdate(OldInr,INr,false)==0)then begin end;
			recordstore(INr,true);
		end else begin
			if(nonblank(sfield0))then begin
				RecordNew(INr);
				INr.Code = sfield0;
				INr.SN = sfield0;
				INr.SNOne = sfield1;
				INr.AlternativeCode = sfield2;
				DIr.Name = sfield3;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Reference = DIr.Code; 
				end else begin
					DIr.Code = "ML99999";
					TrHs = true;
					while(LoopBackKey("Code",DIr,1,TrHs))begin
						if(left(DIr.Code,2)=="ML")then begin
							recordnew(DIr);
							suf = StringToInt(right(DIr.Code,5))+1;
							if(len(suf)<7)then begin
								for (i=0;i<(7-len(suf));i=i+1) begin
									suf = "0" & suf;
								end;
							end;
							DIr.Code = left(DIr.Code,2) & suf;
							DIr.Name = sfield3;
							DIr.CType = "MODEL";
							
							if (RECORDSTORE(DIr,true)==false) then begin
								logtext(0,DIr.Code);
								INr.Reference = DIr.Code; 
							end;
						end;
						TrHs = false;
					end;
				end;
				INr.Name = sfield4;
				INrw.Text = sfield5;
				matrowput(INr,0,INrw);
				DIr.Name = sfield6;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Colour = DIr.Code; 
				end else begin
					DIr.Code = "CL99999";
					TrHs = true;
					while(LoopBackKey("Code",DIr,1,TrHs))begin
						if(left(DIr.Code,2)=="ML")then begin
							recordnew(DIr);
							suf = StringToInt(right(DIr.Code,5))+1;
							if(len(suf)<7)then begin
								for (i=0;i<(7-len(suf));i=i+1) begin
									suf = "0" & suf;
								end;
							end;
							DIr.Code = left(DIr.Code,2) & suf;
							DIr.Name = sfield6;
							DIr.CType = "COLOUR";
							if(readfirstmain(OldDir,1,true)==false)then begin
								if (RECORDSTORE(DIr,true)==false) then begin
									logtext(0,DIr.Code);
									INr.Reference = DIr.Code; 
								end;
							end;
						end;
						TrHs = false;
					end;
				end;
				INr.Unittext = sfield7;
				DIr.Name = sfield8;
				while (LoopKey("Name",DIr,1,TrHs))begin 
					if(sfield8==DIr.Name)then begin
						testf = false;
						for (i=0;i<len(DIr.Code);i=i+1)begin
							if(Asc(mid(DIr.Code,i,1))<=48 or Asc(mid(DIr.Code,i,1))>=57)then begin testf = true; end;
						end;
						if(testf==true)then begin
							INr.DispGroups = DIr.Code;
						end;
					end else begin
						TrHs = false;
					end;
				end;
				ResetLoop(DIr);
				/*
				ITr.Comment = sfield8;
				if(readfirstKey("Comment",ITr,1,true))then begin 
					INr.Group = ITr.Code; 
				end;*/
				INr.Category = sfield9;
				INr.CompletCode = sfield10;
				INr.LastPurchPrice2 = StringToVal(sfield11,M4Val);
				INr.LastPurchCurncyCode = "EUR";
				INr.InPrice = StringToVal(sfield12,M4Val);
				INr.IDOldINNr = sfield13;
				DIr.Name = sfield14;
				if(readfirstKey("Name",DIr,1,true))then begin 
					INr.Size = DIr.Code; 
				end else begin
					INr.Size = sfield14;
				end;
				RecordInsert(INr,false);
			end;
		end;
		NextImportLine(true);
	end;
	return;
end;



global updating procedure ImportBrandsIDIn()
begin
	record DIVc DIr, OldDIr;
	record CUVc CUr, OldCUr;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,sfield8,sfield9,sfield10,sfield11,sfield12,sfield13,sfield14;
	
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield5 = "";
		sfield6 = "";
		sfield0 = ImportField;
		sfield1 = ImportField;
		sfield2 = ImportField;
		sfield3 = ImportField;
		sfield4 = ImportField;
		sfield5 = ImportField;
		sfield6 = ImportField;
		DIr.Code = sfield0;
		if(!ReadFirstMain(DIr,1,true))then begin
			if(nonblank(sfield0))then begin
				RecordNew(DIr);
				DIr.Code = sfield0;
				DIr.Name = sfield1;
				Dir.CType = "BRAND";
				RecordInsert(DIr,false);
			end;
		end;
		CUr.Code = sfield0;
		if(ReadFirstMain(CUr,1,true))then begin
			RecordCopy(OldCUr,CUr);
			CUr.Name = sfield1;
			CUr.InvAddr1 = sfield2;
			CUr.Person = sfield3;
			CUr.Phone = sfield4;
			CUr.eMail = sfield5;
			Cur.PlanShipDays = StringToInt(sfield6);
			if(RecordUpdate(OldCUr,CUr,false)==0)then begin end;
		end else begin
			if(nonblank(sfield0))then begin
				RecordNew(CUr);
				CUr.Code = sfield0;
				CUr.Name = sfield1;
				CUr.InvAddr1 = sfield2;
				CUr.Person = sfield3;
				CUr.Phone = sfield4;
				CUr.eMail = sfield5;
				Cur.PlanShipDays = StringToInt(sfield6);
				RecordInsert(CUr,false);
			end;
		end;
		NextImportLine(true);
	end;
	return;
end;






global updating procedure IMportINMainIn()
begin
	record INVc INr,oldINr;
	record GlobalItemVc GIr;
	integer i,curc;
	boolean TrHs,foundf;
	string 50 code,maincode;
	
	curc = currentcompany;
	
	TrHs = true;
	while (TestEOF()==false) begin
		code = ImportField;
		logtext(0,code);
		INr.Code=code;
		if(ReadFirstMain(INr,1,true)) then begin
			if(INr.MainCode!=INr.Code)then begin
				INr.MainCode = ImportField;
				oldINr.Code = INr.MainCode;
				if(readfirstmain(oldINr,1,true))then begin
					GIr.HansaCode = oldINr.Code;
					if(readfirstkey("HansaCode",GIr,1,true)==false)then begin
						CreateNewGlobalItem(oldINr);
						recordstore(oldINr,true);
					end;
					GIr.HansaCode = code;
					foundf = false;
					if(readfirstkey("HansaCode",GIr,1,true))then begin
						UpdateGlobalItem(INr);
					end else begin
						CreateNewGlobalItem(INr);
					end;
					RecordStore(INr,True);
				end;
			end;
		end;
		NextImportLine(true);
	end;
	//resetcompany(curc);
	return;
end;







global updating procedure IMportINMainIn()
begin
	record INVc INr,oldINr;
	record GlobalItemVc GIr;
	integer i,curc;
	boolean TrHs,foundf;
	string 50 code,maincode;
	
	curc = currentcompany;
	
	TrHs = true;
	while (TestEOF()==false) begin
		code = ImportField;
		logtext(0,code);
		INr.Code=code;
		if(ReadFirstMain(INr,1,true)) then begin
			if(INr.MainCode!=INr.Code)then begin
				INr.MainCode = ImportField;
				oldINr.Code = INr.MainCode;
				if(readfirstmain(oldINr,1,true))then begin
					GIr.HansaCode = oldINr.Code;
					if(readfirstkey("HansaCode",GIr,1,true)==false)then begin
						CreateNewGlobalItem(oldINr);
						recordstore(oldINr,true);
					end;
					GIr.HansaCode = code;
					foundf = false;
					if(readfirstkey("HansaCode",GIr,1,true))then begin
						UpdateGlobalItem(INr);
					end else begin
						CreateNewGlobalItem(INr);
					end;
					RecordStore(INr,True);
				end;
			end;
		end;
		NextImportLine(true);
	end;
	//resetcompany(curc);
	return;
end;




Global updating procedure ImportABCINIn()
begin
	record INVc INr;
	record RebVc Rebr;
	record ITVc ITr;
	integer i;
	string 255 sfield0,sfield1,sfield2,sfield3,sfield4,sfield5,sfield6,sfield7,color,size;
		
	while (TestEOF()==false) begin
		sfield0 = "";
		sfield1 = "";
		sfield2 = "";
		sfield3 = "";
		sfield4 = "";
		sfield5 = "";
		sfield6 = "";
		sfield0 = ImportField;
		if(nonblank(sfield0))then begin
			FormatUpperCaseCode(sfield0);
			sfield1 = ImportField;
			if(nonblank(sfield1))then begin
				FormatUpperCaseCode(sfield1);
				if(sfield1!="A" and sfield1!="B" and sfield1!="C" and sfield1!="E")then begin
					sfield1 = "";
				end;
			end;
			sfield2 = ImportField;
			if(nonblank(sfield2))then begin
				FormatUpperCaseCode(sfield2);
				if(sfield2!="S" and sfield2!="X" and sfield2!="Y" and sfield2!="Z")then begin
					sfield2 = "";
				end;
			end;
			sfield3 = ImportField;
			if(nonblank(sfield3))then begin
				FormatUpperCaseCode(sfield3);
				if(sfield3!="C" and sfield3!="D")then begin
					sfield3 = "";
				end;
			end;
			sfield4 = ImportField;
			sfield5 = ImportField;
			if(nonblank(sfield5))then begin
				FormatUpperCaseCode(sfield5);
				if(sfield5!="S" and sfield5!="L")then begin
					sfield5 = "";
				end;
			end;
			sfield6 = ImportField;
			//logtext(0,sfield0 & " <> " & sfield1 & " <> " & sfield2 & " <> " & sfield3 & " <> " & sfield4 & " <> " & sfield5);
			INr.Code = sfield0;
			if(ReadFirstMain(INr,1,true))then begin
				if(nonblank(sfield1))then begin
					INr.ItemCat = sfield1;
				end;
				if(nonblank(sfield2))then begin
					INr.SubItemCat = sfield2;
				end;
				if(nonblank(sfield3))then begin
					INr.TypeSeasNeeds = sfield3;
				end;
				if(nonblank(sfield4))then begin
					INr.LeadTime = sfield4;
				end;
				if(nonblank(sfield5))then begin
					INr.LifeCicle = sfield5;
				end;
				if(nonblank(sfield6))then begin
					INr.SeasonalReorderMonth = sfield6;
				end;
				recordStore(INr,True);
			end;//if RFM INr
		end;//if nonblank(sfield0)
		NextImportLine(true);
	end;
	return;
end;

















global updating procedure AddInchesMn(record RcVc RepSpec)
begin
	record INVc INr;
	
	
	while(loopmain(INr,1,true))begin
		INr.Unittext = "˜’";
		INr.UpdateCost = 1;
		recordStore(INr,true);
	end;

return;
end;


global
updating procedure ImpCLOut()
BEGIN


    RegisterImport("ITVc2");

  RETURN;
END;


global
updating procedure ImpDocVc()
BEGIN

    RegisterImport("doc3");

  RETURN;
END;




global
updating procedure INImportCostsIn()		//Edit----------------------Dima  10.02.2015
begin
  record INVc INr;
  string 70 code;
  string 15 cost;



	while (TestEOF()==false) begin
			code = ImportField;
			cost = ImportField;
	
			if(nonblank(code) and nonblank(cost)) then begin

				INr.Code = code;				
				if (ReadFirstMain(INr,1,true)) then begin
					INr.InPrice = StringToVal(cost,M4Val);
					RecordStore(INr,true);
				end;
			end;								
				
			if (NextImportLine(true)) then begin end;
	end;		

return;
end;



global
updating procedure ImportOfRegister(record RcVc RepSpec)	//Edit----------------------Dima  28.05.2015
BEGIN
string 100 tag;
boolean first;
		if(first==false)then begin
			tag = ImportField;
		end;
		
		logtext(0,"ImportOfRegister tag " & tag);
		if(first==false)then begin
			first = true;
			RegisterImport(tag);
    end;
  RETURN;
END;



global
updating procedure ImportOfRegisterRewriting(record RcVc RepSpec)	//Edit----------------------Dima  28.05.2015
BEGIN
string 100 tag;
string 50 registerVc;
	record LocClVc LocClr,oldLocClr;
	record INVc INr;
	record CLInVc CLInr;
	record CLOutVc CLOutr;
	record IPVc IPr;
	record OPVc OPr;
	record IVVc IVr;
	record VIVc VIr;
	record POVc POr;
	record SHVc SHr;
	record PUVc PUr;
	record SDVc SDr;
	record StockMovVc StockMovr;
	record RetVc Retr;
	record RetPUVc RetPUr;
	record ORVc ORr;
	record TRVc TRr;
	record FBVc FBr;
	record ItemHistVc IHr;
	record ItemStatusVc ISr;
	record AccVc Accr;
	record DocVc Docr;
	
	registerVc = UpperCase(RepSpec.f1);
	tag = ImportField;

	if (nonblank(registerVc))	then begin
		while (NextImportLine(false)) begin
			switch(registerVc) begin
				case "LOCCLVC": 					 	
 			  	  ImportOneRecord(LocClr,tag);
 			  	  oldLocClr.Code = LocClr.Code;
 			  	  if (ReadFirstMain(oldLocClr,1,true)) then begin  	  
							RecordUpdate(oldLocClr,LocClr,false);
						end else begin
							RecordStore(LocClr,false);
						end;
				case "DocVc": 					 	
 			  	  ImportOneRecord(Docr,tag);
 			  	  RecordStore(Docr,true);
				
				case "INVC": 					 	
 			  	  ImportOneRecord(INr,tag);
 			  	  RecordStore(INr,true);
 			  	  
				case "CLINVC": 					 	
 			  	  ImportOneRecord(CLInr,tag);
 			  	  RecordStore(CLInr,true); 
 			  	  
				case "CLOUTVC": 					 	
 			  	  ImportOneRecord(CLOutr,tag);
 			  	  RecordStore(CLOutr,true); 
 			  	  
				case "IPVC": 					 	
 			  	  ImportOneRecord(IPr,tag);
 			  	  RecordStore(IPr,true); 
 			  	  
				case "OPVC": 					 	
 			  	  ImportOneRecord(OPr,tag);
 			  	  RecordStore(OPr,true); 
 			  	  
				case "IVVC": 					 	
 			  	  ImportOneRecord(IVr,tag);
 			  	  RecordStore(IVr,true); 
 			  	  
				case "VIVC": 					 	
 			  	  ImportOneRecord(VIr,tag);
 			  	  RecordStore(VIr,true); 
 			  	  
				case "POVC": 					 	
 			  	  ImportOneRecord(POr,tag);
 			  	  RecordStore(POr,true); 
 			  	  
				case "PUVC": 					 	
 			  	  ImportOneRecord(PUr,tag);
 			  	  RecordStore(PUr,true); 
 			  	  
				case "SDVC": 					 	
 			  	  ImportOneRecord(SDr,tag);
 			  	  RecordStore(SDr,true); 
 			  	  
				case "STOCKMOVVC": 					 	
 			  	  ImportOneRecord(StockMovr,tag);
 			  	  RecordStore(StockMovr,true); 
 			  	  
				case "RETVC": 					 	
 			  	  ImportOneRecord(Retr,tag);
 			  	  RecordStore(Retr,true); 
 			  	  
				case "RETPUVC": 					 	
 			  	  ImportOneRecord(RetPUr,tag);
 			  	  RecordStore(RetPUr,true);
 			  	  
				case "ORVC": 					 	
 			  	  ImportOneRecord(ORr,tag);
 			  	  RecordStore(ORr,true);
 			  	  
				case "TRVC": 					 	
 			  	  ImportOneRecord(TRr,tag);
 			  	  RecordStore(TRr,true); 
 			  	  
				case "FBVC": 					 	
 			  	  ImportOneRecord(FBr,tag);
 			  	  RecordStore(FBr,true);
 			  	  
				case "ITEMHISTVC": 					 	
 			  	  ImportOneRecord(IHr,tag);
 			  	  RecordStore(IHr,true); 
 			  	  
				case "ITEMSTATUSVC": 					 	
 			  	  ImportOneRecord(ISr,tag);
 			  	  RecordStore(ISr,true);
 			  	  
 			  case "AccVc": 					 	
 			  	  ImportOneRecord(Accr,tag);
 			  	  RecordStore(Accr,true);  			  	   			  	   			  	  			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	   			  	  			  	  
					
			end;
		end;	
  end;  

  RETURN;
END;


Global updating procedure ImportBarCodesIn()
begin
	record INVc INr;
	record RebVc Rebr;
	record ITVc ITr;
	integer i;
	string 255 artcode,barcode;
		
	while (TestEOF()==false) begin
		artcode = ImportField;
		barcode = ImportField;
		if(nonblank(artcode) and nonblank(barcode))then begin
			INr.Code = artcode;
			if(readfirstmain(INr,1,true))then begin
				if(nonblank(INr.BarCode) and INr.BarCode!=barcode)then begin
					INr.BarCode = barcode;
					INr.AlternativeCode = barcode;
					INr.EKNCode = barcode;
					recordstore(INr,true);
				end else begin
					if(blank(INr.BarCode) and nonblank(INr.AlternativeCode) and INr.AlternativeCode!=barcode)then begin
						INr.BarCode = barcode;
						INr.AlternativeCode = barcode;
						INr.EKNCode = barcode;
						recordstore(INr,true);
					end;
				end;
			end;
		end;
		
		NextImportLine(true);
	end;
	return;
end;

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure HandleCUClassificationIn(integer mode)
begin
  record CUVc CUr;
  record CClassVc CClassr,CClass2r;
  string 20 code;
  string 255 importedClass,importedClassForExchange,newClassList,extractedClass;
  Boolean storeF;
  Integer pos;

	while (TestEOF()==false) begin
			code = ImportField;
			importedClass = UpperCase(ImportField);
			if (mode==1) then begin
			  importedClassForExchange = UpperCase(ImportField);
			end;

			if(nonblank(code)) then begin
				CUr.Code = code;				
				if (ReadFirstMain(CUr,1,true)) then begin
					storeF = false;
					switch (mode) begin
					  case 0: //add classification
					    if (NonBlank(importedClass)) then begin
					      pos = 0;
                ExtractObj(importedClass,pos,extractedClass);
                while (nonblank(extractedClass)) begin
                  CClassr.Code = extractedClass;
                  if (ReadFirstMain(CClassr,1,true) and SetInSet(extractedClass,CUr.Classification)==false) then begin
                    if (NonBlank(CUr.Classification)) then begin
                      CUr.Classification = CUr.Classification & ",";
                    end;
                    CUr.Classification = CUr.Classification & extractedClass;
                    storeF = true;
                  end;
                  ExtractObj(importedClass,pos,extractedClass);
                end;
					    end;
					  case 1: //exchange classification
              pos = 0;
              ExtractObj(importedClass,pos,extractedClass);
              importedClass = extractedClass;
              pos = 0;
              ExtractObj(importedClassForExchange,pos,extractedClass);
              importedClassForExchange = extractedClass;
              
              newClassList = "";
              CClassr.Code = extractedClass;
              CClass2r.Code = importedClassForExchange;
              if (ReadFirstMain(CClassr,1,true) and ReadFirstMain(CClass2r,1,true)) then begin
                if (NonBlank(importedClass) and NonBlank(importedClassForExchange)) then begin
                  pos = 0;
                  ExtractObj(CUr.Classification,pos,extractedClass);
                  while (NonBlank(extractedClass)) begin
                    if (NonBlank(newClassList)) then begin
                      newClassList = newClassList & ",";
                    end;
                    if (extractedClass==importedClass) then begin
                      newClassList = newClassList & importedClassForExchange;
                    end else begin
                      newClassList = newClassList & extractedClass;
                    end;
                    ExtractObj(CUr.Classification,pos,extractedClass);
                  end; 
                  if (newClassList!=CUr.Classification) then begin
                    CUr.Classification = newClassList;
                    storeF = true;
                  end;
                end;
              end;
					  case 2: //remove classification
					    if (NonBlank(importedClass) and NonBlank(CUr.Classification)) then begin
					      pos = 0;
					      newClassList = "";
                ExtractObj(CUr.Classification,pos,extractedClass);
                while (nonblank(extractedClass)) begin
                  if (SetInSet(extractedClass,importedClass)==false) then begin
                    if (NonBlank(newClassList)) then begin
                      newClassList = newClassList & ",";
                    end;
                    newClassList = newClassList & extractedClass;
                  end;
                  ExtractObj(CUr.Classification,pos,extractedClass);
                end;
                if (newClassList!=CUr.Classification) then begin
                  CUr.Classification = newClassList;
                  storeF = true;
                end;
					    end;
					    if (Blank(importedClass) and NonBlank(CUr.Classification)) then begin //clear up CUVc classifications
					      CUr.Classification = "";
                storeF = true;
					    end;
					end;
					if (storeF) then begin
					  RecordStore(CUr,true);
					end;
				end;
			end;								
				
			if (NextImportLine(true)) then begin end;
	end;		

return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure AddCUClassificationIn(record RcVc RepSpec)
begin
  
  HandleCUClassificationIn(0);
  
return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure ChangeCUClassificationIn(record RcVc RepSpec)
begin
  
  HandleCUClassificationIn(1);
  
return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure RemoveCUClassificationIn(record RcVc RepSpec)
begin
  
  HandleCUClassificationIn(2);
  
return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }


global updating procedure ImportIDEACUIn()
begin
	record CUVc CUr;
	string 255 mfrno,mfrname,mfrnameshort;
	string 255 adres,citystate,contact;
	string 255 phone,mail,maxday,minmax;
	string 255 coef,onproj;
	record ObjVc Objr;
	record DIVc DIr;
	
	while (TestEOF()==false) begin
		mfrno = ImportField;
		mfrname = ImportField;
		mfrnameshort = ImportField;
		adres = ImportField;
		citystate = ImportField;
		contact = ImportField;
		phone = ImportField;
		mail = ImportField;
		maxday = ImportField;
		minmax = ImportField;
		coef = ImportField;
		onproj = ImportField;
		
		/*if(nonblank(mfrno))then begin
			CUr.Code = mfrno;
			if(readfirstmain(CUr,1,true))then begin
				CUr.Name = " " & CUr.Name;
				recordstore(CUr,true);
			end;
		end;*/
		
		if(nonblank(mfrno))then begin
			recordnew(CUr);
				CUr.Code = mfrno;
				CUr.VEType = 1;
				CUr.CUType = 0;
				CUr.Name = mfrname;
				if(blank(CUr.Name))then begin
					CUr.Name = "blank_name";
				end;
				CUr.Phone = phone;
				CUr.InvAddr0 = adres;
				CUr.InvAddr1 = citystate;
				CUr.InvAddr2 = contact;
				CUr.Person =contact;
				CUr.SearchKey = mfrnameshort;
				CUr.Comment = coef & "," & onproj;		
				CUr.OnAccount = 1;
				CUr.SelfBilling = 1;
				CUr.VEVATCode = "0%I";
				CUr.AccAP = "60";
				CUr.AccCost = "41/01";
				CUr.OnAccAccAP = "64";
				
				Objr.Code = CUr.Code;
				if(readfirstmain(Objr,1,true)==false)then begin
					recordnew(Objr);
					Objr.Code = CUr.Code;
					Objr.Comment = CUr.Name;
					Objr.OTCode = "BRAND";
					recordstore(Objr,true);
				end;
				
				DIr.Code = CUr.Code;
				if(readfirstmain(DIr,1,true)==false)then begin
					recordnew(Objr);
					DIr.Code = CUr.Code;
					DIr.Name = CUr.Name;
					DIr.CType = "BRAND";
					recordstore(DIr,true);
				end;
			
				if(nonblank(maxday))then begin
					CUr.PlanShipDays = stringtoint(maxday);	
				end;
				if(nonblank(minmax))then begin
					CUr.PlanShipDaysMin = stringtoint(minmax);	
				end;
			recordstore(CUr,true);
		end;
		if (NextImportLine(true)) then begin end;
	end;
	
return;
end;



global updating procedure FixIDEAMn()
begin
	record CUVc CUr;
	boolean TrHs,testf;
	
	CUr.Code = "0000001";
	TrHs = true;
	while(loopmain(CUr,1,TrHs))begin
		testf = true;
		if(CUr.Code<"0000001")then begin TrHs = false; testf = false; end;
		if(CUr.Code>"0000424")then begin TrHs = false; testf = false; end;
		if(CUr.VEType==0)then begin testf = false; end;
		if(CUr.Code=="00001")then begin testf = false; end;
		
		
		if(testf)then begin
			//CUr.Name = " " & CUr.Name;
      if (left(CUr.Name,1)==" ") then begin
        CUr.Name = right(CUr.Name,len(CUr.Name)-1);
        CUr.VECat = "IDEA";
      end;
			recordstore(CUr,true);
		end;
	end;
	
	
return;
end;

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure ItemsClassificationsImportIn(record RcVc RepSpec)
begin
	record INVc INr;
	string 100 artcode,brand,collection,group,textbrand,dinameu;  
	string 100 subgrp,category,material,color,shape,size,use,sex,plating,clarity,weight,cut,stone,strap,odour;  
  record OldDIVc DIr;
  record ITVc ITr;
  vector boolean difnd;
  vector string 100 itfind,difound;
  boolean testf,tst,itemfounfd,brnotfound,zerrofl,zerrofl2,zerrofl3;
  integer i,ci,curcmp;
  array string 100 abrnd;
  integer acnt;
  record BPIBrandVc BBr;
  vector string 100 vBrandName;
  
  while(loopmain(BBr,1,true))begin
  	vBrandName[BBr.Code] = BBr.Name;
  end;
  
	curcmp = currentcompany;
	
	for(ci=1;ci<29;ci=ci+1)begin
		tst = true;
		if(ci!=3 and CompanyIsJWLikeCompany(ci))then begin
			tst = false;
		end;
		
		if(tst)then begin

			resetloop(ITr);
			ITr.Code = "";
			while(loopmain(ITr,1,true))begin
					dinameu = uppercase(ITr.Comment);
					itfind[ITr.Code] = dinameu;
			end;

			resetloop(DIr);
			DIr.Code = "";
			while(loopmain(DIr,1,true))begin
				if(DIr.CType=="BRAND")then begin
					abrnd[acnt] = DIr.Code;
					difound[DIr.Code] = uppercase(DIr.Name);
					acnt = acnt + 1;
				end;
			end;
		end;
	end;


  
  while (TestEOF()==false) begin
  	itemfounfd = false;
  	artcode = ImportField;
  	textbrand = ImportField;
  	brand = ImportField;
  	collection = ImportField;
  	group = ImportField;
  	subgrp = ImportField;
		category = ImportField;
		material = ImportField;
		color = ImportField;
		shape = ImportField;
		size = ImportField;
		use = ImportField;
		sex = ImportField;
		plating = ImportField;
		clarity = ImportField;
		weight = ImportField;
		cut = ImportField;
		stone = ImportField;
		strap = ImportField;
		odour = ImportField;
		
		for(ci=1;ci<29;ci=ci+1)begin
			tst = true;
			if(ci!=3 and CompanyIsJWLikeCompany(ci))then begin
				tst = false;
			end;
			if(ci==10)then begin
				tst = false;
			end;
			if(ci==11)then begin
				tst = false;
			end;
			if(ci==12)then begin
				tst = false;
			end;
			
			if(tst)then begin
				setcompany(ci,false);
				INr.Code = artcode;
				zerrofl = true;
				zerrofl2 = true;
				zerrofl3 = true;
	lItemsClassificationsImportIn:;
				if(readfirstmain(INr,1,true))then begin
					brnotfound = false;
					itemfounfd = false;
					testf = true;
					if(nonblank(INr.Group))then begin
						if(left(itfind[INr.Group],len(textbrand))!=textbrand)then begin
							testf = false;
						end else begin
							itemfounfd = true;
						end;
					end else begin
						for(i=0;i<acnt;i=i+1)begin
							if(setinset(abrnd[i],INr.OldDispGroups))then begin
								if(left(difound[abrnd[i]],len(textbrand))!=textbrand)then begin
									testf = false;
								end else begin
									itemfounfd = true;	
								end;
							end else begin
								brnotfound = true;
							end;
						end;
					end;
					if(currentcompany==1 and brand=="BRND0171")then begin
						testf = true;
					end;
					if(currentcompany==2 and brand=="BRND0117")then begin
						testf = true;
					end;
					if(currentcompany==4 and brand=="BRND0182")then begin
						testf = true;
					end;
					if(currentcompany==5 and brand=="BRND0153")then begin
						testf = true;
					end;
					if(currentcompany==6 and brand=="BRND0013")then begin
						testf = true;
					end;
					if(currentcompany==25 and brand=="BRND0046")then begin
						testf = true;
					end;
				
					if(blank(INr.Group) and brnotfound and testf==false)then begin
						testf = true;
					end;

					if(nonblank(INr.BPIBrand) and INr.BPIBrand==brand)then begin
						//testf = true;
					end;
					
					if(blank(INr.BPIGroup) and testf==false)then begin
						//logtext(0,currentcompany & chr(9) & INr.Code & chr(9) & INr.Group & chr(9) & vBrandName[brand]);
						/*if(INr.Group=="AL_P" and vBrandName[brand]=="ALEXANDRE TURPAULT ")then begin testf = true; end;
						if(INr.Group=="ALFI" and vBrandName[brand]=="ALFI")then begin testf = true; end;
						if(INr.Group=="AN_AC" and vBrandName[brand]=="KARE")then begin testf = true; end;
						if(INr.Group=="AN_FU" and vBrandName[brand]=="KARE")then begin testf = true; end;
						if(INr.Group=="BEKA" and vBrandName[brand]=="BEKA")then begin testf = true; end;
						if(INr.Group=="BERNP" and vBrandName[brand]=="BERNARDAUD")then begin testf = true; end;
						if(INr.Group=="BOHEM" and vBrandName[brand]=="BOHEMIA")then begin testf = true; end;
						if(INr.Group=="BR" and vBrandName[brand]=="BRABANTIA")then begin testf = true; end;
						if(INr.Group=="BR_K" and vBrandName[brand]=="BRABANTIA")then begin testf = true; end;
						if(INr.Group=="BR_LC" and vBrandName[brand]=="BRABANTIA")then begin testf = true; end;
						if(INr.Group=="BRAB" and vBrandName[brand]=="BRABANTIA")then begin testf = true; end;
						if(INr.Group=="CANDI" and vBrandName[brand]=="CANDINO")then begin testf = true; end;
						if(INr.Group=="CHR_A" and vBrandName[brand]=="CHRISTOFLE")then begin testf = true; end;
						if(INr.Group=="CHR_F" and vBrandName[brand]=="CHRISTOFLE")then begin testf = true; end;
						if(INr.Group=="CHR_P" and vBrandName[brand]=="CHRISTOFLE")then begin testf = true; end;
						if(INr.Group=="CHURC" and vBrandName[brand]=="CHURCHILL")then begin testf = true; end;
						if(INr.Group=="COG_R" and vBrandName[brand]=="COGAL")then begin testf = true; end;
						if(INr.Group=="COG_T" and vBrandName[brand]=="COGAL")then begin testf = true; end;
						if(INr.Group=="CRIST" and vBrandName[brand]=="CHRISTOFLE")then begin testf = true; end;
						if(INr.Group=="D_S_M" and vBrandName[brand]=="SVAD DONDI")then begin testf = true; end;
						if(INr.Group=="D_S_P" and vBrandName[brand]=="SVAD DONDI")then begin testf = true; end;
						if(INr.Group=="DEKOR" and vBrandName[brand]=="DEKORATIEF  ")then begin testf = true; end;
						if(INr.Group=="DG" and vBrandName[brand]=="De Grisogono")then begin testf = true; end;
						if(INr.Group=="DUPON" and vBrandName[brand]=="Dupont")then begin testf = true; end;
						if(INr.Group=="EGIZI" and vBrandName[brand]=="EGIZIA")then begin testf = true; end;
						if(INr.Group=="ESCAD" and vBrandName[brand]=="ESCADA")then begin testf = true; end;
						if(INr.Group=="F_C_T" and vBrandName[brand]=="CHRISTIAN FISCHBACHER")then begin testf = true; end;
						if(INr.Group=="FESTI" and vBrandName[brand]=="FESTINA")then begin testf = true; end;
						if(INr.Group=="FIS_M" and vBrandName[brand]=="CHRISTIAN FISCHBACHER")then begin testf = true; end;
						if(INr.Group=="FIS_P" and vBrandName[brand]=="CHRISTIAN FISCHBACHER")then begin testf = true; end;
						if(INr.Group=="FISL3" and vBrandName[brand]=="CHRISTIAN FISCHBACHER")then begin testf = true; end;
						if(INr.Group=="FISSL" and vBrandName[brand]=="FISSLER")then begin testf = true; end;*/
						
						testf = true;
						
						if(INr.Group=="AN_AC" and vBrandName[brand]=="CRABTREE&EVELYN")then begin testf = false; end;
						if(INr.Group=="AND_A" and vBrandName[brand]=="IVV")then begin testf = false; end;
						if(INr.Group=="ARCA" and vBrandName[brand]=="CRABTREE&EVELYN")then begin testf = false; end;
						if(INr.Group=="ARCA" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="BODUM" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="CHOPA" and vBrandName[brand]=="CRABTREE&EVELYN")then begin testf = false; end;
						if(INr.Group=="COLLE" and vBrandName[brand]=="RALPH LAUREN HOME")then begin testf = false; end;
						if(INr.Group=="CRA_E" and vBrandName[brand]=="IVV")then begin testf = false; end;
						if(INr.Group=="CRA_E" and vBrandName[brand]=="KARE")then begin testf = false; end;
						if(INr.Group=="CRA_E" and vBrandName[brand]=="LE JACQUARD")then begin testf = false; end;
						if(INr.Group=="CRABT" and vBrandName[brand]=="KARE")then begin testf = false; end;
						if(INr.Group=="DUPON" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="KATRI" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="LAMP" and vBrandName[brand]=="HELIOS")then begin testf = false; end;
						if(INr.Group=="LANGN" and vBrandName[brand]=="KARE")then begin testf = false; end;
						if(INr.Group=="LE_JA" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="LE_JA" and vBrandName[brand]=="KATRIN LEUZE")then begin testf = false; end;
						if(INr.Group=="LE_JA" and vBrandName[brand]=="LALIQUE")then begin testf = false; end;
						if(INr.Group=="LIGHT" and vBrandName[brand]=="LALIQUE")then begin testf = false; end;
						if(INr.Group=="LJ_FR" and vBrandName[brand]=="LALIQUE")then begin testf = false; end;
						if(INr.Group=="POINT" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="RAL_M" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="S_H_F" and vBrandName[brand]=="Dupont")then begin testf = false; end;
						if(INr.Group=="SO_KB" and vBrandName[brand]=="TRUDI")then begin testf = false; end;
						if(INr.Group=="SO_KT" and vBrandName[brand]=="TRUDI")then begin testf = false; end;
						if(INr.Group=="SOHER" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="SZ" and vBrandName[brand]=="ADLER")then begin testf = false; end;
						if(INr.Group=="VAN_R" and vBrandName[brand]=="SIA HOME")then begin testf = false; end;
						if(INr.Group=="VAN_R" and vBrandName[brand]=="YVES DELORME")then begin testf = false; end;
						if(INr.Group=="Y_DEL" and vBrandName[brand]=="CRABTREE&EVELYN")then begin testf = false; end;
						if(INr.Group=="Y_DEL" and vBrandName[brand]=="DINH VAN")then begin testf = false; end;
						if(INr.Group=="YDM" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="YDP" and vBrandName[brand]=="LENOX")then begin testf = false; end;
						if(INr.Group=="YDP" and vBrandName[brand]=="SWAROVSKI")then begin testf = false; end;
						
						if(testf==false)then begin
							logtext(0,currentcompany & chr(9) & INr.Code & chr(9) & INr.Group & chr(9) & vBrandName[brand]);
						end;
					end;	
					if(testf)then begin
						INr.BPIBrand = brand;
						INr.BPICollection = collection;
						INr.BPIGroup = group;
						INr.BPISubGroup = subgrp;
						INr.BPICategory = category;
						INr.BPIMaterial = material;
						INr.BPIColor = color;
						INr.BPIShape = shape;
						INr.BPISize = size;
						INr.BPIUse = use;
						INr.BPISex = sex;
						INr.BPIPlating = plating;
						INr.BPIClarity = clarity;
						INr.BPIWeight = weight;
						INr.BPICut = cut;
						INr.BPIStone = stone;
						INr.BPIStrap = strap;
						INr.BPIOdour = odour;
						recordstore(INr,true);
					end;
				end else begin
					/*if(zerrofl)then begin
						INr.Code = "0" & artcode;
						zerrofl = false;
						goto lItemsClassificationsImportIn;
					end;
					if(zerrofl2)then begin
						INr.Code = "00" & artcode;
						zerrofl2 = false;
						goto lItemsClassificationsImportIn;
					end;
					if(zerrofl3)then begin
						INr.Code = "000" & artcode;
						zerrofl3 = false;
						goto lItemsClassificationsImportIn;
					end;*/
				end;
			end;
		
		end;
  	if (NextImportLine(true)) then begin end;
	end;
	resetcompany(curcmp);	
  
return;
end; //Edit***************************Sasha2,11:45 04.07.2017 }


global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure ImportSuppELevelIn(record RcVc RepSpec)
begin
	record CUVc CUr;
	string 100 cucode,elevel,deltype,supptype,prodtime;
	
	while (TestEOF()==false) begin
		
		cucode = ImportField;
		elevel = ImportField;
		deltype = ImportField;
		supptype = ImportField;
		prodtime = ImportField;
		
		if(nonblank(cucode))then begin
			CUr.Code = cucode;
			if(readfirstmain(CUr,1,true))then begin
				if(nonblank(elevel))then begin
					CUr.ELevel = evaltoval(elevel);
				end;
				if(nonblank(deltype))then begin
					CUr.DeliveryWay = stringtoint(deltype);
				end;
				if(nonblank(supptype))then begin
					CUr.DeliveryFrom = stringtoint(supptype);
				end;
				if(nonblank(prodtime))then begin
					CUr.PlanShipDaysMin = stringtoint(prodtime);
				end;
				recordstore(CUr,true);
			end;
		end;
		
		if (NextImportLine(true)) then begin end;
	end;
	
return;
end;

global 	//Edit***************************Sasha2,11:45 04.07.2017 {
updating procedure BMIn(record RcVc RepSpec)
begin
	record BPIBrandVc BBr;
	integer i;
	string 200 code,mng;
	i = 0;
	while (TestEOF()==false) begin
		code = ImportField;
		mng = ImportField;
		i = i+1;
		logtext(0,i);
		BBr.Code = code;
		if(ReadFirstMain(BBr,1,true)) then begin
			logtext(0,i);
			BBr.BrndMngr = mng;
			RecordStore(BBr,true);
		end;	
		if (NextImportLine(true)) then begin end;
	end;
	
return;
end;

global updating procedure ImportGroupsNewIn()
begin
	boolean floine,snrfnd;
	integer i,cnt;
	array string 100 group,subgrp;
	string 255 tmp;
	record NewClassSetVc NCSr;
	row NewClassSetVc NCSrw;
	record BPIBrandVc BPIBrandr;
	record BPICollectionVc BPICollectionr;
	record BPIGroupVc BPIGroupr;
	record BPISubGroupVc BPISubGroupr;
	record BPICategoryVc BPICategoryr;
	record BPIMaterialVc BPIMaterialr;
	record BPIColorVc BPIColorr;
	record BPIShapeVc BPIShaper;
	record BPISizeVc BPISizer;
	record BPIUseVc BPIUser;
	record BPISexVc BPISexr;
	record BPIPlatingVc BPIPlatingr;
	record BPIClarityVc BPIClarityr;
	record BPIWeightVc BPIWeightr;
	record BPICutVc BPICutr;
	record BPIStoneVc BPIStoner;
	record BPIStrapVc BPIStrapr;
	record BPIOdourVc BPIOdourr;
	vector string 100 vgroup,vsubgroup,vCategory,vMaterial,vColor,vShape,vSize,vUse,vSex,vPlating,vClarity,vWeight,vCut,vStone,vStrap,vOdour;
	integer catcnt,j;
	vector string 100 vcat;
	
	while(loopmain(BPICategoryr,1,true))begin
		vCategory[BPICategoryr.Name] = BPICategoryr.Code;
	end;
	
	while(loopmain(BPIMaterialr,1,true))begin
		vMaterial[BPIMaterialr.Name] = BPIMaterialr.Code;
	end;
	
	while(loopmain(BPIColorr,1,true))begin
		vColor[BPIColorr.Name] = BPIColorr.Code;
	end;
	
	while(loopmain(BPISizer,1,true))begin
		vSize[BPISizer.Name] = BPISizer.Code;
	end;
	
	while(loopmain(BPIShaper,1,true))begin
		vShape[BPIShaper.Name] = BPIShaper.Code;
	end;
	
	while(loopmain(BPIUser,1,true))begin
		vUse[BPIUser.Name] = BPIUser.Code;
	end;
	
	while(loopmain(BPISexr,1,true))begin
		vSex[BPISexr.Name] = BPISexr.Code;
	end;
	
	while(loopmain(BPIPlatingr,1,true))begin
		vPlating[BPIPlatingr.Name] = BPIPlatingr.Code;
	end;
	
	while(loopmain(BPIClarityr,1,true))begin
		vClarity[BPIClarityr.Name] = BPIClarityr.Code;
	end;
	
	while(loopmain(BPIWeightr,1,true))begin
		vWeight[BPIWeightr.Name] = BPIWeightr.Code;
	end;
	
	while(loopmain(BPICutr,1,true))begin
		vCut[BPICutr.Name] = BPICutr.Code;
	end;
	
	while(loopmain(BPIStoner,1,true))begin
		vStone[BPIStoner.Name] = BPIStoner.Code;
	end;
	
	while(loopmain(BPIStrapr,1,true))begin
		vStrap[BPIStrapr.Name] = BPIStrapr.Code;
	end;
	
	while(loopmain(BPIOdourr,1,true))begin
		vOdour[BPIOdourr.Name] = BPIOdourr.Code;
	end;
	
	
	
	while(loopmain(BPIGroupr,1,true))begin
		vgroup[BPIGroupr.Name] = BPIGroupr.Code;
	end;
	while(loopmain(BPISubGroupr,1,true))begin
		vsubgroup[BPISubGroupr.Name] = BPISubGroupr.Code;
	end;
	
	
	while(loopmain(NCSr,1,true))begin
		recorddelete(NCSr);
		stepback(NCSr);
	end;
	
	floine = false;
	while (TestEOF()==false) begin
		if(snrfnd)then begin
			logtext(0,"Import Categ===========");
			for(i=0;i<cnt;i=i+1)begin
				tmp = "";
				tmp = ImportField;
				vcat[catcnt & "_" & i] = tmp;
			end;
			catcnt = catcnt + 1;
		end;
		if(floine and snrfnd==false)then begin
			logtext(0,"Import SubGroups===========" & cnt);
			for(i=0;i<cnt;i=i+1)begin
				tmp = ImportField;
				subgrp[i] = tmp;
				snrfnd = true;
			end;
		end;
		
		if(floine==false)then begin
			logtext(0,"Import Groups===========");
			tmp = ImportField;
			while(nonblank(tmp))begin
				group[cnt] = tmp;
				cnt=cnt+1;
				tmp = ImportField;
			end;
			floine = true;
		end;
				
		if (NextImportLine(true)) then begin end;
	end;
	
	if(snrfnd)then begin
		for(i=1;i<cnt;i=i+1)begin
			recordnew(NCSr);
				NCSr.Group = vgroup[group[i]];
				if(blank(NCSr.Group))then begin
					NCSr.Group = group[i];
				end;
				NCSr.Type = vsubgroup[subgrp[i]];
				if(blank(NCSr.Type))then begin
					NCSr.Group = subgrp[i];
				end;
				NCSr.GroupName = group[i];
				NCSr.TypeName = subgrp[i];

				for(j=0;j<catcnt;j=j+1)begin
					if(nonblank(vcat[j & "_" & i]))then begin
						NCSrw.CType = vcat[j & "_" & 0];
						NCSrw.CCode = vcat[j & "_" & i];
						NCSrw.CTypeName = vcat[j & "_" & 0];
						NCSrw.CCodeName = vcat[j & "_" & i];
						switch(vcat[j & "_" & 0]) begin
							case "Category": NCSrw.CType = "CATEGORY";
							NCSrw.CCode = vCategory[vcat[j & "_" & i]];
							case "Clarity": NCSrw.CType = "CLARITY";
							NCSrw.CCode = vClarity[vcat[j & "_" & i]];
							case "Color": NCSrw.CType = "COLOR";
							NCSrw.CCode = vColor[vcat[j & "_" & i]];
							case "Cut": NCSrw.CType = "CUT";
							NCSrw.CCode = vCut[vcat[j & "_" & i]];
							case "Material": NCSrw.CType = "MATERIAL";
							NCSrw.CCode = vMaterial[vcat[j & "_" & i]];
							case "Odour": NCSrw.CType = "ODOUR";
							NCSrw.CCode = vOdour[vcat[j & "_" & i]];
							case "Plating": NCSrw.CType = "PLATING";
							NCSrw.CCode = vPlating[vcat[j & "_" & i]];
							case "Sex": NCSrw.CType = "SEX";
							NCSrw.CCode = vSex[vcat[j & "_" & i]];
							case "Shape": NCSrw.CType = "SHAPE";
							NCSrw.CCode = vShape[vcat[j & "_" & i]];
							case "Size": NCSrw.CType = "SIZE";
							NCSrw.CCode = vSize[vcat[j & "_" & i]];
							case "Stone": NCSrw.CType = "STONE";
							NCSrw.CCode = vStone[vcat[j & "_" & i]];
							case "Strap": NCSrw.CType = "STRAP";
							NCSrw.CCode = vStrap[vcat[j & "_" & i]];
							case "Use": NCSrw.CType = "USE";
							NCSrw.CCode = vUse[vcat[j & "_" & i]];
							case "Weight": NCSrw.CType = "WEIGHT";
							NCSrw.CCode = vWeight[vcat[j & "_" & i]];
						end;
						
						matrowput(NCSr,matrowcnt(NCSr),NCSrw);
					end;
				end;
				
				logtext(0,"recordstore(NCSr,true);");
			recordstore(NCSr,true);
		end;
	end;

return;
end;

global updating procedure ImportABCXMLIn()
begin
	area axml;
	xml xdata;
	string 255 xkey,crncy,tstr,OwnID,BankID,ABC,XYZ,CurCode,CdtDbtInd,bookdate,impfilename;
	record INVc INr;
	longint cntchld,i,dcf;
	date ndat;
	area afile;
	
	logtext(0,"ImportABCIn " & GetImportFileName);
	cntchld = 0;
	xdata = ParseXMLFile(GetImportFileName);
	impfilename = "Categorization Data for Hansa.xml";
	addfiletoarea(GetImportFileName,afile,0);
	if(DirExists("CategorizationDataforHansa")==false)then begin
		CreateFolder("CategorizationDataforHansa");
	end;
	impfilename = impfilename & currentdate & "-" & currenttime;
	writeareatofile(afile,"CategorizationDataforHansa/" & impfilename,0);
	cntchld = XmlCountChildren(xdata,"dataroot");
	logtext(0,cntchld);
	for(i=0;i<cntchld;i=i+1) begin
		CurCode = XmlGet(xdata,"dataroot/Categorization_x0020_Data_x0020_for_x0020_Hansa[" & i & "]/Item_x0020_ID");
		logtext(0,CurCode);
		INr.Code=CUrCode;
		if(ReadFirstMain(INr,1,true)) then begin
			ABC = XmlGet(xdata,"dataroot/Categorization_x0020_Data_x0020_for_x0020_Hansa[" & i & "]/ABC_x002C__x0020_E");
			XYZ = XmlGet(xdata,"dataroot/Categorization_x0020_Data_x0020_for_x0020_Hansa[" & i & "]/XYZ_x002C__x0020_S");
			logtext(0,ABC & XYZ);
			INr.ItemCat = ABC;
			INr.SubItemCat = XYZ;
			RecordStore(INr,true);
		end;
	end;	
	
	while (TestEOF==false) begin
    tstr = ImportField;
    if (NextImportLine(true)) then begin
    end;
  end;
return;
end;

global webpublic updating procedure WebIDEAFixCost()
begin
	record INVc INr;
	
	setcompany(28,false);
	
	INr.Code = "";
	while(loopmain(INr,1,true))begin
		if(INr.LastPurchCurncyCode=="EUR")then begin
			if(INr.LastPurchPrice2>INr.InPrice)then begin
				logtext(0,INr.Code & "___" & INr.InPrice & "->" & round(INr.LastPurchPrice2 * 1.954,SetRoundModeD(2)));
				INr.InPrice = round(INr.LastPurchPrice2 * 1.954,SetRoundModeD(2));
				
				recordstore(INr,true);
			end;
		end;
	end;

return;
end;

global webpublic updating procedure WebIDEAChechIHPU()
begin
	record INVc INr;
	record PUVc PUr;
	row PUVc PUrw;
	record ItemHistVc IHr;
	integer i,mtrw;
	
	
	setcompany(28,false);
	
	PUr.SerNr = -1;
	while(loopmain(PUr,1,true))begin
		mtrw = matrowcnt(PUr);
		For(i=0;i<mtrw;i=i+1) begin
	  	matrowget(PUr,i,PUrw);
	  	IHr.FileName = "PUVc";
	  	IHr.TransNr = PUr.SerNr;
	  	IHr.Row = i;
	  	if(readfirstkey("FNTransNr",IHr,3,true))then begin
	  		if(IHr.TotCostPrice!=PUrw.Sum)then begin
	  			logtext(0,PUrw.ArtCode & "  " & PUrw.Sum & " -> " & IHr.TotCostPrice);
	  		end;
	  	end;
		end; 
	end;
	
return;
end;

global webpublic updating procedure WebIDEACheckCost()
begin
	record INVc INr;
	
	setcompany(28,false);
	
	INr.Code = "";
	while(loopmain(INr,1,true))begin
		if(INr.LastPurchPrice2==0 and INr.InPrice>0)then begin
			logtext(0,INr.Code & "___" & INr.InPrice & "->" & round(INr.LastPurchPrice2,SetRoundModeD(2)));
		end;
	end;

return;
end;

global webpublic updating procedure WebIDEACheckCostPU()
begin
	record INVc INr;
	record PUVc PUr;
	row PUVc PUrw;
	integer mtrw,i;
	boolean changed;
	
	setcompany(28,false);
	
	PUr.SerNr = 0;
	while(loopmain(PUr,1,true))begin
		changed = false;
		mtrw = matrowcnt(PUr);
		for(i=0;i<mtrw;i=i+1)begin
			matrowget(PUr,i,PUrw);
			if(true)then begin
				INr.Code = PUrw.ArtCode;
				if(readfirstmain(INr,1,true))then begin
					if(PUrw.UPrice!=INr.LastPurchPrice2 or PUrw.CostPrice!=INr.InPrice)then begin
						//logtext(0,PUrw.ArtCode & "  " & PUrw.UPrice & " " & PUrw.CostPrice);
						//logtext(0,INr.Code & "___" & INr.InPrice & "->" & INr.LastPurchPrice2);
					
						PUrw.UPrice = INr.LastPurchPrice2;
						if(PUrw.UPrice==blankval)then begin
							PUrw.UPrice = 0;
						end;
						PUrw.CostPrice = INr.InPrice;
						if(PUrw.CostPrice==blankval)then begin
							PUrw.CostPrice = 0;
						end;
						PUrw.Sum = INr.InPrice * PUrw.Quant;
						matrowput(PUr,i,PUrw);
						changed = true;
						logtext(0,PUrw.ArtCode);
						logtext(0,INr.Code & "___" & INr.InPrice & "->" & round(INr.LastPurchPrice2,SetRoundModeD(2)));
					end;
				//if(INr.LastPurchPrice2==0 and INr.InPrice>0)then begin
					//logtext(0,INr.Code & "___" & INr.InPrice & "->" & round(INr.LastPurchPrice2,SetRoundModeD(2)));
				end;	
				//end;
			end;
		end;
		if(changed)then begin
			//PUSumUp(PUr);
			recordstore(PUr,true);
		end;
	end;

return;
end;

global
updating procedure ImportFixCreativeCostIn()//   Edit-------------------------------------------Dima    23.12.2014  
begin
	record INVc INr;
	string 255 artcode,eurcost,azncost,creativeartcode;
	val eurvalcost,aznvalcost;
	
	while (TestEOF()==false) begin	
		artcode = importfield;
		creativeartcode = importfield;
		eurcost = importfield;
		azncost = importfield;
		
		if(nonblank(artcode))then begin
			INr.Code = artcode;
			if(readfirstmain(INr,1,true))then begin
				eurvalcost = blankval;
				aznvalcost = blankval;
				if(nonblank(eurcost))then begin
					eurvalcost =  stringtoval(eurcost,M45Val);
				end else begin
					eurvalcost = 0;
				end;
				if(nonblank(azncost))then begin
					aznvalcost =  stringtoval(azncost,M45Val);
				end else begin
					aznvalcost = 0;
				end;
				if(AbsoluteVal(INr.InPrice-aznvalcost)>1 or AbsoluteVal(INr.LastPurchPrice2-eurvalcost)>1)then begin
					INr.InPrice = aznvalcost;
					INr.LastPurchPrice2 = eurvalcost;
					logtext(0,INr.Code & " fixed");
					recordstore(INr,True);
				end;
			end;
		end;
		
		if (NextImportLine(true)) then begin end;
	end;
return;
end;


global
updating procedure PUImportIn()//   Edit-------------------------------------------Dima    23.12.2014  
begin
  record PUVc PUr,PU2r;
  row PUVc PUrw;
	record PosVc Posr;
  record LocationVc Locr;
  string 50 location,curLoc, artcode, quant,binNr,sum1,sum2,sum;
  Integer pucnt;
  record INVc INr;
	integer coefx;
	vector string 50 serialNr;
	record SysFormatBlock SysFormatRec;
  
  BlockLoad(SysFormatRec);
	
	pucnt =0;
	logtext(0,"start");
	while (TestEOF()==false) begin	
		PUr.CurncyCode = "EUR";
		artcode = ImportField;
		location = ImportField;
	
		if ((location == curLoc) and (pucnt < 999) and nonblank(artcode)) then begin	//çàïîëíåíèå òàáëèöû äàííûìè
			binNr = ImportField;
			quant = ImportField;

			PUr.FrRate = 1;
			PUr.ToRateB1 = 1.954;
			INr.Code = artcode;
			Posr.Code = binNr;
			if(blank(serialNr[artcode])) then begin
				Purw.SerialNr = "1";
				serialNr[artcode] = "1";
			end else begin 
				serialNr[artcode] = ValToString((StringToVal(serialNr[artcode],M4UVal)+1), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
				Purw.SerialNr = ValToString((StringToVal(serialNr[artcode],M4UVal)), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
			end;
			if(!ReadFirstMain(Posr,1,true)) then begin
				RecordNew(Posr);
				Posr.Code = binNr;
				Posr.Location = location;
				RecordStore(Posr,true);
				logtext(0,"new polochka " & Locr.Name);
			end;
			If(readfirstmain(INr,1,true))then begin
				coefx = INr.Conversion1;
				if(coefx<1)then begin
					coefx = 1;
				end;
				PUrw.ArtCode = artcode;
				//PUrw.UPrice = StringToVal(price,M45Val);
				PUrw.Quant = StringToVal(quant,M4UVal)*coefx;
				PUrw.UPrice = INr.LastPurchPrice2;
				if(PUrw.UPrice==blankval)then begin PUrw.UPrice = 0; end;
				PUrw.CostPrice = INr.InPrice;
				if(PUrw.CostPrice==blankval)then begin PUrw.CostPrice = 0; end;
				Purw.Sum = INr.InPrice * PUrw.Quant ;
		
				MatRowPut(PUr,pucnt,PUrw);
				PUVc_FillRow(PUr,pucnt);
				pucnt= pucnt + 1;	
			end else begin
				INr.Code = artcode;
				if(readfirstMain(INr,1,true))then begin
					PUrw.ArtCode = INr.Code;
					//PUrw.UPrice = StringToVal(price,M45Val);
					PUrw.Quant = StringToVal(quant,M4UVal);
					PUrw.UPrice = INr.LastPurchPrice2;
					if(PUrw.UPrice==blankval)then begin PUrw.UPrice = 0; end;
					PUrw.CostPrice = INr.InPrice;
					if(PUrw.CostPrice==blankval)then begin PUrw.CostPrice = 0; end;
					Purw.Sum = INr.InPrice * PUrw.Quant ;
					PUrw.ToPosCode = binNr;
					MatRowPut(PUr,pucnt,PUrw);
					PUVc_FillRow(PUr,pucnt);
					pucnt= pucnt + 1;	
				end;
			end;
		end else begin			//ñîçäàíèå íîâîé PU çàïèñè
			if (NonBlank(curLoc)) then begin			
				PUSumUp(PUr);
				RecordInsert(PUr,true);
			end;

			Locr.Code = location;

			if (nonblank(location) and ReadFirstMain(Locr,1,true) and nonblank(artcode)) then begin			
				logtext(0,location);
				RecordNew(PUr);				
  			PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,-1,false,"");  		
				pucnt = 0;
				binNr	=	ImportField;
				quant = ImportField;
      		
				PUr.Location = location;
				PUr.FrRate = 1;
				PUr.ToRateB1 = 1.954;
				Posr.Code = binNr;
			if(blank(serialNr[artcode])) then begin
						Purw.SerialNr = "1";
						serialNr[artcode] = "1";
					end else begin 
						serialNr[artcode] = ValToString((StringToVal(serialNr[artcode],M4UVal)+1), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
						Purw.SerialNr = ValToString((StringToVal(serialNr[artcode],M4UVal)), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
					end;
				if(!ReadFirstMain(Posr,1,true)) then begin
					RecordNew(Posr);
					Posr.Code = binNr;
					Posr.Location = location;
					RecordStore(Posr,true);
					logtext(0,"new polochka " & Locr.Name);
				end;
				INr.Code = artcode;
				If(readfirstmain(INr,1,true))then begin
					coefx = INr.Conversion1;
					if(coefx<1)then begin
						coefx = 1;
					end;
					PUrw.ArtCode = artcode;
					//PUrw.UPrice = StringToVal(price,M45Val);
					PUrw.Quant = StringToVal(quant,M4UVal)*coefx;
					PUrw.UPrice = INr.LastPurchPrice2;
					if(PUrw.UPrice==blankval)then begin PUrw.UPrice = 0; end;
					PUrw.CostPrice = INr.InPrice;
					if(PUrw.CostPrice==blankval)then begin PUrw.CostPrice = 0; end;
					Purw.Sum = INr.InPrice * PUrw.Quant ;
					PUrw.ToPosCode = binNr;
					MatRowPut(PUr,pucnt,PUrw);
					PUVc_FillRow(PUr,pucnt);
					pucnt= pucnt + 1;	
				end else begin
					INr.Code = artcode;
					if(readfirstMain(INr,1,true))then begin
						PUrw.ArtCode = INr.Code;
						//PUrw.UPrice = StringToVal(price,M45Val);
						PUrw.Quant = StringToVal(quant,M4UVal);
						PUrw.UPrice = INr.LastPurchPrice2;
						if(PUrw.UPrice==blankval)then begin PUrw.UPrice = 0; end;
						PUrw.CostPrice = INr.InPrice;
						if(PUrw.CostPrice==blankval)then begin PUrw.CostPrice = 0; end;
						Purw.Sum = INr.InPrice * PUrw.Quant ;
						MatRowPut(PUr,pucnt,PUrw);
						PUVc_FillRow(PUr,pucnt);
						pucnt= pucnt + 1;	
					end;
				end;
								     		
				curLoc = location;
			end;			
				
		end;
		
		if (NextImportLine(true)) then begin end;
	end;

	if (pucnt>0) then begin	//äîáàâëåíèå ïîñëåäíåé çàïèñè
 			PUSumUp(PUr);
			RecordInsert(PUr,true);	
	end;
logtext(0,"end");
return;
end;

global
updating procedure PUImportIn2()//   Edit-------------------------------------------Dima    23.12.2014  
begin
  record PUVc PUr,PU2r;
  row PUVc PUrw;
	record PosVc Posr;
  record LocationVc Locr;
  string 50 location,curLoc, artcode, quant,binNr,sum1,sum2,sum;
  Integer pucnt;
  record INVc INr;
	integer coefx;
	vector string 50 serialNr;
	record SysFormatBlock SysFormatRec;
  
  BlockLoad(SysFormatRec);
	
	pucnt =0;
	logtext(0,"start");
	while (TestEOF()==false) begin	
		PUr.CurncyCode = "EUR";
		artcode = ImportField;
		location = ImportField;
	
		if ((location == curLoc) and (pucnt < 999) and nonblank(artcode)) then begin	//çàïîëíåíèå òàáëèöû äàííûìè
			binNr = ImportField;
			quant = ImportField;
			sum1 = ImportField;
			if(blank(sum1))then begin sum1 = "0"; end;
			sum2 = ImportField;
			if(blank(sum2))then begin sum2 = "0"; end;
			PUr.FrRate = 1;
			PUr.ToRateB1 = 1.954;
			INr.Code = artcode;
			Posr.Code = binNr;
			if(blank(serialNr[artcode])) then begin
						Purw.SerialNr = "1";
						serialNr[artcode] = "1";
					end else begin 
						serialNr[artcode] = ValToString((StringToVal(serialNr[artcode],M4UVal)+1), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
						Purw.SerialNr = ValToString((StringToVal(serialNr[artcode],M4UVal)), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
					end;
			if(!ReadFirstMain(Posr,1,true)) then begin
					RecordNew(Posr);
					Posr.Code = binNr;
					Posr.Location = location;
					RecordStore(Posr,true);
					logtext(0,"new polochka " & Locr.Name);
			end;
			If(readfirstmain(INr,1,true))then begin
				coefx = INr.Conversion1;
				if(coefx<1)then begin
					coefx = 1;
				end;
				PUrw.ArtCode = artcode;
				//PUrw.UPrice = StringToVal(price,M45Val);
				PUrw.Quant = StringToVal(quant,M4UVal)*coefx;
				PUrw.UPrice = StringToVal(sum1,M4UVal);
				PUrw.CostPrice = StringToVal(sum2,M4UVal);
				PUrw.Sum = PUrw.CostPrice * PUrw.Quant;
				PUrw.ToPosCode = binNr;
				MatRowPut(PUr,pucnt,PUrw);
				PUVc_FillRow(PUr,pucnt);
				/*PUrw.UPrice = StringToVal(sum1,M4UVal);
						PUrw.CostPrice = StringToVal(sum2,M4UVal);
						PUrw.Sum = PUrw.CostPrice * PUrw.Quant;
						PUrw.UnitCode = INr.Unittext;
						MatRowPut(PUr,pucnt,PUrw);*/
				pucnt= pucnt + 1;	
			end else begin
				logtext(0,"ItemNotFound " & artcode);
			end;
		end else begin			//ñîçäàíèå íîâîé PU çàïèñè
			if (NonBlank(curLoc)) then begin			
				PUSumUp(PUr);
				RecordInsert(PUr,true);
			end;

			Locr.Code = location;

			if (nonblank(location) and ReadFirstMain(Locr,1,true) and nonblank(artcode)) then begin			
				logtext(0,location);
				RecordNew(PUr);				
  			PUr.SerNr = NextSerNr("PUVc",PUr.TransDate,-1,false,"");  		
				pucnt = 0;
				binNr	=	ImportField;
				quant = ImportField;
      	sum1 = ImportField;
				sum2 = ImportField;	
				PUr.Location = location;
				PUr.FrRate = 1;
				PUr.ToRateB1 = 1.954;
				Posr.Code = binNr;
				if(blank(serialNr[artcode])) then begin
						Purw.SerialNr = "1";
						serialNr[artcode] = "1";
					end else begin 
						serialNr[artcode] = ValToString((StringToVal(serialNr[artcode],M4UVal)+1), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
						Purw.SerialNr = ValToString((StringToVal(serialNr[artcode],M4UVal)), M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,0);
					end;
				if(!ReadFirstMain(Posr,1,true)) then begin
					RecordNew(Posr);
					Posr.Code = binNr;
					Posr.Location = location;
					RecordStore(Posr,true);
					logtext(0,"new polochka " & Locr.Name);
				end;
				INr.Code = artcode;
				If(readfirstmain(INr,1,true))then begin
					coefx = INr.Conversion1;
					if(coefx<1)then begin
						coefx = 1;
					end;
					PUrw.ArtCode = artcode;
					//PUrw.UPrice = StringToVal(price,M45Val);
					PUrw.Quant = StringToVal(quant,M4UVal)*coefx;
					PUrw.UPrice = StringToVal(sum1,M4UVal);
					PUrw.CostPrice = StringToVal(sum2,M4UVal);
					PUrw.Sum = PUrw.CostPrice * PUrw.Quant;
					PUrw.ToPosCode = binNr;
					MatRowPut(PUr,pucnt,PUrw);
					PUVc_FillRow(PUr,pucnt);
					/*PUrw.UPrice = StringToVal(sum1,M4UVal);
						PUrw.CostPrice = StringToVal(sum2,M4UVal);
						PUrw.Sum = PUrw.CostPrice * PUrw.Quant;
						PUrw.UnitCode = INr.Unittext;
						MatRowPut(PUr,pucnt,PUrw);*/
					pucnt= pucnt + 1;	
				end else begin
					logtext(0,"ItemNotFound " & artcode);
				end;
								     		
				curLoc = location;
			end;			
				
		end;
		
		if (NextImportLine(true)) then begin end;
	end;

	if (pucnt>0) then begin	//äîáàâëåíèå ïîñëåäíåé çàïèñè
 			PUSumUp(PUr);
			RecordInsert(PUr,true);	
	end;
logtext(0,"end");
return;
end;

global updating procedure OutOfOrderIn()
begin
record INVc INr;
integer i,curcomp,cnt;
string 100 item,brand;

	curcomp = currentcompany;
	logtext(0,"start");

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		logtext(0,cnt);
		item = importfield;
		brand = importfield;
		for(i=1;i<30; i=i+1) begin
			if(!CompanyIsJWLikeCompany(i) or i==3) then begin
				SetCompany(i,false);
				INr.Code = item;
				if(readfirstmain(INr,1,true)) begin
					if(INr.Code==item and INr.BPIBrand==brand and INr.OutOfOrder==0) then begin
						INr.OutOfOrder = 1;
						logtext(0,INr.Code);
						RecordStore(INr,true);
					end;
				end;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	SetCompany(curcomp,false);
	
logtext(0,"end");
return;
end;	


global updating procedure ChangeBPIGroupIn()
begin
record INVc INr;
integer i,curcomp,cnt;
string 100 item,brand,oldgroup,newgroup;
record BPIBrandVc BPIBrandr;
record BPIGroupVc BPIGroupr;


	curcomp = currentcompany;
	logtext(0,"start");

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		item = importfield;
		brand = importfield;
		oldgroup = importfield;
		newgroup = importfield;
		for(i=1;i<30; i=i+1) begin
			if(!CompanyIsJWLikeCompany(i) or i==3) then begin
				SetCompany(i,false);
				INr.Code = item;
				if(readfirstmain(INr,1,true)) begin
					BPIBrandr.Name = brand;
					if(readfirstkey("Name",BPIBrandr,1,true) and INr.BPIBrand==BPIBrandr.Code)then begin
						BPIGroupr.Name = oldgroup;
						if(readfirstkey("Name",BPIGroupr,1,true) and INr.BPIGroup==BPIGroupr.Code)then begin
							BPIGroupr.Name = newgroup;
							if(readfirstkey("Name",BPIGroupr,1,true))then begin
								logtext(0,INr.DispGroups & " <- " & INr.BPIGroup);
								logtext(0,setinset2(INr.BPIGroup,INr.DispGroups));
								if(setinset(INr.BPIGroup,INr.DispGroups))then begin
									logtext(0,"Try to change subgroup");
									logtext(0,INr.DispGroups & " -> " & StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code));
									INr.DispGroups = StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code);
									
								end;
								INr.BPIGroup = BPIGroupr.Code;
								logtext(0,INr.Code);
								recordstore(INr,true);
							end;
						end;
					end;
				end;
			end;
		end;
		if (NextImportLine(true)) then begin end;
	end;
	SetCompany(curcomp,false);
	
logtext(0,"end");
return;
end;

global updating procedure ChangeAllBrandBPIGroupIn()
begin
record INVc INr;
integer i,curcomp,cnt,j,k;
string 100 item,brand,oldgroup,newgroup;
record BPIBrandVc BPIBrandr;
record BPIGroupVc BPIGroupr;
array string 100 abrand,aoldgroup,anewgroup;


	curcomp = currentcompany;
	logtext(0,"start");

	while (TestEOF()==false) begin
		cnt = cnt + 1;
		brand = importfield;
		oldgroup = importfield;
		newgroup = importfield;
		logtext(0,brand & " " & oldgroup & " " & newgroup);
		BPIBrandr.Name = brand;
		if(readfirstkey("Name",BPIBrandr,1,false))then begin
			logtext(0,BPIBrandr.Name & " " & oldgroup & " " & newgroup);
			if(uppercase(brand)==uppercase(BPIBrandr.Name))then begin
				abrand[abrand.length] = BPIBrandr.Code;
				BPIGroupr.Name = oldgroup;
				if(readfirstkey("Name",BPIGroupr,1,false))then begin
					aoldgroup[aoldgroup.length] = BPIGroupr.Code;
					BPIGroupr.Name = newgroup;
					if(readfirstkey("Name",BPIGroupr,1,false))then begin
						anewgroup[anewgroup.length] = BPIGroupr.Code;
					
						logtext(0,abrand[abrand.length-1] & " " & aoldgroup[aoldgroup.length-1] & " -> " & anewgroup[anewgroup.length-1]);
						
						
						for(i=1;i<30; i=i+1) begin
						if(!CompanyIsJWLikeCompany(i) or i==3) then begin
							SetCompany(i,false);
							resetloop(INr);
							INr.Code = "";
							while(loopmain(INr,1,true)) begin
								if(nonblank(INr.BPIGroup) and nonblank(INr.BPIBrand))then begin
									For(j=0;j<abrand.length;j=j+1) begin
										if(INr.BPIBrand==abrand[j])then begin
											if(INr.BPIGroup==aoldgroup[j])then begin
												logtext(0,INr.Code & " " & aoldgroup[j] & " -> " & anewgroup[j]);
												if(setinset(INr.BPIGroup,INr.DispGroups))then begin
													logtext(0,INr.Code & "  " & INr.DispGroups & " -> " & StrReplace(INr.DispGroups,INr.BPIGroup,anewgroup[j]));
													INr.DispGroups = StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code);
												end;
												INr.BPIGroup = anewgroup[j];
												//recordstore(INr,true);
											end;
										end;
									end; 
								end;
							end;
						end;
					end;
						
					end;
				end;
			end;
		end;
		/*
		for(i=1;i<30; i=i+1) begin
			if(!CompanyIsJWLikeCompany(i) or i==3) then begin
				SetCompany(i,false);
				INr.Code = item;
				if(readfirstmain(INr,1,true)) begin
					BPIBrandr.Name = brand;
					if(readfirstkey("Name",BPIBrandr,1,true) and INr.BPIBrand==BPIBrandr.Code)then begin
						BPIGroupr.Name = oldgroup;
						if(readfirstkey("Name",BPIGroupr,1,true) and INr.BPIGroup==BPIGroupr.Code)then begin
							BPIGroupr.Name = newgroup;
							if(readfirstkey("Name",BPIGroupr,1,true))then begin
								logtext(0,INr.DispGroups & " <- " & INr.BPIGroup);
								logtext(0,setinset2(INr.BPIGroup,INr.DispGroups));
								if(setinset(INr.BPIGroup,INr.DispGroups))then begin
									logtext(0,"Try to change subgroup");
									logtext(0,INr.DispGroups & " -> " & StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code));
									INr.DispGroups = StrReplace(INr.DispGroups,INr.BPIGroup,BPIGroupr.Code);
									
								end;
								INr.BPIGroup = BPIGroupr.Code;
								logtext(0,INr.Code);
								recordstore(INr,true);
							end;
						end;
					end;
				end;
			end;
		end;*/
		if (NextImportLine(true)) then begin end;
	end;
	SetCompany(curcomp,false);
	
logtext(0,"end");
return;
end;
	
